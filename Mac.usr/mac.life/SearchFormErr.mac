import RsbDataSet, BankInter, PTInter; 
import "fastexcel.mac"; 

var ex, ob, obBook, obSheet;
var count : integer = 0;
var code = Tarray(3);
var adr = Tarray(3);
var cat = Tarray(2);
var note = Tarray(6);
var ustav = Tarray(2);
var multistat = 0;
var year1, year2;
var sqln4, rsbn4;

var RegParam;
var Templ = "SearchFormErr.xltx";

macro openExcel()

        var out;
   if (IsStandAlone()) // 2х звенка
      if ((ValType(ex)!=V_UNDEF) and (ex.Visible==False))
        ex = ActiveX("Excel.Application",NULL,false); 
      else
        ex = ActiveX("Excel.Application",NULL,true);        
      end;
   else                // 3х звенка
      ob = CreateObject ("rsax","TRsAxServer","My_session",false);
      ex = ob.CreateComObject ("Excel.Application");
   end; 
   GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,RegParam);

   var temppath = findpath(Templ,RegParam);
   if (not temppath)
      msgbox("Не найден шаблон!");
      exit();
   end;
   obBook = ex.Workbooks.open(temppath,false); 
   obSheet = obBook.ActiveSheet();      
/*
   var out;

   ob = CFastExcel(False);
        GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,out);
   var Fulloutput = FindPath(Templ, out);
   if (not Fulloutput)
      msgbox("Не найден шаблон");
      exit();
   end;
   obBook = ob.Open(Fulloutput);
   obSheet = obBook.ActiveSheet(); 
*/
end;




macro get_code(partyid)
        var code = Tarray(3);
        code(1) = 0;
        code(2) = 0;
        code(3) = 0;

        var sql_code = "     SELECT cod.t_codekind, cod.t_code "
        +"\n            FROM dobjcode_dbt cod "
        +"\n            WHERE cod.t_objectid = ? AND cod.t_codekind IN (1, 16, 27)      ";


        var rsb_code = RsdCommand(sql_code);
        rsb_code.addparam("p", RSDBP_IN, partyid);
        rsb_code.execute();
        var rs_code = RsdRecordset(rsb_code);

        while (rs_code.MoveNext)
                if (rs_code.value("t_codekind") == 1)
                        code(1) = rs_code.value("t_code");
                elif (rs_code.value("t_codekind") == 16)
                        code(2) = rs_code.value("t_code");
                elif (rs_code.value("t_codekind") == 27)
                        code(3) = rs_code.value("t_code");
                end;
        end;
        return code;    
end;

macro get_note (partyid)
        var note = Tarray(6);
        note(1) = "";           note(2) = "";
        note(3) = "";   note(4) = "";
        note(5) = "";   note(6) = "";
        note(7) = "";   

        var sql_note = " SELECT tt.t_notekind, " 
        +"\n           case " 
        +"\n           when tt.t_notetype = 9 then ( " 
        +"\n           to_char(ASCII (SUBSTR (t_t, 1, 1))) || '.' || " 
        +"\n           to_char(ASCII (SUBSTR (t_t, 2, 1))) || '.' || " 
        +"\n           to_char(ASCII (SUBSTR (t_t, 3, 1)) + ASCII (SUBSTR (t_t, 4, 1)) * 16 * 16)) " 
        +"\n           else tt.t_t " 
        +"\n           end t_text  " 
        +"\n    FROM (SELECT NT.T_NOTEKIND, UTL_RAW.cast_to_varchar2 (nt.t_text) t_t, k.t_notetype " 
        +"\n          FROM dnotetext_dbt nt, dnotekind_dbt k " 
        +"\n          WHERE     nt.t_documentid = LPAD (? , 10, 0) " 
        +"\n                AND nt.t_notekind = k.t_notekind " 
        +"\n                 AND nt.t_objecttype = k.t_objecttype " 
        +"\n                 AND NT.T_NOTEKIND IN (4, 8, 9, 10, 12, 16, 1)) tt ";


        var rsb_note = RsdCommand(sql_note);
        rsb_note.addparam("p", RSDBP_IN, partyid);
        rsb_note.execute();
        var rs_note = RsdRecordset(rsb_note);

        while (rs_note.MoveNext)
                if (rs_note.value("t_notekind") == 4)
                        note(1) = rs_note.value("t_text");
                elif (rs_note.value("t_notekind") == 8)
                        note(2) = rs_note.value("t_text");
                elif (rs_note.value("t_notekind") == 9)
                        note(3) = rs_note.value("t_text");
                elif (rs_note.value("t_notekind") == 10)
                        note(4) = rs_note.value("t_text");
                elif (rs_note.value("t_notekind") == 16)
                        note(5) = rs_note.value("t_text");
                elif (rs_note.value("t_notekind") == 45)
                        note(6) = rs_note.value("t_text");
                elif (rs_note.value("t_notekind") == 12)
                        note(7) = rs_note.value("t_text");

                end;
        end;

        return note
end;

macro get_ustav (partyid)

        var ustav = Tarray(2);
        ustav(1) = 0;           ustav(2) = 0;
        var sql_ustav ="        SELECT decode(t_declarecapital, null, '', t_declarecapital) t_declarecapital, decode(t_realcapital, null, '', t_realcapital) t_realcapital, f.t_fi_code "
        +"\n           FROM dinstitut_dbt t, dfininstr_dbt f "
        +"\n           WHERE f.t_fiid(+) = t.t_capitalfi AND t_partyid = ?;";


        var rsb_ustav = RsdCommand(sql_ustav);
        rsb_ustav.addparam("p", RSDBP_IN, partyid);
        rsb_ustav.execute();
        var rs_ustav = RsdRecordset(rsb_ustav);
        rs_ustav.MoveNext;
        
        ustav (1) = rs_ustav.value("t_declarecapital");
        ustav (2) = rs_ustav.value("t_realcapital");

        return ustav;

end;

macro get_cat(partyid)
        var cat = Tarray(2);
        cat(1) = "";
        cat(2) = "";
        cat(3) = "";

        
        var sql_cat = " SELECT OBJ.T_GROUPID, ATTR.T_FULLNAME "
        +"\n    FROM dobjatcor_dbt obj, dobjattr_dbt attr "
        +"\n    WHERE obj.t_object = LPAD (? , 10, '0') AND obj.t_attrid = attr.t_attrid "
        +"\n    AND ((attr.t_groupid = 4  "
        +"\n    AND obj.t_groupid = 4) OR ((attr.t_groupid = 14  "
        +"\n    AND obj.t_groupid = 14)) OR ((attr.t_groupid = 103 AND obj.t_groupid = 103))) "
        +"\n    AND obj.t_general = CHR (88) "
        +"\n    AND attr.t_objecttype = 3; ";

        var rsb_cat = RsdCommand(sql_cat);
        rsb_cat.addparam("p", RSDBP_IN, partyid);
        rsb_cat.execute();
        var rs_cat = RsdRecordset(rsb_cat);

        while (rs_cat.MoveNext)
                if (rs_cat.value("t_groupid") == 4)
                        cat(1) = rs_cat.value("t_fullname");
                elif (rs_cat.value("t_groupid") == 14)
                        cat(2) = rs_cat.value("t_fullname");
                elif (rs_cat.value("t_groupid") == 103)
                        cat(3) = rs_cat.value("t_fullname");
                end;
        end;
        return cat;     
end;

macro get_account_date(partyid)
        var sql_acc = " SELECT MIN(t_Open_Date) opendate "
        /* EVG 31/1/2014 ПЕреход на 2031
        +"\n        FROM daccounts_dbt "*/
        +"\n        FROM daccount_dbt "
        +"\n        WHERE t_Client =  ?;";

        var rsb_acc = RsdCommand(sql_acc);
        rsb_acc.addparam("p", RSDBP_IN, partyid);
        rsb_acc.execute();
        var rs_acc = RsdRecordset(rsb_acc);
        rs_acc.MoveNext;

        return  rs_acc.value("opendate");
end;

macro get_vigodo(partyid)       
        var sql_vigodo ="       SELECT (SELECT 'Клиент №' || code.t_code || ' Наименование:' || t_name"+
        "\n                             FROM dparty_dbt, dobjcode_dbt code"+
        "\n                             WHERE     t_partyid = TO_NUMBER (objlnk.t_attrid)"+
        "\n                                   AND code.t_objectid = TO_NUMBER (objlnk.t_attrid)"+
        "\n                                   AND code.t_codekind = 1)"+
        "\n                               t_vig , UTL_RAW.cast_to_varchar2(PRM.T_VALUE) prim"+
        "\n                             FROM dobjlink_dbt objlnk, dparty_dbt part, dobjlinkprm_dbt prm"+
        "\n                             WHERE     objlnk.t_objecttype = 3"+
        "\n                             AND TO_NUMBER (objlnk.t_objectid) = part.t_partyid"+
        "\n                            AND objlnk.t_groupid = 603"+
        "\n                            AND part.t_partyid = ?"
        "\n                            AND OBJLNK.T_LINKID = PRM.T_LINKID;";
        
        var rsb_vigodo = RsdCommand(sql_vigodo);
        rsb_vigodo.addparam("p", RSDBP_IN, partyid);
        rsb_vigodo.execute();
        var rs_vigodo = RsdRecordset(rsb_vigodo);
        while (rs_vigodo.MoveNext)      
                
        end;
              
end;

macro get_adress(partyid)
        var adr = Tarray(3);
        adr(1) = "";
        adr(2) = "";
        adr(3) = "";

        var sql_adr = "    SELECT adr.t_type, adr.t_adress, DECODE (adr.t_phonenumber, CHR (1), ' ', adr.t_phonenumber) || DECODE (adr.t_phonenumber2, CHR (1), ' ', adr.t_phonenumber2) || DECODE (adr.t_mobilephone, CHR (1), ' ', adr.t_mobilephone) phon "
        +"\n            FROM dadress_dbt adr "
        +"\n            WHERE adr.t_partyid = ? ";
        debugbreak;

        var rsb_adr = RsdCommand(sql_adr);
        rsb_adr.addparam("p", RSDBP_IN, partyid);
        rsb_adr.execute();
        var rs_adr = RsdRecordset(rsb_adr);

        while (rs_adr.MoveNext)
                if (rs_adr.value("t_type") == 1)
                        adr(1) = rs_adr.value("t_adress");
                elif (rs_adr.value("t_type") == 2)
                        adr(2) = rs_adr.value("t_adress");
                end;
                adr(3) = adr(3) + rs_adr.value("phon") + " ";
        end;
        return adr;     
end;



macro Is_Digit( str, digit_ )
        var isdigit, digit=digit_;
        var i, n, cur_symb;
        isdigit = true;
        i = 1;
        n = strlen(str);
        while( (isdigit) and (i <= n) )
                cur_symb = SubStr(str, i, 1);
                if(index(digit,cur_symb) == 0)
                        isdigit = false;
                end;
                i = i+1;
        end;
        return isdigit;
end; 
              
openExcel();
//Ex.visible = true;

var arr = TArray;
arr(0) = "Физ. лица + Юр. лица";
arr(1) = "Физ. лица";
arr(2) = "Юр. лица";

var chois_up = menu(arr, "+))" ,"Укажите режим", null, null, 0);

VAR SQ_QU = "";

if (chois_up == 0)
        SQ_QU = "";
elif (chois_up == 1)
        SQ_QU = "\n  AND part.t_legalform = 2";
        obSheet = obBook.Sheets("Физ. лица");
//      Ex.visible = true;
elif (chois_up == 2)
        SQ_QU = "\n  AND part.t_legalform <> 2";
else
        msgbox("Отменено пользователем");
        exit(0);
end;


        var SQL = "     SELECT COUNT ( * ) cnt" 
        +"\n              FROM (SELECT DISTINCT part.t_partyid, part.t_name,  part.t_okpo, part.t_legalform " 
        +"\n                    FROM dparty_dbt part, dclient_dbt cli, daccount_dbt acco " 
        +"\n                    WHERE     part.t_partyid = cli.t_partyid " 
        +"\n                          AND part.t_partyid = acco.t_client " 
        +"\n                          AND part.t_locked = CHR (0) " 
        +"\n                          AND acco.t_open_close <> 'З' "
        +"\n                           AND acco.t_chapter = 1 "  
        + SQ_QU
        +"\n                          AND REGEXP_LIKE (acco.t_account, " 
        +"\n                                           '^30109|^306|^40[123456]|^4070[123]|^40901|^41|^42[012]|^425|^43[89]|^44|^45[123]|^456|^31[23456]|^32[0123]|^46|^47[0123]|^5230[1234567]|^52503|^52406|^40802|^40807|^40901|^421|^425|^454|^523|^52406' " 
        +"\n                             ))";


        var data = TRsbDataSet(SQL);
        if (data.MoveNext)
                count = data.cnt ;
        else
                MsgBox("Нет данных");
                exit(0);
        end;
        
                   sql = "      SELECT distinct part.t_partyid, part.t_name,  part.t_okpo, part.t_legalform " 
                +"\n              FROM dparty_dbt part, dclient_dbt cli, daccount_dbt acco  " 
                +"\n              WHERE     part.t_partyid = cli.t_partyid  " 
                +"\n                    AND part.t_partyid = acco.t_client " 
                +"\n                    AND part.t_locked = CHR (0) " 
                +"\n                    AND acco.t_open_close <> 'З' " 
                +"\n                    AND acco.t_chapter = 1 " 

                + SQ_QU
                +"\n                    AND REGEXP_LIKE (acco.t_account,  " 
                +"\n                                     '^30109|^306|^40[123456]|^4070[123]|^40901|^41|^42[012]|^425|^43[89]|^44|^45[123]|^456|^31[23456]|^32[0123]|^46|^47[0123]|^5230[1234567]|^52503|^52406|^40802|^40807|^40901|^421|^425|^454|^523|^52406'  " 
                +"\n                       ) "; 
        
        var rsb = TRsbDataSet(sql);



/* ПолучитьДанныеРегистрации */

var i = 0;
var bar = 0;

var i_fiz = 1;
var i_uri = 1;

var sql_fiz = "";
var rsb_fiz;

initprogress(count);

while (rsb.movenext)
        if (chois_up == 1)      
                i_fiz = i_fiz + 1;
                //msgbox("!!");
                sql_fiz =" SELECT   (SELECT   COD.T_CODE " 
+"\n                FROM   dobjcode_dbt cod " 
+"\n                           WHERE   COD.T_CODEKIND = 1 AND T_STATE=0 AND COD.T_OBJECTID = PARTY.T_PARTYID) " 
+"\n                            t_code, " 
+"\n                         PARTY.T_NAME, " 
+"\n                         PERS.T_BORN, " 
+"\n                         PERS.T_BIRSPLASE, " 
+"\n                         PARTY.T_NRCOUNTRY, " 
+"\n                         IDC.T_PAPERSERIES, " 
+"\n                         IDC.T_PAPERNUMBER, " 
+"\n                         IDC.T_PAPERISSUEDDATE, " 
+"\n                         IDC.T_PAPERISSUER, " 
+"\n                         IDC.T_PAPERISSUERCODE, " 
+"\n                         (SELECT   COD.T_CODE " 
+"\n                            FROM   dobjcode_dbt cod " 
+"\n                           WHERE       COD.T_CODEKIND = 16 " 
+"\n                                   AND COD.T_STATE = 0 " 
+"\n                                   AND COD.T_OBJECTID = PARTY.T_PARTYID) " 
+"\n                            t_inn, " 
+"\n                         (SELECT   COD.T_CODE " 
+"\n                            FROM   dobjcode_dbt cod " 
+"\n                           WHERE       COD.T_CODEKIND = 27 " 
+"\n                                   AND COD.T_STATE = 0 " 
+"\n                                   AND COD.T_OBJECTID = PARTY.T_PARTYID) " 
+"\n                            t_ogrn, " 
+"\n                         (SELECT   RGDOC.T_DOCDATE " 
+"\n                            FROM   dobjrgdoc_dbt rgdoc " 
+"\n                           WHERE       RGDOC.T_OBJECTID = PARTY.T_PARTYID " 
+"\n                                   AND RGDOC.T_OBJECTTYPE = 3 "
+"\n                                   AND RGDOC.T_REGDOCKIND = 4  "
+"\n                                   AND RGDOC.T_ISMAIN = 'X' " 
+"\n                                  AND RGDOC.T_ISCLOSED <> 'X') " 
+"\n                            T_DOCDATE, " 
+"\n                         (SELECT   RGDOC.T_REGPLACE " 
+"\n                            FROM   dobjrgdoc_dbt rgdoc " 
+"\n                           WHERE       RGDOC.T_OBJECTID = PARTY.T_PARTYID " 
+"\n                                   AND RGDOC.T_OBJECTTYPE = 3 " 
+"\n                                   AND RGDOC.T_REGDOCKIND = 4  "
+"\n                                   AND RGDOC.T_ISMAIN = 'X' " 
+"\n                                  AND RGDOC.T_ISCLOSED <> 'X') " 
+"\n                            T_REGPLACE, " 
+"\n                         (SELECT   RGDOC.T_REGPARTYID " 
+"\n                            FROM   dobjrgdoc_dbt rgdoc " 
+"\n                           WHERE       RGDOC.T_OBJECTID = PARTY.T_PARTYID " 
+"\n                                   AND RGDOC.T_OBJECTTYPE = 3 " 
+"\n                                   AND RGDOC.T_REGDOCKIND = 4  "
+"\n                                   AND RGDOC.T_ISMAIN = 'X' " 
+"\n                                  AND RGDOC.T_ISCLOSED <> 'X') " 
+"\n                            T_REGPARTYID, " 
+"\n                         (SELECT   part.T_NAME " 
+"\n                            FROM   dparty_dbt part " 
+"\n                           WHERE   part.t_partyid = " 
+"\n                                      (SELECT   RGDOC.T_REGPARTYID " 
+"\n                                         FROM   dobjrgdoc_dbt rgdoc " 
+"\n                                        WHERE       RGDOC.T_OBJECTID = PARTY.T_PARTYID " 
+"\n                                                AND RGDOC.T_OBJECTTYPE = 3 " 
+"\n                                              AND RGDOC.T_REGDOCKIND = 4  "
+"\n                                                AND RGDOC.T_ISMAIN = 'X' "
+"\n                                                AND RGDOC.T_ISCLOSED <> 'X')) " 
+"\n                            t_regorgname, " 
+"\n                         (SELECT   UTL_RAW.cast_to_varchar2 (NOTE.T_TEXT) " 
+"\n                            FROM   dnotetext_dbt note " 
+"\n                           WHERE       NOTE.T_NOTEKIND = 9 " 
+"\n                                   AND note.t_objecttype = 3 " 
+"\n                                   AND NOTE.T_DOCUMENTID = LPAD (PARTY.T_PARTYID, 10, 0)) " 
+"\n                            t_license, " 
+"\n                         (SELECT   UTL_RAW.cast_to_varchar2 (NOTE.T_TEXT) " 
+"\n                            FROM   dnotetext_dbt note " 
+"\n                           WHERE       NOTE.T_NOTEKIND = 12 " 
+"\n                                   AND note.t_objecttype = 3 " 
+"\n                                   AND NOTE.T_DOCUMENTID = LPAD (PARTY.T_PARTYID, 10, 0)) " 
+"\n                            t_kindewr, " 
+"\n                         (SELECT      ADR.T_PHONENUMBER " 
+"\n                                   || ' ' " 
+"\n                                   || ADR.T_PHONENUMBER2 " 
+"\n                                   || ' ' " 
+"\n                                   || ADR.T_MOBILEPHONE " 
+"\n                            FROM   dadress_dbt adr " 
+"\n                           WHERE   ADR.T_PARTYID = PARTY.T_PARTYID AND ADR.T_TYPE = 1) " 
+"\n                            t_Uphone, " 
+"\n                         (SELECT      ADR.T_PHONENUMBER " 
+"\n                                   || ' ' " 
+"\n                                   || ADR.T_PHONENUMBER2 " 
+"\n                                   || ' ' " 
+"\n                                   || ADR.T_MOBILEPHONE " 
+"\n                            FROM   dadress_dbt adr " 
+"\n                           WHERE   ADR.T_PARTYID = PARTY.T_PARTYID AND ADR.T_TYPE = 2) " 
+"\n                            t_Fphone, " 
+"\n                         (SELECT      ADR.T_PHONENUMBER " 
+"\n                                   || ' ' " 
+"\n                                   || ADR.T_PHONENUMBER2 " 
+"\n                                   || ' ' " 
+"\n                                   || ADR.T_MOBILEPHONE " 
+"\n                            FROM   dadress_dbt adr " 
+"\n                           WHERE   ADR.T_PARTYID = PARTY.T_PARTYID AND ADR.T_TYPE = 3) " 
+"\n                            t_Pphone, " 
+"\n                         (SELECT   ADR.T_ADRESS " 
+"\n                            FROM   dadress_dbt adr " 
+"\n                           WHERE   ADR.T_PARTYID = PARTY.T_PARTYID AND ADR.T_TYPE = 1) " 
+"\n                            t_Uadress, " 
+"\n                         (SELECT   ADR.T_ADRESS " 
+"\n                            FROM   dadress_dbt adr " 
+"\n                           WHERE   ADR.T_PARTYID = PARTY.T_PARTYID AND ADR.T_TYPE = 2) " 
+"\n                            t_Fadress, " 
+"\n                         (SELECT   ADR.T_ADRESS " 
+"\n                            FROM   dadress_dbt adr " 
+"\n                           WHERE   ADR.T_PARTYID = PARTY.T_PARTYID AND ADR.T_TYPE = 3) " 
+"\n                            t_Padress, " 
+"\n                         (SELECT   MIN (t_Open_Date) opendate " 
+"\n                            FROM   daccounts_view " 
+"\n                           WHERE   t_Client = PARTY.T_PARTYID AND t_chapter = 1) " 
+"\n                            t_datefirstacc, " 
+"\n                         1 t_accoper, " 
//Lavrenov: 11.07.2012 в рамках перехода на 11G к вызову wm_concat добавляем dbms_lob.substr
+"\n                         (SELECT   dbms_lob.substr(wm_concat (attr.T_fullname || ' ')) " 
+"\n                            FROM   dobjatcor_dbt atcor, dobjattr_dbt attr " 
+"\n                           WHERE       atcor.T_OBJECT = LPAD (PARTY.T_PARTYID, 10, 0) " 
+"\n                                   AND atcor.T_OBJECTTYPE = 3 " 
+"\n                                   AND ATCOR.T_GROUPID = 14 " 
+"\n                                   AND ATCOR.T_OBJECTTYPE = ATTR.T_OBJECTTYPE " 
+"\n                                   AND ATCOR.T_GROUPID = ATTR.T_GROUPID " 
+"\n                                   AND ATCOR.T_ATTRID = ATTR.T_ATTRID) " 
+"\n                            t_levrisk, " 
//Lavrenov: 11.07.2012 в рамках перехода на 11G к вызову wm_concat добавляем dbms_lob.substr
+"\n                         (SELECT   dbms_lob.substr(wm_concat (attr.T_fullname || ' ')) " 
+"\n                            FROM   dobjatcor_dbt atcor, dobjattr_dbt attr " 
+"\n                           WHERE       atcor.T_OBJECT = LPAD (PARTY.T_PARTYID, 10, 0) " 
+"\n                                   AND atcor.T_OBJECTTYPE = 3 " 
+"\n                                   AND ATCOR.T_GROUPID = 108 " 
+"\n                                   AND ATCOR.T_OBJECTTYPE = ATTR.T_OBJECTTYPE " 
+"\n                                   AND ATCOR.T_GROUPID = ATTR.T_GROUPID " 
+"\n                                   AND ATCOR.T_ATTRID = ATTR.T_ATTRID) " 
+"\n                            t_risk, " 
+"\n                         (SELECT   ASCII ( " 
+"\n                                      SUBSTR (UTL_RAW.cast_to_varchar2 (NT.T_TEXT), 1, 1) " 
+"\n                                   ) " 
+"\n                                   || '.' " 
+"\n                                   || ASCII ( " 
+"\n                                         SUBSTR (UTL_RAW.cast_to_varchar2 (NT.T_TEXT), 2, 1) " 
+"\n                                      ) " 
+"\n                                   || '.' " 
+"\n                                   || (ASCII ( " 
+"\n                                          SUBSTR (UTL_RAW.cast_to_varchar2 (NT.T_TEXT), 3, 1) " 
+"\n                                       ) " 
+"\n                                       + ASCII(SUBSTR (UTL_RAW.cast_to_varchar2 (NT.T_TEXT), " 
+"\n                                                       4, " 
+"\n                                                       1)) " 
+"\n                                         * 16 " 
+"\n                                         * 16) " 
+"\n                            FROM   dnotetext_dbt nt " 
+"\n                           WHERE       nt.t_documentid = LPAD (PARTY.T_PARTYID, 10, 0) " 
+"\n                                   AND nt.T_NOTEKIND = 1 " 
+"\n                                   AND nt.t_objecttype = 3) " 
+"\n                            t_date_create_anket, " 
+"\n                         (SELECT   UTL_RAW.cast_to_varchar2 (NOTE.T_TEXT) " 
+"\n                            FROM   dnotetext_dbt note " 
+"\n                           WHERE       NOTE.T_NOTEKIND = 118 " 
+"\n                                   AND note.t_objecttype = 3 " 
+"\n                                   AND NOTE.T_DOCUMENTID = LPAD (PARTY.T_PARTYID, 10, 0)) " 
+"\n                            t_manager " 
+"\n                  FROM   dparty_dbt party, " 
+"\n                         dpersnidc_dbt idc, " 
+"\n                         dpersn_dbt pers " 
+"\n                 WHERE       PARTY.T_PARTYID =  " + rsb.t_partyid 
+"\n                         AND IDC.T_PERSONID(+) = PARTY.T_PARTYID " 
+"\n                         AND PERS.T_PERSONID(+) = PARTY.T_PARTYID; ";  
       rsb_fiz = TRsbDataSet(sql_fiz);
        if(rsb_fiz.movenext())
//              debugbreak;
                obSheet.Cells(i_fiz,1).value = string(i_fiz-1);
                obSheet.Cells(i_fiz,2).value = rsb_fiz.t_code;
                obSheet.Cells(i_fiz,3).value = rsb_fiz.T_NAME;
//              debugbreak;

                DateSplit(date(rsb_fiz.T_BORN), NULL, NULL, year1);
                DateSplit(date(), NULL, NULL, year2);
                if (trim(string(date(rsb_fiz.T_BORN))) == "")
                        obSheet.Cells(i_fiz,4).Interior.Color = 255;//65535;
                elif((year2 - year1) < 18 )
                        obSheet.Cells(i_fiz,4).Interior.Color = 65535;
                else
//                      obSheet.Cells(i_fiz,4).value = rsb_fiz.T_BORN;
                end;
        
                if (trim(rsb_fiz.T_BIRSPLASE)=="")
                        obSheet.Cells(i_fiz,5).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,5).value = rsb_fiz.T_BIRSPLASE;
                end;
                if (trim(rsb_fiz.T_NRCOUNTRY)=="")
                        obSheet.Cells(i_fiz,6).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,6).value = rsb_fiz.T_NRCOUNTRY;
                end;

                multistat = 0;
                if ((trim(string(rsb_fiz.T_PAPERNUMBER)) == "") or (trim(string(rsb_fiz.T_PAPERNUMBER)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_PAPERSERIES)) == "") or (trim(string(rsb_fiz.T_PAPERSERIES)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_PAPERISSUEDDATE)) == "") or (trim(string(rsb_fiz.T_PAPERISSUEDDATE)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_PAPERISSUER)) == "") or (trim(string(rsb_fiz.T_PAPERISSUER)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_PAPERISSUERCODE)) == "") or (trim(string(rsb_fiz.T_PAPERISSUERCODE)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                
                if (multistat == 0)
//                      obSheet.Cells(i_fiz,7).value = "Номер: " + rsb_fiz.T_PAPERNUMBER + " " + rsb_fiz.T_PAPERSERIES +" Дата выдачи: "+rsb_fiz.T_PAPERISSUEDDATE+" Кем выдан: "+rsb_fiz.T_PAPERISSUER + " Код: " + rsb_fiz.T_PAPERISSUERCODE;                                 
                elif (multistat == 4)
                        obSheet.Cells(i_fiz,7).Interior.Color = 255;
                else
                        obSheet.Cells(i_fiz,7).Interior.Color = 65535;
                end;
//              debugbreak;

                if (trim(string(rsb_fiz.T_INN)) == "")
                      obSheet.Cells(i_fiz,8).Interior.Color = 255;
                elif(trim(string(rsb_fiz.T_INN)) == "Undefined")
                      obSheet.Cells(i_fiz,8).Interior.Color = 255;
                else
//                    obSheet.Cells(i_fiz,8).value = rsb_fiz.T_INN;
                end;
                
                multistat = 0;
                if ((trim(string(rsb_fiz.T_OGRN)) == "") or (trim(string(rsb_fiz.T_OGRN)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_DOCDATE)) == "") or (trim(string(rsb_fiz.T_DOCDATE)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_REGPLACE)) == "") or (trim(string(rsb_fiz.T_REGPLACE)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.t_regorgname)) == "") or (trim(string(rsb_fiz.t_regorgname)) == "Undefined"))
                        multistat = multistat + 1;
                end;
                
                if (multistat == 0)
//                      obSheet.Cells(i_fiz,9).value = "ОГРН: " + rsb_fiz.T_OGRN + " Дата регистрации: " + rsb_fiz.T_DOCDATE +" Место регистрации: "+ rsb_fiz.T_REGPLACE +" Регистрирующий орган: "+rsb_fiz.t_regorgname;
                elif (multistat == 4)
                        obSheet.Cells(i_fiz,9).Interior.Color = 255;
                else
                        obSheet.Cells(i_fiz,9).Interior.Color = 65535;
                end;

                if ((trim(string(rsb_fiz.T_LICENSE)) == "") or (trim(string(rsb_fiz.T_LICENSE)) == "Undefined"))
                      obSheet.Cells(i_fiz,10).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,10).value = rsb_fiz.T_LICENSE;
                end;

                if ((trim(string(rsb_fiz.T_KINDEWR)) == "") or (trim(string(rsb_fiz.T_KINDEWR)) == "Undefined"))
                      obSheet.Cells(i_fiz,11).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,11).value = rsb_fiz.T_KINDEWR;
                end;

                multistat = 0;
                if ((trim(string(rsb_fiz.T_UPhone)) == "") or (trim(string(rsb_fiz.T_UPhone)) == "Undefined") or (trim(string(rsb_fiz.T_UPhone)) == strfor(1)+" "+strfor(1)+" "+strfor(1)))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_FPhone)) == "") or (trim(string(rsb_fiz.T_FPhone)) == "Undefined") or (trim(string(rsb_fiz.T_FPhone)) == strfor(1)+" "+strfor(1)+" "+strfor(1)))
                        multistat = multistat + 1;
                end;
                if ((trim(string(rsb_fiz.T_PPhone)) == "") or (trim(string(rsb_fiz.T_PPhone)) == "Undefined") or (trim(string(rsb_fiz.T_PPhone)) == strfor(1)+" "+strfor(1)+" "+strfor(1)))
                        multistat = multistat + 1;
                end;
                
                if (multistat == 0)
//                      obSheet.Cells(i_fiz,12).value = "Телефоны Юр. адреса: " + rsb_fiz.T_UPhone +" Телефоны Факт. адреса: " + rsb_fiz.T_FPhone +" Телефоны Почтового адреса: " + rsb_fiz.T_PPhone;
                elif (multistat == 3)
                        obSheet.Cells(i_fiz,12).Interior.Color = 255;
//              else
//                      obSheet.Cells(i_fiz,12).Interior.Color = 65535;
                end;

                if ((trim(string(rsb_fiz.T_UADRESS)) == "") or (trim(string(rsb_fiz.T_UADRESS)) == "Undefined"))
//                    obSheet.Cells(i_fiz,13).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,13).value = rsb_fiz.T_UADRESS;
                end;

                if ((trim(string(rsb_fiz.T_FADRESS)) == "") or (trim(string(rsb_fiz.T_FADRESS)) == "Undefined"))
//                    obSheet.Cells(i_fiz,14).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,14).value = rsb_fiz.T_FADRESS;
                end;

                if (trim(string(date(rsb_fiz.t_datefirstacc))) == "")
                      obSheet.Cells(i_fiz,15).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,15).value = rsb_fiz.t_datefirstacc;
                end;

                if (trim(string(rsb_fiz.t_accoper)) == "")
                      obSheet.Cells(i_fiz,16).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,16).value = rsb_fiz.t_accoper;
                end;

                if ((trim(string(rsb_fiz.t_levrisk)) == "") or (trim(string(rsb_fiz.t_levrisk)) == "Undefined"))
                      obSheet.Cells(i_fiz,17).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,17).value = rsb_fiz.t_levrisk;
                end;

                if ((trim(string(rsb_fiz.t_risk)) == "") or (trim(string(rsb_fiz.t_risk)) == "Undefined"))
                      obSheet.Cells(i_fiz,18).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,18).value = rsb_fiz.t_risk;
                end;

                if (trim(string(date(rsb_fiz.t_date_create_anket))) == "")
                      obSheet.Cells(i_fiz,19).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,19).value = rsb_fiz.t_date_create_anket;
                end;

                if ((trim(string(rsb_fiz.t_manager)) == "") or (trim(string(rsb_fiz.t_manager)) == "Undefined"))
                      obSheet.Cells(i_fiz,21).Interior.Color = 255;
                else
//                      obSheet.Cells(i_fiz,21).value = rsb_fiz.t_manager;
                end;

        else
                println ("В отчёт не попал клиент partyid = " + rsb.t_partyid + " (Слишком много ошибок)");
        end;
        UseProgress(bar);
        bar = bar + 1;
else    
                if (rsb.t_legalform == 2)
                        obSheet = obBook.Sheets("Физ. лица");
                        i_fiz = i_fiz + 1;
                        i = i_fiz;
                        bar = bar + 1;
                else
                        obSheet = obBook.Sheets("Юр. лица");
                        i_uri = i_uri + 1;
                        i = i_uri;
                        bar = bar + 1;
                end;

                
        //      obSheet.Cells(i,3).AddComment;
        //      obSheet.Cells(i,3).Comment.Visible = False;
        //      obSheet.Cells(i,3).Comment.Text("Наименование клиента:" + "\n" + rsb.t_name);

        //      obSheet.Cells(i,7).AddComment;
        //      obSheet.Cells(i,7).Comment.Visible = False;
        //      obSheet.Cells(i,7).Comment.Text("ОКПО:" + "\n" + rsb.t_okpo);
                if  (rsb.t_okpo == "")
                          obSheet.Cells(i,7).Interior.Color = 255;
                elif (not (Is_Digit(rsb.t_okpo, "1234567890")) or (int(rsb.t_okpo) == 0))
                          obSheet.Cells(i,7).Interior.Color = 65535;
                end;

                code = Tarray(get_code(rsb.t_partyid));

                obSheet.Cells(i,2).Value = code(1);

        //      obSheet.Cells(i,4).AddComment;
        //      obSheet.Cells(i,4).Comment.Visible = False;
        //      obSheet.Cells(i,4).Comment.Text("ИНН:" + "\n" + code(2));
                if  (code(2) == "")
                          obSheet.Cells(i,4).Interior.Color = 255;
                elif (not (Is_Digit(code(2),"1234567890/")) or (int(code(2)) == 0))
                          obSheet.Cells(i,4).Interior.Color = 65535;
                end;

        //      obSheet.Cells(i,6).AddComment;
        //      obSheet.Cells(i,6).Comment.Visible = False;
        //      obSheet.Cells(i,6).Comment.Text("ОГРН:" + "\n" + code(3));
                debugbreak;             
                if  (code(3) == "")
                          obSheet.Cells(i,6).Interior.Color = 255;
                elif (not (Is_Digit(code(3), "1234567890")) or (int(code(3)) == 0))
                          obSheet.Cells(i,6).Interior.Color = 65535;
                else
                        sqln4 = "SELECT   T_DOCDATE, T_REGPLACE FROM   dobjrgdoc_dbt "
                                +" WHERE       T_OBJECTID = "+rsb.t_partyid+" AND T_OBJECTTYPE = 3 AND T_REGDOCKIND = 4 AND T_ISMAIN = 'X' AND T_ISCLOSED <> 'X'";
                        rsbn4 = TRsbDataSet(sqln4);
                        if(rsbn4.movenext())
                                if ((trim(string(rsbn4.T_DOCDATE)) == "") OR (trim(rsbn4.T_REGPLACE) == ""))
                                        obSheet.Cells(i,6).Interior.Color = 65535;
                                end;
                        else
                          obSheet.Cells(i,6).Interior.Color = 255;
                        end;
                end;
                
                adr = Tarray(get_adress(rsb.t_partyid));

        //      obSheet.Cells(i,10).AddComment;
        //      obSheet.Cells(i,10).Comment.Visible = False;
        //      obSheet.Cells(i,10).Comment.Text("Юридический адрес:" + "\n" + adr(1));
                if  (adr(1) == "")
                          obSheet.Cells(i,10).Interior.Color = 65535;
                end;
                
        //      obSheet.Cells(i,11).AddComment;
        //      obSheet.Cells(i,11).Comment.Visible = False;
        //      obSheet.Cells(i,11).Comment.Text("Фактический адрес:" + "\n" + adr(2));
                if  (trim(adr(2)) == "")
                          obSheet.Cells(i,11).Interior.Color = 255;
                end;

        //      obSheet.Cells(i,9).AddComment;
        //      obSheet.Cells(i,9).Comment.Visible = False;
        //      obSheet.Cells(i,9).Comment.Text("Телефоны:" + "\n" + adr(3));
                if  (trim(adr(3)) == "")
                          obSheet.Cells(i,9).Interior.Color = 255;
                end;

                cat = Tarray(get_cat(rsb.t_partyid));

        //      obSheet.Cells(i,5).AddComment;
        //      obSheet.Cells(i,5).Comment.Visible = False;
        //      obSheet.Cells(i,5).Comment.Text("Организационно правовые формы:" + "\n" + cat(1));
                if  (cat(1) == "")
                          obSheet.Cells(i,5).Interior.Color = 65535;
                end;
                
        //      obSheet.Cells(i,21).AddComment;
        //      obSheet.Cells(i,21).Comment.Visible = False;
        //      obSheet.Cells(i,21).Comment.Text("Уровень риска легализации:" + "\n" + cat(2));
                if  (trim(cat(2)) == "")
                          obSheet.Cells(i,21).Interior.Color = 255;
                end;

        //      obSheet.Cells(i,18).AddComment;
        //      obSheet.Cells(i,18).Comment.Visible = False;
        //      obSheet.Cells(i,18).Comment.Text("Наличие выгодоприобретателей:" + "\n" + cat(3));
                if  (trim(cat(3)) == "")
                          obSheet.Cells(i,18).Interior.Color = 255;
                end;


                note = Tarray(get_note(rsb.t_partyid));
                   
        //      obSheet.Cells(i,16).AddComment;
        //      obSheet.Cells(i,16).Comment.Visible = False;
        //      obSheet.Cells(i,16).Comment.Text("Нахождение органа управления по юридическому адресу:" + "\n" + note(1));
                if  (trim(note(1)) == "")
                          obSheet.Cells(i,16).Interior.Color = 255;
                end;

        //      obSheet.Cells(i,12).AddComment;
        //      obSheet.Cells(i,12).Comment.Visible = False;
        //      obSheet.Cells(i,12).Comment.Text("Сведения об учредителях:" + "\n" + note(2));
                if  (trim(note(2)) == "")
                          obSheet.Cells(i,12).Interior.Color = 255;
                end;
                
        //      obSheet.Cells(i,8).AddComment;
        //      obSheet.Cells(i,8).Comment.Visible = False;
        //      obSheet.Cells(i,8).Comment.Text("Сведения о наличии лицензий:" + "\n" + note(3));
                if  (trim(note(3)) == "")
                          obSheet.Cells(i,8).Interior.Color = 255;
                end;
                
        //      obSheet.Cells(i,13).AddComment;
        //      obSheet.Cells(i,13).Comment.Visible = False;
        //      obSheet.Cells(i,13).Comment.Text("Сведения об органах юридического лица:" + "\n" + note(4));

                if  (trim(note(4)) == "")
                        sqln4 = "select distinct 1 rez from dofficer_dbt offi where offi.t_partyid = " + rsb.t_partyid;
                        rsbn4 = TRsbDataSet(sqln4);
                        if(rsbn4.movenext())
                        else
                                obSheet.Cells(i,13).Interior.Color = 255;
                        end;
                end;

        //      obSheet.Cells(i,22).AddComment;
        //      obSheet.Cells(i,22).Comment.Visible = False;
        //      obSheet.Cells(i,22).Comment.Text("Обоснование уровеня риска легализации:" + "\n" + note(5));
//              debugbreak;
                if  (trim(note(5)) == "")
                        sqln4 = "SELECT   DISTINCT 1 FROM dobjatcor_dbt WHERE T_OBJECT = LPAD ("+rsb.t_partyid+", 10, 0) AND T_OBJECTTYPE = 3 AND T_GROUPID = 108" ;
                        rsbn4 = TRsbDataSet(sqln4);
                        if(rsbn4.movenext())
                        else
                                obSheet.Cells(i,22).Interior.Color = 255;
                        end;
                end;
                
        //      obSheet.Cells(i,20).AddComment;
        //      obSheet.Cells(i,20).Comment.Visible = False;
        //      obSheet.Cells(i,20).Comment.Text("Дата анкеты:" + "\n" + note(6));
                if  (trim(note(6)) == "")
//                        obSheet.Cells(i,20).Interior.Color = 255;
                end;

        //      obSheet.Cells(i,17).AddComment;
        //      obSheet.Cells(i,17).Comment.Visible = False;
        //      obSheet.Cells(i,17).Comment.Text("Основные виды деятельности:" + "\n" + note(7));
                debugbreak;
                if  (trim(note(7)) == "")
                        sqln4 = "SELECT   DISTINCT 1 FROM   dobjatcor_dbt WHERE T_OBJECT = LPAD ("+rsb.t_partyid+", 10, 0) AND T_OBJECTTYPE = 3 AND T_GROUPID = 28"; //17
                        rsbn4 = TRsbDataSet(sqln4);
                        if(rsbn4.movenext())
                     else
                                obSheet.Cells(i,11).Interior.Color = 255;
                        end;
                end;
                

                ustav = Tarray(get_ustav(rsb.t_partyid));
        //      obSheet.Cells(i,14).AddComment;
        //      obSheet.Cells(i,14).Comment.Visible = False;
        //      obSheet.Cells(i,14).Comment.Text("Уставной капитал зарегистрированный:" + "\n" + string(ustav(1)));
                if  ((valtype(ustav(1)) == 26) or (valtype(ustav(1)) == 29))
                          obSheet.Cells(i,14).Interior.Color = 255;
                else
                        if (int(ustav(1)) == 0 )
                                  obSheet.Cells(i,14).Interior.Color = 65535;
                        end;
                end;
        //      obSheet.Cells(i,15).AddComment;
        //      obSheet.Cells(i,15).Comment.Visible = False;
        //      obSheet.Cells(i,15).Comment.Text("Уставной капитал оплаченный:" + "\n" + string(ustav(2)));
                if  ((valtype(ustav(2)) == 26) or (valtype(ustav(1)) == 29))
                          obSheet.Cells(i,15).Interior.Color = 255;
                else
                        if (int(ustav(2)) == 0 )
                                  obSheet.Cells(i,15).Interior.Color = 65535;
                        end;
                end;

                var acc_date = get_account_date(rsb.t_partyid);
        //      obSheet.Cells(i,23).AddComment;
        //      obSheet.Cells(i,23).Comment.Visible = False;
        //      obSheet.Cells(i,23).Comment.Text("Дата открытия первого счёта:" + "\n" + string(acc_date));

                if  (acc_date < date("01.01.1111"))
                          obSheet.Cells(i,23).Interior.Color = 255;
                end;
                

                   
                UseProgress(bar);

                i = i + 1;
        end;
end;

RemProgress(i-1);
obSheet.Columns("A:A").EntireColumn.AutoFit;
obSheet.Columns("B:B").ColumnWidth = 14;
obSheet.Columns("C:C").ColumnWidth = 40;
Ex.visible = true;





