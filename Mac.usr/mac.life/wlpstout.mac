/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*                          Экспорт сообщений                               */
/*                                                                          */
/*  Имя файла: wlpstout.mac                                                 */
/*  Создан:  13.07.01                                         Бабин А.П.    */
//SDA - 20.06.2012 - в Ставрополе не влезало наименование населенного пунка после наименования банка.
/****************************************************************************/

import "wlexport.mac", "swtools.mac", "adress.mac";

import "fg_Life_parm.mac"; // KS 21.12.2010 I-087765 Почтовые платежи. Замечания

import Oprinter;

import PTInter;

var _dvalue;

var fgBank = fg_life_subject({OurBank}); // KS 21.12.2010 I-087765 Почтовые платежи. Замечания

/*SDA - функции работы с нумерацией рейсов */

private var RaceNumber;

private macro GetLastNumberRace(tdate,frmid,currace); 
  var rs:object;
  var select:string;
  var params:TArray;
  var numberrace = 0;
  var NUMBERLASTRACE,TPFRMTIDLASTRACE;

	select = "select nvl(max(WS.T_NUMBERRACE),0) from dwlsess_dbt ws "+
	         "\n where WS.T_BANKDATE = :tdate and WS.T_TPFRMTID = :frmid";
   params = makeArray( SQLParam("tdate",tdate ),
                      SQLParam("frmid", frmid));
  rs = execSQLselect( select, params, FALSE );
  if (rs.movenext())
   NUMBERLASTRACE = int(rs.value(0));
   TPFRMTIDLASTRACE = frmid;
   return NUMBERLASTRACE;
  end;
 onerror(x);
 return(numberrace);
end;

private macro SetNumberRace(racenum,sessid); 
  var rs:object;
  var select:string;
  var params:TArray;
  var numberrace = 0;
	select = "update dwlsess_dbt ws SET WS.T_NUMBERRACE = :racenum"+
	         "\n where WS.T_SESSIONID = :sessid";
  params = makeArray( SQLParam("racenum",racenum ),
                      SQLParam("sessid", sessid));
  rs = execSQL( select, params, FALSE );
  return(true);
 onerror(x);
 return(false);
end;



macro StringToDate( str )
   return date( int(substr(str,1,2)), int(substr(str,4,2)), int(substr(str,7)) );
end;

class FieldsMes( СтрокаДокумента )
   var ShifrOperation, Number, DatePay, ValueDate, Sum, PayerAccount,
       ReceiverAccount, ReceiverCorrAccNostro, ReceiverBankCode, Priority, _ddate;
   macro FillFields( СтрокаДокумента )
       ShifrOperation = substr(СтрокаДокумента, 1, 2); 
       Number  = Trim( substr(СтрокаДокумента,3,15) );
       DatePay = StringToDate( substr(СтрокаДокумента, 18, 10) );
       Sum     = moneyl( substr(СтрокаДокумента, 28, 16) );
       PayerAccount = Trim( substr(СтрокаДокумента, 44, 20) );
       ReceiverBankCode = Trim( substr(СтрокаДокумента, 64, 9) );
       ReceiverCorrAccNostro = Trim( substr(СтрокаДокумента, 73, 20) );
       ReceiverAccount = Trim( substr(СтрокаДокумента, 93, 20) );
       Priority = substr(СтрокаДокумента, 113, 2);
       _dvalue = DatePay;
       _ddate = StringToDate(substr(СтрокаДокумента, 115, 10));
   end;   
end;

array Payments;
array PaymentsSum;

private macro sumf(сумма)
if (substr(сумма,index(сумма)) == "00")
return string(substr(сумма,(strlen(сумма)-3)),"=");
else
return (strsubst(сумма,".","-"));
end;
end;


macro СохранитьСообщение()
  var field, buff;
  var paym = FieldsMes;

  if( СчитатьПоле( field, buff ) )
     paym.FillFields( buff );
     Payments[asize(Payments)] = paym;
  else
     ErrExport("Не прочитаны поля сообщения");
     return false;
  end;
  return true;
end;

macro GetNameBank( RespID )
   FILE Party( party ) key 0;
   party.PartyID = RespID;
   if ( getEQ(party) )
       return party.Name;
   else return "Не найден";
   end;
end;

macro GetShortNameBank( RespID )
   FILE Party( party ) key 0;
   party.PartyID = RespID;
   if ( getEQ(party) )
       return party.ShortName;
   else return "Не найден";
   end;
end;
/*
Зубко С. 12.05.2011
Сделал так, чтобы город брался из BANKDPRT, а не из адреса

macro GetPlaceBank( RespID )
   record RecordAdress ( adress );
   if ( НайтиЮридическийАдресСубъекта(RespID,RecordAdress) )
       return RecordAdress.codedistrict + " ." + RecordAdress.district;
   else return "";
   end;
end;
*/

/*
Зубко С. 12.05.2011
Сделал так, чтобы город брался из BANKDPRT, а не из адреса
*/
macro GetPlaceBank( RespID )
   file bankdprt ( bankdprt ) key 0;
   bankdprt.PartyID = RespID;
   if ( GetEQ(bankdprt) )
//     return bankdprt.Place + " " + bankdprt.PlaceName;
     return STRUPR(bankdprt.Place) + bankdprt.PlaceName;
   else 
     return "";
   end;
end;


macro DateToStr( pDate )
   var str, День, Месяц, Год;
   array month;
   month[1]  = "января";
   month[2]  = "февраля";
   month[3]  = "марта";
   month[4]  = "апреля";
   month[5]  = "мая";
   month[6]  = "июня";
   month[7]  = "июля";
   month[8]  = "августа";
   month[9]  = "сентября";
   month[10] = "октября";
   month[11] = "ноября";
   month[12] = "декабря";

   datesplit( pDate, День, Месяц, Год ) ;

   if ( Год<80 )
     Год = Год + 2000;
   elif ( Год<100 )
     Год = Год + 1900;
   end;

   День = string( День:2 );
   День = strfor( 34 ) + StrSubst( День, " ", "0" ) + strfor( 34 );
   str = string( День, " ", month[Месяц], " ", Год, " г." ); 
   return str;
end;

macro FormatDate( pDate )
   var str, День, Месяц, Год;

   datesplit( pDate, День, Месяц, Год ) ;

   if ( Год<80 )
     Год = Год + 2000;
   elif ( Год<100 )
     Год = Год + 1900;
   end;

   str = StrSubst( string(День:2, ".", Месяц:2, ".", Год:4), " ", "0" ); 
   return str;
end;

macro ЗаписатьСводноеПлатежноеПоручение( Документов, СуммаДокументов, Kind, rec_wlmes )

  var i, N, error, КодУчастникаКорр;
  array strings;
  /*Переменные добавил Зубко С.чтобы вычислять длину, а потом использовать дальше*/
  var ИмяБанкаПолучателя:string = ""; 
  var ГородБанкаПолучателя:string = "";


  // KS 04.02.2011 Номер сводного созраняю в номене рейса
  RaceNumber = GetLastNumberRace(wlsess.bankdate,wlsess.TPFRMTID)+1; 
  SetNumberRace(RaceNumber,wlsess.SESSIONID); 

  if ( (rec_wlmes.OutsideAbonentCodeKind==PTCK_BIC) AND (rec_wlmes.OutsideAbonentCode!="") )
     КодУчастникаКорр = rec_wlmes.OutsideAbonentCode;
     error = 0;
  else
     КодУчастникаКорр = ПолучитьОткрытыйКодСубъекта( rec_wlmes.OutsideAbonentID, PTCK_BIC, error );
  end;

  if ( error )
     ErrExport("Не найден код получателя сообщения");
     return false;
  end;

  strings[asize(strings)] = "(3R(s0p13.50h8.5v0s0b20T&l1X&l8D&l0O&a7L&l2E                                             &l8D";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "                                                                                  ┌───────┐";
  strings[asize(strings)] = "──────────────────    ──────────────────                                          │0401060│";
  strings[asize(strings)] = "Поступ.в банк плат.   Списано со сч.плат.                                         └───────┘";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "СВОДНОЕ                                                                            ┌────┐       &l8D";
/*  strings[asize(strings)] = "ПЛАТЕЖНОЕ ПОРУЧЕНИЕ № " + string(wlsess.Number:9) + "             " + FormatDate({curdate}) + "       " + string(Kind:13:c)+"        │    │       &l3.45C";*/
//  strings[asize(strings)] = "ПЛАТЕЖНОЕ ПОРУЧЕНИЕ № " + string(wlsess.Number:9) + "             " + FormatDate(_dvalue) + "            " + string(Kind:10:c)+"       │    │       &l3.45C";
  // KS 04.02.2011 Номер сводного созраняю в номене рейса
  strings[asize(strings)] = "ПЛАТЕЖНОЕ ПОРУЧЕНИЕ № " + string(RaceNumber:9) + "             " + FormatDate(_dvalue) + "            " + string(Kind:10:c)+"       │    │       &l3.45C";
  strings[asize(strings)] = "                                       ───────────────────   ───────────────────   └────┘       &l3.45C";
  strings[asize(strings)] = "                                              Дата               Вид платежа                    &l3.45C";
  strings[asize(strings)] = "          │                                                                                     &l3.45C";
  strings[asize(strings)] = "Сумма     │  " + RubToStr( СуммаДокументов, true )+" &l3.45C";
  strings[asize(strings)] = "          │                                                                                     &l8D";
  strings[asize(strings)] = "прописью  │                                                                                     &l3.45C";
  strings[asize(strings)] = "          │                                                                                     &l8D";
  strings[asize(strings)] = "          │                                                                                     &l3.45C";
  strings[asize(strings)] = "──────────┴───────────────┬──────────────────────────┬───────┬──────────────────────────────────&l8D";
  strings[asize(strings)] = "ИНН                       │ КПП                      │ Сумма │ "+sumf(string(СуммаДокументов:f))+" &l3.45C";
  strings[asize(strings)] = "──────────────────────────┴──────────────────────────┤       │                                  &l8D";
//  strings[asize(strings)] = "   ОАО \"ГАЗЭНЕРГОБАНК\" Г. КАЛУГА                   │       │                                  &l3.45C";
  // KS 21.12.2010 I-087765 Почтовые платежи. Замечания
  strings[asize(strings)] = string(({Name_Bank}+" "+
                                                  GetPlaceBank({OurBank})):52) + " │       │                                  &l3.45C";

  strings[asize(strings)] = "                                                     │       │                                  &l8D";
  strings[asize(strings)] = "                                                     │       │                                  &l3.45C";
  strings[asize(strings)] = "                                                     ├───────┼──────────────────────────────────&l8D";
  strings[asize(strings)] = "                                                     │ Сч. № │ "+{CORAC_Bank}+"             &l3.45C";
  strings[asize(strings)] = "                                                     │       │                                  &l8D";
  strings[asize(strings)] = "                                                     │       │                                  &l3.45C";
  strings[asize(strings)] = "                                                     │       │                                  &l8D";
  strings[asize(strings)] = "Плательщик                                           │       │                                  &l3.45C";
  strings[asize(strings)] = "─────────────────────────────────────────────────────┼───────┤                                  &l8D";
  private var err;

  if   ( fgBank.is_GEB ) // KS 21.12.2010 I-087765 Почтовые платежи. Замечания
    strings[asize(strings)] = " ГРКЦ ГУ БАНКА РОССИИ ПО КАЛУЖСКОЙ ОБЛ. Г. КАЛУГА    │ БИК   │ "+{MFO_RCC}+" &l3.45C";
    strings[asize(strings)] = "                                                     ├───────┤                                  &l8D";
  elif ( fgBank.is_VUZ )
    strings[asize(strings)] = " ГРКЦ ГУ БАНКА РОССИИ ПО СВЕРДЛОВСКОЙ ОБЛ. Г.        │ БИК   │ "+{MFO_RCC}+" &l3.45C";
    strings[asize(strings)] = " ЕКАТЕРИНБУРГ                                        ├───────┤                                  &l8D";
  elif ( fgBank.is_EXV )
/*  strings[asize(strings)] = " ГРКЦ ГУ БАНКА РОССИИ ПО САРАТОВСКОЙ ОБЛ. Г.САРАТОВ  │ БИК   │ "+{MFO_RCC}+" &l3.45C";*/
    /*Зубко С. 12.05.2011 Наряд номер I-00046982
      Сделал так, чтобы добавлялось имя города. В случае, если дина больше 53, то печатается и на сл. строке*/
    ИмяБанкаПолучателя   = trim(GetNameBank(ПолучитьКодсубъекта({MFO_RCC},3,err)));
    ГородБанкаПолучателя = trim(GetPlaceBank({OurBank}));
    /*Если имя + город вмещается в строку, то сделаем имя+город*/
    if ((StrLen(ИмяБанкаПолучателя) + StrLen(ГородБанкаПолучателя)) < 51)
      ИмяБанкаПолучателя = string(ИмяБанкаПолучателя," ",ГородБанкаПолучателя);
      strings[asize(strings)] = string(ИмяБанкаПолучателя:53:l) + "│ БИК   │ "+{MFO_RCC}+" &l3.45C";
      strings[asize(strings)] = "                                                     ├───────┤                                  &l8D";
    else
      strings[asize(strings)] = string(ИмяБанкаПолучателя:53:l)   + "│ БИК   │ "+{MFO_RCC}+" &l8D";
      strings[asize(strings)] = string(ГородБанкаПолучателя:53:l) + "├───────┤                                  &l8D";
    end

  else
    strings[asize(strings)] = " ОПЕРУ МОСКОВСКОГО ГТУ БАНКА РОССИИ, Г. МОСКВА 35    │ БИК   │ "+{MFO_RCC}+" &l3.45C";
    strings[asize(strings)] = "                                                     ├───────┤                                  &l8D";
  end;

  strings[asize(strings)] = "                                                     │ Сч. № │                                  &l3.45C";
  strings[asize(strings)] = "                                                     │       │                                  &l8D";
  strings[asize(strings)] = "Банк плательщика                                     │       │                                  &l3.45C";
  strings[asize(strings)] = "─────────────────────────────────────────────────────┼───────┼──────────────────────────────────&l8D";
  strings[asize(strings)] = " РАЗНЫЕ                                              │ БИК   │                                  &l3.45C";
  strings[asize(strings)] = "                                                     ├───────┤                                  &l8D";
  strings[asize(strings)] = "                                                     │ Сч. № │                                  &l3.45C";
  strings[asize(strings)] = "                                                     │       │                                  &l8D";
  strings[asize(strings)] = "Банк получателя                                      │       │                                  &l3.45C";
  strings[asize(strings)] = "──────────────────────────┬──────────────────────────┼───────┤                                  &l8D";
  strings[asize(strings)] = "ИНН                       │ КПП                      │ Сч. № │                                  &l3.45C";
  strings[asize(strings)] = "──────────────────────────┴──────────────────────────┤       │                                  &l8D";
  strings[asize(strings)] = " РАЗНЫЕ                                              │       │                                  &l3.45C";
  strings[asize(strings)] = "                                                     │       │                                  &l8D";
  strings[asize(strings)] = "                                                     │       │                                  &l3.45C";
  strings[asize(strings)] = "                                                     ├───────┼──────────┬──────────┬────────────&l8D";
  strings[asize(strings)] = "                                                     │Вид.оп.│          │Срок.плат.│            &l3.45C";
  strings[asize(strings)] = "                                                     ├───────┤          ├──────────┤            &l8D";
  strings[asize(strings)] = "                                                     │Наз.пл.│          │Очер.плат.│ "+substr(Payments[0].Priority,2,1)+" &l3.45C";
  strings[asize(strings)] = "                                                     ├───────┤          ├──────────┤            &l8D";
  strings[asize(strings)] = "Получатель                                           │Код    │          │Рез. поле │            &l3.45C";
  strings[asize(strings)] = "───────────────────────┬───────────────┬────┬────────┴───┬───┴──────────┴───┬──────┴─────┬──────&l8D";
  strings[asize(strings)] = "                       │               │    │            │                  │            │      &l3.45C";
  strings[asize(strings)] = "───────────────────────┴───────────────┴────┴────────────┴──────────────────┴────────────┴──────&l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  if (( fgBank.is_VUZ ) or ( fgBank.is_EXV )) // KS 21.12.2010 I-087765 Почтовые платежи. Замечания
    strings[asize(strings)] = " Количество документов - "+string(Документов)+" &l3.45C";
  else
    strings[asize(strings)] = " Кол-во док-тов - "+string(Документов)+" &l3.45C";
  end;
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "Назначение платежа                                                                              &l3.45C";
  strings[asize(strings)] = "────────────────────────────────────────────────────────────────────────────────────────────────&l8D";
  strings[asize(strings)] = "                           Подписи                                Отметки банка                 &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                    ────────────────────────────────                                            &l8D";
  strings[asize(strings)] = "      М.П.                                                                                      &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                    ────────────────────────────────                                            &l8D";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  strings[asize(strings)] = "                                                                                                &l3.45C";
  strings[asize(strings)] = "                                                                                                &l8D";
  // strings[asize(strings)] = "";

  i = 0;
  N = asize(strings);
  while( i<N )
     if( not ЗаписатьСтроку( strings[i] ) )
       ErrExport("Ошибка записи строки сообщения " );
       return false;
     end;
     i = i+1;
  end;  
  return true;
end;

macro ЗаписатьОписьПлатежныхДокументов( Документов, СуммаДокументов, rec_wlmes )
  var i, j, c, N, КодУчастникаКорр, error;
  var buf = $0;
  var bufstr;
  array strings;

  if ( (rec_wlmes.OutsideAbonentCodeKind==PTCK_BIC) AND (rec_wlmes.OutsideAbonentCode!="") )
     КодУчастникаКорр = rec_wlmes.OutsideAbonentCode;
     error = 0;
  else
     КодУчастникаКорр = ПолучитьОткрытыйКодСубъекта( rec_wlmes.OutsideAbonentID, PTCK_BIC, error );
  end;

  if ( error )
     ErrExport("Не найден код получателя сообщения");
     return false;
  end;

if ( fgBank.is_VUZ )
  strings[asize(strings)] = "(3R(s0p13.5h8.5v0s0b0T&l1X&l8D&l1O&a5L";
  strings[asize(strings)] = "                                                                                                    ┌───────┐ &l8D";
  strings[asize(strings)] = string( {Name_Bank}:43:l ) +               "                                                         │0401064│ &l16D";
  strings[asize(strings)] = "Наименование кредитной организации(филиала)                                                         └───────┘ &l8D";
/*  strings[asize(strings)] = "───────────────────────────────────────────                                                         └───────┘ &l8D";*/
  strings[asize(strings)] = "БИК " + string({MFO_Bank}:9:l)+" &l16D";
  strings[asize(strings)] = "    ─────────────────────────────────────── &l8D";
  strings[asize(strings)] = "К/c " + {CORAC_Bank}+" &l16D";
  strings[asize(strings)] = "    ─────────────────────────────────────── &l8D";
  strings[asize(strings)] = "ГРКЦ/РКЦ " + string( GetNameBank(rec_wlmes.OutsideAbonentID):50:l)+" &l16D";
  strings[asize(strings)] = "         ────────────────────────────────── &l8D";
  strings[asize(strings)] = "БИК " + string(КодУчастникаКорр:9)+" &l16D";
  strings[asize(strings)] = "    ─────────────────────────────────────── &l8D";
  strings[asize(strings)] = DateToStr( _dvalue )+" &l16D";
  strings[asize(strings)] = " ──  ─────────────────                      &l8D";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "                                      ОПИСЬ РАСЧЕТНЫХ ДОКУМЕНТОВ";
  strings[asize(strings)] = "";
  // KS 04.02.2011 Номер сводного созраняю в номене рейса
//  strings[asize(strings)] = "                                    № " + string(wlsess.Number:4:r) + " от " + DateToStr( /*{curdate}*/_dvalue )+" &l16D";
  strings[asize(strings)] = "                                    № " + string(RaceNumber:4:r) + " от " + DateToStr( /*{curdate}*/_dvalue )+" &l16D";
// KS 21.12.2010 I-087765 Почтовые платежи. Замечания
//  strings[asize(strings)] = "                                      ────     ──  ─────────────────  &l8D";
  strings[asize(strings)] = "(3R(s0p16.67h8.5v0s0b0T&l1X&l8D&l1O&a5L";
  strings[asize(strings)] = "┌─────┬──────┬────────────────┬──────────┬─────────────┬────────────────────┬─────────┬────────────────────┬────────────────────┬────┐";
  strings[asize(strings)] = "│ №   │Вид   │  № документа   │Дата      │ Сумма       │ Номер              │ БИК     │ Номер              │ Номер              │От- │";
  strings[asize(strings)] = "│п/п  │опе-  │                │документа │ документа   │ лицевого           │ банка   │ корреспондентского │ лицевого           │мет-│";
  strings[asize(strings)] = "│     │рации │                │          │             │ счета              │ получа- │ счета              │ счета              │ки  │";
  strings[asize(strings)] = "│     │(шифр │                │          │             │ плательщика        │ теля    │ банка              │ получателя         │бан-│";
  strings[asize(strings)] = "│     │док.) │                │          │             │                    │         │ получателя         │                    │ка  │";
  strings[asize(strings)] = "├─────┼──────┼────────────────┼──────────┼─────────────┼────────────────────┼─────────┼────────────────────┼────────────────────┼────┤";
  strings[asize(strings)] = "│  1  │   2  │       3        │    4     │      5      │          6         │    7    │          8         │          9         │ 10 │";
  strings[asize(strings)] = "├─────┼──────┼────────────────┼──────────┼─────────────┼────────────────────┼─────────┼────────────────────┼────────────────────┼────┤";
 else
  strings[asize(strings)] = "";
  strings[asize(strings)] = "(3R(s0p13.5h8.5v0s0b0T&l1X&l8D&l0O&a5L";
  strings[asize(strings)] = "                                                                                 ┌───────┐ &l8D";
  strings[asize(strings)] = string( {Name_Bank}:43:l ) +               "                                      │0401064│ &l16D";
  strings[asize(strings)] = "───────────────────────────────────────────                                      └───────┘ &l8D";
  strings[asize(strings)] = "БИК " + string({MFO_Bank}:9:l)+" &l16D";
  strings[asize(strings)] = "    ─────────────────────────────────────── &l8D";
  strings[asize(strings)] = "К/c " + {CORAC_Bank}+" &l16D";
  strings[asize(strings)] = "    ─────────────────────────────────────── &l8D";
  strings[asize(strings)] = "ГРКЦ/РКЦ " + string( GetNameBank(rec_wlmes.OutsideAbonentID):50:l)+" &l16D";
  strings[asize(strings)] = "         ────────────────────────────────── &l8D";
  strings[asize(strings)] = "БИК " + string(КодУчастникаКорр:9)+" &l16D";
  strings[asize(strings)] = "    ─────────────────────────────────────── &l8D";
  strings[asize(strings)] = DateToStr( _dvalue )+" &l16D";
  strings[asize(strings)] = " ──  ─────────────────                      &l8D";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "                                      ОПИСЬ РАСЧЕТНЫХ ДОКУМЕНТОВ";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "                                    № " + string(RaceNumber:4:r) + " от " + DateToStr( /*{curdate}*/_dvalue )+" &l16D";
  strings[asize(strings)] = "                                      ────     ──  ─────────────────  &l8D";
  strings[asize(strings)] = "(3R(s0p16.67h8.5v0s0b0T&l1X&l8D&l0O&a5L";
  strings[asize(strings)] = "┌─────┬──────┬─────┬──────────┬─────────────┬────────────────────┬─────────┬────────────────────┬────────────────────┬────┐";
  strings[asize(strings)] = "│ №   │Вид   │№    │Дата      │ Сумма       │ Номер              │ БИК     │ Номер              │ Номер              │От- │";
  strings[asize(strings)] = "│п/п  │опе-  │доку-│документа │ документа   │ лицевого           │ банка   │ корреспондентского │ лицевого           │мет-│";
  strings[asize(strings)] = "│     │рации │мента│          │             │ счета              │ получа- │ счета              │ счета              │ки  │";
  strings[asize(strings)] = "│     │(шифр │     │          │             │ плательщика        │ теля    │ банка              │ получателя         │бан-│";
  strings[asize(strings)] = "│     │док.) │     │          │             │                    │         │ получателя         │                    │ка  │";
  strings[asize(strings)] = "├─────┼──────┼─────┼──────────┼─────────────┼────────────────────┼─────────┼────────────────────┼────────────────────┼────┤";
  strings[asize(strings)] = "│  1  │   2  │  3  │    4     │      5      │          6         │    7    │          8         │          9         │ 10 │";
  strings[asize(strings)] = "├─────┼──────┼─────┼──────────┼─────────────┼────────────────────┼─────────┼────────────────────┼────────────────────┼────┤";
 end;
  i=0;
  c = asize(strings);                            

 if ( fgBank.is_VUZ )
 
  while( i<Документов )
     PaymentsSum[i] = Payments[i].Sum;
     strings[asize(strings)] = string( /*"│", (i+1):5, */"│", Payments[i].ShifrOperation:6:r, "│",
                               Payments[i].Number:16:r, "│", FormatDate(Payments[i]._dDate), "│",  Payments[i].Sum:13:f, "│", Payments[i].PayerAccount:20, "│",
                               Payments[i].ReceiverBankCode:9, "│", Payments[i].ReceiverCorrAccNostro:20, "│", Payments[i].ReceiverAccount:20, "│    │" );
     i = i+1;
  end;
 else
  while( i<Документов )
     PaymentsSum[i] = Payments[i].Sum;
     strings[asize(strings)] = string(/* "│", (i+1):5,*/ "│", Payments[i].ShifrOperation:6:r, "│",
                               Payments[i].Number:5:r, "│", FormatDate(Payments[i]._dDate), "│",  Payments[i].Sum:13:f, "│", Payments[i].PayerAccount:20, "│",
                               Payments[i].ReceiverBankCode:9, "│", Payments[i].ReceiverCorrAccNostro:20, "│", Payments[i].ReceiverAccount:20, "│    │" );
     i = i+1;
  end;
 end;

  i=0; // KS 11.01.2011 Сортировка по сумме
       //               к сожалению ничего другого не придумал :(
  while( i<Документов-1 )
     j=i;
     while( j<Документов )
        if (PaymentsSum[i]>PaymentsSum[j])
          buf = PaymentsSum[j];   
          PaymentsSum[j] = PaymentsSum[i];
          PaymentsSum[i] = buf;
          bufstr = strings[c+i];
          strings[c+i] = strings[c+j];
          strings[c+j] = bufstr;
        end;
        j = j+1;
     end;
     i = i+1;
  end;

  i=0; // KS 11.01.2011 Пронумерую
  while( i<Документов )
     strings[c+i] = string( "│", (i+1):5) + strings[c+i];
     i = i+1;
  end;
  
  if ( fgBank.is_VUZ )
    strings[asize(strings)] = "├─────┼──────┼────────────────┼──────────┼─────────────┼────────────────────┼─────────┼────────────────────┼────────────────────┼────┤";
    strings[asize(strings)] = "│ИТОГО│  X   │       X        │    X     │" + string(СуммаДокументов:13:f) + "│          X         │    X    │          X         │          X         │ X  │";
    strings[asize(strings)] = "└─────┴──────┴────────────────┴──────────┴─────────────┴────────────────────┴─────────┴────────────────────┴────────────────────┴────┘";
  else
    strings[asize(strings)] = "├─────┼──────┼─────┼──────────┼─────────────┼────────────────────┼─────────┼────────────────────┼────────────────────┼────┤";
    strings[asize(strings)] = "│ИТОГО│  X   │  X  │    X     │" + string(СуммаДокументов:13:f) + "│          X         │    X    │          X         │          X         │ X  │";
    strings[asize(strings)] = "└─────┴──────┴─────┴──────────┴─────────────┴────────────────────┴─────────┴────────────────────┴────────────────────┴────┘";
  end;

  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "                                                                            Подписи";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
// KS 21.12.2010 I-087765 Почтовые платежи. Замечания
 if ( fgBank.is_VUZ )
  strings[asize(strings)] = "      М.П.";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
 else
  strings[asize(strings)] = "      М.П.                                                             _________________________";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "";
  strings[asize(strings)] = "                                                                       _________________________";
 end;
  i = 0;
  N = asize(strings);
  while( i<N )
     if( not ЗаписатьСтроку( strings[i] ) )
       ErrExport("Ошибка записи строки сообщения " );
       return false;
     end;
     i = i+1;
  end;  
  return true;
end;

/* Процедура экспорта */
macro ExportProc( FileName:string, addrSess, Kind:string )
  var loop = TRUE, Документов = 0, СуммаДокументов = 0, i;
 
  Record PostMes(wlmes);

  SetBuff( wlSess, addrSess );

  if( not СчитатьЗапись( wlmes ) )
    ErrExport("Не найдено ни одного сообщения для отправки");
    return false;
  end;  

  /* Параметры внешнего абонента берем из первого выгружаемого сообщения */
  copy( PostMes, wlmes );

  if( PostMes.OutsideAbonentID == 0 )
    ErrExport("Внешний абонент сообщения по транспорту \"Почта\" не может являться \"нашим\" банком");
    return false;
  end;  

  while( loop )
    if( not СохранитьСообщение() )
      return false;
    end;
    if( not СчитатьЗапись( wlmes ) )
       loop = FALSE;
    end;
    СуммаДокументов = СуммаДокументов + Payments[Документов].Sum;
    Документов = Документов + 1;    
    message( "Идет выгрузка документов. Отправлено: ", Документов );
  end;

  if( not ЗаписатьСводноеПлатежноеПоручение(Документов, СуммаДокументов, Kind, PostMes) )
    return false;
  end;

  if( not ЗаписатьОписьПлатежныхДокументов(Документов, СуммаДокументов, PostMes) )
    return false;
  end;
  
  return true;
end;

macro PostOutProc( FileName, addrSess )
    return ExportProc( FileName, addrSess, "почтой" );
end;

macro TlgOutProc( FileName, addrSess )
    return ExportProc( FileName, addrSess, "Телеграф" )
end;


