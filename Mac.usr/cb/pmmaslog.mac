/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : pmmaslog.mac
  Created     : 17.07.2009
  Description : ”®à¬¨à®¢ ­¨¥ ®âç¥â  ® ¬ áá®¢®¬ ¢ë¯®«­¥­¨¨ ®¯¥à æ¨© 
                ¯® ¯« â¥¦ ¬
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import rsd, globals, PaymInter, likepy;

/* ¯®«ãç¨âì §­ ç¥­¨¥ ¨§ à¥§ã«ìâ â  § ¯à®á  */
private macro getValue( rs : RsdRecordset, fld : string, nullValue : variant ) : variant

  var val = rs.value(fld);
  
  if( val == nullVal )

    if( nullValue != null ) val = nullValue;
    else                    val = "";
    end;

  end;
  
  return val;

end;

private macro PrintRecord(OrderID, Number, Date, StepName, Message)                                                                
[  ³##########³##########³###########³##############³################################################³](OrderID, Number:w, Date, StepName:w, Message:w);
end;

macro PM_ShowMassExecuteLog()
[
 
   ¯¥à æ¨®­¨áâ:        ################                ‚à¥¬ï ä®à¬¨à®¢ ­¨ï ®âç¥â : ########## ########
   ”¨«¨ «:              ################
   ¯¥à æ¨®­­ë© ¤¥­ì:   ################

   ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   ³ID ¯« â¥¦ ³ N ¤®ª-â  ³„ â  ¤®ª-â ³     ˜ £      ³       ¥§ã«ìâ â ®¡à ¡®âª¨ ¤®ªã¬¥­â             ³
   ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]({oper}:l, date(), time(), {OperDprt}:l,{curdate}:l);

  var rs : RsdRecordset;
  var StepName = "", Message = "";
  var oldOrderID = -1, oldID_Step = -1, allOrderID = -1, rejOrderID = -1, errOrderID = -1,
      numAll = 0, numReject = 0, numError = 0;
  
  rs = RsdRecordset( string("select ods.t_OrderID, ods.t_ID_Step, rm.t_Number, rm.t_Date, oos.t_Name, pol.t_Message, pm.t_PaymStatus, ods.t_ErrorStatus, decode( nvl( ods.t_ErrorMessage, CHR(1) ), CHR(1), nvl( msg.t_Contents, CHR(1) ), nvl( ods.t_ErrorMessage, CHR(1) ) ) as t_ErrorMessage ",
                              "from doprdistaff_tmp ods, dpmrmprop_dbt rm, dpmoprlog_tmp pol, doprostep_dbt oos, dpmpaym_dbt pm, dbank_msg msg ",
                              "where ods.t_OrderID = rm.t_PaymentID ",
                                "and ods.t_ID_Operation = pol.t_ID_Operation(+) ",
                                "and ods.t_ID_Step = pol.t_ID_Step(+) ",
                                "and ods.t_BlockID = oos.t_BlockID(+) ",
                                "and ods.t_Number_Step = oos.T_Number_Step(+) ",
                                "and ods.t_OrderID = pm.t_PaymentID ",
                                "and msg.t_Number(+) = ods.t_ErrorStatus ",
                             "order by ods.t_OrderID, ods.t_ID_Step "));

  while( rs.moveNext() )
    
    if((oldOrderID != -1) and (oldOrderID != rs.value("t_OrderID")))                               
[  ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
    end;                                            
    
    if(rs.value("t_ID_Step") == 0)
      StepName = "ˆ­¨æ¨ «¨§ æ¨ï ®¯¥à æ¨¨";
    else
      StepName = getValue(rs, "t_Name");
    end;
    
    if(rs.value("t_ErrorStatus") == 0)
      if(getValue(rs, "t_Message") == "")
        Message = "¡à ¡®â ­";
      else
        Message = getValue(rs, "t_Message");
      end;
    else
      Message = /*"è¨¡ª  ¢ë¯®«­¥­¨ï è £ : " + getValue(rs, "t_ErrorStatus") + " " + */getValue(rs, "t_ErrorMessage");  
    end;
    
    if(oldOrderID != rs.value("t_OrderID"))
      PrintRecord(getValue(rs, "t_OrderID"), getValue(rs, "t_Number"), date(rs.value("t_Date")), StepName, Message);
    elif(oldID_Step != rs.value("t_ID_Step"))
      PrintRecord("", "", "", StepName, Message);
    else
      PrintRecord("", "", "", "", Message);
    end;
  
    oldOrderID = rs.value("t_OrderID");
    oldID_Step = rs.value("t_ID_Step");

    if(allOrderID != rs.value("t_OrderID"))
      numAll = numAll + 1;
      allOrderID = rs.value("t_OrderID");
    end;

    if((rs.value("t_PaymStatus") == PM_REJECTED) and (rejOrderID != rs.value("t_OrderID")))
      numReject = numReject + 1;
      rejOrderID = rs.value("t_OrderID");
    end;
    
    if((rs.value("t_ErrorStatus") != 0) and (errOrderID != rs.value("t_OrderID")))
      numError = numError + 1;
      errOrderID = rs.value("t_OrderID")
    end;

  end;

[  ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ


   ‚á¥£® ¤®ªã¬¥­â®¢:      #######################
   ¨§ ­¨å:
   - ®â¢¥à£­ãâ®:          #######################
   - ­¥ ®¡à ¡®â ­®:       #######################
](numAll:l, numReject:l, numError:l);

end;

