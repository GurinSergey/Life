//-----------------------------------------------------------------------------
// Блок     : 29047 - "Акцепт в кассе ЦАБС"
// Шаг      : 10    - "Акцепт в кассе ЦАБС"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import pm_setst, cbsttls, PTInter, CashInter;
import OprInter, oralib; //Jushmanov 2014-02-25 C-19151

var PaymentObj:RsbPayment;

private const CHOICE_BUTTON_YES = 0;    //Да
private const CHOICE_BUTTON_NO = 1;     //Нет
private var str = "По этому документу Вы уже подтвердили расход";


private macro MsgSubmBefore()

    Array Text;
    Array Buttons;

    Text(0) = str + " Продолжить?" ;

    Buttons(CHOICE_BUTTON_YES)  = " Да ";
    Buttons(CHOICE_BUTTON_NO)   = " Нет ";
    return ConfWin(Text,Buttons);
end;


private macro IsBlockAlsoExecutebyOper( DocumentID:variant, DocKind:integer, Symbol:String, IsExec:String , BlockID:integer ):bool

    var query:string, params:TArray, rs:RsdRecordset;

    if (ValType(BlockID) == V_INTEGER)

        query = "SELECT ST.t_Oper " +
                              " FROM DOPROPER_DBT OP, " +
                                   " DOPRSTEP_DBT ST " +
                             " WHERE OP.T_DOCKIND = :DOCKIND " +
                               " AND OP.T_DOCUMENTID = LPAD(:DOCUMENTID, 34, '0') " +
                               " AND ST.T_ID_OPERATION = OP.T_ID_OPERATION " +
                               " AND ST.T_ISEXECUTE = :ISEXECUTE " +
                               " AND ST.T_BLOCKID = :BLOCKID ";
        params = makeArray(            SQLParam( "DOCKIND"   , DocKind   ),
                                       SQLParam( "DOCUMENTID", DocumentID ),
                                       SQLParam( "ISEXECUTE" , IsExec ),
                                       SQLParam( "BLOCKID" , BlockID ) );
        rs = execSQLselect( query, params, true );
    else
        MsgBox( "Ошибка в указании шага операции");
        return false;
    end;

    if( rs )
        if ( rs.moveNext())
            if( rs.Value(0) == {oper})
                return true;
            else
                return false 
            end;        
        end;
    else
        return false;
    end;

end;


MACRO ExecuteStep( doc, paymDoc )
    var note_text:string = "";

    /*Дополнительная проверка для приходно-расходного кассового ордера*/
    if ((PaymentObj.DocKind == DLDOC_INOUTORDER)
    and    (Opr_IsStepExecuteSymb(PaymentObj.DocumentID, PaymentObj.DocKind, "Г", "X", 29047)
       and (Opr_IsStepExecuteSymb(PaymentObj.DocumentID, PaymentObj.DocKind, "Г", "R", 29047))))

        if(IsBlockAlsoExecutebyOper(PaymentObj.DocumentID,PaymentObj.DocKind, "Г", "X", 29047))
            if (not IsOprMultiExec())
                if (MsgSubmBefore()==1)
                    return 1;
                end;
            else    
                msgbox(str);
                return 1;      
            end;         
        end;
    end;                                                                                       

    if( PM_NeedRejectControl() == true )

        if( NOT CashgetString( note_text, "Причина отказа (возврата)" ) )
            msgbox( "Пользователь прервал выполнение шага операции" );
            return 1;
        end;

        PaymentObj.PaymStatus = PM_REJECTED;
        PM_SetPrimDocumentState( PaymentObj, DOCUMENT_ST_REJECTED );

        if( УстановитьСтатусыПлатежа( OPR_PAYM_STATE, OPR_PM_ST_REJECT ) )
            msgbox("Ошибка при установке сегментов статуса экземпляра операции");
            return 1;
        end;

    else /* если кассовый документ акцептован кассиром:*/
         /*Если документ не является приходно-расходным и акцепт делается впервые*/

        if (not ((PaymentObj.DocKind == DLDOC_INOUTORDER) and (Opr_IsStepExecuteSymb(PaymentObj.DocumentID, PaymentObj.DocKind, "Г", "X", 29047)))) 
            if( УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_CONTROL ) ) //Сегмент контроль - проконтролирован
                msgbox("Ошибка при установке сегментов статуса экземпляра операции");
                return 1;
            end;

            if( УстановитьСтатусыПлатежа( OPR_PAYM_DO, OPR_PM_ST_ENTER ) )               //Документооборот - зачисление
                msgbox("Ошибка при установке сегментов статуса экземпляра операции");
                return 1;
            end;

        /*Если это повторное выполнение шага*/
        elif (Opr_IsStepExecuteSymb( PaymentObj.DocumentID, PaymentObj.DocKind, "Г", "X", 29047))           
            if( УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_CONTROL ) )       //Сегмент контроль - проконтролирован
                msgbox("Ошибка при установке сегментов статуса экземпляра операции");
                return 1;
            end;

            if( УстановитьСтатусыПлатежа( OPR_PAYM_STATE, OPR_PM_ST_CLOSE ) )   
                msgbox("Ошибка при установке сегментов статуса экземпляра операции");
                return 1;
            end;  
        end;
    end;

    // Заполнить примечание
    if( PaymentObj.Notes.AddNote( PM_NOTEKIND_DENIALGROUND, note_text ) != 0 )
        msgbox( "Ошибка при вставке примечания платежа" );
        return 1;
    end;

    return 0;
END;


//Jushmanov 2014-02-25 C-19151
macro PostStepAction( message,      /* 1 - выполнение шага; 2 - откат шага;   */
                      errTrn,       /* статус выполнения шага. 0 - ошибки нет */
                      FirstDoc,     /* указатель на первичный документ        */
                      ID_Oper,      /* внутренний идентификатор операции      */
                      Number_Step,  /* Номер шага операции (из настроек)      */
                      KindOper,     /* номер вида операции                    */
                      KindDoc,      /* номер вида первичного документа        */
                      KindStep,     /* вид шага операции                      */
                      ID_Step )     /* внутренний идентификатор шага операции */
    private var logquery, idStep = ID_Step, idOper = ID_Oper;

    if(( message == OP_EXECUTE_STEP ) and (errTrn == 0) and (IsOprMultiExec))
        if ((valtype(idOper) != V_INTEGER) and (valtype(idOper) != V_STRING)) idOper = 0; end;
        if ((valtype(idStep) != V_INTEGER) and (valtype(idStep) != V_STRING)) idStep = 0; end;

        logquery = "UPDATE usr_doprstep_robot_dbt SET t_is_robot_step = chr(88)" +
                   " WHERE t_id_operation = " + idOper + " AND t_id_step = " + idStep;
        ExecSQL(logquery, null, false);
    end;

    return 0;
end;