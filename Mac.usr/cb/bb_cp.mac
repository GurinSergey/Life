//-----------------------------------------------------------------------------
// Блок      : Вне блока
// Шаг       : Вне шага
// Назначение: Макрос скроллинга
// Описание  : Макрос скроллинга валютных платежей банка
//-----------------------------------------------------------------------------

import bbcpdoc;
import "cb_FillFactura.mac";
import "Print_vk.mac", "repforms.mac";
/*22.09.2010 Chesnokov D. Изменение поля t_reason таблицы dpmdocs_dbt для "старых" платежей*/
import "ChangeReason.mac";
import "diver.mac"; 
//TAM 9.11.11 I-00101757-1
import "NUMBERPACK.mac";

/* Установка подсказки для скролингов из макроса */

private const Hint_ByValueDate:string =
"/*+FIRST_ROWS(200) LEADING(t bbcpord pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx11) USE_NL(t bbcpord pmprop pmrmprop oproper oprcurst)*/";

private const Hint_ByCloseDate:string =
"/*+FIRST_ROWS(200) LEADING(t bbcpord pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx15) USE_NL(t bbcpord pmprop pmrmprop oproper oprcurst)*/";

private const Hint_ByStatus   :string =
"/*+FIRST_ROWS(200) LEADING(t bbcpord pmprop pmrmprop oproper oprcurst) INDEX(t DPMPAYM_DBT_IDX16) INDEX(bbcpord DBBCPORD_DBT_IDX0) USE_NL(t bbcpord pmprop pmrmprop oproper oprcurst)*/";

private const Hint_ByStep     :string =
"/*+FIRST_ROWS(200) LEADING(oprstep oproper t bbcpord pmprop pmrmprop oprcurst) INDEX(oprstep doprstep_dbt_idx10) INDEX(bbcpord dbbcpord_dbt_idx0) INDEX(t dpmpaym_dbt_idx0) USE_NL(oprstep oproper t bbcpord pmprop pmrmprop oprcurst)*/";

MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string
  /* Все, Закрытые */
  if( ( ScrolStates == PSSK_ALL ) or 
      ( ScrolStates == PSSK_CLOSED ) ) 

    var dtflt:PMScrolDateFltr = PMScrolDateFltr();

    if( dtflt.IsSet( DTFL_CLOSEDATE ) )
      return Hint_ByCloseDate;
    elif( dtflt.IsSet( DTFL_VALUEDATE ) )
      return Hint_ByValueDate;
    else
      return Hint_ByCloseDate;
    end;

  /* Отложенные, Открытые, Отвергнутые */
  elif( ( ScrolStates == PSSK_DEFER ) or 
        ( ScrolStates == PSSK_OPEN ) or 
        ( ScrolStates == PSSK_REJECTED_WORK ) )
    return Hint_ByStatus;
  /* Подготовленные к шагу */
  elif( ScrolStates == PSSK_STEP )
    return Hint_ByStep;
  end;

  return DefaultHint;

END;

macro Новый_Документ( )

  if( r_pmpaym.DocKind == BBANK_CPORDER )
    return BB_CurPayOrderNewDoc();
  end;

  msgbox("Неизвестный вид документа");
  return 1;
end;

macro  Проверить_Документ( Режим )

  /* EVG Проверка номера пачки */
  if (r_pmpaym.NumberPack < 0)
     msgbox ( "Номер пачки не может быть отрицательным!" );
     return 42;
  end;
  
  if( r_pmpaym.DocKind == BBANK_CPORDER )
    return BB_CurPayOrderCheckDoc( Режим );
  end;

  msgbox("Неизвестный вид документа");
  return 1;

end;

macro    Функция_Пользователя( Режим:integer  )

   var cmd, rs;

   var m;
   var rub, kop,CURtext;
     /*Порядковый номер уведомления*/
   var Num:integer = 0;
   /*22.09.2010 Chesnokov D. Генерируем объект платеж*/
   var PaymentObj:Rsbpayment=Rsbpayment(r_pmpaym.paymentId);
   
   array mn;
   //Tikh

   /* EVG 13/03/2012 */
   var EditF72 = false;

   If (IsCarry(r_pmpaym.paymentid)) //если зачисление состоялось
      If ((r_pmpaym.basefiid == 0) and ISPayerNerezAcc(r_pmpaym.PayerAccount)) //поступили рубли от нерезидента

         mn(0)="печать извещения о поступлении выручки от нерезидента";
         mn(1)="Изменение платежа ФМ";
                  //TAM 9.11.11 I-00101757-1
         mn(asize(mn))="Сменить номер пачки";

         /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
         mn(asize(mn)) = "Редактировать доп. информацию (поле 72)";

         m=menu(mn,null,"Выберите действие над платежом");

         if (m == 0)
            CURtext    = CurToStrAlt(r_pmpaym.amount, rub, kop, GetIsoByID(r_pmpaym.basefiid, false)); 
            ПечатьИзвещения(r_pmpaym.receiveraccount,r_pmrmprop.receivername,r_pmpaym.amount,
                          SubStr(CURtext, StrLen(rub)+1, Index(CURtext,kop)-Strlen(rub)-1), CURtext, r_pmpaym.paymentid, false);
         elif (m == 1)
           ChangeReason(PaymentObj);
                  //TAM 9.11.11 I-00101757-1
                 elif (mn(m)=="Сменить номер пачки")
                        if (ВходитВГруппу({oper},107))
                                NUMBERPACK(paymentObj.paymentID,PaymentObj.NumberPack);
                        else
                                msgbox("Вы не включены в группу \"107 - Право исправлять номер пачки в закрытых документах\"");
                        end;

         /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
         elif( m == 2 )
            EditF72 = true;
         end;

      elif ((r_pmpaym.basefiid != 0) and (not(ISPayerNerezPtID(r_pmpaym.payer))) and (ISTransitAcc(r_pmpaym.receiveraccount))) //поступила валюта резиденту на транзитный счет
         mn(0)="печать уведомления о поступлении валюты резиденту";
         mn(1)="Изменение платежа ФМ";
                //TAM 9.11.11 I-00101757-1
         mn(asize(mn))="Сменить номер пачки";
         //mn(1)="список распоряжений по транзитному счету";

         /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
         mn(asize(mn)) = "Редактировать доп. информацию (поле 72)";

         m=menu(mn,null,"Выберите действие над платежом");

         if (m == 0)
            CURtext    = CurToStrAlt(r_pmpaym.amount, rub, kop, GetIsoByID(r_pmpaym.basefiid, false)); 
            ПечатьУведомления(date(r_pmpaym.valuedate),r_pmpaym.receiveraccount,r_pmrmprop.receivername,r_pmpaym.amount,
                       SubStr(CURtext, StrLen(rub)+1, Index(CURtext,kop)-Strlen(rub)-1), CURtext,
                       DateAfterWorkDays(date(r_pmpaym.valuedate),7), r_pmrmprop.receiverBankname, r_pmpaym.paymentid, false);
         elif (m == 1)
            //show_orders_list(pmpaym.paymentid, pmpaym.futurereceiveraccount); //показ списка распоряжений по тр. счету на просмотр
            ChangeReason(PaymentObj);
          //TAM 9.11.11 I-00101757-1
         elif (mn(m)=="Сменить номер пачки")
                if (ВходитВГруппу({oper},107))
                        NUMBERPACK(paymentObj.paymentID,PaymentObj.NumberPack);
                else
                        msgbox("Вы не включены в группу \"107 - Право исправлять номер пачки в закрытых документах\"");
                end;

         /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
         elif( m == 2 )
            EditF72 = true;
         end
      else
         mn(0)="Изменение платежа ФМ";

         /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
         mn(asize(mn)) = "Редактировать доп. информацию (поле 72)";

         m=menu(mn,null,"Выберите действие над платежом");
                //TAM 9.11.11 I-00101757-1
         mn(asize(mn))="Сменить номер пачки";
         if (m == 0)
             ChangeReason(PaymentObj);
         elif (mn(m)=="Сменить номер пачки")
                if (ВходитВГруппу({oper},107))
                        NUMBERPACK(paymentObj.paymentID,PaymentObj.NumberPack);
                else
                        msgbox("Вы не включены в группу \"107 - Право исправлять номер пачки в закрытых документах\"");
                end;
         /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
         elif( m == 1 )
            EditF72 = true;
         end;
      end;

   else

      /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
      mn(asize(mn)) = "Редактировать доп. информацию (поле 72)";
      m=menu(mn,null,"Выберите действие над платежом");
      if (m == 0)
         EditF72 = true;
      end;

   end;

   /* EVG 13/03/2012 Добавлена возможность ввода дополнительной информация (поле 72) */
   if( EditF72 )

      GetString( PaymentObj.AdditionalInfo, "Редактировать доп. информацию (поле 72)" );
      if( PaymentObj.AdditionalInfo != r_pmrmprop.AdditionalInfo )
//SDA 18.06.2012 - возможность редактирования в т.ч. макетов
        IF (Gettrue(false,"Перенести в поле Доп. информации по платежу?"))
         r_pmrmprop.Ground = PaymentObj.AdditionalInfo;
         PaymentObj.Ground = r_pmrmprop.Ground;
         r_pmrmprop.AdditionalInfo = "";
         PaymentObj.AdditionalInfo ="" ;
        else
         r_pmrmprop.AdditionalInfo = PaymentObj.AdditionalInfo;
        end;
/*
         cmd = RSDCommand( " Update dpmrmprop_dbt Set t_AdditionalInfo = ? Where t_PaymentId = ? " );
         cmd.AddParam("aInf", RSDBP_IN, PaymentObj.AdditionalInfo);
         cmd.AddParam("pmid", RSDBP_IN, PaymentObj.PaymentID);
         cmd.execute();
*/
      end;
      //msgbox (PaymentObj.AdditionalInfo, " - ", pmrmprop.AdditionalInfo, " - ", OldPmrmprop.AdditionalInfo);
   end;

 /*
 Возможные значения Режим:
  UFN_PANEL_INPUT(1) - функция вызвана из панели ввода объекта;
  UFN_PANEL_EDIT(2) - функция вызвана из панели корректировки объекта;
  UFN_SCROL(3) - функция вызвана из панели скролинга, единичный вызов, любая корректировка объекта запрещена;
  UFN_SCROL_FMASS(4) - функция вызвана из панели скролинга, работа по нескольким записям, вызов до начала обработки, любая корректировка объекта запрещена;
 
// Пример работы: 
 if( Режим == UFN_SCROL )
   return UPDTPAGE;    // Обновить страницу записей и область скролинга
   //return UPDTREC;     // Обновить текущую запись, загрузив из файла
 end;
 */
 return 0;
end;

macro ProcessPanel(mode, key, field, panel)
   var i=0,str ="";

   MACRO getISOName( FIID:integer )
    var str;
    record fi( "fininstr.dbt", "bank.def" );
    if( FIID >= 0 )
     if( ПолучитьФинИн( FIID, fi ) == 0 )
       str = fi.Name;
       return str;
     end;
    end;
   return "";
   END;



//SDA 02.07.2012 - обращения только к полям панели валютного платежа
   if (Panel.ResourceName=="PCPORD");
//SDA 02.07.2012 - лечим проблему сообщения  1502 Не найден финансовый инструмент -1 в случае, если сначала была введена валюта счета плательщика -
//                 несмотря на то что в форме заполняется влюта платежа - она не инициализируется в рекорде записи платежа
    if (r_pmpaym.BaseFIID == -1)
      r_pmpaym.BaseFIID = r_pmpaym.FIID;
    end;
   end;

//*SDA 08.08.2012 документы из фронта вставляются с нулевой суммой Pmpaym.orderamount и нулевой валютой.
//                 все как и в РКО было 
     if (panel.Fields.Item(3).value == 0)
        panel.Fields.Item(3).value = r_Pmpaym.amount; 
        r_Pmpaym.orderamount = r_Pmpaym.amount; 
        panel.Fields.Item(4).value = panel.Fields.Item(9).value; 
   
        r_Pmpaym.FIID = ПолучитьКодФинИН(panel.Fields.Item(9).value);  
        r_Pmpaym.PAYFIID = r_Pmpaym.FIID;
        r_Pmpaym.BASEFIID = r_Pmpaym.FIID;
        r_Pmpaym.orderFIID = r_Pmpaym.FIID; 
        str = getISOName(r_Pmpaym.FIID); panel.Fields.Item(5).value = str; 
     end;


end;
