/*
 * Функции для работы с исправительными оборотами
 */
Import BankInter, FIInter, OprInter, "globals.mac";

record acctrn("acctrn.dbt");
/* 
   Макрофункция вызывается при вводе документа исправительных оборотов
     возвращаемое значение
     0 - документ подходит под условия допустимости выполнения исправительных оборотов
     1 - документ не подходит под условия допустимости выполнения исправительных оборотов
*/
macro ПроверитьДопустимостьПроводки(AccTrnBuff)
  
  var stat = 0;

  SetBuff(acctrn, AccTrnBuff);
  
  if( stat != 0 )
    msgbox( "Для выбранной проводки операция \"Исправительные обороты\" не разрешена!" );
  end;

  return stat;

end;

macro УстановитьОснование(DocKind, AccTrnBuff, NumbDoc, DateCarry, CorrTurnType)
  var stat = 0,
      cur,
      str_rub,str_kop,
      pos_begin,pos_end,
      FI_Name,
      INT_FI_code:integer,
      Ground;
  var InitNumb, InitDate, Sum, FI_Code;

  SetBuff(acctrn, AccTrnBuff);
  InitNumb = acctrn.Numb_Document;
  InitDate = acctrn.Date_Carry;
  if(acctrn.FIID_Receiver == 0)
    Sum      = acctrn.Sum_Payer;
    FI_Code  = acctrn.FIID_Payer;
  else
    Sum      = acctrn.Sum_Receiver;
    FI_Code  = acctrn.FIID_Receiver;
  end;

  /* Получим наименование авлюты */
  INT_FI_code = GetFICode(FI_Code, 0, FICK_ISONUMBER);
  if( INT_FI_code == {ISONatCur} )
    cur = RubToStrAlt( Sum, str_rub, str_kop );
  else
    cur = CurToStrAlt( Sum, str_rub, str_kop, INT_FI_code );
  end;

  pos_begin = strlen( str_rub );
  pos_end   = Index ( cur, str_kop ); 
  FI_Name   = SubStr( cur, pos_begin + 1, pos_end - pos_begin - 2 );

  if( CorrTurnType == 1 )
    Ground = "Все провода "; 
    elif( CorrTurnType == 2 )
      Ground = "Сторно провода "; 
      elif( CorrTurnType == 3 )
    Ground = "Исправление провода "; 
  elif( CorrTurnType == 4 )
        Ground = "Корректировка провода "; 
  end;

  if(( CorrTurnType == 1 ) or ( CorrTurnType == 2 ) or ( CorrTurnType == 3 ) or ( CorrTurnType == 4 ))
    /* EVG Номер и дату распоряжения решено из основания убрать.
    Ground = Ground + " №" + InitNumb + " от " + InitDate + " на сумму " + Sum + FI_Name + ".\nРаспоряжение №" + NumbDoc + " от " + DateCarry;*/
    Ground = Ground + " №" + InitNumb + " от " + InitDate + " на сумму " + Sum + FI_Name + ".";
  else
    Ground = "";
  end;

  /* EVG В назначении платежа ИО должно входить также основание исправляемого документа */
  /*SDA 05.04.2012 - если удвоенная длина основания проводки превышает 210 знаков знак переноса ставить нельзя - "хвост"
                     переносится в тип документа вместо "И" - особенность передачи данных в буфер :( */
  if ((trim (Ground) > "") and ((Strlen(acctrn.Ground)*2) < 210 )) 
     Ground = Ground + "\n";
  end;
  Ground = substr((Ground+" "+trim(acctrn.Ground)),1,210);

  return Ground;

end;
