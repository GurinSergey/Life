//-----------------------------------------------------------------------------
// Блок     : 29022 - "Акцепт в кассе"
// Шаг      : 20    - "Акцепт в кассе"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, cbsttls, pm_common;
import OprInter, oralib; //Jushmanov 2014-02-24 C-19151

var PaymentObj:RsbPayment;

MACRO ExecuteStep( doc, paymDoc )

    var note_text:string = "";

    if (not ((PaymentObj.DocKind == DLDOC_INOUTORDER) and (Opr_IsStepExecuteSymb(PaymentObj.DocumentID, PaymentObj.DocKind, "А", "X", 29022))))  
        if( УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_CONTROL, OPR_PAYM_DO, OPR_PM_ST_ENTER, OPR_PAYM_CABS, OPR_PM_ST_MFR_YES ) )
            msgbox("Ошибка при установке сегментов статуса экземпляра операции");
            return 1;
        end;

        if( PaymentObj.Notes.AddNote( PM_NOTEKIND_DENIALGROUND, note_text ) != 0 )
            msgbox( "Ошибка при вставке примечания платежа" );
            return 1;
        end;
    end;

    if (Opr_IsStepExecuteSymb( PaymentObj.DocumentID, PaymentObj.DocKind, "А", "X", 29022))           
        if( УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_CONTROL, OPR_PAYM_STATE, OPR_PM_ST_CLOSE ) )
            msgbox("Ошибка при установке сегментов статуса экземпляра операции");
            return 1;
        end;
    end;

    return 0;

END;


//Jushmanov 2014-02-24 C-19151
macro PostStepAction( message,      /* 1 - выполнение шага; 2 - откат шага;   */
                      errTrn,       /* статус выполнения шага. 0 - ошибки нет */
                      FirstDoc,     /* указатель на первичный документ        */
                      ID_Oper,      /* внутренний идентификатор операции      */
                      Number_Step,  /* Номер шага операции (из настроек)      */
                      KindOper,     /* номер вида операции                    */
                      KindDoc,      /* номер вида первичного документа        */
                      KindStep,     /* вид шага операции                      */
                      ID_Step )     /* внутренний идентификатор шага операции */
    private var logquery, idStep = ID_Step, idOper = ID_Oper;

    if(( message == OP_EXECUTE_STEP ) and (errTrn == 0) and (IsOprMultiExec))
        if ((valtype(idOper) != V_INTEGER) and (valtype(idOper) != V_STRING)) idOper = 0; end;
        if ((valtype(idStep) != V_INTEGER) and (valtype(idStep) != V_STRING)) idStep = 0; end;

        logquery = "UPDATE usr_doprstep_robot_dbt SET t_is_robot_step = chr(88)" +
                   " WHERE t_id_operation = " + idOper + " AND t_id_step = " + idStep;
        ExecSQL(logquery, null, false);
    end;

    return 0;
end;