/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    ███████       █████      █████     ███
    █████████   ████████   ████████    ███
    ███   ███   ███        ███         ███
    ████████     ███████    ███████    ███
    ██████            ███        ███   ███
    ███ ████    █████████  █████████   ████████
    ███   ████    █████      █████     ████████

   R-Style Softlab

   Имя файла: svacrpay.mac

   Описание:  Макрос начисления и оплаты комиссий
              
   ChangeLog:
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 11.12.2013 После перехода на 2031 skipSfDefCom() снова актуальна, убрал ее из коммента Гуцу Е.
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 18.03.2014 Сделал удаление УПК по недействующим ТП клиента
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 17.03.2014 Добавил в skipSfDefCom() удаление "кривых" УПК у которых дата начала больше даты окончания периода
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 18.03.2014 Изменил параметризацию запроса skipSfDefCom()
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 11.02.2015 В рамках установки 130-ХФ убираются пользовательские доработки
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

import "sfcommon.mac", PSINTER, PTINTER, OprInter, oralib, sfcomcat, "sf_lib.mac", "cb_sql.mac", "sfground.mac";

/*FIV Проверка, что месяца дат совпадают */
 private macro MergeMounth(d1, d2)
 var m1,m2;
    DateSplit(d1, null, m1, null);
    DateSplit(d2, null, m2, null);
    return (m1 == m2);
 end;

/*FIV Возвращает первый день месяца*/
 private macro GetFirstDayForCurMonth(lastdate)
 var mm, yy;
    DateSplit(lastdate, null, mm, yy);
    return Date(1,mm,yy);
 end;

/* EVG */
 macro GetSfContrStruc( ContrID, sfcStruc )
   var query, rs, cmd;
   query = " Select * From DSFCONTR_DBT " +
           "  Where T_ID = ? " ;
   cmd = rsdcommand(query);
   cmd.AddParam("", RSDBP_IN,ContrID);
   rs = rsdRecordSet( cmd );

   if (rs and rs.MoveNext())
      CopyRSetToFBuff ( sfcStruc, rs );
   end;

 end;


/* EVG */
/* EVG 9/02/2012 Доработка для 2030 - передача ID ДО для добавления 
   в условие запроса. */
 macro GetMacroName( Type, Number, sfcId )
   var SQL, rs, cmd, i = 0;
   var MacroNames = TArray(0); 
   /* Получаем имя макроса выполнения из польз. алгоритма расчёта (Alt-P) */
   SQL = " SELECT   UTL_RAW.cast_to_varchar2 (DBMS_LOB.SUBSTR (cal.t_fmtblobdata_xxxx, 81, 82))" +
         "   FROM   dsfcalcal_dbt cal" +
         "  WHERE       cal.t_kind = 8" +
         "    AND CAL.T_FEETYPE = ? " +
         "    AND CAL.T_COMMNUMBER = ? " +
         "    AND CAL.T_CONCOMID = 0 ";
   cmd = rsdcommand(sql);
   cmd.AddParam("", RSDBP_IN,Type);
   cmd.AddParam("", RSDBP_IN,Number);
   rs = rsdRecordSet( cmd );

   /* EVG 19.01.2011 Алгоритмов может быть несколько и у каждого свой макрос,
      поэтому нужно собрать их все. */
   while (rs and rs.moveNext())
      MacroNames(i) = trim( rs.value(0, null, V_STRING) );
      i = i + 1;
   end;
   
   return MacroNames;
 end;

 macro skipSfDefCom()
 end;

//В макрос передаем значения всех параметров командной строки:
 macro SfCorrectShedParms( dep:@string, fi:@string, account:@string, oper:@string, 
                          group:@string, comnum:@integer, curonly:@string, 
                          pdate:@integer, cdate:@integer, 
                          charge:@string, paym:@string )
 end;