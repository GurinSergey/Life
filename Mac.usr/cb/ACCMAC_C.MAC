/*---------------- Макро-файл, вызываемого из счета --------------*/
/*                                                                */
/*  - расчет % для Пойдём!                                        */
/*                                                                */
/*----------------------------------------------------------------*/

record a( "account$.dbt" );

private macro percent( acc )

 var DateB, DateE, percnote, Year, Month, nmob, nmtlg, obbook, obsheet, i=3, RestAcc, procent, normalize=0;

   percnote = ReadNoteForObject(4,UniID(acc, OBJTYPE_ACCOUNT),19);

   if (not percnote)
     percnote = 0;
     if (not getInt(percnote,"% ставка в примечании 19 не задана| задайте значение",2))
        return 0;
     end;
     if (not percnote)
        return 0;
     end;
   end;

   println ("Дата":10, "Сумма остатка по выписке":30, "% ставка":10, "Сумма начисленных %%":20);
   nmob = CreateObject ("rsax","TRsAxServer",string("RsAxServer", UserNumber()),IsStandAlone());
   nmtlg = nmob.CreateComObject ("Excel.Application");
   obBook = nmtlg.Workbooks.add;
   obSheet = obBook.ActiveSheet(); 
   obSheet.Range("A"+2).Value="Дата";
   obSheet.Range("B"+2).Value="Сумма остатка по выписке";
   obSheet.Range("C"+2).Value="% ставка";
   obSheet.Range("D"+2).Value="Сумма начисленных %%";
   obSheet.Columns("A:A").ColumnWidth = 20;
   obSheet.Columns("B:B").ColumnWidth = 30;
   obSheet.Columns("C:C").ColumnWidth = 10;
   obSheet.Columns("D:D").ColumnWidth = 30;
   obsheet.pagesetup.zoom=90;

  datesplit({curdate}, null, Month, Year);
  DateB = date(1, Month, Year);
  DateE = {curdate};

  if (getdate(DateB, "Выберите дату начала расчета"))
      if (getdate(DateE, "Выберите дату окончания расчета"))

         if (DateE < DateB)
           msgbox("Дата начала отчета больше даты окончания");
           return 0;
         end;

         datesplit(DateB, null, Month, Year);

         while (DateE >= dateB)

            RestAcc = restaC(acc.account, acc.code_currency, (dateB-1), (dateB-1), acc.chapter);
            procent = ((percnote*RestAcc)/(100*(date(1,1,(Year+1))-date(1,1,Year))) + Normalize);
            Normalize =  procent - round(procent,2);
            procent = round(procent,2);
            println (DateB:10, RestAcc:30, Double(percnote):10, procent:20);
            obSheet.Range("A"+i).Value=DateB;
            obSheet.Range("B"+i).Value=RestAcc;
            obSheet.Range("C"+i).Value=Double(percnote);
            obSheet.Range("D"+i).Value=procent;
            dateB = dateB + 1;
            i = i + 1;

         end;

       else
        return 0;
      end;
  else
    return 0;
  end;

   nmtlg.visible = true;

 return 0;

end;


/*Тихомиров - Реализация расчета процентов для пойдем!*/
private macro account( aa )
 setbuff( a, aa );

array main;
var m;

 main(asize(main)) = "Расчет процентов";

 m = menu(main);

  If (main(m) == "Расчет процентов")
      Percent(a);
  end;

end;

