/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : ostscan.mac
  Created     : 14.09.99
  Programmer  : Сулимов Д.В.
  Description : Печать отчета сканирования шагов операций

└───────────────────────────────────────────────────────────────────────────*/
import rsd;
RECORD oprstep_rec (oprstep);

const   Ошибка   = 0,
        Первый   = 1,
        Последний= 2;
var     Count1 = 0;

MACRO Печать_ОтчетСканирования (Вызов,rec_step,Статус,Сообщение)

   var cmd, rs;

   setbuff (oprstep_rec,rec_step);

   var stat;

   cmd = RSDCommand("select   pm.t_payeraccount, pm.t_receiveraccount, pm.t_amount, rm.t_number " +
                    "  from   doproper_dbt op, dpmpaym_dbt pm, dpmrmprop_dbt rm " +
                    " where   op.t_id_operation = ? and pm.t_paymentid = to_number (op.t_documentid) and rm.t_paymentid = pm.t_paymentid "
                   );
   cmd.addparam("opid", RSDBP_IN, oprstep_rec.ID_Operation);
   rs = RSDRecordset(cmd);
   rs.movenext;

   if (Вызов==Первый)
      [                     Отчет о групповом выполнении шагов операций.    ];
      [┌────────┬───────┬──────┬──────┬────────────────────┬────────────────────┬────────────────────┬──────────────────────────────────────────────────────────────────────┐];
      [│ Номер  │ Номер │Номер │Номер │        Сумма       │        Счет        │       Счет         │                             Сообщение                                │];
      [│операции│ шага  │ошибки│док.  │      документа     │    плательщика     │    получателя      │                                                                      │];
      [├────────┼───────┼──────┼──────┼────────────────────┼────────────────────┼────────────────────┼──────────────────────────────────────────────────────────────────────┤];
   elif (Вызов==Ошибка)

      Count1 = Count1+1;

      if (Статус == 0)
         Сообщение = "Шаг выполнен успешно";
      end;
                   
      [│########│#######│######│######│####################│####################│####################│######################################################################│]
      (oprstep_rec.ID_Operation,oprstep_rec.ID_Step,Статус,rs.value(3),money(rs.value(2)),rs.value(0), rs.value(1), Сообщение:w);

   elif (Вызов==Последний)
      [└────────┴───────┴──────┴──────┴────────────────────┴────────────────────┴────────────────────┴──────────────────────────────────────────────────────────────────────┘
                                                                          ###############](int(Count1));
   end;
END;
