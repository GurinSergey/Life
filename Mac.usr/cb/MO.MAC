/**************************************************************************/
/*         Автоматизированная банковская система RS-Bank                  */
/*               Copyright (c) R-Style Software Lab                       */
/*                                                                        */
/*  Имя файла      : mo.mac                                               */
/*                                                                        */
/*  Описание       : Печать мемориального ордера                          */
/*                   по рублевой проводке по главе А плана счетов ЦБ РФ   */
/*                                                                        */
/*  Изменения      : 13.01.2014 Chesnokov D.S. Исправил печать для валюте */
/*                   по заявке R-525753                                   */
/**************************************************************************/

import globals, "mocommon.mac", "prnlib.mac", likepy, FIInter;

/*---------------------------------------------------------*/
/* Печать рублевой проводки по главе А плана счетов ЦБ РФ  */
/* d       - буфер проводки                                */
/* doc_inf - не используется (оставлено для совместимости) */
/* ncopy   - число копий                                   */
/*---------------------------------------------------------*/ 
record fi( "fininstr.dbt", "bank.def" );

MACRO PutPlatI( d, doc_inf, ncopy:integer ):bool
  debugbreak;
  /* Подготовка строк к печати */
  ARRAY SS, SG, SBP, SBR, SP, SR;
  /*13.01.2015 Chesnokov D.S. Передаем валюту явно, а не рубли как раньше*/
  var Payer   :string = MO_GetClientString( d.Account_Payer,    d.Chapter, d.fiid_payer );
  var Receiver:string = MO_GetClientString( d.Account_Receiver, d.Chapter, d.fiid_receiver );
  var dateDoc :date   = {curdate};
  var NameDocument    = "";
  var SPOD_str:string = IfThenElse( Index( d.TypeDocument, "З" ), "СПОД", "    " );

  var err,pagebreak,terminator=""; // KS 16.11.2011 Разделитель
  GetRegistryValue("PRBB\\REPORT\\ПЕЧАТЬ\\MEMORDER\\PAGE BREAK",V_BOOL,pagebreak,err);
  if (( err == 0 ) and (pagebreak))
    terminator = "";
  end;

  StrSplit( GetOurBankName(),    SBP,    43, 43, 2 );
  StrSplit( GetOurBankName(),    SBR,    43, 43, 2 );  
  //VDN 08.07.2015 I-00575400-2
  if (d.fiid_receiver != 0)   
    ПолучитьФинИн( d.fiid_receiver, fi ); 
    StrSplit( CurToStrAlt( d.Sum_Receiver, NULL, NULL, int(fi.ISO_Number) ), SS, 76, 76, 2 );
  else
    //Gurin S. 19.03.2014 R-348306-2
    //StrSplit( RubToStrAlt( d.Sum ), SS,    76, 76, 2 );
    StrSplit( RubToStrAlt( d.Sum_Receiver ), SS,    76, 76, 2 );
  end;
  StrSplit( d.Ground,             SG,    87, 67, 3 );
  StrSplit( Payer,                SP,    43, 43, 3 );
  StrSplit( Receiver,             SR,    43, 43, 4 );

  NameDocument    = "МЕМОРИАЛЬНЫЙ";
  if( IsCORRECTING( d.TypeDocument ) )
    NameDocument = "ИСПРАВИТЕЛЬНЫЙ";
  end;

  if( d.Date_Carry != date(0, 0, 0) )
    dateDoc = d.Date_Carry;
  end;

  while( ncopy > 0 )
    [┌──────────────────────────┬─────────────────┬────────────────────────────────────────────┐
     │  ############## ОРДЕР N  │ ############### │ #######################         ####       │
     │                          └─────────────────┘ ───────────────────────                    │
     │                                                     /Дата/                              │
     ├──────────┬──────────────────────────────────────────────────────────────────────────────┤
     │ Сумма    │ ############################################################################ │
     │ прописью │ ############################################################################ │
     ├──────────┴──────────────────────────────────┬──────────┬────────────────────────────────┤
     │ ########################################### │  Сумма   │ ############################   │
     │ ########################################### ├──────────┼────────────────────────────────┤
     │ Плательщик ################################ │  Сч.N    │ #########################      │
     ├─────────────────────────────────────────────┼──────────┤                                │
     │ ########################################### │  БИК     │ #################              │
     │ ########################################### ├──────────┤                                │
     │ Банк плательщика                            │  Сч.N    │ #########################      │
     ├─────────────────────────────────────────────┼──────────┼────────────────────────────────┤
     │ ########################################### │  БИК     │ #################              │
     │ ########################################### ├──────────┤                                │
     │ Банк получателя                             │  Сч.N    │ #########################      │
     ├─────────────────────────────────────────────┼──────────┤                                │
     │ ########################################### │  Сч.N    │ #########################      │
     │ ########################################### ├──────────┼────────┬──────────┬────────────┤
     │ ########################################### │ Шифр.док.│ ###### │Срок плат.│            │
     │ ########################################### ├──────────┤        ├──────────┤            │
     │                                             │Назн.плат.│        │Очер.плат.│            │
     │ Получатель                                  │   Код    │        │Рез.поле  │            │
     ├─────────────────────────────────────────────┴──────────┴────────┴──────────┴────────────┤
     │ Назначение платежа  ################################################################### │
     │ ####################################################################################### │
     │ ####################################################################################### │
     │                                                                                         │
     │                              Подписи                                                    │
     └─────────────────────────────────────────────────────────────────────────────────────────┘
     #](NameDocument:r,
        d.Numb_Document:c,
        dateDoc:m:c:f,
        SPOD_str,
        SS(0), SS(1),
        //Gurin S. 19.03.2014 R-348306-2
        //SP(0), d.Sum:l:f,
        SP(0), d.Sum_Receiver:l:f,
        SP(1),
        SP(2), d.Account_Payer,
        SBP(0), {MFO_Bank},
        SBP(1), {CORAC_Bank},
        SBR(0), {MFO_Bank},
        SBR(1), {CORAC_Bank},
        SR(0),  d.Account_Receiver,
        SR(1), SR(2), d.Shifr_oper,/* d.Kind_oper,*/
        SR(3),
        SG(0), SG(1), SG(2),
        terminator // KS 16.11.2011 Разделитель
        );

    ncopy = ncopy - 1;
  end;

  return TRUE;

END;

MACRO PutPlat( a, ncopy)
  RECORD d( "arhdoc.dbt", "bank.def" );
  SetBuff( d, a);
  PutPlatI( d, NULL, ncopy);
END;

MACRO PutPlatInf( a, d_inf)
  RECORD d( "arhdoc.dbt", "bank.def" );
  SetBuff( d, a );
  PutPlatI( d, NULL, 1 );
END;
