/*---------------------------------------------------------------------------\
|                       Файл    arhdocс.mac                                   |
|                     Для архивных документов                                |
\---------------------------------------------------------------------------*/

//Seleznev
/*13.12.2012 Lao добавил вывод счета*/
import rsd, makeMT103, BankInter, "payments.mac", globals;
import "diver.mac";
import "arh_oper.mac";

record          Документ( "arhdoc$.dbt" );
record          СтарыйДокумент( "arhdoc$.dbt" );


macro    Новый_документ( тип_документа )
        msgbox("Запрещен ввод проводок вручную!|операции должны оформляться первичными документами");
        return 1;
end;

macro    Проверить_документ( Режим, Тип_документа )
        return 0;
end;

macro    ФункцияПользователя( тип_документа )
   array mn;
   mn(0)="1. Кредитовое авизо";
   if (({oper} == 10000) or ({oper} == 433) or ({oper} == 10199) or ({oper} == 10191))
      mn(1)="2. Простановка типа СПОД";
   end;
   if (ВходитВГруппу ({oper}, 188))
    mn(2)="2. Замена операциониста на проводке/документе";
   end;
   var  m=menu(mn,null,"Выберите действие над платежом");
   if (m == 0)
      var cmd = RSDCommand("select t_paymentid from dpmdocs_dbt where t_applicationkey = ?");
      cmd.addparam("appkey",RSDBP_IN,Документ.applicationkey);
      var rs=RSDRecordset(cmd);

      if (rs.movenext)
         makeMT103(int(rs.value(0)));
      else
         msgbox("Отсутствует связь проводки с платежом");
      end;
   elif (m == 1)
      cmd = RSDCommand("update darhdoc$_dbt set t_typedocument = 'З' where t_autokey = "+Документ.autokey);
      cmd.Execute;
      cmd = RSDCommand(" UPDATE   darhdoc_dbt "
      + "\n" + "   SET   t_typedocument   = CASE WHEN (t_typedocument = CHR (1)) THEN 'З' ELSE TRIM (t_typedocument || 'З') END " //vihrov 01.02.2011 чтоб не затирались другие типы, но не приписывались к квадратику
      + "\n" + " WHERE   t_autokey = "
      + "\n" + "            (SELECT   t_autokey "
      + "\n" + "               FROM   darhdoc_dbt arhdoc "
      + "\n" + "              WHERE   t_connappkey = (SELECT   t_applicationkey "
      + "\n" + "                                        FROM   darhdoc$_dbt "
      + "\n" + "                                       WHERE   t_autokey = " + Документ.autokey + ") "
      + "\n" + "                      AND t_connappkind = (SELECT   t_iapplicationkind "
      + "\n" + "                                             FROM   darhdoc$_dbt "
      + "\n" + "                                            WHERE   t_autokey = " + Документ.autokey + "))");
      cmd.Execute;
   
   elif (m == 2)
     debugbreak;      
     strartoperchange(Документ.autokey,Документ.date_carry,Документ.oper,Документ.numb_document,(Документ.Code_Currency > 0),"40702");
   end;
   return 0;
end;

macro    Проверить_Счет_В_Мемордере( поле ) /*0-счет плательщика, 1-счет получателя*/
        var новое_значение_счета;

        if(поле) новое_значение_счета = Документ.Account_Receiver;
        else новое_значение_счета = Документ.Account_Payer;
        end;
        return новое_значение_счета;
end;
/*
 *      Функция установки подсказки для списка проводок
 *              
 *         параметр ScrollKind принимает значения:
 *         - CARRY_SCROLL          - список проводок
 *         - CARRY_SCROLL_PAYER    - список дебитовых проводок по счету
 *         - CARRY_SCROLL_RECEIVER - список кредитовых проводок по счету
 *
 *      Если функция возвращает пустую строку, то используется хинт по умолчанию
 */
private macro УстановитьПодсказку( ScrollKind )
  /* EVG Хинт для оптимизации времени вывода списка проводок по счёту */
  return "/*+FIRST_ROWS INDEX(t DARHDOC$_DBT_IDX2) INDEX(t DARHDOC$_DBT_IDX3)*/";
end;