/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : mo2161u.mac.mac
  Created     : 25.08.2009
  Programmer  : Попова О.
  Description : Печатная форма МО по ф.2161-У
                для одновалютного мемордера
/*SDA - эй, помошнички, прежде чем править макросы - почитайте их хотя бы! 
       А если кто то уж лезет - оставляйте комменты - кто, когда и нахера это наворотил */
// KS 31.12.2013 Адаптация под 31ю сборку
└───────────────────────────────────────────────────────────────────────────*/

import "pr2161.mac", "pr2161lib.mac";

Import "fg_Life_parm.mac"; //ASV
private var fgBank = fg_life_subject({OurBank}); //ASV

private VAR CopyCont = 1;          /* Кол-во копий                         */

var pr_cb_doc:TRecHandler = TRecHandler("cb_doc.dbt", "bank.def");

private macro typeacc(account, chapter)
var cmd = rsdcommand ("select 1 from daccount_dbt where t_account = ? and t_usertypeaccount like '%А%' and t_chapter = ?");
cmd.addparam("acc",RSDBP_IN, account);
cmd.addparam("chapter",RSDBP_IN, chapter);
var rsd = rsdrecordset(cmd);
if (rsd.movenext())
return true;
else
return false;
end;
end;

// KS 31.12.2013 Адаптация под 31ю сборку. Теперь typeaccval можно не использовать
/* Коркин И. Н. по заявке I-094873 */
/*
private macro typeaccval(account, chapter)
var cmd = rsdcommand ("select 1 from daccount$_dbt where t_account = ? and t_usertypeaccount like '%А%' and t_chapter = ?");
cmd.addparam("acc",RSDBP_IN, account);
cmd.addparam("chapter",RSDBP_IN, chapter);
var rsd = rsdrecordset(cmd);
if (rsd.movenext())
return true;
else
return false;
end;
end;
*/


MACRO PrintDocument(ncopy: integer):bool
debugbreak;

ground = pr_pmrmprop.rec.ground;
var oper_name = "";
var Document_name = "";
var Passport = "";
var cmd, rsd;
var flag = 0;
array pass, docum, DN;

//Kozina доработка по заполнению дополнительных полей по приему и выдаче ценностей из примечания
  cmd  =  "select NK.T_NOTEKIND, USR_NOTETEXT.ConvertRAWtoSTRING(NT.T_TEXT, NK.T_NOTETYPE) T_TEXT "+
          "from dnotekind_dbt nk, dnotetext_dbt nt " +
          "WHERE NK.T_NOTEKIND = NT.T_NOTEKIND " +
          "and nk.T_OBJECTTYPE = 70 and NT.T_DOCUMENTID (+) = lpad('" + pr_pmpaym.rec.PaymentId + "',34,'0')";
  rsd = RSDRecordset(cmd);

  DN(0) = "";
  DN(1) = "";
  pass(0) = "";
  pass(1) = "";

  while(rsd.MoveNext())
   if (rsd.value(0) == 101)
     DN(0) = rsd.value(1);
   elif (rsd.value(0) == 102)
     DN(1) = rsd.value(1);
   elif (rsd.value(0) == 103)
     Document_name = rsd.value(1);
   elif (rsd.value(0) == 104)
     pass(0) = rsd.value(1);
     flag = 1;
   elif (rsd.value(0) == 105)
     Pass(1) = rsd.value(1);
     flag = 1;
   elif (rsd.value(0) == 106)
     oper_name = rsd.value(1);
   end;
  end;

 
 while (index(ground,"+")>0)
 if (strlen(oper_name) == 0)
        oper_name = substr(ground,1,(index(ground,"+")-1));
        ground = substr(ground,(index(ground,"+")+1));
 elif (strlen(document_name) == 0)
        document_name = substr(ground,1,(index(ground,"+")-1));
        ground = substr(ground,(index(ground,"+")+1));
 else   passport = substr(ground,1,(index(ground,"+")-1));
        ground = substr(ground,(index(ground,"+")+1));
 end;
 end;

 strsplit(document_name,docum,100,60,2);
 if(passport != "")
    strsplit(passport,pass,100,60,2);
 end; 
  

/*SDA   
if ((pr_pmpaym.rec.chapter == 3) and ((typeaccval(pr_pmpaym.rec.receiveraccount, pr_pmpaym.rec.chapter)) or (typeacc(pr_pmpaym.rec.receiveraccount, pr_pmpaym.rec.chapter))) )*/
if (((pr_pmpaym.rec.chapter == 3) and (index(pr_cb_doc.rec.USERTYPEDOCUMENT,"П")>0)) or
                                     ((index(pr_cb_doc.rec.USERTYPEDOCUMENT,"В")==0) and
   (/*(typeaccval(pr_pmpaym.rec.receiveraccount, pr_pmpaym.rec.chapter)) or */
   (typeacc(pr_pmpaym.rec.receiveraccount, pr_pmpaym.rec.chapter)))))
/*SDA - эй, помошнички, прежде чем править макросы - почитайте их хотя бы! 
       А если кто то уж лезет - оставляйте комменты - кто, когда и нахера это наворотил */
    name = "МЕМОРИАЛЬНЫЙ ОРДЕР ПО ПРИЕМУ ЦЕННОСТЕЙ"; // KS 11.03.2012 Ещё раз поменяешь ВЫДАЧУ с ПРИЁМОМ - убью                           
	if (fgBank.is_PRBB)
		pre_post =
			 "                 Подписи  \n"+
			 "                            \n"+
			 "                 Контролер ___________________   Кассир ___________________\n"+
			 " \n"+
			 "                 Исполнитель _________________   Вноситель ________________\n"+
			 " \n"+
			 " \n"+
			 "  Приложение: __________________________________  документов  на __________листах \n\n"+
			 " \n"+
			 "                 Принять от: "+oper_name+"\n"+
			 " \n"+
			 "                 Наименование ценностей и документов: "+document_name+"\n";

		post = "";
	else
		pre_post =
			 "                 Подписи  \n"+
			 "                            \n"+
			 "                 Вноситель ____________/________________________ \n"+
			 "                                                 Ф И О \n"+
			 "                 Исполнитель____________  Контролер______________ \n"+
			 " \n"+
			 "                 Кассир_________________  \n"+
			 " \n"+
			 " \n"+
			 "  Приложение: __________________________________  документов  на __________листах \n\n";

		post = "";
	end;

/* SDA
elif ((pr_pmpaym.rec.chapter == 3) and ((typeaccval(pr_pmpaym.rec.payeraccount, pr_pmpaym.rec.chapter)) or (typeacc(pr_pmpaym.rec.payeraccount, pr_pmpaym.rec.chapter))))*/
elif (((pr_pmpaym.rec.chapter == 3) and (index(pr_cb_doc.rec.USERTYPEDOCUMENT,"В")>0)) or
                                       ((index(pr_cb_doc.rec.USERTYPEDOCUMENT,"П")==0) and
      (/*(typeaccval(pr_pmpaym.rec.payeraccount, pr_pmpaym.rec.chapter)) or */
       (typeacc(pr_pmpaym.rec.payeraccount, pr_pmpaym.rec.chapter)))))

// KS 25.10.2011
    if(flag)    
      post =
        "                 Паспорт РФ:"+pass(0)+"\n"+// KS 25.10.2011
        "                 Выдан "+pass(1)+
        "\n"+
        "\n";
    else
      post =
        "                 Паспорт РФ:"+pass(0)+"\n"+  //vihrov 17.05.2011 по заявке I-00029512-3
        "                 "+pass(1)+                 //vihrov 17.05.2011 по заявке I-00029512-3
        "\n"+
        "\n";// KS 25.10.2011
    end;

    name = "МЕМОРИАЛЬНЫЙ ОРДЕР ПО ВЫДАЧЕ ЦЕННОСТЕЙ"; // KS 11.03.2012 Ещё раз поменяешь ВЫДАЧУ с ПРИЁМОМ - убью
	if (fgBank.is_PRBB)
		pre_post = 
			 "  ──────────────────────────────────────────────────────────────────────────────────────────────────────────── \n"+
			 "                            \n"+
			 "                 Подписи  \n"+
			 "                            \n"+
			 "                 Контролер______________  Кассир_________________   \n"+
			 " \n"+
			 "                 Исполнитель____________  Получатель_____________   \n"+
			 " \n"+
			 " \n"+
			 "  Приложение: __________________________________  документов  на __________листах \n\n"+
			 " \n"+
			 "                 Получатель: "+oper_name+"\n"+
			 post+
			 " \n"+
			 "                 Наименование ценностей и документов: "+document_name+"\n";

		post = "";
	else
		pre_post = post +
			 "  ──────────────────────────────────────────────────────────────────────────────────────────────────────────── \n"+
			 "                            \n"+
			 "                 Подписи  \n"+
			 "                            \n"+
			 "                 Получатель ____________/________________________ \n"+
			 "                                                 Ф И О \n"+
			 "                 Исполнитель____________  Контролер______________ \n"+
			 " \n"+
			 "                 Кассир_________________  \n"+
			 " \n"+
			 " \n"+
			 "  Приложение: __________________________________  документов  на __________листах \n\n";

		post = "";
	end;
  else
    post = "";
    name = "";
    pre_post = "";
  end;

  var ReportData = СформироватьОтчетДляОдновалютногоМО( pr_cb_doc );
  CopyCont = ncopy;
  
  while(CopyCont)
    ReportData.PrintReport();
    CopyCont = CopyCont - 1;
  end;
  return true;

END;