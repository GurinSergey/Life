/* Макрос отправки подтверждений в Клиент Банка */
/*zmp 01.11.2012 I-00278580 добавил ф-ю экранирования кавычек*/
// KS 12.05.2014 Обработка платежей ИК для Солидарности

import iborwp,rsd, lib_compare;

/****Отправка в IB6*****************/
import clbrcpIB;
/***********************************/
// KS 12.05.2014 Обработка платежей ИК в Солидарности
import clbrcpIK;
import "fg_Life_parm.mac";
import globals;

/* Признак отправлять подтверждения сразу, минуя помещене в список подготовки */
private const  sendImmediately = true;
private record oprrcpst(oprrcpst);

/* Макропроцедура отправки подтверждения в Клиент Банка по идентификатору в АБС */
MACRO clbMakeReceipt(cID:string, oprrcpst_buff) : bool
  debugbreak;
  setbuff(oprrcpst, oprrcpst_buff);
  var sqlString, rst, ReceiptIniIsNULL, ReceiptIni; 
  private var fgBank;                                                  // KS 12.05.2014 Для определения банка

  /* cID - строковый идентификатор документа в АБС, для которого необходимо отправить подтверждение с параметрами oprrcpst */

  sqlString = " SELECT T_RECEIPTINI " +
              " FROM DDP_DEP_DBT "+
              " WHERE T_CODE = " + oprrcpst.Department;


  rst = RsdRecordset( sqlString );
  rst.moveNext();
  rst.value("T_RECEIPTINI" , ReceiptIniIsNULL);

  if( ReceiptIniIsNULL != true )
    ReceiptIni = rst.value("T_RECEIPTINI" );
  else
    ReceiptIni = NULL;
  end;

  var result;

/****Отправка в IB6*****************/
/*zmp 01.11.2012 I-00278580 добавил ф-ю экранирования кавычек*/
  if (checkInterBankVersion(cID,6))
    return clbMakeReceiptIB6(cID,oprrcpst.ReceiptType, oprrcpst.ShortDesc, PutDoubleQoute(oprrcpst.Desc));

  elif (checkInterBankVersion(cID,5))
/***********************************/
//SDA 21/06/2012 - временно отключено по просьбе Д.Гаревского всвязи с тем, что "сервер сдох"
//UDA 17.08.2012 по запросу I-00237493-2 включил обратно
/*zmp 01.11.2012 I-00278580 добавил ф-ю экранирования кавычек*/
    result = clbMakeReceiptByABSId(cID, sendImmediately, oprrcpst.ReceiptType, oprrcpst.ShortDesc, PutDoubleQoute(oprrcpst.Desc), ReceiptIni);
    /* Если вернулось false, то значит в БОУРМ нет документа с таким идентификатором, поэтому за ошибку не считаем */
/****Отправка в IB6*****************/
  else
    // KS 12.05.2014 Обработка платежей ИК в Солидарности
    fgBank = fg_life_subject({OurBank});
    if (fgBank.is_SLD)
//      sqlString = " SELECT 1 " +
//                  "   FROM dpmpaym_dbt " +
//                  "  WHERE t_origin = 2 " + // Считаем, что это уже не может быть Интербанк, так как не сработала checkInterBankVersion
//                  "    AND t_paymentid = " + substr(cID,6,10);
// KS 17.06.2014 С происхождением не так всё просто!!!
      sqlString = " select 1 " +
                  "   from dpmpaym_dbt p, dpspayord_dbt ps, dpscpord_dbt pc " +
                  "  where p.t_paymentid = ps.t_orderid(+) " +
                  "    and p.t_paymentid = pc.t_orderid(+) " +
                  "    and nvl(decode(p.t_dockind,201,ps.t_origin,202,pc.t_origin,p.t_origin),p.t_origin) = 2 " + // Считаем, что это уже не может быть Интербанк, так как не сработала checkInterBankVersion
                  "    and p.t_paymentid =  " + substr(cID,6,10);

      rst = RsdRecordset( sqlString );
      if (rst.moveNext())
        return clbMakeReceiptIK(cID,oprrcpst.ReceiptType, oprrcpst.ShortDesc, PutDoubleQoute(oprrcpst.Desc));
      end;
    end;
  end;
/***********************************/
  
  return true;
END;