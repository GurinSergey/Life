/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    ███████       █████      █████     ███
    █████████   ████████   ████████    ███
    ███   ███   ███        ███         ███
    ████████     ███████    ███████    ███
    ██████            ███        ███   ███
    ███ ████    █████████  █████████   ████████
    ███   ████    █████      █████     ████████

   R-Style Softlab
   
   Имя файла sfpaycor.mac

   Описание: ПЗО
             Оплата комиссий на шаге операции
             Формирование документов шага
             Корректировка параметров оплаты в зависимости от бэкофиса

   ChangeLog:
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 28.03.2014 Добавил вызов мефедовской процедуры поиска счета для оплаты
   //EVG 3.04.2014 Закомментил доработку Руслана, см. каммент ниже
-----------------------------------------------------------------------------------------------------------------------------------------------------
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

import SFInter, PTInter;
// EVG 3/04/2014 import "sf_prbb.mac";

 MACRO SfPayCorrect( sfcomiss,       /*  запись sfcomiss.dbt */
                     date,           /*  дата взимания   */
                     ground,         /*  основание   */
                     paySum,         /*  сумма в валюте FIID   */
                     taxSum,         /*  НДС в валюте FIID*/
                     FIID,           /*  валюта сумм */
                     primKind,       /*  тип первички    KIND_OF_DOC */
                     primID,         /*  ID первички */

                     feeType,        /*   тип взимания   SF_FEE_TYPE_... */
                     some_com,       /*  если feeType == SF_FEE_TYPE_PERIOD, то здесь должна быть удержанная комиссия sfdefcom
                                         а если feeType == SF_FEE_TYPE_SINGLE, то комиссия операции oprsfcom
                                         ну а если feeType == SF_FEE_TYPE_ONCE, то разовая комиссия sfsingdf */
                     PayMethod,      /*  метод формирования оплат SF_PAY_METHOD_... */

                     sidebet,        /* sfsi.dbt -- платежная инструкция плательщика */
                     sicredit,       /* sfsi.dbt -- платежная инструкция получателя  */
                     Doc             /* буфер для вставки проводок в операции        */ ) 


    /* EVG 3/04/2014 Убрал поиск счёта-плательщика комиссии. Поиск уже выполнялся ранее - вызов из sfpay.mac->SfFormDocs() - именно для 
       единовременных комиссий. Там сделана проверка того, что счёт комиссии задан в платеже (для валютных переводов) - в этом случае
       подбор счёта не выполняется.
       Если всё-таки понадобится дублировать подбор счёта здесь или переносить его сюда, то здесь тоже нужно делать эту проверку - функция 
       GetComissAccountFromPayment() из CommissLib.mac.

    var ClientID = getClientOnContr( some_com.sfcontrid );
        sidebet.rec.Account = selectAccountForSfPay( paySum + taxSum, FIID, date, ClientID, SF_FEE_TYPE_SINGLE, some_com.ID,some_com.sfcontrid,
                                                    @sidebet.rec.FIID );
    */

    if( sfcomiss.ServiceKind == PTSK_STOCKDL )
      if (feeType == SF_FEE_TYPE_PERIOD)

        if( ExecMacroFile ( "sfpaysec.mac", "СкорректироватьПараметрыОплатыКомиссийДляБОЦБ", Doc, sfcomiss, some_com, sicredit, paySum, taxSum ) == true )
           SetParm(3, paySum);
           SetParm(4, taxSum);
        else
           return 1;     
        end;
      end;

    elif(   sfcomiss.ServiceKind == PTSK_CURRDL )

    end;

    return 0;
 END; // SfPayCorrect

