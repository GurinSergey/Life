/*---------------------------------------------------------------------------\
|                       Файл acctrn.mac.                                     |
|                     Для всех проводок                                      |
\---------------------------------------------------------------------------*/
/*SDA 13.03.2014 перенес пользовательское из архдока */
//LVV 08.12.2014 I-00537160-2 перенес пользовательские функции из arhdoc - 2.
import rsd, makeMT103, BankInter, "payments.mac", globals; 
import ShifrKind; 
import "diver.mac";
import "arh_oper.mac";
import "lib_const.mac"; //TAM 27.08.2013 R-237239

record          Документ( acctrn );
record          СтарыйДокумент( acctrn );

macro    Новый_документ( тип_документа )
   //TAM R-539022 13.03.2015
   msgbox("Запрещен ввод проводок вручную!|операции должны оформляться первичными документами");
   return 1;
end;

macro    Проверить_документ( Режим, Тип_документа )
   return 0;
end;

//LVV 05.12.2014 перенес из 30 версии старые пользовательские функции
/*macro    ФункцияПользователя( тип_документа )
   array mn;
   mn(0)="Печать кредитового авизо";
   if (Документ.kind_oper == " 3")
       mn(1)="ФИО получателя"; 
   end;

   var  m=menu(mn,null,"Выберите действие над платежом");

   if (m == 0)
      var cmd = RSDCommand("select t_paymentid from dpmdocs_dbt where t_ACCTRNID = ?");

      cmd.addparam("appkey",RSDBP_IN,Документ.ACCTRNID);
      var rs=RSDRecordset(cmd);

      if (rs.movenext)
         makeMT103(int(rs.value(0)));
      else
         msgbox("Отсутствует связь проводки с платежом");
      end;
   elif (m == 1) // ФИО получателя
       execmacrofile("lib_menu_common.mac", "GetRecName", Документ.acctrnid);
   end;

        return 0;
end;
*/
macro    ФункцияПользователя( тип_документа )
   debugbreak;
   array mn;
   var cmd, rs;
   var priority, pr;

   mn(0)="Кредитовое авизо";
   mn(1)="Корректировка шифра/вида";
   //Gurin S. 28.05.2014 R-385196-2
   if (Документ.kind_oper == " 3")
       mn(2)="ФИО получателя"; 
   end;
   if (ВходитВГруппу({oper}, ACS_GRP_CARRY_PRIORITY_DATE))  //185 - "Право исправлять очередность проводки"
      mn(3) = "Корректировка очередности проводки";
   end;
   if (ВходитВГруппу ({oper}, ACS_GRP_CARRY_EDIT))
      mn(4)="Простановка типа СПОД";
 //   mn(5)="Исправить проводку покрытия";
      mn(6)="Исправить проводку курсовой разницы";
      mn(7)="Замена операциониста на проводке/документе";
   end;
   
   
  
   var m = menu(mn,null,"Выберите действие над платежом");
   if (m == 0) // Кредитовое авизо
      cmd = RSDCommand("select t_paymentid from dpmdocs_dbt where t_acctrnid = ?");
      cmd.addparam("appkey",RSDBP_IN,Документ.acctrnid);
      rs=RSDRecordset(cmd);
      if (rs.movenext)
         makeMT103(int(rs.value(0)));
      else
         msgbox("Отсутствует связь проводки с платежом");
      end;
   elif (m == 1) // Корректировка шифра\вида
  //    updateSK(Документ.acctrnid, Документ.kind_oper, Документ.shifr_oper, true, (Документ.Code_Currency > 0) );
      updateSK(Документ.acctrnid, Документ.kind_oper, Документ.shifr_oper, true );
   elif (m == 2) // ФИО получателя
       execmacrofile("lib_menu_common.mac", "GetRecName", Документ.acctrnid);
   elif (m == 3) //Корректировка очередности проводки
      priority = Документ.priority;
    //  pr = getint(priority, "Очередность");
      //TAM 12.12.13 C-25730
      if ((Getint(Priority,"Укажите требуемую очередность","Укажите требуемую очередность")) and (Priority >=0) and (Priority <=6)) 
         rs = rsdcommand("update dacctrn_dbt set t_priority = "+priority+" where t_acctrnid = "+Документ.acctrnid);
         rs.execute;
      end; 
   elif (m == 4) // Простановка типа СПОД
      //vihrov 01.02.2011 чтоб не затирались другие типы новым сподом, а добавлялись, но не приписывались к квадратику
      cmd = RSDCommand("UPDATE   dacctrn_dbt   SET   t_typedocument   = CASE WHEN (t_typedocument = CHR (1)) THEN 'З' ELSE TRIM (t_typedocument || 'З') END WHERE   t_acctrnid =  "+Документ.acctrnid);
      cmd.Execute;
/*   elif (m == 5) // Исправить проводку покрытия
      cmd = RSDCommand("update dacctrn_dbt set t_result_carry = 1 where t_acctrnid = " + Документ.acctrnid);
      cmd.Execute;
*/
   elif (m == 6) //Исправить проводку курсовой разницы
      cmd = RSDCommand("update dacctrn_dbt set t_result_carry = 18 where t_acctrnid = " + Документ.acctrnid);
      cmd.Execute;
   elif (m == 7) // Замена операциониста на проводке\документе
      strartoperchange(Документ.acctrnid,Документ.date_carry,Документ.oper,Документ.numb_document,false,Документ.Account_Payer);
   end;


   return 0;
end;
/*
 *      Функция установки подсказки для списка проводок
 *              
 *         параметр ScrollKind принимает значения:
 *         - CARRY_SCROLL          - список проводок
 *         - CARRY_SCROLL_PAYER    - список дебитовых проводок по счету
 *         - CARRY_SCROLL_RECEIVER - список кредитовых проводок по счету
 *
 *      Если функция возвращает пустую строку, то используется хинт по умолчанию
 */
private macro УстановитьПодсказку( ScrollKind )
  return "";
end;
