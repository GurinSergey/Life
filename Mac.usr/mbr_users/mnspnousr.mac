/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : mnspnousr.mac
  Created     : 30.11.2011
  Programmer  : Lavrenov A., Tikhomirov A.
  Description : Класс работы с сообщениями PNO
  Mod.        : Доработка класса PNO
                Lavrenov: 26.06.2012 C-12286-6  
                Teleshova 18.12.2014 C-35507
└───────────────────────────────────────────────────────────────────────────*/

import /*"wlmnstls.mac"*/ ptinter, rsbdataset, globals;
import "PaymProc.mac", "fns_lib.mac";

class MnsMessageFormPNO(m_reqid)

   var Error;                    // Действие выполнено с ошибкой
   var ErrorMes;                 // Сообщение об ошибке
   var DoNotSend = 0;            // Если не 0 то сообщение не формируем
   var reqid = m_reqid;          // идентификатор исходного запроса
   var PartyID = -1;             // идентификатор клиента  
   var PaymentID = 0;            // идентификатор платежа  
   var ПроверенСчета = TArray(); // Массив Счетов, прошедших проверку функцией Chek
   private var field_name, field_value;


   // Поля сообщения PNO
   var  ИдФайл ="",     // Идентификатор файла 
        ТипИнф ="",     // Тип информации 
        ВерсПрог ="",   // Версия передающей программы
        ТелОтпр ="",    // Телефон отправителя
        ДолжнОтпр ="",  // Должность отправителя
        ФамОтпр ="",    // Фамилия отправителя 
        КолДок ="",     // Количество  документов
        ВерсФорм ="",   // Версия формата
        ИдДок ="",      // Идентификатор документа 
        ОКУД ="",       // Номер формы по ОКУД ОК-11-93
        НомПоруч ="",   // Номер Поручения
        ДатаПоруч ="",  // Дата Поручения
        ВидПлат ="",    // Вид платежа
        СумПоруч ="",   // Сумма
        ИНННП ="",      // ИНН плательщика
        КППНП ="",      // КПП плательщика
        Плательщ ="",   // Плательщик
        НомСчПл ="",    // Сч. N="", плательщика
        БанкПл ="",     // Банк плательщика 
        БИКБПл ="",     // БИК банка плательщика
        НомСчБПл ="",   // Сч. N банка плательщика
        НомФ  ="",      // Номер филиала банка плательщика
        БанкПол ="",    // Банк получателя
        БИКБПол ="",    // БИК банка получателя
        НомСчБПол ="",  // Сч. N банка получателя
        ИННПол ="",     // ИНН получателя
        КПППол ="",     // КПП получателя
        НаимПол ="",    // Получатель 
        НомСчПол ="",   // Сч. N получателя
        ВидОп ="",      // Вид операции
        НазПлКод ="",   // Наз. Пл.
        ОчерПл ="",     // Очер. плат.
        КодПл ="",      // Код
        РезПоле ="",    // Рез. поле
        НазнПл ="",     // Назначение платежа
        Статус ="",     // Статус
        КБК ="",        // КБК

        ОКТМО ="",      // ОКТМО
        ОКАТО ="",      // ОКАТО

        ОснПл ="",      // Основание платежа
        СрокУплТр ="",  // Срок уплаты по требованию
        НомТреб ="",    // Номер требования
        ДатаТреб ="",   // Дата требования
        ТипПлат ="",    // Тип платежа
        НомПорВал ="",  // Номер поручения на продажу валюты
        ДатаПорВал ="", // Дата поручения на продажу валюты
        НомВалСч ="";   // Номер валютного счета

   macro GetClientId()
     PartyID = GetPartyidByINN(ИНННП,КППНП);
   end;
   
   macro MnsMessageFormPNO( ) 
     var  rs, str; //rs.t_name, rs.t_value;

     Error = 0;
     ErrorMes = "";

     if(valtype(reqid)== V_UNDEF)
        while( СчитатьПоле( field_name, field_value ) )
            if( field_name == "ИдФайл" )        ИдФайл         = field_value; end;
            if( field_name == "ТипИнф" )        ТипИнф         = field_value; end;
            if( field_name == "ВерсПрог" )      ВерсПрог       = field_value; end;
            if( field_name == "ТелОтпр" )       ТелОтпр        = field_value; end;
            if( field_name == "ДолжнОтпр" )     ДолжнОтпр      = field_value; end;
            if( field_name == "ФамОтпр" )       ФамОтпр        = field_value; end;
            if( field_name == "КолДок" )        КолДок         = field_value; end;
            if( field_name == "ВерсФорм" )      ВерсФорм       = field_value; end;
            if( field_name == "ИдДок" )         ИдДок          = field_value; end;
            if( field_name == "ОКУД" )          ОКУД           = field_value; end;
            if( field_name == "НомПоруч" )      НомПоруч       = field_value; end;
            if( field_name == "ДатаПоруч" )     ДатаПоруч      = field_value; end;
            if( field_name == "ВидПлат" )       ВидПлат        = field_value; end;
            if( field_name == "СумПоруч" )      СумПоруч       = field_value; end;
            if( field_name == "ИНННП" )         ИНННП          = field_value; end;
            if( field_name == "КППНП" )         КППНП          = field_value; end;
            if( field_name == "Плательщ" )      Плательщ       = field_value; end;
            if( field_name == "НомСчПл" )       НомСчПл        = field_value; end;
            if( field_name == "БанкПл" )        БанкПл         = field_value; end;
            if( field_name == "БИКБПл" )        БИКБПл         = field_value; end;
            if( field_name == "НомСчБПл" )      НомСчБПл       = field_value; end;
            if( field_name == "НомФ" )          НомФ           = field_value; end;
            if( field_name == "БанкПол" )       БанкПол        = field_value; end;
            if( field_name == "БИКБПол" )       БИКБПол        = field_value; end;
            if( field_name == "НомСчБПол" )     НомСчБПол      = field_value; end;
            if( field_name == "ИННПол" )        ИННПол         = field_value; end;
            if( field_name == "КПППол" )        КПППол         = field_value; end;
            if( field_name == "НаимПол" )       НаимПол        = field_value; end;
            if( field_name == "НомСчПол" )      НомСчПол       = field_value; end;
            if( field_name == "ВидОп" )         ВидОп          = field_value; end;
            if( field_name == "НазПлКод" )      НазПлКод       = field_value; end;
            if( field_name == "ОчерПл" )        ОчерПл         = field_value; end;
            if( field_name == "КодПл" )         КодПл          = field_value; end;
            if( field_name == "РезПоле" )       РезПоле        = field_value; end;
            if( field_name == "НазнПл" )        НазнПл         = field_value; end;
            if( field_name == "Статус" )        Статус         = field_value; end;
            if( field_name == "КБК" )           КБК            = field_value; end;

            if( field_name == "ОКТМО")          ОКТМО          = field_value; end;
            if( field_name == "ОКАТО" )         ОКАТО          = field_value; end;

            if( field_name == "ОснПл" )         ОснПл          = field_value; end;
            if( field_name == "СрокУплТр" )     СрокУплТр      = field_value; end;
            if( field_name == "НомТреб" )       НомТреб        = field_value; end;
            if( field_name == "ДатаТреб" )      ДатаТреб       = field_value; end;
            if( field_name == "ТипПлат" )       ТипПлат        = field_value; end;
            if( field_name == "НомПорВал" )     НомПорВал      = field_value; end;
            if( field_name == "ДатаПорВал" )    ДатаПорВал     = field_value; end;
            if( field_name == "НомВалСч" )      НомВалСч       = field_value; end;
        end;       

     else
         str =  "SELECT f.t_name, t.t_value, m.t_mandatoryflag " +
                "	 FROM dwlmesval_dbt t, dwlmeslnk_dbt l, dwltpfld_dbt f, dwlmesfld_dbt m " +
                "	WHERE 	 l.t_objkind = 505 " +
                "			AND l.t_objid =  " + reqid +
                "			AND t.t_mesid = l.t_mesid " +
                "			AND t.t_tpfieldid = f.t_tpfieldid " +
                "			AND m.t_fieldid = t.t_fieldid " +
                "ORDER BY t_index " ;
          rs = trsbdataset(str);
          while( rs and rs.movenext )
            if( rs.t_name == "ИдФайл" )        ИдФайл         = rs.t_value; end;
            if( rs.t_name == "ТипИнф" )        ТипИнф         = rs.t_value; end;
            if( rs.t_name == "ВерсПрог" )      ВерсПрог       = rs.t_value; end;
            if( rs.t_name == "ТелОтпр" )       ТелОтпр        = rs.t_value; end;
            if( rs.t_name == "ДолжнОтпр" )     ДолжнОтпр      = rs.t_value; end;
            if( rs.t_name == "ФамОтпр" )       ФамОтпр        = rs.t_value; end;
            if( rs.t_name == "КолДок" )        КолДок         = rs.t_value; end;
            if( rs.t_name == "ВерсФорм" )      ВерсФорм       = rs.t_value; end;
            if( rs.t_name == "ИдДок" )         ИдДок          = rs.t_value; end;
            if( rs.t_name == "ОКУД" )          ОКУД           = rs.t_value; end;
            if( rs.t_name == "НомПоруч" )      НомПоруч       = rs.t_value; end;
            if( rs.t_name == "ДатаПоруч" )     ДатаПоруч      = rs.t_value; end;
            if( rs.t_name == "ВидПлат" )       ВидПлат        = rs.t_value; end;
            if( rs.t_name == "СумПоруч" )      СумПоруч       = rs.t_value; end;
            if( rs.t_name == "ИНННП" )         ИНННП          = rs.t_value; end;
            if( rs.t_name == "КППНП" )         КППНП          = rs.t_value; end;
            if( rs.t_name == "Плательщ" )      Плательщ       = rs.t_value; end;
            if( rs.t_name == "НомСчПл" )       НомСчПл        = rs.t_value; end;
            if( rs.t_name == "БанкПл" )        БанкПл         = rs.t_value; end;
            if( rs.t_name == "БИКБПл" )        БИКБПл         = rs.t_value; end;
            if( rs.t_name == "НомСчБПл" )      НомСчБПл       = rs.t_value; end;
            if( rs.t_name == "НомФ" )          НомФ           = rs.t_value; end;
            if( rs.t_name == "БанкПол" )       БанкПол        = rs.t_value; end;
            if( rs.t_name == "БИКБПол" )       БИКБПол        = rs.t_value; end;
            if( rs.t_name == "НомСчБПол" )     НомСчБПол      = rs.t_value; end;
            if( rs.t_name == "ИННПол" )        ИННПол         = rs.t_value; end;
            if( rs.t_name == "КПППол" )        КПППол         = rs.t_value; end;
            if( rs.t_name == "НаимПол" )       НаимПол        = rs.t_value; end;
            if( rs.t_name == "НомСчПол" )      НомСчПол       = rs.t_value; end;
            if( rs.t_name == "ВидОп" )         ВидОп          = rs.t_value; end;
            if( rs.t_name == "НазПлКод" )      НазПлКод       = rs.t_value; end;
            if( rs.t_name == "ОчерПл" )        ОчерПл         = rs.t_value; end;
            if( rs.t_name == "КодПл" )         КодПл          = rs.t_value; end;
            if( rs.t_name == "РезПоле" )       РезПоле        = rs.t_value; end;
            if( rs.t_name == "НазнПл" )        НазнПл         = rs.t_value; end;
            if( rs.t_name == "Статус" )        Статус         = rs.t_value; end;
            if( rs.t_name == "КБК" )           КБК            = rs.t_value; end;

            if( rs.t_name == "ОКТМО" )         ОКТМО          = rs.t_value; end; // "ОКАТО" )         ОКАТО          = rs.t_value; end;
            if( rs.t_name == "ОКАТО" )         ОКАТО          = rs.t_value; end;

            if( rs.t_name == "ОснПл" )         ОснПл          = rs.t_value; end;
            if( rs.t_name == "СрокУплТр" )     СрокУплТр      = rs.t_value; end;
            if( rs.t_name == "НомТреб" )       НомТреб        = rs.t_value; end;
            if( rs.t_name == "ДатаТреб" )      ДатаТреб       = rs.t_value; end;
            if( rs.t_name == "ТипПлат" )       ТипПлат        = rs.t_value; end;
            if( rs.t_name == "НомПорВал" )     НомПорВал      = rs.t_value; end;
            if( rs.t_name == "ДатаПорВал" )    ДатаПорВал     = rs.t_value; end;
            if( rs.t_name == "НомВалСч" )      НомВалСч       = rs.t_value; end;
         end;
         
         GetClientId();     
     end;
   end;

   
   macro CreatePayment()
    var Paym = UsrPayment(); 
    var ErrorMessage;
    var stat, cmd;
    var RecBankPatryId, RecBankINN;
    //Lavrenov: 26.06.2012 C-12286-6 Номер пачки вынесен в настройку
    var number_pack, errcode;
        GetRegistryValue("PRBB\\FNS\\PACK_PNO", V_INTEGER, number_pack, errCode);
        //msgbox(number_pack,"||" ,errCode);
        if((errcode) or (number_pack == 0))
           number_pack = 1002; 
        end;

        Paym.Initialization();

        debugbreak;
        Paym.NumDoc                 = НомПоруч;          // Номер документа
        Paym.DocDate                = date(ДатаПоруч);   // Дата докумнета
        Paym.ValueDate              = {curdate};         // Дата платежа
        Paym.DebetSum               = Double(СумПоруч)/100;          // Сумма документа
        Paym.Ground                 = НазнПл;            // Основание документа
        Paym.Shifr                  = ВидОп ;//"06/ 6";           // Шифр платежа
        Paym.Oper                   = {oper};            // Операционист
        Paym.Department             = 1;                 // Номер филиала
        Paym.Pack                   = number_pack;       //Номер пачки
            
        if(НомСчПл == "")                                //Счет плательщика
            Paym.PayerAccount       = НомСчБПл; 
        else
            Paym.PayerAccount       = НомСчПл;
        end;
        Paym.PayerName              = Плательщ;          // Наименование плательщика
        Paym.PayerINN               = ИНННП;             // ИНН плательщика
        Paym.PayerKPP               = КППНП;             // КПП плательщика
        Paym.PayerBIC               = БИКБПл;            // БИК банка плательщика

        if(НомСчПол == "")                               // Счет получателя
            Paym.ReceiverAccount    = НомСчБПол;
        else
            Paym.ReceiverAccount    = НомСчПол;
        end;
        Paym.ReceiverBIC            = БИКБПол;           // БИК банка получателя
        Paym.ReceiverName           = НаимПол;           // Наименование получателя
        Paym.ReceiverINN            = ИННПол;            // ИНН получателя 
        Paym.ReceiverKPP            = КПППол;            // КПП получателя
        Paym.Priority               = ОчерПл;            // Очерёдность платежа
        //TAM 18.12.2014 C-35507
        Paym.UIN                    = КодПл;             // УИН

        Paym.CreatorStatus          = Статус;            // Статус составителя
        Paym.KbkCode                = КБК;               // Код КБК

        if( ОКТМО == "" )
            Paym.OkatoCode          = ОКАТО;             // Код ОКАТО
        else
            Paym.OkatoCode          = ОКТМО;             // Код ОКАТО
        end;

        Paym.GroundTaxDoc           = ОснПл;             // Основание налогового платежа 
        Paym.TaxPeriod              = СрокУплТр;         // Налоговый период
        Paym.NumTaxDoc              = НомТреб;           // Номер налогового документа
        Paym.TaxDate                = ДатаТреб;          // Дата налогового документа
        Paym.TaxType                = ТипПлат;           // Тип налогового платежа

        Paym.SkipCheckMask          = skip_recacc_exists+skip_pay_inn_fill+skip_rec_inn_fill+skip_payname_match+skip_recname_match; // Маска пропуска проверок
        Paym.Origin                 = 3300;             //Платеж по сообщению PNO (365П)
        Paym.doc_cur_iso            = substr(Paym.PayerAccount,6,3); // ISO валюты платежа
        Paym.DocKind                = 2011;              // Клиентское поручение
        Paym.RunOperation           = 0;                 // платежи должны быть в отложенных
        Paym.CheckExists            = 0;                 // проверка на дублирование
        Paym.PackMode               = 0;                 //вставка платежей не массовая
        Paym.MakeCarryFromPayment   = 1;                 //проводка по той же корреспонденции, что и сам платеж

        if (not Paym.InsertPayment())                          
            ErrorMes = Paym.ErrorMessage;
            Error = 1;
	     return error;	
        else
            PaymentID = Paym.PaymentID;
            return 0;
        end;
   end;
   
   
   MnsMessageFormPNO();

end;


