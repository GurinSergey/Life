/*******************************************************************************/
/*  RS-Bank 6.0                                          R-Style Software Lab  */
/*                                                                             */
/*  File Name   : mnsgmpb.mac                                                  */
/*  Created     : 08.12.2011                                                   */
/*  Programmer  : Chesnokov D.                                                 */
/*  Description : Œ ªà®á á®§¤ ­¨ï ¯®¤¢¥à¦¤¥­¨© 1/2 (PB)                        */
/*  ‡ ï¢ª       : C-7026                                                       */
/*  ˆ§¬¥­¥­¨ï   : 07.03.2012 ChesnokovD. ˆá¯à ¢«¥­® ä®à¬¨à®¢ ­¨¥ ¢à¥¬¥­¨       */
/*  ˆ§¬¥­¥­¨ï   : 18.04.2012 Chesnokov D. ¥à¥®¯à¥¤¥«¥­® ¯®«ãç¥­¨¥ ¨¬¥­¨       */
/*                 ¢å®¤ïé¥£® ä ©« , ¤«ï ¬ áá®¢®© £¥­¥à æ¨¨ PNO ¢ 2030          */
/*******************************************************************************/

import BankInter, globals,  RSD, PsInter, currinter, rsexts;
import "wlmnstls.mac", "FNS_lib.mac", "FNS_const.mac", "mnspbusr.mac";

/*‘®§¤ ­¨¥ ä ©«  ¨­ä®à¬ æ¨®­­®£® á®®¡é¥­¨ï*/
macro CreatePB(wlreq, err, type, fl_name, mes_id)

  var mes;
  var stat, Error = 0, i;
  var TxtFileDir, ExpPath;
  var rs, fullfilename, name, dir, ext, cnum;
   
  GetRegistryValue("BANK_INI\\Ž™ˆ… €€Œ…’›\\„ˆ…Š’Žˆˆ\\TEXTDIR", V_STRING, TxtFileDir, error);
  if ( error > 0 )
    msgbox("à®¢¥àìâ¥ ­ «¨ç¨¥ ­ áâà®©ª¨: BANK_INI\\Ž™ˆ… €€Œ…’›\\„ˆ…Š’Žˆˆ\\TEXTDIR");
    return 1;
  end;

  GetRegistryValue("PS\\REQOPENACC\\OPERATION\\‘Ž‡„€ˆ… ˆ” ‘ŽŽ™…ˆ‰\\„ˆ…Š’ŽˆŸ ‚›ƒ“‡Šˆ", V_STRING, ExpPath, error);
  if ( error > 0 )
    msgbox("à®¢¥àìâ¥ ­ «¨ç¨¥ ­ áâà®©ª¨: PS\\REQOPENACC\\OPERATION\\‘Ž‡„€ˆ… ˆ” ‘ŽŽ™…ˆ‰\\„ˆ…Š’ŽˆŸ ‚›ƒ“‡Šˆ");
    return 1;
  end;

  rs = trsbdataset("select RSBSESSIONDATA.CNUM  from dual ");
  if (rs and rs.movenext)
     cnum = int(rs.cnum);
  else
     cnum = {oper};
  end;
  
  if (mes_id)
    Name = ®«ãç¨âìˆ¬ï‚å®¤” ©« ®‘®®¡é( mes_id );
  else
    Name = ®«ãç¨âìˆ¬ï‚å®¤” ©« ( wlreq.reqid );
  end;
  dir = SplitFile(Name, name, ext);

  mes = MnsMessageFormPB(wlreq.reqid);

  if (Mes.’¨¯Žâ¢ == "")
    Mes.’¨¯Žâ¢ = type;
  end;

  fullfilename = TxtFileDir+"\\PB"+Mes.’¨¯Žâ¢+"_" + name + "."+cnum;
  /*¥à¥®¯à¥¤¥«¨¬ ¢ë¢®¤ ¢ ­ã¦­ë© ­ ¬ ä ©«*/
  SetOutPut(fullfilename, false);
  
  if (Mes.ˆ¬ï‚å” ©«  != "")
    println( Mes.ˆ¬ï‚å” ©«  + "###");
  else
    println( name + "###");
  end;
  
  i = 0;
  if (Mes.Žè‘®®¡.size > 0)
    while(i < Mes.Žè‘®®¡.size)
      println(Mes.Žè‘®®¡[i] + "@@@" );
      i = i + 1;
    end;
  else
    println(err + "@@@");
  end;
  
  if (Mes.„ â à®¢¥àª¨ != "")
    println( Mes.„ â à®¢¥àª¨ + "@@@");
  else
    println( ToDateStr() + "@@@")
  end;
  
  if (Mes.‚à¥¬ïà®¢¥àª¨ != "")
    println( Mes.‚à¥¬ïà®¢¥àª¨ + "@@@");
  else
    println( TimeToStr(Time()) + "@@@");
  end;
  
  println("===");
  
  SetOutput(null, true);

  Name = "PB"+Mes.’¨¯Žâ¢+"_" + Name + ".txt";    
  
  removefile(ExpPath + "\\" + Name);
  if (CopyFile(fullfilename, ExpPath + "\\" + Name))

    setparm(3, Name);
    return 0;
  else
    msgbox("¥ ã¤ «®áì áª®¯¨à®¢ âì ä ©« "+ Name + "| ¢ ª â «®£ "+ ExpPath + "\\");
    return 1;
  end;
return 0;
  
end;