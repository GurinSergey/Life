Import MesInter, globals, WldInter ;
import "wlmnstls.mac";


Class MnsMessageFormERR();

  var ИмяВхФайла      = "",
      ТипОтв          = "",
      ДатаПроверки    = "",
      ВремяПроверки   = "",
      ОшСооб          = Tarray(); 
      
      
  macro MnsMessageFormERR
  var field_name, field_value;
  
    if (ИмяВхФайла == "")
      while(СчитатьПоле(field_name, field_value))
        if(field_name == "ИмяВхФайла")
          ИмяВхФайла = field_value;
        end;
        if(field_name == "ТипОтв ")
          ТипОтв  = field_value;
        end;
        if(field_name == "ДатаПроверки")
          ДатаПроверки = field_value;
        end;
        if(field_name == "ВремяПроверки")
          ВремяПроверки = field_value;
        end;
        if(field_name == "ОшСооб")
          ОшСооб[ОшСооб.Size] = field_value;
        end;
      end;
    end;
    
  end;
  
  MnsMessageFormERR();
  
end;

// Клиент, по которому создается сообщение
private class ZNSParty( ID:integer )
  var PartyID   :integer;
  var LegalForm :integer;
  var FullName  :string;
  var FullINN   :string;

  macro ZNSParty( ID:integer )
    private var PartyObj = RsbParty( ID );
    PartyID    = ID;
    LegalForm  = PartyObj.LegalForm;
    if( LegalForm == PTLEGF_INST )
      FullName =  PartyObj.FullName;
    else
      FullName = string( PartyObj.LastName, ",", PartyObj.FirstName, ",", PartyObj.Patronymic );
    end;
    FullINN    = PartyObj.Code(PTCK_INN);
  end;
  ZNSParty(ID);
end;

macro GenDoc (AddrMes)

  debugbreak;
  SetBuff( wlmes, addrMes );
  var error = 0, ReqID = -1, i = 0;
  var Message:MnsMessageFormERR;
  var cmd;
  var Отправитель = ZNSParty(wlmes.OutsideAbonentID);
  
  Message.MnsMessageFormERR;
  
  printlog(2, "Генерация формы ERR");
 
 ClearRecord(wlreq);

  /* Заполнение учетных буферов */
  wlreq.Kind                     = 5;
  wlreq.SubKind                  = 0;
  wlreq.Trn                      = 1;
  wlreq.PmDateValue              = wlmes.OutsideAbonentDate;
  wlreq.RelatedRef               = wlmes.Trn;
  wlreq.Queries                  = "Ошибка";
  wlreq.OriginatorID             = wlmes.OutsideAbonentID;
  wlreq.OriginatorCodeKind       = wlmes.OutsideAbonentCodeKind;
  wlreq.OriginatorCode           = wlmes.OutsideAbonentCode;
  wlreq.OriginatorName           = Отправитель.FullName; 
  wlreq.RecipientID              = {OurBank}; //wlmes.InsideAbonentID;
  wlreq.RecipientCodeKind        = PTCK_BIC; //wlmes.InsideAbonentCodekind;
  wlreq.RecipientCode            = {MFO_Bank}; //wlmes.InsideAbonentcode;
  wlreq.RecipientName            = {Name_Bank};
  wlreq.Corschem                 = -1;
  wlreq.FIID                     = -1;
  

  if( not ВставитьЗапрос( wlreq, "Ошибка", "-1", NULL, ReqID ) )
    std.msg("Ошибка при вводе запроса");
    return FALSE;
  end;
 
  return true;


  OnError(er) /* обработка ошибок времени выполнения */
 
  return false;
  
end;