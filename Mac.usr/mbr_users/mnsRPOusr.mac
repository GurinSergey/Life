/*────────────────────────────z──────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : mnsRPOusr.mac
  Created     : 15.12.2011
  Programmer  : Lavrenov A.
  Description : Класс работы с сообщениями RPO
  Mod.        : 23.12.2011 Переименована процедура AccountExists_RUR
                23.01.11 Gurin S. N. I-00145091-1
                25.01.11 Зленко М.П. I-00146042-1
                26.01.11 Зленко М.П. I-00146075-2
                10.01.12 Gurin S. N.  I-00142411-1
                28.04.12 Chesnokov D.S C-10532
                17.05.12 Chesnokov D.S. I-00195062
                17.05.12 Chesnokov D.S. I-00195094
                25.05.12 Golovkin V.N.  C-11297
                07.06.12 Golovkin V.N.  I-00196876
                08.06.12 Lavrenov I-00206328-1 
                25.06.12 Lavrenov I-00212290-1 
                29.06.12 Golovkin R-64474
                11.07.12 Golovkin I-00202250
                31.07.12 Golovkin C-12937
                02.08.12 Chesnokov D.S. переписал под вызов дистрибутивного пакета
                09.08.12 Golovkin I-00233470
                03.09.12 KS       I-00230750 ОТПРАВКА ПИСЕМ-УВЕДОМЛЕНИЙ В LOTUS
                27.03.13 Gurin S. R-171499-2 для ГЕБа определяем счета СКС по типу счета D
                17.04.13 Golovkin C-18326    убрал проверку на соответствие КПП
                19.04.13 Golovkin C-19181    Обработка претензий по закрытым счетам
                21.05.13 Gurin S. R-192203-2 проверка на тип счета О для ГЕБа
                05.08.13 Gurin S. C-17880 
                02.09.13 Gurin S. R-230755-2
                17.09.13 zmp      C-23347-6 для валютный транзитных счетов создается PB2
                13.11.13 Gurin S. R-283396-2 Перенес C-17880 на ГЕБ
                14.07.14 Gurin S. R-409824-2 Перенес C-17880 на Солидарность
└───────────────────────────────────────────────────────────────────────────*/


import "wlmnstls.mac", ptinter, rsbdataset, globals, "fns_lib.mac",rsexts, "send_claim.mac", "lib_account.mac", "fg_Life_parm.mac";
import FIInter, BankInter, CTInter, lib_fg;
import autoKOR/*, acs_func*/;

private var fgBank = fg_life_subject({OurBank});

class MnsMessageFormRPO(m_reqid)
   debugbreak;

   var Error;                    // Действие выполнено с ошибкой
   var ErrorMes;                 // Сообщение об ошибке
   var DoNotSend = 0;            // Если не 0 то сообщение не формируем
   var DoNotProcess = 0;         // Если не 0 то сообщение не обрабатываем, только для массовой обработки
   var ReqID = m_reqid;          // идентификатор исходного запроса
   var PartyID = -1;             // идентификатор клиента  
   var FileName;                 // Имя входящего файла
   var ClaimID = TArray();       // Массив идентификаторов претензий  
   var ОшибочнСчета  = TArray(); // Массив Счетов, по которым не вставилась претензия
   var ПроверенСчета = TArray(); // Массив Счетов, прошедших проверку функцией Chek


   // Поля сообщения RPO
   var  ИдФайл ="",        // Идентификатор файла 
        ТипИнф ="",        // Тип информации 
        ВерсПрог ="",      // Версия передающей программы 
        ТелОтпр ="",       // Телефон отправителя
        ДолжнОтпр ="",     // Должность отправителя
        ФамОтпр ="",       // Фамилия отправителя 
        КолДок ="",        // Количество  документов
        ВерсФорм ="",      // Версия формата
        ИдДок ="",         // Идентификатор документа 
        НомРешПр ="",      // Номер решения
        ДатаРешПр ="",     // Дата принятия решения
        КодНО ="",         // Код налогового органа, сформировавшего решение
        НаимНО ="",        // Наименование налогового органа, сформировавшего решение 
        КодОснов ="",      // Код основания для вынесения решения
        НаимПрич ="",      // Причина вынесения решения
        ИНННП ="",         // ИНН налогоплательщика
        КППНП ="",         // КПП налогоплательщика
        НаимНП ="",        // Наименование юридического лица
        ФИОИП ="",         // ФИО индивидуального предпринимателя, нотариуса, адвоката
        АдрНП ="",         // Адрес места нахождения (жительства) налогоплательщика
        Обстоят ="",       // Обстоятельства существа  установленного  факта  нарушения  
        БИК ="",           // БИК банка (филиала) или учреждения Банка России
        НаимКО ="",        // Наименование банка (филиала) или учреждения Банка России
        НомФ ="",          // Номер филиала банка
        СумВзыск ="",      // Сумма, подлежащая взысканию, руб.
        НомРешВзыск ="",   // Номер решения о взыскании 
        ДатаРешВзыск ="",  // Дата решения о взыскании 
        КласЧинРук ="",    // Классный чин руководителя налогового органа (заместителя)
        ФИОРук ="",        // Ф.И.О. руководителя 
        ДолжРук ="",       // Должность лица, принявшего решение
        НомСч = TArray(),  // Номер счета
        ВидСч = TArray();  // Вид счета
   

   macro GetClientId()
     PartyID = GetPartyidByINN(ИНННП,КППНП);
   end;

   // zmp 16.06.2014 
   private macro is_transit_account(acc)
      if(acc.code_currency != 0)
         if(fgBank.is_SLD)
            if(substr(acc.account, 14, 1) == "9")  return true; end;
         else
            if(substr(acc.account, 14, 1) == "1")  return true; end;
         end;        
      end;
      return false;
   end;            


   //zmp 17.07.2014 C-31296 исключено из проверки часть не действующих счетов СКС 
   private macro is_SKS(acc, account)

      macro notSKS(acc)
         var sql = execSQLSelect("select 1 from daccount_dbt acc where instr(ACC.T_USERTYPEACCOUNT, chr(72)) != 0 and ACC.T_ACCOUNT = '" + acc + "'");
         return (sql and sql.moveNext())
      onError
         return false;
      end;

      if  (_bank.is_EXV_Saratov)  // zmp 04.09.2014 C-32903
          return ((substr(Acc.account,11,1) == "9") or
                  (substr(Acc.account,12,1) == "9"));
      elif(inList(true, _bank.is_EXV_Stavropol, _bank.is_EXV_Volgograd, _bank.is_EXV_Voronezh))
          return  (substr(Acc.account,12,1) == "9");
      elif(_bank.is_GEB)
          if(account.check_usertypeaccount("D"))                              return true; end;
      elif(_bank.is_SLD)
          if((substr(Acc.account,14,1) == "8") and (not notSKS(Acc.account))) return true; end;
      else
          if((substr(Acc.account,11,1) == "9") and (not notSKS(Acc.account))) return true; end;
      end;


   return false;
   end;
   
   //17.09.13 zmp C-23347-6
   macro UpdateAccLnkSate(Acc, State)
      execSQL(" update dwlacclnk_dbt t    " +                                       
              "    set t_state =    ?     " +                                         
              "  where T_OBJECTTYPE = 505 " +                                   
              "    and T_OBJECTID = ?     " + 
              "    and t_account =  ?     ",
              makeArray(SQLParam("", State), SQLParam("", reqid), SQLParam("", Acc)));
   end;
   
   macro MnsMessageFormRPO() 
     var  rs, str; 
     var field_name, field_value;

     Error = 0;
     ErrorMes = "";

     if(valtype(reqid)== V_UNDEF)
        while( СчитатьПоле( field_name, field_value ) )
          if( field_name =="ИдФайл")         ИдФайл  = field_value;        end;
          if( field_name =="ТипИнф")         ТипИнф  = field_value;        end;
          if( field_name =="ВерсПрог")       ВерсПрог  = field_value;      end;
          if( field_name =="ТелОтпр")        ТелОтпр  = field_value;       end;
          if( field_name =="ДолжнОтпр")      ДолжнОтпр  = field_value;     end;
          if( field_name =="ФамОтпр")        ФамОтпр  = field_value;       end;
          if( field_name =="КолДок")         КолДок  = field_value;        end;
          if( field_name =="ВерсФорм")       ВерсФорм  = field_value;      end;
          if( field_name =="ИдДок")          ИдДок  = field_value;         end;
          if( field_name =="НомРешПр")       НомРешПр  = field_value;      end;
          if( field_name =="ДатаРешПр")      ДатаРешПр  = field_value;     end;
          if( field_name =="КодНО")          КодНО  = field_value;         end;
          if( field_name =="НаимНО")         НаимНО  = field_value;        end;
          if( field_name =="КодОснов")       КодОснов  = field_value;      end;
          if( field_name =="НаимПрич")       НаимПрич  = field_value;      end;
          if( field_name =="ИНННП")          ИНННП  = field_value;         end;
          if( field_name =="КППНП")          КППНП  = field_value;         end;
          if( field_name =="НаимНП")         НаимНП  = field_value;        end;
          if( field_name =="ФИОИП")          ФИОИП  = field_value;         end;
          if( field_name =="АдрНП")          АдрНП  = field_value;         end;
          if( field_name =="Обстоят")        Обстоят  = field_value;       end;
          if( field_name =="БИК")            БИК  = field_value;           end;
          if( field_name =="НаимКО")         НаимКО  = field_value;        end;
          if( field_name =="НомФ")           НомФ  = field_value;          end;
          if( field_name =="СумВзыск")       СумВзыск  = field_value;      end;
          if( field_name =="НомРешВзыск")    НомРешВзыск  = field_value;   end;
          if( field_name =="ДатаРешВзыск")   ДатаРешВзыск  = field_value;  end;
          if( field_name =="КласЧинРук")     КласЧинРук  = field_value;    end;
          if( field_name =="ФИОРук")         ФИОРук  = field_value;        end;
          if( field_name =="ДолжРук")        ДолжРук  = field_value;       end;
          if( field_name =="НомСч")          НомСч[НомСч.size] = field_value; end;
          if( field_name =="ВидСч")          ВидСч[ВидСч.size] = field_value; end;
        end;       

     else
        str =  " SELECT f.t_name, t.t_value, m.t_mandatoryflag " +
               "   FROM dwlmesval_dbt t, dwlmeslnk_dbt l, dwltpfld_dbt f, dwlmesfld_dbt m " +
               "  WHERE     l.t_objkind = 505 " +
               "    AND l.t_objid =  " + reqid +
               "    AND t.t_mesid = l.t_mesid " +
               "    AND t.t_tpfieldid = f.t_tpfieldid " +
               "    AND m.t_fieldid = t.t_fieldid " +
               "  ORDER BY t_index " ;
        rs = trsbdataset(str);
        while( rs and rs.movenext )
          if( rs.t_name =="ИдФайл")         ИдФайл  = rs.t_value;        end;
          if( rs.t_name =="ТипИнф")         ТипИнф  = rs.t_value;        end;
          if( rs.t_name =="ВерсПрог")       ВерсПрог  = rs.t_value;      end;
          if( rs.t_name =="ТелОтпр")        ТелОтпр  = rs.t_value;       end;
          if( rs.t_name =="ДолжнОтпр")      ДолжнОтпр  = rs.t_value;     end;
          if( rs.t_name =="ФамОтпр")        ФамОтпр  = rs.t_value;       end;
          if( rs.t_name =="КолДок")         КолДок  = rs.t_value;        end;
          if( rs.t_name =="ВерсФорм")       ВерсФорм  = rs.t_value;      end;
          if( rs.t_name =="ИдДок")          ИдДок  = rs.t_value;         end;
          if( rs.t_name =="НомРешПр")       НомРешПр  = rs.t_value;      end;
          if( rs.t_name =="ДатаРешПр")      ДатаРешПр  = rs.t_value;     end;
          if( rs.t_name =="КодНО")          КодНО  = rs.t_value;         end;
          if( rs.t_name =="НаимНО")         НаимНО  = rs.t_value;        end;
          if( rs.t_name =="КодОснов")       КодОснов  = rs.t_value;      end;
          if( rs.t_name =="НаимПрич")       НаимПрич  = rs.t_value;      end;
          if( rs.t_name =="ИНННП")          ИНННП  = rs.t_value;         end;
          if( rs.t_name =="КППНП")          КППНП  = rs.t_value;         end;
          if( rs.t_name =="НаимНП")         НаимНП  = rs.t_value;        end;
          if( rs.t_name =="ФИОИП")          ФИОИП  = rs.t_value;         end;
          if( rs.t_name =="АдрНП")          АдрНП  = rs.t_value;         end;
          if( rs.t_name =="Обстоят")        Обстоят  = rs.t_value;       end;
          if( rs.t_name =="БИК")            БИК  = rs.t_value;           end;
          if( rs.t_name =="НаимКО")         НаимКО  = rs.t_value;        end;
          if( rs.t_name =="НомФ")           НомФ  = rs.t_value;          end;
          if( rs.t_name =="СумВзыск")       СумВзыск  = rs.t_value;      end;
          if( rs.t_name =="НомРешВзыск")    НомРешВзыск  = rs.t_value;   end;
          if( rs.t_name =="ДатаРешВзыск")   ДатаРешВзыск  = rs.t_value;  end;
          if( rs.t_name =="КласЧинРук")     КласЧинРук  = rs.t_value;    end;
          if( rs.t_name =="ФИОРук")         ФИОРук  = rs.t_value;        end;
          if( rs.t_name =="ДолжРук")        ДолжРук  = rs.t_value;       end;
          if( rs.t_name =="НомСч")          НомСч[НомСч.size] = rs.t_value; end;
          if( rs.t_name =="ВидСч")          ВидСч[ВидСч.size] = rs.t_value; end;
        end;
         
        FileName = ПолучитьИмяВходФайла( reqid );
        //GetClientId();     
     end;
   end;

   macro compareName(namefns,namersb)
    
     //Lavrenov: ну что за криворукость то такая?
     // Второй параметр кто будет к верхнему регистру приводить?
     // Е на Ё зачем менять? - по прозьбе Николаевой Ж.
     
     
     const OOO = "ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ";
     const ZAO = "ЗАКРЫТОЕ АКЦИОНЕРНОЕ ОБЩЕСТВО";
     const OAO = "ОТКРЫТОЕ АКЦИОНЕРНОЕ ОБЩЕСТВО";
     
     namersb = strupr(namersb); 
     namersb = strsubst(namersb,"ООО",OOO);
     namersb = strsubst(namersb,"ЗАО",ZAO);
     namersb = strsubst(namersb,"ОАО",OAO);
     namersb = strsubst(namersb,"Ё","Е");
     namersb = strsubst(namersb,"\"","");
     namersb = strsubst(namersb,"  "," ");

     namefns = strupr(namefns); 
     namefns = strsubst(namefns,"ООО",OOO);
     namefns = strsubst(namefns,"ЗАО",ZAO);
     namefns = strsubst(namefns,"ОАО",OAO);
     namefns = strsubst(namefns,"Ё","Е");
     namefns = strsubst(namefns,"\"",""); 
     namefns = strsubst(namefns,"  "," ");
     return (namefns == namersb);

   end;

   // 19.04.2013 Golovkin C-19181 Обработка претензий по закрытым счетам
   macro check_for_BOS

       record Acc( account );
       var СчетаПоЗапросу, str, cmd;
       var cnt, nameNP, acc_err;
       var accnt_err_35 = TArray();

       if( НаимНП == "" ) nameNP = ФИОИП ;
       else               nameNP = НаимНП;
       end;

       if( НомСч.Size > 0 )

           ErrorMes = "";
           СчетаПоЗапросу = getRsWlacclnk( reqid, 505 );

           while( СчетаПоЗапросу and СчетаПоЗапросу.MoveNext() )

               acc_err = 0;               
               // берем успешно обработанные счета
               if( СчетаПоЗапросу.value("t_state") == 100 )
                   ПолучитьСчет( СчетаПоЗапросу.value("t_FIID"), СчетаПоЗапросу.value("t_Account"), Acc ); /*zmp 08.04.2014 вынес ниже*/
                   // если счет закрыт
                   if( acc.open_close == "З" )
                       // устанавливаем статус 35, чтобы по нему не сформировалась справка
                       str = " UPDATE   dwlacclnk_dbt          " + 
                             "    SET   t_state = 35           " +
                             "  WHERE       t_objecttype = 505 " +
                             "          AND t_objectid   =     " + reqid                             + 
                             "          AND t_account    =    '" + СчетаПоЗапросу.value("t_Account") + "'";

                       cmd = RsdCommand(str);
                       cmd.execute;

                       acc_err = 1;
                       accnt_err_35[accnt_err_35.size] = "Счет " + СчетаПоЗапросу.value("t_Account") + " закрыт " + acc.close_date;
                   end;
               end;

               if(acc_err == 0)
                   ПроверенСчета[ПроверенСчета.size] = СчетаПоЗапросу.value("t_Account");
               end;

           end;

       end;

       // формируем текст ошибки
       if( accnt_err_35.size > 0 )
           Error = 35; 
           cnt   = 0;           

           while( cnt < accnt_err_35.size ) 
               ErrorMes = ErrorMes + accnt_err_35[cnt] + ", ";
               cnt = cnt + 1;
           end;

           ErrorMes = nameNP + " ИНН " + ИНННП + " " + ErrorMes;
       end;

       // откусываем запятую в конце :)
       if( ErrorMes != "" )
           ErrorMes = substr(ErrorMes, 1, strlen(ErrorMes) - 2);
       end;

       // если все счета с ошибкой, то формировать справку не надо
       if( ПроверенСчета.size == 0 )
           DoNotSend = 1;
       end;

   end;

   macro Check(mode)

     var КлиентПоСчету;
     record Acc(account);
     var СчетаПоЗапросу, str, cmd, account;
     var cnt, acc_err, quest, tmpstr, nameNP;
     var accnt_err_32 = TArray(), accnt_err_33 = TArray(), accnt_err_35 = TArray();
     var accnt_err_transit_currency = TArray(); //17.09.13 zmp C-23347-6
     
     if(НаимНП=="")
        nameNP = ФИОИП;
     else
        nameNP = НаимНП;
     end;
     
    //1	Не найден клиент по ИНН	35;В банке (филиале банка) не состоит на обслуживании клиент с ИНН <значение ИНН>, указанным в электронном документе налогового органа
     if( ( PartyID == -1 ) and ( ИНННП != "" ) )
       Error = 35;  
       ErrorMes = "В банке клиент "+nameNP+" ИНН "+ ИНННП +" счетов не имеет";
       DoNotSend = 1;
       return 1;
     end;
     
     КлиентПоСчету = ZNSParty( PartyID );

/*     if (КППНП != "")
         if(( КлиентПоСчету.LegalForm == PTLEGF_INST  ) and (not compareName(НаимНП,КлиентПоСчету.FullName )) and ( КППНП != КлиентПоСчету.KPP )) 
            //2	Не совпадают наименование и КПП	35;Наименование <<значение наименования>> и КПП <<значение КПП>> клиента не соответствуют ИНН <значение ИНН>, указанному в электронном документе налогового органа
            if(mode == 1)//если массовый режим
                Error = 35;  
                ErrorMes = "Наименование клиента и КПП клиента не соответствуют ИНН, указанному в электронном документе налогового органа";
                DoNotProcess = 1;
            else
                gettrue(quest, string("Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||Наименование в запросе:" + НаимНП + "|| наименование в БД:" +КлиентПоСчету.FullName + "|| ИНН/КПП в запросе:" + ИНННП+"/"+КППНП + "|| ИНН/КПП в БД:" +КлиентПоСчету.INN+"/"+КлиентПоСчету.KPP +"|| Сформировать справку?" ));
                if(quest == false)
                   Error = 35;  
//                 ErrorMes = "Наименование клиента и КПП клиента не соответствуют ИНН, указанному в электронном документе налогового органа";
                   /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
                   ErrorMes = String("Наименование клиента ",nameNP," и КПП ",КППНП," клиента не соответствуют ИНН ",ИНННП,", указанному в электронном документе налогового органа");
                end;
            end; 
         elif(( КлиентПоСчету.LegalForm == PTLEGF_INST  ) and ( КППНП != КлиентПоСчету.KPP )) 
            //3	Не  совпадает КПП	35;КПП <значение КПП> клиента не соответствует ИНН <значение ИНН>, указанному в электронном документе налогового органа
            if(mode == 1)//если массовый режим
                Error = 35;  
                ErrorMes = "КПП клиента не соответствует ИНН, указанному в электронном документе налогового органа";
                DoNotProcess = 1;
            else
                gettrue(quest, string("Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||ИНН/КПП в запросе:" + ИНННП+"/"+КППНП + "|| ИНН/КПП в БД:" +КлиентПоСчету.INN+"/"+КлиентПоСчету.KPP + "|| Сформировать справку?" ));
                if(quest == false)
                   Error = 35;  
//                 ErrorMes = "КПП клиента не соответствует ИНН, указанному в электронном документе налогового органа";
                   /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
                   ErrorMes = String("КПП "+КППНП+" клиента не соответствует ИНН ",ИНННП,", указанному в электронном документе налогового органа");
                end;
            end; 
         end;
     end;
     
     if(( Error != 0 ) or ( ErrorMes != "" )) 
        DoNotSend = 1; 
        return 1;
     end;
*/     
     // 17.04.2013 Golovkin C-18326 убрал проверку на соответствие КПП
     if (КППНП != "")
        if(( КлиентПоСчету.LegalForm == PTLEGF_INST ) and ( КлиентПоСчету.KPP == "" ))
            if(mode == 1)                
                Error = 35;  
                ErrorMes = "КПП клиента не соответствует ИНН, указанному в электронном документе налогового органа";
                DoNotProcess = 1;
            else
                gettrue(quest, string("Запрос " + ОтрезатьПутьОтИмениФайла( FileName ) + " ||ИНН/КПП в запросе:" + ИНННП + "/" + КППНП + "|| ИНН/КПП в БД:" +КлиентПоСчету.INN + "/" + КлиентПоСчету.KPP + "|| Сформировать справку?" ));
                if(quest == false)
                    Error = 35;
                    ErrorMes = "КПП " + КППНП + " клиента не соответствует ИНН " + ИНННП + ", указанному в электронном документе налогового органа";
                end;
            end;
        end;
     end;
          
     if(( Error != 0 ) or ( ErrorMes != "" )) 
        DoNotSend = 1; 
        return 1;
     end;

     if ( ( КлиентПоСчету.LegalForm == PTLEGF_INST  ) and ( not compareName(НаимНП,КлиентПоСчету.FullName )) )
       //4	Не совпадает наименование	35;Наименование клиента <<значение наименования>> не соответствует ИНН <значение ИНН>, указанному в электронном документе налогового органа 
        if(mode == 1)//если массовый режим
            Error = 35;  
            ErrorMes = "Наименование клиента не соответствуют ИНН, указанному в электронном документе налогового органа";
            DoNotProcess = 1;
        else
            gettrue(quest, string("Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||Наименование в запросе:" + НаимНП + "|| наименование в БД:" +КлиентПоСчету.FullName +"|| Сформировать справку?" ));
            if(quest == false)
              Error = 35;  
//            ErrorMes = "Наименование клиента не соответствуют ИНН, указанному в электронном документе налогового органа";
              /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
              ErrorMes = String("Наименование клиента ",nameNP," не соответствуют ИНН ",ИНННП,", указанному в электронном документе налогового органа");
            end;
        end;
     elif ( ( КлиентПоСчету.LegalForm == PTLEGF_PERSN ) and (not compareName(ФИОИП,КлиентПоСчету.FullName )) )    
       //4	Не совпадает наименование	35;Наименование клиента <<значение наименования>> не соответствует ИНН <значение ИНН>, указанному в электронном документе налогового органа 
        if(mode == 1)//если массовый режим
            Error = 35;  
            ErrorMes = "Наименование клиента не соответствуют ИНН, указанному в электронном документе налогового органа";
            DoNotProcess = 1;
        else
            gettrue(quest, string("Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||Наименование в запросе:" + ФИОИП + "|| наименование в БД:" +КлиентПоСчету.FullName +"|| Сформировать справку?" ));
            if(quest == false)
              Error = 35;  
//            ErrorMes = "Наименование клиента не соответствуют ИНН, указанному в электронном документе налогового органа";
              /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
              ErrorMes = String("Наименование клиента ",nameNP," не соответствуют ИНН ",ИНННП,", указанному в электронном документе налогового органа");
            end;
        end;
     end;
     
     if(( Error != 0 ) or ( ErrorMes != "" )) 
        DoNotSend = 1; 
        return 1;
     end;

     if(НомСч.Size > 0)
        ErrorMes = "";
        СчетаПоЗапросу = getRsWlacclnk(reqid, 505);
        while(СчетаПоЗапросу and СчетаПоЗапросу.MoveNext() )
           acc_err = 0;
           if (AccountExists_RUR(СчетаПоЗапросу.value("t_Account"),СчетаПоЗапросу.value("t_Chapter")))          
              ПолучитьСчет( СчетаПоЗапросу.value("t_FIID"), СчетаПоЗапросу.value("t_Account"), Acc );
              account = RSL_Account(Acc.account,Acc.code_currency); 
              if(acc.client != PartyID)
                 //счет не принадлежит клиенту
                if(mode == 1)//если массовый режим
                    accnt_err_33[accnt_err_33.size] = СчетаПоЗапросу.value("t_Account");
                    acc_err = 1;
                    DoNotProcess = 1;
                else    
                    gettrue(quest, string("Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||Счет: " + СчетаПоЗапросу.value("t_Account") + "|| не принадлежит клиенту:" +КлиентПоСчету.FullName +"|| Сформировать справку?" ));
                    if(quest == false)
                      str = " update dwlacclnk_dbt t " + 
                            "    set t_state = 33 " +
                            "  where T_OBJECTTYPE = 505 " +
                            "    and T_OBJECTID = " + reqid + 
                            "    and t_account = '" + СчетаПоЗапросу.value("t_Account") + "'";

                      cmd = RsdCommand(str);
                      cmd.execute;
                   
                      accnt_err_33[accnt_err_33.size] = СчетаПоЗапросу.value("t_Account");
                      acc_err = 1;
                    end;
                end;
              elif(is_transit_account(acc)) //17.09.13 zmp C-23347-6                   
                 accnt_err_transit_currency[accnt_err_transit_currency.size()] = acc.account;
                 UpdateAccLnkSate(acc.account, 40);  
                 acc_err = 1;
              else
                 /*29.06.12 Golovkin R-64474 Сообщение по специальному карточному счету*/
                 //Gurin S. 27.03.2013 R-171499-2 для ГЕБа проверяем на D
                 //zmp 16.06.2014 проверка на СКС вынесена отдельно в ф-цию.
                 //zmp 11.08.2014 R-427187-2 убраны проверки из elif, сделано через if, для того чтобы все проверки выполнялись
                 if(is_SKS(acc, account))
                    if(mode == 1)
                       ErrorMes = String("Решение ",ОтрезатьПутьОтИмениФайла(FileName)," по СКС  ");
                       DoNotProcess = 1;
                    else
                       gettrue( quest, String("Решение ",ОтрезатьПутьОтИмениФайла(FileName)," по СКС. Формировать справку?") );
                       if(quest == false)
                          DoNotSend = 1;
                          DoNotProcess = 1;
                       end;
                    end;                 
                 end;

                 //Gurin S. 21.05.2013 R-192203-2
                 if(((account.check_type_account("О")) and fgBank.is_GEB) and (DoNotProcess != 1)) 
                   if(mode == 1)
                      ErrorMes = String("Решение ",ОтрезатьПутьОтИмениФайла(FileName)," по счету овердрафт");
                      DoNotProcess = 1;
                   else
                      gettrue( quest, String("Решение ",ОтрезатьПутьОтИмениФайла(FileName)," по счету овердрафт. Формировать справку?") );
                      if(quest == false)
                         DoNotSend = 1;
                         DoNotProcess = 1;
                      end;
                   end;
                 end;

                 if(acc.open_close == "З" )
                    //счет закрыт
                    if(mode == 1)//если массовый режим
                       accnt_err_35[accnt_err_35.size] = "Счет "+ СчетаПоЗапросу.value("t_Account") +" закрыт "+ acc.close_date;
                       acc_err = 1;
                       DoNotProcess = 1;
                    else    
                       gettrue(quest, string("Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||Счет: " + СчетаПоЗапросу.value("t_Account") + "|| закрыт. || Сформировать справку?" ));
                       if(quest == false)
                           str = " update dwlacclnk_dbt t " + 
                                   "    set t_state = 35 " +
                                   "  where T_OBJECTTYPE = 505 " +
                                   "    and T_OBJECTID = " + reqid + 
                                   "    and t_account = '" + СчетаПоЗапросу.value("t_Account") + "'";

                           cmd = RsdCommand(str);
                           cmd.execute;
                     
                           accnt_err_35[accnt_err_35.size] = "Счет "+ СчетаПоЗапросу.value("t_Account") +" закрыт "+ acc.close_date;
                           acc_err = 1;
                       end;
                    end;
                 end;
              end;
              /*31.07.12 Golovkin C-12937*/
              cmd = RsdRecordSet(" select t_account from daccounts_view where t_account = '" + Acc.Account + "' and instr(t_type_account, 'П') = 0 and instr(t_usertypeaccount, '<') <> 0 ");
              if( cmd.movenext() and ( (DoNotSend != 1) or (DoNotProcess != 1) ) )
                 if(mode == 1)
                    ErrorMes = String("Решение ",ОтрезатьПутьОтИмениФайла(FileName)," по счету("+Acc.Account+") клиента, находящегося в стадии процедуры конкурсного производства  ");
                    DoNotProcess = 1;
                 else
                    gettrue( quest, String("Решение ",ОтрезатьПутьОтИмениФайла(FileName)," по счету("+Acc.Account+") клиента, находящегося в стадии процедуры конкурсного производства. Формировать справку?") );
                    if(quest == false)
                        /*09.08.2012 Golovkin I-00233470 если "НЕТ" то формируем ответ PB2*/
                        Error = 35;
                        ErrorMes = "Клиент "+nameNP+" ИНН "+ИНННП+" конкурсное производство";
                        DoNotSend = 1; 
                        return 1;
                    end;
                 end;
              end;
           else
              //счет не найден
              if(DoNotProcess != 1)
                 str = " update dwlacclnk_dbt t " + 
                        "    set t_state = 32 " +
                        "  where T_OBJECTTYPE = 505 " +
                        "    and T_OBJECTID = " + reqid + 
                        "    and t_account = '" + СчетаПоЗапросу.value("t_Account") + "'";

                 cmd = RsdCommand(str);
                 cmd.execute;
              end;
                      
              accnt_err_32[accnt_err_32.size] = СчетаПоЗапросу.value("t_Account");
              acc_err = 1;
           end;      
           if(acc_err != 1)
               ПроверенСчета[ПроверенСчета.size] = СчетаПоЗапросу.value("t_Account");
           end;
        end;
        /*Обозначим строку*/
        tmpstr = "";
        debugbreak;
        //Формируем строку сообщения 
        if(accnt_err_32.size == НомСч.Size)
           cnt = 0;
           error = 32;
           ErrorMes = "В банке (филиале банка) отсутствует номер счета (номера счетов) ";
           while(cnt<accnt_err_32.size)
              ErrorMes = ErrorMes + accnt_err_32[cnt]+", ";
              cnt = cnt+1;
           end;
           /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
           ErrorMes = ErrorMes + String(" ",nameNP," ИНН ",ИНННП) + ", ";
        elif(accnt_err_33.size == НомСч.Size)
           cnt = 0;
           error = 33;
           /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
           ErrorMes = "Наименование клиента "+String(nameNP," ИНН ",ИНННП)+" не соответствует номеру счета (номерам счетов) ";
           while(cnt<accnt_err_33.size)
              ErrorMes = ErrorMes + accnt_err_33[cnt]+", ";
              cnt = cnt+1;
           end;
        else
           cnt = 0;
           if (accnt_err_32.size > 0)
             //Lavrenov: 25.06.2012 I-00212290-1 теперь все счета попадают в сообщение
             ErrorMes = "В банке (филиале банка) отсутствует номер счета (номера счетов) ";
             while(cnt<accnt_err_32.size)
                ErrorMes = ErrorMes + accnt_err_32[cnt]+", ";
                cnt = cnt+1;
             end;
              
             ErrorMes = substr(ErrorMes,1,strlen(ErrorMes)-2);
             if (ФИОИП != "")
                ErrorMes = ErrorMes + " " +ФИОИП+ " ИНН "+ИНННП+"  ";
             else
                ErrorMes = ErrorMes + " " +НаимНП+ " ИНН "+ИНННП+"  ";
             end;
             error = 35;
           end;
           cnt = 0;
           while(cnt<accnt_err_33.size)
              /*Golovkin 11.07.2012 I-00202250 Ссылки на наименование и ИНН клиента в PB2*/
//            ErrorMes = ErrorMes +"Наименование клиента не соответствует номеру счета "+ accnt_err_33[cnt]+", ";
              ErrorMes = ErrorMes + String("Счет ",accnt_err_33[cnt]," не принадлежит ",nameNP," ИНН ",ИНННП) + ", ";
              cnt = cnt+1;
              error = 35;
           end;
           if (accnt_err_35.size > 0)
             cnt = 0;
             while(cnt<accnt_err_35.size)
                tmpstr = tmpstr + accnt_err_35[cnt]+", ";
                cnt = cnt+1;
             end;
              ErrorMes = ErrorMes+" "+nameNP+" ИНН "+ИНННП+" "+tmpstr;
              error = 35;
           end;
           //17.09.13 zmp C-23347-6
           if(accnt_err_transit_currency.size() > 0)
              ErrorMes = ErrorMes + String(" Счет ", array_to_str(accnt_err_transit_currency, ", ") ," является транзитным валютным счетом и НК РФ не предусмотрено приостановление операций по счетам налогоплательщиков в банках, которые не определены п. 2 ст. 11 НК РФ, в том числе по транзитным валютным счетам  ");
              error = 35;                   
           end;
           
        end;

        if(ПроверенСчета.size == 0)
           DoNotSend = 1; 
        end;

        if ( ErrorMes != "" )
           ErrorMes = substr(ErrorMes, 1, strlen(ErrorMes)-2);
        end;
     end;
     return IfThenElse( ( Error != 0 ) or ( ErrorMes != "" ), 1, 0 ); 
   end;

   
   macro CreateAcClaim(Acc)
      record rate (ratedef);
      var str, cmd, cmd_acclnk, rate_with_point, SumClaim, НаименованиеПричины, v_FIID;
      debugbreak;
      //Lavrenov: 08.06.2012 I-00206328-1 данные в НаимПрич перезаписывались после валютных счетов. Исправил.
      НаименованиеПричины = НаимПрич;
      //Lavrenov: 08.06.2012 зачем 100 раз вызывать Get_Fiid?
      v_FIID = Get_Fiid(acc);
      /*25.05.12 Golovkin C-11297*/
      if( v_FIID != 0 )
        if( (СумВзыск != "") or (СумВзыск != $0) )
          ПолучитьКурс(rate, 0, v_FIID, 7);
          ПолучитьЗначениеКурса(rate, {curdate});
          rate_with_point = rate.rate/pow(10, rate.point);
          НаименованиеПричины = String( "Сумма ", СумВзыск, " по курсу ", rate_with_point, " на ", {curdate} );
          if( ConvSum(SumClaim, Money(СумВзыск), {curdate}, 0, v_FIID, 7 ) != 0 )    
            MsgBox("Не удалось сконвертировать сумму ареста");
            return 1;
          end;
        end;
      else
      SumClaim = СумВзыск; 
      end;

      cmd = RsdCommand("{ ? = call rsi_rsb_acclaim.insertacclaim(?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?) } ");
      
      cmd.AddParam("error",          RSDBP_OUT,  V_INTEGER);
      cmd.AddParam("claimid",        RSDBP_OUT,  V_INTEGER);
      cmd.AddParam("Chapter",        RSDBP_IN,   1);
      cmd.AddParam("Account",        RSDBP_IN,   acc);
      cmd.AddParam("FIID",           RSDBP_IN,   v_FIID);
      cmd.AddParam("ClaimKind",      RSDBP_IN,   1);
      /*17.05.12 Chesnokov D.S. I-00195062*/
      if ((СумВзыск == "") or (СумВзыск == $0))
        cmd.AddParam("RestKind",       RSDBP_IN,   2);//ставим частичный арест
        SumClaim = $0;
      else
        cmd.AddParam("RestKind",       RSDBP_IN,   3);
      end;
      /*End 17.05.12 Chesnokov D.S. I-00195062*/
      cmd.AddParam("Initiator",      RSDBP_IN,   1);
      cmd.AddParam("DocNumber",      RSDBP_IN,   НомРешПр);
      cmd.AddParam("DocDate",        RSDBP_IN,   date(ДатаРешПр) );
      cmd.AddParam("SysDate",        RSDBP_IN,   {curdate});
      
      cmd.AddParam("StartDate",      RSDBP_IN,   {curdate});
      cmd.AddParam("FinishDate",     RSDBP_IN,   date(0,0,0));
      cmd.AddParam("StartAmount ",   RSDBP_IN,   SumClaim); /*30.05.2012 Golovkin C-11297*/
      cmd.AddParam("Priority",       RSDBP_IN,   3/*4*/);//TAM 13.12.13 C-25730
      
//      cmd.AddParam("Comment",        RSDBP_IN,   substr(string("ЭЛЕКТРОННЫЙ ДОКУМЕНТ. "+НаимПрич),1,140));
      cmd.AddParam("Comment",        RSDBP_IN,   substr(string(ОтрезатьПутьОтИмениФайла(FileName) + " " + НаименованиеПричины),1,140));
      
      cmd.AddParam("ContrnVersion",  RSDBP_IN,   0);
      cmd.AddParam("Oper",           RSDBP_IN,   {oper});
      cmd.AddParam("Incremental",    RSDBP_IN,   "X");
      cmd.Addparam("Auto",           RSDBP_IN,   "X");
      cmd.AddParam("Claim_Cancel",   RSDBP_IN,   0);
      
      cmd.AddParam("State",          RSDBP_IN,   1);
      cmd.AddParam("StateID",        RSDBP_OUT,  V_INTEGER);
      cmd.AddParam("FiscOrgCode",    RSDBP_IN,   int(КодНО));
      
      debugbreak;
      cmd.NullConversion = true;// что бы проходила дата 0,0,0
      cmd.execute();
      if (cmd.Param("error").value != 0)
          str = " update t_state = 50 " +
                "  where T_OBJECTTYPE = 505 " +
                "    and T_OBJECTID = " + reqid + 
                "    and t_account = '" + acc + "'";

          cmd_acclnk = RsdCommand(str);
          cmd_acclnk.execute;
          return 1;
      else
          ClaimID[ClaimID.size] = cmd.Param("claimid").value;

          str = " update dwlacclnk_dbt t " + 
                "    set T_LNKOBJECTTYPE = 455, " +
                "        T_LNKOBJECTID  = " + cmd.Param("claimid").value + ", " +
                "        t_state = 100 " +
                "  where T_OBJECTTYPE = 505 " +
                "    and T_OBJECTID = " + reqid + 
                "    and t_account = '" + acc + "'";

          cmd_acclnk = RsdCommand(str);
          cmd_acclnk.execute;
          //Gurin S. 20.06.2013 C-17880-6
          if ((cmd.value("RestKind") == 2) and ((fgBank.is_EXV) or (fgBank.is_VUZ) or (fgBank.is_GEB) or (fgBank.is_SLD)) )
              execmacrofile("autoKOR.mac", "TransferInKORFromK2", Acc);
          end;
          return 0;
      end;
   end;

  macro RegisterClaims()
    var cmd, rs, str, ref, i, Initiator_text="";
    i = 0;
    /*17.05.2012 Chesnokov D.S. Сделаем один номер для всех претензий I-00195094*/
      GenerateReference(1000011,ref);
    while (i < ClaimID.size)
      //GenerateReference(1000011,ref); // I-00195094

      /*07.06.2012 Golovkin I-00196876*/      	

      /*
      str = "SELECT party.t_name  " +
            "  FROM dobjrgdoc_dbt reg, dparty_dbt party, daccount_dbt acc, dacclaim_dbt  acl " +
            " WHERE reg.t_regdockind = 14 AND reg.t_objecttype = 3  " +
            "   AND reg.t_objectid = acc.t_client AND acc.t_account = ACL.T_ACCOUNT  " +
            "   AND acc.t_chapter = ACL.T_CHAPTER AND party.t_partyid = reg.t_regpartyid " +
            "   and ACL.T_CLAIMID = ? "; 
            
      cmd = rsdcommand(str);
      cmd.addparam("acc", RSDBP_IN, ClaimID[i]);
      rs = rsdrecordset(cmd);
      if (rs and rs.movenext())
         Initiator_text = rs.value(0);
      else
         Initiator_text = "";
      end;
      */

      cmd = rsdcommand("insert into usr_claim values (?, ?, ?, ?, ?, CHR(88), chr(0), RSBSESSIONDATA.curdate, chr(0), chr(0)) ");
      cmd.addparam("claimid",RSDBP_IN, ClaimID[i]);
      cmd.addparam("SEQ",RSDBP_IN, ref);
      cmd.addparam("Reg_date",RSDBP_IN, {curdate});
      cmd.addparam("Initiator",RSDBP_IN, НаимНО);
      cmd.addparam("Oper",RSDBP_IN, {oper});
      cmd.execute;
      
      //Lavrenov пока информирование уберем ибо не работает
      //sendClaimMails(ClaimID[i]);// KS 28.11.2011 ОТПРАВКА ПИСЕМ-УВЕДОМЛЕНИЙ В LOTUS
      // KS Как так не работаем, а ну-ка проверим...
      sendClaimMails(ClaimID[i]);// KS 03.09.2012 I-00230750 ОТПРАВКА ПИСЕМ-УВЕДОМЛЕНИЙ В LOTUS

      i = i+1;
    end;
    onerror
      RestoreReference(1000011);
  end;
  
  macro CreateAcClaims()
     var text="", quest = false, err;  
     var str, cmd, СчетаПоЗапросу;

     debugbreak;
     Error = 0;
     Errormes = "";
     ClaimID.size = 0;

     if(НомСч.Size > 0)
        СчетаПоЗапросу = getRsWlacclnk(reqid, 505);
        while(СчетаПоЗапросу and СчетаПоЗапросу.MoveNext() )
           if(СчетаПоЗапросу.value("t_State") == 0 ) 
              err = CreateAcClaim(СчетаПоЗапросу.value("t_Account"));
              if(err == 1)        
                 ОшибочнСчета[ОшибочнСчета.size] = СчетаПоЗапросу.value("t_Account");
                 Error = 1;
              end;
           end;
        end;
     end;

     if(Error == 1)
       Errormes = "Не сформированы претензии по следующим счетам: "+ array_to_str(ОшибочнСчета, ", ");//array_to_str(НомСч, ", "); //

       gettrue(quest, "Запрос "+ОтрезатьПутьОтИмениФайла(FileName)+" ||"+errormes+ "|| Откатить формирование претензий?");
       if(quest)
          text = array_to_str(ClaimID,", ");
          
          str = " delete FROM dacclmcngstate_dbt a WHERE a.t_changedocid IN " +
                " ( SELECT t.t_changedocid FROM dacclmcng_dbt t WHERE t_claimid IN ("+text+")) "; 
          cmd = RsdCommand(str);
          cmd.execute;

          str = "delete FROM dacclmcng_dbt t WHERE t_claimid IN ("+text+")";
          cmd = RsdCommand(str);
          cmd.execute;
          
          str = "delete from dacclaimstate_dbt where t_claimid in ("+text+")";
          cmd = RsdCommand(str);
          cmd.execute;

          str = "delete from dacclaim_dbt where t_claimid in ("+text+")";
          cmd = RsdCommand(str);
          cmd.execute;

          str = " update dwlreq_dbt t set t_queries = '"+errormes+"' where t_reqid = " + reqid;
          cmd = RsdCommand(str);
          cmd.execute;

          str = " update dwlacclnk_dbt t set T_LNKOBJECTTYPE = 0, T_LNKOBJECTID = 0, t_state = 0 where T_LNKOBJECTTYPE = 455 and T_LNKOBJECTID in (" + text +")";
          cmd = RsdCommand(str);
          cmd.execute;
           
          ClaimID.size = 0;
       else
          text = array_to_str(ClaimID,", ");
         
          str = " update dwlreq_dbt t set t_queries = '"+text+"' where t_reqid = " + reqid;
          cmd = RsdCommand(str);
          cmd.execute;
       end;
     else
       text = array_to_str(ClaimID,", ");
      
       str = " update dwlreq_dbt t set t_queries = '"+text+"' where t_reqid = " + reqid;
       cmd = RsdCommand(str);
       cmd.execute;
     end;
  end;

  macro rollback()
  
     var str, cmd, СчетаПоЗапросу, text, quest;
     
     ClaimID.size = 0;
     
     gettrue(quest,"ВНИМАНИЕ! При откате сообщения будет удалена регистрация документа. || Вы хорошо подумали?");
     if(quest)
        if(НомСч.Size > 0)
           СчетаПоЗапросу = getRsWlacclnk(reqid, 505);
           while(СчетаПоЗапросу and СчетаПоЗапросу.MoveNext() )
               if(СчетаПоЗапросу.value("T_STATE") == 100)
                     ClaimID[ClaimID.size] = СчетаПоЗапросу.value("T_LNKOBJECTID");
                     str = "select * from dacclaimstate_dbt where t_claimid = "+СчетаПоЗапросу.value("T_LNKOBJECTID");
                     cmd = trsbdataset(str);
                     if(cmd and cmd.movenext)
                         if(cmd.t_State != 1)
                             msgbox("Претензия была изменена, откатить нельзя! || Предварительно необходимо откатить изменения претензии.");
                             return 1;
                         end;
                     else   
                         msgbox("Невзможно откатить формирование претензии она была изменена! || Предварительно необходимо откатить изменения претензии.");
                         return 1;
                     end;
                     
               end;
           end; 

           if (ClaimID.size != 0)
             text = array_to_str(ClaimID,", ");
              
             str = " delete FROM dacclmcngstate_dbt a WHERE a.t_changedocid IN " +
                   " ( SELECT t.t_changedocid FROM dacclmcng_dbt t WHERE t_claimid IN ("+text+")) "; 
             cmd = RsdCommand(str);
             cmd.execute;

             str = "delete FROM dacclmcng_dbt t WHERE t_claimid IN ("+text+")";
             cmd = RsdCommand(str);
             cmd.execute;
             
             str = "delete from dacclaimstate_dbt where t_claimid in ("+text+")";
             cmd = RsdCommand(str);
             cmd.execute;
             
             str = "delete from dacclaim_dbt t where t_claimid in ("+text+")"; 
             cmd = RsdCommand(str);
             cmd.execute;

             str = "delete from usr_claim t where t_claimid in ("+text+")"; 
             cmd = RsdCommand(str);
             cmd.execute;

           end;   

           СчетаПоЗапросу = getRsWlacclnk(reqid, 505);
           //while(СчетаПоЗапросу and СчетаПоЗапросу.MoveNext() )
           //    КорректировкаСуммПр(СчетаПоЗапросу.value("t_Account"));
           //end;
           
           str = " update dwlacclnk_dbt t set T_LNKOBJECTTYPE = 0, T_LNKOBJECTID = 0, t_state = 0 where T_OBJECTTYPE = 505 and T_OBJECTID = " + reqid;
           cmd = RsdCommand(str);
           cmd.execute;
        end;       
     else
        msgbox("Вот и правильно.");
        return 1;
     end;
     return 0;
  end;

  macro report()
    var str, cmd, СчетаПоЗапросу;
    var TxtPath = "", filename, errCode;
    var statetxt, nameNO, nameCL;
    
    filename = strsubst(string(date),".","")+strsubst(string(time),":","")+{oper}+".txt";

    GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, TxtPath, errCode);
    if ( errCode > 0 )
       msgbox("Ошибка при определении директории TxtFile");
       return 1;
    else
       TxtPath = substr(GetCurDir(false),1,index(StrUpr(GetCurDir(false)),"\\OBJ")) + substr(TxtPath,4)+"\\"+filename;
    end;
    
    removefile(TxtPath);
    setoutput (TxtPath,true);
    
    [                         Протокол процедуры обработки решений регистрационных органов 
     
     Дата отчета: #
     Исполнитель: ##### #
     Решения о приостановлении операций по счетам
     
    ┌───────────┬──────────┬──────────────────────────────────────────────────┬────────────────────────────────────────┬───────────────────────┬──────────────────────┬────────────────────┬───────────────────────────────────────────────────┐
    │  Номер    │ Дата реш.│  Наим. нал. органа (код), исполнитель и телефон  │     Наименование клиента(Юр.лица)      │     ИНН/КПП клиента   │      Номер счета     │       Сумма        │                   Примечание                      │
    │ решения   │          │                                                  │               Ф.И.О. ИП                │                       │                      │                    │                                                   │
    ├───────────┼──────────┼──────────────────────────────────────────────────┼────────────────────────────────────────┼───────────────────────┼──────────────────────┼────────────────────┼───────────────────────────────────────────────────┤]
    ({curdate}, {oper}, {name_oper});
    nameNO = string(НаимНО+" ("+КодНО+"). исп. "+ФамОтпр+" тел. "+ ТелОтпр);
    if(НаимНП == "")
       nameCL = ФИОИП;
    else
       nameCL = НаимНП;
    end;

    if(НомСч.Size > 0)
    debugbreak;
       СчетаПоЗапросу = getRsWlacclnk(reqid, 505);
       while(СчетаПоЗапросу and СчетаПоЗапросу.MoveNext() )
          if(СчетаПоЗапросу.value("T_STATE") == 100)
             statetxt = "По счету создана претензия"; 
          elif(СчетаПоЗапросу.value("T_STATE") == 32)
             statetxt = "В банке (филиале банка) отсутствует номер счета "; 
          elif(СчетаПоЗапросу.value("T_STATE") == 33)
             statetxt = "Счет не принадлежит клиенту"; 
          elif(СчетаПоЗапросу.value("T_STATE") == 35)
             statetxt = "Счет закрыт "; 
          elif(СчетаПоЗапросу.value("T_STATE") == 40)
             statetxt = "Транзитный валютный счет";    
          elif(СчетаПоЗапросу.value("T_STATE") == 50)
             statetxt = "При создании претензии возникли ошибки"; 
          elif(СчетаПоЗапросу.value("T_STATE") == 0)
             statetxt = "Счет не обрабатывался"; 
          else
             statetxt = "Неопознанная ошибка "+ СчетаПоЗапросу.value("T_STATE"); 
          end;
	  [│ ######### │##########│ ################################################ │ ###################################### │ ##################### │ #################### │ ################## │ ################################################# │]
          (НомРешПр, ДатаРешПр, nameNO:w, nameCL:w, string(ИНННП+"/"+КППНП), СчетаПоЗапросу.value("T_account"), СумВзыск, statetxt:w  );
       end;
    end;        
     
    [└───────────┴──────────┴──────────────────────────────────────────────────┴────────────────────────────────────────┴───────────────────────┴──────────────────────┴────────────────────┴───────────────────────────────────────────────────┘


      Созданные ответы:
     ┌─────────────────┬─────────┬──────────────────────┬────────────────────────────────────────────────────────────────────┐
     │    ID Ответа    │  Форма  │        Статус        │                            Сообщение                               │
     │                 │         │                      │                                                                    │
     ├─────────────────┼─────────┼──────────────────────┼────────────────────────────────────────────────────────────────────┤];



    str = " SELECT t.*, (SELECT t_name FROM dwlstatus_dbt WHERE t_typestate = 4 AND t_state = t.t_state) t_status "+ 
          "   FROM dwlreq_dbt t WHERE t.t_kind  = 6 and t.t_relatedref = '"+reqid+"' order by t_ReqID " ;

    cmd = trsbdataset(str);
    
    while(cmd and cmd.movenext)
   [│ ############### │ ####### │ #################### │ ################################################################## │]
   (cmd.t_reqid, ПолучитьИмяФормы(cmd.t_ReqID):c, cmd.t_status:c, cmd.t_queries:w );
    
    end;

   [└─────────────────┴─────────┴──────────────────────┴────────────────────────────────────────────────────────────────────┘];
     
    setoutput (null,true);
    viewfile(TxtPath);
  end;


   MnsMessageFormRPO();

end;




/*  var qqq;
  qqq = MnsMessageFormRPO(592);
//  debugbreak;
 // qqq.Check(); 
 // qqq.CreateAcclaims(); 
  qqq.report;
  //msgbox(qqq.errormes);
*/
