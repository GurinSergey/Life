/*******************************************************************************/
/*  RS-Bank 6.0                                          R-Style Software Lab  */
/*                                                                             */
/*  File Name   : mnspbusr.mac                                                 */
/*  Created     : 08.12.2011                                                   */
/*  Programmer  : Chesnokov D.                                                 */
/*  Description : Пользовательский класс объекта (PB)                          */
/*  Заявка      : C-7026                                                       */
/*******************************************************************************/

import rsbdataset;

class MnsMessageFormPB(m_reqid)

  var reqid = m_reqid;
  //Поля сообщения PB и ERR
  var ИмяВхФайла    = "", // Имя входящего файла
      ТипОтв        = "", // Тип ответа
      ДатаПроверки  = "", // Дата Проверки
      ВремяПроверки = "", // Время проверки
      DoNotProcess = 0,   // Если не 0 то сообщение не обрабатываем, только для массовой обработки
      ОшСооб        = Tarray(); //Ошибки

  macro MnsMessageFormPB
    var  rs, str; 
    
    str =  "   SELECT f.t_name, t.t_value, m.t_mandatoryflag " +
           "     FROM dwlmesval_dbt t, dwlmeslnk_dbt l, dwltpfld_dbt f, dwlmesfld_dbt m " +
           "    WHERE l.t_objkind = 505 " +
           "      AND l.t_objid =  " + reqid +
           "      AND t.t_mesid = l.t_mesid " +
           "      AND t.t_tpfieldid = f.t_tpfieldid " +
           "      AND m.t_fieldid = t.t_fieldid " +
           " ORDER BY t_index " ;
    rs = trsbdataset(str);
    while( rs and rs.movenext )
      if (rs.t_name == "ИмяВхФайла")     ИмяВхФайла          = rs.t_value; end;
      if (rs.t_name == "ТипОтв")         ТипОтв              = rs.t_value; end;
      if (rs.t_name == "ДатаПроверки")   ДатаПроверки        = rs.t_value; end;
      if (rs.t_name == "ВремяПроверки")  ВремяПроверки       = rs.t_value; end;
      if (rs.t_name == "ОшСооб")         ОшСооб[ОшСооб.Size] = rs.t_value; end;
    end;
  end;
  
  MnsMessageFormPB;

end;