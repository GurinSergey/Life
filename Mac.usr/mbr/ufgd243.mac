/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.0                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация запросов по сообщению ED243                                    */
/*                                                                          */
/*  Имя файла: ufgd243.mac                                                  */
/*  Создан:    17.06.11                                  Chukina T.         */
/* Изменен:    10.04.12 Chesnokov D.S. по заявке С-9530 проверка на группу  */
/*             26.03.14 Gurin S. Новый альбом УФЭБС v2.6.0                  */
/****************************************************************************/
/*SDA 06.12.2013 адаптация для 31-й*/
import "ufgendoc.mac", "diver.mac";
import "uf_loader.mac";
debugbreak;
var ver_st = 2;

private macro НайтиКодРежима(strcode: string) :string

  var result = "Неизвестный код режима: " + strcode;
  var rs:object;
  var select:string;
  var params:TArray;

  select = "select t_description from dwlcodes_dbt where t_algnum = 49 and t_code=:code";
  
  params = makeArray( SQLParam("code", strcode));
  rs = execSQLselect( select, params, FALSE );
  if ( rs and rs.MoveNext() )
     result = rs.value(0);
  end;
        
  return result;
end;
debugbreak;
macro GenDoc( addrMes )
  debugbreak;
  if (not ВходитВГруппу({oper},198))
    msgBox("Вы не включены в группу \"198 - Генерация сообщений УФЭБС\"");
    return false;
  end;
debugbreak;
  SetBuff( wlmes, addrMes );
  
  PrintLog(2,"Генерация запроса по ED243");

  ClearRecord(wlreq);
  
  var error = 0, Строка, i = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  
  if( not СчитатьПоле( XMLField, Строка ) )
    return FALSE;
  end;

  if ( not xml.loadXML(Строка) )
    println( string( "Неверный формат сообщения по форме ED243" ) );
    return false;
  end; 

  //Gurin S. Новый альбом УФЭБС, этот функционал самописный у нас пока что
  EDLoader.selfInit(string(wlmes.Trn,".xml"), xml.xml, True);
  
  /*
  /* Заполнение учетных буферов */
  wlreq.Trn                      = wlmes.Trn;
  wlreq.RelatedRef               = wlmes.RelatedRef;
  wlreq.Direct                   = "X";  
  wlreq.Kind                     = MESKIND_REQUEST;
  
  wlreq.OriginatorID             = ToRespID(ReadAttribute(xml,"EDAuthor"));
  wlreq.OriginatorCodeKind       = PTCK_BIC;
  wlreq.OriginatorCode           = ПолучитьКодСубъекта(wlreq.OriginatorID, wlreq.OriginatorCodeKind, Error);

  FILE party(party) key 0;
  party.PartyID = wlreq.OriginatorID;
  if(GetEQ(party))
    wlreq.OriginatorName         = party.Name;
  end;
  
  wlreq.RecipientCode            = {MFO_Bank};
  wlreq.RecipientCodeKind        = PTCK_BIC;
  wlreq.RecipientID              = {OurBank};
  wlreq.RecipientName            = {Name_Bank};
  
  wlreq.InitDateMes              = ToDate(ReadAttribute(xml,"EDDate", "OriginalEPD"));
  wlreq.InitFormIDMes            = НайтиФормуСообщенияПоРеференсу(wlreq.RelatedRef, TRANSP_UFBS);

  // wlreq.Queries -------------------------------------------------
  var EDDefineRequestCode = ReadAttribute(xml,"EDDefineRequestCode");
  wlreq.Queries                  = "/УТ"+EDDefineRequestCode+"/";
  
  var comma = "", MaskPath = "EDDefineRequestInfo/FieldQueryMask";
  if(ReadOptinalAttribute(xml, "Field60", MaskPath))
    wlreq.Queries              = wlreq.Queries + " 60";
    comma = ",";
  end;
  if(ReadOptinalAttribute(xml, "Field61", MaskPath))
    wlreq.Queries              = wlreq.Queries + comma + " 61";
    comma = ",";
  end;
  for (i, 101, 110, 1)
    if(ReadOptinalAttribute(xml, string("Field",i), MaskPath))
      wlreq.Queries            = wlreq.Queries + comma + i;
      comma = ",";
    end;
  end;
  
  var tmpstr = "";
  tmpstr = ReadOptinalAttribute(xml, "AccDocDate", "EDDefineRequestInfo");
  if (tmpstr != "")
    wlreq.Queries                = wlreq.Queries + string("\n", "AccDocDate: ", tmpstr);
  end;
  tmpstr = ReadOptinalAttribute(xml, "AccDocNo", "EDDefineRequestInfo");
  if (tmpstr != "")
    wlreq.Queries                = wlreq.Queries + string("\n", "AccDocNo: ", tmpstr);
  end;
  tmpstr = ReadOptinalAttribute(xml, "Acc", "EDDefineRequestInfo");
  if (tmpstr != "")
    wlreq.Queries                = wlreq.Queries + string("\n", "Acc: ", tmpstr);
  end;
  tmpstr = ReadOptinalAttribute(xml, "Sum", "EDDefineRequestInfo");
  if (tmpstr != "")
    wlreq.Queries                = wlreq.Queries + string("\n", "Sum: ", tmpstr);
  end;
  tmpstr = ReadNodeText(xml, "EDDefineRequestInfo/Name", false);
  if (tmpstr != "")
    wlreq.Queries                = wlreq.Queries + string("\n", "Name: ", tmpstr);
  end;
  // wlreq.Queries -------------------------------------------------
        
  var Description                = НайтиКодРежима("/УТ"+EDDefineRequestCode+"/");


  if( not ВставитьЗапрос( wlreq, Description ) )
    std.msg("Ошибка при вводе запроса");
    return FALSE;
  end;

  */
  return TRUE;

  OnError(er) /* обработка ошибок времени выполнения */
    ExeptionMessage(er);
    return FALSE;
end;