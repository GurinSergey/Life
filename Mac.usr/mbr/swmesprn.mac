/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  ®¤á¨áâ¥¬  "Œ¥¦¡ ­ª®¢áª¨¥ à áç¥âë"                      */
/* ¥ç âì á®®¡é¥­¨© SWIFT                                                   */
/*                                                                          */
/*  ˆ¬ï ä ©« : swmesprn.mac                                                 */
/*  ‘®§¤ ­:    30.05.00                                      €«¥è¨­ €.‚.    */
/****************************************************************************/

import CTInter, "wlglobal.mac", "swparser.mac", "adress.mac", oralib, likepy;

FILE bicdir( ptbicdir ) key 0;
FILE party( party ) key 0;
const PRINT_SHIFT = "                     ";

macro GetllValueName( List, Code, error )
    var rs:object;
    var select:string;
    var params:TArray;

    select = "select t_Name from dllvalues_dbt where t_List=:List and t_Code=:code";
    params = makeArray( SQLParam("List", List),
                        SQLParam("code", code));
    rs = execSQLselect( select, params, FALSE );

    if ( rs.MoveNext() )
       SetParm( 2, 0 );
       return rs.value(0);
    else
       SetParm( 2, 1 );
       return "¥¨§¢¥áâ­ë© ª®¤";
    end;
end;

/* Œ ªà®á à áè¨äà®¢ª¨ ¯®«ï 32 */
macro PrintField32( ¯®«¥:string )
  var datev,name_currency,short_currency,amt;

  datev = YYMMDD2Date(¯®«¥);
  short_currency=SubStr(¯®«¥,7,3);
  ®«ãç¨âì”¨­ˆ­®ISO( short_currency, wlfininstr );
  name_currency = wlfininstr.Name;
  amt=SubStr(¯®«¥,10);
  std.out( 1, PRINT_SHIFT + string(datev:f) );
  std.out( 1, PRINT_SHIFT + name_currency );
  /* EVG 17/04/2011 ‘¤¥« « ¤«ï áã¬¬ë á¤¢¨£ ¯®¬¥­ìè¥.
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + PRINT_SHIFT + amt );*/
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + amt );
end;

/* Œ ªà®á ¯¥ç â¨ ¯®«ï 32B */
macro PrintField32B( ¯®«¥ )
  var name_currency,short_currency,amt;
  short_currency=SubStr( ¯®«¥,1,3);
  ®«ãç¨âì”¨­ˆ­®ISO( short_currency, wlfininstr );
  name_currency = wlfininstr.Name;
  amt=SubStr( ¯®«¥,4);
  [    #](¯®«¥);
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + name_currency );
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + amt );
end;

private macro IsNumber( Number:string )
  if( ((Number >= "0") and (Number <= "9")) or (Number == ".") or (Number == ",") )
    return true;
  else
    return false;
  end;
end;

/* Œ ªà®á ¯¥ç â¨ à áè¨äà®¢ª¨ (¢ «îâ , áã¬¬ ) ¯®«¥© 32H, 34E */
macro PrintFieldCurAmt( ¯®«¥ )
  var name_currency,short_currency,amt;
  if( IsNumber(SubStr(¯®«¥,4,1)) )
    short_currency = SubStr(¯®«¥,1,3);
    amt = SubStr(¯®«¥,4);
  elif( (SubStr(¯®«¥,1,1) == "N") or (SubStr(¯®«¥,1,1) == "n") )
    short_currency = SubStr(¯®«¥,2,3);
    amt = "-" + SubStr(¯®«¥,5);
  else
    short_currency = SubStr(¯®«¥,2,3);
    amt = SubStr(¯®«¥,5);
  end;

  ®«ãç¨âì”¨­ˆ­®ISO( short_currency, wlfininstr );
  name_currency = wlfininstr.Name;
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + name_currency );
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + amt );
end;


/*  á¯¥ç â âì ¬­®£®áâà®ç­®¥ ¯®«¥ */
macro PrintMultiFields( ¯®«¥, LenStr, Numbers );
  var num, count;
  array dest;

   §¡¨âì ‘âà®ª¨( ¯®«¥, dest, LenStr, Numbers );
  num = Asize( dest );
  count=0;
  while( count<num )
    if ( dest(count)!="" ) [    #]( dest(count) ); end;
    count=count+1;
 end;
end;

/* Œ ªà®á ¤«ï ¯¥ç â¨ ¯®«¥© 52, 53, 54, 56, 57, 58 */
macro PrintIns( ¨¬ï, ¯®«¥ )
   record RecordAdress ( adress );
   var count,num, PLUS, ID, error;
   array dest;

   if ( SubStr( ¨¬ï,3,1 )== "A" ) PLUS="- BIC";
   elif ( SubStr( ¨¬ï,3,1 )== "B" ) PLUS="- BRANCH";
   elif ( SubStr( ¨¬ï,3,1 )== "C" ) PLUS="- ACCOUNT";
   elif ( SubStr( ¨¬ï,3,1 )== "D" ) PLUS="- NAME";
   elif ( SubStr( ¨¬ï,3,1 )== "J" ) PLUS="- PARTY IDENTIFICATION";
   else PLUS="";
   end;

   if ( SubStr( ¨¬ï,1,2 )== "52" )
      [###:ORDERING INSTITUTION #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "53" )
      [###:SENDER'S CORRESPONDENT #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "54" )
      [###:RESEIVER'S CORRESPONDENT #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "56" )
      [###:INTERMEDIARY #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "57" )
      [###:ACCOUNT WITH INSTITUTION #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "58" )
      [###:BENEFICIARY INSTITUTION #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "82" )
      [###:PARTY A #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "83" )
      [###:FUND OR INSTRUCTING PARTY #]( ¨¬ï, PLUS );
   elif ( SubStr( ¨¬ï,1,2 )== "87" )
      [###:PARTY B #]( ¨¬ï, PLUS );
   elif ( (SubStr( ¨¬ï,1,2 )== "86") AND PLUS == "" )
      [###:INFORMATION TO ACCOUNT OWNER](¨¬ï);
   elif ( (SubStr( ¨¬ï,1,2 )== "86") AND PLUS != "" )
      [###:INTERMEDIARY2 #]( ¨¬ï, PLUS );
   end;
   
   if( (SubStr( ¨¬ï,1,2 )== "86") AND PLUS == "")
      PrintMultiFields( ¯®«¥, 65, 6 );
   else
      PrintMultiFields( ¯®«¥, 37, 5 );
   end;

   if( SubStr( ¨¬ï,3,1 )== "A" )
      §¡¨âì ‘âà®ª¨( ¯®«¥,dest,37,5);
     if ( SubStr(dest(0),1,1)!="/" ) count=0;
     else count=1; end;

     ID = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ( dest( count ), PTCK_SWIFT, error );
     if( error )
       std.out( 1, PRINT_SHIFT + "BIC NOT FOUND !!!");
     else                                              
       if( ID )
         bicdir.PartyID = ID;
         party.PartyID = ID;
       else
         bicdir.PartyID = {OurBank};
         party.PartyID = {OurBank};
       end;
       if( getEQ( bicdir ))
         std.out( 1, PRINT_SHIFT + bicdir.InstitutionName );
         std.out( 1, PRINT_SHIFT + bicdir.City );
       elif( getEQ( party ) )
         ClearRecord(RecordAdress);
          ©â¨à¨¤¨ç¥áª¨©€¤à¥á‘ã¡ê¥ªâ (party.PartyID,RecordAdress);
         std.out( 1, PRINT_SHIFT + party.Name );
         std.out( 1, PRINT_SHIFT + RecordAdress.Place );
       else
         std.out( 1, PRINT_SHIFT + "BANK NOT FOUND !!!");
       end;
     end;
   end;
end;

/* Œ ªà®á ¤«ï ¯¥ç â¨ ¯®«¥© 60, 62, 64, 65 */
macro PrintField60_62_64_65( ¨¬ï, ¯®«¥ )

   if( SubStr(¨¬ï,1,2) == "60" )
     [###:OPENING BALANCE](¨¬ï);
   elif ( SubStr(¨¬ï,1,2) == "64" )
     [###:CLOSING AVAILABLE BALANCE](¨¬ï);
   elif ( SubStr(¨¬ï,1,2) == "65" )
     [###:FORVARD AVAILABLE BALANCE](¨¬ï);
   else
     [###:CLOSING BALANCE](¨¬ï);
   end;
   [    #](¯®«¥);
   if( SubStr(¯®«¥,1,1)=="D" )
     std.out( 1, PRINT_SHIFT + "DEBIT");
   else
     std.out( 1, PRINT_SHIFT + "CREDIT");
   end;
   PrintField32( SubStr(¯®«¥,2) );
end;

/* ¥ç âì ¯à®¨§¢®«ì­®£® ¯®«ï */
macro PrintOtherField( ¨¬ï, ¯®«¥ )
  FILE wltpfld(wltpfld) key 1;

  wltpfld.TpID = TRANSP_SWIFT;
  wltpfld.Name = ¨¬ï;

  if( GetEQ( wltpfld ) )
    [###:#](¨¬ï, StrUpr(wltpfld.Description ));
    PrintMultiFields( ¯®«¥, wltpfld.LenEdit, wltpfld.NumLines );
  else
    [###:#](¨¬ï, ¯®«¥);
  end;
end;

macro PRINT94B( Qualifier, Scheme, PlaceCode, Narrative )
  var error, PartyID;
  var rs:object;
  var select:string;
  var params:TArray;

  if ( Qualifier=="TRAD" )
     std.out( 1, PRINT_SHIFT + "QUALIFIER - "+Qualifier);
     std.out( 1, PRINT_SHIFT + PlaceCode + " - " + GetllValueName(OBJTYPE_MSGTRDPL,PlaceCode) );
     if ( PlaceCode=="EXCH" )
         PartyID = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ( Narrative, PTCK_MIC, error );
         if ( not error )
            select = "select t_Name from dparty_dbt where t_PartyID=:PartyID";
            params = makeArray( SQLParam("PartyID", PartyID));
            rs = execSQLselect( select, params, FALSE );
            if ( rs.MoveNext() )
               std.out( 1, PRINT_SHIFT + PRINT_SHIFT + rs.value(0) );
            end;
         end;
     end;
  end;
end;

macro Print19A(Qualifier, Sign, Cur, Sum)  
  var name_currency,amt;
  ®«ãç¨âì”¨­ˆ­®ISO( Cur, wlfininstr );
  name_currency = wlfininstr.Name;  
  std.out( 1, PRINT_SHIFT + "QUALIFIER - " + Qualifier );
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + name_currency );
  std.out( 1, PRINT_SHIFT + PRINT_SHIFT + Sum );
end;

macro Print95P(Qualifier, BIC)
  record RecordAdress ( adress );
  var error, PartyID;
  std.out( 1, PRINT_SHIFT + Qualifier + " - " + GetllValueName(OBJTYPE_MSGPARTYTP,Qualifier) );
  PartyID = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ( BIC, PTCK_SWIFT, error );
  if ( not error )
     party.PartyID = PartyID;
     if( getEQ( party ) )
       ClearRecord(RecordAdress);
        ©â¨à¨¤¨ç¥áª¨©€¤à¥á‘ã¡ê¥ªâ (party.PartyID,RecordAdress);
       std.out( 1, PRINT_SHIFT + party.Name );
       std.out( 1, PRINT_SHIFT + RecordAdress.Place );
     else
       std.out( 1, PRINT_SHIFT + "BANK NOT FOUND !!!");
     end;
  else
     std.out( 1, PRINT_SHIFT + "BANK NOT FOUND !!!");
  end;
end;

/* Œ ªà®á ¤«ï ¯¥ç â¨ ¯®«ï */
macro  á¯¥ç â âì®«¥( ¨¬ï, ¯®«¥ )

  /* ----------------- ¥ç âì ¯®«ï 11 (A,R,S) ----------------------- */
  if( (¨¬ï == "11A") OR (¨¬ï == "11R") OR (¨¬ï == "11S") )
    [###:MT AND DATE OF ORIGINAL MESSAGE](¨¬ï);
    PrintMultiFields( ¯®«¥, 10, 3 );
  /* ----------------- ¥ç âì ¯®«ï 12 ------------------------------ */
  elif( ¨¬ï == "12" )
    [###:SUB-MESSAGE TYPE](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 13 ------------------------------ */
  elif( ¨¬ï == "13" )
    [###:DATA/TIME INDICATOR](¨¬ï);
    [    #](¯®«¥);
  elif( ¨¬ï == "19A" )
    [###:PLACE OF TRADE](¨¬ï);
    [    #](¯®«¥);
    Read19A( ¯®«¥, 1, "Print19A" )
  /* ----------------- ¥ç âì ¯®«ï 20 ------------------------------ */
  elif( ¨¬ï == "20" )
    [###:TRANSACTION REFERENCE NUMBER](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 21 ------------------------------ */
  elif( ¨¬ï == "21" )
    [###:RELATED REFERENCE](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 23G ----------------------------- */
  elif ( ¨¬ï == "23G" )
    [###:FUNCTION OF THE MESSAGE](¨¬ï);
    [    #](¯®«¥);
    std.out( 1, PRINT_SHIFT + PRINT_SHIFT + GetllValueName(OBJTYPE_MSGFUN, ¯®«¥));
  /* ----------------- ¥ç âì ¯®«ï 25 ------------------------------ */
  elif( ¨¬ï == "25" )
    [###:ACCOUNT IDENTIFICATION](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 28 («î¡®¥) ---------------------- */
  elif( SubStr(¨¬ï,1,2) == "28" )
    [###:STATMENT NUMBER/SEQUENCE NUMBER](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 30 ------------------------------ */
  elif( ¨¬ï == "30" )
    [###:VALUE DATE](¨¬ï);
    [    ##########](YYMMDD2Date(¯®«¥):f);
  /* ----------------- ¥ç âì ¯®«ï 32A ----------------------------- */
  elif( ¨¬ï == "32A" )
    [###:VALUE DATE, CURRENCY CODE, AMOUNT](¨¬ï);
    [    #](¯®«¥);
    PrintField32( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 32B ----------------------------- */
  elif( ¨¬ï == "32B" )
    [32B:CURRENCY, AMOUNT];
    PrintField32B( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 32 ----------------------------- */
  elif( ¨¬ï == "32C" )
    [###:VALUE DATE, CURRENCY CODE, AMOUNT](¨¬ï);
    [    #](¯®«¥);
    PrintField32( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 32D ----------------------------- */
  elif( ¨¬ï == "32D" )
    [###:VALUE DATE, CURRENCY CODE, AMOUNT](¨¬ï);
    [    #](¯®«¥);
    PrintField32( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 32H ----------------------------- */
  elif( SubStr(¨¬ï,1,3) == "32H" )
    [####:AMOUNT TO BE SETTLED](¨¬ï);
    [     #](¯®«¥);
    PrintFieldCurAmt( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 33B ----------------------------- */
  elif( ¨¬ï == "33B" )
    [33B:CURRENCY, AMOUNT];
    PrintField32B( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 34E ----------------------------- */
  elif( SubStr(¨¬ï,1,3) == "34E" )
    [####:CURRENCY AND INTEREST AMOUNT](¨¬ï);
    [     #](¯®«¥);
    PrintFieldCurAmt( ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 34F ----------------------------- */
  elif( SubStr(¨¬ï,1,3) == "34F" )
    [####:NUMBERS AND SUMM OF ENTRIES](¨¬ï);
    [     #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 50 ------------------------------ */
  elif( ¨¬ï == "50" )
    [###:ORDERING CUSTOMER](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 4 );
  /* ---------- ¥ç âì ¯®«¥© 52, 53, 54, 56, 57, 58, 82, 83, 86, 87----- */
  elif( (SubStr(¨¬ï,1,2) == "52") OR (SubStr(¨¬ï,1,2) == "53") OR
        (SubStr(¨¬ï,1,2) == "54") OR (SubStr(¨¬ï,1,2) == "56") OR
        (SubStr(¨¬ï,1,2) == "57") OR (SubStr(¨¬ï,1,2) == "58") OR
        (SubStr(¨¬ï,1,2) == "82") OR (SubStr(¨¬ï,1,2) == "83") OR
        (SubStr(¨¬ï,1,2) == "86") OR (SubStr(¨¬ï,1,2) == "87") )
    PrintIns( ¨¬ï, ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 59 ------------------------------ */
  elif( ¨¬ï == "59" )
    [###:BENEFICIARY CUSTOMER](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 5 );
  /* ----------------- ¥ç âì ¯®«ï 60 («î¡®¥) ---------------------- */
  elif ( SubStr(¨¬ï,1,2) == "60" )
    PrintField60_62_64_65( ¨¬ï, ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 61 ------------------------------ */
  elif( ¨¬ï == "61" )
    [###:STATEMENT LINE](¨¬ï);
    PrintMultiFields( ¯®«¥, 65, 2 );
  /* ----------------- ¥ç âì ¯®«¥© 62, 64, 65 --------------------- */
  elif ( SubStr(¨¬ï,1,2) == "62" )
    PrintField60_62_64_65( ¨¬ï, ¯®«¥ );
  elif ( SubStr(¨¬ï,1,2) == "64" )
    PrintField60_62_64_65( ¨¬ï, ¯®«¥ );
  elif ( SubStr(¨¬ï,1,2) == "65" )
    PrintField60_62_64_65( ¨¬ï, ¯®«¥ );
  /* ----------------- ¥ç âì ¯®«ï 70 ------------------------------ */
  elif( ¨¬ï == "70" )
    [###:DETAILS OF PAYMENT](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 4 );
   /* ----------------- ¥ç âì ¯®«ï 71A ----------------------------- */
  elif ( ¨¬ï == "71A" )
    [###:DETAILS OF CHARGES](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 71B ------------------------------ */
  elif( ¨¬ï == "71B" )
    [###:DETAILS OF CHARGES](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 6 );
  /* ----------------- ¥ç âì ¯®«ï 72 ------------------------------ */
  elif( ¨¬ï == "72" )
    [###:SENDER TO RECEIVER INFORMATION](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 6 );
  /* ----------------- ¥ç âì ¯®«ï 75 ------------------------------ */
  elif( ¨¬ï == "75" )
    [###:QUERIES](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 6 );
  /* ----------------- ¥ç âì ¯®«ï 76 ------------------------------ */
  elif( ¨¬ï == "76" )
    [###:ANSWERS](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 6 );
   /* ----------------- ¥ç âì ¯®«ï 77E ----------------------------- */
  elif ( ¨¬ï == "77E" )
    [###:PROPRIETARY MESSAGE](¨¬ï);
    PrintMultiFields( ¯®«¥, 78, 125 );
  /* ----------------- ¥ç âì ¯®«ï 77A ------------------------------ */
  elif( ¨¬ï == "77A" )
    [###:NARRATIVE](¨¬ï);
    PrintMultiFields( ¯®«¥, 35, 20 );
  /* ----------------- ¥ç âì ¯®«ï 79 ------------------------------ */
  elif( ¨¬ï == "79" )
    [###:NARRATIVE DESCRIPTION OF THE MESSAGE TO WHICH TRE QUERY RELATES](¨¬ï);
    PrintMultiFields( ¯®«¥, 50, 35 );

  /* ----------------- ¥ç âì ¯®«ï 90 ------------------------------ */
  elif( SubStr(¨¬ï,1,2) == "90" )
    [###:NUMBERS AND SUMM OF ENTRIES](¨¬ï);
    [    #](¯®«¥);
  /* ----------------- ¥ç âì ¯®«ï 94B ------------------------------ */
  elif( ¨¬ï == "94B" )
    [###:PLACE OF TRADE](¨¬ï);
    [    #](¯®«¥);
    Read94B( ¯®«¥, 1, "Print94B" )
  /* ----------------- ¥ç âì ¯®«ï 95P ------------------------------ */
  elif( ¨¬ï == "95P" )
    [###:PARTY](¨¬ï);
    [    #](¯®«¥);
    Read95P( ¯®«¥, 1, "Print95P" )
  /* ----------------- ¥ç âì ¯®«ï MFIELDS -------------------------- */
  elif( ¨¬ï == "MFIELDS" )
    [COPY OF LEAST THE MANDATORY FIELDS OF THE ORIGINAL MESSAGE];
    PrintMultiFields( ¯®«¥, 35, 55 );
  /* ----------------- ‚á¥ ®áâ «ì­ë¥ ¯®«ï ---------------------------- */
  else
    PrintOtherField( ¨¬ï, ¯®«¥ );
  end;

  return TRUE;
end; /* macro  á¯¥ç â âì®«¥ */


/* Œ ªà®á ¯¥ç â¨ § £®«®¢ª  ä®à¬ë */
macro PrintHeader( NumberForm, NameForm, SenderID, ReceiverID, DateMessage )
  record RecordAdress ( adress );
  var CodeBuf, error, InstitutionName, City, Size;

  std.RSBankHeader;
  [Message Type: ####              #]( NumberForm, StrUpr(NameForm) );

  /* â¯à ¢¨â¥«ì á®®¡é¥­¨ï */
  CodeBuf = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ( SenderID, PTCK_SWIFT, error );

  if ( SenderID )
      bicdir.PartyID = SenderID;
      party.PartyID = SenderID;
  else 
      bicdir.PartyID = {OurBank};
      party.PartyID = {OurBank};
  end;

  if( getEQ( bicdir ))
    InstitutionName = bicdir.InstitutionName;
    City = bicdir.City;
  elif( getEQ( party ))
    ClearRecord(RecordAdress);
     ©â¨à¨¤¨ç¥áª¨©€¤à¥á‘ã¡ê¥ªâ (party.PartyID,RecordAdress);
    InstitutionName = party.Name;
    City = RecordAdress.Place;
  else
    InstitutionName = " ";
    City = " ";
  end;
  /* EVG 17/04/2011  áè¨à¨« ¯®«¥ ¢ë¢®¤ .
  [From        :       ########### ###################################
                                   ###################################](CodeBuf,InstitutionName,City);*/
  [From        :       ########### ###############################################
                                   ###############################################](CodeBuf,InstitutionName,City);
  /* ®«ãç â¥«ì á®®¡é¥­¨ï */
  CodeBuf = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ( ReceiverID, PTCK_SWIFT, error );

  if( ReceiverID )
      bicdir.PartyID = ReceiverID;
      party.PartyID = ReceiverID;
  else 
      bicdir.PartyID = {OurBank};
      party.PartyID = {OurBank};
  end;
    
  if( getEQ( bicdir ))
    InstitutionName = bicdir.InstitutionName;
    City = bicdir.City;
  elif( getEQ( party ) )
    ClearRecord(RecordAdress);
     ©â¨à¨¤¨ç¥áª¨©€¤à¥á‘ã¡ê¥ªâ (party.PartyID,RecordAdress);
    InstitutionName = party.Name;
    City = RecordAdress.Place;
  else
    InstitutionName = " ";
    City = " ";
  end;
  /* EVG 17/04/2011  áè¨à¨« ¯®«¥ ¢ë¢®¤ .
  [To          :       ########### ###################################
                                   ###################################](CodeBuf,InstitutionName,City);*/
  [To          :       ########### ###############################################
                                   ###############################################](CodeBuf,InstitutionName,City);
  /* „ â  á®®¡é¥­¨ï */
  [Date of message: ##########](DateMessage:f);
  [______________________________________________________________________________];
  return TRUE;
end;


/* Œ ªà®á ¯¥ç â¨ ä®à¬ */
macro PrintForm( addrMes, MassCopy )
  var field_name, field_value, SenderID, ReceiverID;
  var MsgTmpFileName, OldName;

  SetBuff( wlmes, addrMes );

  FILE rls(wlmesrls) key 0 ;
  FILE form(wlmesfrm) key 0 ;
  FILE MsgTmpFile() txt;

  rls.RlsFormID = wlmes.RlsFormID;
  if(not GetEQ(rls))
    std.msg("è¨¡ª  ¯®¨áª  à¥«¨§  ä®à¬ë á®®¡é¥­¨ï N "+string(wlmes.RlsFormID));
    return FALSE;
  end;

  form.FormID = rls.FormID;
  if(not GetEQ(form))
    std.msg("è¨¡ª  ¯®¨áª  ä®à¬ë á®®¡é¥­¨ï N "+string(rls.FormID));
    return FALSE;
  end;

  if( wlmes.Direct == "X" )   /* ‚å®¤ïé¥¥ á®®¡é¥­¨¥ */
    SenderID = wlmes.OutsideAbonentID;
    ReceiverID = {OurBank};
  else                        /* ˆáå®¤ïé¥¥ á®®¡é¥­¨¥ */
    SenderID = {OurBank};
    ReceiverID = wlmes.OutsideAbonentID;
  end;

 /*¥à¥­ ¯à ¢«ï¥¬ ¢ë¢®¤ á®®¡é¥­¨ï ¢ ä ©«, çâ®¡ë ¯à¨ ¬­®£®ªà â­®© ¯¥ç â¨ ¨á¯®«ì§®¢ âì ¤ ­­ë¥*/
  MsgTmpFileName = GetTxtFileName("tmpmsprn");
  OldName = SetOutPut( MsgTmpFileName );

  if(not open( MsgTmpFile, MsgTmpFileName ) )
    std.msg( String("” ©« ­¥ ®âªàëâ:", "|", MsgTmpFileName) );
    return FALSE;
  end;

  /* ¥ç â ¥¬ § £®«®¢®ª */
  if( not PrintHeader( form.Name, form.Description, SenderID, ReceiverID, wlmes.OutsideAbonentDate ) )
    return FALSE;
  end;

  /* ®á«¥¤®¢ â¥«ì­® áç¨âë¢ ¥¬ ¨ ¯¥ç â ¥¬ ¯®«ï á®®¡é¥­¨ï */
  while( ‘ç¨â âì®«¥( field_name, field_value ) )
    if( not  á¯¥ç â âì®«¥( field_name, field_value ) )
      std.msg( "è¨¡ª  ¯à¨ ¯¥ç â¨ ¯®«ï á®®¡é¥­¨ï" + string(field_name) );
      return FALSE;
    end;
  end;

  /* Š®­¥æ ®âç¥â  */
  std.RSBankFooter;
  println("");

  close(MsgTmpFile);
  SetOutPut( OldName, true );/*¥à¥­ ¯à ¢«ï¥¬ ¢ë¢®¤ ®¡à â­®*/

  while( MassCopy != 0)
    rewind(MsgTmpFile);
    while( next( MsgTmpFile ) )
      println(MsgTmpFile.str);
    end;
    MassCopy = MassCopy - 1;
  end;

  return TRUE;
end;
