/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация выписок по сообщениям УФЭБС ED215                              */
/*                                                                          */
/* Имя файла: ufgd222.mac                                                   */
/* Создан:    06.07.06                                     Гайворонский Е.Г.*/
/* Изменен:   10.04.12 Chesnokov D.S. по заявке С-9530 проверка на группу   */
/****************************************************************************/
import "ufgendoc.mac", "diver.mac";

macro GenDoc( addrMes )

  if (not ВходитВГруппу({oper},198))
    msgBox("Вы не включены в группу \"198 - Генерация сообщений УФЭБС\"");
    return false;
  end;

  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var Строка, Строка2, BIC, CashDocNo, CashDocDate, CashAcc, CashDC, Receiver, Error, InitAuthor;
  var EDDate, Sum, CorrAcc, j = 0;

  SetBuff( wlmes, addrMes );

  PrintLog( 2, "Генерация информационного сообшения по ED215" );

  ClearRecord( wlinfo );

  if( not СчитатьПоле( XMLField, Строка ) )
    return FALSE;
  end;

  if ( not xml.loadXML(Строка) )
     println( string( "Неверный формат сообщения по форме ED215" ) );
     return false;
  end;

  EDDate = ReadAttribute(xml,"EDDate");

  /* Заполнение учетных буферов */
  wlinfo.TRN                = wlmes.Trn;
  wlinfo.OriginatorID       = ToRespID(ReadAttribute(xml,"EDAuthor"));
  wlinfo.OriginatorCodeKind = PTCK_BIC;
  wlinfo.OriginatorCode     = ПолучитьКодСубъекта(wlinfo.OriginatorID, wlinfo.OriginatorCodeKind, Error);
  Receiver = ReadOptinalAttribute(xml,"EDReceiver");
  wlinfo.RecipientCodeKind  = PTCK_BIC;
  if(Receiver)
     wlinfo.RecipientID     = ToRespID(Receiver);
  else
     wlinfo.RecipientID     = {OurBank};
  end;
  wlinfo.RecipientCode      = ПолучитьКодСубъекта(wlinfo.RecipientID, wlinfo.RecipientCodeKind, Error);
  
  BIC         = ReadAttribute(xml,"BIC");
  CashDocNo   = ReadAttribute(xml,"CashDocNo");
  CashDocDate = ReadAttribute(xml,"CashDocDate");
  CashAcc     = ReadAttribute(xml,"CashAcc");
  if( UF_GetDKFlag(ReadAttribute(xml, "CashDC")) == 1)
     CashDC = "дебету";
  else
     CashDC = "кредиту";
  end;

  Sum         = ReadAttribute(xml,"Sum");
  CorrAcc     = ReadAttribute(xml,"CorrAcc");

  Строка2 = "Получено подтверждение от " + BIC +
            " для кассового документа №" + CashDocNo + " за дату:" + CashDocDate +
            "\nпо счету:" + CashAcc + " и корреспондирующим с ним:" + CorrAcc +
            "\nпо " + CashDC + " на сумму:" + String(int(Sum)/100) + " руб."; 

  if( not ВставитьИнфСообщение( wlinfo, Строка2 ) )
    std.msg("Ошибка при вводе ответа");
    return FALSE;
  end;

  return TRUE;

  OnError(er) /* Обработка ошибок времени выполнения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;

end;

macro GenDocV2( addrMes )
   return GenDoc( addrMes );
end;
