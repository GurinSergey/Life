/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : genofkrep.mac
  Created     : 21.12.2012
  Programmer  : Lazarenko M.
  Description : à®â®ª®« ¢ë¯®«­¥­¨ï ¯à®æ¥¤ãàë ä®à¬¨à®¢ ­¨ï á®®¡é¥­¨© ¤«ï ƒˆ‘ ƒŒ

ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import globals, oralib, likepy, WldInter, MesInter, CTInter;

private macro GetOperName( oper:integer ):string

  var fPerson = Tbfile ("person.dbt");
  var Name:string;

  ClearRecord( fPerson.rec );
  fPerson.rec.Oper = Oper;
  if( not fPerson.getEQ () )
    Name = "¥ ­ ©¤¥­ â¥ªãé¨© ¯®«ì§®¢ â¥«ì";
  else
    Name = fPerson.rec.Name;
  end;

  return Name;
end;

private macro GetDepName( dep:string ):string

  var query = " select party.t_Name from dparty_dbt party, ddp_dep_dbt dep " +
              " where party.t_PartyID = dep.t_PartyID " +
              " and dep.t_Code = " + dep;
  var rs:RsdRecordset = execSQLselect(query);
  if (rs and rs.moveNext() )
    return rs.Value(0);
  end;

end;

/*‚ë¢¥áâ¨ § £®«®¢®ª*/
macro PrintHead()

   var operName:string = GetOperName( {oper} );
[
 âç¥â ® à¥§ã«ìâ â å ä®à¬¨à®¢ ­¨ï á®®¡é¥­¨© ¤«ï ƒˆ‘ ƒŒ

 ˆá¯®«­¨â¥«ì #### ##################################################
 „ â  ®âç¥â  ##########

 
]
( {oper}, operName, {curdate} );

end;

/* ‚ë¢¥áâ¨ è ¯ªã â ¡«¨æë ¤«ï ä¨«¨ «  */
macro PrintHeaderTable( dep:string )

  
[ ”¨«¨ « ########## ####################################################################################################
 ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³ N   ³   „ â    ³ID ¤®ª-â  ³ ‘ç¥â ¯« â¥«ìé¨ª         ³        ®«ãç â¥«ì                 ³               ³                    ³                                                  ³   ID     ³ ID ¨­ä.  ³                                                  ³
 ³¤®ª  ³  ¤®ªã¬.  ³          ³                         ÃÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´     ‘ã¬¬      ³        ŠŠ         ³                §­ ç¥­¨¥ ¯« â¥¦                  ³á®®¡é¥­¨ï ³ á®®¡é¥­¨ï³      ¥§ã«ìâ â ®¡à ¡®âª¨                         ³
 ³     ³          ³          ³                         ³   ˆŠ   ³        ‘ç¥â             ³               ³                    ³                                                  ³          ³          ³                                                  ³
 ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( dep, GetDepName( dep ) );
end;  

/* ¯¥ç â âì § £®«®¢®ª ‚‘*/
macro PrintBranch( dep )

[³ ‚‘ ########## ####################################################################################################
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( dep, GetDepName( dep ) ); 
end;

/* ¯¥ç â âì ®âçñâ*/
macro PrintGGReport()
  
  debugbreak();
  var i, j:integer;
  array StringArray;
  var DepPrev:integer = 0;
  var query = "( select ggrep.t_Department as dep, ggrep.t_Branch as br, obj.t_Name, ggrep.t_MesID, rm.t_Number, rm.t_Date,       " 
              "          pm.t_PaymentID, pm.t_PayerAccount, prop.t_BankCode, pm.t_ReceiverAccount,pm.t_BaseAmount, rm.t_BTTTiCode," 
              "          rm.t_Ground, ggrep.t_Result, ggrep.t_ObjectType as tp, ggrep.t_ObjectID as id                            "
              "     from dggrep_tmp ggrep, dobjects_dbt obj, dpmpaym_dbt pm, dpmrmprop_dbt rm, dpmprop_dbt prop                   "
              "       where  ggrep.t_ObjectID = prop.t_PaymentID                                                                  "
              "         and rm.t_PaymentID = pm.t_PaymentID                                   "
              "         and prop.t_PaymentID = pm.t_PaymentID                                 "
              "         and  prop.t_DebetCredit = 1                                                                               "
              "         and ggrep.t_ObjectType = obj.t_ObjectType )                                                               "
              "  union                                                                                                            "
              " ( select ggrep.t_Department as dep, ggrep.t_Branch as br, obj.t_Name, ggrep.t_MesID, chr(1), bdtr.t_Date,         "
              "          bdtr.t_BdTransfID, bdtr.t_PayerAccount, bdtr.t_ReceiverBankCode, bdtr.t_ReceiverAccount, bdtr.t_Amount,  "
              "          bdtr.t_BTTTiCode, bdtr.t_Ground, ggrep.t_Result, ggrep.t_ObjectType as tp, ggrep.t_ObjectID as id        "
              "     from dggrep_tmp ggrep, dobjects_dbt obj, dbdtransf_dbt bdtr                                                   "
              "       where ggrep.t_ObjectID = bdtr.t_BdTransfID                                                                  "
              "         and ggrep.t_ObjectType = obj.t_ObjectType  )                                                              "
              "   order by dep, br, tp, id " ;                                                      
  var rs:RsdRecordset = execSQLselect(query);

  PrintHead();
  i = 1;
  while( (i == 1) and rs and rs.moveNext() )
  
    if( rs.Value(0) != DepPrev )
      PrintHeaderTable( rs.Value(0) );
      DepPrev = rs.Value(0);
    end;
    if( rs.Value(1) != rs.Value(0) )
      PrintBranch( rs.Value(1) );
    end;

    StrSplit( StrSubst(IfThenElse(rs.value(13)!="",rs.value(13)," ") , "|", " " ), StringArray, 50 );

[³#####³##########³###############³##########³#########################³#########³#########################³###############³####################³##################################################³##########³##################################################³
 ]
( rs.Value(4), date(rs.Value(5)), rs.Value(2), int(rs.Value(6)), rs.Value(7), rs.Value(8), rs.Value(9), rs.Value(10), rs.Value(11), rs.Value(12), rs.Value(3), StringArray(0) );

    j = 1;
    while ( StrLen(StringArray(j) ) > 0)
[³     ³          ³               ³          ³                         ³         ³                         ³               ³                    ³                                                  ³          ³##################################################³]
(StringArray(j));
    j = j + 1;
  end;

    i = i + 1;
[ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
]
  end;

end;

macro PrintLine( PaymentID:integer, MesID:integer, InfoID:integer, Result:integer,Errmsg:String )
  
  var resmes:string = "";
  var query = "select rm.t_Number, rm.t_Date, pm.t_PayerAccount, " +
              " prop.t_BankCode, pm.t_ReceiverAccount, pm.t_BaseAmount, " +
              " rm.t_BTTTiCode, rm.t_Ground " +
              "  from dpmpaym_dbt pm, dpmprop_dbt prop, dpmrmprop_dbt rm " +
              " where pm.t_PaymentID = " + PaymentID +
              "   and rm.t_PaymentID = " + PaymentID +
              " and prop.t_PaymentID = " + PaymentID +
              " and prop.t_DebetCredit = 1 " ;
  var rs:RsdRecordset = execSQLselect(query);
  if (rs and rs.moveNext() )
  
  if( Result != 0 )
    resmes = "è¨¡ª  á®§¤ ­¨ï á®®¡é¥­¨ï";
    if (Result==-111) resmes = Errmsg ; end;
  else
    resmes = "‘®®¡é¥­¨¥ ¤«ï ƒˆ‘ ƒŒ áä®à¬¨à®¢ ­® ãá¯¥è­®";
  end;

[³#####³##########³##########³#########################³#########³#########################³###############³####################³##################################################³##########³##########³##################################################³
 ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ]
(rs.Value(0), date(rs.Value(1)), PaymentID, rs.Value(2), rs.Value(3), rs.Value(4), rs.Value(5), rs.Value(6), rs.Value(7), MesID, InfoID, resmes:w );
  end;

end;