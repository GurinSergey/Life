/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщений о логической ошибке по сообщениям УФЭБС ED201        */
/*                                                                          */
/* Имя файла: ufgd201.mac                                                   */
/* Создан:    20.10.04                                             BARS     */
/* Изменен:   10.04.12 Chesnokov D.S. по заявке С-9530 проверка на группу   */
/****************************************************************************/
import "ufgendoc.mac", "cb_sql.mac", rsd, oralib, likepy, "wluftool.mac", "diver.mac";

macro GenDoc( addrMes )

  if (not ВходитВГруппу({oper},198))
    msgBox("Вы не включены в группу \"198 - Генерация сообщений УФЭБС\"");
    return false;
  end;

  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var Error, CtrlCode;
  var Строка;

  SetBuff( wlmes, addrMes );

  PrintLog( 2, "Генерация сообщения о логической ошибке по ED201" );

  if( not СчитатьПоле( XMLField, Строка ) )
    return FALSE;
  end;

  if ( not xml.loadXML(Строка) )
     println( string( "Неверный формат сообщения по форме ED201" ) );
     return false;
  end;

  CtrlCode = int( ReadAttribute(xml, "CtrlCode") );

  var RefTrn = EDNoDateAuthor();
  
  RefTRN.EDNo  = ReadOptinalAttribute(xml, "EDNo", "EDRefID");
  if ( (RefTRN.EDNo!="") and (CtrlCode!=2900) )
     RefTRN.EDDate = ToDate_(ReadAttribute(xml, "EDDate", "EDRefID")); //TAM
     RefTRN.EDAuthor = ReadAttribute(xml, "EDAuthor", "EDRefID");
     return ОбработатьКакED201(RefTRN.EDDate, RefTRN.GetTrn(), CtrlCode);
  else
     return TRUE;
  end;

  OnError(er) /* Обработка ошибок времени выполонения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;

macro GenDocV2( addrMes )
   return GenDoc( addrMes );
end;
