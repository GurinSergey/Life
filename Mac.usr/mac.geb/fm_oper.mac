/* Макрос реестра документов, по которым сформированы операции ФМ            */
/* Изменения:                                                                */
/* 23.04.2012 LAO Зафиксирован оптимальный план с декартовым произведением   */
/* 02.04.2013 joy I-00350638-2 Жаворонкова Н. исправлено для ГЭБа            */

import rsbdataset, globals, ptinter, fiinter, ActX;
 var ЧислоЛистов=1,      
      File_Name="";
 var kol = 0;
 var Код_Ячейки="";
 var Номер_Строки  = 2,  /*с которой начинается заполнение данных*/
     лист = 1;


MACRO GetOprCode(arr, operid, docid, general)
  var rs,str, did, oid;
  if(docid == "")
     did = -1;
  else
     did = docid;
  end;
  if(operid == "")
     oid = -1;
  else
     oid = operid;
  end;
  kol = kol +1;
  str = "SELECT t_nameobject " +
        "  FROM dobjattr_dbt " +
        " WHERE t_objecttype = 700 " +
        "   AND t_groupid = 1 " +
        "   AND t_attrid IN ( " +
        "          SELECT t_attrid " +
        "            FROM dobjatcor_dbt " +
        "           WHERE t_objecttype = 501 " +
        "             AND t_groupid = 11 " +
        "             AND to_number(t_object) = " + did + 
        "             AND t_general = chr("+general+") " +
        "          UNION ALL " +
        "          SELECT t_attrid " +
        "            FROM dobjatcor_dbt " +
        "           WHERE t_objecttype = 700 " +
        "             AND t_groupid = 1 " +
        "             AND to_number(t_object) = " + oid +
        "             AND t_general = chr("+general+")) " ;
  rs = trsbdataset(str);
  while (rs and rs.movenext)
    arr(asize(arr))= rs.t_nameobject;
  end;
  setparm (0,arr);
end;

MACRO GetNeobCode(arr, operid, docid)
  var rs,str, did, oid;
  if(docid == "")
     did = -1;
  else
     did = docid;
  end;
  if(operid == "")
     oid = -1;
  else
     oid = operid;
  end;

  str = "SELECT t_nameobject " +
        "  FROM dobjattr_dbt " +
        " WHERE t_objecttype = 700 " +
        "   AND t_groupid = 2 " +
        "   AND t_attrid IN ( " +
        "          SELECT t_attrid " +
        "            FROM dobjatcor_dbt " +
        "           WHERE t_objecttype = 501 " +
        "             AND t_groupid = 12 " +
        "             AND to_number(t_object) = " + did +
        "          UNION ALL " +
        "          SELECT t_attrid " +
        "            FROM dobjatcor_dbt " +
        "           WHERE t_objecttype = 700 " +
        "             AND t_groupid = 2 " +
        "             AND to_number(t_object) = " + oid+ ")" ;
  rs = trsbdataset(str);
  while (rs and rs.movenext)
    arr(asize(arr))= rs.t_nameobject;
  end;
  setparm (0,arr);
end;


MACRO ArrToStr(arr)
  var i = 0, str="";
  while (i <= asize(arr))
     if(valtype(arr(i)) != 0 )
     str = str + " "+arr(i);
     end;
     i=i+1;
  end;
  return trim(str);
END;

 MACRO Шапка(startdate, enddate)
  var str;
  if(startdate==enddate)
     str = "за "+ startdate +" г.";
  elif(startdate==date("00.00.0000"))
     str =  "за период 00.00.0000 - "+ enddate +" г.";
  else
     str =  "за период "+ startdate +" - "+ enddate +" г.";
  end;


[
                                                                     Реестр документов, включенных в отчет  ОАО "Газэнергобанк"                                                                      
                       в соответствии с Федеральным законом "О противодействии легализации (отмыванию) доходов, полученных преступным путем, и финансированию терроризма" №115-ФЗ                       
                       ##########################################################################################################################################################
                                                                                  
-------T------T-----T----------T------T-------------------T-------------------T----------------------------------------T------------------------------T------------------------------T-----------------┐
│Код ОК│ Доп. │ Код │   Дата   │ Код  │      Сумма        │   Сумма в руб.    │              Основание                 │          Плательщик          │           Получатель         │      Статус     │
│      │ код  │ НО  │          │ вал  │                   │                   │                                        │                              │                              │                 │]
(str:c);

 END;

macro Тапки()
[ 
   Ответственный сотрудник                  ###############################################


   Уполномоченный сотрудник ОФМ             ###############################################


]("Игнатьева Н.А.", "Угольков А.В.");

end;



MACRO СписокОпераций(state, startdate, enddate)
var rs, str, str2, cnt=0;
array arr_main, arr_slave, arr_neob;
var main, slave;

                 /*23.04.2012 Зафиксирован оптимальный план с декартовым произведением HASH LAO*/
  str = " SELECT /*+ USE_HASH(t)*/  ATTR.T_NAMEOBJECT t_code, " 
+"\n		      t.T_OPERATIONID, " 
+"\n		      t.T_DOCKIND, " 
+"\n		      t.T_DOCUMENTID, " 
+"\n		      t.t_date_carry t_date, " 
+"\n		      t.t_code_currency, " 
+"\n		      t.t_sumcur, " 
+"\n		      t.t_sumrub, " 
+"\n		      t.t_ground, " 
+"\n		      DECODE (t.t_status, " 
+"\n		             1, 'на контроль', " 
+"\n		             2, 'проконтролирован', " 
+"\n		             3, 'завизирован', " 
+"\n		             4, 'отложен', " 
+"\n		             5, 'выгружен', " 
+"\n		             6, 'приостановлен', " 
+"\n		             7, 'к проводке', " 
+"\n		             'неизвестен') " 
+"\n		      t_status, " 
+"\n		      (SELECT   t_name " 
+"\n		      FROM   dopcntrpt_dbt " 
+"\n		      WHERE   t_operationid(+) = t.t_operationid AND t_kind = 1) " 
+"\n		      t_payer, " 
+"\n		      (SELECT   t_name " 
+"\n		      FROM   dopcntrpt_dbt " 
+"\n		      WHERE   t_operationid(+) = t.t_operationid AND t_kind = 4) " 
+"\n		      t_receiver, "
+"\n		      atcor.t_general ";
   if(state == 5)
      str = str + "  FROM   dopcontr_dbt t, dopcontrseance_dbt s, dobjatcor_dbt atcor, dobjattr_dbt attr " +
                  " WHERE t.T_SEANCE = s.T_SEANCEID " + 
                  "   and t.t_status = "+state+" AND s.t_date between TO_DATE ('"+startdate+"', 'dd.mm.yyyy') and TO_DATE ('"+enddate+"', 'dd.mm.yyyy') "; 
   else
      str = str + "  FROM dopcontr_dbt t, dobjatcor_dbt atcor, dobjattr_dbt attr " +
                  /* EVG Непонятно, почему анализируется t_date_p (дата отправки). Только у выгруженных операций эта дата ненулевая, и то не у всех.
                  " WHERE t.t_status = "+state+" AND t.t_date_p between TO_DATE ('"+startdate+"', 'dd.mm.yyyy') and TO_DATE ('"+enddate+"', 'dd.mm.yyyy') "; */
                  " WHERE t.t_status = "+state+" AND t.t_date between TO_DATE ('"+startdate+"', 'dd.mm.yyyy') and TO_DATE ('"+enddate+"', 'dd.mm.yyyy') "; 
   end;
  str = str + "           AND atcor.t_object = " 
+"\n		                       DECODE (t.T_DOCUMENTID, " 
+"\n		                               CHR (0), -1, " 
+"\n		                               CHR (1), -1, " 
+"\n		                               lpad(t.T_DOCUMENTID,10,0)) "
+"\n                      and t.t_DOCUMENTID != chr(1) "                 
+"\n		                 AND ((atcor.t_objecttype = 501 AND atcor.t_groupid = 11) OR (atcor.t_objecttype = 700 AND atcor.t_groupid = 1)) "
+"\n		                 AND atcor.t_general = 'X' "
+"\n		                 and ATTR.t_objecttype = 700 /*AND ROWNUM = 1*/ AND ATTR.t_groupid = 1 "
+"\n		                 and ATTR.T_ATTRID = ATCOR.T_ATTRID "
+" union all " //Lavrenov: 11.04.2012 I-00176234 теперь в выборку попадают и операции введенные руками
+" SELECT    ATTR.T_NAMEOBJECT t_code, " 
+"\n		      t.T_OPERATIONID, " 
+"\n		      t.T_DOCKIND, " 
+"\n		      t.T_DOCUMENTID, " 
+"\n		      t.t_date_carry t_date, " 
+"\n		      t.t_code_currency, " 
+"\n		      t.t_sumcur, " 
+"\n		      t.t_sumrub, " 
+"\n		      t.t_ground, " 
+"\n		      DECODE (t.t_status, " 
+"\n		             1, 'на контроль', " 
+"\n		             2, 'проконтролирован', " 
+"\n		             3, 'завизирован', " 
+"\n		             4, 'отложен', " 
+"\n		             5, 'выгружен', " 
+"\n		             6, 'приостановлен', " 
+"\n		             7, 'к проводке', " 
+"\n		             'неизвестен') " 
+"\n		      t_status, " 
+"\n		      (SELECT   t_name " 
+"\n		      FROM   dopcntrpt_dbt " 
+"\n		      WHERE   t_operationid(+) = t.t_operationid AND t_kind = 1) " 
+"\n		      t_payer, " 
+"\n		      (SELECT   t_name " 
+"\n		      FROM   dopcntrpt_dbt " 
+"\n		      WHERE   t_operationid(+) = t.t_operationid AND t_kind = 4) " 
+"\n		      t_receiver, "
+"\n		      atcor.t_general ";
   if(state == 5)
      str = str + "  FROM   dopcontr_dbt t, dopcontrseance_dbt s, dobjatcor_dbt atcor, dobjattr_dbt attr " +
                  " WHERE t.T_SEANCE = s.T_SEANCEID " + 
                  "   and t.t_status = "+state+" AND s.t_date between TO_DATE ('"+startdate+"', 'dd.mm.yyyy') and TO_DATE ('"+enddate+"', 'dd.mm.yyyy') "; 
   else
      str = str + "  FROM dopcontr_dbt t, dobjatcor_dbt atcor, dobjattr_dbt attr " + 
                  /* EVG Непонятно, почему анализируется t_date_p (дата отправки). Только у выгруженных операций эта дата ненулевая, и то не у всех.
                  " WHERE t.t_status = "+state+" AND t.t_date_p between TO_DATE ('"+startdate+"', 'dd.mm.yyyy') and TO_DATE ('"+enddate+"', 'dd.mm.yyyy') "; */
                  " WHERE t.t_status = "+state+" AND t.t_date between TO_DATE ('"+startdate+"', 'dd.mm.yyyy') and TO_DATE ('"+enddate+"', 'dd.mm.yyyy') "; 
   end;
  str = str + "           AND atcor.t_object =  lpad(t.t_operationid,10,0)" 
+"\n		                 AND ((atcor.t_objecttype = 501 AND atcor.t_groupid = 11) OR (atcor.t_objecttype = 700 AND atcor.t_groupid = 1)) "
+"\n		                 AND atcor.t_general = 'X' "
+"\n		                 and ATTR.t_objecttype = 700 /*AND ROWNUM = 1*/ AND ATTR.t_groupid = 1 "
+"\n		                 and ATTR.T_ATTRID = ATCOR.T_ATTRID "
+"\n		 AND NOT EXISTS (SELECT 1 FROM dobjatcor_dbt WHERE t_object = LPAD (t.t_documentid, 10, 0) "
+"\n						    AND ( (t_objecttype = 501 AND t_groupid = 11) OR (t_objecttype = 700 AND t_groupid = 1)) AND t_general = 'X') "
+"\n		      ORDER BY   t_code, t_sumrub ";
//println(str);
  rs = trsbdataset(str);       
  while (rs and rs.movenext)
  asize(arr_main,0);
  asize(arr_slave,0);
  asize(arr_neob,0);
//  getoprcode(arr_main,rs.T_OPERATIONID, rs.T_DOCUMENTID,88);
//  getoprcode(arr_slave,rs.T_OPERATIONID, rs.T_DOCUMENTID,0);
	if (rs.t_general =="X")
		arr_main(asize(arr_main))= rs.t_code;
	else
		arr_slave(asize(arr_slave))= rs.t_code;
	end;
  getneobcode(arr_neob,rs.T_OPERATIONID, rs.T_DOCUMENTID);
  
 cnt=cnt+1;
 [+------+------+-----+----------+------+-------------------+-------------------+----------------------------------------+------------------------------+------------------------------+-----------------+
  │######│######│#####│##########│######│###################│###################│########################################│##############################│##############################│#################│]
(arrtostr(arr_main):c:w, arrtostr(arr_slave):c:w, arrtostr(arr_neob):c:w, substr(string(rs.t_date),1,10), получитькодфинин(rs.t_code_currency):c, rs.t_sumcur, rs.t_sumrub, rs.t_ground:w, rs.t_payer:w, rs.t_receiver:w, rs.t_status:c);

  Код_Ячейки ="A"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, arrtostr(arr_main));
  Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, arrtostr(arr_slave));
  Код_Ячейки ="C"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, arrtostr(arr_neob));
  Код_Ячейки ="D"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, substr(string(rs.t_date),1,10));
  Код_Ячейки ="E"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодфинин(rs.t_code_currency));
  Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.t_sumcur));
  Код_Ячейки ="G"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.t_sumrub));
  Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_ground);
  Код_Ячейки ="I"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_payer);
  Код_Ячейки ="J"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_receiver);
  Код_Ячейки ="K"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_status);
  Номер_Строки=Номер_Строки+1;

  end;
//  msgbox(kol);
 [+------+------+-----+----------+------+-------------------+-------------------+----------------------------------------+------------------------------+------------------------------+-----------------+
  │ Итого: ####### документов    │                                                                                                                                                                       │
  L------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------]
  (cnt);  

  //msgbox(cnt);
END;


array m_menu;
      m_menu(0)="На контроль";
      m_menu(1)="Проконтролированные";
      m_menu(2)="Завизированные";
      m_menu(3)="Отложенные";
      m_menu(4)="Выгруженные";
      m_menu(5)="Приостановленные";
      m_menu(6)="К проводке";
      m_menu(7)="Отвергнутые";



 var startdate, enddate, promt, summ=$50000;
  startDate = date();

   promt = menu(m_menu, "Выбор статуса?","Выбор статуса?",null,null);
   if (promt < 0)
      exit(1);
   else
      promt = promt+1;
   end;


  if ( not GetDate( startDate, "Введите начальную дату отчета :" ) )
    exit(1);
  else
    if(startdate == date(0,0,0))
       startdate = "01.01.0001";
    end;
  end;

  endDate = startDate;
  if ( not GetDate( endDate, "Введите конечную дату отчета :" ) )
    exit(1);
  else
    if (startDate > endDate)
      msgbox("Значение даты "+string(endDate)+" введено неверно !!!");
      exit(1);
    end;
  end;

  ОткрытиеТаблицы_Книги("fm_oper.xls");
  ИнициализацияЛистов(ЧислоЛистов);

  ws(1).Activate;/*можно писать в этот лист*/
  ob.Visible=false;


  Шапка(startdate, enddate); 
  СписокОпераций(promt, startdate, enddate);
  Тапки;

  msgbox("Все! Теперь можете просмотреть полученный отчет в EXCEL","| Нажмите ESC");
  ob.Visible=true;
