/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6.0                     */
/****************************************************************************/
/*                  Подсистема "РКО Юридических лиц"                        */
/*  Отправка статуса документа в ИК на шаге операции                        */
/*                                                                          */
/*  Имя файла:  SendStatus_IB.mac                                           */
/*  Создан   :  23.11.2012                                 Чесноков Д.С.    */
/*  Заявка   :  C-15839                                                     */
/*  Описание :  Макропроцедура SendStatus_IB вызывается на шагк операции в  */
/*              блоке PostStepAction.                                       */
/*              Входные параметры:                                          */
/*              - PaymentID - Id документа в рс-банке                       */
/*              - Dockind - вид документа в рс-банке                        */
/*              - StatusID - ID статуса документа из таблицы doprrcptp_dbt  */
/*              - CheckIB - флаг проверки документа в том что он выгружен   */
/*                из ИК, по умолчанию включен.                              */
// KS 09.06.2014 Обработка Статусов ИК Солидарность
// VDN 05.12.2014 R-502576 проверка необходимости отправки статуса в "свой" ИК Солидарности
/****************************************************************************/
import "iborwp.mac", "clbrcpIB.mac", RSD;
import "clbrcpIK.mac","fg_Life_parm.mac",globals; // KS 09.06.2014 Обработка Статусов ИК Солидарность

private macro LZ( num, len )
 var str1, len1;
    str1 = trim( string( num ) );
    len1 = strlen( str1 );
    if ( len1 >= len )
      return str1;
    else
       return  mkstr("0", len-len1 ) + str1; /* слева */
    end;
END;

/*VDN 05.12.2014 R-502576 Проверка версии ИК для Солидарности*/
macro checkIB_SLD(PaymentID, Dockind)
   var clID = "00202" + LZ(PaymentID, 10);
   if (Dockind == 201) 
      clID = "00201" + LZ(PaymentID, 10); 
   end;

   if (checkInterBankVersion(clID,6))
      return false;
   elif (checkInterBankVersion(clID,5))
      return false;
   end;
   return true;
end;

macro SendStatus_IB(PaymentID, Dockind, StatusID, CheckIB);

var clID, rs, str;
private var sqlString, rst;
private var fgBank; // KS 09.06.2014 Для определения банка
  
  if(ValType(CheckIB) == V_Undef)
    CheckIB = true;
  end;
  
  if (Dockind == 201)
    clID = "00201" + LZ(PaymentID, 10);
  else
    clID = "00202" + LZ(PaymentID, 10);
  end;
  
  if (CheckIB)//Флаг проверки документ выгружен из ИК
    str = "select 1 from dclbdoc_dbt where t_docid = " + clID;
    rs = RsdRecordSet(str);
    
    if (rs and rs.movenext())
      str = "select t_desc from doprrcptp_dbt where t_receipttype = " + StatusID;
      rs = RsdRecordSet(str);
  
      if (rs and rs.movenext())
      /*Отправка статуса в ИК*/
        if (checkInterBankVersion(clID,6))
          clbMakeReceiptIB6(clID, StatusID, rs.value("t_desc"), rs.value("t_desc"));
        elif (checkInterBankVersion(clID,5))
          clbMakeReceiptByABSId(clID, true, StatusID, rs.value("t_desc"), rs.value("t_desc"), null);
        else
          // KS 12.05.2014 Обработка платежей ИК в Солидарности
          fgBank = fg_life_subject({OurBank});
          if (fgBank.is_SLD)
            sqlString = " SELECT 1 " +
                        "   FROM dpmpaym_dbt " +
                        "  WHERE t_origin = 2 " + // Считаем, что это уже не может быть Интербанк, так как не сработала checkInterBankVersion
                        "    AND t_paymentid = " + substr(clID,6,10);

            rst = RsdRecordset( sqlString );
            if (rst.moveNext())
              clbMakeReceiptIK(clID, StatusID, rs.value("t_desc"), rs.value("t_desc"));
            end;
          end;
        end;
      end;
    end;
  else//Если флаг false все равно отправляем статус
    str = "select t_desc from doprrcptp_dbt where t_receipttype = " + StatusID;
    rs = RsdRecordSet(str);
  
    if (rs and rs.movenext())
    /*Отправка статуса в ИК*/
      if (checkInterBankVersion(clID,6))
        clbMakeReceiptIB6(clID, StatusID, rs.value("t_desc"), rs.value("t_desc"));
      elif (checkInterBankVersion(clID,5))
        clbMakeReceiptByABSId(clID, true, StatusID, rs.value("t_desc"), rs.value("t_desc"), null);
        else
          // KS 12.05.2014 Обработка платежей ИК в Солидарности
          fgBank = fg_life_subject({OurBank});
          if (fgBank.is_SLD)
            sqlString = " SELECT 1 " +
                        "   FROM dpmpaym_dbt " +
                        "  WHERE t_origin = 2 " + // Считаем, что это уже не может быть Интербанк, так как не сработала checkInterBankVersion
                        "    AND t_paymentid = " + substr(clID,6,10);

            rst = RsdRecordset( sqlString );
            if (rst.moveNext())
              clbMakeReceiptIK(clID, StatusID, rs.value("t_desc"), rs.value("t_desc"));
            end;
          end;
      end;
    end;
  end;
end;