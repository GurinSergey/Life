//-----------------------------------------------------------------------------
// Блок: 11001778 "Валютный контроль для 407 Формы"
// Шаг: & - "ВК407Ф"
// Описание : Макрос шага валютного контроля для документов по 407 форме. Пройден\не пройден.
// Разработчик: Телешова А. 01.11.2012 С-14674
//-----------------------------------------------------------------------------
import PaymInter, CTInter, BankInter, InsCarryDoc, RSD; //Gurin S. 12.01.2015 I-00543950-1

var PaymentObj:RsbPayment;

MACRO ExecuteStep( doc, paymDoc, p1, p2,  Id_step )
    debugbreak;
    var stat:integer = 0;
    var note_139 = "";
    var attr_117 = "";
    var cmd;
    
    macro GetPaymAttribute(Paym_id:integer,Category_id:integer):string
        var result = " ";
        record pmpaym(pmpaym);
        ClearRecord(pmpaym);
        pmpaym.paymentid = Paym_id;
        GetMainObjAttr (null, OBJTYPE_PAYMENT, UniID(pmpaym,OBJTYPE_PAYMENT), Category_id, null, null, result);
        return result;
    end;

    macro ReadNoteForPayment(Paym_id:integer,NoteKind:integer ):string
        record pmpaym(pmpaym);
        ClearRecord(pmpaym);
        pmpaym.paymentid = Paym_id;
        return ReadNoteForObject( OBJTYPE_PAYMENT, makeObjectID(OBJTYPE_PAYMENT, NULL, pmpaym), NoteKind );
    end;
    
    note_139 = trim(ReadNoteForPayment(PaymentObj.PaymentID,139));
    attr_117 = trim(GetPaymAttribute(PaymentObj.PaymentID,117));
    
    if(note_139 == "")
        msgbox("Заполните примечание 139 \"Контрагент для формы 0409407\"!");
        stat = 1;
    else
        if(attr_117 == "")
            msgbox("Заполните категорию \"Код страны банка нерезидента\"!");
            stat = 1;
        else
            if(PaymentObj.basefiid != 0) //для РКО валюта закрываем платеж
                if( not InsertPaymentPropStat( PaymentObj.PaymentID, 32000 /*PM_FINISHED*/ ) )
                    msgbox("Ошибка при вставке статуса платежа");
                    return 1;
                end;
                cmd = RSDCommand("update dwlpm_dbt set t_propstatus = 32000 where t_paymentid = ?");
                cmd.addparam("pmid", RSDBP_IN, PaymentObj.PaymentID);
                cmd.execute();
            end;
        end;
    end;
    
    if (stat == 0)
        msgbox ("Документ проконтролирован ВК407Ф");
    end;

   return stat;
END;