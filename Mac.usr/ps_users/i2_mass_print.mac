/************************************************************************************************
 * Макрос массовой печати извещений о постановке на К2
 * zip_z. I-080947 2010-12-15
  ************************************************************************************************/
/* Изменен: Gurin S. N. 19.09.2012 I-00255230-2                                                  */
// VV 13.06.2013 V-21093 Убрать печать извещений по документам с пачкой 1003
import oralib, likepy, globals;
import prpmbuff, psi2note;

/* --------------- Параметры выпуска отчета ----------------------------------------------------- */

var p_Oper     = 0;         // операционист-владелец документа К2   
var p_BegDate  = {curDate}; // дата постановки на К2: начальная дата 
var p_EndDate  = {curDate}; // дата постановки на К2: конечная дата  

var report_has_records = false;

private macro ExitReport ( msg )
    msgBox (msg);
    Exit (1);
end;

private macro main ()
var _sql;
debugbreak;
    if (   not GetInt  (p_Oper,    "Введите номер операциониста|"
                                   "0 - выпуск отчета по всем операционистам")  
        or not GetDate (p_BegDate, "Введите начальную дату" )
        or not GetDate (p_EndDate, "Введите конечную дату"  ))
        
        ExitReport ("Пользователь прервал выпуск отчета");   
    end;

    if (p_begDate > p_endDate)
        ExitReport ("Заданы неверные параметры отчета:"
                    "|Конечная дата не может быть больше начальной");
    end;
/*SDA нет больше такого индекса */
//    var sql = "select /*+leading (paym) index (paym dpmpaym_dbt_idxc)*/"+
    var sql = "select "+
              "\n       paym.t_paymentid, paym.t_purpose, paym.t_subpurpose, paym.t_dockind, paym.t_documentid"+
              "\n  from dpmpaym_dbt paym, dpmrmprop_dbt rmprop"+
              "\n where paym.t_dockind = 201"+
/*SDA нет больше такой необходимости */
//              "\n   and paym.t_paymentid = payord.t_orderid"+
              "\n   and paym.t_paymentid = rmprop.t_paymentid"+
              "\n   and paym.t_paymstatus between 2000 and 32000"+
              "\n   and PAYM.T_NUMBERPACK!=1003"+  // VV 13.06.2013 C-21093 Убрать печать извещений по документам с пачкой 1003
             "\n   and PAYM.T_NUMBERPACK!=1002"+  // VV 02.07.2013 C-21594 Убрать печать извещений по документам с пачкой 1002
              "\n   and paym.t_feetype = 0 and rmprop.t_SHIFROPER != '01' and rmprop.t_SHIFROPER != '16' "+
              "\n   and paym.t_i2placedate != to_date ('01.01.0001', 'dd.mm.yyyy')"+
              "\n   and paym.t_i2placedate between :begdate and :enddate"+
/*SDA нет больше такого поля */
//              "\n   and payord.t_closedate <= :enddate ";
              "\n   and paym.t_closedate <= :enddate ";

    if (p_oper != 0) // Gurin S. N. 19.09.2012 I-00255230-2 не был передан еще один :enddate
        sql = sql + " and paym.t_oper = :oper"; 
        _sql = ExecSQLSelect (sql, MakeArray (sqlParam ("begDate", p_BegDate),
                                             sqlParam ("endDate", p_endDate),
                                             sqlParam ("endDate2", p_endDate), 
                                             sqlParam ("oper",    p_Oper)));

    else
        _sql = ExecSQLSelect (sql, MakeArray (sqlParam ("begDate", p_BegDate),
                                             sqlParam ("endDate", p_endDate),
                                             sqlParam ("endDate2", p_endDate)));
    end;

    while (_sql.MoveNext ())
        report_has_records = true;
        if (FindPayment (_sql.value ("t_paymentid"), 
                         _sql.value ("t_purpose"), 
                         _sql.value ("t_purpose"), 
                         _sql.value ("t_dockind"), 
                         _sql.value ("t_documentid"), 
                         true, pr_pmpaym, pr_debet, pr_credit, pr_pmrmprop) == 0)
                
            PrintDocument (1);
        end;
    end;

    if (not report_has_records)
        println ("Нет данных для печати\n\n");
        println ("Отсутствуют документы К2 в диапазоне дат c ", string (p_begDate), " по ", string (p_EndDate));
        if (p_oper != 0) 
            println ("для операциониста ", string (p_oper));
        end;
    end;

onError 
Println("Ошибка выполнения ");

end;

/* --------------- Точка входа ------------------------------------------------------------------- */
main ();