//-----------------------------------------------------------------------------
// Блок: 11101778 "Комплайенс-контроль"
// Шаг: ! - "КМК"
// Описание : Макрос шага комплайенс-контроля для клиентских платежей и чеков
// Разработчик: Головкин Владимир
// Changes:
//          Teleshova A. 10.12.2014 С-35801
//-----------------------------------------------------------------------------
import paymInter,rsd,OprInter;
import oralib,likePy;
import pmdefbo,pschkrst;
import lib_account, lib_fg;

var PaymentObj:RsbPayment;

macro ExecuteStep( doc, paymDoc, DocKind:integer, ID_Operation:integer, ID_Step:integer )
   var stat       = 0;
   var accountObj = RSL_Account( PaymentObj.FuturePayerAccount );

private var sql = " SELECT 1 FROM dobjatcor_dbt                            " +
                       "         WHERE t_objecttype  = 3                   " +
                       "           AND t_groupid = 300                     " +
                       "           AND t_attrid = 6                        " +
                       "           AND t_object = LPAD (:partyid, 10, '0') " +
                       "           AND T_VALIDTODATE = to_date('31.12.9999','dd.mm.yyyy') " ;
        sql = execSQLSelect( sql, makeArray( SQLParam( "partyid",  PaymentObj.payer ) ) );
        
        /*27.04.2015 LAO C-38649 если уровень бордовый(5), тогда проверяем доступ к группе 68*/
     if (( sql.movenext ) and (not ВходитВГруппу({oper},ACS_GRP_KK_OS)))
        MsgBox("Вы не включены в группу \"68 -Compliance control (Бордовый уровень)\". Проведение документа запрещено!");
        return 1;
     end;


   if( getTrue( TRUE, "Отвергнуть документ?" ) )
      PaymentObj.PaymStatus = PM_REJECTED;
      PM_SetPrimDocumentState( PaymentObj, DOCUMENT_ST_REJECTED ); 

      stat = УстановитьСтатусыПлатежа( OPR_PAYM_STATE, OPR_PM_ST_REJECT  );
      if( stat == 0 )
         PaymentObj.FreeReserve( accountObj.rec.account, accountObj.rec.chapter, accountObj.rec.code_currency );
      end;
      //Gurin S. 01.04.2015 R-564956-2
      if (_bank.is_PRBB)
         if( inList(GetOprStatus(291),3,4) )
            УстановитьСтатусыПлатежа(117,2);
         end; 
      end;
   else
      //TAM 10.12.2014 C-35081 Проверка свободного остатка только для платежей
      if (PaymentObj.DocKind != CASH_PS_OUTORDER)
         // Golovkin C-32589 27.08.2014 проверка остатка, т.к. на шаге предобработка была исключена
         stat = PS_CheckAccRest( PaymentObj, ID_Operation, ID_Step );
         // Golovkin R-445716 08.09.2014 Если денег нет, то отставить согласование
         if( inList(GetOprStatus(304),3,9) )
            УстановитьСтатусыПлатежа(118,1);
         end; 
      end;
   end;

   return stat;
end;