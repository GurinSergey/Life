/**************************************************************************************************/
/*                                                                                R-Style Softlab */
/*         Финмониторинг/Отчеты/Контроль за объемами снятия наличных денежных средств для ДО      */
/*                                                                                                */
/*         Изменено: 20.06.2012 Lavrenov по заявке I-00210299                                     */
/*                   11.07.2012 Lavrenov в рамках перехода на 11G к вызову wm_concat добавляем    */
/*                              dbms_lob.substr                                                   */
/*                   26.10.2012 Teleshova: по заявке C-600                                        */
/*                   06.08.2013 DPN по заявке I-00409153 Добавил возможность формирования отчёта  */
/*                              по головному узлу и подразделениях                                */
/*                   06.02.2014 Chesnokov D.S. адаптация под 2031                                 */
/*                   13.11.2014 joy R-493406 возможность выпуска отчета за текущую дату           */
/**************************************************************************************************/
import rsbdataset, globals, ptinter, ActX, CTInter;
import likePy;

var ЧислоЛистов=1, File_Name="";
var Код_Ячейки="";
var Номер_Строки  = 2,  /*с которой начинается заполнение данных*/
     лист = 1;
record dep (dp_dep);

var rs, str;
var startdate={curdate}, enddate = {curdate};
var cnt = 0, legalform, dep_kind, rule;
//TAM 24.10.2012 C-600
var department = "", bm = "", oper = "";

array m_menu_gl;
      m_menu_gl(0)="Снятие наличных средств";
      m_menu_gl(1)="Внесение наличных средств";

array m_menu_lf;
      m_menu_lf(0)="Юридические лица";
      m_menu_lf(1)="Индивидуальные предприниматели";

array m_menu_dep;
      m_menu_dep(0)="Брать подразделение из проводок";
      m_menu_dep(1)="Брать подразделение из счетов";

//DPN: 06.08.2013 I-00409153-2
array m_menu_general_dep;
      m_menu_general_dep(0)="Только головное подразделение";
      m_menu_general_dep(1)="Головное и все подчинённые подразделения";

var sum_40=$0, sum_41=$0, sum_42=$0, sum_46=$0, sum_50=$0, sum_53=$0, sum_54=$0, sum_55=$0, sum_56=$0,
    sum_57=$0, sum_58=$0, sum_59=$0, sum_60=$0, sum_all=$0, glob_cln_debet=$0;

MACRO GetPartyName(partyid)
  var rs, str;
  str = "SELECT t_name " +
        "  FROM dparty_dbt " +
        " WHERE t_partyid = "+partyid;
  rs = trsbdataset(str);
  if(rs and rs.movenext)
     return rs.name;
  else
     return "";
  end;
END;

MACRO get_perc_client_credit  (partyid, startdate, enddate)
   var rs, str;
   str = "SELECT   acc.t_client, SUM (ad.t_sum_receiver) t_sum, " +
         "         SUM (NVL ((SELECT SUM (t_sum) " +
         "                      FROM dsymbcash_dbt " +
         "                     WHERE t_acctrnid = ad.t_acctrnid),0)) t_symb_sum " + 
         "    FROM dacctrn_dbt ad, daccount_dbt acc " +
         "   WHERE acc.t_client =   " + partyid +
         "     AND (   acc.t_account LIKE '405__810%' " +
         "          OR acc.t_account LIKE '406__810%' " +
         "          OR acc.t_account LIKE '407__810%' " +
         "          OR acc.t_account LIKE '40802810%') " +
         "     AND acc.t_chapter = 1 " +
         "     AND ad.t_account_receiver = acc.t_account " +
         "     AND ad.t_chapter = 1 " +
         "     AND ad.t_date_carry BETWEEN TO_DATE ('"+startdate+"', 'dd.mm.yyyy') " +
         "                             AND TO_DATE ('"+enddate+"', 'dd.mm.yyyy') " +
         "GROUP BY acc.t_client " ;

   rs = trsbdataset(str);
   if(rs and rs.movenext)
      return (money(rs.t_symb_sum)/money(rs.t_sum))*100 ;
   else
      return money(0);
   end;
END;

MACRO Get_Client_Debet (partyid, startdate, enddate)
  var rs, str;
  str = "SELECT nvl(sum(ad.t_sum_payer),0) t_sum " +
        "  FROM dacctrn_dbt ad, daccount_dbt acc " +
        " WHERE acc.t_client =  " + partyid +
        "   AND (   acc.t_account LIKE '405__810%' " +
        "        OR acc.t_account LIKE '406__810%' " +
        "        OR acc.t_account LIKE '407__810%' " +
        "        OR acc.t_account LIKE '40802810%' " +
        "       ) " +
        "   AND acc.t_chapter = 1 " +
        "   AND ad.t_account_payer = acc.t_account " +
        "   AND ad.t_chapter = 1 " +
        "   AND ad.t_date_carry BETWEEN TO_DATE ('"+startdate+"', 'dd.mm.yyyy') " +
        "                           AND TO_DATE ('"+enddate+"', 'dd.mm.yyyy') " ;
  rs = trsbdataset(str);
  if(rs and rs.movenext)
     return money(rs.t_sum);
  else
     return money(0);
  end;
END;

MACRO GetRAcc(partyid)
//Lavrenov: 11.07.2012 в рамках перехода на 11G к вызову wm_concat добавляем dbms_lob.substr
  var sqlRAcc = " SELECT dbms_lob.substr( NVL(wm_concat (ACC.T_ACCOUNT), ' ')) racc " +
                "   FROM (SELECT * " +
                "           FROM daccount_dbt " +
                "          WHERE T_TYPE_ACCOUNT LIKE '%Ч%' " +
                "             OR T_TYPE_ACCOUNT LIKE '%X%' "
                "            AND T_OPEN_CLOSE <> 'З' " +
                "            AND T_CHAPTER = 1 ) acc " +
                "  WHERE ACC.T_CLIENT = " + partyid;

  var rsRAcc = trsbdataset(sqlRAcc);
  if (rsRAcc and rsRAcc.movenext)
    return rsRAcc.racc;
  else
    return "";
  end;
end;

//TAM 26.10.2012 C-600
macro GetAccDepName(account:string):string
  private var cmd, rs;
  cmd = RSDCommand(" SELECT PT.T_NAME dep_name" +
                   "   FROM daccount_dbt ac, ddp_dep_dbt dp, dparty_dbt pt " +
                   "  WHERE AC.T_ACCOUNT = ? AND ac.T_branch = DP.T_CODE AND DP.T_PARTYID = PT.T_PARTYID");
  cmd.addParam("acnt", RSDBP_IN, account);
  rs = RSDRecordset(cmd);
  if(rs.MoveNext())
     if (rs.value("dep_name") != "")
       return rs.value("dep_name");
     else 
       return "";
     end;
  end;
end;

macro ReadNoteForClient(ClientID:integer, NoteKind:integer ):string
  record client(party);
  ClearRecord(client);
  client.partyid = ClientID;
  return ReadNoteForObject( OBJTYPE_PARTY, makeObjectID(OBJTYPE_PARTY, NULL, client), NoteKind );
end;

macro GetClientOper(ClientID:integer):string
  private var cmd, rs;
  cmd = RSDCommand(" SELECT PR.T_NAME oper_name" +
                   "   FROM dparty_dbt pt, dclient_dbt cl, dperson_dbt pr " +
                   "  WHERE PT.T_PARTYID = ? " +
                   "    AND PT.T_PARTYID = CL.T_PARTYID AND cl.T_oper = PR.T_OPER ");
  cmd.addParam("cl", RSDBP_IN, ClientID);
  rs = RSDRecordset(cmd);
  if(rs.MoveNext())
     if (rs.value("oper_name") != "")
       return rs.value("oper_name");
     else 
       return "";
     end;
  end;
end;

private macro getShortName (fullname:string):string
  while (index (fullname, "  ")) 
    fullname = trim (strSubst (fullName, "  ", " "));
  end;

  var f = split(trim(fullName), " ");
  if (f.size (f) == 2)
    return fullName;
  else
    return (string(f[0], " ", strUpr (substr (f[1], 1, 1)), ".", strUpr (substr (f[2], 1, 1)), "."));
  end;
end;
//end TAM 

MACRO report

var rs, str, str2;
var cln_debet, perc_all, perc_somn, perc_kred, INN, KPP;

str = "select t.*, p.t_name from   " +
      "(SELECT   q.t_client, SUM (q.t_sum) t_sum, " +
      "           SUM (q.t_sum_40) + SUM (q.t_sum_41) + SUM (q.t_sum_42) " +
      "         + SUM (q.t_sum_46) + SUM (q.t_sum_50) + SUM (q.t_sum_53) " +
      "         + SUM (q.t_sum_54) + SUM (q.t_sum_55) + SUM (q.t_sum_56) " +
      "         + SUM (q.t_sum_57) + SUM (q.t_sum_58) + SUM (q.t_sum_59) " +
      "         + SUM (q.t_sum_60) sum_all, " +
      "         SUM (q.t_sum_40) sum_40, SUM (q.t_sum_41) sum_41, SUM (q.t_sum_42) sum_42, " +
      "         SUM (q.t_sum_46) sum_46, SUM (q.t_sum_50) sum_50, SUM (q.t_sum_53) sum_53, " +
      "         SUM (q.t_sum_54) sum_54, SUM (q.t_sum_55) sum_55, SUM (q.t_sum_56) sum_56, " +
      "         SUM (q.t_sum_57) sum_57, SUM (q.t_sum_58) sum_58, SUM (q.t_sum_59) sum_59, " +
      "         SUM (q.t_sum_60) sum_60 " +
      "    FROM (SELECT acc.t_client, ad.t_account_payer, ad.t_account_receiver, ad.t_sum_payer as t_sum, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 40 ),0) t_sum_40, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 41),0) t_sum_41, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 42),0) t_sum_42, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 46),0) t_sum_46, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 50),0) t_sum_50, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 53),0) t_sum_53, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 54),0) t_sum_54, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 55),0) t_sum_55, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 56),0) t_sum_56, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 57),0) t_sum_57, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 58),0) t_sum_58, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 59),0) t_sum_59, " +
      "                 NVL ((SELECT SUM (t_sum) " +
      "                         FROM dsymbcash_dbt " +
      "                        WHERE t_acctrnid = ad.t_acctrnid " +
      "                          AND t_symbol = 60),0) t_sum_60 " +
      "            FROM dacctrn_dbt ad, daccount_dbt acc " +
      "           WHERE (   ad.t_account_payer LIKE '405__810%' " +
      "                  OR ad.t_account_payer LIKE '406__810%' " +
      "                  OR ad.t_account_payer LIKE '407__810%' " +
      "                  OR ad.t_account_payer LIKE '40802810%' " +
      "                 ) " +
      "             AND ad.t_account_receiver LIKE '202__810%' " +
      "             AND ad.t_date_carry BETWEEN TO_DATE ('"+startdate+"', 'dd.mm.yyyy') " +
      "                                     AND TO_DATE ('"+enddate+"', 'dd.mm.yyyy') " +
      "             AND ad.t_chapter = 1 "; 
 
//Lavrenov: 20.06.2012 I-00210299-1 В зависимости от выбора t_branch берется либо из счета, либо из проводки 
  if(dep_kind == 0)
    if (rule == 0)    //DPN: 06.08.2013 I-00409153-2 берётся либо только по головному подразделению, либо по всем подразделениям
      str = str + "             AND ad.t_branch =  " + dep.code + " ";
    end;
  else 
    str = str + "             AND acc.t_branch =  " + dep.code + " ";
  end;
    str = str +"             AND acc.t_account = ad.t_account_payer " +
               "             AND acc.t_chapter = 1) q " +
      "GROUP BY q.t_client) t , dparty_dbt p " +
      "where p.T_PARTYID = t.t_client " +
      "and p.t_legalform = " + legalform +
      "and sum_all > 0 " +
      "order by sum_all desc " ;
 
  if(startdate==enddate)
     str2 = "за "+ startdate +" г.";
  elif(startdate==date("00.00.0000"))
     str2 =  "за период 00.00.0000 - "+ enddate +" г.";
  else
     str2 =  "за период "+ startdate +" - "+ enddate +" г.";
  end;
 
[                 Отчет для контроля и анализа за объемами снятия наличных денежных средств со счетов Юр. лиц и ИП согласно указаниям ЦБ #

 ┌───────┬────────────────┬──────────────────────────────────────┬────────────────┬────────────────────┬─────────────────┬─────────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────┬──────────────────┬──────────────────┬──────────────┬──────────────┬──────────────┐
 │ № п/п │  Код  клиента  │           Название клиента           │  ИНН  клиента  │  Офис              │  БМ             │  Операционист   │      40      │      41      │      42      │      46      │      50      │      53      │      54      │      55      │      56      │      57      │      58      │      59      │      60      │      Итого       │    Дебетовые     │% снят наличн │% сомн опер   │% отнош общ   │
 │       │                │                                      │                │                    │                 │                 │    Символ    │              │              │              │              │              │              │              │              │              │              │              │              │                  │     обороты      │к общему дебет│к общему дебет│суммы нал по- │
 │       │                │                                      │                │                    │                 │                 │              │              │              │              │              │              │              │              │              │              │              │              │              │                  │                  │   обороту    │   обороту    │ ступлений к  │
 │       │                │                                      │                │                    │                 │                 │              │              │              │              │              │              │              │              │              │              │              │              │              │                  │                  │              │              │  общ сумме   │
 │       │                │                                      │                │                    │                 │                 │              │              │              │              │              │              │              │              │              │              │              │              │              │                  │                  │              │              │ поступлений  │
](str2, dep.name+" "+getpartyname(dep.partyid));;

 rs = trsbdataset(str);
 while(rs and rs.movenext)
    cnt = cnt+1;
    cln_debet = get_client_debet(rs.t_client, startdate, enddate);
    perc_all = (money(rs.sum_all)/cln_debet)*100;
    perc_somn = ((money(rs.sum_all)-money(rs.sum_40)-money(rs.sum_42)-money(rs.sum_50))/cln_debet)*100;
    perc_kred = get_perc_client_credit(rs.t_client, startdate, enddate);
            
    sum_40  = sum_40  + rs.sum_40; 
    sum_41  = sum_41  + rs.sum_41;
    sum_42  = sum_42  + rs.sum_42; 
    sum_46  = sum_46  + rs.sum_46;
    sum_50  = sum_50  + rs.sum_50;
    sum_53  = sum_53  + rs.sum_53;
    sum_54  = sum_54  + rs.sum_54;
    sum_55  = sum_55  + rs.sum_55;
    sum_56  = sum_56  + rs.sum_56;
    sum_57  = sum_57  + rs.sum_57;
    sum_58  = sum_58  + rs.sum_58;  
    sum_59  = sum_59  + rs.sum_59;
    sum_60  = sum_60  + rs.sum_60;
    sum_all = sum_all + rs.sum_all;
    glob_cln_debet = glob_cln_debet + cln_debet;
    splitfullinn(ПолучитьКодСубъекта(rs.t_client,16),INN,KPP);
    //TAM 26.10.2012 C-600
    department = GetAccDepName(substr(GetRAcc(rs.t_client),1,20));
    bm = GetShortName(ReadNoteForClient(rs.t_client,118));
    oper = GetShortName(GetClientOper(rs.t_client));
    //end TAM
    if(valtype(INN)==0)
      INN = "";
    end;

[├───────┼────────────────┼──────────────────────────────────────┼────────────────┼────────────────────┼─────────────────┼─────────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────────┼──────────────────┼──────────────┼──────────────┼──────────────┤
 │ ##### │ ############## │ #################################### │ ############## │ ################## │ ############### │ ############### │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ################ │ ################ │ ############ │ ############ │ ############ │]
(  cnt, ПолучитьКодСубъекта(rs.t_client,1), rs.t_name:w, INN, department, bm, oper/*TAM 26.10.2012 C-600*/,money(rs.sum_40), money(rs.sum_41), money(rs.sum_42), money(rs.sum_46), money(rs.sum_50), money(rs.sum_53), 
 money(rs.sum_54), money(rs.sum_55), money(rs.sum_56), money(rs.sum_57), money(rs.sum_58), money(rs.sum_59), money(rs.sum_60), money(rs.sum_all), cln_debet, perc_all, perc_somn, perc_kred);
  Код_Ячейки ="A"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, cnt);
  Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, ПолучитьКодСубъекта(rs.t_client,1));
  Код_Ячейки ="C"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_name);
  Код_Ячейки ="D"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, INN);
  //TAM 24.10.2012
  Код_Ячейки ="E"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, department);
  Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, bm);
  Код_Ячейки ="G"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, oper);
  //end TAM
  Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_40));
  Код_Ячейки ="I"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_41));
  Код_Ячейки ="J"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_42));
  Код_Ячейки ="K"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_46));
  Код_Ячейки ="L"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_50));
  Код_Ячейки ="M"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_53));
  Код_Ячейки ="N"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_54));
  Код_Ячейки ="O"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_55));
  Код_Ячейки ="P"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_56));
  Код_Ячейки ="Q"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_57));
  Код_Ячейки ="R"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_58));
  Код_Ячейки ="S"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_59));
  Код_Ячейки ="T"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_60));
  Код_Ячейки ="U"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.sum_all));
  Код_Ячейки ="V"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(cln_debet));
  Код_Ячейки ="W"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, double(perc_all));
  Код_Ячейки ="X"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, double(perc_somn));
  Код_Ячейки ="Y"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, double(perc_kred));
  Номер_Строки=Номер_Строки+1;

 end;

[├───────┴────────────────┴──────────────────────────────────────┴────────────────┴────────────────────┴─────────────────┴─────────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────────┼──────────────────┼──────────────┼──────────────┼──────────────┤
 │ ИТОГО                                                                                                                                   │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ############ │ ################ │ ################ │              │              │              │
 └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────────┴──────────────────┴──────────────┴──────────────┴──────────────┘]
(money(sum_40), money(sum_41), money(sum_42), money(sum_46), money(sum_50), money(sum_53), 
 money(sum_54), money(sum_55), money(sum_56), money(sum_57), money(sum_58), money(sum_59), money(sum_60), money(sum_all), glob_cln_debet);

  Код_Ячейки ="A"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, "ИТОГО");
  Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_40));
  Код_Ячейки ="I"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_41));
  Код_Ячейки ="J"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_42));
  Код_Ячейки ="K"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_46));
  Код_Ячейки ="L"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_50));
  Код_Ячейки ="M"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_53));
  Код_Ячейки ="N"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_54));
  Код_Ячейки ="O"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_55));
  Код_Ячейки ="P"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_56));
  Код_Ячейки ="Q"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_57));
  Код_Ячейки ="R"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_58));
  Код_Ячейки ="S"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_59));
  Код_Ячейки ="T"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_60));
  Код_Ячейки ="U"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(sum_all));
  Код_Ячейки ="V"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(glob_cln_debet));
  Номер_Строки=Номер_Строки+1;
   
end;


     ОткрытиеТаблицы_Книги("fm_cli_symb.xls");
     ИнициализацияЛистов(ЧислоЛистов);

     ws(1).Activate;/*можно писать в этот лист*/
     ob.Visible=false;

  legalform = Menu(m_menu_lf, "По кому выпускаем отчет?","По кому выпускаем отчет?",null,null);
  if (legalform < 0)
    exit(1);
  elif (legalform == 0)
     legalform = 1;
  else
     legalform = 2;
  end;

//Lavrenov: 20.06.2012 I-00210299-1 Добавил еще одну менюшку
  dep_kind = Menu(m_menu_dep, "Способ выпуска отчета","Способ выпуска отчета",null,null);
  if (dep_kind < 0)
    exit(1);
  end;

  startDate = {curdate} - 1;
  if ( not GetDate( startDate, "Введите начальную дату отчета :" ) )
    exit(1);
  else
    if (startDate > {curdate}) // 13.11.2014 joy R-493406 возможность выпуска отчета за текущую дату 
      msgbox("Значение даты "+string(startDate)+" введено неверно !!!");
      exit(1);
    end;

    if(startdate == date(0,0,0))
       startdate = "01.01.0001";
    end;
  end;

  endDate = startDate;
  if ( not GetDate( endDate, "Введите конечную дату отчета :" ) )
    exit(1);
  else
    if (startDate > endDate)
      msgbox("Значение даты "+string(endDate)+" введено неверно !!!");
      exit(1);
    end;
  end;

  if(not listdepartment(dep))
      msgbox("Не выбрано подразделение");
      exit(1);
  end;
  
//DPN: 06.08.2013 I-00409153-2
  if (dep.code == 1)
    rule = Menu(m_menu_general_dep, "Уточните выбор","Подразделение имеет подчиненных, уточните выбор",null,null);
    if (rule < 0)
      exit(1);
    elif (rule == 0)
      rule = 0;
    else
      rule = 1;
    end;
  end;
  
  close(1);
  report;
  msgbox("Все! Теперь можете просмотреть полученный отчет в EXCEL","| Нажмите ESC");
  ob.Visible=true;
