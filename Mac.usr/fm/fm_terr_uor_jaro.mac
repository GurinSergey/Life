/****************************************************************************/
/*                     R-Style SoftLab, RS-Bank V6                          */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*          Работа с пользовательской таблицей dbsgvbranch_dbt              */
/*                                                                          */
/*  Имя файла: bsgvbranch.mac                                               */
/*  Создан:   19.12.08                                      Лавренов А.А.   */
/****************************************************************************/
// KS 03.10.2012 C-14283 Нечеткий поис теперь зависит от скроллинга

/*Для запсука из модуля использовать fm_terr_imp.mac */

// 13-01-2012 Жаворонкова Н. (joy) C-7958-6 Добавлено order by t.t_text в MACRO СписокТеррористов
//RR 26.2013 Ввиду отключения RSAPP2 убрана константа
//LAO 20.11.2013 Признак должен ставиться на все просканированные документы
//LAO 20.11.2013 Добавил первоначальное сканирвание по методу Джаро Винклера(процент совпадения больше 85%)
 import rsbdataset, bankinter, compare, globals, календарь, rsexts, timestat;

 

 record dlg1 (chk_ter, "fm_ter.lbr") dialog;

 var outfile, errCode;// = "..\\txtfile\\terr"+strsubst(string(date()),".","")+{oper}+".txt";

 array kinddoc;
 kinddoc(0)= "Начальные";
 kinddoc(1)= "Ответные";
 kinddoc(2)= "Внутренние";
 var start_date, end_date, doc_kind, prizn;
 var count = 0;

macro STR_LPad (st, len, c, td)
private var n;
  if (Valtype(td) == V_Undef)
     td = FALSE;
  end;
  n = StrLen(st);
  while (n < len)
     st = c + st;
     n = StrLen(st);
  end;
  if(td and (n > len))
    st = SubStr(st, n - len + 1)
  end;
  return st;
end;


// KS 03.10.2012 C-14283 Нечеткий поис теперь зависит от скроллинга
// MACRO ШАПКА(startdate, enddate, dockind)
 MACRO ШАПКА(startdate, enddate, dockind, ScrolStates);
  var str1, str2;
  str1 = substr(strlwr(dockind),1,strlen(dockind)-1)+"х";
  if(startdate==enddate)
     str2 = "за "+ startdate +" г.";
  elif(startdate==date("00.00.0000"))
     str2 =  "за период 00.00.0000 - "+ enddate +" г.";
  else
     str2 =  "за период "+ startdate +" - "+ enddate +" г.";
  end;


// KS 03.10.2012 C-14283 Добавил поле Режим выпуска
  [                                   Список ########### документов, совпадающих с перечнем экстремистов и лиц причастных к терроризму    #
   Режим выпуска: #
  --------------T-------------T---------T--------------T------------------T--------------------------------------------------------------------------------T-------T-------------------------T---------┐
  │ Код клиента │ Код клиента │  № Док. │     Дата     │      Сумма       │                             Стоп фраза                                         │  Коэф.│   Имя поля документа    │   Вид   │
  │ плательщика │ получателя  │         │              │                  │                                                                                │       │                         │документа│
](str1:c,
  str2,
  ternary(((ValType(ScrolStates) != 26) and (ScrolStates == 10)),"по закрытым документам","по открытым документам")
  );

 END;

/* MACRO СписокТеррористов(stopfrase)
  var rs, str, itogstring;
  str = "SELECT t.* " +
        "  FROM dstopfrase_dbt sf, dterrinfo_dbt t " +
        " WHERE t.t_terroristid = sf.t_terroristid " +
        "   AND t.t_number = 1 " +
        "   AND sf.t_stopfrase = '"+stopfrase+"' " ;
 [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+];
//   msgbox(str);
   rs = trsbdataset(str);
   while(rs and rs.movenext)
      itogstring = rs.T_NAME;
      if(strlen(rs.T_ADDRESS)>0)    
         itogstring = itogstring + " Адрес: "+ rs.T_ADDRESS;
      end;
      if(strlen(rs.T_NAMEDOCUM)>0)    
         itogstring = itogstring + " Документ: "+ rs.T_NAMEDOCUM;
      end;
      if(strlen(rs.T_PAPERSERIES)>0)    
         itogstring = itogstring + " Серия: "+ rs.T_PAPERSERIES;
      end;
      if(strlen(rs.T_PAPERNUMBER)>0)    
         itogstring = itogstring + " Номер: "+ rs.T_PAPERNUMBER;
      end;
      if(strlen(rs.T_OKPO)>0)    
         itogstring = itogstring + " ОКПО: "+ rs.T_OKPO;
      end;
      if(strlen(rs.T_REGNUMBER)>0)    
         itogstring = itogstring + " Рег. номег: "+ rs.T_REGNUMBER;
      end;
      if(strlen(rs.T_BIRTHPLACE)>0)    
         itogstring = itogstring + " Место рождения: "+ rs.T_BIRTHPLACE;
      end;

      [│             │             │         │              │                  │################################################################################│       │                         │         │]
      (itogstring:w);
   end;
 END;
*/
 MACRO СписокТеррористов(stopfrase)
  var rs, str, itogstring;
  str = "SELECT * " +
        "  FROM dstop_dbt t " +
        " WHERE t.t_str = '"+stopfrase+"' order by t.t_text "; // 13-01-2012 Жаворонкова Н. (joy) C-7958-6 Добавлено order by t.t_text
 [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+];
//   msgbox(str);
   rs = trsbdataset(str);
   while(rs and rs.movenext)
   if(valtype(rs.text) == 0)
      itogstring = " ";
   else
      itogstring = rs.text;
   end;


      [│             │             │         │              │                  │################################################################################│       │                         │         │]
      (itogstring:w);
   end;
 END;

// KS 03.10.2012 C-14283 Нечеткий поис теперь зависит от скроллинга
//MACRO ТЕЛО(startdate, enddate, codekind, Prizn)
MACRO ТЕЛО(startdate, enddate, codekind, Prizn, ScrolStates)
 var rs, str, terr, rs1,sovp;
 var query, inside=""; 
 var cnt = 0;

 str = "SELECT pmpaym.t_valuedate, pmrmprop.t_date, pmpaym.t_amount, " +
       "       pmrmprop.t_number, " +
       "       DECODE (pmpaym.t_payer, -1, ' ', pmpaym.t_payer) t_payer, " +
       "       pmrmprop.t_payername, " +
       "       DECODE (pmpaym.t_receiver, -1, ' ', pmpaym.t_receiver) t_receiver, " +
       "       pmrmprop.t_receivername, pmrmprop.t_ground, pmpaym.t_paymentid, " +
       "       pmpaym.t_dockind, pmpaym.t_paymentid " +
       "  FROM dpmprop_dbt t, dpmpaym_dbt pmpaym, dpmrmprop_dbt pmrmprop,dstop_dbt stops " +
       " WHERE t.t_issender = CHR (0) " +
// KS 03.10.2012 C-14283 Нечеткий поис теперь зависит от скроллинга
//       "   AND t.t_group = 1 " +
//       "   AND t.t_propstatus = 3000 " +
       "   AND t.t_debetcredit = 1 " +
       "   AND t.t_group = 1 ";
 if ((ValType(ScrolStates) != 26) and (ScrolStates == 10))
   str = str +
       "   AND t.t_propstatus = 32000 " +
       "   AND t.t_corschem not in (select t_number From dcorschem_dbt c where instr(' '||c.t_userfield2||' ',' STOP ')>0) ";
 else
   str = str +
       "   AND t.t_propstatus = 3000 ";
 end;
 str = str +
// KS end 03.10.2012 C-14283
       "   AND t.t_paymentid = pmpaym.t_paymentid " +
       "   AND t.t_paymentid = pmrmprop.t_paymentid " +
       "   AND t.t_group = 1 " +
       "   AND pmpaym.t_dockind IN (16, 17, 27, 201, 202, 450, 320, 322, 311) " +
       "   AND t.t_transferdate BETWEEN TO_DATE ('"+startdate+"', 'DD.MM.YYYY') " +
       "                            AND TO_DATE ('"+enddate+"', 'DD.MM.YYYY') " +
       " AND (    LENGTH (stops.t_str) > 0 "
       "       AND stops.t_terror != 0 "
       "       AND stops.t_number != 0 "
       "       AND (utl_match.JARO_WINKLER_SIMILARITY (pmrmprop.t_payername,stops.T_NAMEU ) > 80 "
       "            OR utl_match.JARO_WINKLER_SIMILARITY (pmrmprop.t_receivername,stops.T_NAMEU) > 80 "
       "            OR utl_match.JARO_WINKLER_SIMILARITY (pmrmprop.t_ground,stops.T_NAMEU) > 80)) " ;

if(prizn == "Да")

 str = str + "AND not EXISTS ( " +
       "          SELECT * " +
       "            FROM dnotetext_dbt t " +
       "           WHERE t.t_notekind = 999 " +
       "             AND t.t_objecttype = 501 " +
//       "             AND t.t_documentid LIKE '%' || pmpaym.t_paymentid) " ;
      //Tikh Все встало!
      " AND t.t_documentid = lpad(pmpaym.t_paymentid,10,0) ) ";
end;


 terr = "SELECT DISTINCT t_str t_stopfrase, t_factor  " +
        "                  FROM dstop_dbt " +
        "                  where length (t_str) > 0 " +
        "                    and t_terror != 0 " +
        "                    and t_number != 0 " ;



debugbreak;

//  msgbox(str);
 rs = trsbdataset(str);
 initprogress(-1, "Обработка документов","Обработка документов");
 while (rs and rs.movenext)
    rs1 = trsbdataset(terr);
    while (rs1 and rs1.movenext)
        if(strlen(rs.payername) > 0)
           sovp = similarity( strlen(rs1.stopfrase), StrUpr(rs.payername), StrUpr(rs1.stopfrase));
           if(sovp > rs1.factor)
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │#############│#############│#########│##############│##################│################################################################################│#######│                         │  #####  │]
              ( rs.t_payer, rs.t_receiver, rs.t_number, substr(string(rs.t_date),1,10), rs.t_amount, rs1.stopfrase, sovp, rs.dockind:c );

              СписокТеррористов(rs1.stopfrase);

              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │             │             │         │              │                  │################################################################################│       │ ####################### │         │]
              (rs.t_payername:w, "Плательщик");

              count = count + 1;
          /*    if(prizn== "Да")
                 addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
              end;*/
           end;
        end;

        if(strlen(rs.receivername) > 0)
           sovp = similarity( strlen(rs1.stopfrase), StrUpr(rs.receivername), StrUpr(rs1.stopfrase));
           if(sovp > rs1.factor)
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │#############│#############│#########│##############│##################│################################################################################│#######│                         │  #####  │]
              ( rs.t_payer, rs.t_receiver, rs.t_number, substr(string(rs.t_date),1,10), rs.t_amount, rs1.stopfrase, sovp, rs.dockind:c );

              СписокТеррористов(rs1.stopfrase);

              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │             │             │         │              │                  │################################################################################│       │ ####################### │         │]
              (rs.t_receivername:w, "Получатель");

              count = count + 1;
          /*    if(prizn== "Да")
                 addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
              end;*/
           end;
        end;
 
        if(strlen(rs.ground) > 0)
           sovp = similarity( strlen(rs1.stopfrase), StrUpr(rs.ground), StrUpr(rs1.stopfrase));
           if(sovp > rs1.factor)
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │#############│#############│#########│##############│##################│################################################################################│#######│                         │  #####  │]
              ( rs.t_payer, rs.t_receiver, rs.t_number, substr(string(rs.t_date),1,10), rs.t_amount, rs1.stopfrase, sovp, rs.dockind:c );

              СписокТеррористов(rs1.stopfrase);

              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │             │             │         │              │                  │################################################################################│       │ ####################### │         │]
              (rs.t_ground:w, "Основание");

              count = count + 1;
            /*  if(prizn== "Да")
                 addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
              end;*/
           end;
        end;

    end;
    //20.11.2013 Если признак Да, тогда отметим отсканированные документы.
    if(prizn== "Да")
        addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
    end;
    useprogress(cnt);
    cnt = cnt+1;
 end;
 remprogress;
END;


MACRO ТАПКИ()
[+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+  
 │ ИТОГО       │  ####################   записей отобрано                                                                                                                                             │ 
 L-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+]
 (count);

END;

//Обработчик для панели
 macro fm_ter_dlg (dlg, cmd, id, key)
   var choice;
   if ( cmd == DLG_INIT )
      dlg.startdate = {curdate};
      dlg.enddate   = {curdate};
      dlg.dockind   = "Начальные";
      dlg.prizn     = "Да";
      DisableFields(dlg,2);
      message("Esc Выход F3 Список Пробел Переключение F2(F9) Запуск ");
      UpdateFields(dlg);
   elif ( cmd == DLG_REMFOCUS ) 
      if (id==0)
         UpdateFields(dlg);
      elif (id==1)
         UpdateFields(dlg);
      end;
      return CM_IGNORE;

   elif( cmd == DLG_KEY ) //Проверки на нажатие клавиш
      if( key == 27 ) //Esc
         exit(1);
         return CM_CANCEL;
      elif ( key == 32 ) //Пробел
      if (id==3)
         if(dlg.prizn=="Да")
             dlg.prizn="Нет"
         else
             dlg.prizn="Да"
         end;
      end;
        UpdateFields(dlg);
      elif ( key == 317 ) //F3
      if (id==0)
        dlg.startdate = getdatebycalendar(dlg.startdate);
        UpdateFields(dlg);
      elif (id==1)
        dlg.enddate = getdatebycalendar(dlg.enddate);
        UpdateFields(dlg);
      elif (id==2)
        choice = menu(kinddoc,"","Вид документов");
        if(choice >=0)
        dlg.dockind = kinddoc(choice);
        end;
        UpdateFields(dlg);
      end;

         return CM_IGNORE;
      elif ( (key == 316) or (key == 323) ) //F2 F9
         
         if(dlg.startdate == "")
            start_date = "01.01.0001";
         else
            start_date = dlg.startdate;
         end; 
         if(dlg.enddate == "")
            end_date = "01.01.0001";
         else
            end_date   = dlg.enddate;
         end; 
         doc_kind   = dlg.dockind;
         prizn      = dlg.prizn;

         return CM_SAVE;
      end;
   end;
   return CM_DEFAULT;
 END;

// KS 03.10.2012 C-14283 Нечеткий поис теперь зависит от скроллинга
macro fm_run(ScrolStates)

  outfile = GetTxtFileName ("terr"+strsubst(strsubst(string(date),".","")," ","0")+strsubst(string(time),":",""));

  //пересоздаем файл
  setoutput(outfile,false);
  setoutput(null,true);

  RunDialog (dlg1, @fm_ter_dlg);

  SaveBeginTime();//Старт

  setoutput(outfile,true);
// KS 03.10.2012 C-14283 Нечеткий поис теперь зависит от скроллинга
//  ШАПКА(start_date, end_date, doc_kind);
//  ТЕЛО(start_date, end_date, doc_kind, prizn);
  ШАПКА(start_date, end_date, doc_kind, ScrolStates);
  ТЕЛО(start_date, end_date, doc_kind, prizn, ScrolStates);
  ТАПКИ();
  setoutput(null,true);
  viewfile(outfile);

  SaveEndTime (4); //Конец

end;


//fm_run();


  
