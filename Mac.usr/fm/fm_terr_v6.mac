/****************************************************************************/
/*                     R-Style SoftLab, RS-Bank V6                          */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*          Работа с пользовательской таблицей dbsgvbranch_dbt              */
/*                                                                          */
/*  Имя файла: bsgvbranch.mac                                               */
/*  Создан:   19.12.08                                      Лавренов А.А.   */
/****************************************************************************/

 import rsbdataset, bankinter, compare, globals, календарь, rsexts, ptinter, ActX;

 var ЧислоЛистов=1,      
      File_Name="";

 var Код_Ячейки="";
 var Номер_Строки  = 2,  /*с которой начинается заполнение данных*/
     лист = 1;

 

 record dlg (chk_ter, "fm_ter.lbr") dialog;

 var outfile, ecode;// = "..\\txtfile\\terr"+strsubst(string(date()),".","")+{oper}+".txt";

 array kinddoc;
 kinddoc(0)= "Начальные";
 kinddoc(1)= "Ответные";
 kinddoc(2)= "Внутренние";
 var start_date, end_date, doc_kind, prizn;
 var doc_cnt = 0, ground_cnt = 0;

macro STR_LPad (st, len, c, td)
private var n;
  if (Valtype(td) == V_Undef)
     td = FALSE;
  end;
  n = StrLen(st);
  while (n < len)
     st = c + st;
     n = StrLen(st);
  end;
  if(td and (n > len))
    st = SubStr(st, n - len + 1)
  end;
  return st;
end;


 MACRO ШАПКА(startdate, enddate, dockind)
  var str1, str2;
  str1 = substr(strlwr(dockind),1,strlen(dockind)-1)+"х";
  if(startdate==enddate)
     str2 = "за "+ startdate +" г.";
  elif(startdate==date("00.00.0000"))
     str2 =  "за период 00.00.0000 - "+ enddate +" г.";
  else
     str2 =  "за период "+ startdate +" - "+ enddate +" г.";
  end;

  [                                    Отчет совпадений ########### документов с перечнем  экстремистов и лиц, причастных к терроризму #

  --------------T-------------T---------T--------------T------------------T--------------------------------------------------------------------------------T-------T-------------------------T---------┐
  │ Код клиента │ Код клиента │  № Док. │     Дата     │      Сумма       │                             Стоп фраза                                         │  Коэф.│   Имя поля документа    │   Вид   │
  │ плательщика │ получателя  │         │              │                  │                                                                                │       │                         │документа│
](str1:c, str2);

 END;

 MACRO СписокТеррористов(id, nameid, kind)
  var rs, str, itogstring;
  if(kind == 1)
  str =  "SELECT t.*, k.t_name, k.t_nameid " +
         "FROM dterrinfo_dbt t, dterr_kfm_aka_dbt k " +
         "WHERE     t.t_number = 1 " +
         "      AND k.t_terroristid = t.t_terroristid " +
         "      AND t.t_terroristid =  "+id+ 
         "      AND k.t_nameid =  "+nameid; 

  else
  str = "SELECT t.* " +
        "  FROM dterror_dbt t " +
        " WHERE t.t_entnum =  "+id ;
  end;
 [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+];
//   msgbox(str);
   rs = trsbdataset(str);
   while(rs and rs.movenext)
    if(kind == 1)

      itogstring = rs.T_NAME;
      if(strlen(rs.T_ADDRESS)>0)    
         itogstring = itogstring + " Адрес: "+ rs.T_ADDRESS;
      end;
      if(strlen(rs.T_NAMEDOCUM)>0)    
         itogstring = itogstring + " Документ: "+ rs.T_NAMEDOCUM;
      end;
      if(strlen(rs.T_PAPERSERIES)>0)    
         itogstring = itogstring + " Серия: "+ rs.T_PAPERSERIES;
      end;
      if(strlen(rs.T_PAPERNUMBER)>0)    
         itogstring = itogstring + " Номер: "+ rs.T_PAPERNUMBER;
      end;
      if(strlen(rs.T_OKPO)>0)    
         itogstring = itogstring + " ОКПО: "+ rs.T_OKPO;
      end;
      if(strlen(rs.T_REGNUMBER)>0)    
         itogstring = itogstring + " Рег. номег: "+ rs.T_REGNUMBER;
      end;
      if(strlen(rs.T_BIRTHPLACE)>0)    
         itogstring = itogstring + " Место рождения: "+ rs.T_BIRTHPLACE;
      end;
    else
      itogstring = rs.t_name;
    end;
      [│             │             │         │              │                  │################################################################################│       │                         │         │]
      (itogstring:w);
      Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, itogstring);
      Номер_Строки=Номер_Строки+1;  
   end;
 END;


MACRO ТЕЛО(startdate, enddate, codekind, Prizn)
 var rs, str, terr, rs1,sovp;
 var query, inside=""; 
 var cnt = 0; 

 // EVG 31/1/2014 Переход на 2031 {SelfId} -> {OurBank}
 if (codekind == "Начальные")
   query = " (t_dockind >322 or t_dockind < 320) and t_receiverbankid != "+ {OurBank} ;
 elif(codekind == "Ответные")
   query = " t_dockind in (320, 322) " ;
 else //Внутренние
   query = " (t_dockind >322 or t_dockind < 320) and t_receiverbankid = "+ {OurBank} ;

 end;

 str = "SELECT pm.t_valuedate, rm.t_date, pm.t_amount, rm.t_number, decode(pm.t_payer,-1,' ',pm.t_payer) t_payer, " +
       "       rm.t_payername, decode(pm.t_receiver,-1,' ',pm.t_receiver) t_receiver, rm.t_receivername, rm.t_ground, " +
       "       pm.t_paymentid, pm.t_dockind, pm.t_paymentid " +
       "  FROM dpmpaym_dbt pm, dpmrmprop_dbt rm " +
       " WHERE " + query +
       "   AND rm.t_paymentid = pm.t_paymentid " +
       "   AND pm.t_valuedate BETWEEN TO_DATE ('"+startdate+"', 'dd.mm.yyyy') " +
       "                          AND TO_DATE ('"+enddate+"', 'dd.mm.yyyy') " ;



 terr = "SELECT t.t_terroristid, t.t_nameid,  " +
        "       DECODE (SUBSTR (t.t_name, 1, INSTR (t.t_name, '(') - 2),  " +
        "               '', t_name,  " +
        "               SUBSTR (t.t_name, 1, INSTR (t.t_name, '(') - 2)  " +
        "              ) t_name,  " +
        "       0.7 t_factor, 1 t_kind  " +
        "  FROM dterr_kfm_aka_dbt t, dterrinfo_dbt i   " +
        " WHERE T.T_TERRORISTID = I.T_TERRORISTID " +
        "   and I.T_NUMBER = 1     " +
        "   and DECODE (SUBSTR (t_name, 1, INSTR (t_name, '(') - 2),  " +
        "            '', t_name,  " +
        "            SUBSTR (t_name, 1, INSTR (t_name, '(') - 2)) != CHR (1) ";

/*        "UNION ALL " +
        "SELECT t_entnum t_terroristid, t_name, 1 t_factor, 2 t_kind " +
        "  FROM dterror_dbt " ;*/





 doc_cnt = 0; ground_cnt = 0;
//  debugbreak;
 rs = trsbdataset(str);
 initprogress(-1, "Обработка документов","Обработка документов");
 while (rs and rs.movenext)
    rs1 = trsbdataset(terr);
    while (rs1 and rs1.movenext)
        if(strlen(rs.payername) > 0)
           sovp = similarity( strlen(rs1.t_name), StrUpr(rs.payername), StrUpr(rs1.t_name));
           if(sovp >= rs1.t_factor)
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │#############│#############│#########│##############│##################│################################################################################│#######│                         │  #####  │]
              ( rs.t_payer, rs.t_receiver, rs.t_number, substr(string(rs.t_date),1,10), rs.t_amount, rs1.t_name, sovp, rs.dockind:c );
              Код_Ячейки ="A"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодсубъекта(int(rs.t_payer),1));
              Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодсубъекта(int(rs.t_receiver),1));
              Код_Ячейки ="C"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_number);
              Код_Ячейки ="D"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, substr(string(rs.t_date),1,10));
              Код_Ячейки ="E"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_amount);
              Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs1.t_name);
              Код_Ячейки ="G"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, sovp);
              Код_Ячейки ="I"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.dockind);
              Номер_Строки=Номер_Строки+1;  

              СписокТеррористов(rs1.t_terroristid, rs1.t_nameid, rs1.t_kind );

              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │             │             │         │              │                  │################################################################################│       │ ####################### │         │]
              (rs.t_payername:w, "Плательщик");
              Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_payername);
              Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, "Плательщик");
              Номер_Строки=Номер_Строки+1; 

              doc_cnt = doc_cnt+1;

              if(prizn== "Да")
                 addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
              end;

           end;
        end;

        if(strlen(rs.receivername) > 0)
           sovp = similarity( strlen(rs1.t_name), StrUpr(rs.receivername), StrUpr(rs1.t_name));
           if(sovp >= rs1.t_factor)
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │#############│#############│#########│##############│##################│################################################################################│#######│                         │  #####  │]
              ( rs.t_payer, rs.t_receiver, rs.t_number, substr(string(rs.t_date),1,10), rs.t_amount, rs1.t_name, sovp, rs.dockind:c );

              Код_Ячейки ="A"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодсубъекта(int(rs.t_payer),1));
              Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодсубъекта(int(rs.t_receiver),1));
              Код_Ячейки ="C"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_number);
              Код_Ячейки ="D"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, substr(string(rs.t_date),1,10));
              Код_Ячейки ="E"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_amount);
              Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs1.t_name);
              Код_Ячейки ="G"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, sovp);
              Код_Ячейки ="I"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.dockind);
              Номер_Строки=Номер_Строки+1;   
              СписокТеррористов(rs1.t_terroristid, rs1.t_nameid, rs1.t_kind );
             
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │             │             │         │              │                  │################################################################################│       │ ####################### │         │]
              (rs.t_receivername:w, "Получатель");
              Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_receivername);
              Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, "Получатель");
              Номер_Строки=Номер_Строки+1; 

              doc_cnt = doc_cnt+1;

              if(prizn== "Да")
                 addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
              end;
           end;
        end;
 
        if(strlen(rs.ground) > 0)
           sovp = similarity( strlen(rs1.t_name), StrUpr(rs.ground), StrUpr(rs1.t_name));
           if(sovp >= rs1.t_factor)
              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │#############│#############│#########│##############│##################│################################################################################│#######│                         │  #####  │]
              ( rs.t_payer, rs.t_receiver, rs.t_number, substr(string(rs.t_date),1,10), rs.t_amount, rs1.t_name, sovp, rs.dockind:c );

              Код_Ячейки ="A"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодсубъекта(int(rs.t_payer),1));
              Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, получитькодсубъекта(int(rs.t_receiver),1));
              Код_Ячейки ="C"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_number);
              Код_Ячейки ="D"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, substr(string(rs.t_date),1,10));
              Код_Ячейки ="E"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_amount);
              Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs1.t_name);
              Код_Ячейки ="G"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, sovp);
              Код_Ячейки ="I"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.dockind);
              Номер_Строки=Номер_Строки+1;   
              СписокТеррористов(rs1.t_terroristid, rs1.t_nameid, rs1.t_kind );

              [+-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+---------+
               │             │             │         │              │                  │################################################################################│       │ ####################### │         │]
              (rs.t_ground:w, "Основание");
              Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_ground);
              Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, "Основание");
              Номер_Строки=Номер_Строки+1;

              doc_cnt = doc_cnt+1;

              if(prizn== "Да")
                 addNoteForObject (501, str_lpad(rs.paymentid, 10, "0"), 999, "X");
              end;
           end;
        end;

    end;
    useprogress(cnt);
    cnt = cnt+1;
 end;
 remprogress;
END;

MACRO ТЕЛО2()
  FILE src      () TXT;
  if(not open(Src, outfile) )
     Msgbox("Не найден файл", outfile);
     exit();
  end;

  rewind(Src);
  while(next(src))
     println(src.str);
  end;

  close(Src);
  //removefile(outfile);

END;

MACRO ТАПКИ(cnt)
[L-------------+-------------+---------+--------------+------------------+--------------------------------------------------------------------------------+-------+-------------------------+----------
   Итого отобрано записей: ################## ](cnt:l);
END;

//Обработчик для панели
 macro fm_ter_dlg (dlg, cmd, id, key)
   var choice;
   if ( cmd == DLG_INIT )
      dlg.startdate = {curdate};
      dlg.enddate   = {curdate};
      dlg.dockind   = "Начальные";
      dlg.prizn     = "Нет";
      message("Esc Выход F3 Список Пробел Переключение F2(F9) Запуск ");
      UpdateFields(dlg);
   elif ( cmd == DLG_REMFOCUS ) 
      if (id==0)
         UpdateFields(dlg);
      elif (id==1)
         UpdateFields(dlg);
      end;
      return CM_IGNORE;

   elif( cmd == DLG_KEY ) //Проверки на нажатие клавиш
      if( key == 27 ) //Esc
         exit(1);
         return CM_CANCEL;
      elif ( key == 32 ) //Пробел
      if (id==3)
         if(dlg.prizn=="Да")
             dlg.prizn="Нет"
         else
             dlg.prizn="Да"
         end;
      end;
        UpdateFields(dlg);
      elif ( key == 317 ) //F3
      if (id==0)
        dlg.startdate = getdatebycalendar(dlg.startdate);
        UpdateFields(dlg);
      elif (id==1)
        dlg.enddate = getdatebycalendar(dlg.enddate);
        UpdateFields(dlg);
      elif (id==2)
        choice = menu(kinddoc,"","Вид документов");
        if(choice >=0)
        dlg.dockind = kinddoc(choice);
        end;
        UpdateFields(dlg);
      end;

         return CM_IGNORE;
      elif ( (key == 316) or (key == 323) ) //F2 F9
         start_date = dlg.startdate;
         end_date   = dlg.enddate;
         doc_kind   = dlg.dockind;
         prizn      = dlg.prizn;

         return CM_SAVE;
      end;
   end;
   return CM_DEFAULT;
 END;


  macro go()
  RunDialog (dlg, @fm_ter_dlg);
  ОткрытиеТаблицы_Книги("fm_terr.xls");
  ИнициализацияЛистов(ЧислоЛистов);
   
  ws(1).Activate;/*можно писать в этот лист*/
  ob.Visible=false;
  
  ШАПКА(start_date, end_date, doc_kind);
  ТЕЛО(start_date, end_date, doc_kind, prizn);
  ТАПКИ(doc_cnt);

  msgbox("Все! Теперь можете просмотреть полученный отчет в EXCEL","| Нажмите ESC");
  ob.Visible=true;
  end;

  go;





  
