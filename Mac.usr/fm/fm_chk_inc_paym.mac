import rsbdataset, globals, ptinter, ActX;

array m_menu;
      m_menu(0)="Платежи, поступившие от физических лиц";
      m_menu(1)="Платежи, поступившие от индивидуальных предпринимателей";
      m_menu(2)="Платежи, поступившие от юридических лиц";


 var ЧислоЛистов=1,      
      File_Name="";

 var Код_Ячейки="";
 var Номер_Строки  = 4,  /*с которой начинается заполнение данных*/
     лист = 1;


MACRO GetData(start, endd, sum, kind)

var rs, str, str2, cnt=0;
var newcode, oldcode, isfirst = true, summ=$0;
 str = "SELECT pr.t_date, pr.t_number, DECODE (SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1), NULL, pr.t_payerinn,  " +
       "       SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1)) t_payerinn, pr.T_PAYERNAME,  pm.t_payer, pm.t_payeraccount, " +
       "       pm.t_amount " +
       "  FROM dpmpaym_dbt pm, dpmrmprop_dbt pr " +
       " WHERE pr.t_paymentid = pm.t_paymentid " +
       "   AND pm.t_dockind IN (320, 322) " +
       "   AND pm.t_paymstatus = 32000 " +
       "   AND pm.t_valuedate BETWEEN TO_DATE ('"+start+"', 'dd.mm.yyyy') " +
       "                          AND TO_DATE ('"+endd+"', 'dd.mm.yyyy') " +
       "   AND pm.t_amount > " +sum +
       "   AND pm.t_fiid = 0 " ;
  if(kind == 0)

 str = str + "   AND (   SUBSTR (pm.t_payeraccount, 1, 3) IN ('423', '426', '303') " +
             "        OR SUBSTR (pm.t_payeraccount, 1, 5) IN ('40817', '40820', '40911')) " +
             "   AND LENGTH (DECODE (SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1), NULL, pr.t_payerinn,  " +
             "                       SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1))) != 12 " ;
  elif(kind == 1)

 str = str + "   AND pm.t_payeraccount like '40802%' " +
             "   AND LENGTH (DECODE (SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1), NULL, pr.t_payerinn,  " +
             "                       SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1))) != 12 " ;
  else
 str = str + "   AND (   SUBSTR (pm.t_payeraccount, 1, 3) not IN ('423', '426', '303') " +
             "        and SUBSTR (pm.t_payeraccount, 1, 5) not IN ('40817', '40802', '40820', '40911')) " +
             "   AND LENGTH (DECODE (SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1), NULL, pr.t_payerinn,  " +
             "                       SUBSTR (pr.t_payerinn, 1,INSTR (pr.t_payerinn, '/') - 1))) != 10 " ;
  end;
 str = str + " order by pr.t_date, pr.t_payerinn, pm.t_amount  ";

  rs = trsbdataset(str);


  if(start==endd)
     str2 = "за "+ start +" г.";
  elif(start==date("00.00.0000"))
     str2 =  "за период 00.00.0000 - "+ endd +" г.";
  else
     str2 =  "за период "+ start +" - "+ endd +" г.";
  end;



  Запись_ячейка(1,"B1",m_menu(kind));
  Запись_ячейка(1,"B2",str2);
(str2);




  while (rs and rs.movenext)
    cnt = cnt+1;
    summ = summ + money(rs.t_amount);

  Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, cnt);
  Код_Ячейки ="C"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, date(rs.t_date));
  Код_Ячейки ="D"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_number);
  Код_Ячейки ="E"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_payerinn);
  Код_Ячейки ="F"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_PAYERNAME);// ПолучитьКодСубъекта(rs.t_payer,1));
  Код_Ячейки ="G"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, rs.t_payeraccount);
  Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(rs.t_amount));

  Номер_Строки=Номер_Строки+1;
end;


//  (summ);

  Код_Ячейки ="B"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, "Итого");
  Код_Ячейки ="H"+Номер_Строки;  Запись_ячейка(1,Код_Ячейки, money(summ));

end;




 var startdate, enddate, promt, summ=$15000;
  startDate = {curdate} - 1;

     ОткрытиеТаблицы_Книги("fm_chk_inc_paym.xls");
     ИнициализацияЛистов(ЧислоЛистов);


   promt = menu(m_menu, "Какой отчет выпускаем?","Какой отчет выпускаем?",null,null);
   if (promt < 0)
      exit(1);
   end;


  if ( not GetDate( startDate, "Введите начальную дату отчета :" ) )
    exit(1);
  else
    if (startDate >= {curdate})
      msgbox("Значение даты "+string(startDate)+" введено неверно !!!");
      exit(1);
    end;

    if(startdate == date(0,0,0))
       startdate = "01.01.0001";
    end;
  end;

  endDate = startDate;
  if ( not GetDate( endDate, "Введите конечную дату отчета :" ) )
    exit(1);
  else
    if (startDate > endDate)
      msgbox("Значение даты "+string(endDate)+" введено неверно !!!");
      exit(1);
    end;
  end;
    
  ws(1).Activate;/*можно писать в этот лист*/
  ob.Visible=false;

  GetData(startdate, enddate, summ, promt);
  
  msgbox("Все! Теперь можете просмотреть полученный отчет в EXCEL","| Нажмите ESC");
  ob.Visible=true;
  exit(1);