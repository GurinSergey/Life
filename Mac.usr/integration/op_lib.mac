/*
Seleznev
общие функции для макросов операции

*/
//22.05.2012 Chesnokov D.S. C-10370 Отправка писем в лотус по зачислению пенсий
//13.08.2013 C-22144-6 отправка уведомлений для инкассовых поручений и платежных требований LAO
// KS 22.11.2013 Предварительная адаптация под 31ю сборку
//25.11.2014 Chesnokov D.S. Debugbreak утомил до безобразия, зло должно быть изгнано

import pm_common, OprInter, BankInter;
import lib_pm_check;

// KS 10.11.2011 Шифры - виды для пойдем
import "fg_Life_parm.mac";

macro iscashdoc (PaymentObj)

   if ((PaymentObj.DocKind == CASH_BOF_ADDORDER) or
       (PaymentObj.DocKind == CASH_BOF_INCORDER) or
       (PaymentObj.DocKind == CASH_BOF_OUTORDER) or
       (PaymentObj.DocKind == CASH_PS_INCORDER) or
       (PaymentObj.DocKind == CASH_PS_OUTORDER))
      return true;
   end;

   return false;

end;


macro GetPrimObj(PaymentObj)

   var obj:object;

   if( PaymentObj.DocKind == DLDOC_MEMORIALORDER )
      obj = GenObject( "RsbMemorialOrder", PaymentObj.DocumentID );
   /* EVG Пока добавил PS_CPORDER*/
   elif ( PaymentObj.DocKind == PS_PAYORDER )
      obj = GenObject( "RsbPsPayOrder", PaymentObj.DocumentID );
   elif (PaymentObj.DocKind == CB_MULTYDOC )
      obj = GenObject( "RsbMultyDoc", PaymentObj.DocumentID );

   /* EVG Добавил недостающие виды документов */

   /* Кассовые документы */
   elif ( PaymentObj.DocKind == CASH_PS_INCORDER )
      obj = GenObject( "RsbPSInCashOrder", PaymentObj.DocumentID );
   elif ( PaymentObj.DocKind == CASH_PS_OUTORDER )
      obj = GenObject( "RsbPSOutCashOrder", PaymentObj.DocumentID );

   /* Платёж и требование банка */
   elif ( PaymentObj.DocKind == DLDOC_BANKPAYMENT )
      obj = GenObject( "RsbBankPayment", PaymentObj.DocumentID );
   elif ( PaymentObj.DocKind == DLDOC_BANKCLAIM )
      obj = GenObject( "RsbBankClaim", PaymentObj.DocumentID );
   /* Валютный клиентский платёж */
   elif ( PaymentObj.DocKind == PS_CPORDER )
      obj = GenObject( "RsbPsCpOrder", PaymentObj.DocumentID );
   /* Валютный платёж банка */
   elif  ( PaymentObj.DocKind == BBANK_CPORDER )
      obj = GenObject( "RsbBbCpOrder", PaymentObj.DocumentID );
   elif( PaymentObj.DocKind == CASH_BOF_ADDORDER )
      obj = GenObject( "RsbBBAddCashOrder", PaymentObj.DocumentID );
   elif( PaymentObj.DocKind == CASH_BOF_INCORDER )
     obj = GenObject( "RsbBBIncCashOrder", PaymentObj.DocumentID );
   elif( PaymentObj.DocKind == CASH_BOF_OUTORDER )
      obj = GenObject( "RsbBBOutCashOrder", PaymentObj.DocumentID );
   elif( PaymentObj.DocKind == CASH_PS_INCORDER )
      obj = GenObject( "RsbPSInCashOrder" , PaymentObj.DocumentID );
   elif ( PaymentObj.DocKind == 200 )
      obj = GenObject( "RsbBuyCurrencyOrder", PaymentObj.DocumentID );
   // TAM 12.10.2012 I-00267440-2
   elif ( PaymentObj.DocKind == 203 )
      obj = GenObject( "RsbRequestOrder", PaymentObj.DocumentID );
   //TAM 15.10.2012 I-00268730-1
   elif ( PaymentObj.DocKind == DLDOC_BANKORDER)
      obj = GenObject( "RsbBankOrder", PaymentObj.DocumentID );
   //TAM 21.11.2014 I-00533751-2
   elif ( PaymentObj.DocKind == 288)
      obj = GenObject( "RsbValueTransOrder", PaymentObj.DocumentID );
   /*else
     msgbox("Неверный тип документа  " + PaymentObj.DocKind + "!!!!");  */
   else //CASH_PS_OUTORDER
      obj = GenObject( "RsbPSOutCashOrder", PaymentObj.DocumentID );
   //end TAM 12.10.2012 I-00267440-2
   end;

   /* EVG */
   //Str!
   If ((paymentObj.Dockind==WL_INDOC) or (paymentObj.Dockind==322))
      //TAM 15.10.2012 I-00268730 - вынесено выше для банковского ордера, чтобы было правильно.
      // or (PaymentObj.DocKind==DLDOC_BANKORDER))// KS 01.08.2011 Для банковского ордера
      obj=paymentObj;
   End;

   return obj;

end;

macro getkindcarry (PaymentObj, shifr_op, kind_op)

   //Процедура определения шифра и вида операции для проводки

   private var prim_doc;
   private var shifr, kind;

  private  var fgBank = fg_life_subject({OurBank});

      debugbreak;
   if (PaymentObj.DocKind == PS_PAYORDER)

      prim_doc = GetPrimObj(PaymentObj);

      if (PaymentObj.IsExternal)
         kind = " 1";      // внешний документ
      else
         kind = " 6";      // внутренний документ
      end;

      if (prim_doc.dockind == PSPOKIND_ORDER)

         if (PaymentObj.ShifrOper == "16")
            shifr = "16"; //Списано, зачислено по платежному ордеру
//Kozina ПРББ не использует вид документа ИП. ПО с шифром 06 будет формировать проводку с шифром 06
         elif (PaymentObj.ShifrOper == "06")
            shifr = "06"; //Оплачено, зачислено по инкассовому поручению
         elif (PaymentObj.ShifrOper == "02")
            shifr = "02"; //Оплачено, зачислено по инкассовому поручению
         else
            shifr = "01"; //Списано, зачислено по платежному поручению
         end;

      elif (prim_doc.dockind == PSPOKIND_DEMAND) 
         shifr = "02"; //Оплачено, зачислено по платежному требованию
      elif (prim_doc.dockind == PSPOKIND_AKKREDITIV) 
         shifr = "08"; //Открытие аккредитива, зачисление сумм неиспользованного, аннулированного аккредитива
      elif (prim_doc.dockind == PSPOKIND_CASH_REQUEST)
         shifr = "09";    // Списано, зачислено по мемориальному (расходному,приходному кассовому) ордеру
         kind  = " 3";     //кассовый документ
   //Kozina иногда все-таки использует
      elif(prim_doc.dockind == PSPOKIND_REQUEST)
         shifr = "06"; //Оплачено, зачислено по инкассовому поручению
      end;

   elif ((PaymentObj.DocKind == PS_CPORDER) or (PaymentObj.DocKind == DLDOC_BANKPAYMENT) or (PaymentObj.DocKind == BBANK_CPORDER))

      shifr = "01"; //Списано, зачислено по платежному поручению
      if (PaymentObj.IsExternal)
         kind = " 1";      // внешний документ
      else
         kind = " 6";      // внутренний документ
      end;

   /* EVG 18/11/09 В мемордерах реализовано изменение Шифра/Вида по Ctrl-Z, поэтому принудительно
      возвращать Шифр/Вид к 09/6 не нужно. */
   elif ((PaymentObj.DocKind == DLDOC_MEMORIALORDER) or (PaymentObj.DocKind == DLDOC_BANKORDER)) // KS 01.08.2011 Для банковского ордера
      /* A.Gregeradsky - Доработка по запросу пользователя в рамках заявки № А52429 (для документов, приходящих из Фронта с невыясненных) */
      if(substr(PaymentObj.FuturePayerAccount,1,5) == "47416") 
        shifr = "09";
        kind = " 6";
      else
        prim_doc = GetPrimObj(PaymentObj);
        shifr = PaymentObj.ShifrOper;
        if (PaymentObj.DocKind == DLDOC_MEMORIALORDER) // KS 01.08.2011 Не нашёл вид операции
          kind  = prim_doc.Kind_Oper;
        /* EVG 3/12/2011 У банковского ордера нет поля "Вид", поэтому возвращаем просто 6 */
        elif( PaymentObj.DocKind == DLDOC_BANKORDER )
          kind  = " 6";
        end;
      end;
   elif (/* EVG (PaymentObj.DocKind == DLDOC_MEMORIALORDER) or */(PaymentObj.DocKind == CB_MULTYDOC))
      
      shifr = "09";    // Списано, зачислено по мемориальному (расходному,приходному кассовому) ордеру
      kind  = " 6";     // внутренний документ

      if (substr(PaymentObj.payeraccount,1,5) == "20202")
        if (not fgBank.is_GO) // KS 10.11.2011 Шифры Пойдём
          if (substr(PaymentObj.payeraccount,6,3) == "810")
              shifr = "04";    // Поступило
          else
              shifr = "03";    // Расход
          end;
        end;
        kind  = " 3";     // внутренний документ
      end;

      if ((substr(PaymentObj.receiveraccount,1,5) == "20202")and(fgBank.is_GO)) // KS 10.11.2011 Шифры Пойдём
        kind  = " 3";     // внутренний документ
      end;

//Tikh 2477-У
   
   elif (PaymentObj.DocKind == CASH_BOF_ADDORDER)

      shifr = "09";    // Списано, зачислено по мемориальному (расходному,приходному кассовому) ордеру
      kind  = " 3";     //кассовый документ
//LVV C-35594-7 используем шифры по умолчанию
   elif ((PaymentObj.DocKind == CASH_BOF_INCORDER) or // KS 10.11.2011 Шифры Пойдём
           (PaymentObj.DocKind == CASH_BOF_OUTORDER))
      shifr = PaymentObj.shifroper;        
      kind  = " 3";     //кассовый документ
  //кассовый документ

//Tikh 2477-У
   

     elif (PaymentObj.DocKind == CASH_PS_INCORDER)

      shifr = "04"; //Поступило наличными по объявлению на взнос наличными
      kind  = " 3";  //кассовый документ

//Tikh 2477-У

   elif (PaymentObj.DocKind == CASH_PS_OUTORDER) 
        
      shifr = "03"; //Оплачен наличными денежный чек
      kind  = " 3";  //кассовый документ
  
   // zmp 21.11.2014 R-498468-2 
   elif(PaymentObj.DocKind == 288) /*102 ордер(передача ценностей)*/

      shifr = "18"; 
      kind  = " 6"; 

   elif ((PaymentObj.DocKind == 320) or (PaymentObj.DocKind == 322))
      //Тихомиров Исправил. Для всех внешних проставлялось Авизо. Поставил на проверку валюте

//      shifr = "12";  //Зачислено на основании авизо
//      kind  = "1";   // внешний документ

      if (PaymentObj.shifroper == 12)

         /* A.Gregeradsky - доработка для документов, списываемых с невыясненных */
         if(substr(PaymentObj.FuturePayerAccount,1,5) == "47416")
           shifr = "09";
           kind  = " 6";
         else
           shifr = "12";  //Зачислено на основании авизо
           kind  = " 1";   // внешний документ
         end;
         /* End Gregeradsky */

      else /* Не Авизо */
        if(substr(PaymentObj.FuturePayerAccount,1,5) == "47416") /* A.Gregeradsky - Доработка по запросу пользователя в рамках заявки № А52429 (для документов, приходящих из Фронта с невыясненных) */
           shifr = "01";
           kind  = " 6";
        else
           if (not (PaymentObj.shifroper))
           
             shifr = "12";  //По умолчанию
             kind  = " 1";   // внешний документ

           else

// Убрал по заявке I-00142729
//             if (fgBank.is_GO) // KS 17.11.2011 Шифры Пойдём
//               shifr = "09";
//               kind  = " 6";   // внешний документ
//             else
               shifr = PaymentObj.shifroper;  //По умолчанию
               kind  = " 1";   // внешний документ
//             end;

           end;
        end;
      end;   

      //Gurin S. 15.09.2015 R-619360-2 берем с usr_pmdocs
      if (fgBank.is_PRBB and PM_IsStepExist(PaymentObj.PaymentID, 11000120, 10, "X"))
         var rs = execSqlSelect("select shifr_oper, kind_oper from usr_pmdocs where paymentid = :id " +
                                " and substr(payer_account,1,5) = '47422' and receiver_account in ('47422810900000047416','47422810133300000001')", 
                                makeArray (SQLParam ("id", PaymentObj.PaymentID)));
         if (rs.movenext())
            shifr = rs.value("shifr_oper");
            kind  = RSL_LPAD(rs.value("kind_oper"),2," ");
         end;
      end;
      
   end;
   
   /* не обработанные

   05      Оплачено, зачислено по требованию-поручению
   07      Оплачено, поступило по расчетному чеку
   10      Документы по погашению кредита, кроме поименованных выше
   11      Документы по выдаче кредита, зачислению кредита на счет, кроме поименованных выше
   13      Расчеты с применением банковских карт

   */

   setparm(1, shifr);
   setparm(2, kind);

end;

// KS 19.01.2011 I-114409 Перетереть ФИО в примечании
macro UpdNoteForPayment_txt(paymentid, noteid, text)
   private var cmd = RSDCommand("update dnotetext_dbt"+
                                "   set  t_oper=?,"+
                                "        t_date=?,"+
                                "        t_text=RPAD (UTL_RAW.cast_to_raw (?), 3000, '0')"+
                                 "where t_objecttype=501 "+
                                 "  and t_documentid=lpad (?, 10, '0')"+
                                 "  and t_notekind=?");

   cmd.addparam("oper",   RSDBP_IN,{oper});
   cmd.addparam("curdate",RSDBP_IN,{curdate});
   cmd.addparam("text",   RSDBP_IN,text);
   cmd.addparam("pmid",   RSDBP_IN,paymentid);
   cmd.addparam("noteid", RSDBP_IN,noteid);
   cmd.execute();
end;

// KS 12.10.2011 Удаление примечания
macro DelNoteForPayment(paymentid, noteid)
   private var cmd = RSDCommand("delete from dnotetext_dbt "+
                                 "where t_objecttype=501 "+
                                 "  and t_documentid=lpad (?, 10, '0')"+
                                 "  and t_notekind=?");
   cmd.addparam("pmid",   RSDBP_IN,paymentid);
   cmd.addparam("noteid", RSDBP_IN,noteid);
   cmd.execute();
end;

macro AddNoteForPayment_txt(paymentid, noteid, text)
   private var cmd = RSDCommand("insert into dnotetext_dbt (t_id, t_objecttype,t_documentid,t_notekind,t_oper,t_date,t_time,t_text,t_validtodate,t_branch,t_numsession)"+
                                  "values   (0,501,lpad (?, 10, '0'),?,?,?,sysdate,RPAD (UTL_RAW.cast_to_raw (?), 3000, '0'),to_date('31129999','DDMMYYYY'),1,0)");

   cmd.addparam("pmid",   RSDBP_IN,paymentid);
   cmd.addparam("noteid", RSDBP_IN,noteid);
   cmd.addparam("oper",   RSDBP_IN,{oper});
   cmd.addparam("curdate",RSDBP_IN,{curdate});
   cmd.addparam("text",   RSDBP_IN,text);
   cmd.execute();
onError
   UpdNoteForPayment_txt(paymentid, noteid, text);
end;

/*Проверить счет на отправку письма в Lotus "Зачисление пенсии" С-10370*/
//Gurin S. 01.03.2016 параметризировал запрос
macro CheckPension(Account)
  
  var rs:object;
  var result:bool;
  var cmd;
  
  cmd = RsdCommand("Select 1 from dpension_dbt where t_account = ?");
  cmd.AddParam("acc", RSDBP_IN, Account);
  rs = RsdRecordset(cmd);

  if (rs and rs.movenext)
    result = true;
  else
    result = false;
  end;
  
  return result;
onError //zmp 28.07.2014 R-418310-5
  return false;  
end;

/*Создает тело письма, при зачислении на счет пенсий*/
macro GetPensLetter(Payment:RsbPayment, paymtr)

  var str, NameAcc;
  var rs:object;

  // KS 29.11.2013 Апаптация под 31ю сборку
  //rs = RsdRecordSet(" select t_nameaccount from daccounts_view where instr(t_type_account, 'П') = 0 and t_account = '" + Payment.ReceiverAccount + "'");
  rs = RsdRecordSet(" select t_nameaccount from daccount_dbt where instr(t_type_account, 'П') = 0 and t_account = '" + Payment.ReceiverAccount + "'");
  if (rs.Movenext)
    NameAcc = rs.value("t_nameaccount");
  end;
  
  if(paymtr)
    str = {curdate} + " на счет " + paymtr.AccountReceiver + " \"" + NameAcc + "\" поступило: " + paymtr.SumPayer;
    str = str + "\n Основание платежа: " + Payment.Ground + "\n Дата документа: " + Payment.ValueDate +".\n Исполнитель: " + {Oper};
  end;
  return str;
end;

//LAO 08.08.2013 C-22144 Создает тело письма, при списание для инкассовых
macro GetINKLetter(Payment:RsbPayment, paymtr,status_step)

 private var str, NameAcc;
 private var rs:object;

  // KS 29.11.2013 Апаптация под 31ю сборку
  //rs = RsdRecordSet(" select t_nameaccount from daccounts_view where instr(t_type_account, 'П') = 0 and t_account = '" + Payment.PayerAccount + "'");
  rs = RsdRecordSet(" select t_nameaccount from daccount_dbt where instr(t_type_account, 'П') = 0 and t_account = '" + Payment.PayerAccount + "'");
  if (rs.Movenext)
    NameAcc = rs.value("t_nameaccount");
  end;
  if (paymtr)
    if (status_step == "K2")
        str = {curdate} + " На К2 по счету: " + Payment.PayerAccount + " \"" + NameAcc + "\" помещен документ  на сумму: " + paymtr.SumPayer;
        str = str + "\n Основание платежа: " + Payment.Ground + "\n Дата документа: " + Payment.ValueDate +".\n Исполнитель: " + {Oper};
    elif(status_step == "PAY_K2_Мeet")  
        str = {curdate} + " Списание с К2 (частички), по  счету " + Payment.PayerAccount + " \"" + NameAcc + "\" списалось: " + paymtr.SumPayer;
        str = str + "\n Основание платежа: " + Payment.Ground + "\n Дата документа: " + Payment.ValueDate +".\n Исполнитель: " + {Oper};
    elif(status_step == "PAY_K2")  
        str = {curdate} + " Списание с К2 (полное), по  счету " + Payment.PayerAccount + " \"" + NameAcc + "\" списалось: " + paymtr.SumPayer;
        str = str + "\n Основание платежа: " + Payment.Ground + "\n Дата документа: " + Payment.ValueDate +".\n Исполнитель: " + {Oper};
    else
        str = {curdate} + " Со счета " + Payment.PayerAccount + " \"" + NameAcc + "\" списалось: " + paymtr.SumPayer;
        str = str + "\n Основание платежа: " + Payment.Ground + "\n Дата документа: " + Payment.ValueDate +".\n Исполнитель: " + {Oper};
    end;
  end;  
  return str;
end;