/***************************************************************************************************************
   Имя файла..:       check_err_pipe.mac
   Назначение.:       обработка ошибок компиляции при работе обработчиков: отпавка писем в лотус, автоматическая остановка
   Заявка.....:       C-6161
   Дата.......:       12.04.2013
   Автор......:       Лисименко Антон 
   
***************************************************************************************************************/
import lib_compare,RSD,GLOBALS, "Send_lotus.mac";
private var Email,stats;
  GetRegistryValue("PRBB\\Интерфейсы\\ERR_MAIL", V_STRING, Email, stats); 
  if (stats!=0)
   Email = "Vladimir N Golovkin/IT/Probusiness Bank@PRBB,Anton O Lisimenko/IT/Probusiness Bank@PRBB";
  end; 
  
 MACRO ClearERR
     private var cmd;
     cmd = RSDCommand("delete  from usr_error_log where t_datetime< sysdate - interval '60' minute  ");
     cmd.execute;
 end;
  private macro paste_err(Func_Type,MESS)
   var cmd;
    cmd = RSDCommand("insert into usr_error_log (T_FUNC, T_DATETIME, T_ERROR,T_OPER,T_SESSIONID) VALUES (?,sysdate,?,?,USERENV('sessionid'))");
    cmd.addparam("FUNC", RSDBP_IN, Func_Type );
    cmd.addparam("mes", RSDBP_IN, substr(MESS,1,250));
    cmd.addparam("oper", RSDBP_IN,{oper});
    cmd.execute();
    ClearERR();  
  end;
  private macro count_err() //отсекаем блокировку
   var err_count;
    err_count = rsdrecordset("SELECT   COUNT (*)  FROM  usr_error_log WHERE  T_ERROR not like '%NOWAIT%' and t_oper = "+{oper}+" AND t_datetime > SYSDATE - INTERVAL '5' MINUTE");
     if (err_count.movenext())
       return err_count.value(0);
     else
       return 0;
     end;
  end;

   macro check_stat(stat,FuncType);
   var err_stat;
   //Проверяем на то что есть ошибка, сразу отсекаем проверку связи
    if ((FuncType!=7) and (index(stat,"no_error")==0)) 
     if (regexp_like(stat,"Неверный тип значения|доступ к свойству|ORA|компиляции"))
      paste_err(FuncType,stat);
      if (count_err()>=10)
          Send_l("Внимание! Ошибки компиляции в обработчиках! "+{Name_Bank}, "Внимание!\nЗа 5 минут работы обработчиков № "+{oper}
                 +" было зафиксировано более 10 ошибок компиляции.\nОбработчик остановлен!\nДетальная информация находится в 'Мониторе обработчиков'.",73, EMAIL);
       return 1;
      end; 
     end;
    end;
   return 0;
  end;
 
onerror(x);
  return 0;

  end;
