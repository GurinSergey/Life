import rsbdataset,globals, Bankinter, cb_sql;

const REP_SUCCESS = 0;
const REP_ERROR = 1;
var rep_file_succ = GetTxtFileName("report_succ");
var rep_file_err = GetTxtFileName("report_err");
file rep_succ  () txt;
file rep_err  () txt;


macro PrintReport (type_paym, repdate)

   macro head(chapt, mode)

   if (mode == REP_SUCCESS)
     setoutput(rep_file_succ);
   elif (mode == REP_ERROR)
     setoutput(rep_file_err);
   end;

[€ €Š "à®¡¨§­¥á¡ ­ª", £.Œ®áª¢  ########## ######## ¯¥à æ¨®­¨áâ: #



]
   (date(),time(),{oper}:l);
                                                                   
[                                                                        à®â®ª®« # 
                                                             ¯à®æ¥¤ãàë ¬ áá®¢®© ¯à®¢®¤ª¨ ¤®ªã¬¥­â®¢ #.
                                                                                 §  ##########


]
   (chapt:l,type_paym:l,{curdate});
   if (mode == REP_SUCCESS)
[
ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿  
³ü ¤®ª³  áç.áç¥â ª«¨¥­â    ³       ”¨«¨ «        ³     ¨¬¥­®¢ ­¨¥ ª«¨¥­â       ³       áâ â®ª      ³ ‘¢®¡®¤. ®áâ â®ª ³ ‘ã¬¬  á¯¨á ­¨ï  ³  
ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´  
]
   elif (mode == REP_ERROR)
[
ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿  
³ü ¤®ª³  áç.áç¥â ª«¨¥­â    ³       ”¨«¨ «        ³     ¨¬¥­®¢ ­¨¥ ª«¨¥­â       ³       áâ â®ª      ³     à¨ç¨­  ­¥á¯¨á ­¨ï áã¬¬ë      ³  
ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´  
]

   end;
end;

   macro putline( doc,payeracc,filial,payername,rest,freerest,sum,error,mode)


   if (mode == REP_SUCCESS)
     setoutput(rep_file_succ, true);
[³#####³#####################³#####################³##############################³####################³#################³#################³]
   (doc:w,payeracc,filial:c,payername:w,rest,freerest, sum);
//   total_sum = total_sum + sum;
   elif (mode == REP_ERROR)
     setoutput(rep_file_err, true);
[³#####³#####################³#####################³##############################³####################³###################################³]
   (doc:w,payeracc,filial:c,payername:w,rest,error:w);
   end;
           
   end;

   macro foot(mode)

   if (mode == REP_SUCCESS)
     setoutput(rep_file_succ, true);                                               
[ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
   elif (mode == REP_ERROR)
     setoutput(rep_file_err, true);
[ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
   end;


   end;


   macro ˆâ®£ (cond)

      var symbs, total_cnt =0, total_sum=$0;

      if (cond == REP_SUCCESS)
         symbs = " (st.t_symbol in('Š','f','7','”') or st.t_isexecute = 'X')";
      elif(cond == REP_ERROR)
         symbs = "st.t_symbol not in('Š','f','7','”') and st.t_isexecute <> 'X'";
      end;

      private var rs=TRSBDataSet(
             "  select   count (1) cnt, sum (sum) gr_sum, list " +
             "    from   (select   pm.t_amount sum, st.t_symbol, case st.t_isexecute " +
             "                                                      when 'R' " +
             "                                                      then " +
             "                                                         case st.t_symbol " +
             "                                                            when 'J' then '®â¢¥à£­ãâ' " +
             "                                                            when 'Š' then '­  ¢¨§ã «ì­®¬ ª®­âà®«¥' " +
             "                                                            when '8' then '­  á®£« á®¢ ­¨¨' " +
             "                                                            when 'f' then '®¦¨¤ ¥â ¢ë£àã§ª¨ ¢® ”à®­â' " +
             "                                                            when '7' then '­  ¢ «îâ­®¬ ª®­âà®«¥' " +
             "                                                            when '‰' then '®¦¨¤ ¥â ¯®áâã¯«¥­¨©' " +
             "                                                            when '”' then '®¦¨¤ ¥â ¢ë£àã§ª¨ ¢ Œ' " +
             "                                                            when '“' then '¯à¨®áâ ­®¢«¥­(â¥àà®à¨áâ)' " +
             "                                                            else '®âªàëâ' " +
             "                                                         end " +
             "                                                      when 'X' " +
             "                                                      then " +
             "                                                         '§ ªàëâ' " +
             "                                                   end " +
             "                                                      list " +
             "              from   doprtemp_tmp tmp, doprstep_dbt st, dpmpaym_dbt pm " +
             "             where       st.t_id_operation = tmp.t_id_operation " +
             "                     and "+symbs+
             "                     and st.t_id_step = (select   max (t_id_step) " +
             "                                           from   doprstep_dbt t " +
             "                                          where   t_id_operation = st.t_id_operation and t_isexecute <> chr (0)) " +
             "                     and pm.t_paymentid = tmp.t_orderid) " +
             "group by   list " +
             "order by   1 ");

[
ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
³Š®«-¢®³  ‘ã¬¬      ³ å®¦¤¥­¨¥ ¤®ªã¬¥­â®¢    ³
ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
];

      while (rs.MoveNext)
[³######³############³#########################³]
(int(rs.cnt), money(rs.gr_sum), rs.list);
         total_cnt = total_cnt+int(rs.cnt);
         total_sum = total_sum+money(rs.gr_sum);
      end;
[ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
³######³############³
ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÙ
](total_cnt, total_sum);
   end;

   var sql =           "  select   pmr.t_number doc, " +
          "           pm.t_payeraccount payeracc, " +
          "           (SELECT t_name FROM ddp_dep_dbt WHERE t_code = (SELECT t_branch FROM dsfcontr_dbt where t_object = pm.t_payeraccount)) filial, " +
          "           pm.t_amount sum, " +
          "           (SELECT t_shortname FROM dparty_dbt WHERE t_partyid = pm.t_payer) payername, " +
          "           USR_get_rest(pm.t_payeraccount, "+GetSQLDate(repdate)+") rest, " +
          "           USR_get_rest_current(pm.t_payeraccount, "+GetSQLDate(repdate)+") freerest, " +
          "           (SELECT error_text from usr_operations_log where paymentid = pm.t_paymentid AND pack_id = "+
          "                (select max(pack_id) FROM usr_operations_log WHERE paymentid = pm.t_paymentid )) error, " +
          "           case st.t_isexecute " +
          "              when 'R' " +
          "              then '®âªàëâ' " +
          "              when 'X' " +
          "              then '§ ªàëâ' " +
          "           end  list " +
          "    from   doprtemp_tmp tmp, " +
          "           doprstep_dbt st, " +
          "           dpmrmprop_dbt pmr, " +
          "           dpmpaym_dbt pm " +
          "   where       st.t_id_operation = tmp.t_id_operation " +
          "           and st.t_id_step = (select   max (t_id_step) " +
          "                                 from   doprstep_dbt t " +
          "                                where   t_id_operation = st.t_id_operation and t_isexecute <> chr (0)) " +
          "           and pmr.t_paymentid = pm.t_paymentid " +
          "           and pm.t_paymentid = tmp.t_orderid " +
          " order by   filial ";

   var rs=TRSBDataSet(sql);

   head("¯à®¢¥¤¥­­ëå ¤®ªã¬¥­â®¢", REP_SUCCESS);
   head(" ®è¨¡®ª ¢ ¤®ªã¬¥­â å", REP_ERROR);

   while (rs.movenext)

      if  (rs.list == "®âªàëâ")
         putline( rs.doc,rs.payeracc,rs.filial,rs.payername,rs.rest,rs.freerest,rs.sum,rs.error,REP_ERROR);
      else
         putline( rs.doc,rs.payeracc,rs.filial,rs.payername,rs.rest,rs.freerest,rs.sum,rs.error,REP_SUCCESS);
      end;

   end;
   foot(REP_SUCCESS);
   ˆâ®£(REP_SUCCESS);
   foot(REP_ERROR);
   ˆâ®£(REP_ERROR);

   setoutput(null,true);
   if ( not Open( rep_succ, rep_file_succ) )
     MsgBox("è¨¡ª  ®âªàëâ¨ï ä ©«  á ¯à®â®ª®«®¬");
   else
     ViewFile( rep_succ );
   end;


   if ( not Open( rep_err, rep_file_err) )
     MsgBox("è¨¡ª  ®âªàëâ¨ï ä ©«  á ¯à®â®ª®«®¬");
   else
     ViewFile( rep_err );
   end;
end;
