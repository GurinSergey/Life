/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Классы строк приложения3 ФОР по 342-П

  Создан: 22.10.2009 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
/***************************************************************************************************
 *  Класc строки 1 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow342_3_1(applicationName : String)
    initTApplicationRow2_7(applicationName);

    private macro constructor()
        m_code = "1";
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки (либо их часть) ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" отдельных лицевых счетов балансовых", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов по учету денежных средств,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" привлеченных от юридических лиц на", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" срок не менее трех лет в соответствии", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" с условиями заключенных  договоров:", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Пассивные остатки");
    end;

    constructor();
end;

/***************************************************************************************************
 *  Базовый класс для строк 1.1 и 1.3 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow342_3__1_1__1_3(applicationName : String)
    initTApplicationRow2_7(applicationName);

    /*Существует хотябы один досрочный возврат*/
    class (TDataSourceFilter) TDataSourceFilter3_F1(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+  "AND " + isExistsAnticipatedPayment("account.t_account", "account.t_fiId", "account.t_chapter");
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    /*Фильтр суммы 1*/
    class (TDataSourceFilter) TDataSourceFilter3_F2(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  " + hasAssignedCategory();
        end;

        macro makePartDateFilter()
            var isPaidCancellation = global.parameters.isPaidCancellation();

            m_partDateFilter = "  (   (    " + getAnticipatoryRepudiationDate() + " IS NULL"
                +"\n"+ "               AND " + getPayingSharesDate() + " IS NULL)"
                +"\n"+ "           OR (    (   " + getPayingSharesDate() + " IS NULL"
                +"\n"+ "                    OR rcb_for.getWorkDayCount(" + getAnticipatoryRepudiationDate() + "," + getPayingSharesDate() + ") > 5)"
                +"\n"+ "               AND (t_date - 1) < " + getAnticipatoryRepudiationDate() + ")"
                +"\n"+ "           OR (    rcb_for.getWorkDayCount(" + getAnticipatoryRepudiationDate() + "," + getPayingSharesDate() + ") <= 5"
                +"\n"+ "               " + ternary(isPaidCancellation, "OR", "AND") + " (t_date - 1) < " + getAnticipatoryRepudiationDate() + "))";
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    /*Фильтр для суммы 2*/
    class (TDataSourceFilter) TDataSourceFilter3_F3(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND (         NOT (account.t_balance LIKE '%06' OR account.t_balance LIKE '%07' OR account.t_balance LIKE '%08')"
                +"\n"+ " OR " + isTermExceedThreeYears("account.t_account", "account.t_fiId", "account.t_chapter") + ")"
                +"\n"+ "AND  " + getAnticipatoryRepudiationDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS null"
                +"\n"+ "AND  " + getPayingSharesDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS null";
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    /*Фильтр для суммы 3*/
    class (TDataSourceFilter) TDataSourceFilter3_F4(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  " + hasAssignedCategory();
        end;

        macro makePartDateFilter()
            if (global.parameters.isPaidCancellation())
                m_partDateFilter = "  (    rcb_for.getWorkDayCount(" + getAnticipatoryRepudiationDate() + "," + getPayingSharesDate() + ") <= 5"
                    +"\n"+         "   OR (t_date - 1) < " + getAnticipatoryRepudiationDate() + ")";
            else
                m_partDateFilter = " (t_date - 1) < " + getAnticipatoryRepudiationDate();
            end;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;
end;


/***************************************************************************************************
 *  Класc строки 1.1 приложения3
 **************************************************************************************************/
class (TApplicationRow342_3__1_1__1_3) TApplicationRow342_3_1_1(applicationName : String)
    initTApplicationRow342_3__1_1__1_3(applicationName);

    private macro constructor()
        m_code = "1.1";
    end;

    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro fillTempTable(tempTable : TTempTable)
        var dataSet = TrsbDataSet(TBalanceDataSource(TDataSourceFilter3_F1(getBalanceMasksForRow(m_code) + "," + getBalanceMasksForRow("1.3")), m_code, m_applicationName, "ПривлЮЛ_Нерез", true).getQuery());

        if (dataSet.moveNext())
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_F2(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        else
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_F3(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ_Нерез"));

            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_F4(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        end;
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ПривлЮЛ_Нерез");
    end;

    macro saveAttributes()
        var applicationRow     : Object = null;
        var dataSet            : Object = null;
        var roubleRest         : Money  = $0.0;
        var currencyRest       : Money  = $0.0;
        var scaledRoubleRest   : Double = 0.0;
        var scaledCurrencyRest : Double = 0.0;
        var multiplier = rcbApplication.currentReport.multiplier;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ_Нерез")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" от юридических лиц-нерезидентов:", true, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printRow(getValueIterator(TSorter(), beginDateInBlock, numberDatesInBlock), false, true, true);
    end;

    macro exportToKliko()
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;
        exportDescriptionRow("1.1.от юридических лиц-нерезидентов");
        exportValueRow(getValueIterator(TSorter()));
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_1", this, "ПривлЮЛ_Нерез", "RV").export();
    end;

    constructor();
end;


/***************************************************************************************************
 *  Класc строки 1.2 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow342_3_1_2(applicationName : String)
    initTApplicationRow2_7(applicationName);

    private macro constructor()
        m_code = "1.2";
    end;

    macro saveAttributes()

        class TFilter()
            macro isSuitable(v : Object)
                return (v.fieldValue("row").exact == "1.1");
            end;
        end;

        class TSorter()
            macro isLess(v1 : Object, v2 : Object)
                return (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current)));
            end;
        end;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            summarizeAndSaveAttributeValue(getAttributeValueIterator(m_applicationName, TFilter(), TSorter()), "", "314440");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printRow(getValueIterator(TSorter(), beginDateInBlock, numberDatesInBlock), true, true, true, "ИТОГО пассивных остатков,");
        printDescriptionRow(" подлежащих исключению из обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" перед юридическими лицами-нерезидентами,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения - 314440", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        exportValueRow(getValueIterator(TSorter()), "1.2.ИТОГО пас. ост.(код 314440)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_2", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 1.3 приложения3 после 1951-У
 **************************************************************************************************/
class (TApplicationRow342_3__1_1__1_3) TApplicationRow342_3_1_3(applicationName : String)
    initTApplicationRow342_3__1_1__1_3(applicationName);

    private macro constructor()
        m_code = "1.3";
    end;

    macro fillTempTable(tempTable : TTempTable)
        var dataSet = TrsbDataSet(TBalanceDataSource(TDataSourceFilter3_F1(getBalanceMasksForRow(m_code) + "," + getBalanceMasksForRow("1.1")), m_code, m_applicationName, "ПривлЮЛ", true).getQuery());

        if (dataSet.moveNext())
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_F2(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
        else
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_F3(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ"));

            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_F4(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
        end;
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ПривлЮЛ");
    end;

    macro saveAttributes()
        var applicationRow : Object = null;
        var dataSet        : Object = null;
        var roubleRest     : Money  = $0.0;
        var currencyRest   : Money  = $0.0;
        var scaledRoubleRest   : Double = 0.0;
        var scaledCurrencyRest : Double = 0.0;
        var multiplier = rcbApplication.currentReport.multiplier;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);

            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" от иных юридических лиц:", true, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printRow(getValueIterator(TSorter(), beginDateInBlock, numberDatesInBlock), false, true, true);
    end;

    macro exportToKliko()
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        exportDescriptionRow("1.3. от иных юридических лиц:");
        exportValueRow(getValueIterator(TSorter()));
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлЮЛ", "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 1.4 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow342_3_1_4(applicationName : String)
    initTApplicationRow2_7(applicationName);

    private macro constructor()
        m_code = "1.4";
    end;

    macro saveAttributes()

        class TFilter()
            macro isSuitable(v : Object)
                return (v.fieldValue("row").exact == "1.3");
            end;
        end;

        class TSorter()
            macro isLess(v1 : Object, v2 : Object)
                return (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current)));
            end;
        end;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            summarizeAndSaveAttributeValue(getAttributeValueIterator(m_applicationName, TFilter(), TSorter()), "", "410439");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printRow(getValueIterator(TSorter(), beginDateInBlock, numberDatesInBlock), true, true, true, "ИТОГО пассивных остатков,");
        printDescriptionRow(" подлежащих исключению из ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" иных обязательств, код ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" обозначения - 410439", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        class TSorter
            macro isLess(v1, v2)
                return  (v1.fieldValue("balance").current < v2.fieldValue("balance").current)
                     or (     (v1.fieldValue("balance").current == v2.fieldValue("balance").current)
                          and (Date(trim(v1.fieldValue("date").current)) < Date(trim(v2.fieldValue("date").current))));
            end;
        end;

        exportValueRow(getValueIterator(TSorter()), "1.4.ИТОГО пас. ост.(код - 410439)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_4", this, "RV").export();
    end;

    constructor();
end;
