/**
* Класс TSourceDataControlOperation и его наследники.
*/
import BankInter;
import RsbDataSet;
import globals;
import cb_sql;
import rcb_lib;
import repException;
import RcbCoreInter;
import departmentFilter;
import Календарь;
import CFSourceDataControlProtocolView;
import RcbDepartmentOkatoControlProtocolView;

const OBJGROUP_PT_TYPE = 16; //категория субъекта "Тип субъекта"

/**
* Операция контроля первичных даных.
*/
class TSourceDataControlOperation()

    private var m_beginDate;

    private var m_endDate;

    private var m_balancePlanNumber;

    macro constructorTSourceDataControlOperation()
        m_beginDate         = rcbApplication().currentReport.context.period.beginDate;
        m_endDate           = rcbApplication().currentReport.context.period.endDate;
        m_balancePlanNumber = rcbApplication().parameters.balancePlanNumber;
    end;

    macro controlSymbols()
        throw(TPureVirtualMethodCallException("TSourceDataControlOperation::controlSymbols"));
    end;

    /**
    * Выполнить контроль.
    */
    macro execute()

        sql_truncate("dfcshctrl_tmp");

        controlSymbols();
    end;

    constructorTSourceDataControlOperation();

end;

/**
* Операция контроля первичных данных по 1881-У.
*/
class (TSourceDataControlOperation) TSourceDataControlOperation1881(reportName)


    const NO_PAYER_SYMBOL     =  0;/*Внимание! Документ не содержит приходный кассовый символ*/
    const NO_RECEIVER_SYMBOL  =  1;/*Внимание! Документ не содержит расходный кассовый символ*/
    const WRONG_DEBET_SYMBOL  =  2;/*Ошибка! Приходный документ содержит неверный кассовый символ <##>*/
    const WRONG_CREDIT_SYMBOL =  3;/*Ошибка! Расходный документ содержит неверный кассовый символ <##>*/
    const NO_SYMBOL_IN_LIST   =  4;/*Ошибка! Кассовый символ <##> не соответствует справочнику символов*/
    const WRONG_SUM           =  5;/*Внимание! Сумма разнесения по символам  не равна сумме документа*/
    const NO_CASH             =  6;/*Ошибка! Кассовый символ <##> стоит на документе, не затрагивающем счет кассы*/
    const NO_BALANCE_02       =  7;/*Ошибка! Для документа с символом 89 должен быть установлен балансовый символ <02>*/
    const WRONG_DATE          =  8;/*Ошибка! Дата проведения операции должна быть <первый рабочий день месяца в формате дд.мм.гггг>*/
    const NO_BALANCE_40       =  9;/*Ошибка! Для документа с символом 96 должен быть установлен балансовый символ <40>*/
    const NO_DEBET_SYMBOL     = 10;/*Ошибка! Для документа с символом 97 должен быть установлен балансовый символ прихода*/
    const NO_CREDIT_SYMBOL    = 11;/*Ошибка! Для документа с символом 98 должен быть установлен балансовый символ расхода*/
    const WRONG_SUM_89        = 12;/*Ошибка! Сумма по символу 89 должна быть меньше или равна сумме по балансовому символу 02.*/
    const WRONG_SUM_96        = 13;/*Ошибка! Сумма по символу 96 должна быть меньше или равна сумме по балансовому символу 40.*/
    const WRONG_SUM_97        = 14;/*Ошибка! Сумма по символу 97 должна быть меньше или равна сумме по балансовым символам прихода.*/
    const WRONG_SUM_98        = 15;/*Ошибка! Сумма по символу 98 должна быть меньше или равна сумме по балансовым символам расхода.*/
    const WRONG_SUM_BALANCE   = 16;/*Ошибка! Сумма по забалансовым символам должна быть меньше или равна сумме по балансовым символам*/

    var m_protocolView;
    var m_okatoProtocolView;

    macro constructorTSourceDataControlOperation1881(reportName)
        initTSourceDataControlOperation();
        m_protocolView      = TSourceDataControlProtocolView1881("ПРОТОКОЛ КОНТРОЛЯ ИСХОДНЫХ ДАННЫХ");
        m_okatoProtocolView = TDepartmentOkatoControlProtocolView("ПРОТОКОЛ КОНТРОЛЯ НАЛИЧИЯ КОДОВ ОКАТО У ПОДРАЗДЕЛЕНИЙ");
    end;


    macro getBalanceMask()
        return "20202*, 20206*, 20207*";
    end;

    /**
    * Проверка на наличие у всех кассовых документов соответствующих балансовых символов.
    */
    macro checkSymbols(isDebetCashAccount, balanceMask);

        var error             = ternary(isDebetCashAccount == true, WRONG_DEBET_SYMBOL, WRONG_CREDIT_SYMBOL);
        var warning           = ternary(isDebetCashAccount == true, NO_PAYER_SYMBOL, NO_RECEIVER_SYMBOL);
        var accountField      = ternary(isDebetCashAccount == true, "t_accountId_payer", "t_accountId_receiver");
        var otherAccountField = ternary(isDebetCashAccount == true, "t_accountId_receiver", "t_accountId_payer");
        var symbolKind        = ternary(isDebetCashAccount == true, 1, 2);

        var query = "INSERT INTO dfcshctrl_tmp (t_accTrnId, t_error, t_symbol)"
        + "\n"  + "   WITH documents AS(SELECT doc.t_accTrnId, "
        + "\n"  + "                    CASE"
        + "\n"  + "                                WHEN EXISTS (SELECT 1 "
        + "\n"  + "                                              FROM dAccount_dbt account,"
        + "\n"  + "                                                   dAccBlnc_dbt balance"
        + "\n"  + "                                             WHERE account.t_accountId = doc." + otherAccountField
        + "\n"  + "                                               AND balance.t_accountId = doc." + otherAccountField
        + "\n"  + "                                               AND (" + convertMaskToSqlFormat(balanceMask, "balance.t_balance"  + m_balancePlanNumber) + "))"
        + "\n"  + "                                     THEN 1"
        + "\n"  + "                                ELSE 0"
        + "\n"  + "                            END otherAccountIsCash "
        + "\n"  + "                       FROM daccTrn_dbt doc"
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_result_carry != " + RUBCARRY
        + "\n"  + "                        AND doc.t_kind_oper = ' 3'"
        + "\n"  + "                        AND EXISTS (SELECT 1 "
        + "\n"  + "                                      FROM dAccount_dbt account,"
        + "\n"  + "                                           dAccBlnc_dbt balance"
        + "\n"  + "                                     WHERE account.t_accountId = doc." + accountField
        + "\n"  + "                AND account.t_code_currency  = " + NATCUR
        + "\n" + "                 AND (" + rcbAccountFilter.getAsSqlString("account") +")"
        + "\n"  + "                AND instr( account.t_type_account, 'П' ) = 0"
        + "\n"  + "                                       AND balance.t_accountId = doc." + accountField
        + "\n"  + "                                       AND (" + convertMaskToSqlFormat(balanceMask, "balance.t_balance"  + m_balancePlanNumber) + "))"
        + "\n"  + "                    )"
        + "\n"  + "     SELECT documents.t_accTrnId, " + warning + ", NULL  -- Документ не содержит кассовый символ"
        + "\n"  + "       FROM documents"
        + "\n"  + "      WHERE NOT EXISTS (SELECT 1"
        + "\n"  + "                          FROM dsymbcash_dbt symb"
        + "\n"  + "                         WHERE symb.t_accTrnId = documents.t_accTrnId"
        + "\n"  + "                           AND symb.t_docKind = 1"
        + "\n"  + "                           AND (   (documents.otherAccountIsCash = 0 AND symb.t_kind IN (1,2))"
        + "\n"  + "                                OR (symb.t_kind = " + symbolKind + "))"
        + "\n"  + "                       )"
        + "\n"  + "  UNION ALL "
        + "\n"  + "     SELECT documents.t_accTrnId, "
        + "\n"  + "            CASE"
        + "\n"  + "                WHEN symb.t_kind <> " + symbolKind  + " -- Документ содержит неверный кассовый символ"
        + "\n"  + "                    THEN " + error
        + "\n"  + "                WHEN list.t_symb_cash IS NULL  -- Кассовый символ не соответствует справочнику"
        + "\n"  + "                    THEN " + NO_SYMBOL_IN_LIST
        + "\n"  + "            END error,"
        + "\n"  + "            SUBSTR(symb.t_symbol, 2) symbol"
        + "\n"  + "       FROM documents, "
        + "\n"  + "            dSymbCash_dbt symb,"
        + "\n"  + "            dListSymb_dbt list"
        + "\n"  + "      WHERE documents.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "        AND symb.t_dockind = 1"
        + "\n"  + "        AND ((documents.otherAccountIsCash = 0 AND symb.t_kind IN (1,2)) OR (symb.t_kind = " + symbolKind + "))"
        + "\n"  + "        AND list.t_symb_cash(+) = symb.t_symbol"
        + "\n"  + "        AND list.t_docKind(+) = 1"
        + "\n"  + "        AND (  (list.t_symb_cash IS NULL)"
        + "\n"  + "            OR (symb.t_kind <> " + symbolKind  + "))";

        return query;
    end;

    /**
    * Проверка равенства суммы документа сумме всех символов документа.
    */

    macro checkSymbolSums(balanceMask);

        var query = "INSERT INTO dfcshctrl_tmp (t_accTrnId, t_error, t_symbol)"
        + "\n"  + "     SELECT /*+ LEADING (daccTrn_dbt) */"
        + "\n"  + "            doc.t_accTrnId,"
        + "\n"  + "            " + WRONG_SUM + " error,"
        + "\n"  + "            null symbol"
        + "\n"  + "       FROM daccTrn_dbt doc,"
        + "\n"  + "            daccblnc_dbt debet,"
        + "\n"  + "            daccblnc_dbt credit"
        + "\n"  + "      WHERE doc.t_chapter = 1"
        + "\n"  + "        AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                 AND " + getSqlDate(m_endDate)
        + "\n"  + "        AND doc.t_result_carry != " + RUBCARRY
        + "\n"  + "        AND debet.t_chapter = 1"
        + "\n"  + "        AND debet.t_account = doc.t_account_payer"
        + "\n"  + "        AND credit.t_chapter = 1"
        + "\n"  + "        AND credit.t_account = doc.t_account_receiver"
        + "\n"  + "        AND (    (     (    (" + convertMaskToSqlFormat(balanceMask, "debet.t_balance"  + m_balancePlanNumber) + ")"
        + "\n"  + "                        AND (doc.t_kind_oper = ' 3')"
        + "\n"  + "                        AND (credit.t_balance"  + m_balancePlanNumber + " <> '20208'))"
        + "\n"  + "                        AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                   AND doc.t_sum_payer <> (SELECT SUM (symb.t_sum)"
        + "\n"  + "                                             FROM dsymbcash_dbt symb"
        + "\n"  + "                                            WHERE symb.t_dockind = 1"
        + "\n"  + "                                              AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                              AND symb.t_kind = 1))"
        + "\n"  + "              OR (     (    (" + convertMaskToSqlFormat(balanceMask, "credit.t_balance" + m_balancePlanNumber) + ")"
        + "\n"  + "                        AND (doc.t_kind_oper = ' 3')"
        + "\n"  + "                        AND (debet.t_balance" + m_balancePlanNumber + " <> '20208'))"
        + "\n"  + "                        AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                   AND doc.t_sum_receiver <> (SELECT SUM (symb.t_sum)"
        + "\n"  + "                                                FROM dsymbcash_dbt symb"
        + "\n"  + "                                               WHERE symb.t_dockind = 1"
        + "\n"  + "                                                 AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                                 AND symb.t_kind = 2)))";

        return query;
    end;

    /**
    * Проверка на то, что балансовый символ стоит на документе, проходящем через счет кассы.
    */
    macro checkBalanceSymbols(balanceMask);

        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error, t_symbol)"
        + "\n"  + "     SELECT /*+ LEADING (daccTrn_dbt) */"
        + "\n"  + "            doc.t_accTrnId,"
        + "\n"  + "            " + NO_CASH + " error,"
        + "\n"  + "            SUBSTR(symb.t_symbol, 2) symbol"
        + "\n"  + "       FROM daccTrn_dbt doc,"
        + "\n"  + "            daccblnc_dbt debet,"
        + "\n"  + "            daccblnc_dbt credit,"
        + "\n"  + "            dsymbcash_dbt symb"
        + "\n"  + "      WHERE doc.t_chapter = 1"
        + "\n"  + "        AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                 AND " + getSqlDate(m_endDate)
        + "\n"  + "        AND doc.t_kind_oper = ' 3'"
        + "\n"  + "        AND doc.t_result_carry != " + RUBCARRY
        + "\n"  + "        AND debet.t_chapter = 1"
        + "\n"  + "        AND debet.t_account = doc.t_account_payer"
        + "\n"  + "        AND credit.t_chapter = 1"
        + "\n"  + "        AND credit.t_account = doc.t_account_receiver"
        + "\n"  + "        AND NOT (" + convertMaskToSqlFormat(balanceMask, "debet.t_balance"  + m_balancePlanNumber) + ")"
        + "\n"  + "        AND NOT (" + convertMaskToSqlFormat(balanceMask, "credit.t_balance" + m_balancePlanNumber) + ")"
        + "\n"  + "        AND credit.t_balance"  + m_balancePlanNumber + " <> '20208'"
        + "\n"  + "        AND debet.t_balance"  + m_balancePlanNumber + " <> '20208'"
        + "\n"  + "        AND symb.t_kind IN (1,2)"
        + "\n"  + "        AND symb.t_dockind = 1"
        + "\n"  + "        AND symb.t_accTrnId = doc.t_accTrnId";

        return query;
    end;

    /**
    * Контроль соответствия забалансовых символов балансовым.
    */
    macro checkOffBalanceSymbols();

        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error, t_symbol)"
        + "\n"  + "     SELECT t_accTrnId, error, symbol"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN symb.t_symbol = ' 89'"
        + "\n"  + "                         AND NOT EXISTS (SELECT 1"
        + "\n"  + "                                           FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                                          WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                                            AND symb.t_dockind = 1"
        + "\n"  + "                                            AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                                            AND balance_symbols.t_symbol = ' 02')"
        + "\n"  + "                             THEN " + NO_BALANCE_02
        + "\n"  + "                    WHEN symb.t_symbol = ' 96'"
        + "\n"  + "                    AND NOT EXISTS ("
        + "\n"  + "                            SELECT 1"
        + "\n"  + "                              FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                             WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                               AND symb.t_dockind = 1"
        + "\n"  + "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                               AND balance_symbols.t_symbol = ' 40')"
        + "\n"  + "                            THEN " + NO_BALANCE_40
        + "\n"  + "                    WHEN symb.t_symbol = ' 97'"
        + "\n"  + "                    AND NOT EXISTS ("
        + "\n"  + "                            SELECT 1"
        + "\n"  + "                              FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                             WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                               AND symb.t_dockind = 1"
        + "\n"  + "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                               AND balance_symbols.t_kind = 1"
        + "\n"  + "                               AND balance_symbols.t_symbol <> ' 35')"
        + "\n"  + "                            THEN " + NO_DEBET_SYMBOL
        + "\n"  + "                    WHEN symb.t_symbol = ' 98'"
        + "\n"  + "                    AND NOT EXISTS ("
        + "\n"  + "                            SELECT 1"
        + "\n"  + "                              FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                             WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                               AND symb.t_dockind = 1"
        + "\n"  + "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                               AND balance_symbols.t_kind = 2"
        + "\n"  + "                               AND balance_symbols.t_symbol <> ' 70')"
        + "\n"  + "                            THEN " + NO_CREDIT_SYMBOL
        + "\n"  + "                    END error,"
        + "\n"  + "                    NULL symbol"
        + "\n"  + "               FROM daccTrn_dbt doc, "
        + "\n"  + "                    dsymbcash_dbt symb"
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_kind_oper = ' 3'"
        + "\n"  + "                AND doc.t_result_carry != " + RUBCARRY
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND symb.t_kind = 3"
        + "\n"  + "                AND symb.t_dockind = 1"
        + "\n"  + "                AND symb.t_accTrnId = doc.t_accTrnId)"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Контроль даты забалансового символа.
    */
    macro check89Date()

        var dateOneWorkDay;
        var month;
        var year;
        var prevMonth = 0;

        var symbol89 = TRsbDataSet("   SELECT doc.t_accTrnId,"
                        + "\n"  + "          doc.t_date_carry t_date_carry"
                        + "\n"  + "     FROM daccTrn_dbt doc,"
                        + "\n"  + "          dsymbcash_dbt symb"
                        + "\n"  + "    WHERE doc.t_chapter = 1"
                        + "\n"  + "      AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
                        + "\n"  + "                               AND " + getSqlDate(m_endDate)
                        + "\n"  + "      AND doc.t_kind_oper = ' 3'"
                        + "\n"  + "      AND doc.t_result_carry != " + RUBCARRY
                        + "\n"  + "      AND doc.t_fiId_payer = " + NATCUR
                        + "\n"  + "      AND doc.t_fiId_receiver = " + NATCUR
                        + "\n"  + "      AND symb.T_SYMBOL = ' 89'"
                        + "\n"  + "      AND symb.t_dockind = 1"
                        + "\n"  + "      AND symb.t_accTrnId = doc.t_accTrnId"
                        + "\n"  + " ORDER BY doc.t_date_carry", RSDVAL_CLIENT, RSDVAL_STATIC);

        symbol89.setFieldType("date_carry", V_DATE);

        while (symbol89.moveNext())
            dateSplit(symbol89.date_carry, NULL, month, year);
            if (month != prevMonth)
                dateOneWorkDay = Date(1, month, year);
                while(not isWorkday(dateOneWorkDay) )
                    dateOneWorkDay = dateOneWorkDay + 1;
                end;
            end;

            prevMonth = month;

            if(symbol89.date_carry != dateOneWorkDay)
                sql_execute("INSERT INTO dfcshctrl_tmp (t_accTrnId, t_error, t_symbol)"
                + "\n"  + "     VALUES (" + symbol89.t_accTrnId + ", " + WRONG_DATE + ", null)");
            end;
        end;
    end;

    /**
    * Проверка сумм символов  02 и 89 по документу.
    */
    macro checkSymbolSumsBalance02_89();
        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error)"
        + "\n"  + "     SELECT t_accTrnId, error"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN "
        + "\n"  + "                              (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol = ' 02')"
        + "\n"  + "                            < (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol = ' 89')"
        + "\n"  + "                             THEN " + WRONG_SUM_89
        + "\n"  + "                    END error"
        + "\n"  + "               FROM daccTrn_dbt doc "
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND doc.t_kind_oper = ' 3')"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Проверка сумм символов  40 и 96 по документу.
    */
    macro checkSymbolSumsBalance40_96();
        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error)"
        + "\n"  + "     SELECT t_accTrnId, error"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN "
        + "\n"  + "                              (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol = ' 40')"
        + "\n"  + "                            < (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol = ' 96')"
        + "\n"  + "                             THEN " + WRONG_SUM_96
        + "\n"  + "                    END error"
        + "\n"  + "               FROM daccTrn_dbt doc "
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND doc.t_kind_oper = ' 3')"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Проверка сумм символа 97 по документу.
    */
    macro checkSymbolSumsBalance97();
        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error)"
        + "\n"  + "     SELECT t_accTrnId, error"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN "
        + "\n"  + "                              (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_kind = 1)"
        + "\n"  + "                            < (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol = ' 97')"
        + "\n"  + "                             THEN " + WRONG_SUM_97
        + "\n"  + "                    END error"
        + "\n"  + "               FROM daccTrn_dbt doc "
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND doc.t_kind_oper = ' 3')"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Проверка сумм символа 98 по документу.
    */
    macro checkSymbolSumsBalance98();
        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error)"
        + "\n"  + "     SELECT t_accTrnId, error"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN "
        + "\n"  + "                              (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_kind = 2)"
        + "\n"  + "                            < (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol = ' 98')"
        + "\n"  + "                             THEN " + WRONG_SUM_98
        + "\n"  + "                    END error"
        + "\n"  + "               FROM daccTrn_dbt doc "
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND doc.t_kind_oper = ' 3')"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Проверка сумм балансовых и забалансовых символов по документу.
    */
    macro checkSymbolSumsBalance();
        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error)"
        + "\n"  + "     SELECT t_accTrnId, error"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN "
        + "\n"  + "                              (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_kind IN (1,2))"
        + "\n"  + "                            < (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_kind = 3)"
        + "\n"  + "                             THEN " + WRONG_SUM_BALANCE
        + "\n"  + "                    END error"
        + "\n"  + "               FROM daccTrn_dbt doc "
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND doc.t_kind_oper = ' 3')"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Контроль кассовых символов.
    */
    macro controlSymbols()

        var balanceMask = getBalanceMask();

        sql_execute(checkSymbols(true, balanceMask));
        sql_execute(checkSymbols(false, balanceMask));

        sql_execute(checkSymbolSums(balanceMask));
        sql_execute(checkBalanceSymbols(balanceMask));
        sql_execute(checkOffBalanceSymbols());

        sql_execute(checkSymbolSumsBalance());
        sql_execute(checkSymbolSumsBalance02_89());
        sql_execute(checkSymbolSumsBalance40_96());
        sql_execute(checkSymbolSumsBalance97());
        sql_execute(checkSymbolSumsBalance98());

        check89Date();

        m_protocolView.printProtocol();
        m_protocolView.addFrom(m_okatoProtocolView);
    end;


    constructorTSourceDataControlOperation1881(reportName);
end;


/**
* Операция контроля первичных данных по 2332-У.
*
* отличия от 1881У:
*                 к проверкам по 97 символы добавлены 99, 100
*/
class (TSourceDataControlOperation1881) TSourceDataControlOperation2332()

    macro constructorTSourceDataControlOperation2332()
        initTSourceDataControlOperation1881("Отчет о наличном денежном обороте");

        m_protocolView = TSourceDataControlProtocolView2332("ПРОТОКОЛ КОНТРОЛЯ ИСХОДНЫХ ДАННЫХ", "Отчет о наличном денежном обороте");
    end;

    /**
    * Контроль соответствия забалансовых символов балансовым.
    */
    macro checkOffBalanceSymbols();

        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error, t_symbol)"
        + "\n"  + "     SELECT t_accTrnId, error, symbol"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN symb.t_symbol = ' 89'"
        + "\n"  + "                         AND NOT EXISTS (SELECT 1"
        + "\n"  + "                                           FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                                          WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                                            AND symb.t_dockind = 1"
        + "\n"  + "                                            AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                                            AND balance_symbols.t_symbol = ' 02')"
        + "\n"  + "                             THEN " + NO_BALANCE_02
        + "\n"  + "                    WHEN symb.t_symbol = ' 96'"
        + "\n"  + "                    AND NOT EXISTS ("
        + "\n"  + "                            SELECT 1"
        + "\n"  + "                              FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                             WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                               AND symb.t_dockind = 1"
        + "\n"  + "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                               AND balance_symbols.t_symbol = ' 40')"
        + "\n"  + "                            THEN " + NO_BALANCE_40
        + "\n"  + "                    WHEN symb.t_symbol IN (' 97', ' 99', '100')"
        + "\n"  + "                    AND NOT EXISTS ("
        + "\n"  + "                            SELECT 1"
        + "\n"  + "                              FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                             WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                               AND symb.t_dockind = 1"
        + "\n"  + "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                               AND balance_symbols.t_kind = 1"
        + "\n"  + "                               AND balance_symbols.t_symbol <> ' 35')"
        + "\n"  + "                            THEN " + NO_DEBET_SYMBOL
        + "\n"  + "                    WHEN symb.t_symbol = ' 98'"
        + "\n"  + "                    AND NOT EXISTS ("
        + "\n"  + "                            SELECT 1"
        + "\n"  + "                              FROM dsymbcash_dbt balance_symbols"
        + "\n"  + "                             WHERE balance_symbols.t_dockind = 1"
        + "\n"  + "                               AND symb.t_dockind = 1"
        + "\n"  + "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
        + "\n"  + "                               AND balance_symbols.t_kind = 2"
        + "\n"  + "                               AND balance_symbols.t_symbol <> ' 70')"
        + "\n"  + "                            THEN " + NO_CREDIT_SYMBOL
        + "\n"  + "                    END error,"
        + "\n"  + "                    symb.t_symbol symbol"
        + "\n"  + "               FROM daccTrn_dbt doc, "
        + "\n"  + "                    dsymbcash_dbt symb"
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_kind_oper = ' 3'"
        + "\n"  + "                AND doc.t_result_carry != " + RUBCARRY
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND symb.t_kind = 3"
        + "\n"  + "                AND symb.t_dockind = 1"
        + "\n"  + "                AND symb.t_accTrnId = doc.t_accTrnId)"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Проверка сумм символа 97 по документу.
    */
    macro checkSymbolSumsBalance97();
        var query = "INSERT INTO dfcshctrl_tmp"
        + "\n"  + "            (t_accTrnId, t_error)"
        + "\n"  + "     SELECT t_accTrnId, error"
        + "\n"  + "       FROM (SELECT doc.t_accTrnId,"
        + "\n"  + "                    CASE"
        + "\n"  + "                        WHEN "
        + "\n"  + "                              NVL((SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_kind = 1), 0)"
        + "\n"  + "                            < (SELECT Sum(symb.t_sum) "
        + "\n"  + "                                   FROM dsymbcash_dbt symb"
        + "\n"  + "                                  WHERE symb.t_dockind = 1"
        + "\n"  + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
        + "\n"  + "                                    AND symb.t_symbol IN (' 97', ' 99', '100'))"
        + "\n"  + "                             THEN " + WRONG_SUM_97
        + "\n"  + "                    END error"
        + "\n"  + "               FROM daccTrn_dbt doc "
        + "\n"  + "              WHERE doc.t_chapter = 1"
        + "\n"  + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                         AND " + getSqlDate(m_endDate)
        + "\n"  + "                AND doc.t_fiId_payer = " + NATCUR
        + "\n"  + "                AND doc.t_fiId_receiver = " + NATCUR
        + "\n"  + "                AND doc.t_kind_oper = ' 3')"
        + "\n"  + "      WHERE error IS NOT NULL";

        return query;
    end;

    constructorTSourceDataControlOperation2332();
end;

class (TSourceDataControlOperation2332) TSourceDataControlOperation2539()
    initTSourceDataControlOperation2332();

    macro getBalanceMask()
        return "20202*, 20207*";
    end;
end;


/**
* Операция контроля первичных данных по 2627-У.
*
*/
class (TSourceDataControlOperation2539) TSourceDataControlOperation2627()

    const NO_CATEGORY_85      = 17;/*Ошибка! Символ 85 может быть установлен только для кассового документа по приходу, у которого контрагент по счету кредита имеет категорию "Тип субъекта" со значением "Ломбард"*/
    const WRONG_SUM_85        = 18;/*Ошибка! Сумма по символу 85 должна быть равна сумме по балансовым символам прихода.*/
    const NO_CATEGORY_86      = 19;/*Ошибка! Символ 86 может быть установлен только для кассового документа по приходу, у которого контрагент по счету дебита имеет категорию "Тип субъекта" со значением "Ломбард"*/
    const WRONG_SUM_86        = 20;/*Ошибка! Сумма по символу 86 должна быть равна сумме по балансовым символам расхода.*/
    const NO_BALANCE_19_32    = 21;/*Ошибка! Для документа с символом 87 должен быть установлен балансовый символ 19 или 32*/
    const NO_BALANCE_53_58    = 22;/*Ошибка! Для документа с символом 88 должен быть установлен балансовый символ 53 или 58.*/
    const KIND_ACCOUNT_A_80_81  = 23;/*Внимание! На балансовом счете для символов 80, 81 установлен типа "А - счет кассы".*/
    const KIND_ACCOUNT_NO_A     = 24;/*Внимание! На балансовом счете для символов 02-77, 82-100 не установлен типа "А - счет кассы".*/
    const SYMBOL_ON_CARRY       = 25;/*Ошибка! Кассовый символ <##> стоит на проводке, не затрагивающей счет кассы.*/

    macro constructorTSourceDataControlOperation2627()
        initTSourceDataControlOperation2539();
        m_protocolView = TSourceDataControlProtocolView2627("ПРОТОКОЛ КОНТРОЛЯ ИСХОДНЫХ ДАННЫХ", "Отчет о наличном денежном обороте");
    end;

    macro hasAssignedPartyCategory(clientCodeAlias : String, category : String) : String
        var filter = "";
        if (category != NULL)
            filter = "EXISTS(SELECT 1"
              +"\n"+ "         FROM dobjatcor_dbt atc"
              +"\n"+ "        WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
              +"\n"+ "          AND atc.t_GroupID    = " + OBJGROUP_PT_TYPE
              +"\n"+ "          AND atc.t_Object     = LPAD(" + clientCodeAlias + ",10,'0') "
              +"\n"+ "          AND atc.t_AttrID IN (SELECT att.t_AttrID"
              +"\n"+ "                                 FROM dobjattr_dbt att"
              +"\n"+ "                                WHERE att.t_ObjectType = atc.t_ObjectType"
              +"\n"+ "                                  AND att.t_GroupID    = atc.t_GroupID"
              +"\n"+ "                                  AND att.t_name  = '" + category + "'"
              +"\n"+ "          AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate))";
        else
            filter = "1 = 1";
        end;
        return filter;
    end;

    /**
    * Контроль соответствия забалансовых символов балансовым.
    */
    macro checkOffBalanceSymbols();

        var query = "INSERT INTO dfcshctrl_tmp"
             +"\n"+ "            (t_accTrnId, t_error, t_symbol)"
             +"\n"+ "     SELECT t_accTrnId, error, symbol"
             +"\n"+ "       FROM (SELECT doc.t_accTrnId,"
             +"\n"+ "                    CASE"
             +"\n"+ "                        WHEN symb.t_symbol = ' 89'"
             +"\n"+ "                         AND NOT EXISTS (SELECT 1"
             +"\n"+ "                                           FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                                          WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                                            AND symb.t_dockind = 1"
             +"\n"+ "                                            AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                                            AND balance_symbols.t_symbol = ' 02')"
             +"\n"+ "                             THEN " + NO_BALANCE_02
             +"\n"+ "                    WHEN symb.t_symbol = ' 96'"
             +"\n"+ "                    AND NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND balance_symbols.t_symbol = ' 40')"
             +"\n"+ "                            THEN " + NO_BALANCE_40
             +"\n"+ "                    WHEN symb.t_symbol IN (' 97', ' 99', '100')"
             +"\n"+ "                    AND NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND balance_symbols.t_kind = 1"
             +"\n"+ "                               AND balance_symbols.t_symbol <> ' 35')"
             +"\n"+ "                            THEN " + NO_DEBET_SYMBOL
             +"\n"+ "                    WHEN symb.t_symbol = ' 98'"
             +"\n"+ "                    AND NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND balance_symbols.t_kind = 2"
             +"\n"+ "                               AND balance_symbols.t_symbol <> ' 70')"
             +"\n"+ "                            THEN " + NO_CREDIT_SYMBOL
             +"\n"+ "                    WHEN symb.t_symbol = ' 85'"
             +"\n"+ "                    AND (NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND balance_symbols.t_kind = 1"
             +"\n"+ "                               AND balance_symbols.t_symbol <> ' 35')"
             +"\n"+ "                                OR ( NOT " + hasAssignedPartyCategory("accCredit.t_client","Ломбард") + "))" // категория "Тип субъекта" со значением "Ломбард"
             +"\n"+ "                            THEN " + NO_CATEGORY_85
             +"\n"+ "                    WHEN symb.t_symbol = ' 86'"
             +"\n"+ "                    AND (NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND balance_symbols.t_kind = 2"
             +"\n"+ "                               AND balance_symbols.t_symbol <> ' 70')"
             +"\n"+ "                                OR (NOT " + hasAssignedPartyCategory("accDebet.t_client","Ломбард") + "))" // категория "Тип субъекта" со значением "Ломбард"
             +"\n"+ "                            THEN " + NO_CATEGORY_86
             +"\n"+ "                    WHEN symb.t_symbol = ' 87'"
             +"\n"+ "                    AND NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND ((balance_symbols.t_symbol = ' 19')"
             +"\n"+ "                                    OR (balance_symbols.t_symbol = ' 32')))"
             +"\n"+ "                            THEN " + NO_BALANCE_19_32
             +"\n"+ "                    WHEN symb.t_symbol = ' 88'"
             +"\n"+ "                    AND NOT EXISTS ("
             +"\n"+ "                            SELECT 1"
             +"\n"+ "                              FROM dsymbcash_dbt balance_symbols"
             +"\n"+ "                             WHERE balance_symbols.t_dockind = 1"
             +"\n"+ "                               AND symb.t_dockind = 1"
             +"\n"+ "                               AND balance_symbols.t_accTrnId = symb.t_accTrnId"
             +"\n"+ "                               AND ((balance_symbols.t_symbol = ' 53')"
             +"\n"+ "                                    OR (balance_symbols.t_symbol = ' 58')))"
             +"\n"+ "                            THEN " + NO_BALANCE_53_58
             +"\n"+ "                    END error,"
             +"\n"+ "                    symb.t_symbol symbol"
             +"\n"+ "               FROM daccTrn_dbt doc,"
             +"\n"+ "                    dsymbcash_dbt symb,"
             +"\n"+ "                    daccount_dbt accDebet,"
             +"\n"+ "                    daccount_dbt accCredit"
             +"\n"+ "              WHERE doc.t_chapter = 1"
             +"\n"+ "                AND doc.t_accountId_payer = accDebet.t_accountId"
             +"\n"+ "                AND doc.t_accountId_receiver = accCredit.t_accountId"
             +"\n"+ "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
             +"\n"+ "                                         AND " + getSqlDate(m_endDate)
             +"\n"+ "                AND doc.t_kind_oper = ' 3'"
             +"\n"+ "                AND doc.t_result_carry != " + RUBCARRY
             +"\n"+ "                AND doc.t_fiId_payer = " + NATCUR
             +"\n"+ "                AND doc.t_fiId_receiver = " + NATCUR
             +"\n"+ "                AND symb.t_kind = 3"
             +"\n"+ "                AND symb.t_dockind = 1"
             +"\n"+ "                AND (" + rcbAccountFilter.getAsSqlString("accDebet") +")"
             +"\n"+ "                AND (" + rcbAccountFilter.getAsSqlString("accCredit") +")"
             +"\n"+ "                AND symb.t_accTrnId = doc.t_accTrnId)"
             +"\n"+ "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Проверка сумм символа 97 по документу.
    */
    macro checkSymbolSumsBalance97();
        var query = "INSERT INTO dfcshctrl_tmp"
               +"\n" + "            (t_accTrnId, t_error)"
               +"\n" + "     SELECT t_accTrnId, error"
               +"\n" + "       FROM (SELECT doc.t_accTrnId,"
               +"\n" + "                    CASE"
               +"\n" + "                        WHEN "
               +"\n" + "                              NVL((SELECT Sum(symb.t_sum) "
               +"\n" + "                                   FROM dsymbcash_dbt symb"
               +"\n" + "                                  WHERE symb.t_dockind = 1"
               +"\n" + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
               +"\n" + "                                    AND symb.t_kind = 1), 0)"
               +"\n" + "                            < (SELECT Sum(symb.t_sum) "
               +"\n" + "                                   FROM dsymbcash_dbt symb"
               +"\n" + "                                  WHERE symb.t_dockind = 1"
               +"\n" + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
               +"\n" + "                                    AND symb.t_symbol IN (' 97', ' 99', '100'))"
               +"\n" + "                             THEN " + WRONG_SUM_97
               +"\n" + "                        WHEN "
               +"\n" + "                              NVL((SELECT Sum(symb.t_sum) "
               +"\n" + "                                   FROM dsymbcash_dbt symb"
               +"\n" + "                                  WHERE symb.t_dockind = 1"
               +"\n" + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
               +"\n" + "                                    AND symb.t_kind = 1), 0)"
               +"\n" + "                            <> (SELECT Sum(symb.t_sum) "
               +"\n" + "                                   FROM dsymbcash_dbt symb"
               +"\n" + "                                  WHERE symb.t_dockind = 1"
               +"\n" + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
               +"\n" + "                                    AND symb.t_symbol =' 85')"
               +"\n" + "                             THEN " + WRONG_SUM_85
               +"\n" + "                        WHEN "
               +"\n" + "                              NVL((SELECT Sum(symb.t_sum) "
               +"\n" + "                                   FROM dsymbcash_dbt symb"
               +"\n" + "                                  WHERE symb.t_dockind = 1"
               +"\n" + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
               +"\n" + "                                    AND symb.t_kind = 2), 0)"
               +"\n" + "                            <> (SELECT Sum(symb.t_sum) "
               +"\n" + "                                   FROM dsymbcash_dbt symb"
               +"\n" + "                                  WHERE symb.t_dockind = 1"
               +"\n" + "                                    AND symb.t_accTrnId = doc.t_accTrnId"
               +"\n" + "                                    AND symb.t_symbol =' 86')"
               +"\n" + "                             THEN " + WRONG_SUM_86
               +"\n" + "                    END error"
               +"\n" + "               FROM daccTrn_dbt doc "
               +"\n" + "              WHERE doc.t_chapter = 1"
               +"\n" + "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
               +"\n" + "                                         AND " + getSqlDate(m_endDate)
               + "\n"+ "                AND doc.t_fiId_payer = " + NATCUR
               + "\n"+ "                AND doc.t_fiId_receiver = " + NATCUR
               +"\n" + "                AND doc.t_kind_oper = ' 3')"
               +"\n" + "      WHERE error IS NOT NULL";

        return query;
    end;

    /**
    * Контроль 02-77,82-100 символов на отсутствие признака кассы
    */
    macro checkKindAccountForSymbols();
        var query = "INSERT INTO dfcshctrl_tmp"
             +"\n"+ "            (t_accTrnId, t_error, t_symbol)"
             +"\n"+ "     SELECT t_accTrnId, error, symbol"
             +"\n"+ "       FROM (SELECT doc.t_accTrnId,"
             +"\n"+ "                    CASE"
             +"\n"+ "                        WHEN (accDebet.t_balance = '20208') AND (accDebet.t_type_account = 'А') AND (accDebet.t_code_currency = " + NATCUR + ") THEN " + KIND_ACCOUNT_A_80_81
             +"\n"+ "                        WHEN ((accDebet.t_balance = '20202') OR (accDebet.t_balance = '20207')) AND (accDebet.t_code_currency = " + NATCUR + ")"
             +"\n"+ "                              AND (accDebet.t_type_account != 'А') THEN " + KIND_ACCOUNT_NO_A
             +"\n"+ "                    END error,"
             +"\n"+ "                    symb.t_symbol symbol"
             +"\n"+ "               FROM daccTrn_dbt doc, "
             +"\n"+ "                    dsymbcash_dbt symb,"
             +"\n"+ "                    daccount_dbt accDebet,"
             +"\n"+ "                    daccount_dbt accCredit"
             +"\n"+ "              WHERE doc.t_chapter = 1"
             +"\n"+ "                AND doc.t_accountId_payer = accDebet.t_accountId"
             +"\n"+ "                AND doc.t_accountId_receiver = accCredit.t_accountId"
             +"\n"+ "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
             +"\n"+ "                                         AND " + getSqlDate(m_endDate)
             +"\n"+ "                AND trim(doc.t_kind_oper) = '3'"
             +"\n"+ "                AND symb.t_dockind = 1"
             +"\n"+ "                AND (" + rcbAccountFilter.getAsSqlString("accDebet") +")"
             +"\n"+ "                AND (" + rcbAccountFilter.getAsSqlString("accCredit") +")"
             +"\n"+ "                AND symb.t_accTrnId = doc.t_accTrnId)"
             +"\n"+ "      WHERE error IS NOT NULL";
        return query;
    end;

    /**
    * Контроль проводок
    */
    macro checkSymbolsOnCarry();
        var query = "INSERT INTO dfcshctrl_tmp"
             +"\n"+ "            (t_accTrnId, t_error, t_symbol)"
             +"\n"+ "     SELECT t_accTrnId, error, symbol"
             +"\n"+ "       FROM (SELECT doc.t_accTrnId,"
             +"\n"+ "                    CASE"
             +"\n"+ "                        WHEN ((  substr(doc.T_ACCOUNT_PAYER,1,5) = '20208' OR substr(doc.T_ACCOUNT_RECEIVER,1,5) = '20208') "
             +"\n"+ "                              OR ((substr(doc.T_ACCOUNT_PAYER,1,5) != '20202' AND substr(doc.T_ACCOUNT_PAYER,1,5) != '20207') "
             +"\n"+ "                                 AND (substr(doc.T_ACCOUNT_RECEIVER,1,5) != '20202' AND substr(doc.T_ACCOUNT_RECEIVER,1,5) != '20207')"
             +"\n"+ "                                 AND (symb.t_kind = 1 OR symb.t_kind = 2))) "
             +"\n"+ "                        THEN " + SYMBOL_ON_CARRY
             +"\n"+ "                    END error,"
             +"\n"+ "                    symb.t_symbol symbol"
             +"\n"+ "               FROM daccTrn_dbt doc, "
             +"\n"+ "                    dsymbcash_dbt symb"
             +"\n"+ "              WHERE doc.t_chapter = 1"
             +"\n"+ "                AND doc.T_RESULT_CARRY <> 23 "
             +"\n"+ "                AND symb.t_accTrnId = doc.t_accTrnId"
             +"\n"+ "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
             +"\n"+ "                                         AND " + getSqlDate(m_endDate)
             +"\n"+ "                AND doc.t_fiId_payer = " + NATCUR
             +"\n"+ "                AND doc.t_fiId_receiver = " + NATCUR
             +"\n"+ "                AND trim(doc.t_kind_oper) = '3' )"
             +"\n"+ "      WHERE error IS NOT NULL";
        return query;
    end;

    macro controlSymbols()

        var balanceMask = getBalanceMask();

        sql_execute(checkSymbols(true, balanceMask));
        sql_execute(checkSymbols(false, balanceMask));

        sql_execute(checkSymbolSums(balanceMask));
        sql_execute(checkBalanceSymbols(balanceMask));
        sql_execute(checkOffBalanceSymbols());

        sql_execute(checkSymbolSumsBalance());
        sql_execute(checkSymbolSumsBalance02_89());
        sql_execute(checkSymbolSumsBalance40_96());
        sql_execute(checkSymbolSumsBalance97());
        sql_execute(checkSymbolSumsBalance98());
        sql_execute(checkKindAccountForSymbols());
        sql_execute(checkSymbolsOnCarry());

        check89Date();

        m_protocolView.printProtocol();
        m_protocolView.addFrom(m_okatoProtocolView);
    end;

    constructorTSourceDataControlOperation2627();
end;



class (TSourceDataControlOperation2627) TSourceDataControlOperation2835()
    initTSourceDataControlOperation2627();

    macro getBalanceMask()
        return "20202*";
    end;
    /**
    * Контроль 02-77,82-100 символов на отсутствие признака кассы
    */
    macro checkKindAccountForSymbols();
        var query = "INSERT INTO dfcshctrl_tmp"
             +"\n"+ "            (t_accTrnId, t_error, t_symbol)"
             +"\n"+ "     SELECT t_accTrnId, error, symbol"
             +"\n"+ "       FROM (SELECT doc.t_accTrnId,"
             +"\n"+ "                    CASE"
             +"\n"+ "                        WHEN (accDebet.t_balance = '20208') AND (accDebet.t_type_account = 'А') AND (accDebet.t_code_currency = " + NATCUR + ") THEN " + KIND_ACCOUNT_A_80_81
             +"\n"+ "                        WHEN (accDebet.t_balance = '20202') AND (accDebet.t_type_account != 'А') AND (accDebet.t_code_currency = " + NATCUR + ") THEN " + KIND_ACCOUNT_NO_A
             +"\n"+ "                    END error,"
             +"\n"+ "                    symb.t_symbol symbol"
             +"\n"+ "               FROM daccTrn_dbt doc, "
             +"\n"+ "                    dsymbcash_dbt symb,"
             +"\n"+ "                    daccount_dbt accDebet,"
             +"\n"+ "                    daccount_dbt accCredit"
             +"\n"+ "              WHERE doc.t_chapter = 1"
             +"\n"+ "                AND doc.t_accountId_payer = accDebet.t_accountId"
             +"\n"+ "                AND doc.t_accountId_receiver = accCredit.t_accountId"
             +"\n"+ "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
             +"\n"+ "                                         AND " + getSqlDate(m_endDate)
             +"\n"+ "                AND trim(doc.t_kind_oper) = '3'"
             +"\n"+ "                AND symb.t_dockind = 1"
             +"\n"+ "                AND (" + rcbAccountFilter.getAsSqlString("accDebet") +")"
             +"\n"+ "                AND (" + rcbAccountFilter.getAsSqlString("accCredit") +")"
             +"\n"+ "                AND symb.t_accTrnId = doc.t_accTrnId)"
             +"\n"+ "      WHERE error IS NOT NULL";
        return query;
    end;
    /**
    * Контроль проводок
    */
    macro checkSymbolsOnCarry();
        var query = "INSERT INTO dfcshctrl_tmp"
             +"\n"+ "            (t_accTrnId, t_error, t_symbol)"
             +"\n"+ "     SELECT t_accTrnId, error, symbol"
             +"\n"+ "       FROM (SELECT doc.t_accTrnId,"
             +"\n"+ "                    CASE"
             +"\n"+ "                        WHEN (substr(doc.T_ACCOUNT_PAYER,1,5) = '20208' OR substr(doc.T_ACCOUNT_RECEIVER,1,5) = '20208') "
             +"\n"+ "                             OR ((substr(doc.T_ACCOUNT_PAYER,1,5) != '20202') "
             +"\n"+ "                                 AND (substr(doc.T_ACCOUNT_RECEIVER,1,5) != '20202')"
             +"\n"+ "                                 AND (symb.t_kind = 1 OR symb.t_kind = 2)) "
             +"\n"+ "                        THEN " + SYMBOL_ON_CARRY
             +"\n"+ "                    END error,"
             +"\n"+ "                    symb.t_symbol symbol"
             +"\n"+ "               FROM daccTrn_dbt doc, "
             +"\n"+ "                    dsymbcash_dbt symb"
             +"\n"+ "              WHERE doc.t_chapter = 1"
             +"\n"+ "                AND doc.T_RESULT_CARRY <> 23 "
             +"\n"+ "                AND symb.t_accTrnId = doc.t_accTrnId"
             +"\n"+ "                AND doc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
             +"\n"+ "                                         AND " + getSqlDate(m_endDate)
             +"\n"+ "                AND doc.t_fiId_payer = " + NATCUR
             +"\n"+ "                AND doc.t_fiId_receiver = " + NATCUR
             +"\n"+ "                AND trim(doc.t_kind_oper) = '3' )"
             +"\n"+ "      WHERE error IS NOT NULL";
        return query;
    end;
end;


