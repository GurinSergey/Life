/**
* Печать протокола контроля исходных данных. Класс TSourceDataControlProtocolView и наследники.
*/

import BankInter;
import RsbDataSet;
import log_lib;
import RcbCoreInter;
import cb_sql;
import RcbProtocolView;
import repException;


/**
* Протокол контроля исходных данных.
*/
class (TProtocolView)TSourceDataControlProtocolView(description, reportName)

    private var m_beginDate;

    private var m_endDate;

    private var m_errorList = TArray();

    macro constructorTSourceDataControlProtocolView(description, reportName)

        initTProtocolView(description, reportName);

        m_isEmpty = true;

        m_beginDate         = rcbApplication().currentReport.context.period.beginDate;
        m_endDate           = rcbApplication().currentReport.context.period.endDate;
    end;

    macro printBody()
        throw(TPureVirtualMethodCallException("TSourceDataControlProtocolView::printBody"));
    end;

    macro getQuery()
        throw(TPureVirtualMethodCallException("TSourceDataControlProtocolView::getQuery"));
    end;

    macro printProtocol()

        setProtocolOutput();
        printHead();
        printBody();
        if (m_isEmpty)
            printNullData();
        end;
        resetProtocolOutput();
    end;

    constructorTSourceDataControlProtocolView(description, reportName);
end;

/**
* Протокол контроля по 1881-У.
*/
class (TSourceDataControlProtocolView) TSourceDataControlProtocolView1881(description, reportName)

    private macro constructorTSourceDataControlProtocolView1881(description, reportName)
        initTSourceDataControlProtocolView(description, reportName);

        m_errorList[0]  = "Внимание! Документ не содержит приходный кассовый символ";
        m_errorList[1]  = "Внимание! Документ не содержит расходный кассовый символ";
        m_errorList[2]  = "Ошибка! Приходный документ содержит неверный кассовый символ <##>";
        m_errorList[3]  = "Ошибка! Расходный документ содержит неверный кассовый символ <##>";
        m_errorList[4]  = "Ошибка! Кассовый символ <##> не соответствует справочнику символов";
        m_errorList[5]  = "Внимание! Сумма разнесения по символам  не равна сумме документа";
        m_errorList[6]  = "Ошибка! Кассовый символ <##> стоит на документе, не затрагивающем счет кассы";
        m_errorList[7]  = "Ошибка! Для документа с символом 89 должен быть установлен балансовый символ <02>";
        m_errorList[8]  = "Ошибка! Дата проведения операции должна быть <первый рабочий день месяца в формате дд.мм.гггг>";
        m_errorList[9]  = "Ошибка! Для документа с символом 96 должен быть установлен балансовый символ <40>";
        m_errorList[10]  = "Ошибка! Для документа с символом 97 должен быть установлен балансовый символ прихода";
        m_errorList[11] = "Ошибка! Для документа с символом 98 должен быть установлен балансовый символ расхода";
        m_errorList[12] = "Ошибка! Сумма по символу 89 должна быть меньше или равна сумме по балансовому символу 02.";
        m_errorList[13] = "Ошибка! Сумма по символу 96 должна быть меньше или равна сумме по балансовому символу 40.";
        m_errorList[14] = "Ошибка! Сумма по символу 97 должна быть меньше или равна сумме по балансовым символам прихода.";
        m_errorList[15] = "Ошибка! Сумма по символу 98 должна быть меньше или равна сумме по балансовым символам расхода.";
        m_errorList[16] = "Ошибка! Сумма по забалансовым символам должна быть меньше или равна сумме по балансовым символам";
    end;

    macro printNullData()
        println("Ошибок в распределении кассовых документов по символам выявлено не было.");
    end;

    macro getQuery()
        var query = "   SELECT DISTINCT arhdoc.t_numb_document    document_number,"
        + "\n"  + "          arhdoc.t_date_carry       document_date,"
        + "\n"  + "          arhdoc.t_account_payer    account_payer,"
        + "\n"  + "          arhdoc.t_account_receiver account_receiver,"
        + "\n"  + "          arhdoc.t_sum_payer        document_sum,"
        + "\n"  + "          CASE cashcontrol.t_error"
        + "\n"  + "              WHEN 0  THEN '"+ m_errorList[0]  +"'"
        + "\n"  + "              WHEN 1  THEN '"+ strsubst(m_errorList[1], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
        + "\n"  + "              WHEN 2  THEN '"+ strsubst(m_errorList[2], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
        + "\n"  + "              WHEN 3  THEN '"+ strsubst(m_errorList[3], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
        + "\n"  + "              WHEN 4  THEN '"+ strsubst(m_errorList[4], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
        + "\n"  + "              WHEN 5  THEN '"+ strsubst(m_errorList[5], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
        + "\n"  + "              WHEN 6  THEN '"+ m_errorList[6]  +"'"
        + "\n"  + "              WHEN 7  THEN '"+ m_errorList[7]  +"'"
        + "\n"  + "              WHEN 8  THEN '"+ m_errorList[8]  +"'"
        + "\n"  + "              WHEN 9  THEN '"+ strsubst(m_errorList[9], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
        + "\n"  + "              WHEN 10 THEN '"+ m_errorList[10] +"'"
        + "\n"  + "              WHEN 11 THEN '"+ m_errorList[11] +"'"
        + "\n"  + "              WHEN 12 THEN '"+ m_errorList[12] +"'"
        + "\n"  + "              WHEN 13 THEN '"+ m_errorList[13] +"'"
        + "\n"  + "              WHEN 14 THEN '"+ m_errorList[14] +"'"
        + "\n"  + "              WHEN 15 THEN '"+ m_errorList[15] +"'"
        + "\n"  + "          END error_text"
        + "\n"  + "     FROM dfcshctrl_tmp cashcontrol,"
        + "\n"  + "          daccTrn_dbt arhdoc"
        + "\n"  + "    WHERE arhdoc.t_chapter = 1"
        + "\n"  + "      AND arhdoc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
        + "\n"  + "                                  AND " + getSqlDate(m_endDate)
        + "\n"  + "      AND arhdoc.t_result_carry != " + RUBCARRY
        + "\n"  + "      AND cashcontrol.t_accTrnId = arhdoc.t_accTrnId"
        + "\n"  + "      AND arhdoc.t_chapter       = 1"
        + "\n"  + " ORDER BY document_number, document_date";

        return query;
    end;

    macro printBody()
        var dumper = SQL_Dumper();
        var query = getQuery();

        dumper.AddColumn("document_number",  "№ докум",         5);
        dumper.AddColumn("document_date",    "Дата докум",      10);
        dumper.AddColumn("account_payer",    "Счет по дебету",  25);
        dumper.AddColumn("account_receiver", "Счет по кредиту", 25);
        dumper.AddColumn("document_sum",     "Сумма",           16);
        dumper.AddColumn("error_text",       "Примечание",      21);

        m_isEmpty = not(dumper.Dump(query));
    end;

    constructorTSourceDataControlProtocolView1881(description, reportName);
end;

/**
* Протокол контроля по 2332-У.
*
* отличия от 1881У:
*                   к проверкам по 97 символы добавлены 99, 100
*/
class (TSourceDataControlProtocolView1881) TSourceDataControlProtocolView2332(description, reportName)

    private macro constructorTSourceDataControlProtocolView2332(description, reportName)
        initTSourceDataControlProtocolView1881(description, reportName);

        m_errorList[9]  = "Ошибка! Для документа по символу <##> должен быть установлен балансовый символ прихода";
        m_errorList[13] = "Ошибка! Сумма по символам 97, 99, 100 должна быть меньше или равна сумме по балансовым символам прихода.";
    end;

    constructorTSourceDataControlProtocolView2332(description, reportName);
end;

/**
* Протокол контроля по 2627-У.
*/
class (TSourceDataControlProtocolView2332) TSourceDataControlProtocolView2627(description, reportName)

    private macro constructorTSourceDataControlProtocolView2627(description, reportName)
        initTSourceDataControlProtocolView2332(description, reportName);

        m_errorList[17] = "Ошибка! Символ 85 может быть установлен только для кассового документа по приходу, у которого контрагент по счету кредита имеет категорию ""Тип субъекта"" со значением ""Ломбард""";
        m_errorList[18] = "Ошибка! Сумма по символу 85 должна быть равна сумме по балансовым символам прихода.";
        m_errorList[19] = "Ошибка! Символ 86 может быть установлен только для кассового документа по расходу, у которого контрагент по счету дебита имеет категорию ""Тип субъекта"" со значением ""Ломбард""";
        m_errorList[20] = "Ошибка! Сумма по символу 86 должна быть равна сумме по балансовым символам расхода.";
        m_errorList[21] = "Ошибка! Для документа с символом 87 должен быть установлен балансовый символ 19 или 32";
        m_errorList[22] = "Ошибка! Для документа с символом 88 должен быть установлен балансовый символ 53 или 58.";
        m_errorList[23] = "Внимание! На лицевом счете <##> установлен тип А - Счет кассы.";
        m_errorList[24] = "Внимание! На лицевом счете <##> не установлен тип А - Счет кассы.";
        m_errorList[25] = "Ошибка! Кассовый символ <##> стоит на проводке, не затрагивающей счет кассы.";
    end;

    macro printNullData()
        println("Ошибок в распределении кассовых документов по символам выявлено не было.");
    end;

    macro getQuery()
        var query = "   SELECT DISTINCT arhdoc.t_numb_document    document_number,"
                +"\n" + "          arhdoc.t_date_carry       document_date,"
                +"\n" + "          arhdoc.t_account_payer    account_payer,"
                +"\n" + "          arhdoc.t_account_receiver account_receiver,"
                +"\n" + "          arhdoc.t_sum_payer        document_sum,"
                +"\n" + "          CASE cashcontrol.t_error"
                +"\n" + "              WHEN 0  THEN '"+ m_errorList[0]  +"'"
                +"\n" + "              WHEN 1  THEN '"+ strsubst(m_errorList[1], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "              WHEN 2  THEN '"+ strsubst(m_errorList[2], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "              WHEN 3  THEN '"+ strsubst(m_errorList[3], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "              WHEN 4  THEN '"+ strsubst(m_errorList[4], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "              WHEN 5  THEN '"+ strsubst(m_errorList[5], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "              WHEN 6  THEN '"+ m_errorList[6]  +"'"
                +"\n" + "              WHEN 7  THEN '"+ m_errorList[7]  +"'"
                +"\n" + "              WHEN 8  THEN '"+ m_errorList[8]  +"'"
                +"\n" + "              WHEN 9  THEN '"+ strsubst(m_errorList[9], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "              WHEN 10 THEN '"+ m_errorList[10] +"'"
                +"\n" + "              WHEN 11 THEN '"+ m_errorList[11] +"'"
                +"\n" + "              WHEN 12 THEN '"+ m_errorList[12] +"'"
                +"\n" + "              WHEN 13 THEN '"+ m_errorList[13] +"'"
                +"\n" + "              WHEN 14 THEN '"+ m_errorList[14] +"'"
                +"\n" + "              WHEN 15 THEN '"+ m_errorList[15] +"'"
                +"\n" + "              WHEN 16 THEN '"+ m_errorList[16] +"'"
                +"\n" + "              WHEN 17 THEN '"+ m_errorList[17] +"'"
                +"\n" + "              WHEN 18 THEN '"+ m_errorList[18] +"'"
                +"\n" + "              WHEN 19 THEN '"+ m_errorList[19] +"'"
                +"\n" + "              WHEN 20 THEN '"+ m_errorList[20] +"'"
                +"\n" + "              WHEN 21 THEN '"+ m_errorList[21] +"'"
                +"\n" + "              WHEN 22 THEN '"+ m_errorList[22] +"'"
                +"\n" + "              WHEN 23 THEN "
                +"\n" + "                          CASE "
                +"\n" + "                              WHEN (substr(arhdoc.t_account_payer,1,5) = '20208') AND (substr(arhdoc.t_account_receiver,1,5) = '20208') "
                +"\n" + "                                  THEN  '"+ strsubst(m_errorList[23], "<##>", "'|| dacc.t_account ||'") +"'"
                +"\n" + "                              WHEN (substr(arhdoc.t_account_payer,1,5) = '20208')   "
                +"\n" + "                                  THEN  '"+ strsubst(m_errorList[23], "<##>", "'|| arhdoc.t_account_payer ||'") +"'"
                +"\n" + "                              WHEN (substr(arhdoc.t_account_receiver,1,5) = '20208') "
                +"\n" + "                                  THEN  '"+ strsubst(m_errorList[23], "<##>", "'|| t_account_receiver ||'") +"'"
                +"\n" + "                           END       "
                +"\n" + "              WHEN 24 THEN  "
                +"\n" + "                          CASE "
                +"\n" + "                              WHEN (((substr(arhdoc.t_account_payer,1,5) = '20202') OR (substr(arhdoc.t_account_payer,1,5) = '20207')) "
                +"\n" + "                                    AND ((substr(arhdoc.t_account_receiver,1,5) = '20202') OR (substr(arhdoc.t_account_receiver,1,5) = '20207'))) "
                +"\n" + "                                  THEN  '"+ strsubst(m_errorList[24], "<##>", "'|| dacc.t_account ||'") +"'"
                +"\n" + "                              WHEN (substr(arhdoc.t_account_payer,1,5) = '20202') OR (substr(arhdoc.t_account_payer,1,5) = '20207') "
                +"\n" + "                                  THEN  '"+ strsubst(m_errorList[24], "<##>", "'|| arhdoc.t_account_payer ||'") +"'"
                +"\n" + "                              WHEN (substr(arhdoc.t_account_receiver,1,5) = '20202') OR (substr(arhdoc.t_account_receiver,1,5) = '20207') "
                +"\n" + "                                  THEN  '"+ strsubst(m_errorList[24], "<##>", "'|| arhdoc.t_account_receiver ||'") +"'"
                +"\n" + "                           END         "
                +"\n" + "              WHEN 25 THEN '"+ strsubst(m_errorList[25], "<##>", "'|| cashcontrol.t_symbol ||'") +"'"
                +"\n" + "          END error_text"
                +"\n" + "     FROM dfcshctrl_tmp cashcontrol,"
                +"\n" + "          daccTrn_dbt arhdoc,"
                +"\n" + "          daccount_dbt dacc"
                +"\n" + "    WHERE arhdoc.t_chapter = 1"
                +"\n" + "      AND arhdoc.t_date_carry BETWEEN " + getSqlDate(m_beginDate)
                +"\n" + "                                  AND " + getSqlDate(m_endDate)
                +"\n" + "      AND arhdoc.t_result_carry != " + RUBCARRY
                +"\n" + "      AND cashcontrol.t_accTrnId = arhdoc.t_accTrnId"
                +"\n" + "      AND arhdoc.t_chapter       = 1"
                +"\n" + "      AND ((dacc.t_account = arhdoc.t_account_payer) OR (dacc.t_account = arhdoc.t_account_receiver))"
                +"\n" + " ORDER BY document_number, document_date";

        return query;
    end;

    constructorTSourceDataControlProtocolView2627(description, reportName);
end;
