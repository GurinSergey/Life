/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   EVG Банк ЭВ

       Макрос пользовательского алгоритма расчёта базовых сумм комиссии 3.4.7
       "Прочие платежи по системе "Интернет-Клиент" до 16-00".

       Тип комиссии - периодическая.
       
       ChangeLog:
       
   //RR 06.11.2014 Убрал дубль проверки платежей на банк, проверка реализована в функции EXV_GetCom3RecordSet
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

import sfinter, ctinter, cb_sql;
import ExvComLib;

import lib_packetCommission;

/*    Если при расчете произошла ошибка, поместить в эту переменную ненулевое значение*/
var MacroError :integer = 0;
private var FICode_calc:string = "";

  /* Тип величины
enum SfBaseTypes{*/
private const   SF_BASETYPE_SUM     = 1;      /* Сумма*/
private const   SF_BASETYPE_QUONT   = 2;      /* Количество*/

private const NATCUR = 0;
record sfbassum( "sfbassum.str" );
record paym(pmpaym);

/* EVG Добавил приём структуры sfcontr для вызова из макроса sfacrpay.mac */
macro CalcServiceSum( sfcontr_addr/*Договор обслуживания*/, BeginDate/*Начало периода*/, EndDate/*Конец периода*/,
      sAddr /* EVG Какой-то ещё адрес */, sfcontrStruc /*Cтруктура sfcontr*/ )
DebugBreak;
    record sfcontr( sfcontr );
    var CommQuont   = 0,
        CommSum     = $0;
    var rs, stat;

    var DayEndTime, DocTime, DocDate;
    var recBank;

    /* EVG При вызове из sfacrpay.mac используем полученную структуру sfcontrStruc вместо адреса sfcontr_addr */
    if ( ValType (sfcontr_addr) != V_UNDEF )
       SetBuff( sfcontr, sfcontr_addr );
    else
       Copy ( sfcontr, sfcontrStruc );
    end;

    // 2012-09-03 zip_z. C-13540 Для периодической комиссии 3.4.7 (ГЭБ) при простановке категории 
    // 200 на клиенте комиссия не рассчитывается, т.е. дальнейшие приседания бессмысленны
    // lib_packetCommission::isConnectedPacketCommissionOnDate ()
    // #0
    if (not (isConnectedPacketCommissionOnDate (sfcontr.object, endDate)))
        /* EVG 03/05/2011 Чтение настройки с временем окончания опердня */
        DayEndTime = GetOperDayEndTime();
    
        rs = EXV_GetCom3RecordSet( sfcontr.Object, CLB_DocOrigin, BeginDate, EndDate );
        while ( rs and rs.MoveNext() )
          /* Получим время платежа */
          DocTime = gettimeP( rs.PaymentId, EndDate, @DocDate );
          if ( ( DocTime < DayEndTime ) or (DocDate < EndDate) )
              CommQuont = CommQuont + 1;
          end;
        end;
    end;
       
    /* EVG При вызове из sfacrpay.mac возвращаем true в случае положительного результата расчёта */
    if ( ValType (sfcontrStruc) != V_UNDEF )
       if (CommQuont > 0)
          return true;
       end;
       return false;
    end;

    ClearRecord(sfbassum);

    sfbassum.baseType    = SF_BASETYPE_QUONT;
    sfbassum.baseQuont   = CommQuont;

    sfbassum.baseType2   = SF_BASETYPE_QUONT;
    sfbassum.baseQuont2  = CommQuont;
    sfbassum.baseSum2    = CommSum;

    stat = InsertSumList(sfbassum);

    if( stat )
      MsgBox("Ошибка при вставке базовой суммы");
    end;


end;/*CalcServiceSum*/