/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   ████████   ████████
   ███   ███  ███   ███
   ███  ████  ███  ████
   ███████    ███████
   ███  ███   ███  ███
   ███   ███  ███   ███

   RR Рахмедов Р.С.

   Имя файла: Comiss_Agent_Update_Tasks.mac

   Создан:    22.05.2013

   Описание:  Макрос для обновления статуса заданий usr_comiss_agent_job
   
   P.S.       Редактирование, рефаторинг, добавление новых функций запрещено, все делать по согласованию со мной.
              
   ChangeLog:
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 04.04.2014 Из-за проблем с календарем, временно ввожу свою проверку на рабочие дни GetDayType()
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 11.04.2014 После установки 20-го ХФ устанены проблем с календарем. Добавлен вызов функции выполняющей переход в последний опер. день
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

Import Globals, lib_rsbsession, Календарь;

 MACRO WriteUsrLog (msg, param)
 var cmd, RobotInfo;
 var ORA = RSL_OraSession ();
 
   if (ValType(param) == v_undef);
      param = "";
   end;
   
   RobotInfo = ora.sid + "_" + ora.serial+"$"+ora.logon_time+"$"+ora.osuser+"$"+ora.machine;
   cmd = RSDCommand("INSERT INTO USR_COMISS_AGENT_LOG (T_AGENT_INFO, T_TEXT, T_COMMAND) VALUES ('Робот_"+ora.sid+":" +msg+"', '"+param+"','"+RobotInfo+"')");
   cmd.execute();
 END;
 
 MACRO UpdateTask()
 var cmd;
  cmd = RSDCommand("UPDATE usr_comiss_agent_job SET t_job_is_done = CHR (88) where T_ID = 9998");
  cmd.execute();
END;
debugbreak; 
//Точка входа

 ExecMacroFile("CurDateProc.mac","usr_SetOperDay"); //Устанавливаем последний открытый опер. день
 if (IsWorkDay({curdate}))
   UpdateTask();
   WriteUsrLog("Журнал заданий агента комиссий обновлен");
 else
   WriteUsrLog("Журнал заданий агента комиссий НЕ обновлен");
 end;