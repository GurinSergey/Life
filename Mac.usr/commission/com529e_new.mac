/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   joy Банк ЭВ

       Макрос пользовательского алгоритма расчёта базовых сумм по комиссии 5.2.9
       " Выдача наличных:
         - прочее (на сумму свыше 5 млн. руб.)

       (при общей сумме снятия наличных на прочие цели  свыше 5 млн. руб. в месяц)

       Тип комиссии - единовременная.

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

//import sfinter, ptinter, cb_sql;
//import CommissLib;
import sfinter, ptinter, cb_sql, globals, oprinter;


var MacroError :integer = 0;


 
private const   SF_BASETYPE_SUM     = 1;      /* Сумма*/
private const   SF_BASETYPE_QUONT   = 2;      /* Количество*/

private const NATCUR = 0;
  record sfbassum( "sfbassum.str" );

/* Символ кассы, по которому берётся данная комиссия */
CONST CommCashSymbol = "('53', '42', '46', '54', '58', '60', '61')";    // прочие

CONST LimitSum = $5000000.01;

var  SymbSum = $0, TotalCashSum = $0, SumOfBases = $0;

/*
    Расчет для единовременных комиссий
*/
macro CalcCommissionSum( docKind/*Тип первички*/, Doc/*Буфер первички*/, sfcalcalusr_addr/*Алгоритм расчета*/, sfcontr_addr /*Договор обслуживания*/, beginDate, endDate  )
    record sfclusr( "sfclusr.str" );
    record sfcontr( sfcontr );
    record sfcalcal(sfcalcal);
    record cashDoc(pscshdoc);

    var stat:integer; 
    var query, rs;
    var CommSum   = $0,
        SymbSum   = $0,
        TotalCashSum;
                
    SetBuff( sfcalcal, sfcalcalusr_addr );
    SetBuff( sfcontr, sfcontr_addr );
    SetBuff( cashDoc, Doc );


    // Комиссия по чекам
    if ( docKind == CASH_PS_OUTORDER )
    
        /************************************************************/
        /*Получаем глобальные параметры и разрушаем все, так как это последняя комиссия в серии комиссий 5.2.* */
        SymbSum      = GetGlobalParameter("SymbSumGlob"+ string (cashDoc.AutoKey), true);
        TotalCashSum = GetGlobalParameter("TotalCashSumGlob"+ string (cashDoc.AutoKey), true);
        SumOfBases   = GetGlobalParameter("SumOfBasesGlob"+ string (cashDoc.AutoKey), true); 
        /************************************************************/


        if (TotalCashSum == 0)
            if (SymbSum > LimitSum)
                CommSum = SymbSum - SumOfBases;
            else
                CommSum = 0;
            end;
        else
            if (TotalCashSum > LimitSum)
                CommSum = SymbSum;
            else
                if ((SymbSum - SumOfBases) > 0)
                    CommSum = SymbSum - SumOfBases;
                else  
                    CommSum = 0;
                end;
            end;
        end;
    end;
    
    if (( CommSum < $0 ) or (CommSum > SymbSum) ) // На всякий случай
        CommSum = $0;
    end;

    ClearRecord(sfbassum);

    sfbassum.baseType  = SF_BASETYPE_SUM;
    sfbassum.baseSum   = CommSum;

    sfbassum.baseType2  = SF_BASETYPE_SUM;
    sfbassum.baseSum2   = CommSum;

    stat = InsertSumList(sfbassum);

    if( stat )
      MsgBox("Ошибка при вставке базовой суммы: ", GetErrMsg );
    end;


    
end;


