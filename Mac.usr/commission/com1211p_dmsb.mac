/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
RR - Рахмедов Руслан 22.04.2012
Комиссия 12.1.2 
Тип комиссии: Периодическая
Имя файла com1212p.mac
Изменения:
        22.01.2012 RR Исправлена макска счетом отбора с 40817 на 40807
        20.12.2012 zip_z. C-16217 изменен механихм расчёта базовой суммы согласно ТЗ
        18.02.2013 zip_z. рефакторинг
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

import sfinter, lib_fc_corporate;

record sfbassum( "sfbassum.str" );

macro CalcServiceSum( sfcontr_addr, BeginDate, EndDate, sAddr, sfcontrStruc)
    DebugBreak ();
    private const   SF_BASETYPE_SUM     = 1;      /* Сумма*/
    private const   SF_BASETYPE_QUONT   = 2;      /* Количество*/

    record sfcontr( sfcontr );
        
    /* EVG При вызове из sfacrpay.mac используем полученную структуру sfcontrStruc вместо адреса sfcontr_addr */
    if ( ValType (sfcontr_addr) != V_UNDEF )
        SetBuff( sfcontr, sfcontr_addr );
    else
        Copy ( sfcontr, sfcontrStruc );
    end;

    var CommQuont = 0;
    if (Acc_IsCardAccount (sfcontr.object))
        CommQuont = Com_FC_GetBaseQuantity (sfcontr.PartyID, EndDate, true, false, false);
    end;
    
    if ( ValType (sfcontrStruc) != V_UNDEF )
        return (CommQuont > 0);
    end;

    sfbassum.baseType  = sfbassum.baseType2  = SF_BASETYPE_QUONT;
    sfbassum.baseQuont = sfbassum.baseQuont2 = CommQuont;

    if (InsertSumList(sfbassum))
        msgbox ("Ошибка при вставке базовой суммы");
    end;
end;

