/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   joy Жаворонкова Н.

   Создан:    29.05.2015

   Описание:  Макрос выполняющий подключение ежедневных комиссий 3.4.8 для ВУЗа. За основу взят макрос ConnectSfContr2.mac

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
import "ConnectSfcontr_MainProc.mac";
import bankInter;

private var Comiss,
            err,
            ProcName,
            indMessage,
            OperDate,
            OperDayProlongTime,
            LifeBank = fg_life_subject( {OurBank} );

if (LifeBank.is_VUZ)
      /* Дата выполнения процедуры */
      OperDate = {CurDate} - 1;
      if ( not GetDate( OperDate, "Пожалуйста, введите дату расчёта комиссии:" ) )
         exit(1);
      end;

      /* Время продления опердня */

      // Чтение настройки
      var regPath = "PRBB\\СЕРВИС ГКБО\\ПРОДЛЕНИЕ ОПЕРДНЯ",
          defTime = "16:00";
      GetRegistryValue( regPath, V_STRING, OperDayProlongTime, err );
      if ( ( err != 0 )
           or ( strLen( trim( OperDayProlongTime ) ) == 0 ) )

         OperDayProlongTime = defTime;

      elif ( index( OperDayProlongTime, ":" ) == 0 )
         msgbox ("Неправильный формат времени в настройке \""+ regPath +"\": " + OperDayProlongTime +
                 "|Время должно быть указано в формате HH:MM" );
         OperDayProlongTime = defTime;
      end;
      OperDayProlongTime = trim( OperDayProlongTime );

      // Запрос корректировки
      while( GetString( OperDayProlongTime, "Пожалуйста, введите время продления опердня в формате HH:MM") 
             and index( OperDayProlongTime, ":" ) == 0 )

         msgbox ("Вы указали неправильный формат времени. Необходимо использовать формат HH:MM");
         OperDayProlongTime = defTime;
      end;

      // Сохранение настройки
      if ( not SetDefaultRegistryValue( regPath, OperDayProlongTime ) )
         msgbox ( "Ошибка сохранения времени продления опердня.|Время продления опердня не сохранено.");
      end;

      if (not WriteFiscLog (OLSTRPROC, "ЗАПУСК ПРОЦЕДУРЫ ОТКЛЮЧЕНИЯ\ПОДКЛЮЧЕНИЯ КОМИССИЙ 3.4.8\n" + 
                                       "Дата: " + OperDate + "\n"
                                       "Время продления ОД: " + OperDayProlongTime + "\n" + 
                                       "Макрос: ConnectSfcontr34Vuz.mac"))
          msgbox ("Не удалось добавить запись о старте процедуры в фискальный журнал");

      end;
     
     //Точка входа
       if (GetTrue(false, "Произвести подключение комиссии?\n ДА - выполнить подключение и вывести лог\n НЕТ - вывести лог предыдущего подключения"))
         ExecMacroFile ("ConnectSfcontr_MainProc.mac", "RunConnect34VUZ", OperDate, true, OperDayProlongTime, true);
       else
         ExecMacroFile ("ConnectSfcontr_MainProc.mac", "RunConnect34VUZ", OperDate, false, OperDayProlongTime, true);
       end;

     
      if (not WriteFiscLog (OLFINPROC, "ОКОНЧАНИЕ ПРОЦЕДУРЫ ПРОЦЕДУРЫ ОТКЛЮЧЕНИЯ\ПОДКЛЮЧЕНИЯ КОМИССИЙ 3.4.8\n" + 
                                       "Дата: " + OperDate + "\n"
                                       "Время продления ОД: " + OperDayProlongTime + "\n" + 
                                       "Макрос: ConnectSfcontr34Vuz.mac"))
          msgbox ("Не удалось добавить запись об окончании процедуры в фискальный журнал");

      end;
      
      println ("Время продления опер дня - " + OperDayProlongTime);
else
    msgbox ("Данная процедура подключения 3.4.8 используется только в ВУЗе");
return 1;
end;

