/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

       Макрос пользовательского алгоритма расчёта базовых сумм комиссии 7.5.4
       "Комиссияза пользование пакетом услуг <Информационный>, в год ". 
       Основывается на категории.

       Тип комиссии - периодическая. C-35437

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

import sfinter, ctinter, currinter, fiinter, Commisslib;
Import lib_fg;
/*
    Если при расчете произошла ошибка, поместить в эту переменную ненулевое значение
*/
var MacroError :integer = 0;
private var FICode_calc:string = "";

  /* Тип величины
enum SfBaseTypes{*/
private const   SF_BASETYPE_SUM     = 1;      /* Сумма*/
private const   SF_BASETYPE_QUONT   = 2;      /* Количество*/

private const NATCUR = 0;
record sfbassum( "sfbassum.str" );
private var CommNumber754 = 1139;// Саратов по умолчанию
if ((fgbank.is_EXV_Volgograd) or (fgbank.is_EXV_Voronezh))
    CommNumber754 = 1138;
elif (fgbank.is_EXV_Stavropol)
    CommNumber754 = 1136;
end;
    

const UsTypeConsulting = "#";      // Польз. тип счёта "ЦТО ДМСБ"
var ComCode = "7.5.4";
var period = 12; // Комиссия годовая

/*
    Расчет для периодических комиссий
*/
/* EVG Добавил приём структуры sfcontr для вызова из макроса sfacrpay.mac */
macro CalcServiceSum( sfcontr_addr/*Договор обслуживания*/, BeginDate/*Начало периода*/, EndDate/*Конец периода*/,
      sAddr /* EVG Какой-то ещё адрес */, sfcontrStruc /*Cтруктура sfcontr*/)
debugbreak;
    record sfcontr( sfcontr );
    var query, rs, stat;
    var tblName,
        CommQuont = 0;
    var ComCode = "7.5.4";
    var period = 12; // Комиссия годовая

    /* EVG При вызове из sfacrpay.mac используем полученную структуру sfcontrStruc вместо адреса sfcontr_addr */
    if ( ValType (sfcontr_addr) != V_UNDEF )
       SetBuff( sfcontr, sfcontr_addr );
    else
       Copy ( sfcontr, sfcontrStruc );
    end;
    
    // joy определяем наличие категории 
    var category  = RsbObjCategories(OBJTYPE_PARTY,  strLpad(string(sfcontr.PartyID), 10, "0"));
    var info_pack_year  = category.IsAttrPresense (202, 1,  NULL, NULL, false, {curdate} );

    if ( info_pack_year and (CheckUserField( sfcontr.PartyID, UsTypeConsulting )) and CheckUPK(CommNumber754, sfcontr.object) and CheckPreviousUPK (ComCode, sfcontr.ID, period, EndDate ) ) 
        CommQuont = 1;
    end;
   

    /* EVG При вызове из sfacrpay.mac возвращаем true в случае положительного результата расчёта */
    if ( ValType (sfcontrStruc) != V_UNDEF )
       if (CommQuont > 0)
          return true;
       end;
       return false;
    end;

    
    ClearRecord(sfbassum);

    sfbassum.baseType = SF_BASETYPE_QUONT;
    sfbassum.baseQuont  = CommQuont;

    sfbassum.baseType2 = SF_BASETYPE_QUONT;
    sfbassum.baseQuont2  = CommQuont;

    stat = InsertSumList(sfbassum);

    if( stat )
      MsgBox("Ошибка при вставке базовой суммы");
    end;

    
end;/*CalcServiceSum*/



