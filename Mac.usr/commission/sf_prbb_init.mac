/* MEV, RSSL, 03/06/209
 * Макрос инициализации для операций обработки разовых комиссий
 */
import "sf_prbb.mac";

MACRO InitOperation(kind_oper, doc_kind, adr)
    record comm( "sfsingdf.dbt" );
    var Ret = 0, rest, Acc = null;
    
    SetBuff(comm, adr);
    
    //DebugBreak;
    rest = AccGetFreeAmount(comm.accountpayer, 1, comm.FiidPayer, 6, 0, comm.CommDate);
    if (rest>=(comm.Sum+comm.SumNDS))
    /* 1.1.1.1. Если средств на счете плательщика достаточно, по комиссии начинается операция взимания. 
                В дальнейшем на оплату этой комиссии будет сформирован документ оплаты.*/
        ret = 0;
    else
        /* 1.1.1.2.     Если средств на счете плательщика недостаточно, выполняется поиск счёта, остаток которого 
                    достаточен для исполнения платежа по комиссии.*/
        selectAccountForSfPay(comm.Sum+comm.SumNDS, comm.FiidPayer, comm.CommDate, getClient4Account(comm.accountpayer, comm.FiidPayer), SF_FEE_TYPE_ONCE, comm.ID);
        Acc = getFoundedAcc();
        
        if ((Acc!=null) and isEnougthRest4Comm())
           /*   1.1.1.2.1.      Если такой счет найден, этот счет переносится в форму разовой комиссии, комиссия перемещается 
                           в список открытых, и по комиссии начинается операция взимания. В дальнейшем на оплату этой 
                           комиссии будет сформирован документ оплаты.*/
                comm.userfield2 = comm.accountpayer;
                comm.accountpayer = Acc.account;
            ret = 0;
        else
            /*   1.1.1.2.2.     Если счета, остаток которого достаточен для исполнения платежа по комиссии, найти не удалось, 
                            пользователю выдаётся диагностическое сообщение "На счетах плательщика недостаточно средств для 
                            оплаты комиссии. Продолжить? <Нет, Да>".*/
                if (not GetTrue(false, "На счетах плательщика недостаточно средств для оплаты комиссии. Продолжить?"))
                /*   1.1.1.2.2.1.       Если пользователь ответил "Нет", операция взимания разовой комиссии не выполняется, 
                                                        разовая комиссия остаётся в отложенных. В дальнейшем пользователь может либо заново 
                                                        инициировать операцию взимания комиссии (при поступлении средств на счет клиента), 
                                                        либо удалить отложенную разовую комиссию.*/
                ret = 1;
            else
                /*   1.1.1.2.2.2.       Если пользователь ответил "Да", по комиссии начинается операция взимания. В дальнейшем 
                                                        на оплату этой комиссии будет сформирован документ оплаты, ко-торый будет автоматически 
                                                        поставлен в картотеку 2.*/
                        ret = 0;
                end;
        end;
    end;

    return Ret;
END;