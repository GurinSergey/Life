/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   Жаворонкова Н.С-24098 Макрос комиссии 5.18.0 за оформление кассового чека
   
   Create: 11.10.2013
   
   Тип комиссии - единовременная.

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/


import sfinter, ptinter, cb_sql, CTInter, OprInter, lib_compare;
Import lib_fg;

/*
    Если при расчете произошла ошибка, поместить в эту переменную ненулевое значение
*/
var MacroError :integer = 0;
private var FICode_calc:string = "";

  /* Тип величины
enum SfBaseTypes{*/
private const   SF_BASETYPE_SUM     = 1;      /* Сумма*/
private const   SF_BASETYPE_QUONT   = 2;      /* Количество*/

private const NATCUR = 0;
  record sfbassum( "sfbassum.str" );
  record paym(pmpaym);


/* Номер категории, которая определяет тариф для платежей */
var TarifNumber = "5.18.0"; 
/* ID Категории  */
const GroupID = 1019; 


/*
    Расчет для единовременных комиссий
*/
macro CalcCommissionSum( docKind/*Тип первички*/, Doc/*Буфер первички*/, sfcalcalusr_addr/*Алгоритм расчета*/, sfcontr_addr /*Договор обслуживания*/, beginDate, endDate  )
    record sfclusr( "sfclusr.str" );
    record sfcontr( sfcontr );
    record sfcalcal(sfcalcal);
    record cashDoc(pscshdoc);

    var stat:integer; 
    var CommQuont   = 0,
        Num,
        retVal,
        error;
    /* 22.10.2013  Добавлены номера признаков категорий для ВУЗа и ЭВ+филиалы*/
    if (fgbank.is_VUZ)
        TarifNumber = "5.12.0";
    elif (fgbank.is_EXV)
        TarifNumber = "2.30.1"; 
    end;

    SetBuff( sfcalcal, sfcalcalusr_addr );
    SetBuff( sfcontr, sfcontr_addr );
    SetBuff( cashDoc, Doc );

    Num = "";

    ClearRecord(paym);
    paym.PaymentID = cashDoc.AutoKey;                    

    GetMainObjAttr (retVal, OBJTYPE_PAYMENT, UniID(paym, OBJTYPE_PAYMENT), GroupID, null, null, Num);
    
    debugbreak;
       // Комиссия по чекам ручного ввода
    if ((docKind == CASH_PS_OUTORDER) and (Num == TarifNumber) and stringEqMask (cashDoc.clientaccount, "405*,406*,407*,40802*,40807*" ) and (cashDoc.origin == 0)  )
        CommQuont = 1;
    end;
    
    
        ClearRecord(sfbassum);

    sfbassum.baseType   = SF_BASETYPE_QUONT;
    sfbassum.baseQuont  = CommQuont;

    sfbassum.baseType2  = SF_BASETYPE_QUONT;
    sfbassum.baseQuont  = CommQuont;

    stat = InsertSumList(sfbassum);

    if( stat )
      MsgBox("Ошибка при вставке базовой суммы: ", GetErrMsg );
    end;

    
    
    /*return integer( 1 ); -- количество*/
    
    /*return $1; -- сумма */
    
end;/*CalcCommissionSum*/


