/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   RR Рахмедов Р.С.

   Имя файла ConnectSfcontr2.mac

   Создан:    01.09.2013

   Описание:  Макрос выполняющий подключение ежедневных комиссий при помощи разработанного мной пакета usr_comiss_prbb_34, предыдущая версия
              разработанная Гуцу Е. была перенесена в ConnectSfcontr_MainProc.mac. В текущей версии удалось добится существенного ускорения работы
              ранее на обработку уходил 1 час, сейчас от 20 до 90 секунд, ускорение порядка 30 раз.

   P.S.       Редактирование, рефаторинг, добавление новых функций ЗАПРЕЩЕНЫ, все делать по согласованию со мной.

   ChangeLog:
-----------------------------------------------------------------------------------------------------------------------------------------------------
   //RR 29.01.2015 Адаптировано для банка ПОЙДЕМ
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
import "ConnectSfcontr_MainProc.mac";
import bankInter;

private var Comiss,
            err,
            ProcName,
            indMessage,
            OperDate,
            OperDayProlongTime,
            LifeBank = fg_life_subject( {OurBank} );

  /* Дата выполнения процедуры */
  OperDate = {CurDate} - 1;
  if ( not GetDate( OperDate, "Пожалуйста, введите дату расчёта комиссии:" ) )
     exit(1);
  end;

  /* Время продления опердня */

  // Чтение настройки
  var regPath = "PRBB\\СЕРВИС ГКБО\\ПРОДЛЕНИЕ ОПЕРДНЯ",
      defTime = "16:00";
  GetRegistryValue( regPath, V_STRING, OperDayProlongTime, err );
  if ( ( err != 0 )
       or ( strLen( trim( OperDayProlongTime ) ) == 0 ) )

     OperDayProlongTime = defTime;

  elif ( index( OperDayProlongTime, ":" ) == 0 )
     msgbox ("Неправильный формат времени в настройке \""+ regPath +"\": " + OperDayProlongTime +
             "|Время должно быть указано в формате HH:MM" );
     OperDayProlongTime = defTime;
  end;
  OperDayProlongTime = trim( OperDayProlongTime );

  // Запрос корректировки
  while( GetString( OperDayProlongTime, "Пожалуйста, введите время продления опердня в формате HH:MM") 
         and index( OperDayProlongTime, ":" ) == 0 )

     msgbox ("Вы указали неправильный формат времени. Необходимо использовать формат HH:MM");
     OperDayProlongTime = defTime;
  end;

  // Сохранение настройки
  if ( not SetDefaultRegistryValue( regPath, OperDayProlongTime ) )
     msgbox ( "Ошибка сохранения времени продления опердня.|Время продления опердня не сохранено.");
  end;

  // 2012-09-10 zip_z. I-00249064-2 добавлена журнализация
  if (not WriteFiscLog (OLSTRPROC, "ЗАПУСК ПРОЦЕДУРЫ ОТКЛЮЧЕНИЯ КОМИССИЙ ОТ ДОГОВОРОВ ОБСЛУЖИВАНИЯ\n" + 
                                   "Дата: " + OperDate + "\n"
                                   "Время продления ОД: " + OperDayProlongTime + "\n" + 
                                   "Макрос: ConnectSfcontr2.mac"))
      msgbox ("Не удалось добавить запись о старте процедуры в фискальный журнал");

  end;
  // < 2012-09-10 zip_z.
 
 //Точка входа
 if ((LifeBank.is_prbb) or (LifeBank.is_go))
   if (GetTrue(false, "Произвести подключение комиссии?\n ДА - выполнить подключение и вывести лог\n НЕТ - вывести лог предыдущего подключения"))
     ExecMacroFile ("ConnectSfcontr_MainProc.mac", "RunConnect34PRBB", OperDate, true, OperDayProlongTime, true);
   else
     ExecMacroFile ("ConnectSfcontr_MainProc.mac", "RunConnect34PRBB", OperDate, false, OperDayProlongTime, true);
   end;
 else
   ExecMacroFile ("ConnectSfcontr_MainProc.mac", "Run_Connection_34_com", OperDate, OperDayProlongTime);
 end;
 
    // 2012-09-10 zip_z. I-00249064-2 добавлена журнализация
  if (not WriteFiscLog (OLFINPROC, "ОКОНЧАНИЕ ПРОЦЕДУРЫ ОТКЛЮЧЕНИЯ КОМИССИЙ ОТ ДОГОВОРОВ ОБСЛУЖИВАНИЯ\n" + 
                                   "Дата: " + OperDate + "\n"
                                   "Время продления ОД: " + OperDayProlongTime + "\n" + 
                                   "Макрос: ConnectSfcontr2.mac"))
      msgbox ("Не удалось добавить запись об окончании процедуры в фискальный журнал");

  end;
  // < 2012-09-10 zip_z. 
  
  println ("Время продления опер дня - " + OperDayProlongTime);

