/***********************************************************************************************
Банк "Газэнергобанк" (ГЭБ)

Макрос пользовательского алгоритма расчета базовой суммы по комиссии "За перевод средств 
со счетов клиента Банка на счета в ОАО "Газэнергобанк либо в пользу клиентов других 
банков на бумажных носителях или по системе Интернет-Клиент, направляемых на участие в тендерах 
и аукционах, в том числе электронных"

Пункт 3.11.4 - Сумма от 5 000 001 руб. до 25 000 000, комиссия 1,5% 

Тип комиссии - Периодическая

@fname: ..\mac.usr\commission\geb_com3111p.mac
@author: Жаворонкова Н. (joy) C-9117
@changes: 14-03-2012  zip_z. execSQLSelect + оптимизация SQL
***********************************************************************************************/


import sfinter, oralib, likepy;
import GebComLib;

var MacroError :integer = 0; // Если при расчете произошла ошибка, поместить в эту переменную ненулевое значение
private var FICode_calc:string = "";

  /* Тип величины */ 
private const   SF_BASETYPE_SUM     = 1;      /* Сумма*/
private const   SF_BASETYPE_QUONT   = 2;      /* Количество*/


record sfbassum( "sfbassum.str" );
// record paym(pmpaym);

macro CalcServiceSum (sfcontr_addr    /* Договор обслуживания*/, 
                      BeginDate       /* Начало периода*/, 
                      EndDate         /* Конец периода*/,
                      sAddr           /* EVG Какой-то ещё адрес */, 
                      sfcontrStruc    /* Cтруктура sfcontr*/ 
                      )
   record sfcontr( sfcontr );
   var stat;
   var CommQuont   = 0,
       CommSum     = $0;
   var retVal, Attrid, Code, Num;



   const MIN_PAYM_AMOUNT = $5000001;
   const MAX_PAYM_AMOUNT = $25000000;

   /* EVG При вызове из sfacrpay.mac используем полученную структуру sfcontrStruc вместо адреса sfcontr_addr */
   if ( valType (sfcontr_addr) != V_UNDEF )
      setBuff( sfcontr, sfcontr_addr );
   else
      copy ( sfcontr, sfcontrStruc );
   end;
    
    
    
   debugbreak ();
   var query = " SELECT NVL( SUM( PAYM.T_AMOUNT ), 0 ) sum "
           +"\n       FROM dpmpaym_dbt paym, dpmrmprop_dbt rm"
           +"\n       WHERE "       
           +"\n       rm.t_paymentid = paym.t_paymentid"
           +"\n       AND paym.t_fiid = 0"
           +"\n       AND paym.t_payfiid = 0 "
           +"\n       AND paym.t_basefiid = 0 "
           +"\n       AND t_dockind = 201 "
           +"\n       AND paym.t_paymstatus = 32000"
           +"\n       AND (   TO_NUMBER (SUBSTR (paym.t_payeraccount, 1, 3)) BETWEEN 405 AND 407"
           +"\n               OR SUBSTR (paym.t_payeraccount, 1, 5) IN ('40807', '40802')"
           +"\n           )"
           +"\n       AND (   TO_NUMBER (SUBSTR (paym.t_receiveraccount, 1, 3)) BETWEEN 405 AND 407"
           +"\n               OR SUBSTR (paym.t_receiveraccount, 1, 5) IN ('40807', '40802')"
           +"\n           )"
           +"\n       AND REGEXP_LIKE (regexp_replace"
           +"\n          (LOWER (rm.t_ground), ' +', ' '),"
           +"\n                 'для обеспечения участия|открыт[а-я]+.*аукцион[а-я]+|аукцион[а-я]+.*в.*электронн[а-я]+|по.*электронно[а-я]+.*аукцион[а-я]+'"
           +"\n          )"
           +"\n       AND paym.t_amount between :p_min_amount and :p_max_amount" // 
           +"\n       AND paym.t_valuedate = :p_date "
           +"\n       AND paym.t_payeraccount = :p_account ";



   var rs = execSQLSelect (query, makeArray (SQLParam ("p_min_amount",    MIN_PAYM_AMOUNT),
                                             SQLParam ("p_max_amount",    MAX_PAYM_AMOUNT),
                                             SQLParam ("p_date",    endDate),
                                             SQLParam ("p_account", sfcontr.object)));
   
   if (rs.moveNext ())
      CommSum = rs.value("sum");
   end;
    

    /* EVG При вызове из sfacrpay.mac возвращаем true в случае положительного результата расчёта */
    if ( ValType (sfcontrStruc) != V_UNDEF )
       if (CommSum > 0)
          return true;
       end;
       return false;
    end;
    
   ClearRecord(sfbassum);

   sfbassum.baseType    = SF_BASETYPE_SUM; 
   sfbassum.baseSum     = CommSum;

   sfbassum.baseType2   = SF_BASETYPE_SUM; 
   sfbassum.baseSum2    = CommSum;

   stat = InsertSumList(sfbassum);

   if( stat )
      MsgBox("Ошибка при вставке базовой суммы");
   end;

end;