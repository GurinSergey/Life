/*SDA - ошибка обработчика OP_EXECUTE_STEP*/
import OprInter;
import "sf_prbb.mac";
import oralib; //Jushmanov 2014-02-20 C-19151

/* Макрос постобработки для шага обработки единовременных комиссий */
macro PostStepAction( message,     /* 1 - выполнение шага; 2 - откат шага;  */
                      errTrn,      /* статус выполнения шага. Если параметр */
                                   /* не равен 0, произошла ошибка          */
                      FirstDoc,    /* указатель на первичный документ       */
                      ID_Oper,     /* внутренний идентификатор операции     */
                      Number_Step, /* номер шага операции                   */
                      KindOper,    /* номер вида операции                   */
                      KindDoc,     /* номер вида первичного документа       */
                      KindStep,    /* вид шага операции                     */
                      ID_Step )    /* идентификатор шага операции           */

private var logquery;

    if((message==OP_EXECUTE_STEP) AND (errTrn == 0))
  	    /*MEV: Обновить СПИ по единовременным комиссиям*/
  	    DebugBreak;
  	    UpdateAllSingleCommSi(ID_Oper, ID_Step);
    end;

    //Jushmanov 2014-02-20 C-19151
    if(( message == OP_EXECUTE_STEP ) and (errTrn == 0) and (IsOprMultiExec))
        if ((valtype(ID_Oper) != V_INTEGER) and (valtype(ID_Oper) != V_STRING)) ID_Oper = 0; end;
        if ((valtype(ID_Step) != V_INTEGER) and (valtype(id_Step) != V_STRING)) ID_Step = 0; end;

        logquery = "UPDATE usr_doprstep_robot_dbt SET t_is_robot_step = chr(88)" +
                   " WHERE t_id_operation = " + ID_Oper + " AND t_id_step = " + ID_Step;
        ExecSQL(logquery, null, false);
    end;

    return 0;
end;
