/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

   RR Рахмедов Р.С.

   Имя файла ComissAgent.mac

   Создан:    24.06.2013

   Описание:  Макрос для получения информации из лога оплаты агента комиссий
              
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

Import RSD, Globals, SfInter, RSBError, Календарь, lib_rsbsession, TReport;

 
 Macro Get_Comiss_Agent_Pay_Log ();

  var i = 0,
      cmd, 
      rs, 
      table,
      LogDate = {curdate}, 
      Dep     = "ВСЕ", 
      ComCode = "ВСЕ",
      DepSTR  = "",
      ComStr  = "",;
  
   if (not GetDate(LogDate, "Введите дату работы агента"))
     println("Пользователь отказался от выполнения");
     break;
    elif (not GetString(Dep, "Введите узел ТС",3))
     println("Пользователь отказался от выполнения");
     break;
   elif(not GetString(ComCode, "Введите код комиссии по формату *.*.* ",10))
     println("Пользователь отказался от выполнения");
     break;
   end;
   
   if (Dep != "ВСЕ")
     DepStr = " AND LG.T_DEPARTMENT = '"+Dep+"' "
   end;  

   if (ComCode != "ВСЕ")
     ComStr = " AND LG.T_CODE = '"+ComCode+"' ";
   end;

   rs = RSDRecordSet(" SELECT to_char(LG.LOGDATE,'dd.mm.yyyy') LOGDATE, " +
                    "         LG.T_DEPARTMENT, " +
                    "         NVL(LG.T_DEBIT,'Отсутствует') T_DEBIT, " +
                    "         NVL(LG.T_CREDIT,'Отсутствует') T_CREDIT, " +
                    "         to_char(LG.T_BEGINDATE,'dd.mm.yyyy') T_BEGINDATE, " +
                    "         to_char(NVL(LG.T_ENDDATE,'01.01.0001'), 'dd.mm.yyyy') T_ENDDATE, " +
                    "         NVL(LG.T_COMMSUM,0) T_COMMSUM, " +
                    "         NVL(LG.T_NDSSUM,0) T_NDSSUM, " +
                    "         LG.T_OBJECT, " +
                    "         LG.T_CODE, " +
                    "         NVL(LG.T_COMMENT,'Отсутствует') T_COMMENT, " +
                    "         LG.T_ERRORCODE " +
                    "  FROM   usr_comiss_agent_pay_log lg " +
                    " WHERE   LG.LOGDATE = '"+LogDate+"' "+ DepStr + ComStr +  " ORDER BY LG.T_ERRORCODE DESC ");
   table = CTableReport();
   table.addColumn ("Системная дата",       10, AL_LEFT);
   table.addColumn ("Узел ТС",              8,  AL_LEFT);
   table.addColumn ("Дебет",                20, AL_LEFT);
   table.addColumn ("Кредит",               20, AL_LEFT);
   table.addColumn ("Начало периода",       10, AL_LEFT);
   table.addColumn ("Конец периода",        10, AL_LEFT);
   table.addColumn ("Сумма",                10, AL_LEFT);
   table.addColumn ("НДС",                  10, AL_LEFT);
   table.addColumn ("Договор обслуживания", 20, AL_LEFT);
   table.addColumn ("Комиссия",             10, AL_LEFT);
   table.addColumn ("Коментарий",           50, AL_LEFT);
   table.addColumn ("Код ошибки",           10, AL_LEFT);
        
   table.printHead ();
            
   while (rs.moveNext ())
       table.printStringTransferByWord ( string(rs.value("LOGDATE")), rs.value("T_DEPARTMENT"), rs.value("T_DEBIT"), rs.value("T_CREDIT"), 
                                         rs.value("T_BEGINDATE"), rs.value("T_ENDDATE"), rs.value("T_COMMSUM"), rs.value("T_NDSSUM"), 
                                         rs.value("T_OBJECT"), rs.value("T_CODE"), rs.value("T_COMMENT"), rs.value("T_ERRORCODE")  );
                                         
       i = i + 1;
   end;
            
   table.printSeparator ();
   table.printBottom ();
   
   if (i == 0)
     println("С указанными параметрами (Дата:"+LogDate+", Узел ТС:"+Dep+", Код комиссии:"+ComCode+") данных не найдено")
   end;
   
 END;
 
 
Get_Comiss_Agent_Pay_Log ();