/* 
   EVG             Макрос создания отложенных заявлений на закрытие счёта
   04.07.2008      по лицевым счетам, отмеченным специальным пользовательским типом.
*/
// zmp 24.02.2014 адаптация под 31 патч
import BankInter, OprInter, CTInter, PTInter, globals, cb_sql;

var reqClos = TBFile ("reqclosa.dbt", "W", 0),
    objVer  = TBFile ("objver.dbt",   "W", 0),
    oprOper = TBFile ("oproper.dbt",  "W", 0),
    acc    = TBFile ("account.dbt",  "W", 0);
    //accC    = TBFile ("account$.dbt", "W", 0);

// Пользовательский тип счёта для создания заявлений на закрытие
const UserType_CLOSE = "C"; // лат

// Номер вида операции по заявлению на закрытие счёта
const TypeOper_ACCCLOSE = 3035;

private const OBJTYPE_REQCLOSA = 451,
      PS_REQCLOSA      = 231,
      AccKind_RUR      = 0,
      AccKind_CUR      = 1;

var Report,
    ErrText;
    


CLASS TProtocolForm

   macro PrintHeader( accKind )

      println ("\n\n");
      if (accKind == AccKind_RUR)
         [      Протокол работы процедуры создания отложенных заявлений на закрытие      
                                  счёта в национальной валюте                           ];
      else
         [      Протокол работы процедуры создания отложенных заявлений на закрытие      
                                   счёта в иностранной валюте                           ];
      end;

         [
           ┌───────┬─────────────────────────┬────────────┬───────────────────────────────────────────────────────┐
           │ Номер │ Номер счета             │ Дата       │ Комментарий                                           │
           │ п/п   │                         │ заявления  │                                                       │
           ├───────┼─────────────────────────┼────────────┼───────────────────────────────────────────────────────┤
         ];
   
   end;


   
   
   macro PrintLine( lineNumber, accNumber, reqDate )
      [ │ #     │ #                       │ #          │ Вставка заявления на закрытие счета выполнена успешно │]
      (lineNumber:l, accNumber:l:f, reqDate:l);
   end;



   macro PrintErrorLine( lineNumber, accNumber, errorText )

      Array ET;
      Var   i;

      if (valType(errorText) == V_UNDEF)
         errorText = "";
      end;

      errorText = errorText + " Заявление на закрытие счёта не сформировано.";
      StrSplit(errorText, ET, 53);

      [ │ #     │ #                       │            │ #                                                     │]
      (lineNumber:l, accNumber:l:f, ET(0):l);

      if (aSize(ET) > 1)
         i = 1;
         while (i < aSize(ET))
            [ │       │                         │            │ #                                                     │]
            (ET(i):l);
            i = i + 1;
         end;

      end;
   
   end;

   
   
   macro PrintFooter()
      [ └───────┴─────────────────────────┴────────────┴───────────────────────────────────────────────────────┘
      ]
   end;


END;



/* EVG Больше не нужно, вставка делается PL/SQL-процедурой из функции InsertReqClose().
macro TrnInsData();
   var AccFile:Object;

   if ( not reqClos.Insert() )
      ErrText = "Ошибка при вставке записи в таблицу reqclosa.dbt!";
      AbortTrn();
   end;

   objVer.rec.ObjectID = reqClos.rec.RequestID;
   if ( not objVer.Insert() )
      ErrText = "Ошибка при вставке записи в таблицу objver.dbt!";
      AbortTrn();
   end;
   
   oprOper.rec.DocumentID = UniID( reqClos, OBJTYPE_REQCLOSA, PS_REQCLOSA );
   if ( not oprOper.Insert() )
      ErrText = "Ошибка при вставке записи в таблицу oproper.dbt!";
      AbortTrn();
   end;


   /* После того, как все вставки выполнены, необходимо найти счёт, по которому
      вводится заявление, и убрать у него польз. тип UserType_OPEN. */
   /*if (reqClos.rec.Code_Currency == 0)
      AccFile = accR;
   else
      AccFile = accC;
   end;*/
   AccFile = acc;
   AccFile.Clear();
   AccFile.rec.Chapter       = 1;                               // Жестко глава А
   AccFile.rec.Account       = reqClos.rec.Account;
   AccFile.rec.Code_Currency = reqClos.rec.Code_Currency;
   if (AccFile.GetEQ())
      AccFile.rec.UserTypeAccount = StrSubst(AccFile.rec.UserTypeAccount, UserType_CLOSE, "");
   end;
   if ( not AccFile.Update() )
      ErrText = "Ошибка при обновлении записи о лицевом счёте!";
      AbortTrn();
   end;

end;
*/


macro InsertReqClose( account, accTabName, dType )

   var query, rs;

   record pty ("party.dbt");
   var ClientName;
   if (ПолучитьСубъекта(account.rec.Client, pty) == 0)
      ClientName = pty.Name;
   else
      msgbox ("Ошибка при определении субъекта по счёту " + string(account.rec.account:f) + "!");
   end;


   query = " DECLARE                                                                                            \n" +
           "    NewRequestID Numeric := 0;                                                                      \n" +
           " BEGIN                                                                                              \n" +

           /* Вставка DReqClosA_dbt */
           "    Insert into DReqClosA_dbt (t_RequestID,                                                         \n" +
           "                               t_Oper,                                                              \n" +
           "                               t_Date,                                                              \n" +
           "                               t_InputDate,                                                         \n" +
           "                               t_CloseDate,                                                         \n" +
           "                               t_CurrentState,                                                      \n" +
           "                               t_Kind_Operation,                                                    \n" +
           "                               t_Account,                                                           \n" +
           "                               t_Code_Currency,                                                     \n" +
           "                               t_TransfIndex,                                                       \n" +
           "                               t_Return,                                                            \n" +
           "                               t_Department,                                                        \n" +
           "                               t_Branch,                                                            \n" +
           "                               t_SubKind,                                                           \n" +
           "                               t_TransfCodeKind,                                                    \n" +
           "                               t_TransfCode,                                                        \n" +
           "                               t_TransfName)                                                        \n" +
           "    Values (0,                                                                                      \n" +
           "            " + {oper} + ",                                                                         \n" +
           "            " + GetSQLDate({CurDate}) + ",                                                          \n" +
           "            " + GetSQLDate({CurDate}) + ",                                                          \n" +
           "            " + GetSQLDate(account.rec.Close_Date) + ",                                             \n" +
           "            0,                                                                                      \n" +
           "            " + TypeOper_ACCCLOSE + ",                                                              \n" +
           "            " + GetSQLString(account.rec.Account) + ",                                              \n" +
           "            " + account.rec.Code_Currency + ",                                                      \n" +
           "            " + GetSQLChar("X") + ",                                                                \n" +
           "            " + GetSQLChar("X") + ",                                                                \n" +
           "            " + account.rec.Department  + ",                                                        \n" +
           "            " + account.rec.Branch  + ",                                                            \n" +
           "            " + dType + ",                                                                          \n" +
           "            1,                                                                                      \n" +
           "            " + GetSQLString(ПолучитьКодСубъекта(account.rec.Client, 1/*вид кода*/))+ ",            \n" +
           "            " + GetSQLString(ClientName)  + ")                                                      \n" +
           "    Returning t_RequestID                                                                           \n" +
           "    Into NewRequestID;                                                                              \n" +

           "  dbms_output.put_line(NewRequestID);                                                               \n" +
           
           /* Вставка DObjVer_dbt */
           "    Insert into DObjVer_dbt (t_ObjectType,                                                          \n" +
           "                             t_ObjectID,                                                            \n" +
           "                             t_Version)                                                             \n" +
           "    Values (" + OBJTYPE_REQCLOSA + ",                                                               \n" +    // 451
           "            NewRequestID,                                                                           \n" +
           "            1);                                                                                     \n" +
           

           /* Вставка DOprOper_dbt */
           "    Insert into DOprOper_dbt (t_Id_Operation,                                                       \n" +
           "                              t_Kind_Operation,                                                     \n" +
           "                              t_Init_Oper,                                                          \n" +
           "                              t_DocKind,                                                            \n" +
           "                              t_DocumentID)                                                         \n" +
           "    Values (0,                                                                                      \n" +
           "            " + TypeOper_ACCCLOSE + ",                                                              \n" +
           "            0,                                                                                      \n" +
           "            " + PS_REQCLOSA + ",                                                                    \n" +    // 231
           "            lPad(NewRequestID, 34, '0') );                                                          \n" +


           /* Убираем признак необходимости ввода заявления на открытие с лицевого счёта */
           "    Update   daccount_dbt                                                                           \n" +
           "       Set t_UserTypeAccount = NVL( replace(t_UserTypeAccount, '" + UserType_CLOSE + "'), Chr(1) )  \n" +
           "     Where t_Chapter       = 1                                                                      \n" +
           "       and t_Account       = " + GetSQLString(account.rec.Account) + "                              \n" +
           "       and t_Code_Currency = " + account.rec.Code_Currency + ";                                     \n" +
           
           "  end;   ";

   //println (query);
   rs = rsdCommand(query);
   rs.execute;
   return true;

   onError(er);
      ErrText = er.message;
      return false;
  
  
  
   /* EVG Старый алгоритм
   /* Заполнение структуры reqopena.dbt */
   reqClos.Clear();
   reqClos.rec.RequestID         = 0;                             // Autoinc
   reqClos.rec.Oper              = {oper};
//   reqClos.rec.Date              = account.rec.Close_Date;
   reqClos.rec.Date              = {CurDate};
   reqClos.rec.InputDate         = {CurDate};
   reqClos.rec.CurrentState      = 0;                             // Отложенное
   reqClos.rec.Kind_Operation    = TypeOper_ACCCLOSE;
   reqClos.rec.Account           = account.rec.Account;
   reqClos.rec.Code_Currency     = account.rec.Code_Currency;
   reqClos.rec.TransfIndex       = "X";
   reqClos.rec[reqClos.FldIndex("Return")]    = "X";              // Т.к. слово "Return" - зарезервировано.
   reqClos.rec.Department        = account.rec.Department;
   reqClos.rec.Branch            = account.rec.Branch;
   reqClos.rec.SubKind           = 1;
   reqClos.rec.TransfCodeKind    = 1;
   reqClos.rec.TransfCode        = ПолучитьКодСубъекта(account.rec.Client, 1/*вид кода*/);
   reqClos.rec.TransfName        = ClientName;


   /* Заполнение структуры objver.dbt */
   objVer.Clear();
   objVer.rec.ObjectType = OBJTYPE_REQCLOSA;                    // 450
   /* ObjectID будет заполнено в транзакции после вставки записи в reqopena.dbt
      и определения reqopena.RequestID. */
   objVer.rec.ObjectID = 0;
   objVer.rec.Version = 1;                                      // Константа


   /* Заполнение структуры oproper.dbt */
   oprOper.Clear();
   oprOper.rec.Id_Operation   = 0;                              // Autoinc
   oprOper.rec.Kind_Operation = reqClos.rec.Kind_Operation;
   oprOper.rec.Init_Oper      = 0;
   oprOper.rec.DocKind        = PS_REQCLOSA;                    // 230
   /* DocumentID будет заполнено в транзакции после вставки записи в reqopena.dbt
      и определения reqopena.RequestID. */
   oprOper.rec.DocumentID     = 0;


   ErrText = "";
   if ( ProcessTrn(null, "TrnInsData", reqClos, objVer, oprOper, accR, accC) )
      return true;
   end;

   return false;
   */
end;


macro ProcessAccPart( accKind )

   var n, progrHeader;

   var query, rs, AccFileName,
       recordsCount, DocType, SQL_COND;
   var AccFile = TBFile("account.dbt");

   if (accKind == AccKind_RUR)
      //AccFileName = "daccount_dbt";
      progrHeader = "Лицевые счета в национальной валюте";
      SQL_COND = " = 0 ";
   else
      //AccFileName = "daccount$_dbt";
      progrHeader = "Лицевые счета в иностранной валюте";
      SQL_COND = " != 0 ";
   end;

   /* Посчитаем количество счетов, которые нужно закрыть */
   recordsCount = 0;
   query = " Select count (*) from  daccount_dbt "
           "  Where t_Open_Close      = Chr(0) " +
           "    and t_UserTypeAccount like '%" + UserType_CLOSE + "%'"+
           "    and T_CODE_CURRENCY " + SQL_COND; 
   rs = rsdRecordSet (query);
   if (rs and rs.moveNext())
      recordsCount = rs.Value(0, null, V_INTEGER);
   end;

   Report.PrintHeader( accKind );

   /* Основной цикл */
   if (recordsCount > 0)
      
      rs = null;
      query = " Select acc.*, oc.t_AttrId aId from daccount_dbt  acc, dobjatcor_dbt oc " +
              "  Where acc.t_Open_Close      = Chr(0) " +
              "    and acc.t_UserTypeAccount like '%" + UserType_CLOSE + "%'" +
              "    and oc.t_ObjectType    (+)= 4 " +                                    // OBJTYPE_ACCOUNT
              "    and oc.t_GroupId       (+)= 107 " +
              "    and oc.t_Object        (+)= lpad( acc.t_Chapter, 2, '0' ) || " +
              "                                lpad( acc.t_Code_Currency, 7, '0' ) || " +
              "                                acc.t_Account "+
              "    and acc.T_CODE_CURRENCY " + SQL_COND; 
      //getstring (query);
      rs = rsdRecordSet(query);

      n = 0;
      initProgress(recordsCount, "Обрабатываются лицевые счета...", progrHeader);
      while (rs.moveNext())

         /* Вид документа закрытия счёта (категория "Вид документа закрытия счета") */
         DocType = SQL_ConvTypeInteger( rs.value( "aId", null, V_INTEGER ) );
         if ( DocType == 0 )
            DocType = 1;                        // По умолчанию - Заявление
         end;

         CopyRSetToFBuff( AccFile, rs );
         
         n = n + 1;
         useProgress(n);

         message("Выполняется вставка заявления на закрытие счёта...");
         if( InsertReqClose (AccFile, AccFileName, DocType) )
            Report.PrintLine( n, 
                                   AccFile.rec.Account,
                                   {CurDate} );
         else
            Report.PrintErrorLine( n, 
                                        AccFile.rec.Account,
                                        ErrText );
         end;
         message("Обрабатываются лицевые счета...");

      end; // while (rs.moveNext())

      remProgress();

   end; // if (recordsCount > 0)

   Report.PrintFooter();

 

   /* EVG Старый алгоритм
   var AccFile:Object,
       n, k, progrHeader, h;

   if (accKind == AccKind_RUR)
      AccFile = accR;
      progrHeader = "Лицевые счета в национальной валюте";
   else
      AccFile = accC;
      progrHeader = "Лицевые счета в иностранной валюте";
   end;
   
   Report.PrintHeader( accKind );

   k = 0; n = 0;
   initProgress(AccFile.NRecords, "Обрабатываются лицевые счета...", progrHeader);
   while (AccFile.Next())

      k = k + 1;
      useProgress(k);
      if ( index( AccFile.rec.UserTypeAccount, UserType_CLOSE ) > 0 )
         n = n + 1;
         message("Выполняется вставка заявления на закрытие счёта...");
         if( InsertReqClose (AccFile) )
            Report.PrintLine( n, 
                              AccFile.rec.Account,
                              reqClos.rec.Date );
         else
            Report.PrintErrorLine( n, 
                                   AccFile.rec.Account,
                                   ErrText );
         end;
         message("Обрабатываются лицевые счета...");
      end;

   end;
   Report.PrintFooter();
   remProgress();

   */

end;


//msgbox (PS_REQCLOSA);

 
 Report = TProtocolForm();

 // Обработать рублёвые счета
 ProcessAccPart( AccKind_RUR );

 // Обработать валютные счета
 ProcessAccPart( AccKind_CUR );









