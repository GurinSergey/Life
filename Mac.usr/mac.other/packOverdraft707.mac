/****************************************************************/
/* Процедура установки\снятия типа счета "О" для б\с 707        */
/* По заявке R-33213                                            */
/* Teleshova 14.01.2015 Adaptation 2031                         */
/****************************************************************/

IMPORT RSD, BankInter, oralib, likepy, globals;

/*13.03.2013 Chesnokov D.S. логгирование запуска для поиска неиспользуемых макросов*/
ExecmacroFile("lib_log.mac", "LogProcedure", "packOverdraft707.mac");

private var Fulloutputl, outl, outputl="overdraft707.lbr";
GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
private var panel = TRecHandler("main", fulloutputl, TRUE);

/* Получаем список счетов */

private var accounts = " SELECT   *                                                             "
                       "   FROM   (SELECT   t_account account, t_type_account accounttype       "
                       "             FROM   daccount_dbt                                        "
                       "            WHERE   T_TYPE_ACCOUNT NOT LIKE '%П%'                       "
                       "              AND   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy')) "
                       //TAM 14.01.2015
                       /*"           UNION ALL                                                    "
                       "           SELECT   t_account account, t_type_account accounttype       "
                       "             FROM   daccount$_dbt                                       "
                       "            WHERE   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy')) "*/
                       "  WHERE   account LIKE '707%'                                           ";

/* Считаем количество счетов */

private var account707count = " SELECT   COUNT ( * )                                                   "
                              "   FROM   (SELECT   t_account                                           "
                              "             FROM   daccount_dbt                                        "
                              "            WHERE   T_TYPE_ACCOUNT NOT LIKE '%П%'                       "
                              "              AND   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy')) "
                              //TAM 14.01.2015
                              /*"           UNION ALL                                                    "
                              "           SELECT   t_account FROM daccount$_dbt                        "
                              "            WHERE   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy')) "*/
                              "  WHERE   t_account LIKE '707%'                                         ";

/* Устанавливаем тип счета */

private var SetOverdraft = RsdCommand(" BEGIN                                                               "
                                      "    UPDATE   daccount_dbt                                            "
                                      "       SET   T_TYPE_ACCOUNT = trim(CONCAT (T_TYPE_ACCOUNT, 'О'))     "
                                      "     WHERE   t_account like '707%'                                   "
                                      "       AND   INSTR (T_TYPE_ACCOUNT, 'О') = 0                         "
                                      "       AND   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy');     "
                                      //TAM 14.01.2015
                                      /*"    UPDATE   daccount$_dbt                                           "
                                      "       SET   T_TYPE_ACCOUNT = trim(CONCAT (T_TYPE_ACCOUNT, 'О'))     "
                                      "     WHERE   t_account like '707%'                                   "
                                      "       AND   INSTR (T_TYPE_ACCOUNT, 'О') = 0                         "
                                      "       AND   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy');     "*/
                                      " END;                                                                "),

/* Снимаем тип счета */

            RemOverdraft = RsdCommand(" BEGIN                                                                "
                                      "    UPDATE   daccount_dbt                                             "
                                      "       SET   T_TYPE_ACCOUNT = trim(REPLACE (T_TYPE_ACCOUNT, 'О', '')) "
                                      "     WHERE   t_account like '707%'                                    "
                                      "       AND   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy');      "
                                      //TAM 14.01.2015
                                      /*"    UPDATE   daccount$_dbt                                            "
                                      "       SET   T_TYPE_ACCOUNT = trim(REPLACE (T_TYPE_ACCOUNT, 'О', '')) "
                                      "     WHERE   t_account like '707%'                                    "
                                      "       AND   T_CLOSE_DATE = to_date('01.01.0001', 'dd.mm.yyyy');      "*/
                                      " END;                                                                 ");


macro AddCol (ar, ind, fld, head, width, rdonly, DecPoint)

   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = 0;
   ar.value (ind * 6 + 4 ) = decPoint;
   ar.value (ind * 6 + 5 ) = 0;

end;

macro ShowCountAccounts()
var rs = RsdRecordSet(account707count);
FILE f_rep_out() txt;
var f_rep_name = GetTXTFileName("OverAcc707");

    SetOutput(f_rep_name,false);

    if(rs.movenext())
                        [ Процедура установки\снятия типа счета "О" для б\с 707 ];
                        [                                                       ];
                        [  Всего счетов: #                                      ]( String(int(rs.value(0))) );
    end;
    rs = RsdRecordSet(accounts);
                        [ ┌────────────────────────┬────────────────────────┐   ];
                        [ │        Счет            │    Новый тип счета     │   ];
                        [ ├────────────────────────┼────────────────────────┤   ];
    while(rs.movenext())[ │ ###################### │ ###################### │   ](rs.value(0):c,rs.value(1):c);
    end;                [ └────────────────────────┴────────────────────────┘   ];

    SetOutput(null,false);

    if ((ExistFile(f_rep_name,0)) and (open(f_rep_out,f_rep_name))) ;
        viewFile(f_rep_out);
        close(f_rep_out);	
    end;

end;

macro showaccounts(str)

   private var rs, col = TArray();

   AddCol (col, 0, "account", "Счет", 21, true);
   AddCol (col, 1, "accounttype", "Тип счета", 10, true);

   rs = RsdRecordset(accounts,RSDVAL_CLIENT,RSDVAL_STATIC);
   RunScroll(rs,2,col,null,"EvProcScroll",str,"~ESC~ Выход")

end;

MACRO EventPanel(pn, CMD, ID, KEY)

   VAR CurrentField = FldName(pn, ID);

   if (CMD == DLG_INIT)
       pn.rec.Set = "X";
       pn.rec.Rem = "";    
       UpdateFields(pn);
   end;
   if(KEY == 32)
       if (CurrentField == "Set")
          pn.rec.Set = "X";
          pn.rec.Rem = "";
       elif(CurrentField == "Rem")
          pn.rec.Set = "";
          pn.rec.Rem = "X";
       end;
       UpdateFields(pn);
   elif(KEY == 316)
       if(pn.rec.Set == "X")
          BegAction(500,"Идет установка типа \"Овердрафт\" для счетов 707| Подождите...",false);
          SetOverdraft.execute();
          EndAction(0);
          ShowCountAccounts();
       elif(pn.rec.Rem == "X")
          BegAction(500,"Идет снятие типа \"Овердрафт\" со счетов 707| Подождите...",false);
          RemOverdraft.execute();
          EndAction(0);
          ShowCountAccounts();
       end;
   elif(KEY == 317)
       showaccounts();
   end;

END;

rundialog(panel,"EventPanel");

exit(1);
