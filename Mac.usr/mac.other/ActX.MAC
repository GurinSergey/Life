/*  'Новиков А.В. 14.09.2001
*/

Import BankInter,CurrInter,RslX,rcw;//,Lgxs;

CONST Код_А  = CodeFor("A")-1,  /*код 65 соответствует букве А*/
      Num_St = CodeFor("Z")-Код_А; /*число латинских букв от A до Z, потом идут AA,AB,AC...*/

VAR   ob,wb;
var regparam;

Array ws;
array mass0,mass1,mass2,mass3,mass4,mass5/*приоритет*/;
array Kod_Val_mass;

file accblnc(accblnc,"bank.def") key 0;
file account(account,"bank.def") key 0;
file client(client,"bank.def") key 0;
file currency(currency,"bank.def") key 0;

Macro mass_(mass0);
var i=0,tmp;
  while(GetParm( i+1, tmp ))
    mass0(i)=string(tmp);
    i=i+1;
  end;
  setparm(0,mass0);
end;

Macro sort_(a1,a2);
var a=a1;
  setparm(0,a2);
  setparm(1,a);
end;

Macro Sort_mass(a,a1,a2,a3,a4);
var i=0,k,j,n,m;
  n=asize(a);
  While (i<n)
    m=a(i);
    k=i;
    j=i;
    While (j<n)
      if (m>a(j))
        m=A(j);
        k=j;
      end;
      j=j+1;
    end;
    sort_(A(k),A(i));
    sort_(A1(k),A1(i));
    sort_(A2(k),A2(i));
    sort_(A3(k),A3(i));
    sort_(A4(k),A4(i));
    /*
    A[k]=A[i];
    A[i]=m;
    */
    i=i+1;
  end;
  setparm(0,a);
  setparm(1,a1);
  setparm(2,a2);
  setparm(3,a3);
  setparm(4,a4);
end;

/*==========================================================================
  Процедуры выгрузки в EXCEL
===========================================================================*/
Macro My_exit(i);
  ob.Workbooks.Close (false);
  ob.Quit;
  exit(i);
end;

Macro ОткрытиеТаблицы_Книги(NameFile)
	var WordApplication;
	var flnm;
	if(IsStandAlone())
		ob=ActiveX ("Excel.Application");
		Flnm="..\\Templs\\"+namefile;
		if(not SelectFile(Flnm,namefile,"Выбор файла *.xls, ESC - отмена"))
			exit(1);
		end;
		namefile =Flnm; 
	else
		WordApplication = CreateObject ("rsax","TRsAxServer","RsAxServer",false);
      	ob = WordApplication .CreateComObject ("Excel.Application");
//		WordApplication=CreateObject("rsax", "TRsAxServer", "LoansAxServer", isStandalone());
//		ob = WordApplication.CreateComObject("Excel.Application",true);
//		GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,RegParam);
//		NameFile = FindPath(namefile, RegParam);
	end;
	
	GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,RegParam);
   	private var temppath = findpath(namefile,RegParam);
   	if (not temppath)
		msgbox("Не найден шаблон!");
    	exit();
   	end;
	ob.visible = false;
	
	wb = ob.Workbooks.open(temppath,false); 	
//	ob.Workbooks.Open(NameFile,0,true); /*true - только для чтения*/
	wb=ob.Workbooks.Item(1);
//	wb = wb.ActiveSheet();
end;

Macro ИнициализацияЛистов(ЧислоЛистов);
var i=1;
    while(i<=ЧислоЛистов)
       ws(i)=wb.Worksheets.Item (i);
 /*(*
       ws(i).Activate;/*можно писать сразу во все листы*/
   *)*/
       i=i+1;
    end;
end;

Macro ФорматированиеСтолбца_Ячейки(лист,Код_Ячейки1,Код_Ячейки2,
                                   HorizontalAlignment,
                                   VerticalAlignment,
                                   MergeCells
                                   );
var Код_Ячейки=Код_Ячейки1+":"+Код_Ячейки2;
    ws(лист).Range(Код_Ячейки).HorizontalAlignment = HorizontalAlignment;
    ws(лист).Range(Код_Ячейки).VerticalAlignment   = VerticalAlignment;
    ws(лист).Range(Код_Ячейки).MergeCells          = MergeCells;
    ws(лист).Range(Код_Ячейки).WrapText = False;
end;

Macro ЦветЯчейки(лист,Код_Ячейки1,Код_Ячейки2,Цвет);
var Код_Ячейки=Код_Ячейки1+":"+Код_Ячейки2;
    ws(лист).Range(Код_Ячейки).Interior.ColorIndex = Цвет;
end;

Macro Шрифт(лист,Код_Ячейки,Name,FontStyle,Size);
    ws(лист).Range(Код_Ячейки).Font.Name = Name;
    ws(лист).Range(Код_Ячейки).Font.FontStyle = FontStyle;
    ws(лист).Range(Код_Ячейки).Font.Size = Size;
    /*Шрифт(лист,Код_Ячейки,"Arial Cyr","полужирный",14)*/
end;

Macro КопирСтрок(лист,Код_Ячейки1,Код_Ячейки2);
var Код_Ячейки=Код_Ячейки1+":"+Код_Ячейки2;
    ws(лист).Range(Код_Ячейки).Copy;
end;

Macro ВставкаСтрок(лист,Код_Ячейки1,Код_Ячейки2);
var Код_Ячейки=Код_Ячейки1+":"+Код_Ячейки2;
    ws(лист).Range(Код_Ячейки).Insert;
end;

Macro УдалениеСтрок(лист,Код_Ячейки1,Код_Ячейки2);
var Код_Ячейки=Код_Ячейки1+":"+Код_Ячейки2;
    ws(лист).Range(Код_Ячейки).Delete;
end;

Macro Запись_ячейка(лист,Код_Ячейки,Value);
   ws(лист).Range(Код_Ячейки).Value = Value;
end;

Macro Код_Столбца_(Номер_Столбца1);
var t=0,       /*t = 0, если от A до Z ,  t = 1,если от AA до AZ и т.д.*/
    Код_Столбца=StrFor(Код_А+Номер_Столбца1);
    t=int((Номер_Столбца1-1)/Num_St);
    if(t==0)
       Код_Столбца="";
    else
       Код_Столбца=StrFor(Код_А+t);
    end;
    return Код_Столбца+StrFor(Код_А+Номер_Столбца1-(Num_St*t) );
end;

Macro formula2(Столбец,n,НомерСтрокиИтог,per);
var ячейки=Столбец,i1=2,i=НомерСтрокиИтог,formula="";
  i=i-per;
  ячейки=string(Столбец,i);
  formula=ячейки;
  while (i1<n)
        i=i-per;
        ячейки=string(Столбец,i);
        formula=ячейки+";"+formula;
        i1=i1+1;
  end;
  return string("=СУММ(",formula,")");
end;
