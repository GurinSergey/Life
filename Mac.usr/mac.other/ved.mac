import bcprncom, PSInter, oralib, pm_common, pm_tools;
import BankInter, RSD, globals;
Import PaymInter;

/*13.03.2013 Chesnokov D.S. «®££¨à®¢ ­¨¥ § ¯ãáª  ¤«ï ¯®¨áª  ­¥¨á¯®«ì§ã¥¬ëå ¬ ªà®á®¢*/
ExecmacroFile("lib_log.mac", "LogProcedure", "ved.mac");

var zapros,  zapros2, zapros3 , zapros4 :RSDRecordset;
var SQLQuery, SQLQuery_2, SQLQuery_3 , SQLQuery_4:string  = "";
var counter  :integer = 0;
var BegDate = {CurDate};
var EndDate = {CurDate};

var KodCountryPayer, KodCountryReceiver;

MACRO Header;
[
##################################################
      
				à®¢¥à®ç­ ï ¢¥¤®¬®áâì ¯® ®¯¥à æ¨ï¬ ¡¥§ ª®¤®¢ ‚Ž
                                     ‡  ¯¥à¨®¤ á ########## ¯® ########## 
]( {Name_Bank}, BegDate, EndDate );
END;


MACRO Razdel1;
[

   §¤¥« I - ®¯¥à æ¨¨ à¥§¨¤¥­â®¢ ¡ ­ª 
  ‚ ¨­®áâà ­­®© ¢ «îâ¥ (ªà®¬¥ 810)
];
END;

MACRO Razdel2;
[

   §¤¥« II - ®¯¥à æ¨¨ ­¥à¥§¨¤¥­â®¢ ¡ ­ª 
  ‚ àã¡«ïå (â®«ìª® 810)
];
END;



MACRO Colon;
[
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿
 ³    „ â     ³ Š®¤ ³           ‘ã¬¬           ³          ¨¬¥­®¢ ­¨¥         ³          Š®àà¥á¯®­¤¥­æ¨ï áç¥â®¢         ³  Š®¤   ³   Š®¤    ³   Š®¤   ³
 ³ ¤®ªã¬¥­â   ³ ¢ « ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ´           ª«¨¥­â             ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ áâà ­ë ³  áâà ­ë  ³  ¡ ­ª   ³
 ³            ³     ³  ‘¯¨á ­¨¥   ³ ‡ ç¨á«¥­¨¥ ³                              ³        „¥¡¥â       ³       Šà¥¤¨â       ³¯« â¥«ìé³¯®«ãç â¥«ï³         ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄ´];
END;


MACRO PrintStroka( date_docum, kod_val, summS, summZ, NameCl, Payer, Receiver, KodPayer, KodReceiver);
 array str1; 
 StrSplit(NameCl,str1,30,30,5);
 var i = 1;

[³ ########## ³ ### ³#############³############³##############################³####################³####################³  ###   ³   ###    ³#########³]
( date_docum, kod_val,    summS,       summZ,               str1(0),                    Payer,             Receiver,    KodPayer, KodReceiver, ""   );

while((strlen(str1(i))>0))
[³            ³     ³             ³            ³##############################³                    ³                    ³        ³          ³         ³]
(str1(i):s);
i = i + 1;
end;

END;



MACRO GetCoutryAndAdress( ID, NotResident )
  
  FILE adr(adress) key 0;
  FILE party(party) key 0;
  var AttrID = 0;
  VAR COUNTRY;
  party.PartyID = ID;
  if( not getEQ(party) )
    return 1;
  end;
  ClearRecord(adr);
  adr.PartyID = ID;
  adr.Type    = 1;
  if( getEQ(adr) )
    if( (adr.Country == "") and (NotResident == "X") )
       Country = "997";
    else
       GetMainObjAttr( null, OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 32, AttrID, NULL, NULL, NULL );
       if( AttrID == 1 )
         Country = "998";
       else
         Country = string(adr.Country);

		if (country == "RUS") 
		country = " ";
		end;
       end;
    end;
return Country;
  end;
END;


MACRO WorkZoneRazdel1;
/*
SQLQuery = " Select pmpaym.T_ValueDate, pmpaym.T_BaseAmount, pmco.t_PassportNumber, llvalues.t_Code, fi.t_FI_Code, pmrmprop.t_PayerName, pmrmprop.t_ReceiverName, pmpaym.t_PayerAccount, pmpaym.t_ReceiverAccount, pmpaym.T_FIID, pmpaym.t_payer, pmpaym.t_receiver " +
           " FROM dpmpaym_dbt pmpaym, dpmco_dbt pmco, dfininstr_dbt fi, dllvalues_dbt llvalues, dpmrmprop_dbt pmrmprop " +  
           " WHERE pmpaym.T_PAYMENTID = pmco.T_PAYMENTID " +
                " and pmco.T_VO_CODE = 0 " + //ã ª®£® ­¥â ª®¤®¢ ‚Ž
                " and llvalues.T_Element = pmco.T_VO_CODE" +
                " and llvalues.T_List = 1805" +
                " and fi.t_FIID = pmco.t_ContractFIID" +
		" and pmpaym.T_PAYMENTID = pmrmprop.T_PAYMENTID";
*/
SQLQuery = " Select pmpaym.T_ValueDate, pmpaym.T_BaseAmount, pmpaym.t_PayerAccount, pmpaym.t_ReceiverAccount, pmpaym.T_FIID, pmpaym.t_payer, pmpaym.t_receiver " +
           " FROM dpmpaym_dbt pmpaym, dpmco_dbt pmco, dllvalues_dbt llvalues, dpmrmprop_dbt pmrmprop " +  

           " WHERE pmpaym.T_PAYMENTID = pmco.T_PAYMENTID " +
//                " and pmco.T_VO_CODE = 0 " + //ã ª®£® ­¥â ª®¤®¢ ‚Ž
                " and llvalues.T_Element = pmco.T_VO_CODE" +
                " and llvalues.T_List = 1805" +
//                " and fi.t_FIID = pmco.t_ContractFIID" +
		" and pmpaym.T_PAYMENTID = pmrmprop.T_PAYMENTID";


/* ¯¥à¢ë© ¯à®£®­ - á¯¨á ­¨¥ */ 
zapros = RSDRecordset(SQLQuery); /*à¥§ã«ìâ â § ¯à®á */

while (zapros.moveNext)
KodCountryPayer    = "";
KodCountryReceiver = "";

//	if ((strlen(zapros.value(6)) > 0))
	PrintStroka ( string(zapros.value(0)), "", zapros.value(1), "", "", zapros.value(2), zapros.value(3), zapros.value(4), zapros.value(5) );
//	end;

end; //while


END;        





Header();                 //§ £®«®¢®ª

Razdel1();		  //§ £®«®¢®ª â ¡«¨æë
Colon();                  //è ¯ª  â ¡«¨æë 
WorkZoneRazdel1();        //à áç¥â ¤«ï à §¤¥«  1 ®âç¥â 



















