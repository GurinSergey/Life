/************************************************************************************************************************
Макрос для отбора пользователей типового АРМ, автор Тихомиров А.

ChangeLog:

//RR 29.11.2012 Добавил новое поле в таблицу вывода, в которой отображается признак заблокированности пользователя.
                Из выборки пользователей для данного отчета были исключены закрытые пользователи 
************************************************************************************************************************/
import BankInter, RSD, globals;

var zapros,  zapros2, zapros3 , zapros4 :RSDRecordset;
var SQLQuery, SQLQuery_2, SQLQuery_3 , SQLQuery_4:string  = "";
var counter  :integer = 0, query, all: integer = 0;
var Arm;

if (not getint(Arm,"Задайте номер АРМа"))
  exit;
end;

// Tikh для всех арм
if (arm == 0)
SQLQuery = " SELECT DISTINCT (t_role) AS arm "+
           " FROM dperson_lnk_dbt "+
       " ORDER BY arm";
else
SQLQuery = " SELECT distinct(t_role) AS arm "+
           " FROM dperson_lnk_dbt "+
           " WHERE T_role = "+arm;
end;
QUERY = RSDRecordset(SQLQuery); /*результат запроса*/
while (query.movenext())
counter = 0;
//-------------

SQLQuery = " select t_user, t_role "
            +" from dperson_lnk_dbt "
            +" where t_role = " + query.value(0)
            +" order by t_user";

zapros = RSDRecordset(SQLQuery); /*результат запроса*/

 [
   ##########

   Список привязки сотрудников к типовому АРМ

   ###### 
   ┌───────┬─────────────────────────────────────────────┬───────────────────────────────────────┬────────────┬──────────────────────────────┬───────────────────┐
   │ Номер │                   Узел                      │           Название меню               │   Номер    │            Ф.И.О.            │     Признак       │
   │ меню  │                    ТС                       │                                       │пользователя│        операциониста         │    блокировки     │
   ├───────┼─────────────────────────────────────────────┼───────────────────────────────────────┼────────────┼──────────────────────────────┼───────────────────┤]({CurDate}, query.value(0) );

while (zapros.moveNext)

SQLQuery_2 =" select pers.t_name, pers.t_oper, pers.t_codedepart , part.t_name, decode(PERS.T_USERBLOCKED, chr(0), 'не_заблокирован' , chr(88), 'заблокирован') blocked "
            +" from dperson_dbt pers, dparty_dbt part ,DDP_DEP_DBT dep"
            +"  where pers.t_oper =  "+ zapros.value(0) 
            +"  and dep.t_code =  pers.t_codedepart "
            +"  and dep.t_partyid = part.t_partyid "
            +"  and PERS.T_USERCLOSED = chr(0)  ";
//             +" order by t_oper";
zapros2 = RSDRecordset(SQLQuery_2);
counter = counter + 1;
// Tikh Общий счетчик
all = all+1;

zapros2.moveNext;

SQLQuery_3 =" select t_name, t_menuid "
            +" from dmenutpl_dbt"
       +" where t_menuid = "+ zapros.value(1)+";";       
zapros3 = RSDRecordset(SQLQuery_3);
zapros3.moveNext;
/*
// запрос узла по внутреней ТС
SQLQuery_4 =" select t_code1, t_code2 "
            +" from dop_otdel_dbt"
       +" where t_oper = "+ zapros.value(0)+";";         
zapros4 = RSDRecordset(SQLQuery_4);

   if (zapros4.moveNext)
[      │#######│###-### │ ######################################│##########  │ #############################│] 
        (zapros.value(1):c, zapros4.value(0), zapros4.value(1):l, zapros3.value(0), zapros.value(0):r, zapros2.value(0));
   else
[      │#######│НеУказан│ ######################################│##########  │ #############################│] 
        (zapros.value(1):c,  zapros3.value(0), zapros.value(0):r, zapros2.value(0));
   end;
*/
// узлы по дистрибутивной ТС
if(string(zapros2.value(4)) != "Special value 0")
[ │#######│#############################################│ ######################################│##########  │ #############################│###################│] 
        (zapros.value(1):c, zapros2.value(3):r, zapros3.value(0), zapros.value(0):r, zapros2.value(0), zapros2.value(4));
end;
end;

[ └───────┴─────────────────────────────────────────────┴───────────────────────────────────────┴────────────┴──────────────────────────────┴───────────────────┘];
          
[ ┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │Всего сотрудников подключено к АРМ: #######                                                         │ 
  └────────────────────────────────────────────────────────────────────────────────────────────────────┘](Counter:l);
end;
// Tikh Общий счетчик
if (all != counter)
[ ┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │Всего сотрудников подключено к АРМ по всем меню: #######                                            │ 
  └────────────────────────────────────────────────────────────────────────────────────────────────────┘](all:l);
end;

    