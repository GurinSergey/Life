//Автоматическое проставление кодов ВО в п\п\к
//Str!
// после констант в "Предобработка п/п/к"*/
//получить код страны нерезидента из карточки субъекта {GBR}

Import "SetVOStaff.mac";
Import BankInter, PaymInter, PTInter, CTInter, globals;

const pmid = 2898441;

/*13.03.2013 Chesnokov D.S. логгирование запуска для поиска неиспользуемых макросов*/
ExecmacroFile("lib_log.mac", "LogProcedure", "AvtoCode_1.mac");

private macro GetCodNer(ppID:integer)
  var query:string = "select T_nrcountry from dparty_dbt where t_partyid=" + PPid;
  var rs:RsdRecordset = execSQLselect(query);
  if( rs.moveNext() )
    return rs.Value(0);
  else
  msgbox("Ошибка получения кода страны нерезидента");
   return "";
  end;
end;
//получить ID признака по коду страны строго для 5 группы!!!   //возможно t_ojecttype=501
private macro GetAttrid(CC:string) 
  var query:string = "select t_attrid from dobjattr_dbt where t_groupID=5 and t_codelist= " + "'"+ CC +"'";
//  msgbox(query);
                                 
  var rs:RsdRecordset = execSQLselect(query);
  if( rs.moveNext() )
//   msgbox(rs.Value(0));
    return rs.Value(0);
  else
  msgbox("Ошибка получения кода признака");
   return "";
  end;
end;
/*Str!*/

MACRO AvCodeVoPPK(Obj,paymentObj, fl)
var MaskaD="";
var MaskaK="";
//if(fl==2)
//Str! Если конверсия, то КВО=01040 
If(obj.bcordkind==3)
MaskaD="401-407, 40802????????0*";
MaskaK="401-407, 40802????????0*";
If (not(CompareStrWithMasks (MaskaD,PaymentObj.PayerAccount))And
not(CompareStrWithMasks (MaskaK,PaymentObj.ReceiverAccount)))
   //msgBox("Конверсия валюты резидентом");
   PaymentObj.VO_code=5; //01040;
   Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});
End;
End;
//Str! Если покупка 
If(obj.bcordkind==1)

MaskaD="401-407,40802810*";
MaskaK="401-407,40802????????0*";
   If (not(CompareStrWithMasks (MaskaD,PaymentObj.PayerAccount))And
       not(CompareStrWithMasks (MaskaK,PaymentObj.ReceiverAccount)))
   //msgBox("Покупка валюты резидентом с зачислением на  текущий валютный счет");
      PaymentObj.VO_code=4; //01030
      Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});
/* // Заполнить примечание
note="333222111";
    if( Obj.Notes.AddNote( 101,note, err_mes ) != 0 )
      msgbox( "Ошибка при вставке примечания платежа" );
      return -1;
    end;*/
   end;
MaskaD="40807810*";
MaskaK="40807*";
   If (not(CompareStrWithMasks (MaskaD,PaymentObj.PayerAccount))and
   not(CompareStrWithMasks (MaskaK,PaymentObj.ReceiverAccount)))
//      MsgBox("Покупка валюты нерезидентом");
      PaymentObj.VO_code=8;//02020
      Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});
//вставка кода страны плательщика нерезидента в 5 категорию Платежа
      Paymentobj.categories.ConnectAttr(5,GetAttrid(GetCodNer(PaymentObj.payer)),null,null,{curdate});
      
   End; 

End;

//Str! Если продажа 
If(obj.bcordkind==2)
MaskaD="40807*";
MaskaK="40807810*";
   If (not(CompareStrWithMasks (MaskaD,PaymentObj.PayerAccount))And
not(CompareStrWithMasks (MaskaK,PaymentObj.ReceiverAccount)))
   //msgBox("Продажа валюты нерезидентом");
   PaymentObj.VO_code=7;//02010
        Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});
//вставка кода страны плательщика нерезидента в 5 категорию Платежа
Paymentobj.categories.ConnectAttr(5,GetAttrid(GetCodNer(PaymentObj.payer)),null,null,{curdate});

/* // Заполнить примечание
note="333222111";
    if( Obj.Notes.AddNote( 101,note, err_mes ) != 0 )
      msgbox( "Ошибка при вставке примечания платежа" );
      return -1;
    end;*/
   end;
MaskaD="401-407,40802????????0*";
MaskaK="401-407,40802810*";
   If (not(CompareStrWithMasks (MaskaD,PaymentObj.PayerAccount))and
   not(CompareStrWithMasks (MaskaK,PaymentObj.ReceiverAccount)))
//      MsgBox("Продажа валюты резидентом с текущего валютного счета");
   PaymentObj.VO_code=2;//01010
        Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});
      End; 
End;
End; //MACRO AvCodeVoPPK

private macro ПлатежКомиссии(acnt)
var q, cmd, rs;

q="SELECT * FROM daccount_dbt WHERE t_chapter = 1 AND t_account = '"+acnt+"'";
cmd = RsdCommand(q);
rs = RsdRecordSet(cmd);

  if(rs.MoveNext())
    if(index(rs.Value("t_nameaccount"),"Комисс") == 1)
      return true;
    end;
    return false;
  else
    return null;
  end;

end;
/*********************************************************************************************************************/

//VAR AcNer = "";
//var AccBank  = "";


MACRO AvCodeVo(paymentObj)
var MaskaD="";
var MaskaK="";
var AccReceiver, ok = "";
var pi :TRecHandler = TRecHandler( "pmaddpi.dbt" );

getRegistryValue("PS\\REQOPENACC\\173-ФЗ СЧЕТА НЕРЕЗИДЕНТОВ\\СЧЕТА НЕРЕЗИДЕНТОВ", V_string, MaskaD);


 /* EVG Если комиссия с НДС, то счета-получатели находятся в уточняющих записях. Перебираем их
    и находим счёт доходов. */
 if( paymentObj.PIList( PRT_Credit ).Size > 0 )

    ok = ((paymentObj.PIList( PRT_Credit ).First() == 0) and (paymentObj.PIList( PRT_Credit ).Current( pi ) == 0));
    while( ok )
       if ( subStr(pi.rec.Account, 1, 5) == "70601" )
          AccReceiver = pi.rec.Account;
       end;

       ok = ((paymentObj.PIList( PRT_Credit ).Next() == 0) and (paymentObj.PIList( PRT_Credit ).Current( pi ) == 0) );
    end;

 else

    AccReceiver = PaymentObj.ReceiverAccount;

 end;


/*надо доделывать*/
/*
//комиссии в пользу уполномоченных банков за совершение операций по счету
*/
//If(Paymentobj.origin==3)   // бестолковое условие
 /* EVG MaskaD - счета нерезидентов (PS\\REQOPENACC\\173-ФЗ СЧЕТА НЕРЕЗИДЕНТОВ\\СЧЕТА НЕРЕЗИДЕНТОВ)
 MaskaD="40807810*";*/
 MaskaK="70601810?????2102*, 70601810?????2101*";
 If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
     not(CompareStrWithMasks (MaskaK, AccReceiver)))
    //msgBox("комиссии в пользу уполномоченных банков за совершение операций по счету");
    PaymentObj.VO_code=203; //99020;
    Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});   
 End;
//End;

//комиссии в пользу уполномоченных банков прочие

 /* EVG MaskaD - счета нерезидентов (PS\\REQOPENACC\\173-ФЗ СЧЕТА НЕРЕЗИДЕНТОВ\\СЧЕТА НЕРЕЗИДЕНТОВ)
 MaskaD="40807810*";*/
 MaskaK="70601810?????6203*, 70601810?????6301*, 70601810?????6304*, ";
 MaskaK=MaskaK+"70601810?????7102*, 70601810?????7103*, 70601810?????7202*, ";
 MaskaK=MaskaK+ "70601810?????720304*, 70601810?????6306*";
 If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
     not(CompareStrWithMasks (MaskaK, AccReceiver)))
    //msgBox("комиссии в пользу уполномоченных банков прочие");
    PaymentObj.VO_code=212; //99090;
    Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});     
 End;

//комиссии в пользу  банка за совершение операций по счету

 /* EVG Только для валютных платежей */
 if (PaymentObj.BaseFIID > 0)
    MaskaD="401-407, 40802????????0*";
    MaskaK="70601810?????2102*, 70601810?????2101*";
    If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
        not(CompareStrWithMasks (MaskaK, AccReceiver)))
       //msgBox("комиссии в пользу  банка за совершение операций по счету");
       PaymentObj.VO_code=203; //99020;
       Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});         
    End;
 end;

//комиссии в пользу  банка  прочие

 /* EVG Только для валютных платежей */
 if (PaymentObj.BaseFIID > 0)
    MaskaD="401-407, 40802????????0*";
    MaskaK="70601810?????6203*, 70601810?????6301*, 70601810?????6304*, ";
    MaskaK=MaskaK+"70601810?????7102*, 70601810?????7103*, 70601810?????7202*, ";
    MaskaK=MaskaK+ "70601810?????720304*, 70601810?????6306*";
    If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
        not(CompareStrWithMasks (MaskaK, AccReceiver)))
       //msgBox("комиссии в пользу  банка  прочие");
       PaymentObj.VO_code=212; //99090;
       Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});         
    End;
 End;

 //Операции по списанию комиссий в ин.валюте с транзитных  счетов резидентов 
 If(paymentObj.docKind==27)
    MaskaD="401-407, 40802????????1*";
    MaskaK="70601810?????2102*, 70601810?????2101*, ";
    MaskaK=MaskaK+"70601810?????6203*, 70601810?????6301*, 70601810?????6304*, ";
    MaskaK=MaskaK+"70601810?????7102*, 70601810?????7103*, 70601810?????7202*, ";
    MaskaK=MaskaK+ "70601810?????720304*, 70601810?????6306*";

    If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
        not(CompareStrWithMasks (MaskaK, AccReceiver)))
       //msgBox("комиссии в ин.валюте с транзитных  счетов резидентов");
       PaymentObj.VO_code=186; //61090;
       Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});         
    End;
 End;
 
 //Dex - простановка кода 99090 для погашения кредитов (Кредит счета 47422)
 
 //if(paymentObj.docKind==201)
if (not PaymentObj.IsExternal)

   if ( PaymentObj.BaseFIID > 0 )
        MaskaD="401*,402*,403*,404*,405*,406*,407*,40802*";
        MaskaK="47422*";
        If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
           not(CompareStrWithMasks (MaskaK, PaymentObj.ReceiverAccount)))
           PaymentObj.VO_code=212;
         end;
   end;

 MaskaD="40807*";
 MaskaK="47422*";
 
      If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
        not(CompareStrWithMasks (MaskaK, PaymentObj.ReceiverAccount)))
        PaymentObj.VO_code = 212; /* 99090 - Прочие */
        UpdateNRCountryInPaymetnCat(PaymentObj,PaymentObj.Payer, 118);
      end;
end;

VAR AcNer = "";
var AccBank  = "";
var errAn;
 
 // Dex - код 99090 для платежей на банковские счета нашего банка
 
    /*счета нерезидентов*/  
   GetRegistryValue("PS\\REQOPENACC\\173-ФЗ СЧЕТА НЕРЕЗИДЕНТОВ\\ДЛЯ ВК", V_STRING, AcNer, errAn);

   /* EVG Счета банка */
   GetRegistryValue("PS\\REQOPENACC\\СЧЕТА БАНКА", V_STRING, AccBank, errAn);
 
   if (not PaymentObj.IsExternal) //внутренний 
      if( not(CompareStrWithMasks (AcNer, PaymentObj.PayerAccount)) and
          not(CompareStrWithMasks (AccBank, PaymentObj.ReceiverAccount)) )
         /* A.Gregeradsky - 16.11.2009 - Анализ внутреннего платежа на предмет того, не является ли он платежом по комиссии */
        If(ПлатежКомиссии(PaymentObj.ReceiverAccount))
          PaymentObj.VO_code=204; /* 99020 - Комиссии */
        else
          PaymentObj.VO_code=212;
        end;
      end;
      
      //AccD = "401*,402*,403*,404*,405*,406*,407*,40802*";
      if ( PaymentObj.BaseFIID > 0 ) // валюта
         MaskaD = "401*,402*,403*,404*,405*,406*,407*,40802*";
         if( not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount)) and
             not(CompareStrWithMasks (AccBank, PaymentObj.ReceiverAccount)) )
                  PaymentObj.VO_code=212;
             end;
      end;
      
   end;
 
 
 
 //
 
 
 
 //Dex на кассовые(страна нерезмдента)
 if((paymentObj.docKind==410) or (paymentObj.docKind==420) or (paymentObj.docKind==430) or (paymentObj.docKind==440))
 
 MaskaD="40807*";
 MaskaK="20202*";
 
       If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
        not(CompareStrWithMasks (MaskaK, PaymentObj.ReceiverAccount)))
        //PaymentObj.VO_code=212;
        UpdateNRCountryInPaymetnCat(PaymentObj,PaymentObj.Payer, 118);
      end;

 MaskaD="20202*";
 MaskaK="40807*";

 
        If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
        not(CompareStrWithMasks (MaskaK, PaymentObj.ReceiverAccount)))
        //PaymentObj.VO_code=212;
        UpdateNRCountryInPaymetnCat(PaymentObj,PaymentObj.Receiver, 119);
      end;

 
 end;
 
 //Dex(с тарнзитного на текущий - 61100)
 
 MaskaD="401*,402*,403*,404*,405*,406*,407*,40802*";
 MaskaK="401*,402*,403*,404*,405*,406*,407*,40802*";
 
If (not(CompareStrWithMasks (MaskaD, PaymentObj.PayerAccount))And
not(CompareStrWithMasks (MaskaK, PaymentObj.ReceiverAccount)))
  if(((substr(PaymentObj.PayerAccount,6,3))!=810)  and ((substr(PaymentObj.ReceiverAccount,6,3))!=810) )
   if((substr(PaymentObj.PayerAccount,1,5)) == (substr(PaymentObj.ReceiverAccount,1,5)))
      if (PaymentObj.Payer == PaymentObj.Receiver)
         if (((substr(PaymentObj.PayerAccount,14,1)) == 1) and  ((substr(PaymentObj.ReceiverAccount,14,1)) == 0))
            PaymentObj.VO_code=187;
         end;
      end;
   end;
  end 
end;
 
 
/* вр
//НДС  полученный, и иные налоги
MaskaD="40807810*";
MaskaK="60309810*, 60301810*";
If (not(CompareStrWithMasks (MaskaD,PaymentObj.PayerAccount))And
not(CompareStrWithMasks (MaskaK,PaymentObj.ReceiverAccount)))
   //msgBox("НДС  полученный, и иные налоги");
   PaymentObj.VO_code=194; //70010;
   Paymentobj.categories.ConnectAttr(117,165,null,null,{curdate});         
End; */

   //msgbox ("PaymentObj.VO_code -- > ", PaymentObj.VO_code);
End;//MACRO AvCodeVo



var PmObj = RsbPayment(pmid);

AvCodeVo(PmObj);


//END;//mac