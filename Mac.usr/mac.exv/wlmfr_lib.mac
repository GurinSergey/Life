/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.0                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*  Библиотека для межфилиальных платежей и платежей Экономбанку            */
/*  Экспресс-Волга г. Саратов                                               */
/*  Имя файла: wlmfr_lib.mac                                                */
/*  Создан:  17.01.11                                             Зубко С.  */
/*  Зубко С. 19.04.11 Добавлены функции именования файлов                   */
/****************************************************************************/

array BIC,FF;
var БИК_Саратов,БИК_Энгельс,БИК_Волгоград,БИК_Воронеж,БИК_Ульяновск,БИК_Ставрополь,БИК_Экономбанк;
var ff_Саратов,ff_Энгельс,ff_Волгоград,ff_Воронеж,ff_Ульяновск,ff_Экономбанк,ff_Ставрополь,ff_Сбербанк;

БИК_Саратов    = BIC(asize(BIC)) =  "046311808";
БИК_Энгельс    = BIC(asize(BIC)) =  "046375825";
БИК_Волгоград  = BIC(asize(BIC)) =  "041806835";
БИК_Воронеж    = BIC(asize(BIC)) =  "042007755";
БИК_Ульяновск  = BIC(asize(BIC)) =  "047308902";
БИК_Ставрополь = BIC(asize(BIC)) =  "040702756";
БИК_Экономбанк = BIC(asize(BIC)) =  "046311722";
               
ff_Саратов     = FF(asize(FF)) = "mg";
ff_Энгельс     = FF(asize(FF)) = "mx";
ff_Волгоград   = FF(asize(FF)) = "n7";
ff_Воронеж     = FF(asize(FF)) = "nw";
ff_Ульяновск   = FF(asize(FF)) = "nu";
ff_Ставрополь  = FF(asize(FF)) = "ns";
ff_Экономбанк  = FF(asize(FF)) = "k2";

ff_Сбербанк    = FF(asize(FF)) = "i1";

macro ПроверитьНомерДокумента( number:string )
   var Shablon = "0123456789", i;
   if ( strlen(number)==0 ) 
      return false; 
   end;

   i = strlen(number);
   while( i>0 )
      if ( index(Shablon,substr(number,i,1))==0 )
         return false;
      end;
      i = i-1;
   end;

   return int(number)!=0;
end;

/* возвращает n последних символов из строки */
macro Последние_Символы( str, n )
  var i = strlen(str) - n + 1;
  if( i > 0 )
    return substr( str, i );
  else
    return str;
  end;
end;

/* Извлекает "имя файла + расширение" из полного пути */
macro FileFromPath( s)
var c, f = "", i = strlen( s);
  while ( i > 0 )
    c = SubStr( s, i, 1);
    if ( (c == ":") or (c == "\\") or (c == "/") )
      return f;
    end;
    f = c + f;
    i = i - 1;
  end;
  return f;
end;

/* Извлекает "имя файла без расширение" имени файла */
macro NameBodyFromFile(s)

  var pos_pnt;

  pos_pnt = index(s, ".");

  if(pos_pnt == 0)
    return s;
  else
    return substr(s, 1, pos_pnt - 1)
  end;

end;

/*Извлекает путь без файла*/
macro PathWithOutFile ( s )

  var c, path = "", i = strlen( s ), k = 0;
  var last_pos = 0;

  while ( i > k )
    c = SubStr( s, k, 1);
    if ( c == "\\")
      last_pos = k;
    end;
    SetDialogFlag(1);

    path = SubStr( s, 1, last_pos);
    k = k + 1;
  end;
  return path;
end;


// Функция преобразования числа в символ по 36-ричной системе исчисления, для ВУЗа (60-ричной)
// используется для перевода дня, месяца в символ.
macro _36(a)
  if(a==1) return("1"); end;  if(a==13) return("d"); end;  if(a==25) return("p"); end;  if(a==36) return("1"); end;  if(a==48) return("d"); end;
  if(a==2) return("2"); end;  if(a==14) return("e"); end;  if(a==26) return("q"); end;  if(a==37) return("2"); end;  if(a==49) return("e"); end;
  if(a==3) return("3"); end;  if(a==15) return("f"); end;  if(a==27) return("r"); end;  if(a==38) return("3"); end;  if(a==50) return("f"); end;
  if(a==4) return("4"); end;  if(a==16) return("g"); end;  if(a==28) return("s"); end;  if(a==39) return("4"); end;  if(a==51) return("g"); end;
  if(a==5) return("5"); end;  if(a==17) return("h"); end;  if(a==29) return("t"); end;  if(a==40) return("5"); end;  if(a==52) return("h"); end;
  if(a==6) return("6"); end;  if(a==18) return("i"); end;  if(a==30) return("u"); end;  if(a==41) return("6"); end;  if(a==53) return("i"); end;
  if(a==7) return("7"); end;  if(a==19) return("j"); end;  if(a==31) return("v"); end;  if(a==42) return("7"); end;  if(a==54) return("j"); end;
  if(a==8) return("8"); end;  if(a==20) return("k"); end;  if(a==32) return("w"); end;  if(a==43) return("8"); end;  if(a==55) return("k"); end;
  if(a==9) return("9"); end;  if(a==21) return("l"); end;  if(a==33) return("x"); end;  if(a==44) return("9"); end;  if(a==56) return("l"); end;
 if(a==10) return("a"); end;  if(a==22) return("m"); end;  if(a==34) return("y"); end;  if(a==45) return("a"); end;  if(a==57) return("m"); end;
 if(a==11) return("b"); end;  if(a==23) return("n"); end;  if(a==35) return("z"); end;  if(a==46) return("b"); end;  if(a==58) return("n"); end;
 if(a==12) return("c"); end;  if(a==24) return("o"); end;  if(a==0)  return("0"); end;  if(a==47) return("c"); end;  if(a==59) return("o"); end;
  return("@");
end ; /* Minimum */

/***************************************/
/*ПОШЛИ ФУНКЦИИ ДЛЯ НАИМЕНОВАНИЯ ФАЙЛОВ*/
/***************************************/

/*АЛГОРИТМ ФОРМИРОВАНИЯ ФАЙЛА МФР  
  Файл именуется по алгоритму
  ff_name+ kod+ NN+ TT+ _36(День), ".", _36(Месяц), ff_ext
  где:

  1. ff_name(КУДА) и ff_ext(ОТКУДА) может принимать значения:
     Саратов (голова)- mg
     Сбербанк        - i1
     Э-В Энгельс     - mx
     Э-В Волгоград   - n7
     Э-В Ульяновск   - nu
     Э-В Воронеж     - nw
     Экономбанк      - k2
  2. Kod = b
  3. NN - порядковый номер
  4. TT - все что народилось в голове  это "05", все что в филиале (любом) это "07"
  5. _36(день) и _36(месяц) преобразованное число в символ по 36-ричной системе
  6. ff_ext код означает ОТКУДА отправляется сообщение.Значения как и у ff_name. 

  ПРИМЕРЫ:
  Файл из филиала в голову
  Волгоград - Саратов:   mgb0107i.4n7                     
  Энгельс   - Саратов:   mgb0107i.4mx                   
  Ульяновск - Саратов:   mgb0107i.4nu                      
  Воронеж   - Саратов:   mgb0107i.4nw                     

  Из Головного на филиалы так :    
  Саратов - Волгоград:   n7b0105i.4mg 
  Саратов - Энгельс  :   mxb0105i.4mg
  Саратов - Ульяновск:   nub0105i.4mg  
  Саратов - Воронеж  :   nwb0105i.4mg 
*/


/*Возвращает циферки, которые участвуют в наименовании файла*/
/*TT - все что народилось в голове  это "05", все что в филиале (любом) это "07"*/
macro Get_TT()
  if ( {MFO_Bank} == БИК_Саратов)
     return "05";
  else
     return "07";
  end;
end;

/*Возвращает буковки, которые участвуют в наименовании файла*/
/*ff_ext код означает ОТКУДА отправляется сообщение*/
macro Get_ff_ext()
private var _i=0;
  while (_i< asize(BIC))
   if ({MFO_Bank} == BIC(_i)) return(FF(_i)); end;
   _i=_i+1;
  end;
  return "__";
/*
  if   ( {MFO_Bank} == БИК_Саратов)
     return ff_Саратов;
  elif ( {MFO_Bank} == БИК_Энгельс)
     return ff_Энгельс;
  elif ( {MFO_Bank} == БИК_Волгоград)
     return ff_Волгоград;
  elif ( {MFO_Bank} == БИК_Воронеж)
     return ff_Воронеж;
  elif ( {MFO_Bank} == БИК_Ульяновск)
     return ff_Ульяновск;
  elif ( {MFO_Bank} == БИК_Ставрополь)
     return ff_Ставрополь;
  else
     return "__";
  end;
*/
end;


