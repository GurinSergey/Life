/*Внешние документы                                                    */
/*                                                                     */
/*                                                                     */
/*Тихомиров А.Н. 15.09.2009                    Версия 1.0              */

 //!!! 2011-10-27 zip_z. При изменении текста макроса пишите в шапке характер изменений и номер заявки,
 //                      на основании которой они были сделаны.

/*------------------------------------------------------------------------------------------- 
   @changes: / история изменений
   
   17.11.10 I-00002546  Добавил по заявке ВУЗ возможность выбора схем расчетов 
   14.03.11 SDA  При выборе всех документов (почтовые, электронные)  дата определяется по дате выполнения шага зачисления.
   28.10.11 Жаворонкова Н. (joy):  I-00111608-2, I-00111560-2, I-00111560-3 ЭВ При выборе типа документов "Все документы" и типе 
            отчета "Реестр" отбор осуществляется по дате шага зачисления, как и при формировании ведомости (тип отчета "Документы")
   02.11.11 Жаворонкова Н. (joy): I-00114746-2 Исключено дублирование документов в отчете "Реестр"
   23.04.12 Дунаев А. по I-00184818-2 проверка актуальности БИК при смене
//23.07.2012 vihrov I-00223947-2
//27.07.2012 vihrov I-00215102-2 шагов зачисления может быть больше одного. нужен шаг выгрузки в мбр            
   04.09.12 GSP по I-00230067-2 добавил проверку актуальности БИК в реестр, чтобы соответствовало ведомости.
   12.09.12 GSP опер теперь берется с проводки, а не с документа.
   03.07.2013 Gurin S. R-212844-2 
 -------------------------------------------------------------------------------------------*/

import RSD,rcw, rslx, Календарь, rsbdataset, payminter, globals;
//import"outselect.mac";


private Class TSchemaParam () //класс для параметров схемы расчетов А.Киселев 16.11.2010
 var param_number,
     param_name,
     param_fi,
     param_acc,
     param_dprt;
end;

var Fulloutput,  out,  output="\\OutDoc.txt";
var g,g1,g2,g3, sql, dprt, i, sum, cnt, incontrtab;

var     reportdate, 
        Kinddoc,
        Contr,
        Nocontr,
        Schema :TSchemaParam,
        Dep,
        Kind,
        pack,
        Race,
        Opr,
        type,
        incontr,
        inkind,
        inpack,
        indep,
        inoper,
        inrace,
        inracetab,
        inkindschema;



const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;
/*var     DateOt:date,
        Kinddoc,
        Contr,
        Nocontr,
        Dep,
        Kindotpr,
        Numberpack,
        Rejs,
        Opr,
        Kindotcheta;*/
var Fulloutputl, outl, outputl="OutDoc.lbr"; 
record oper (person);     
record department (dp_dep);    

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("PANOUTD1", fulloutputl, TRUE); 

/*Найдем имя по Partyid*/
private macro GetClientName(id)

var  sl=" select part.t_name from dparty_dbt part where part.t_partyid="+id;

var  DataS=TRsbDataSet(sl);

  if( DataS.moveNext())
    return DataS.name;
  else
    msgbox("Субъект не найден в party.dbt");
    return 0;
  end;

END;

private macro outall()
var rsd = rsdrecordset(rsdcommand(sql));
while (rsd.movenext())
if (type == "документы")
/* EVG 2/03/2011 Убраз ДПП по просьбе Розалии Стотланд.
[│#########│##########│####################│#########│####################│#####│##################│#############################################│]*/
[│#########│####################│#########│####################│#####│##################│#############################################│]
/* EVG 1/03/2011 Нужно убрать перевод каретки, чтобы строчка не переносилась.
(rsd.value(0),date(rsd.value(7)),rsd.value(2),rsd.value(1),rsd.value(3),rsd.value(4),money(rsd.value(5)):f,substr(rsd.value(6),1,45));*/
(rsd.value(0),rsd.value(2),rsd.value(1),rsd.value(3),rsd.value(4),money(rsd.value(5)):f,substr( strSubst(rsd.value(6), "\n", ""), 1,45));
i=1;
sum = sum+rsd.value(5);
cnt = cnt + 1;
while ((strlen(rsd.value(6))-i*45)>0)
/* EVG 2/03/2011 Убраз ДПП по просьбе Розалии Стотланд.
[│         │          │                    │         │                    │     │                  │#############################################│]*/
[│         │                    │         │                    │     │                  │#############################################│]
/* EVG 1/03/2011 Нужно убрать перевод каретки, чтобы строчка не переносилась.
(substr(rsd.value(6),(i*45+1)));*/
(substr( strSubst(rsd.value(6), "\n", ""),(i*45+1)));
i = i+1;
end;
elif (type == "операционисты")
[│###############│#####################│####################│#############################│]
(rsd.value(0),money(rsd.value(1)):f,int(rsd.value(2)):c,"");
sum = sum+rsd.value(1);
cnt = cnt + rsd.value(2);
elif (type == "подразделения")
[│###############│#########################################│####################│#############################│]
(rsd.value(0),rsd.value(1),int(rsd.value(3)):c,money(rsd.value(2)):f);
sum = sum+rsd.value(2);
cnt = cnt + rsd.value(3);
else
[│###############│#####################│####################│#############################│]
(int(rsd.value(2)),money(rsd.value(0)):f,int(rsd.value(1)),"");
sum = sum+rsd.value(0);
cnt = cnt + rsd.value(1);
end;
end;
end;



MACRO Event (dlg, cmd, id, key) 
   array gname;
var k=0;
//   var gg=3, data, ac;
//    var gg=5;
   gname(0)="документы";
   gname(1)="операционисты";
   gname(2)="подразделения"; 
   gname(3)="реестр";
/*   gname(4)="справка по платежам";*/
   gname(3)="реестр";
   array gname1;
   gname1(0)="все документы";
   gname1(1)="отправленные";
   gname1(2)="не отправленные";
   array gname2;
   gname2(0)="все виды платежей";
   gname2(1)="электронно";
   gname2(2)="почтой";
   array gname3;
   sql = " SELECT T_NUMBER,T_NAME,T_FIID,T_ACCOUNT,T_DEPARTMENT FROM dcorschem_dbt " +
         "  ORDER BY T_NUMBER "; //{OperDprtNode}
   var rsd_ = rsdrecordset(rsdcommand(sql));
   while (rsd_.movenext())
    gname3(k) = rsd_.value(1);
    k = k + 1;
   end;
   gname3(k) = "Все";

   var const_mess = "~F2~ Продолжить ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dlg.rec.date  = {curDate};
      dprt = 1;
      dlg.rec.kinddoc ="Все документы";
      dlg.rec.contr ="X";
      dlg.rec.nocontr ="X";
      dlg.rec.kindschema = gname3(0); 
      g3 = 0;
      dlg.rec.dep = "000";
      dlg.rec.deptname = {Name_Bank};
      dlg.rec.kindotpr = "Все виды платежей";
      dlg.rec.numberpack = "";
      dlg.rec.rejs = "";
      dlg.rec.oper = "";
      dlg.rec.opername = "По всем операционистам";
      dlg.rec.kindotcheta = "документы";
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     if ((FldName(dlg,id)=="date"))
       message(" ~F3~ Выбор даты из календаря "+const_mess);
 /*    elif (FldName(dlg,id)=="DateBegin")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="DateEnd")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="G")
       message(" ~F3~ Выбор главы счетов "+const_mess);
     elif (FldName(dlg,id)=="Dept")
       message(" ~F3~ Выбор филиала "+const_mess);
     elif (FldName(dlg,id)=="Oper")
       message(" ~F3~ Выбор операциониста "+const_mess);
     elif (FldName(dlg,id)=="Account")
       message(" ~F3~ Выбор Счета "+const_mess);   */
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
     if (FldName(dlg,id) == "date")
       if ( dlg.rec.Date > {curdate} )
         MsgBox("Дата не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       end;
     end;
 
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "date")
          dlg.rec.date = GetDateByCalendar ({curDate});
        end;
 
         if (FldName(dlg,id) == "dep")
           if (ListDepartment (Department))
              dlg.rec.dep = Department.name;
              dprt = department.code;
              dlg.rec.deptname = GetClientName(Department.PartyID);
              message(" ~F3~ Список подразделений "+const_mess);
              UpdateFields(dlg);
           end;
        end;
        /*Вид документа*/
        if (FldName(dlg,id) == "kinddoc")
        g1=menu(gname1,"Выбор типа отчета");
           if (g1==0)  
              dlg.rec.kinddoc = "все документы";
              UpdateFields(dlg);
           elif(g1==1)
              dlg.rec.kinddoc = "отправленные";
              UpdateFields(dlg);
           elif(g1==2)
              dlg.rec.kinddoc = "не отправленные";
              UpdateFields(dlg);
           end;
        End;
        /*Вид отчета*/
        if (FldName(dlg,id) == "kindotcheta")
            g=menu(gname,"Выбор типа отчета");

            if (g==0)
              dlg.rec.kindotcheta = "документы";                         
              UpdateFields(dlg);
            elif (g==1)
              dlg.rec.kindotcheta = "операционисты";                         
              UpdateFields(dlg);
            elif (g==2)
              dlg.rec.kindotcheta = "подразделения";
              UpdateFields(dlg);
            elif (g==3)
              dlg.rec.kindotcheta = "реестр";
              UpdateFields(dlg);
 /*           elif (g==4)
              dlg.rec.kindotcheta = "справка по платежам";
              UpdateFields(dlg);
            else
              dlg.rec.kindotcheta = "документы";
              UpdateFields(dlg); */
            end;
        end;
         /*Вид отправки*/
         if (FldName(dlg,id) == "kindotpr")
           g2=menu(gname2,"Выбор вида отправки");
           if (g2==0)
              dlg.rec.kindotpr = "все виды платежей";                         
              UpdateFields(dlg);
           elif (g2==1)
              dlg.rec.kindotpr = "электронно";                         
              UpdateFields(dlg);
           elif (g2==2)
              dlg.rec.kindotpr = "почтой";                         
              UpdateFields(dlg);
           end;
         end;
        if (FldName(dlg,id) == "oper")
           if (Listoper (oper))
              dlg.rec.oper = oper.oper;
              dlg.rec.opername = oper.name;
              message(" ~F3~ Выбор операциониста "+const_mess);              
              UpdateFields(dlg);
          end;
        end;
        // схема расчетов
        if (FldName(dlg,id) == "kindschema")
         g3=menu(gname3,"Выбор схемы расчетов");
         if( g3 >= 0)
          dlg.rec.kindschema = gname3(g3);
          UpdateFields(dlg);
         end;
        end;
        // схема расчетов
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
           if (FldName(dlg,id) == "contr") 
            if (dlg.rec.contr=="")
            dlg.rec.contr="X";
            UpdateFields(dlg);
            else
            dlg.rec.contr="";
            UpdateFields(dlg);
            end;
           elif (FldName(dlg,id) == "nocontr") 
            if (dlg.rec.nocontr=="")
            dlg.rec.nocontr="X";
            UpdateFields(dlg);
            else
            dlg.rec.nocontr="";
            UpdateFields(dlg);
            end;
           elif (FldName(dlg,id) == "kindschema")
            dlg.rec.kindschema= gname3(Asize(gname3)-1);
            g3 = Asize(gname3)-1;
            UpdateFields(dlg);
           elif (FldName(dlg,id) == "dep")
            dlg.rec.dep="000";
            dprt = 1;
            dlg.rec.deptname="ОАО Пробизнесбанк";  
            UpdateFields(dlg);
      /*     elif (FldName(dlg,id) == "oper")
            dlg.rec.oper="0";
            dlg.rec.opername="Все опера";
            UpdateFields(dlg);   */
          end; 

     elif (( KEY == KEY_F2 ) or (KEY == KEY_ENTER))         //Проверки при вводе
         if ( dlg.rec.date > {curdate} )
                MsgBox("Дата не может быть больше даты текущего операционного дня");
                return CM_IGNORE;          
         end;
        reportdate  = dlg.rec.date;
        Kinddoc = dlg.rec.kinddoc;
        Contr   = dlg.rec.contr;
        Nocontr = dlg.rec.nocontr;
        Dep     = dprt;
        Kind = dlg.rec.kindotpr;
        pack = dlg.rec.numberpack;
        Race = dlg.rec.rejs;
        Opr = dlg.rec.oper;
        type = dlg.rec.kindotcheta;


        if ( g3 != (Asize(gname3)-1) )
         rsd_ = rsdrecordset(rsdcommand(sql));
         k = 0;
         while (rsd_.movenext())
          if (k == g3)
           Schema.param_number = rsd_.value(0);
           Schema.param_name = rsd_.value(1);
           Schema.param_fi = rsd_.value(2);
           Schema.param_acc = rsd_.value(3);
           Schema.param_dprt = rsd_.value(4);
           break;
          end;
          k = k + 1;
         end;
        else
         Schema.param_number = "";
         Schema.param_name = gname3(Asize(gname3)-1);
         Schema.param_fi = "";
         Schema.param_acc = "";
         Schema.param_dprt = "";
        end;

        if ((reportdate < {curDate}))    
           Return CM_SAVE;
        elif(1)// (gettrue(true,"Дата равна текущему опрерационному дню. Продолжить?"))
           Return CM_SAVE;
        end;
     end;
   end;
        
END;
/*Точка входа в макрос*/
if (RunDialog(dlg, "Event"))                  
incontr = "";
inkind = "";
inpack = "";
indep = "";
inoper = "";
inrace = "";
inracetab = "";
incontrtab = "";
inkindschema = "";


if (race)
/*inracetab = " dwlpm_dbt  wlpm, dwlmes_dbt mes, dwlsess_dbt sess, dwlmeslnk_dbt lnk, ";

inrace =    " and wlpm.t_paymentid = pmpaym.t_paymentid "+
    " and mes.t_sessionid = sess.t_sessionid "+ // Если нужен номер сеанса
    " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY')"+
    " AND lnk.t_objid = wlpm.t_wlpmid "+
    " AND mes.t_mesid = lnk.t_mesid "+
    " and sess.T_NUMBERRACE= "+race+ " ";            */
    if (kinddoc == "отправленные")    //Выгруженные
	inrace =        " and sess.T_NUMBERRACE= "+race+ " ";
    else
	inrace ="";
    end;
end;
//	indep = "and pmpaym.t_department = "+dep;
	indep = " and pmpaym.t_department = 1 ";
 if (dep and (dep != 1))
	indep = indep + "and pmpaym.t_opernode="+dep;  //23.07.2012 vihrov I-00223947-2
 end;

 if (opr)
	inoper = " AND arh.t_oper = "+opr;
//	inoper = " AND pmpaym.t_oper = "+opr;
 end;
 if ((contr) and (nocontr))
		incontr =   " AND (curst.T_NUMVALUE = 1 "+
	        	  " OR curst.T_NUMVALUE = 2)   ";
//"   AND pmpaym.t_futurepayeraccount = pmpaym.t_futurereceiveraccount ";
 elif (contr)
	  if (kinddoc == "не отправленны")
		incontrtab = " doprstep_dbt step, ";
		incontr =     " AND pmpaym.t_futurepayeraccount = pmpaym.t_futurereceiveraccount "+
	              " AND step.t_id_operation = opr.t_id_operation "+
	              " AND step.t_symbol = 'Ф' "+
	              " AND step.t_blockid = 10000145 "+
        	      " AND step.t_isexecute = 'R' ";
	  else
		incontr =   " AND curst.T_NUMVALUE = 2 ";
	  end;
 elif (nocontr)
		incontr =   " AND curst.T_NUMVALUE = 1 ";
 else
		incontr =   " AND curst.T_NUMVALUE = 99 "; //Если не задали не один из вариантов, то ставим то, что явно не будет
 end;
debugbreak;
 if (kind == "электронно")
	inkind =  "  AND rm.t_paymentkind = 'Э' ";
/*SDA - на переаттестацию  */
/*      "   AND sess.t_tpid = 9 ";
if (kinddoc == "Все документы")
inkind =  "  AND rm.t_paymentkind = 'Э' ";
end;
*/
 elif (kind == "почтой")
	inkind =  "  AND rm.t_paymentkind = 'П' ";
 else
	inkind =  "";
 end;

  if (pack)  //Здесь еще нужна доработка
	inpack =  "     AND pmpaym.t_numberpack = "+pack;
  end;

 if ( Schema.param_acc )  
 	inkindschema = "     AND pmprop.T_CORSCHEM = " + Schema.param_number + "     AND pmprop.T_PAYFIID = "+Schema.param_fi + "  ";

/*         Schema.param_number = rsd_.value(0);
         Schema.param_name = rsd_.value(1);
         Schema.param_fi = rsd_.value(2);
         Schema.param_acc = rsd_.value(3);
         Schema.param_dprt = rsd_.value(4);
*/
 end;


 //    t_dockind = 201  Пока все закоментировал, нужны не только клиентские платежи
if (type == "документы")
   if (kinddoc == "отправленные")    //Выгруженные

   sql = " SELECT distinct rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
         " pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
         " rm.t_ground, pmprop.T_TRANSFERDATE, pmpaym.t_paymentid "+
     " FROM doproper_dbt opr, "+
      "    dpmprop_dbt pmprop, "+
      "    dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
       inracetab +
      "    doprstep_dbt step, "+
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
      "    dpmrmprop_dbt rm, "+
      "    dobjcode_dbt obj, "+
      "    doprcurst_dbt curst "+
    " WHERE pmprop.t_group = 1 "+
     " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
     " AND curst.T_STATUSKINDID = 296 "+
     " AND obj.t_codekind = 3 "+
     " AND obj.t_objecttype = 3 "+
     /*DAI 23.04.12 по I-00184818-2 проверка актуальности БИК при смене*/
     " and obj.T_BANKDATE <= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
     " and (obj.T_BANKCLOSEDATE >= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+ 
     "      or obj.T_BANKCLOSEDATE = TO_DATE ('01.01.0001', 'DD-MM-YYYY')) "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
     " AND obj.t_objectid = pmpaym.t_payerbankid "+*/
     " AND obj.t_objectid = pmpaym.t_receiverbankid "+
     " AND pmprop.t_issender = CHR (0) "+
     " AND pmpaym.t_fiid = 0 "+
      incontr + inkind + inpack + inrace + inoper + indep + inkindschema  +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
     " AND pmpaym.t_paymentid = pmprop.t_paymentid "+       
     " AND pmpaym.t_paymentid = rm.t_paymentid "+
//     " AND pmpaym.t_dockind = 201 "+
//     " AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
       " AND step.t_id_operation = opr.t_id_operation "+
     " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
     " AND step.t_symbol = 'Ф'                  "+
              " AND step.t_blockid = 10000145 "+
//     " AND step.t_dockind = 201 "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
     " and sess.t_direct = chr(0) "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid "+
       " AND step.t_isexecute = chr(88)              " + 
       "  ORDER BY  T_AMOUNT  ";
 
   elif (kinddoc == "не отправленны")   //Невыгруженные

   sql = " SELECT  distinct rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
         " pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
         " rm.t_ground, pmprop.T_TRANSFERDATE, pmpaym.t_paymentid  "+
     " FROM doproper_dbt opr, "+
         " dpmprop_dbt pmprop, "+
         " dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
          inracetab + incontrtab +
         " dpmrmprop_dbt rm, "+
         " dobjcode_dbt obj, "+
         " doprcurst_dbt curst "+
    " WHERE pmprop.t_group = 1 "+
     " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
     " AND curst.T_STATUSKINDID = 296 "+
     " AND obj.t_codekind = 3 "+
     " AND obj.t_objecttype = 3 "+
     /*DAI 23.04.12 по I-00184818-2 проверка актуальности БИК при смене*/
     " and obj.T_BANKDATE <= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
     " and (obj.T_BANKCLOSEDATE >= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+ 
     "      or obj.T_BANKCLOSEDATE = TO_DATE ('01.01.0001', 'DD-MM-YYYY')) "+

     /* EVG 1/02/2011 Банк получателя вместо плательщика.
     " AND obj.t_objectid = pmpaym.t_payerbankid "+*/
     " AND obj.t_objectid = pmpaym.t_receiverbankid "+
     " AND pmprop.t_issender = CHR (0) "+
     " AND pmpaym.t_fiid = 0 "+
     " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
     " AND pmpaym.t_paymentid = rm.t_paymentid "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+     
     incontr + inkind + inpack + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
 //    " AND pmpaym.t_dockind = 201 "+

//   " AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
     " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )" +
"  ORDER BY  T_AMOUNT  ";
/*     " SELECT pmpaym1.t_paymentid "+ 
     " FROM doproper_dbt opr1,  "+
     "   dpmpaym_dbt pmpaym1,  "+
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
     "   doprstep_dbt step1  "+
     " WHERE pmpaym1.t_fiid = 0  "+
//     " AND pmpaym1.t_dockind = 201  "+
//     " AND pmpaym1.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
     " AND step1.t_id_operation = opr1.t_id_operation  "+
  "   AND pmpaym1.t_dockind = opr1.t_dockind "+
     " AND opr1.t_documentid = LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0')  "+
       " and wlpm.t_paymentid = pmpaym1.t_paymentid "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid "+
     " AND step1.t_symbol = 'Ф'                   "+
//     " AND step1.t_dockind = 201  "+
     " AND step1.t_isexecute = chr(88)      )             ";*/


   else               //Все
   sql = " SELECT distinct rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
      " pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
      " rm.t_ground, pmprop.T_TRANSFERDATE, pmpaym.t_paymentid  "+
 " FROM doproper_dbt opr, "+
      " dpmprop_dbt pmprop, "+
      " dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
      inracetab +
      " dpmrmprop_dbt rm, "+
      " dobjcode_dbt obj, "+
/**SDA****************************************/
//      " doprcurst_dbt curst, "+
//      " doprcurst_dbt curst1 "+
/*********************************************/
      " doprstep_dbt step "+
 " WHERE pmprop.t_group = 1 "+
/* SDA
  " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
*/
/* SDA с выполненным шагом зачисления  */
  " AND step.t_id_operation = opr.t_id_operation "+
  " AND step.t_blockid = 10000130 "+ // vihrov пока временно вернул шаг зачисления
//  " AND step.t_blockid = 10000145 "+ //27.07.2012 vihrov шагов зачисления может быть больше одного. нужен шаг выгрузки в мбр
  " AND step.t_isexecute = CHR (88) "+
//Gurin S. 03.07.2013 R-212844-2 да.. может быть несколько шагов зачисления
  "AND step.t_fact_date = " +
  "               (SELECT   MIN (t_fact_date) " +
  "                  FROM   doprstep_dbt       " +
  "                 WHERE   t_id_operation = opr.t_id_operation " +
  "                         AND T_BLOCKID = 10000130)" +
  " AND step.T_FACT_DATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
/*  " AND curst.T_STATUSKINDID = 296 "+*/
/*****************************************/
  " AND obj.t_codekind = 3 "+
  " AND obj.t_objecttype = 3 "+
     /*DAI 23.04.12 по I-00184818-2 проверка актуальности БИК при смене*/
     " and obj.T_BANKDATE <= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
     " and (obj.T_BANKCLOSEDATE >= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+ 
     "      or obj.T_BANKCLOSEDATE = TO_DATE ('01.01.0001', 'DD-MM-YYYY')) "+

     /* EVG 1/02/2011 Банк получателя вместо плательщика.
  " AND obj.t_objectid = pmpaym.t_payerbankid "+*/
  " AND obj.t_objectid = pmpaym.t_receiverbankid "+
  " AND pmprop.t_issender = CHR (0) "+
//  " AND pmpaym.t_paymstatus>0 "+
  " AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+                                     
/*SDA********************************************************************* 
    incontr + inkind + inpack + inrace + inoper + indep + inkindschema +
**************************************************************************/
    inkind + inpack + inrace + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
  " AND pmpaym.t_paymentid = rm.t_paymentid "+            
//  " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
/*SDA*/
//  "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
/*****************************************************************************/
  " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "
/**SDA****************************************************/
//  "   AND curst1.t_id_operation = opr.t_id_operation "+
//  " AND curst1.T_STATUSKINDID = 292 "+
//  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) " +
/**********************************************************/
  "  ORDER BY  T_AMOUNT  ";
   end; 


elif (type == "операционисты")  

   if (kinddoc == "отправленные") //Выгруженные
   sql = "SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
    " FROM doproper_dbt opr, "+
        " dpmprop_dbt pmprop, "+
        " dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
        inracetab +
        " doprstep_dbt step, "+
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
        " dpmrmprop_dbt rm, "+
        " dobjcode_dbt obj, "+
        " doprcurst_dbt curst          "+
  " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
    " AND obj.t_objecttype = 3 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
    " AND obj.t_objectid = pmpaym.t_payerbankid "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
    " AND pmprop.t_issender = CHR (0) "+
     incontr + inkind + inpack + inrace + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
    " AND pmpaym.t_fiid = 0 "+                             
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//    " AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND step.t_id_operation = opr.t_id_operation "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
              " AND step.t_blockid = 10000145 "+
    " AND step.t_symbol = 'Ф'      "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
     " and sess.t_direct = chr(0) "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid "+
    " AND step.t_isexecute = chr(88)   "+
//    " AND step.t_dockind = 201 "+
      "GROUP BY pmpaym.t_oper ";

   elif (kinddoc == "не отправленны")
   sql = "SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
        " dpmprop_dbt pmprop, "+
        " dpmpaym_dbt pmpaym, "+
        " dpmrmprop_dbt rm, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab + incontrtab +
        " dobjcode_dbt obj, "+
        " doprcurst_dbt curst          "+
  " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
    " AND obj.t_objecttype = 3 "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
    " AND obj.t_objectid = pmpaym.t_payerbankid "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
    " AND pmprop.t_issender = CHR (0) "+
    " AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+     
     incontr + inkind + inpack + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )"+
   " GROUP BY pmpaym.t_oper ";

   else                     //Все
   sql =" SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab +
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst,          "+
   "      doprcurst_dbt curst1          "+
  " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
//  " AND pmpaym.t_paymstatus>0 "+
    " AND obj.t_objecttype = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep +  inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
    " AND obj.t_objectid = pmpaym.t_payerbankid "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
    " AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
    " AND pmpaym.t_fiid = 0 "+
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND curst1.t_id_operation = opr.t_id_operation "+
  " AND curst1.T_STATUSKINDID = 292 "+
  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) " +
   "GROUP BY pmpaym.t_oper ";

   end;

elif (type == "подразделения")

   if (kinddoc == "отправленные") //Выгруженные
   sql =" SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab +
   "      doprstep_dbt step, "+
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
   "      dparty_dbt party, "+
   "      ddp_dep_dbt dep, "+
   "      doprcurst_dbt curst "+
   "WHERE pmprop.t_group = 1 "+
   "  AND party.t_partyid = dep.t_partyid "+ 
   "  AND dep.t_code = pmpaym.t_department "+ 
   "  AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
   "  AND curst.T_STATUSKINDID = 296 "+
     " and sess.t_direct = chr(0) "+
   "  AND obj.t_codekind = 3 "+
   "  AND obj.t_objecttype = 3 "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
   "  AND obj.t_objectid = pmpaym.t_payerbankid "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
   "  AND pmprop.t_issender = CHR (0) "+
     "   AND pmpaym.t_dockind = opr.t_dockind "+
   "  AND pmpaym.t_fiid = 0 "+
              " AND step.t_blockid = 10000145 "+
   "  AND pmpaym.t_paymentid = pmprop.t_paymentid "+
     incontr + inkind + inpack + inrace + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
   "  AND pmpaym.t_paymentid = rm.t_paymentid "+           
//   "  AND pmpaym.t_dockind = 201 "+
//   "  AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid "+
   "  AND step.t_id_operation = opr.t_id_operation "+
   "  AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
   "  AND step.t_symbol = 'Ф'  "+
   "  AND step.t_isexecute = chr(88) "+
//   "  AND step.t_dockind = 201 "+
   "GROUP BY pmpaym.t_department, party.t_name ";

   elif (kinddoc == "не отправленны" ) //Невыгруженные

   sql = "SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab + incontrtab +
   "      dparty_dbt party, "+
   "      ddp_dep_dbt dep, "+
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst "+
  " WHERE pmprop.t_group = 1 "+
   "  AND party.t_partyid = dep.t_partyid "+ 
   "  AND dep.t_code = pmpaym.t_department "+ 
   "  AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
   "  AND curst.T_STATUSKINDID = 296 "+
   "  AND obj.t_codekind = 3 "+
   "  AND obj.t_objecttype = 3 "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
   "  AND obj.t_objectid = pmpaym.t_payerbankid "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
   "  AND pmprop.t_issender = CHR (0) "+
   "  AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+     
     incontr + inkind + inpack + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
   "  AND pmpaym.t_paymentid = pmprop.t_paymentid "+
   "  AND pmpaym.t_paymentid = rm.t_paymentid "+
//   "  AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
   "  AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )"+
   "GROUP BY pmpaym.t_department, party.t_name      ";

   else   //Все
   sql = " SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab +
   "      dpmpaym_dbt pmpaym, "+
   "      dparty_dbt party, "+
   "      ddp_dep_dbt dep, "+
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst, "+
   "      doprcurst_dbt curst1 "+
  " WHERE pmprop.t_group = 1 "+
   "  AND party.t_partyid = dep.t_partyid "+ 
   "  AND dep.t_code = pmpaym.t_department "+ 
  "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
  "   AND curst.T_STATUSKINDID = 296 "+
//  " AND pmpaym.t_paymstatus>0 "+
  "   AND obj.t_codekind = 3 "+
  "   AND obj.t_objecttype = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep +  inkindschema + 
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
  "   AND obj.t_objectid = pmpaym.t_payerbankid "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
  "   AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  "   AND pmpaym.t_paymentid = rm.t_paymentid "+
//  "   AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
  "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND curst1.t_id_operation = opr.t_id_operation "+
  " AND curst1.T_STATUSKINDID = 292 "+
  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) "+
   " GROUP BY pmpaym.t_department, party.t_name";
   end;

else

   if (kinddoc == "отправленные")
         
   sql = "SELECT   SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt, "+
/* I-00002546 Тема: Пачки подразделений указаны не правильно у внешних выгруженных исходящих платежей*/
/* Нужно выводить пачку полностью*/
/*      "    decode(SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)),null,0,SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2))) AS reestr "+*/
     "    t_numberpack AS reestr "
    " FROM doproper_dbt opr, "+
    "     dpmprop_dbt pmprop, "+
    "     dpmpaym_dbt pmpaym, "+
    "     doprstep_dbt step, "+
    "     dpmrmprop_dbt rm, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab +
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
    "     dobjcode_dbt obj, "+
    "     doprcurst_dbt curst \n"+
  " WHERE pmprop.t_group = 1 "+
  "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
  "   AND curst.T_STATUSKINDID = 296 "+
  "   AND obj.t_codekind = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep + inkindschema  +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
  "   AND obj.t_objecttype = 3 "+                          
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
  "   AND obj.t_objectid = pmpaym.t_payerbankid    "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
  "   AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_fiid = 0 "+
    "   AND pmpaym.t_dockind = opr.t_dockind "+
   "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  "   AND pmpaym.t_paymentid = rm.t_paymentid \n"+
//  "   AND pmpaym.t_dockind = 201 "+
//  "   AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
              " AND step.t_blockid = 10000145 "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
     " and sess.t_direct = chr(0) "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid \n"+
  "   AND step.t_id_operation = opr.t_id_operation "+
  "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND step.t_symbol = 'Ф' "+
  "   AND step.t_isexecute = chr(88) "+
//  "   AND step.t_dockind = 201 "+
/*   " GROUP BY SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)) "+*/
   " GROUP BY t_numberpack "+
    "order by reestr    ";

//println (sql);
   elif (kinddoc == "не отправленны") //Невыгруженные

   sql =" SELECT   SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt, "+
/*     "     decode(SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)),null,0,SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2))) AS reestr "+*/
     "     t_numberpack AS reestr "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
          inracetab + incontrtab +
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst "+
   " WHERE pmprop.t_group = 1 "+
   "  AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
   "  AND curst.T_STATUSKINDID = 296 "+
   "  AND obj.t_codekind = 3 "+
   "  AND obj.t_objecttype = 3 "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
   "  AND obj.t_objectid = pmpaym.t_payerbankid    "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
   "  AND pmprop.t_issender = CHR (0) "+
   "  AND pmpaym.t_fiid = 0 "+
   "  AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+     
     incontr + inkind + inpack + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
   "  AND pmpaym.t_paymentid = rm.t_paymentid "+
//   "  AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
   "  AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+ 
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )"+
/*   " GROUP BY SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)) "+*/
   " GROUP BY t_numberpack "+
    "order by reestr    ";

   else 
/* 28.10.11  Жаворонкова Н. (joy) I-00111608-2, I-00111560-2, I-00111560-3 
                                  Отбор в реестр приведен в соответсвие с отбором в ведомость (с выполненным шагом зачисления) */
/* 02.11.11   Жаворонкова Н. (joy) I-00114746-2 Исключено дублирование платежей  в результатах выборки  (distinct)*/
   sql = "WITH t AS (SELECT DISTINCT rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
      " pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
      " rm.t_ground, pmprop.T_TRANSFERDATE, pmpaym.t_paymentid " +
/*      "   decode(SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)),null,0,SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2))) AS reestr "+*/
    " FROM doproper_dbt opr, "+
    "     dpmprop_dbt pmprop, "+
    "     dpmpaym_dbt pmpaym, "+
/*--------------------------------------------------------------------------------------GSP*/
      "    dpmdocs_dbt docs, "+
      "    dacctrn_dbt arh, "+
/*--------------------------------------------------------------------------------------*/
         inracetab +
    "     dpmrmprop_dbt rm, "+
    "     dobjcode_dbt obj, "+
/****************************  28.10.11 joy
    "doprcurst_dbt curst, "+
    "     doprcurst_dbt curst1 "+ 
*****************************/
    "     doprstep_dbt step" +
    " WHERE pmprop.t_group = 1 "+
/*************************** 28.10.11 joy
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
//  " AND pmpaym.t_paymstatus>0 "+
    " AND curst.T_STATUSKINDID = 296 "+
***************************/
/* 28.10.11 joy C выполненным шагом зачисления как и при формировании ведомости*/
    " AND step.t_id_operation = opr.t_id_operation "+
    " AND step.t_blockid = 10000130 "+ // vihrov пока временно вернул шаг зачисления
//	" AND step.t_blockid = 10000145 "+ //27.07.2012 vihrov шагов зачисления может быть больше одного. нужен шаг выгрузки в мбр
    " AND step.t_isexecute = CHR (88) "+
//Gurin S. 03.07.2013 R-212844-2 да.. может быть несколько шагов зачисления
  "AND step.t_fact_date = " +
  "               (SELECT   MIN (t_fact_date) " +
  "                  FROM   doprstep_dbt       " +
  "                 WHERE   t_id_operation = opr.t_id_operation " +
  "                         AND T_BLOCKID = 10000130)" +
    " AND step.T_FACT_DATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
/******************************************************************/
    " AND obj.t_codekind = 3 "+
/*     incontr + inkind + inpack + inrace + inoper + indep +  inkindschema +*/
     inkind + inpack + inrace + inoper + indep + inkindschema +
/*--------------------------------------------------------------------------------------GSP*/
     " AND arh.T_chapter = 1 "+
     " AND pmpaym.T_PAYMENTID = docs.T_PAYMENTID "+
     " AND ARH.T_ACCTRNID = DOCS.T_ACCTRNID " + //TAM 21.10.2014 adaptation
     //" AND arh.t_applicationkey = docs.t_applicationkey"+
/*--------------------------------------------------------------------------------------*/
    " AND obj.t_objecttype = 3 "+
     /* EVG 1/02/2011 Банк получателя вместо плательщика.
    " AND obj.t_objectid = pmpaym.t_payerbankid    "+*/
    " AND obj.t_objectid = pmpaym.t_receiverbankid "+
     " and obj.T_BANKDATE <= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+                //GSP по I-00230067-2 привел реестр в соответствие с ведомостью
     " and (obj.T_BANKCLOSEDATE >= TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+ 
     "      or obj.T_BANKCLOSEDATE = TO_DATE ('01.01.0001', 'DD-MM-YYYY')) "+
    " AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
    " AND pmpaym.t_fiid = 0 "+
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
/***************************** 28.10.11 joy
"  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
******************************/
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0')) "+
/*01.11.2011 joy */ 
    " SELECT SUM (t_amount) AS SUM, COUNT (1) AS cnt, t_numberpack AS reestr" +
    " FROM t" +
/**************************** 28.10.11 joy
"   AND curst1.t_id_operation = opr.t_id_operation "+
" AND curst1.T_STATUSKINDID = 292 "+
  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) "+
****************************/
   " GROUP BY t_numberpack "+
/*   " GROUP BY SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)) "+*/
    "order by reestr    ";
   end;
end;
sum = 0;
cnt = 0;
if (type == "документы")

/* EVG 2/03/2011 Убраз ДПП по просьбе Розалии Стотланд.
[                                       Ведомость выгруженных документов 
                                                   за ##########
┌─────────┬──────────┬────────────────────┬─────────┬────────────────────┬─────┬──────────────────┬─────────────────────────────────────────────┐
│ Номер   │   ДПП    │        Счет        │   БИК   │       Счет         │Номер│      Сумма       │                     Основание               │
│ докум.  │          │     плательщика    │ получат.│     получателя     │пачки│                  │                                             │
├─────────┼──────────┼────────────────────┼─────────┼────────────────────┼─────┼──────────────────┼─────────────────────────────────────────────┤]
*/
[                                       Ведомость выгруженных документов 
                                                   за ##########
┌─────────┬────────────────────┬─────────┬────────────────────┬─────┬──────────────────┬─────────────────────────────────────────────┐
│ Номер   │        Счет        │   БИК   │       Счет         │Номер│      Сумма       │                     Основание               │
│ докум.  │     плательщика    │ получат.│     получателя     │пачки│                  │                                             │
├─────────┼────────────────────┼─────────┼────────────────────┼─────┼──────────────────┼─────────────────────────────────────────────┤]
(date(reportdate));
elif (type == "операционисты")
[                    Отчет о внешних платежах по операционисту
                                    #############
┌───────────────┬─────────────────────┬────────────────────┬─────────────────────────────┐
│###############│#####################│####################│#############################│
├───────────────┼─────────────────────┼────────────────────┼─────────────────────────────┤]
(date(reportdate),"Операционист":c,"Сумма док-тов":c, "Кол-во док-тов":c, "Примечание":c);
elif (type == "подразделения")
[                   Отчет о внешних платежах Банка и клиентов
                                по подразделениям
                                      ##########
┌───────────────┬─────────────────────────────────────────┬────────────────────┬─────────────────────────────┐
│###############│#########################################│####################│#############################│
├───────────────┼─────────────────────────────────────────┼────────────────────┼─────────────────────────────┤]
(date(reportdate),"№ пачки":c,"Наименование подразделения":c, "Итого док-тов":c, "Итого сумма документов":c);
else
[                    Итоги документов по реестрам в разрезе подразделений 
                         за ##########
фильтр:  ###############
┌───────────────┬─────────────────────┬────────────────────┬─────────────────────────────┐
│###############│#####################│####################│#############################│
├───────────────┼─────────────────────┼────────────────────┼─────────────────────────────┤]
(date(reportdate),kinddoc, "Платежи":c,"Сумма док-тов":c, "Кол-во док-тов":c, "Примечание":c)
end;

outall();

if (type == "документы")
/* EVG 2/03/2011 Убраз ДПП по просьбе Розалии Стотланд.
[├─────────┴──────────┴────────────────────┴─────────┴────────────────────┴─────┴──────────────────┴─────────────────────────────────────────────┤
 │    Итого документов  ######### на сумму  ######################                                                                               │]
*/
[├─────────┴────────────────────┴─────────┴────────────────────┴─────┴──────────────────┴─────────────────────────────────────────────┤
 │    Итого документов  ######### на сумму  ######################                                                                    │]
(int(cnt), money(sum):f);

[└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘];
elif (type == "операционисты")
[│      Итого    │#####################│####################│                             │]
(money(sum):f,int(cnt));
[└───────────────┴─────────────────────┴────────────────────┴─────────────────────────────┘];
elif (type == "подразделения")
[│      Итого    │                                         │####################│#############################│]
(int(cnt):c,money(sum):f);
[└───────────────┴─────────────────────────────────────────┴────────────────────┴─────────────────────────────┘];
else
[├───────────────┼─────────────────────┼────────────────────┼─────────────────────────────┤
│               │#####################│####################│                             │
└───────────────┴─────────────────────┴────────────────────┴─────────────────────────────┘]
(money(sum):f,int(cnt));

end;

end;
END;

