/*Внешние документы                                                    */
/*                                                                     */
/*                                                                     */
/*Тихомиров А.Н. 15.09.2009                    Версия 1.0              */
// Lavrenov: 19.06.2012 I-00210224-1 добавил новый пункт "отправленные Payments"
// Lavrenov: 19.06.2012 Обращение к Тихомирову: Алексей, ты себя превзошел!!! Я знал, что у тебя руки не от туда растут, но чтобы ТАК ГЛУБОКО, 
//                                              я даже представить не мог. Отчет мало того, что не читабелен и громоздок, так еще и не 
//                                              работает ни черта, кое-где поправил, все переделывать не стал.
// Gurin S. 19.07.2012 I-00223356-3
// Gurin S. 12.07.2013 R-217437-1

import RSD,rcw, rslx, Календарь, rsbdataset, payminter, globals;
//import"outselect.mac";
var Fulloutput,  out,  output="\\OutDoc.txt";
var g,g1,g2, sql, dprt, i, sum, cnt, incontrtab;

var     reportdate, 
        Kinddoc,
        Contr,
        Nocontr,
        Dep,
        Kind,
        pack,
        Race,
        Opr,
        type,
        incontr,
        inkind,
        inpack,
        indep,
        inoper,
        inrace,
        inracetab;


const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;
/*var     DateOt:date,
        Kinddoc,
        Contr,
        Nocontr,
        Dep,
        Kindotpr,
        Numberpack,
        Rejs,
        Opr,
        Kindotcheta;*/
var Fulloutputl, outl, outputl="OutDoc.lbr"; 
record oper (person);     
record department (dp_dep);    

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("PANOUTD", fulloutputl, TRUE); 

/*Найдем имя по Partyid*/
private macro GetClientName(id)

var  sl=" select part.t_name from dparty_dbt part where part.t_partyid="+id;

var  DataS=TRsbDataSet(sl);

  if( DataS.moveNext())
    return DataS.name;
  else
    msgbox("Субъект не найден в party.dbt");
    return 0;
  end;

END;

private macro outall()
var rsd = rsdrecordset(rsdcommand(sql));
while (rsd.movenext())
if (type == "документы")
[│#########│##########│#########│####################│####################│#####│##################│#############################################│]
(rsd.value(0),date(rsd.value(7)),rsd.value(1),rsd.value(2),rsd.value(3),rsd.value(4),money(rsd.value(5)):f,substr(rsd.value(6),1,45));
i=1;
sum = sum+rsd.value(5);
cnt = cnt + 1;
while ((strlen(rsd.value(6))-i*45)>0)
[│         │          │         │                    │                    │     │                  │#############################################│]
(substr(rsd.value(6),(i*45+1)));
i = i+1;
end;
elif (type == "операционисты")
[│###############│#####################│####################│#############################│]
(rsd.value(0),money(rsd.value(1)):f,int(rsd.value(2)):c,"");
sum = sum+rsd.value(1);
cnt = cnt + rsd.value(2);
elif (type == "подразделения")
[│###############│#########################################│####################│#############################│]
(rsd.value(0),rsd.value(1),int(rsd.value(3)):c,money(rsd.value(2)):f);
sum = sum+rsd.value(2);
cnt = cnt + rsd.value(3);
else
[│###############│#####################│####################│#############################│]
(int(rsd.value(2)),money(rsd.value(0)):f,int(rsd.value(1)),"");
sum = sum+rsd.value(0);
cnt = cnt + rsd.value(1);
end;
end;
end;



MACRO Event (dlg, cmd, id, key) 
   array gname;
//   var gg=3, data, ac;
//    var gg=5;
   gname(0)="документы";
   gname(1)="операционисты";
   gname(2)="подразделения"; 
   gname(3)="реестр";
/*   gname(4)="справка по платежам";*/
   gname(3)="реестр";
   array gname1;
   gname1(0)="все документы";
   gname1(1)="отправленные";
   gname1(2)="не отправленные";
   gname1(3)="отправленные Payments";
   array gname2;
   gname2(0)="все виды платежей";
   gname2(1)="электронно/не задан";
   gname2(2)="почтой";
   var const_mess = "~F2~ Продолжить ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dlg.rec.date  = {curDate};
      dprt = 1;
      dlg.rec.kinddoc ="Все документы";
      dlg.rec.contr ="X";
      dlg.rec.nocontr ="X";
      dlg.rec.dep = "000";
      dlg.rec.deptname = "ОАО Пробизнесбанк";
      dlg.rec.kindotpr = "Все виды платежей";
      dlg.rec.numberpack = "";
      dlg.rec.rejs = "";
      dlg.rec.oper = "";
      dlg.rec.opername = "По всем операционистам";
      dlg.rec.kindotcheta = "документы";
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     if ((FldName(dlg,id)=="date"))
       message(" ~F3~ Выбор даты из календаря "+const_mess);
 /*    elif (FldName(dlg,id)=="DateBegin")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="DateEnd")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="G")
       message(" ~F3~ Выбор главы счетов "+const_mess);
     elif (FldName(dlg,id)=="Dept")
       message(" ~F3~ Выбор филиала "+const_mess);
     elif (FldName(dlg,id)=="Oper")
       message(" ~F3~ Выбор операциониста "+const_mess);
     elif (FldName(dlg,id)=="Account")
       message(" ~F3~ Выбор Счета "+const_mess);   */
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
     if (FldName(dlg,id) == "date")
       if ( dlg.rec.Date > {curdate} )
         MsgBox("Дата не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       end;
     end;
 
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "date")
          dlg.rec.date = GetDateByCalendar ({curDate});
        end;
 
         if (FldName(dlg,id) == "dep")
           if (ListDepartment (Department))
              dlg.rec.dep = Department.name;
              dprt = department.code;
              dlg.rec.deptname = GetClientName(Department.PartyID);
              message(" ~F3~ Список подразделений "+const_mess);
              UpdateFields(dlg);
           end;
        end;
        /*Вид документа*/
        if (FldName(dlg,id) == "kinddoc")
        g1=menu(gname1,"Выбор типа отчета");
           if (g1==0)  
              dlg.rec.kinddoc = "все документы";
              UpdateFields(dlg);
           elif(g1==1)
              dlg.rec.kinddoc = "отправленные";
              UpdateFields(dlg);
           elif(g1==2)
              dlg.rec.kinddoc = "не отправленные";
              UpdateFields(dlg);
           elif(g1==3)
              dlg.rec.kinddoc = "отпр. Payments";
              UpdateFields(dlg);
           end;
        End;
        /*Вид отчета*/
        if (FldName(dlg,id) == "kindotcheta")
            g=menu(gname,"Выбор типа отчета");

            if (g==0)
              dlg.rec.kindotcheta = "документы";                         
              UpdateFields(dlg);
            elif (g==1)
              dlg.rec.kindotcheta = "операционисты";                         
              UpdateFields(dlg);
            elif (g==2)
              dlg.rec.kindotcheta = "подразделения";
              UpdateFields(dlg);
            elif (g==3)
              dlg.rec.kindotcheta = "реестр";
              UpdateFields(dlg);
 /*           elif (g==4)
              dlg.rec.kindotcheta = "справка по платежам";
              UpdateFields(dlg);
            else
              dlg.rec.kindotcheta = "документы";
              UpdateFields(dlg); */
            end;
        end;
         /*Вид отправки*/
         if (FldName(dlg,id) == "kindotpr")
           g2=menu(gname2,"Выбор вида отправки");
           if (g2==0)
              dlg.rec.kindotpr = "все виды платежей";                         
              UpdateFields(dlg);
           elif (g2==1)
              dlg.rec.kindotpr = "электронно/не задан";                         
              UpdateFields(dlg);
           elif (g2==2)
              dlg.rec.kindotpr = "почтой";                         
              UpdateFields(dlg);
           end;
         end;
        if (FldName(dlg,id) == "oper")
           if (Listoper (oper))
              dlg.rec.oper = oper.oper;
              dlg.rec.opername = oper.name;
              message(" ~F3~ Выбор операциониста "+const_mess);              
              UpdateFields(dlg);
          end;
        end;
    
        
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
           if (FldName(dlg,id) == "contr") 
            if (dlg.rec.contr=="")
            dlg.rec.contr="X";
            UpdateFields(dlg);
            else
            dlg.rec.contr="";
            UpdateFields(dlg);
            end;
           elif (FldName(dlg,id) == "nocontr") 
            if (dlg.rec.nocontr=="")
            dlg.rec.nocontr="X";
            UpdateFields(dlg);
            else
            dlg.rec.nocontr="";
            UpdateFields(dlg);
            end;
           elif (FldName(dlg,id) == "dep")
            dlg.rec.dep="000";
            dprt = 1;
            dlg.rec.deptname="ОАО Пробизнесбанк";  
            UpdateFields(dlg);
      /*     elif (FldName(dlg,id) == "oper")
            dlg.rec.oper="0";
            dlg.rec.opername="Все опера";
            UpdateFields(dlg);   */
          end; 

     elif (( KEY == KEY_F2 ) or (KEY == KEY_ENTER))         //Проверки при вводе
         if ( dlg.rec.date > {curdate} )
                MsgBox("Дата не может быть больше даты текущего операционного дня");
                return CM_IGNORE;          
         end;
          
        reportdate  = dlg.rec.date;
        Kinddoc = dlg.rec.kinddoc;
        Contr   = dlg.rec.contr;
        Nocontr = dlg.rec.nocontr;
        Dep     = dprt;
        Kind = dlg.rec.kindotpr;
        pack = dlg.rec.numberpack;
        Race = dlg.rec.rejs;
        Opr = dlg.rec.oper;
        type = dlg.rec.kindotcheta;
        if ((reportdate < {curDate}))    
           Return CM_SAVE;
        elif(1)// (gettrue(true,"Дата равна текущему опрерационному дню. Продолжить?"))
           Return CM_SAVE;
        end;
     end;
   end;
        
END;
/*Точка входа в макрос*/
if (RunDialog(dlg, "Event"))                  
incontr = "";
inkind = "";
inpack = "";
indep = "";
inoper = "";
inrace = "";
inracetab = "";
incontrtab = "";
if (race)
/*inracetab = " dwlpm_dbt  wlpm, dwlmes_dbt mes, dwlsess_dbt sess, dwlmeslnk_dbt lnk, ";

inrace =    " and wlpm.t_paymentid = pmpaym.t_paymentid "+
    " and mes.t_sessionid = sess.t_sessionid "+ // Если нужен номер сеанса
    " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY')"+
    " AND lnk.t_objid = wlpm.t_wlpmid "+
    " AND mes.t_mesid = lnk.t_mesid "+
    " and sess.T_NUMBERRACE= "+race+ " ";            */
   if (kinddoc == "отправленные")    //Выгруженные
inrace =        " and sess.T_NUMBERRACE= "+race+ " ";
   else
inrace ="";
 end;
end;
debugbreak;
if (dep)
indep = "and pmpaym.t_department = "+dep;
end;

if (opr)
inoper = "AND pmpaym.t_oper = "+opr;
end;
if ((contr) and (nocontr))
incontr =   " AND (curst.T_NUMVALUE = 1 "+
          " OR curst.T_NUMVALUE = 2)   ";
//"   AND pmpaym.t_futurepayeraccount = pmpaym.t_futurereceiveraccount ";
elif (contr)
if (kinddoc == "не отправленны")
incontrtab = " doprstep_dbt step, ";
incontr =     " AND pmpaym.t_futurepayeraccount = pmpaym.t_futurereceiveraccount "+
              " AND step.t_id_operation = opr.t_id_operation "+
              " AND step.t_symbol = 'Ф' "+
              " AND step.t_blockid = 10000145 "+
              " AND step.t_isexecute = 'R' ";
else
incontr =   " AND curst.T_NUMVALUE = 2 ";
end;
elif (nocontr)
incontr =   " AND curst.T_NUMVALUE = 1 ";
else
incontr =   " AND curst.T_NUMVALUE = 99 "; //Если не задали не один из вариантов, то ставим то, что явно не будет
end;

if (kind == "электронно/не задан")
inkind =  "  AND ((rm.t_paymentkind = 'Э') or (rm.t_paymentkind = 'Н'))";
     if(kinddoc == "отправленные")
        inkind =  inkind + "   AND sess.t_tpid = 9 ";
     end;
if (kinddoc == "Все документы")
inkind =  "  AND ((rm.t_paymentkind = 'Э') or (rm.t_paymentkind = 'Н')) ";
end;
 elif (kind == "почтой")
inkind =  "  AND rm.t_paymentkind = 'П' ";
end;

if (pack)  //Здесь еще нужна доработка
inpack =  "     AND pmpaym.t_numberpack = "+pack;
end;
debugbreak;
 //    t_dockind = 201  Пока все закоментировал, нужны не только клиентские платежи
if (type == "документы")
   if (kinddoc == "отправленные")    //Выгруженные
   //Gurin S. N. 19.07.2012 I-00223356-3 Добавил Group By в запрос
   sql = " SELECT rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
         "   pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
         "   rm.t_ground, pmprop.T_TRANSFERDATE "+
         " FROM doproper_dbt opr, "+
         "   dpmprop_dbt pmprop, "+
         "   dpmpaym_dbt pmpaym, "+
          inracetab +
         "   doprstep_dbt step, "+
         "   dwlpm_dbt  wlpm, "+
         "   dwlmes_dbt mes,  "+
         "   dwlsess_dbt sess,  "+
         "   dwlmeslnk_dbt lnk,  "+
         "   dpmrmprop_dbt rm, "+
         "   dobjcode_dbt obj, "+
         "   doprcurst_dbt curst "+
         " WHERE pmprop.t_group = 1 "+
         "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
         "   AND curst.T_STATUSKINDID = 296 "+
         "   AND obj.t_codekind = 3 "+
         "   AND obj.t_objecttype = 3 "+
         "   AND pmpaym.t_dockind = opr.t_dockind "+
         "   AND obj.t_objectid = pmpaym.t_payerbankid "+
         "   AND pmprop.t_issender = CHR (0) "+
         "   AND pmpaym.t_fiid = 0 "+
         incontr + inkind + inpack + inrace + inoper + indep+
         "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
         "   AND pmpaym.t_paymentid = rm.t_paymentid "+
         "   AND step.t_id_operation = opr.t_id_operation "+
         "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
         "   AND step.t_symbol = 'Ф'                  "+
         "   AND step.t_blockid = 10000145 "+
         "   and wlpm.t_paymentid = pmpaym.t_paymentid "+
         "   and mes.t_sessionid = sess.t_sessionid "+
         "   and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
         "   and sess.t_direct = chr(0) "+
         "   AND lnk.t_objid = wlpm.t_wlpmid  "+
         "   AND mes.t_mesid = lnk.t_mesid "+
         "   AND step.t_isexecute = chr(88)"+
         " group by rm.t_number "+
         "  ,obj.t_code "+
         " ,pmpaym.t_payeraccount "+
         " ,pmpaym.t_receiveraccount "+
         " ,pmpaym.t_numberpack "+
         " ,pmpaym.t_amount "+
         " ,rm.t_ground " +
         " ,pmprop.t_transferdate ";
 
   elif (kinddoc == "не отправленны")   //Невыгруженные

   sql = " SELECT  rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
         "   pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
         "   rm.t_ground, pmprop.T_TRANSFERDATE  "+
         " FROM doproper_dbt opr, "+
         "   dpmprop_dbt pmprop, "+
         "   dpmpaym_dbt pmpaym, "+
          inracetab + incontrtab +
         "   dpmrmprop_dbt rm, "+
         "   dobjcode_dbt obj, "+
         "   doprcurst_dbt curst "+
         " WHERE pmprop.t_group = 1 "+
         "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
         "   AND curst.T_STATUSKINDID = 296 "+
         "   AND obj.t_codekind = 3 "+
         "   AND obj.t_objecttype = 3 "+
         "   AND obj.t_objectid = pmpaym.t_payerbankid "+
         "   AND pmprop.t_issender = CHR (0) "+
         "   AND pmpaym.t_fiid = 0 "+
         "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
         "   AND pmpaym.t_paymentid = rm.t_paymentid "+
         "   AND pmpaym.t_dockind = opr.t_dockind "+
        incontr + inkind + inpack + inoper + indep+
         "   and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
         "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
         "   AND pmpaym.t_paymentid not in ( "+
         "          SELECT pmpaym1.t_paymentid "+
         "            FROM doproper_dbt opr1, "+
         "                 dpmpaym_dbt pmpaym1, "+
         "                 doprstep_dbt step1, "+
         "                 dpmprop_dbt pmprop1 "+
         "           WHERE pmpaym1.t_fiid = 0 "+
         "             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
         "             AND pmprop1.t_group = 1 "+
         "             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
         "             AND step1.t_id_operation = opr1.t_id_operation "+
         "             AND pmpaym1.t_dockind = opr1.t_dockind "+
         "             AND opr1.t_documentid = LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
         "             AND step1.t_symbol = 'Ф' "+
         "             AND step1.t_isexecute = CHR (88) )";

   elif (kinddoc == "отпр. Payments")   //Payments
debugbreak;
   sql = " SELECT  rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
         "   pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
         "   rm.t_ground, pmprop.T_TRANSFERDATE  "+
         " FROM doproper_dbt opr, "+
         "   dpmprop_dbt pmprop, "+
         "   dpmpaym_dbt pmpaym, "+
          inracetab + incontrtab +
         "   dpmrmprop_dbt rm, "+
         "   dobjcode_dbt obj, "+
         "   doprcurst_dbt curst "+
         " WHERE pmprop.t_group = 1 "+
         "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
         "   AND curst.T_STATUSKINDID = 296 "+
         "   AND obj.t_codekind = 3 "+
         "   AND obj.t_objecttype = 3 "+
         "   AND obj.t_objectid = pmpaym.t_payerbankid "+
         "   AND pmprop.t_issender = CHR (0) "+
         "   AND pmpaym.t_fiid = 0 "+
         "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
         "   AND pmpaym.t_paymentid = rm.t_paymentid "+
         "   AND pmpaym.t_dockind = opr.t_dockind "+
        incontr + inkind + inpack + inoper + indep+
         "   and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
         "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
         "   AND pmpaym.t_paymentid  in ( "+
         "          SELECT pmpaym1.t_paymentid "+
         "            FROM doproper_dbt opr1, "+
         "                 dpmpaym_dbt pmpaym1, "+
         "                 doprstep_dbt step1, "+
         "                 dpmprop_dbt pmprop1 "+
         "           WHERE pmpaym1.t_fiid = 0 "+
         "             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
         "             AND pmprop1.t_group = 1 "+
         "             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
         "             AND step1.t_id_operation = opr1.t_id_operation "+
         "             AND pmpaym1.t_dockind = opr1.t_dockind "+
         "             AND opr1.t_documentid = LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
         "             AND step1.t_symbol = 'Ь' "+
         "             AND step1.t_isexecute = CHR (88) )";

   else               //Все
   sql = " SELECT rm.t_number, obj.t_code, pmpaym.t_payeraccount, "+
         "   pmpaym.t_receiveraccount, pmpaym.t_numberpack, pmpaym.t_amount, "+
         "   rm.t_ground, pmprop.T_TRANSFERDATE  "+
         " FROM doproper_dbt opr, "+
         "   dpmprop_dbt pmprop, "+
         "   dpmpaym_dbt pmpaym, "+
         inracetab +
         "   dpmrmprop_dbt rm, "+
         "   dobjcode_dbt obj, "+
         "   doprcurst_dbt curst, "+
         "   doprcurst_dbt curst1 "+
         " WHERE pmprop.t_group = 1 "+
         "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
         "   AND curst.T_STATUSKINDID = 296 "+
         "   AND obj.t_codekind = 3 "+
         "   AND obj.t_objecttype = 3 "+
         "   AND obj.t_objectid = pmpaym.t_payerbankid "+
         "   AND pmprop.t_issender = CHR (0) "+
         "   AND pmpaym.t_fiid = 0 "+
         "   AND pmpaym.t_dockind = opr.t_dockind "+
          incontr + inkind + inpack + inrace + inoper + indep+
         "   AND pmpaym.t_paymentid = rm.t_paymentid "+
         "   and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
         "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
         "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "
         "   AND curst1.t_id_operation = opr.t_id_operation "+
         "   AND curst1.T_STATUSKINDID = 292 "+
         "   AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) ";

   end; 


elif (type == "операционисты")  

   if (kinddoc == "отправленные") //Выгруженные
   sql = "SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
    " FROM doproper_dbt opr, "+
        " dpmprop_dbt pmprop, "+
        " dpmpaym_dbt pmpaym, "+
        inracetab +
        " doprstep_dbt step, "+
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
        " dpmrmprop_dbt rm, "+
        " dobjcode_dbt obj, "+
        " doprcurst_dbt curst          "+
  " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
    " AND obj.t_objecttype = 3 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
    " AND obj.t_objectid = pmpaym.t_payerbankid "+
    " AND pmprop.t_issender = CHR (0) "+
     incontr + inkind + inpack + inrace + inoper + indep+
    " AND pmpaym.t_fiid = 0 "+
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//    " AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND step.t_id_operation = opr.t_id_operation "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
              " AND step.t_blockid = 10000145 "+
    " AND step.t_symbol = 'Ф'      "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
     " and sess.t_direct = chr(0) "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid "+
    " AND step.t_isexecute = chr(88)   "+
//    " AND step.t_dockind = 201 "+
      "GROUP BY pmpaym.t_oper ";

   elif (kinddoc == "не отправленны")
   sql = "SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
        " dpmprop_dbt pmprop, "+
        " dpmpaym_dbt pmpaym, "+
        " dpmrmprop_dbt rm, "+
         inracetab + incontrtab +
        " dobjcode_dbt obj, "+
        " doprcurst_dbt curst          "+
  " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
    " AND obj.t_objecttype = 3 "+
    " AND obj.t_objectid = pmpaym.t_payerbankid "+
    " AND pmprop.t_issender = CHR (0) "+
    " AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
     incontr + inkind + inpack + inoper + indep+
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )"+
   " GROUP BY pmpaym.t_oper ";

   elif (kinddoc == "отпр. Payments")   //Payments
debugbreak;
   sql = " SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt  "+
         " FROM doproper_dbt opr, "+
         "   dpmprop_dbt pmprop, "+
         "   dpmpaym_dbt pmpaym, "+
          inracetab + incontrtab +
         "   dpmrmprop_dbt rm, "+
         "   dobjcode_dbt obj, "+
         "   doprcurst_dbt curst "+
         " WHERE pmprop.t_group = 1 "+
         "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
         "   AND curst.T_STATUSKINDID = 296 "+
         "   AND obj.t_codekind = 3 "+
         "   AND obj.t_objecttype = 3 "+
         "   AND obj.t_objectid = pmpaym.t_payerbankid "+
         "   AND pmprop.t_issender = CHR (0) "+
         "   AND pmpaym.t_fiid = 0 "+
         "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
         "   AND pmpaym.t_paymentid = rm.t_paymentid "+
         "   AND pmpaym.t_dockind = opr.t_dockind "+
        incontr + inkind + inpack + inoper + indep+
         "   and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
         "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
         "   AND pmpaym.t_paymentid  in ( "+
         "          SELECT pmpaym1.t_paymentid "+
         "            FROM doproper_dbt opr1, "+
         "                 dpmpaym_dbt pmpaym1, "+
         "                 doprstep_dbt step1, "+
         "                 dpmprop_dbt pmprop1 "+
         "           WHERE pmpaym1.t_fiid = 0 "+
         "             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
         "             AND pmprop1.t_group = 1 "+
         "             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
         "             AND step1.t_id_operation = opr1.t_id_operation "+
         "             AND pmpaym1.t_dockind = opr1.t_dockind "+
         "             AND opr1.t_documentid = LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
         "             AND step1.t_symbol = 'Ь' "+
         "             AND step1.t_isexecute = CHR (88) )" +
         " GROUP BY pmpaym.t_oper ";

   else                     //Все
   sql =" SELECT   pmpaym.t_oper, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
         inracetab +
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst,          "+
   "      doprcurst_dbt curst1          "+
  " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
//  " AND pmpaym.t_paymstatus>0 "+
    " AND obj.t_objecttype = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep+
    " AND obj.t_objectid = pmpaym.t_payerbankid "+
    " AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
    " AND pmpaym.t_fiid = 0 "+
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND curst1.t_id_operation = opr.t_id_operation "+
  " AND curst1.T_STATUSKINDID = 292 "+
  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) " +
   "GROUP BY pmpaym.t_oper ";

   end;

elif (type == "подразделения")

   if (kinddoc == "отправленные") //Выгруженные
   sql =" SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
         inracetab +
   "      doprstep_dbt step, "+
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
   "      dparty_dbt party, "+
   "      ddp_dep_dbt dep, "+
   "      doprcurst_dbt curst "+
   "WHERE pmprop.t_group = 1 "+
   "  AND party.t_partyid = dep.t_partyid "+ 
   "  AND dep.t_code = pmpaym.t_department "+ 
   "  AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
   "  AND curst.T_STATUSKINDID = 296 "+
     " and sess.t_direct = chr(0) "+
   "  AND obj.t_codekind = 3 "+
   "  AND obj.t_objecttype = 3 "+
   "  AND obj.t_objectid = pmpaym.t_payerbankid "+
   "  AND pmprop.t_issender = CHR (0) "+
     "   AND pmpaym.t_dockind = opr.t_dockind "+
   "  AND pmpaym.t_fiid = 0 "+
              " AND step.t_blockid = 10000145 "+
   "  AND pmpaym.t_paymentid = pmprop.t_paymentid "+
     incontr + inkind + inpack + inrace + inoper + indep+
   "  AND pmpaym.t_paymentid = rm.t_paymentid "+
//   "  AND pmpaym.t_dockind = 201 "+
//   "  AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid "+
   "  AND step.t_id_operation = opr.t_id_operation "+
   "  AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
   "  AND step.t_symbol = 'Ф'  "+
   "  AND step.t_isexecute = chr(88) "+
//   "  AND step.t_dockind = 201 "+
   "GROUP BY pmpaym.t_department, party.t_name ";

   elif (kinddoc == "не отправленны" ) //Невыгруженные

   sql = "SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
         inracetab + incontrtab +
   "      dparty_dbt party, "+
   "      ddp_dep_dbt dep, "+
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst "+
  " WHERE pmprop.t_group = 1 "+
   "  AND party.t_partyid = dep.t_partyid "+ 
   "  AND dep.t_code = pmpaym.t_department "+ 
   "  AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
   "  AND curst.T_STATUSKINDID = 296 "+
   "  AND obj.t_codekind = 3 "+
   "  AND obj.t_objecttype = 3 "+
   "  AND obj.t_objectid = pmpaym.t_payerbankid "+
   "  AND pmprop.t_issender = CHR (0) "+
   "  AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
     incontr + inkind + inpack + inoper + indep+
   "  AND pmpaym.t_paymentid = pmprop.t_paymentid "+
   "  AND pmpaym.t_paymentid = rm.t_paymentid "+
//   "  AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
   "  AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )"+
   "GROUP BY pmpaym.t_department, party.t_name      ";
   elif (kinddoc == "отпр. Payments")   //Payments
debugbreak;
   sql = " SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt  "+
         " FROM doproper_dbt opr, "+
         "   dpmprop_dbt pmprop, "+
         "   dpmpaym_dbt pmpaym, "+
          inracetab + incontrtab +
         "   dparty_dbt party, "+
         "   ddp_dep_dbt dep, "+
         "   dpmrmprop_dbt rm, "+
         "   dobjcode_dbt obj, "+
         "   doprcurst_dbt curst "+
         " WHERE pmprop.t_group = 1 "+
         "   AND party.t_partyid = dep.t_partyid "+ 
         "   AND dep.t_code = pmpaym.t_department "+ 
         "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
         "   AND curst.T_STATUSKINDID = 296 "+
         "   AND obj.t_codekind = 3 "+
         "   AND obj.t_objecttype = 3 "+
         "   AND obj.t_objectid = pmpaym.t_payerbankid "+
         "   AND pmprop.t_issender = CHR (0) "+
         "   AND pmpaym.t_fiid = 0 "+
         "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
         "   AND pmpaym.t_paymentid = rm.t_paymentid "+
         "   AND pmpaym.t_dockind = opr.t_dockind "+
        incontr + inkind + inpack + inoper + indep+
         "   and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
         "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
         "   AND pmpaym.t_paymentid  in ( "+
         "          SELECT pmpaym1.t_paymentid "+
         "            FROM doproper_dbt opr1, "+
         "                 dpmpaym_dbt pmpaym1, "+
         "                 doprstep_dbt step1, "+
         "                 dpmprop_dbt pmprop1 "+
         "           WHERE pmpaym1.t_fiid = 0 "+
         "             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
         "             AND pmprop1.t_group = 1 "+
         "             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
         "             AND step1.t_id_operation = opr1.t_id_operation "+
         "             AND pmpaym1.t_dockind = opr1.t_dockind "+
         "             AND opr1.t_documentid = LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
         "             AND step1.t_symbol = 'Ь' "+
         "             AND step1.t_isexecute = CHR (88) )" +
         " GROUP BY pmpaym.t_department, party.t_name      ";

   else   //Все
   sql = " SELECT   pmpaym.t_department, party.t_name, SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
         inracetab +
   "      dpmpaym_dbt pmpaym, "+
   "      dparty_dbt party, "+
   "      ddp_dep_dbt dep, "+
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst, "+
   "      doprcurst_dbt curst1 "+
  " WHERE pmprop.t_group = 1 "+
   "  AND party.t_partyid = dep.t_partyid "+ 
   "  AND dep.t_code = pmpaym.t_department "+ 
  "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
  "   AND curst.T_STATUSKINDID = 296 "+
//  " AND pmpaym.t_paymstatus>0 "+
  "   AND obj.t_codekind = 3 "+
  "   AND obj.t_objecttype = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep+
  "   AND obj.t_objectid = pmpaym.t_payerbankid "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
  "   AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_fiid = 0 "+
  "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  "   AND pmpaym.t_paymentid = rm.t_paymentid "+
//  "   AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
  "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND curst1.t_id_operation = opr.t_id_operation "+
  " AND curst1.T_STATUSKINDID = 292 "+
  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) "+
   " GROUP BY pmpaym.t_department, party.t_name";
   end;

else

   if (kinddoc == "отправленные")
         
   sql = "SELECT   SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt, "+
      "    decode(SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)),null,0,SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2))) AS reestr "+
    " FROM doproper_dbt opr, "+
    "     dpmprop_dbt pmprop, "+
    "     dpmpaym_dbt pmpaym, "+
    "     doprstep_dbt step, "+
    "     dpmrmprop_dbt rm, "+
         inracetab +
      " dwlpm_dbt  wlpm, "+
      " dwlmes_dbt mes,  "+
      " dwlsess_dbt sess,  "+
      " dwlmeslnk_dbt lnk,  "+
    "     dobjcode_dbt obj, "+
    "     doprcurst_dbt curst \n"+
  " WHERE pmprop.t_group = 1 "+
  "   AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
  "   AND curst.T_STATUSKINDID = 296 "+
  "   AND obj.t_codekind = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep+
  "   AND obj.t_objecttype = 3 "+
  "   AND obj.t_objectid = pmpaym.t_payerbankid    "+
  "   AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_fiid = 0 "+
    "   AND pmpaym.t_dockind = opr.t_dockind "+
   "   AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  "   AND pmpaym.t_paymentid = rm.t_paymentid \n"+
//  "   AND pmpaym.t_dockind = 201 "+
//  "   AND pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
       " and wlpm.t_paymentid = pmpaym.t_paymentid "+
              " AND step.t_blockid = 10000145 "+
      " and mes.t_sessionid = sess.t_sessionid "+
     " and sess.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY') "+
     " and sess.t_direct = chr(0) "+
      " AND lnk.t_objid = wlpm.t_wlpmid  "+
      " AND mes.t_mesid = lnk.t_mesid \n"+
  "   AND step.t_id_operation = opr.t_id_operation "+
  "   AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND step.t_symbol = 'Ф' "+
  "   AND step.t_isexecute = chr(88) "+
//  "   AND step.t_dockind = 201 "+
   " GROUP BY SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)) "+
    "order by reestr    ";

//println (sql);
   elif (kinddoc == "не отправленны") //Невыгруженные

   sql =" SELECT   SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt, "+
     "     decode(SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)),null,0,SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2))) AS reestr "+
   " FROM doproper_dbt opr, "+
   "      dpmprop_dbt pmprop, "+
   "      dpmpaym_dbt pmpaym, "+
          inracetab + incontrtab +
   "      dpmrmprop_dbt rm, "+
   "      dobjcode_dbt obj, "+
   "      doprcurst_dbt curst "+
   " WHERE pmprop.t_group = 1 "+
   "  AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
   "  AND curst.T_STATUSKINDID = 296 "+
   "  AND obj.t_codekind = 3 "+
   "  AND obj.t_objecttype = 3 "+
   "  AND obj.t_objectid = pmpaym.t_payerbankid    "+
   "  AND pmprop.t_issender = CHR (0) "+
   "  AND pmpaym.t_fiid = 0 "+
   "  AND pmpaym.t_paymentid = pmprop.t_paymentid "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
     incontr + inkind + inpack + inoper + indep+
   "  AND pmpaym.t_paymentid = rm.t_paymentid "+
//   "  AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
   "  AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+ 
     " AND pmpaym.t_paymentid not in ( "+
"          SELECT pmpaym1.t_paymentid "+
"            FROM doproper_dbt opr1, "+
"                 dpmpaym_dbt pmpaym1, "+
"                 doprstep_dbt step1, "+
"                 dpmprop_dbt pmprop1 "+
"           WHERE pmpaym1.t_fiid = 0 "+
"             AND pmprop1.t_paymentid = pmpaym1.t_paymentid "+
"             AND pmprop1.t_group = 1 "+
"             AND pmprop1.t_transferdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')  "+
"             AND step1.t_id_operation = opr1.t_id_operation "+
"             AND pmpaym1.t_dockind = opr1.t_dockind "+
"             AND opr1.t_documentid = "+
"                                 LPAD (TO_CHAR (pmpaym1.t_paymentid), 34, '0') "+
"             AND step1.t_symbol = 'Ф' "+
"             AND step1.t_isexecute = CHR (88) )"+
   " GROUP BY SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)) "+
    "order by reestr    ";

   else
   sql = "SELECT   SUM (pmpaym.t_amount) AS SUM, COUNT (1) AS cnt, "+
      "   decode(SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)),null,0,SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2))) AS reestr "+
    " FROM doproper_dbt opr, "+
    "     dpmprop_dbt pmprop, "+
    "     dpmpaym_dbt pmpaym, "+
         inracetab +
    "     dpmrmprop_dbt rm, "+
    "     dobjcode_dbt obj, "+
    "     doprcurst_dbt curst, "+
    "     doprcurst_dbt curst1 "+
   " WHERE pmprop.t_group = 1 "+
    " AND CURST.T_ID_OPERATION = opr.T_ID_OPERATION "+
//  " AND pmpaym.t_paymstatus>0 "+
    " AND curst.T_STATUSKINDID = 296 "+
    " AND obj.t_codekind = 3 "+
     incontr + inkind + inpack + inrace + inoper + indep+
    " AND obj.t_objecttype = 3 "+
    " AND obj.t_objectid = pmpaym.t_payerbankid    "+
    " AND pmprop.t_issender = CHR (0) "+
  "   AND pmpaym.t_dockind = opr.t_dockind "+
    " AND pmpaym.t_fiid = 0 "+
    " AND pmpaym.t_paymentid = pmprop.t_paymentid "+
    " AND pmpaym.t_paymentid = rm.t_paymentid "+
//    " AND pmpaym.t_dockind = 201 "+
//  " AND (rm.t_payerchargeoffdate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') or  pmpaym.t_valuedate = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY')) "+
     "  and pmprop.T_TRANSFERDATE = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
    " AND opr.t_documentid = LPAD (TO_CHAR (pmpaym.t_paymentid), 34, '0') "+
  "   AND curst1.t_id_operation = opr.t_id_operation "+
  " AND curst1.T_STATUSKINDID = 292 "+
  " AND curst1.T_NUMVALUE in (2, 4, 5, 9, 24) "+
   " GROUP BY SUBSTR (t_numberpack, 1, (LENGTH (t_numberpack) - 2)) "+
    "order by reestr    ";
   end;
end;
sum = 0;
cnt = 0;
if (type == "документы")
[                                       Ведомость выгруженных документов 
                                                   за ##########
┌─────────┬──────────┬─────────┬────────────────────┬────────────────────┬─────┬──────────────────┬─────────────────────────────────────────────┐
│ Номер   │   ДПП    │   БИК   │        Счет        │       Счет         │Номер│      Сумма       │                     Основание               │
│ докум.  │          │плательщ.│     плательщика    │     получателя     │пачки│                  │                                             │
├─────────┼──────────┼─────────┼────────────────────┼────────────────────┼─────┼──────────────────┼─────────────────────────────────────────────┤]
(date(reportdate));
elif (type == "операционисты")
[                    Отчет о внешних платежах по операционисту
                                    #############
┌───────────────┬─────────────────────┬────────────────────┬─────────────────────────────┐
│###############│#####################│####################│#############################│
├───────────────┼─────────────────────┼────────────────────┼─────────────────────────────┤]
(date(reportdate),"Операционист":c,"Сумма док-тов":c, "Кол-во док-тов":c, "Примечание":c);
elif (type == "подразделения")
[                   Отчет о внешних платежах Банка и клиентов
                                по подразделениям
                                      ##########
┌───────────────┬─────────────────────────────────────────┬────────────────────┬─────────────────────────────┐
│###############│#########################################│####################│#############################│
├───────────────┼─────────────────────────────────────────┼────────────────────┼─────────────────────────────┤]
(date(reportdate),"№ пачки":c,"Наименование подразделения":c, "Итого док-тов":c, "Итого сумма документов":c);
else
[                    Итоги документов по реестрам в разрезе подразделений 
                         за ##########
фильтр:  ###############
┌───────────────┬─────────────────────┬────────────────────┬─────────────────────────────┐
│###############│#####################│####################│#############################│
├───────────────┼─────────────────────┼────────────────────┼─────────────────────────────┤]
(date(reportdate),kinddoc, "Платежи":c,"Сумма док-тов":c, "Кол-во док-тов":c, "Примечание":c)
end;

outall();

if (type == "документы")
[├─────────┴──────────┴─────────┴────────────────────┴────────────────────┴─────┴──────────────────┴─────────────────────────────────────────────┤
 │    Итого документов  ######### на сумму  ######################                                                                               │]
(int(cnt), money(sum):f);

[└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘];
elif (type == "операционисты")
[│      Итого    │#####################│####################│                             │]
(money(sum):f,int(cnt));
[└───────────────┴─────────────────────┴────────────────────┴─────────────────────────────┘];
elif (type == "подразделения")
[│      Итого    │                                         │####################│#############################│]
(int(cnt):c,money(sum):f);
[└───────────────┴─────────────────────────────────────────┴────────────────────┴─────────────────────────────┘];
else
[├───────────────┼─────────────────────┼────────────────────┼─────────────────────────────┤
│               │#####################│####################│                             │
└───────────────┴─────────────────────┴────────────────────┴─────────────────────────────┘]
(money(sum):f,int(cnt));

end;

end;
END;

