/*************************************************************************/
/*Остатки и безналичные обороты по Клиентам без ссуд и овердрафтов********/
/*Володина В. C-31645 31.07.2014******************************************/
/* 13.02.2015 I-00551007-2 DPN Не попадало в отчет наименование последнего клиента*/
/*************************************************************************/
import globals, oralib, bankinter, likePy, lib_lang, rsexts;
import RSD,rcw, rslx, Календарь, rsbdataset;
private var SQL,cmd,ex,ob,obbook,obsheet, wdays, rest, n, i=5, sm, flagR, flagS, codep, dprt_v,  beg, en;
private var dt, kt;
const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;

record Department ("dp_dep.dbt");
private var Fulloutputl, outl, outputl="accrstR.lbr";
GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
private var dlg = TRecHandler("accrst", fulloutputl, TRUE); 
private var out, output = "accrstR.xls", fulloutput;
private var branch, DateBegin, DateEnd, Office:double  = 0, OfficeName = "По всем офисам";
private var maxS:integer, restbegin1,restend1,debit1,credit1,restbegin2,restend2,debit2,credit2,clientcode,Clientname,acc,div,podr;
//AAN
FILE rep_ac()txt write;
private var str : string, m_path, tempFileName, tempFileNameBezPuti;
private var all_local_puth:string;
private var dd:date, tt:time, ii:integer;
const TEXTDIR_REESTR = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
var format_str:string;

private macro Clear(str)        //AAN
   str = STRSUBST(STRSUBST(STRSUBST(str, ";", ","),strfor(13),""),strfor(10), "");
   // надо выкинуть символы 10 и 13 из строки, а также все ; т.к. это разделитель в .csv файлах
   return str;
END;

private macro chekReestrRead(m_name:string, m_status:integer, m_err:integer)  //AAN
	if ((m_status == V_UNDEF) or (m_err != 0))
    	msgbox("Ошибка получения значения настройки реестра " + m_name + " \n Процедура GetRegistryValue вернула код ошибки "+m_err);
   		exit(0);
	end;
end;

private macro dayString(m_reestrName:string):string  //AAN
   var m_errCode:integer = NULL;
   var m_statusGetRegistry :integer = NULL;
   var m_zna4enie:string  = NULL;
   if (m_reestrName == "")
      msgbox("При чтении реестра не задана строка реестра");
      exit(0)
   end;
   m_statusGetRegistry=GetRegistryValue(m_reestrName, V_STRING, m_zna4enie, m_errCode);
   chekReestrRead(m_reestrName, m_statusGetRegistry, m_errCode);
   return(m_zna4enie);
end;

private macro createUniqueFile()      //AAN генерим универсальное имя файла
	private var ff:string = "accrstR_"+{oper}+"_"+date+"_"+time;
	private var file_ext:string = ".txt";
	tempFileName = dayString(TEXTDIR_REESTR);
	tempFileName = tempFileName + "\\" + ff;
	tempFileNameBezPuti = ff;
	tempFileName = StrSubst ( tempFileName, ".", "_" );
	tempFileName = StrSubst ( tempFileName, ":", "_" );
	tempFileName = StrSubst ( tempFileName, " ", "_" );
	tempFileName = tempFileName + file_ext;
	tempFileNameBezPuti = StrSubst ( tempFileNameBezPuti, ".", "_" );
	tempFileNameBezPuti = StrSubst ( tempFileNameBezPuti, ":", "_" );
	tempFileNameBezPuti = StrSubst ( tempFileNameBezPuti, " ", "_" );
	tempFileNameBezPuti = tempFileNameBezPuti + file_ext;
	if (substr(tempFileName,1,2) == "__")
		tempFileName=".."+substr(tempFileName,3)
	end;
end;

private macro copyToMe()     //AAN  копируем файл временных данных с СП на терминал во временную папку(какую именно зависит от лок. настр.)
   private var m_path: string = "";
   m_path = "$" + tempFileNameBezPuti;
   if (not CopyFile(tempFileNameBezPuti, m_path, TRUE))
     println ("НЕ СМОГ скопировать файл с сервера приложений на терминал. исходный файл: "+tempFileNameBezPuti+" файл назначения: " + m_path);
   else 
      println ("УСПЕШНО скопирован файл с сервера приложений на терминал. исходный файл: "+tempFileNameBezPuti+" файл назначения: " + m_path);
      if (not removeFile(tempFileName))
         println("Не смог удалить файл "+tempFileName+" с сервера приложений. ничего сташного, продолжаем работу.");
      else
         println("удален файл "+tempFileName+" с сервера приложений.");
      end;
   end;
end;

private macro Title();  // AAN печатаем заголовок отчёта, и форматируем отчёт
   
   ex.Sheets(1).Rows("1:1").Insert(-4121);
   ex.Sheets(1).Rows("1:1").Insert(-4121);
   ex.Sheets(1).Rows("1:1").Insert(-4121);
   ex.Sheets(1).Rows("1:1").Insert(-4121);
   ex.Sheets(1).Rows("1:1").Insert(-4121);
   ex.Sheets(1).Cells(2,1).Value="Отчет по остаткам и безналичным оборотам по Клиентам без ссуд и овердрафтов с "+DateBegin+" по "+DateEnd;
   ex.Sheets(1).Cells(3,1).Value=officename;
   ex.Sheets(1).Cells(4,1).Value="Код клиента";
   ex.Sheets(1).Cells(4,2).Value="Код клиента";
   ex.Sheets(1).Cells(4,3).Value="Наименование клиента";

   ex.Sheets(1).Cells(4,4).Value="Расчетные счета 401-408";
   ex.Sheets(1).Cells(4,8).Value="Ссудные счета 441-454, 456";
   
    ex.Sheets(1).Cells(4,12).Value="Дивизион";
    ex.Sheets(1).Cells(4,13).Value="Подразделение";

   ex.Sheets(1).Cells(5,4).Value="Остаток на утро "+DateBegin;
   ex.Sheets(1).Cells(5,5).Value="Остаток на вечер "+DateEnd;
   ex.Sheets(1).Cells(5,6).Value="Дебетовый оборот за "+DateBegin +" "+DateEnd;
   ex.Sheets(1).Cells(5,7).Value="Кредитовый оборот оборот за "+DateBegin +" "+DateEnd;

   ex.Sheets(1).Cells(5,8).Value="Остаток на утро "+DateBegin;
   ex.Sheets(1).Cells(5,9).Value="Остаток на вечер "+DateEnd;
   ex.Sheets(1).Cells(5,10).Value="Дебетовый оборот за "+DateBegin +" "+DateEnd;
   ex.Sheets(1).Cells(5,11).Value="Кредитовый оборот оборот за "+DateBegin +" "+DateEnd;
   ex.Sheets(1).Rows("2:5").VerticalAlignment = 2;
   ex.Sheets(1).Rows("2:5").HorizontalAlignment = 3;
   ex.Sheets(1).Rows("4:5").interior.color = 7070700;
   ex.Sheets(1).Rows("4:5").NumberFormat = format_str;
   ex.Sheets(1).Rows("4:4").RowHeight=22;
   ex.Sheets(1).Rows("5:5").RowHeight=56;
   ex.Sheets(1).Rows("5:5").WrapText=True;
   
   ex.Sheets(1).Range("A2:E2").MergeCells=true;
   ex.Sheets(1).Range("A3:D3").MergeCells=true;
   ex.Sheets(1).Range("D4:G4").MergeCells=true;
   ex.Sheets(1).Range("H4:K4").MergeCells=true;
   
   ex.Sheets(1).Range("A4:M" + (5+i)).Borders.Weight=2;
   
END;
/*Найдем имя по Partyid*/
private macro GetClientName(id)
   var  sl=string(" select t_name from dparty_dbt t where t.t_PartyID=",id);
   var  DataS=TRsbDataSet(sl);
      if( DataS.moveNext())
         return DataS.name;
      else
         if (id !=0)
            msgbox("Субъект не найден в party.dbt");
            return 0;
         else
                     return {Name_Bank};
         end;
      end;
END;

private macro OutAll()
   var count=0, datec;
   /*Определяем общее количество счетов*/
   initprogress(-1, "Отбираются счета, ждите...", "Отбираются счета");
   var sl = "SELECT  count(*) as cnt from ((SELECT t_account "+
         "    FROM (SELECT * "+
         "      FROM daccount_dbt acc"+
         "     WHERE (acc.t_account BETWEEN '401%' AND '4089%' "+
         "        OR acc.t_account BETWEEN '44101%' AND '441099%' "+
         "        OR acc.t_account BETWEEN '44201%' AND '442099%' "+
         "        OR acc.t_account BETWEEN '44301%' AND '443099%' "+
         "        OR acc.t_account BETWEEN '44401%' AND '444099%' "+
         "        OR acc.t_account BETWEEN '44501%' AND '445099%' "+
         "        OR acc.t_account BETWEEN '44601%' AND '446099%' "+
         "        OR acc.t_account BETWEEN '44701%' AND '447099%' "+
         "        OR acc.t_account BETWEEN '44801%' AND '448099%' "+
         "        OR acc.t_account BETWEEN '44901%' AND '449099%' "+
         "        OR acc.t_account BETWEEN '45001%' AND '450099%' "+
         "        OR acc.t_account BETWEEN '45101%' AND '451099%' "+
         "        OR acc.t_account BETWEEN '45201%' AND '452099%' "+
         "        OR acc.t_account BETWEEN '45301%' AND '453099%' "+
         "        OR acc.t_account BETWEEN '45401%' AND '454099%' "+
         "        OR acc.t_account BETWEEN '45601%' AND '456099%')"+
         "  AND acc.t_chapter = 1 "+
                 branch+
         ") accs "+
         "   INNER JOIN "+
         "   (SELECT t.t_partyid "+
         "      FROM dpartyown_dbt t "+
         "     WHERE t.t_partykind = 1 "+
         "    MINUS "+
         "    SELECT t.t_partyid "+
         "      FROM dpartyown_dbt t "+
         "     WHERE t.t_partykind = 2 "+
         "    MINUS "+
         "    SELECT t.t_partyid "+
         "      FROM dpartyown_dbt t "+
         "     WHERE t.t_partykind = 29) client "+
         "   ON accs.t_client = client.t_partyid "+
         " WHERE (accs.t_close_date > TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') "+
         " OR accs.t_open_close =chr(0) ) AND accs.t_open_date <= TO_DATE ('"+dateend+"', 'DD-MM-YYYY'))) ";
        // debugbreak;
   var DataS = TRsbDataSet(sl);
   DataS.movenext();
   maxS=datas.cnt;
   
 
   sql= " SELECT distinct t_account, "+
        " t_nameaccount, "+
        " t_client, "+
        " t_partyid, "+
        " t_code, "+
        "   NVL (kt, 0) kt, "+
        "   NVL (dt, 0) dt, "+
        "   NVL (beg, 0) beg, "+
        "   NVL (en, 0) en, " +
        "   div, "+
        "   podr  "+
 " FROM  (  (SELECT acc.t_Account,  "   +
 "                  acc.t_nameaccount, "+
   "                acc.t_client, "+
    "               client.t_partyid, "+
    "               obj.t_code, "+
    "              ( select sum(AH1.T_SUM_NATCUR )  "+
   "                    from  dacctrn_dbt ah1   "+
   "                    where       AH1.T_ACCOUNTID_RECEIVER=ACC.T_ACCOUNTID   "+
   "                                and AH1.T_ACCOUNT_PAYER not like '202%'   "+                            
   "                                and AH1.T_DATE_CARRY between  TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') and TO_DATE ('"+dateend+"', 'DD-MM-YYYY') )   kt,      "+
   "                ( select sum(AH.T_SUM_NATCUR )  "+
   "                  from  dacctrn_dbt ah           "+
   "                  where       AH.T_ACCOUNTID_PAYER=ACC.T_ACCOUNTID     "+
   "                              and AH.T_ACCOUNT_RECEIVER not like '202%'   "+                           
   "                              and AH.T_DATE_CARRY between  TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') and TO_DATE ('"+dateend+"', 'DD-MM-YYYY') )   dt,   "+
   "                  rsb_account.resta (t_account,     "+
   "                          TO_DATE ('"+(datebegin-1)+"', 'DD-MM-YYYY'),      "+
   "                          1,           "+
   "                          NULL)  AS beg,  "+
   "                  rsb_account.resta (t_account,  "+
   "                          TO_DATE ('"+dateend+"', 'DD-MM-YYYY'),   "+
   "                          1,                      "+
   "                          NULL)   AS en ,        "+
   "                   DECODE (cl.T_SERVICEKIND,1001,'ДКБ',1002,'ДМСБ') div, "+
   "                   PD.T_NAME podr "+
   "         FROM   daccount_dbt acc,          "+       
   "                dobjcode_dbt obj,         "+
   "                dpartyown_dbt client ,     "+
   "                dclient_dbt cl,            "+
  "                 ddp_dep_dbt dp,           "+
  "                 dparty_dbt pd             "+
   "          WHERE    acc.t_account BETWEEN '401%' AND '4089%'     "+
    "             and ( ( select sum(AH1.T_SUM_NATCUR )  "+
   "                    from  dacctrn_dbt ah1   "+
   "                    where       AH1.T_ACCOUNTID_RECEIVER=ACC.T_ACCOUNTID   "+
   "                                and AH1.T_ACCOUNT_PAYER not like '202%'   "+                            
   "                                and AH1.T_DATE_CARRY between  TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') and TO_DATE ('"+dateend+"', 'DD-MM-YYYY') ) <>0      "+
   "                 or   ( select sum(AH.T_SUM_NATCUR )  "+
   "                  from  dacctrn_dbt ah           "+
   "                  where       AH.T_ACCOUNTID_PAYER=ACC.T_ACCOUNTID     "+
   "                              and AH.T_ACCOUNT_RECEIVER not like '202%'   "+                           
   "                              and AH.T_DATE_CARRY between  TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') and TO_DATE ('"+dateend+"', 'DD-MM-YYYY') ) <>0 )   "+        
  "                  AND acc.t_chapter = 1       "+  branch+  
  "                  AND obj.t_objecttype = 3     "+
  "                  AND obj.t_codekind = 1       "+
  "                  AND obj.t_state = 0         "+
  "                  AND obj.t_objectid = acc.t_client     "+
  "                  AND CL.T_PARTYID = ACC.T_CLIENT         "+
  "                  AND CL.T_SERVICEKIND IN (1001, 1002)   "+
  "                  AND cl.t_FINISHDATE =TO_DATE ('01.01.0001', 'dd.mm.yyyy') "+
  "                  AND DP.T_PARTYID = PD.T_PARTYID  "+
  "                  AND ACC.T_BRANCH = DP.T_CODE       "+
  "                  AND (acc.t_close_date >             "+
  "                          TO_DATE ('"+datebegin+"', 'DD-MM-YYYY')    "+
  "                       OR acc.t_open_close = CHR (0))           "+
  "                  AND acc.t_open_date <=                        "+
  "                        TO_DATE ('"+dateend+"', 'DD-MM-YYYY')       "+
  "                  AND client.t_partykind = 1                      "+
  "                  AND acc.t_client = client.t_partyid             "+
  "                  AND acc.t_client NOT IN                          "+
  "                           (SELECT   tt.t_partyid                  "+
  "                              FROM   dpartyown_dbt tt               "+
  "                             WHERE   (tt.t_partykind = 29           "+
  "                                      OR tt.t_partykind = 2)          "+
  "                                     AND tt.t_subkind = 0) )          "+
" UNION ALL              "+
" (SELECT   t_account,      "+
"          t_nameaccount,     "+
"          t_client,           "+
"          t_partyid,          "+
"          t_code,             "+
"          rsb_account.kredita (t_account,   "+
"                               1,                          "+
"                               TO_DATE ('"+datebegin+"', 'DD-MM-YYYY'),     "+
"                               TO_DATE ('"+dateend+"', 'DD-MM-YYYY'))     "+
"             AS kt,                                                    "+
"          rsb_account.debeta (t_account,                              "+
"                              1,                                        "+
"                             TO_DATE ('"+datebegin+"', 'DD-MM-YYYY'),     "+
"                             TO_DATE ('"+dateend+"', 'DD-MM-YYYY'))        "+
"             AS dt,                                                         "+
"          rsb_account.resta (t_account,                                      "+
"                             TO_DATE ('"+(datebegin-1)+"', 'DD-MM-YYYY'),            "+
"                             1,                                                "+
"                             NULL)                                             "+
"             AS beg,                                                           "+
"          rsb_account.resta (t_account,                                        "+
"                             TO_DATE ('"+dateend+"', 'DD-MM-YYYY'),            "+
"                             1,                                                "+
"                             NULL)                                             "+
"             AS en ,                                                            "+
"             div,                                                                "+
"             podr                                                              "+
"   FROM   (SELECT   acc.t_Account,                                             "+
"                    acc.t_nameaccount,                                         "+
"                    acc.t_client,                                              "+
"                    obj.t_code,                                                "+
"                    client.t_partyid,                                          "+
"                    acc.t_open_close,                                          "+
"                    acc.t_code_currency,                                       "+
"                    acc.t_close_date,                                          "+
"                    acc.t_open_date ,                                           "+
  "                   DECODE (cl.T_SERVICEKIND,1001,'ДКБ',1002,'ДМСБ') div, "+
   "                   PD.T_NAME podr "+
"             FROM   daccount_dbt acc, dobjcode_dbt obj, dpartyown_dbt client ,dclient_dbt cl, ddp_dep_dbt dp, dparty_dbt pd  "+
"            WHERE   (   acc.t_account LIKE '4410%'                             "+
"                     OR acc.t_account LIKE '4420%'                             "+
"                     OR acc.t_account LIKE '4430%'                             "+
"                     OR acc.t_account LIKE '4440%'                             "+
"                     OR acc.t_account LIKE '4450%'                             "+
"                     OR acc.t_account LIKE '4460%'                             "+
"                     OR acc.t_account LIKE '4470%'                             "+
"                     OR acc.t_account LIKE '4480%'                             "+
"                     OR acc.t_account LIKE '4490%'                             "+
"                     OR acc.t_account LIKE '4500%'                             "+
"                     OR acc.t_account LIKE '4510%'                             "+
"                     OR acc.t_account LIKE '4520%'                             "+
"                     OR acc.t_account LIKE '4530%'                             "+
"                     OR acc.t_account LIKE '4540%'                             "+
"                     OR acc.t_account LIKE '4560%')                            "+
"                    AND acc.t_chapter = 1                                      "+  branch+ 
"                    AND obj.t_objecttype = 3                                   "+
"                    AND obj.t_codekind = 1                                     "+
"                    AND obj.t_state = 0                                        "+
"                    AND ACC.T_BRANCH = DP.T_CODE                               "+
"                    AND DP.T_PARTYID = PD.T_PARTYID                            "+
"                    AND CL.T_PARTYID = ACC.T_CLIENT                            "+
"                    AND CL.T_SERVICEKIND IN (1001, 1002)                       "+
"                    AND cl.t_FINISHDATE = TO_DATE ('01.01.0001', 'dd.mm.yyyy') "+ 
"                    AND obj.t_objectid = acc.t_client                          "+
"                    AND (acc.t_close_date >                                    "+
"                            TO_DATE ('"+datebegin+"', 'DD-MM-YYYY')               "+
"                         OR acc.t_open_close = CHR (0))                        "+
"                    AND acc.t_open_date <=                                     "+
"                          TO_DATE ('"+dateend+"', 'DD-MM-YYYY')                 "+
"                    AND client.t_partykind = 1                                 "+
"                    AND acc.t_client = client.t_partyid                        "+
"                    AND acc.t_client NOT IN                                    "+
"                             (SELECT   tt.t_partyid                            "+
"                                FROM   dpartyown_dbt tt                        "+
"                               WHERE   (tt.t_partykind = 29                    "+
"                                        OR tt.t_partykind = 2)                 "+
"                                       AND tt.t_subkind = 0))                  "+
"  WHERE   rsb_account.resta (t_account,                                        "+
"                             TO_DATE ('"+(datebegin-1)+"', 'DD-MM-YYYY'),             "+
"                             1,                                                "+
"                             NULL) = 0                                         "+
"          AND rsb_account.resta (t_account,                                    "+
"                                 TO_DATE ('"+dateend+"', 'DD-MM-YYYY'),         "+
"                                 1,                                            "+
"                                 NULL) = 0)         )                           "+
" ORDER BY   t_code  " ;

   useprogress;
   debugbreak;
   var DataSet = TRsbDataSet(sql);
      
   createUniqueFile();
   open (rep_ac, tempFileName);
      
   i=0;
   initprogress(maxs, "Выводится отчет, ждите", "Выводится отчет");
   n=0;
      if (maxs!=0)
     dataset.movenext();
     clientcode = dataset.client;
     Clientname = dataset.nameaccount;
     acc = dataset.account;
     codep=dataset.code;
     dt = dataset.dt;
     kt = dataset.kt;
     beg = dataset.beg;
     en = dataset.en;
     div=dataset.div;
     podr=dataset.podr;
     n=1;
   end;
   restbegin1=0;
   restend1=0;
   debit1=0;
   credit1=0;
   restbegin2=0;
   restend2=0;
   debit2=0;
   credit2=0;
   FlagR=0;
   flagS=0;
   while (dataset.movenext())
      n=n+1;
   /*Заполняем таблицу*/
      if (comparestrwithmasks("401-408",acc)==0)
   
         restbegin1=restbegin1+beg;
         restend1=restend1+en;
         debit1=debit1+dt;
         credit1=credit1+kt;
         flagR=1;
      else
 
         restbegin2=restbegin2+beg;
         restend2=restend2+en;
         debit2=debit2+dt;
         credit2=credit2+kt;
         FlagS=1;
      end;
    
      if (clientcode!=dataset.client)
         i=i+1;
         str = Clear(String(codep))+";"
              +Clear( String(substr(codep,6)))+";"
              +Clear( String(GetClientName(clientcode)))+";" ;
         if (flagr==1)
            str = str +Clear(String(restbegin1))+";"
                      +Clear(String(restend1))+";"
                      +Clear(String(debit1))+";" 
                      +Clear(String(credit1))+";"  ;                    
         else
            str = str + " - ; - ; - ; - ;"
         end;
         
         if (flags==1)
            str = str +Clear(String(restbegin2))+";"
                      +Clear(String(restend2))+";"
                      +Clear(String(debit2))+";"
                      +Clear(String(credit2))+";";
         else
            str = str + " - ; - ; - ; - ;"
         end;
           str=str    +Clear( String(div))+";"
                      +Clear( String(podr))+";";

         rep_ac.str = ToAnsi (str, true);
         insert (rep_ac);
         restbegin1=0;
         restend1=0;
         debit1=0;
         credit1=0;
         restbegin2=0;
         restend2=0;
         debit2=0;
         credit2=0;
         flags=0;
         flagr=0;
      end;
      useprogress (n);
      clientcode = dataset.client;
      Clientname = dataset.nameaccount;
      acc = dataset.account;
      codep = dataset.code;
      dt = dataset.dt;
      kt = dataset.kt;
      beg = dataset.beg;
      en = dataset.en;
      div=dataset.div;
      podr=dataset.podr;
   end;
   if (comparestrwithmasks("401-408",acc)==0)
   /*      restbegin1=restbegin1+restA(acc,(datebegin-1));
      restend1=restend1+restA(acc,dateend);
      debit1=debit1+debetA(acc, datebegin, dateend);
      credit1=credit1+kreditA(acc, datebegin, dateend);*/
      restbegin1=restbegin1+beg;
      restend1=restend1+en;
      debit1=debit1+dt;
      credit1=credit1+kt;
      flagR=1;
   else
   /*    restbegin2=restbegin2+restA(acc,(datebegin-1));
      restend2=restend2+restA(acc,dateend);
      debit2=debit2+debetA(acc, datebegin, dateend);
      credit2=credit2+kreditA(acc, datebegin, dateend);*/
      restbegin2=restbegin2+beg;
      restend2=restend2+en;
      debit2=debit2+dt;
      credit2=credit2+kt;
      FlagS=1;
   end;
   i=i+1;
   str = Clear(String(codep))+";"
        +Clear( String(substr(codep,6)))+";"
        +Clear( String(GetClientName(clientcode)))+";" ;  // 13.02.2015 I-00551007-2 DPN Стояла лишнияя";" 
   if (flagr==1)
      str = str +Clear(String(restbegin1))+";"
                +Clear(String(restend1))+";"
                +Clear(String(debit1))+";"
                +Clear(String(credit1))+";"   ;
              
   else
      str = str + " - ; - ; - ; - ;"
   end;
 
   if (flags==1)
      str = str +Clear(String(restbegin2))+";"
                +Clear(String(restend2))+";"
                +Clear(String(debit2))+";"
                +Clear(String(credit2))+";";
   else
      str = str + " - ; - ; - ; - ;"
   end;
  str=str    +Clear( String(div))+";"
             +Clear( String(podr))+";";

   rep_ac.str = ToAnsi (str, true);
   insert (rep_ac);
   close(rep_ac);
   copyToMe();
   
   ob = CreateObject ("rsax","TRsAxServer","RsAxServer",false);
   ex = ob.CreateComObject ("Excel.Application");
   if (not(GetFileInfo("$"+tempFileNameBezPuti,@dd,@tt,@ii,@all_local_puth))); //all_local_puth- то что надо. полный путь абсолютный локальный
      msgbox("не могу найти на локальном диске файл "+tempFileNameBezPuti+"          \n останавливаюсь");
    exit(0);
  end;
debugbreak;
  all_local_puth = SUBSTR(all_local_puth, 2);
  
   private var aw=tarray;
   private var w1=tarray;
   private var w2=tarray;
   private var w3=tarray;
   private var w4=tarray;
   private var w5=tarray;
   private var w6=tarray;
   private var w7=tarray;
   private var w8=tarray;
   private var w9=tarray;
   private var w10=tarray;
   private var w11=tarray;
 private var w12=tarray;
 private var w13=tarray;


   w1(0)=1; w1(1)=2; //формат столбца - текст
   w2(0)=2; w2(1)=1; //формат столбца - General
   w3(0)=3; w3(1)=1;//формат столбца - General
   w4(0)=4; w4(1)=1;//формат столбца - General
   w5(0)=5; w5(1)=1;//формат столбца - General
   w6(0)=6; w6(1)=1;//формат столбца - General
   w7(0)=7; w7(1)=1;//формат столбца - General
   w8(0)=8; w8(1)=1;//формат столбца - текст
   w9(0)=9; w9(1)=1;//формат столбца - текст
   w10(0)=10; w10(1)=1;//формат столбца - текст
   w11(0)=11; w11(1)=1;//формат столбца - текст
   w12(0)=12; w12(1)=1;//формат столбца - текст
   w13(0)=13; w13(1)=1;//формат столбца - текст


   
   aw(0)=w1;
   aw(1)=w2;
   aw(2)=w3;
   aw(3)=w4;
   aw(4)=w5;
   aw(5)=w6;
   aw(6)=w7;
   aw(7)=w8;
   aw(8)=w9;
   aw(9)=w10;
   aw(10)=w11;
   aw(11)=w12;
   aw(12)=w13;

	aw.MarshalByVal =true; // работает только так. передача по значению через @aw вызывает ошибку
	w1.MarshalByVal =true;
	w2.MarshalByVal =true;
	w3.MarshalByVal =true;
	w4.MarshalByVal =true;
	w5.MarshalByVal =true;
	w6.MarshalByVal =true;
	w7.MarshalByVal =true;
	w8.MarshalByVal =true;
    w9.MarshalByVal =true;
    w10.MarshalByVal =true;
    w11.MarshalByVal =true;
 w12.MarshalByVal =true;
 w13.MarshalByVal =true;


   
   ex.Workbooks.opentext(all_local_puth,1251,1,1,-4142,false,false,true,false,false,false,";",aw,1,"."," ",true,true);
   ex.Sheets(1).Range("A:A").ColumnWidth=12;
   ex.Sheets(1).Range("B:B").ColumnWidth=12;
   ex.Sheets(1).Range("C:C").ColumnWidth=50;
   ex.Sheets(1).Range("D:D").ColumnWidth=14;
   ex.Sheets(1).Range("E:E").ColumnWidth=14;
   ex.Sheets(1).Range("F:F").ColumnWidth=14;
   ex.Sheets(1).Range("G:G").ColumnWidth=14;
   ex.Sheets(1).Range("H:H").ColumnWidth=14;
   ex.Sheets(1).Range("I:I").ColumnWidth=14;
   ex.Sheets(1).Range("J:J").ColumnWidth=14;
   ex.Sheets(1).Range("K:K").ColumnWidth=14;
   ex.Sheets(1).Range("L:L").ColumnWidth=8;
   ex.Sheets(1).Range("M:M").ColumnWidth=25;
   format_str = "# ##0" + ex.International(3) + "00";
   ex.Sheets(1).Range("D:K").NumberFormat = format_str;
   Title();
   ex.Visible = true;
   
   remprogress(n);
   /*Раскрашиваем итоговую таблицу и шапку*/
   //obSheet.Range("A4:K"+(5+i)).Borders.Weight=2;
   //obSheet.Range("A4:K"+5).interior.color=4035000;
   //Ex.visible = true;
END; //OutAll()

 /*Обработчик диалоговой панели ввода исходных данных для печати*/
MACRO Event (dlg, cmd, id, key) 
   var const_mess = "~F2~ Продолжить ~SPACE~ По всем офисам ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";
   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dprt_v = 0;
      dlg.rec.dprt_code  ="";
      dlg.rec.dprt_name = officename;
      dlg.rec.Datebegin = {curDate};
      dlg.rec.DateEnd = {curDate};
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
      if (FldName(dlg,id)=="dprt_code") 
         message(" ~F3~ Список подразделений "+const_mess);
      elif (FldName(dlg,id)=="Datebegin")
         message(" ~F3~ Выбор даты из календаря "+const_mess2);
      elif (FldName(dlg,id)=="DateEnd")
         message(" ~F3~ Выбор даты из календаря "+const_mess2);
      end;
   end;
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
      if (FldName(dlg,id) == "Datebegin")
         if ( dlg.rec.DateBegin > {curdate} )
            MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
            return CM_CANCEL;
         elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
            MsgBox("Дата начала периода не может быть больше даты окончания периода");
            return CM_CANCEL;
         end;
      end;
      if (FldName(dlg,id) == "DateEnd")
         if ( dlg.rec.DateEnd > {curdate} )
            MsgBox("Дата не может быть больше даты текущего операционного дня");
            return CM_CANCEL;
         elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
            MsgBox("Дата окончания периода не может быть меньше даты начала периода");
            return CM_CANCEL;
         end;
      end;
      UpdateFields(dlg); 
   end;
   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
      if (KEY == KEY_ESC)
         return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
      elif ( KEY == KEY_F3)
      /*Выбор подразделения банка из списка подразделений */
      if (FldName(dlg,id) == "dprt_code")
        if (ListDepartment (Department))
           dprt_v = department.code; 
           dlg.rec.dprt_code = Department.name;
           dlg.rec.dprt_name = GetClientName(Department.PartyID);
           message(" ~F3~ Список подразделений "+const_mess);
           UpdateFields(dlg);
        end;
      end;
      /*Выбор даты из календаря*/
      if (FldName(dlg,id) == "Datebegin")
         dlg.rec.datebegin = GetDateByCalendar ({curDate});
      end;
      if (FldName(dlg,id) == "DateEnd")
         dlg.rec.dateend = GetDateByCalendar ({curDate});
      end;
      elif (KEY == KEY_SPACE)
      /*Сброс установок в поле офис банка*/
         if (dlg.rec.dprt_code != 0 ) 
            dlg.rec.dprt_code="";
            dprt_v = 0;
            dlg.rec.dprt_name = "По всем офисам";
            UpdateFields(dlg);
         end;
         if (dlg.rec.dprt_code == "По всем офисам") 
            message(" ~F3~ Список подразделений "+const_mess);
            UpdateFields(dlg);
         end;
      elif (( KEY == KEY_F2 ) or (KEY == KEY_ENTER))         //Проверки при вводе
         if ( dlg.rec.DateBegin > {curdate} )
            MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
            return CM_IGNORE;
         elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
            MsgBox("Дата начала периода не может быть больше даты окончания периода");
            return CM_IGNORE;
         end;
         if ( dlg.rec.DateEnd > {curdate} )
            MsgBox("Дата не может быть больше даты текущего операционного дня");
            return CM_IGNORE;
         elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
            MsgBox("Дата окончания периода не может быть меньше даты начала периода");
            return CM_IGNORE;
         end;
         if ((strlen(dlg.rec.dprt_code) != "") and (dlg.rec.dprt_name != "По всем офисам"))
            if (department.nodetype == 2)                   
               branch = "and acc.t_branch="+dprt_v;
               officename=dlg.rec.dprt_name;
            else
               branch = "and acc.t_department="+dprt_v;
               officename=dlg.rec.dprt_name;
            end;
         else 
            branch = "and acc.t_department=1";
            officename=dlg.rec.dprt_name;
         end;
         Datebegin  = dlg.rec.Datebegin;
         Dateend = dlg.rec.DateEnd;
         if ((Datebegin < {curDate}))    
            Return CM_SAVE;
         elif (gettrue(true,"Дата равна текущему опрерационному дню. Продолжить?"))
            Return CM_SAVE;
         end;
      else
         Return CM_IGNORE;
      end;
   end;
END;

/*Точка входа в макрос*/
if (RunDialog(dlg, "Event"))
  OutAll;
end;

//end;