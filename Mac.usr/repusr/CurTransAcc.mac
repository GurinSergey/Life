/************************************************************************/
/*          Автоматизированная банковская система RS-Bank v6.0          */
/*                                                                      */
/*               Copyright (c) R-Style Ukraine                          */
/*                                                                      */
/*  Имя файла        : CurTransAcc.mac                                  */
/*                                                                      */
/*  Описание         : Макрос печати Уведомления о зачислении           */
/*                     иностранной валюты  на транзитный валютный счет  */
/*                     резидента (Извещение ВТК)                        */
/*                                                                      */
/*  Программист      : Новиков С. С.                                    */
/*                                                                      */
/*  Создан           : 08.08.2008                                       */
/*                                                                      */
/*  Модифицирован1   : 11.08.2008                                       */
/*                                                                      */
/*  Модифицирован2   : 12.08.2008                                       */
/*                                                                      */
/************************************************************************/



import globals, oralib, bankinter, "KeyCodes.mac", repforms, likePy, Календарь,lib_lang, PTInter;
import rcw,RSD;

record Department ("dp_dep.dbt");

var path = "",
    pathfile = "",
    filen = "RSU.lbr";

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,path);
pathfile = FindPath(filen,path);
	if (not pathfile)
		msgbox("Не найдена LBR");
		exit();
	end;

var dlg = TRecHandler("tracc",pathfile,True);


var Office:double  = 0,
    OfficeName = "По всем офисам",
    Date_report,
    rselect = "";

record superior(ptoffice);
record officet(ptoffice);

var PartyID:integer;
/*Макрос Шаблона отчета*/
private macro PrintHead(Doc_date,Account_num,Client_Name,Value,Currency_str,Value_str,Reply_date,No, BankName)
  
  //var myreport = "..//TXTFILE//UserRepnotice.txt"; 
  //file report("..//TXTFILE//UserRepnotice.txt") txt;

  /*Спец. переменные                   < Bank_Name >< Client_Name>
    заполняются отобранными значениями < No >< Date_report > < Value > 
                                       < Value_str > < Currency_str > 
                                       < Account_num > < Doc_date >< Reply_date >
  */
  /*Начало записи отчета в файл*/
  //SetOutput (myreport);
   
  /*Печать наименования банка */
  if (OfficeName == "По всем офисам")
    /*Наименования всех банков*/
    println("Банк     "+BankName);                                                          
  else
    /*Печать наименование конкретного одного банка*/
    println("Банк     "+OfficeName);                                                          
  end;

  println;
  println("Клиент   "+Client_Name);                                                           
  println;
  println;
  println;                                                                              
  println("                            УВЕДОМЛЕНИЕ № "+No+ " от "+Date_report);                                                                 
                               
  println("\n");
  print("В пользу Вашего предприятия поступили средства в сумме "+String(Value:a)+" "+Currency_str);

  println("("+Value_str+"),"); 
  println;
  println("которые зачислены на Ваш транзитный валютный  счет "+ Account_num+" "+Doc_date+ " г."); 
  println;
  println("Просим  в  срок до "+Reply_date+" г. представить в банк Распоряжение по транзитному валютному счету и справку,"); 
  println;
  println("идентифицирующую поступившие средства.");      

  println("\n");
  println("Ответственный  исполнитель   _____________________  (подпись)");
  println;
  println("уполномоченного  банка");    
  [




































  ]; 
  /*Конец записи отчета в файл*/
  //SetOutput(NULL,true);
  /*Отображения отчета с файла*/
  //Viewfile(report);
  //(OfficeName,Client_Name,string(No:z),Date_report, Value:l,Currency_str,Value_str,Account_num,Doc_date,Reply_date);
END;

/*Макрос формирования отчета  отобранными данными из БД*/
Macro PrintAll();
  
  /*Переменные для выборки данных*/
  var rs1:object = NULL;
  var rs2:object = NULL;
  var branch:object = NULL;
  var select = "";
  var numstr = "";
  var val:bool;
  var val1:bool;

  /*Сумма операции зачисления средств прописью +наименование валюты + наименование 1/100 валюты в род.падеже*/ 
  var CURtext:string = "";
  var rub,kop:string;       

  /*Порядковый номер уведомления*/
  var Num:integer = 0;
  //var NumStr:string ="";
  
  /*Флаги для обработки ошибок и корретных данных*/
  var FlagError:bool = false;
  var flag:bool = false;
 
  var myreport = "..//TXTFILE//UserRepNotice.txt"; 
  
  /*Файл для хранения и отображения отчета*/
  file report("..//TXTFILE//UserRepNotice.txt") txt;
  
  /*Счетчик индикатора состояния*/
  var i:integer = 0;
  var ii:integer = 0;
 
  /*Файл для чтения порядкового номера уведомления*/
  file report1("..//TXTFILE//Numrep.txt") txt;
  /*Файл для записи порядкового номера уведомления*/
  file report2("..//TXTFILE//Numrep.txt") txt write; 

 /*Чтение порядкового номера уведомления с файла*/    
  if (open(report1));
    while (Next(report1))
      if (Date_report == date(1,1))
        Num = 1;
      else  
        Num = Int(report1.str);
      end; 
    end;
  else
  /* SetOutput (myreport);
    [1];
    SetOutput(NULL,true);
  */ 
  Num = 1;
  end;
  close(report1);
   
   /*Чтение порядкового номера уведомления с реестра*/    
  if (ValType(GetRegistryValue("REPORT\\ПОЛЬЗОВАТЕЛЬСКИЕ\\NUM", 2, NumStr)) == V_UNDEF);
    SetRegistryValue ("REPORT\\ПОЛЬЗОВАТЕЛЬСКИЕ\\NUM", "1");  
  else
    GetRegistryValue("REPORT\\ПОЛЬЗОВАТЕЛЬСКИЕ\\NUM", 2, NumStr);
    /*Если Истина - обнуление порядкового номера уведомление в начале текущего года,
    иначе порядковый номер берется из реестра*/
    if (Date_report == date(1,1))
      Num = 1;
    else  
      Num = Int(NumStr);
    end;
  end; 
   
  InitProgress(-1, " ~CtrlBreak~ Прекратить", "Идет обработка данных, ждите... ");
  SetOutput (myreport);
  /*Выборка данных по конкретному подразделению*/
  if ((office != 0) and (valtype(office) != V_UNDEF))
      select = "select t.t_paymentid, t.t_payeraccount, t.t_receiveraccount, t.t_valuedate, t.t_payerbankenterdate, t.t_amount,t.t_fiid "+
               "from dpmpaym_dbt t inner join " +
               "     daccount$_dbt v on (t.t_receiveraccount = v.t_account) and (v.t_branch = '"+office+"' )"+
               "where (t.t_payeraccount not between '441%' and '453%') "+
               "and (t.t_receiveraccount between '401%' and '409%')"+ 
               "and (t.t_receiveraccount like '__________1%')" +
               "and ( t.t_receiveraccount not like '40819%' ) " +
               "and (t.t_dockind between 320 and 322 )" /*Вид первичного документа Платеж МБР */ 
               "and (t.t_payerbankenterdate = '"+string(Date_report)+"')";            
       if (OperSelect != "")
          select = select +
                    "   AND t.t_oper like '"+OperSelect+ "'\n";
       end;
          select = select +      
                    " order by t.t_amount" ;
  
     rs1 = ExecSQLSelect(select);
     val1 = rs1.movenext();
     if (not (val1)) 
         FlagError = true;
     else
       while (val1)
         flag = true;
         FlagError = false;
         if ((valtype(rs1.value("t_paymentid")) != 26) and (valtype(rs1.value("t_payeraccount")) != 26) and
           (valtype(rs1.value("t_receiveraccount")) != 26) and (valtype(date(rs1.value("t_valuedate"))) != 26) and
           (valtype(rs1.value("t_amount")) != 26) and (valtype(rs1.value("t_fiid")) != 26)) 
           /*Выборка идентификатора платежа, наименования получателя*/
           select = "select t.t_paymentid, t.t_receivername "
                    +"from dpmrmprop_dbt t " 
                    +"where (t.t_paymentid = '"+rs1.value("t_paymentid")+"') "
                    +"order by t.t_receivername";
           rs2 = ExecSQLSelect(select);
           while (rs2.movenext())
             if ((valtype(rs2.value("t_receivername")) != 26))
               /*Сумма прописью +наименование валюты + наименование 1/100 валюты в род.падеже*/
               CURtext    = CurToStrAlt(rs1.value("t_amount"), rub, kop, GetIsoByID(rs1.value("t_fiid"), false));           
               /*Вызов процедуры формирования отчета*/
               printhead(date(rs1.value("t_valuedate")),rs1.value("t_receiveraccount"),rs2.value("t_receivername"),
                        rs1.value("t_amount"), SubStr(CURtext, StrLen(rub)+1, Index(CURtext,kop)-Strlen(rub)-1), 
                        CURtext, DateAfterWorkDays(date(rs1.value("t_valuedate")),7), Num);
             end;
             /*Увеличение порядкового номера уведомления*/
             Num = Num + 1;
           end; 
         else
           MsgBox("Нет данных для отчета");
           FlagError = true;
         end;
         val1 = rs1.movenext();
       end;
     end;
  /*Выборка данных по всем подразделениям*/
  elif ((office == 0) and (valtype(office) != V_UNDEF))
    /*Выборка идентификатора платежа, счета плательщика, счета получателя, даты платежа, суммы, идентификатора валюты*/
    select = "select t.t_paymentid, t.t_payeraccount, t.t_receiveraccount, t.t_valuedate, t.t_amount, t.t_fiid "
             +"from dpmpaym_dbt t " 
             +"where (t.t_payeraccount not between '441%' and '453%') "
             +"and (t.t_receiveraccount between '401%' and '409%') "
             +"and (t.t_receiveraccount like '_____________1%')"
             +"and ( t.t_receiveraccount not like '40819%' ) "
             +"and (t.t_dockind between 320 and 322) "
             +"and (t.t_payerbankenterdate = '"+string(Date_report)+ "')"; 
       if (OperSelect != "")
          select = select +
                    "   AND t.t_oper like '"+OperSelect+ "'\n";
       end;
          select = select +       
                    "order by t.t_amount " ;
    rs1 = ExecSQLSelect(select);
    val1 = rs1.movenext();
    if (not (val1)) 
      FlagError = true;
    else
      while (val1)
        UseProgress(ii = ii + 1);
        if ((valtype(rs1.value("t_paymentid")) != 26) and (valtype(rs1.value("t_payeraccount")) != 26) and
           (valtype(rs1.value("t_receiveraccount")) != 26) and (valtype(date(rs1.value("t_valuedate"))) != 26) and
           (valtype(rs1.value("t_amount")) != 26) and (valtype(rs1.value("t_fiid")) != 26)) 
          /*Выборка идентификатора платежа, наименования получателя*/
          select = "select t.t_paymentid, t.t_receivername, t.t_receiverbankname "
                   +"from dpmrmprop_dbt t " 
                   +"where (t.t_paymentid = '"+rs1.value("t_paymentid")+"') "
                   +"order by t.t_receivername";
          rs2 = ExecSQLSelect(select);
          while (rs2.movenext())
            flag = true;
            FlagError = false;
            if ((valtype(rs2.value("t_receivername")) != 26))
               /*Сумма прописью +наименование валюты + наименование 1/100 валюты в род.падеже*/
               CURtext    = CurToStrAlt(rs1.value("t_amount"), rub, kop, GetIsoByID(rs1.value("t_fiid"), false));           
               /*Вызов процедуры формирования отчета*/
               printhead(date(rs1.value("t_valuedate")),rs1.value("t_receiveraccount"),rs2.value("t_receivername"),
                        rs1.value("t_amount"),SubStr(CURtext, StrLen(rub)+1, Index(CURtext,kop)-Strlen(rub)-1), 
                        CURtext, DateAfterWorkDays(date(rs1.value("t_valuedate")),7), Num, rs2.value("t_receiverbankname"));
            else
              //PrintLn("Нет данных для отчета");
              FlagError = true;
            end;
            /*Увеличение порядкового номера уведомления*/
            Num = Num+1;
          end; 
        else
          //PrintLn("Нет данных для отчета");
          FlagError = true;
        end;
        val1 = rs1.movenext();
      end;
    end;
  else
    FlagError = true;
    //MsgBox("Нет данных для отчета");
  end;
  RemProgress();
  
  
  /*Запись порядкового номера уведомления в реестр*/
  SetDprtRegistryValue("REPORT\\ПОЛЬЗОВАТЕЛЬСКИЕ\\NUM", String(Num));  

  /*Обработка ошибок при поиске данных в базе данных*/
  if ( FlagError)
    MsgBox("Нет данных для формирования отчета.");
    //flag = false;
    return CM_CANCEL;
  end;
  
  /*Отображение файла отчета если необходимые данные в базе данных есть в наличие*/
  if (flag)
    SetOutput(NULL,true);
    Viewfile(report);
  end;              

  /* Запись порядкового намера уведомления в файл */
  report2.str = Num;
  update (report2);
  close(report2);
  
  OnError(Err)
     MsgBox(Err.Message,"| at ",Err.Line,"|in ",Err.Module);
 
 END;

/*Обработчик диалоговой панели ввода исходных данных для печати*/
MACRO Event (dlg, cmd, id, key) 

   var const_message1 = "~F2~ Продолжить ~SPACE~ По всем офисам ~ESC~ Выход ";
   var const_message2 = "~F2~ Продолжить ~ESC~ Выход ";
   var OrgDate:date = {curdate} + 1;
   var NoChangeDate:bool = false;

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      PartyID = {OurBank};
      dlg.rec.Office  = OfficeName;
      dlg.rec.Date = {curDate};
      dlg.rec.oper   = "";
      dlg.rec.opername = "все операционисты";
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     officeN = dlg.rec.numoffice;
     if (FldName(dlg,id)=="Office") 
       message(" ~F3~ Список подразделений "+const_message2);
     elif (FldName(dlg,id)=="Date")
       message(" ~F3~ Выбор даты из календаря "+const_message2);
     end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности даты отчета*/
     if (FldName(dlg,id) == "Date")
       if ( dlg.rec.Date > {curdate} )
         MsgBox("Дата отчета больше даты текущего операционного дня"); 
         return CM_CANCEL;
       end;
     elif (FldName(dlg,id) == "numoffice")
         if (dlg.rec.numoffice != officeN)
             dlg.rec.oper   = "";
             dlg.rec.opername = "все операционисты";
         end;
         if (dlg.rec.numoffice == "")
             dlg.rec.Office = OfficeName;
         end;
      end;
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор подразделения банка из списка подразделений */
        if (FldName(dlg,id) == "numoffice")
           if (ListDepartment (Department))
              //OfficeName = 
              dlg.rec.numoffice = Department.name;
              dlg.rec.office = GetClientName(Department.PartyID);
              office = Department.Code;
              PartyID = Department.PartyID; 
              message(" ~F3~ Список подразделений "+const_message1);
              UpdateFields(dlg);
           end;
     elif(FldName(dlg,id) == "oper")
            rselect = "select t.t_oper, t.t_name " +   
                      " from dperson_dbt t inner join ddp_dep_dbt v on v.t_name = '"+dlg.rec.numoffice+"' and t.t_codedepart = v.t_code;";           
           
            cmd = RSDCommand(rselect);                        
            rsrec = RSDRecordset( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
            if (RunScroll(rsrec, 0, 0, "Опера", @EvProc, "Список операционистов", "~Enter~ выбор сотрудника ~Esc~ выход", true))
              dlg.rec.oper = rsrec.value (0);
              dlg.rec.OperName = rsrec.value (1);
              UpdateFields(dlg);
              OperSelect = rsrec.value (0);
            end;
        end;
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "Date")
          dlg.rec.date = GetDateByCalendar ({curDate});
        end;
        
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
          if (office != 0 ) 
            office = 0;
            dlg.rec.office = "По всем офисам";
            UpdateFields(dlg);
          end;
          if (dlg.rec.Office == "По всем офисам") 
            message(" ~F3~ Список подразделений "+const_message2);
            UpdateFields(dlg);
          end;
        /*/*Сброс даты отчета*/
          if ( Date(dlg.date) != Date({curDate}))
            dlg.date = {curDate};
            UpdateFields(dlg);
          end;
        */
     elif ( KEY == KEY_F2 )
        if ((strlen(dlg.rec.office) != 0) and (dlg.rec.office != "По всем офисам"))
           OfficeName = GetClientName(GetDepart(office));
        elif (dlg.rec.office == "По всем офисам") 
           OfficeName = dlg.rec.office;
        end;
        Date_report  = dlg.rec.Date; 
        if ((Date_report <= {curDate}) and (strlen(dlg.rec.office) != 0) and (strlen(string(office)) != 0))   
           Return CM_SAVE;
        else
           MsgBox("Не все поля корректны! \n" 
                  +"Возможно, причина ошибки в том,\n" 
                  //+"что не заполнен справочник подразделений ТС\n" 
                  +"что дата отчета больше даты текущего операционного дня.");
        end;
     elif ( (KEY == KEY_ENTER) and (FldName(dlg,id) == "Date") )
         SetFocus(dlg, 0);
         Return CM_IGNORE;
     end;
   end;
        
END;

if (RunDialog(dlg, "Event"))
  PrintAll();
end;
exit(1);