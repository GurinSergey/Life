/*

¢¨åà®¢. ¯® § ï¢ª¥ I-032636

®âç¥â ¢ë¢®¤¨â ¯®«ì§®¢ â¥«¥©, á®¢¥àè ¢è¨å ¯à®¢®¤ª¨ ¢ ®âç¥â­ë© ¯¥à¨®¤, ­® ­¥ ¯à¨¢ï§ ­­ëå ª ®â¤¥« ¬ (¢­ãâà¥­­ïï áâàãªâãà  ¡ ­ª )


*/
// zmp 23.07.2014 I-00503564 darhdoc_dbt => dacctrn_dbt
import globals,rsbdataset,treport, BankInter;

var path = "", pathfile = "", filen = "period_provodok.lbr";
GetRegistryValue("BANK_INI\\Ž™ˆ… €€Œ…’›\\„ˆ…Š’Žˆˆ\\LBRDIR", 6,path);
pathfile = FindPath(filen,path);

var iskl_str:string;
    iskl_str = "";
var errcode, stat;

stat = GetRegistryValue("PRBB\\REPORT\\USER_NOT_LINK", V_STRING, iskl_str, errcode);
/*‡ ï¢ª  I-00008472 —¥á­®ª®¢ ®¡à ¡®âªã ®è¨¡®ª ­ã¦­® ¢á¥£¤  ¤¥« âì*/
/*       ¨­ ç¥ ­¥ ¯®­ïâ­® ¯®ç¥¬ã ¦¥ ®âç¥â ­ ç¨­ ¥â çã¤¨âì.  */

  if((stat == V_UNDEF) and (errcode != 0))
    msgbox("Žè¨¡ª  ¯®«ãç¥­¨ï §­ ç¥­¨ï ­ áâà®©ª¨ à¥¥áâà  PRBB\\REPORT\\USER_NOT_LINK");
    exit(1);
  end;


var dlg = TRecHandler("panel",pathfile,True);
var ot4_data_begin,ot4_data_end;
var kkKEY_F2=316;
var KEY_F3=317;
var KEY_F9=323;
var KEY_ESC=27;
var KEY_ENTER=13;

var ds,ds_prov,sql,sql_prov;

var nomera=tarray;
var nomer:string="";
var ind:integer;
var ascii_code:integer;

var table1=ctablereport();
var table2=ctablereport();
var report1:string="";
var report2:string="";

var first_oper:bool=true;
var first_prov:bool=true;

const shirina_ot4eta:integer=98;
var time1,time2:time;

var tek_prov:integer=0;
var vsego_prov:integer=0;

MACRO EvMacro (dlg, cmd, id, key)

  if (cmd==DLG_INIT)
      message("~F2~ ¯à®¤®«¦¨âì,  ~ESC~ ¢ëå®¤");
     dlg.rec.Date_begin = {curdate};
     dlg.rec.Date_end = {curdate};
     UpdateFields(dlg); 
  end;

  if (cmd == DLG_REMFOCUS)
    if (FldName(dlg,id)=="date_begin")
       if ( dlg.rec.Date_begin >  dlg.rec.Date_end)
          MsgBox("„ â  ­ ç «  ¡®«ìè¥ ¤ âë ª®­æ  ¯¥à¨®¤ "); 
          return CM_CANCEL;
       end;
    end;
    if (FldName(dlg,id)=="date_end")
       	if ( dlg.rec.Date_end > {curdate} )
          MsgBox("„ â  ª®­æ  ¡®«ìè¥ ¤ âë â¥ªãé¥£® ®¯¥à æ¨®­­®£® ¤­ï"); 
          return CM_CANCEL;
       	end;
    end;
   	UpdateFields(dlg); 
  end;

  if (cmd==DLG_KEY)
    if (KEY==KEY_F9)
   		return CM_ignore;
    end; //if F9

    if (KEY==KEY_ENTER)
	    return CM_ignore;
    end; //if enter

    if (KEY==KEY_F3)
      return CM_ignore;
    end; //if F3

    if (KEY==kkKEY_F2)
      ot4_data_begin=dlg.rec.Date_begin;
      ot4_data_end=dlg.rec.Date_end;
      if ((ot4_data_begin>{curdate}) or (ot4_data_end>{curdate})) msgbox("§­ ç¥­¨¥ ¤ âë ¡®«ìè¥ â¥ªãé¥£® ®¯¥à¤­ï"); return CM_ignore;
      else  
      	return CM_SAVE;
      end;
    end; //if F2

    if (KEY==KEY_ESC)
      exit(1);
      return CM_CANCEL;
    end; //if esc

  end; //if DLG_KEY
END; //evmacro


if(rundialog(dlg,"evmacro")) 
	nomera.size=0;
	trim(iskl_str);
	for (ind,1,strlen(iskl_str))
		ascii_code=codefor(substr(iskl_str,ind,1));
		if ((ascii_code>=48) and (ascii_code<=57)) 
			nomer=nomer+substr(iskl_str,ind,1); 
		elif (strlen(nomer)!=0) 
			nomera[nomera.size]=nomer; 
			nomer=""; 
		end;
	end;
	if (strlen(nomer)!=0) 
		nomera[nomera.size]=nomer; 
		nomer=""; 
	end;


	sql=" select distinct ( prov.t_oper ) oper, t_name name from dacctrn_dbt prov left join dperson_dbt pers on (prov.t_oper=pers.t_oper) "+
			" where     prov.t_oper not in (select t_oper  from dop_otdel_dbt) "+
 			" and t_date_carry >= to_date ( '"+ot4_data_begin+"', 'dd.mm.rrrr' ) "+
 			" and t_date_carry <= to_date ( '"+ot4_data_end+"', 'dd.mm.rrrr' ) ";
        if (nomera.size > 0)
          for (ind,0,nomera.size-1)
 		sql=sql+" and prov.t_oper<>"+trim(nomera[ind]);
          end;
 	end;
// 	    getstring(sql);
      ds=trsbdataset(sql);
      report1=report1+"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\n";
      report1=report1+"³Žâç¥â ® á®¢¥àè ¢è¨å ¯à®¢®¤ª¨ ¯®«ì§®¢ â¥«ïå V6 ¢ ¯¥à¨®¤ á "+ot4_data_begin+" ¯® "+ot4_data_end+" ¢ª«îç¨â¥«ì­®\n";
      report1=report1+"³¨ ­¥ ¯à¨¢ï§ ­­ëå ­¨ ª ®¤­®¬ã ¯®¤à §¤¥«¥­¨î ¡ ­ª  (á ãç¥â®¬ ­¨¦¥¯à¨¢¥¤¥­­ëå ¨áª«îç¥­¨©)\n";
      report1=report1+"ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\n";
	    println(report1); report1="";
  
      //table1.offset=20;
      table1.addcolumn("­®¬¥à",10, AL_RIGHT);
			table1.addcolumn("¨¬ï",40, AL_LEFT);
			table1.printhead();

      while (ds.movenext)
      	if (not(first_oper))    	table1.printseparator; end;
      	first_oper=false;
      	table1.printStringTransferByWord(ds.value("oper"),ds.value("name"));  
      end;        
      table1.printbottom(string(" ¢á¥£® ¯®«ì§®¢ â¥«¥©: ",table1.GetNumStr));

      report1=report1+"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ \n";
      report1=report1+"³ ¯®«ì§®¢ â¥«¨, ­¥ ¯à¨¢ï§ ­­ë¥ ­¨ ª ®¤­®¬ã ¯®¤à §¤¥«¥­¨î, ­®, â¥¬ ­¥ ¬¥­¥¥,¨áª«îç¥­­ë¥ ¨§ ®âç¥â : ³ \n";
			nomer="³ ";
                        if (nomera.size > 0)
			  for (ind,0,nomera.size-1)
				nomer=nomer+nomera[ind]+", ";
				if (strlen(nomer)>90) report1=report1+string(substr(nomer,1,strlen(nomer)-2):98:l)+"³ \n"; nomer=" ³"; end;
			  end;
			end;
			if (nomer!="³ ") report1=report1+string(substr(nomer,1,strlen(nomer)-2):98:l)+"³ \n"; end;
      
      report1=report1+"ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \n";

      println(report1);
      println();


//      ds.movefirst(); ­¥ à ¡®â ¥â § à § 
      ds=trsbdataset(sql);

     	table2.addcolumn("áç¥â ¯« â¥«ìé¨ª ",20,AL_RIGHT);
     	table2.addcolumn("áç¥â ¯®«ãç â¥«ï",20,AL_RIGHT);
     	table2.addcolumn("áã¬¬ ",15,AL_RIGHT);
     	table2.addcolumn("N ¤®ª",10,AL_LEFT);
     	table2.addcolumn("®á­®¢ ­¨¥",81,AL_LEFT);
      	
      while (ds.movenext)
      	table2.printhead(" à áè¨äà®¢ª  ¯à®¢®¤®ª ­¥¯à¨¢ï§ ­­®£® ¯®«ì§®¢ â¥«ï "+string(ds.value("oper"):r:8)+"    "+ds.value("name"));
//      	println(" ¯à®¢®¤ª¨ ¯®«ì§®¢ â¥«ï "+string(ds.value("oper"):r:8)+"    "+ds.value("name"));
      	sql_prov="select * from dacctrn_dbt where t_date_carry >= to_date ( '"+ot4_data_begin+"', 'dd.mm.rrrr' ) "+
                 " and t_date_carry <= to_date ( '"+ot4_data_end+"', 'dd.mm.rrrr' ) and t_oper="+ds.value("oper");
        ds_prov=trsbdataset(sql_prov);
        vsego_prov=ds_prov.getreccount;
        tek_prov=0;
        	time1=time();
        	time2=time1-time1;
        while (ds_prov.movenext)
        	tek_prov=tek_prov+1;
        	time1=time();
          table2.printStringTransferByWord(ds_prov.value("t_account_payer"),ds_prov.value("t_account_receiver"),ds_prov.value("t_sum_natcur"),ds_prov.value("t_numb_document"),ds_prov.value("t_ground"));
          time2=time2+(time()-time1);
            if (mod(tek_prov,100)==0)
		          message("®¯¥à æ¨®­¨áâ "+string(ds.value("oper"):r:8)+", â¥ªãé ï ¯à®¢®¤ª : "+string(tek_prov)+", ¢à¥¬ï ­  ¤®¡ ¢«¥­¨¥ 100 ¯à®¢®¤®ª "+string(time2));
    	      	time2=time1-time1;
          	end;
        end;        
	      table2.printbottom(/*string("  ¢á¥£® ¯à®¢®¤®ª  ¯®«ì§®¢ â¥«ï ",ds.value("oper"),"(",ds.value("name"),"): ",table2.GetNumStr)*/);
	      //report2=report2+table2.getStr+"\n";
	      table2.clearmem();
	      println();
      end;        
//      table1.printmemstr;
      println();
//      println(report2);
      println("                                 ¤«ï ¯à®¤®«¦¥­¨ï à ¡®âë ­ ¦¬¨â¥ ESC");
   
end;
