/*Оборотная ведомость по транзитным счетам за период                   */
/*                                                                     */
/*                                                                     */
/*Тихомиров А.Н. 06.04.2009                    Версия 1.0              */

//12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
//04.09.2014 R-444167-2 DPN - Адаптация под "Солидарность"



//var Fulloutput,  out,  output="\\ovta.txt";                    
import RSD,rcw, rslx, Календарь, rsbdataset, payminter, globals, bankinter, "lib_fg.mac"; //04.09.2014 R-444167-2 DPN
var fulloutput = GetTxtFileName("ovta"), dprt_v;

const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;

var sss, ddd, Fulloutputl, outl, outputl="ovta.lbr"; 
record department (dp_dep);  
var branch, branchname, datebegin, dateend;  

var bank = FGBank(); //04.09.2014 R-444167-2 DPN

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("ovta", fulloutputl, TRUE); 

/*Найдем имя по Partyid*/
private macro GetClientName(id)
var  sl=" select part.t_name from dparty_dbt part where part.t_partyid="+id;
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.name;
  else
    if (id !=0)
       msgbox("Субъект не найден в party.dbt");
       return 0;
 //   else
 //     return "ОАО АКБ Пробизнесбанк";
    end;
  end;
END;

private macro vocodenote(trnid,i)  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
array vo;
var dat, data, ss, fl, f,pos, pos2, note;
var sq = "select prop.T_GROUND, prop.t_paymentid "+
     " from dpmdocs_dbt docs, dpmrmprop_dbt prop "+
     " where docs.t_paymentid=prop.t_paymentid "+
     " and DOCS.T_ACCTRNID = "+trnid;   //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
     debugbreak;
dat = trsbdataset(sq);
 if (dat.movenext())
   ss= " SELECT   utl_raw.cast_to_varchar2( t_text ) ExistNote "+
    " FROM dnotetext_dbt t "+
    " WHERE  t.t_documentid = "+dat.paymentid+
    " AND (t.t_objecttype = 501) "+
    " AND (t.t_notekind = 111)";
     data = trsbdataset(ss);
    if (data.movenext())
      fl=0;
      f=0;
      note=data.existnote;
      while (fl<1)
        pos = index (note,"{");
        pos2 =index (note, "}");
          if ((pos!=0) and (pos2!=0))
             vo(f)=substr(note,(pos+3),5);
             f=f+1;
             note = substr(note,(pos2+1));
          else
             fl=1;
          end;
      end;
      if (asize(vo)>i)
         return vo(i);
      else
         return "#";
      end;
    end;
 end;
END;

private macro vosumnote(trnid, i)  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
array vo;
var ss, data, fl, f,pos, pos2, note;
var sq = "select prop.T_GROUND, prop.t_paymentid "+
     " from dpmdocs_dbt docs, dpmrmprop_dbt prop "+
     " where docs.t_paymentid=prop.t_paymentid "+
     " and DOCS.T_ACCTRNID = "+trnid;  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
     debugbreak;
var dat = trsbdataset(sq);
 if (dat.movenext())
  ss= " SELECT   utl_raw.cast_to_varchar2( t_text ) ExistNote "+
      " FROM dnotetext_dbt t "+
      " WHERE  t.t_documentid = "+dat.paymentid+
      " AND (t.t_objecttype = 501) "+
      " AND (t.t_notekind = 111)";
  data = trsbdataset(ss);
    if (data.movenext())
        fl=0;
        f=0;
        note=data.existnote;
     while (fl<1)
        pos = index (note,"}");
        pos2 =index (note, ";");
         if ((pos!=0) and (pos2!=0))
           vo(f)=substr(note,(pos+2),(pos2-pos-2));
           f=f+1;
           note = substr(note,(pos2+1));
         else
           fl=1;
         end;
     end;
     return vo(i);
    end;
 end;
END;




private macro vocode(ground,trnid)  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
array vc;
var sq, data, f,j,h,pos, s, dat, ss, dd;
j=3;
f=1;

sq = "SELECT l.t_code FROM dpmco_dbt t , dllvalues_dbt l, dpmdocs_dbt pm WHERE t.t_paymentid = pm.T_PAYMENTID "+
     " and l.t_element = t.t_vo_code and l.t_list =1805 and PM.T_ACCTRNID =  "+trnid; //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
data = trsbdataset(sq);
if (data.movenext())
  return data.code;
end;
 
 while (j<8)
   j=j+1;
    if ((substr(ground,j,1)!=0) and (substr(ground,j,1)!=1) and (substr(ground,j,1)!=2) and (substr(ground,j,1)!=3)
        and (substr(ground,j,1)!=4) and (substr(ground,j,1)!=5) and (substr(ground,j,1)!=6) and (substr(ground,j,1)!=7)
        and (substr(ground,j,1)!=8) and (substr(ground,j,1)!=9))
       f=0;
    end;
 end;
 if (f)
    sq="select count(*)as cnt from dllvalues_dbt where t_list=1805 and t_flag=1 and t_code='"+substr(ground,4,5)+"'";
    data=trsbdataset(sq);
    data.movenext();
   if (data.cnt>0)
     return substr(ground,4,5);
   end;
 end;
sq = "select prop.T_GROUND, prop.t_paymentid "+
     " from dpmdocs_dbt docs, dpmrmprop_dbt prop "+
     " where docs.t_paymentid=prop.t_paymentid "+
     " and DOCS.T_ACCTRNID=  "+trnid;  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
data = trsbdataset(sq);
  if (data.movenext())
     s="select count(*)as cnt from dllvalues_dbt where t_list=1805 and t_flag=1 and t_code='"+substr(data.ground,4,5)+"'";
     dat=trsbdataset(s);
     dat.movenext();
       if (dat.cnt>0)
         return substr(data.ground,4,5);
       end;
         ss= " SELECT   utl_raw.cast_to_varchar2( t_text ) ExistNote "+
             " FROM dnotetext_dbt t "+
             " WHERE  t.t_documentid = "+data.paymentid+
             " AND (t.t_objecttype = 501) "+
             " AND (t.t_notekind = 111)";
         dd = trsbdataset(ss);
       if (dd.movenext())
          pos = index(dd.existnote,"{");
          s="select count(*) as cnt from dllvalues_dbt where t_list=1805 and t_flag=1 and t_code='"+substr(dd.existnote,(pos+3),5)+"'";
          dat=trsbdataset(s);
          dat.movenext();
            if (dat.cnt>0)
               return substr(dd.existnote,(pos+3),5)+"!!";
            end;
       end;
  end;
return "00000";
end;

private macro outall(inter, fiid, namefi)
var maxs:integer, s:integer;
initprogress(-1,"Ждите, отбираются счета...","Отбираются счета. Валюта - "+ namefi);
var sql = " SELECT   count(*) as cnt"+
   " FROM daccount_dbt acc, dfininstr_dbt fin, dacctrn_dbt arh "+  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
   " WHERE (   acc.t_account BETWEEN '401%' AND '4079%' "+
   "       OR acc.t_account LIKE '40802%' "+
   "      ) "+
   "     AND acc.t_type_Account like '%Y%' ";// or substr(acc.t_account,14,1)=1)"+ //04.09.2014 R-444167-2 DPN
   //04.09.2014 R-444167-2 DPN
   if (bank.is_SLD)
       sql = sql + " AND ( acc.t_account LIKE '_____________1%' or acc.t_account LIKE '_____________9%') ";
   else
       sql = sql + " AND acc.t_account LIKE '_____________1%' ";
   end;
   
   sql = sql + branch +
   "     AND acc.t_code_currency = fin.t_fiid "+
   "     AND fin.t_fi_code not like '%KLR%' "+
   "     AND (arh.T_ACCOUNT_PAYER=acc.t_account "+
   "     OR arh.T_ACCOUNT_RECEIVER=acc.t_account) "+
   " AND arh.t_date_carry BETWEEN TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') and TO_DATE ('"+dateend+"', 'DD-MM-YYYY')"+ inter;
   useprogress(-1);
   var dataset=trsbdataset(sql);
   dataset.movenext();
   maxs=dataset.cnt;
   sql = " SELECT  ARH.T_ACCTRNID trnid, acc.t_client, acc.t_account, arh.T_ACCOUNT_PAYER, acc.t_nameaccount, "+  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
         " arh.t_date_carry,  ARH.T_SUM_PAYER sum, arh.T_GROUND, arh.T_ACCOUNT_RECEIVER, acc.t_code_currency"+    //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
         " FROM daccount_dbt acc, dfininstr_dbt fin, dacctrn_dbt arh "+                                              //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
         " WHERE (   acc.t_account BETWEEN '401%' AND '4079%' "+
         "       OR acc.t_account LIKE '40802%' "+
         "      ) "+
         "     AND acc.t_type_Account like '%Y%' ";// or substr(acc.t_account,14,1)=1)"+ //04.09.2014 R-444167-2 DPN
         //04.09.2014 R-444167-2 DPN
         if (bank.is_SLD)
             sql = sql + " AND ( acc.t_account LIKE '_____________1%' or acc.t_account LIKE '_____________9%') ";
         else
             sql = sql + " AND acc.t_account LIKE '_____________1%' ";
         end;

         sql = sql + branch +
         "     AND acc.t_code_currency = fin.t_fiid "+
         "     AND fin.t_fi_code not like '%KLR%' "+
         "     AND (arh.T_ACCOUNT_PAYER=acc.t_account "+
         "     OR arh.T_ACCOUNT_RECEIVER=acc.t_account) "+
         " AND arh.t_date_carry BETWEEN TO_DATE ('"+datebegin+"', 'DD-MM-YYYY') and TO_DATE ('"+dateend+"', 'DD-MM-YYYY') " +
         " AND ARH.T_SUM_PAYER > 0"+  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
         inter;
   dataset=trsbdataset(sql);
   remprogress(-1);
   initprogress(maxs,"Ждите, производится расчет","Производится расчет. Валюта -"+ namefi);
   array  vop, vosum, sum, vocn, vok, vod, vo,nam,gr;
   var i, h, fl, debet_all=0, kredit_all=0,p,k;
   s=0;
   debugbreak;
    while (dataset.movenext());
        s=s+1;
        useprogress(s);
        strsplit(dataset.nameaccount,nam,23);
        strsplit(dataset.ground,gr,33);
        asize(vocn,0);
        asize(sum,0);
        vocn(0)=(vocode(dataset.ground, dataset.trnid));  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
        if (substr(vocn(0),6,2)=="!!")
           vocn(0)=substr(vocn(0),1,5);
           i=0;
           fl=1;
           debugbreak;
           while (fl)
               vocn(i)=vocodenote(dataset.trnid,i);  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
           if (vocn(i)=="#")
               fl=0;
           else
               sum(i)=money(vosumnote(dataset.trnid,i));  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
           end;
               i=i+1;
           end;
               vocn(i-1)="";
        else
           sum(0)=dataset.sum;
        end;
        if (asize(nam)>asize(gr))
            if (asize(vocn)<asize(nam))
                p=asize(nam);
            else
                p=asize(vocn);
            end;
        else
            if (asize(vocn)<asize(gr))
                p=asize(gr);
            else
                p=asize(vocn);
            end;
        end;

        if (dataset.account_receiver==dataset.account)
            if ((s==1) and (fiid!=41))
[├────────────────────────┬────────────────────┬───────────────────┼────────────────────┼────────────────────┼─────────────────────────────────┼──────┤];
            else
[├────────────────────────┼────────────────────┼───────────────────┼────────────────────┼────────────────────┼─────────────────────────────────┼──────┤];
            end;
[│########################│####################│###################│                    │####################│#################################│######│]
(nam(0), dataset.account, date(dataset.date_carry),sum(0),gr(0),vocn(0));
   if (p>1)
   k=1;
   while (k<p)
   k=k+1;
     if (asize(nam)<k)
       h=asize(nam);
       while (h<k)
      nam(h)="";
       h=h+1;
       end;
     end;
     if (asize(vocn)<k)
       h=asize(vocn);
       while (h<k)
      vocn(h)="";
      sum(h)="";
       h=h+1;
       end;
     end;
     if (asize(gr)<k)
       h=asize(gr);
       while (h<k)
      gr(h)="";
       h=h+1;
       end;
     end;
[│########################│                    │                   │                    │####################│#################################│######│]
(nam(k-1), sum(k-1), gr(k-1), vocn(k-1));
   end;
   end;
     kredit_all=kredit_all+dataset.sum;
       k=0;
       fl=1;
       while (k<asize(vocn))
       i=0;
       while (i<asize(vo))
         if ((vocn(k)==vo(i)) and (vocn(k)!=""))
         vok(i)=vok(i)+sum(k);
         fl=0;
         end;
         i=i+1;
         end;
        if ((fl) and (vocn(k)!=""))
        vo((asize(vo)))=vocn(k);
        vok(asize(vo)-1)=sum(k);
        vod(asize(vo)-1)=0;
        end;
        k=k+1;
       end;

  else
if ((s==1)  and (fiid!=41))
[├────────────────────────┬────────────────────┬───────────────────┼────────────────────┼────────────────────┼─────────────────────────────────┼──────┤];
else
[├────────────────────────┼────────────────────┼───────────────────┼────────────────────┼────────────────────┼─────────────────────────────────┼──────┤];
end;
[│########################│####################│###################│####################│                    │#################################│######│]
(nam(0), dataset.account, date(dataset.date_carry),sum(0),dataset.ground,vocn(0));
   if (p>1)
   k=1;
   while (k<p)
   k=k+1;
     if (asize(nam)<k)
       h=asize(nam);
       while (h<k)
      nam(h)="";
       h=h+1;
       end;
     end;
     if (asize(vocn)<k)
       h=asize(vocn);
       while (h<k)
      vocn(h)="";
      sum(h)="";
       h=h+1;
       end;
     end;
     if (asize(gr)<k)
       h=asize(gr);
       while (h<k)
      gr(h)="";
       h=h+1;
       end;
     end;
[│########################│                    │                   │####################│                    │#################################│######│]
(nam(k-1), sum(k-1), gr(k-1), vocn(k-1));

   end;
   end;
       debet_all=debet_all+dataset.sum;
       k=0;
       fl=1;
       while (k<asize(vocn))
       i=0;
       while (i<asize(vo))
         if ((vocn(k)==vo(i)) and (vocn(k)!=""))
         vod(i)=vod(i)+sum(k);
         fl=0;
         end;
         i=i+1;
         end;
        if ((fl) and (vocn(k)!=""))
        vo((asize(vo)))=vocn(k);
        vod(asize(vo)-1)=sum(k);
        vok(asize(vo)-1)=0;
        end;
        k=k+1;
       end;

  end;
end;
 if ((debet_all!=0) or (kredit_all!=0))
[├────────────────────────┴────────────────────┴───────────────────┼────────────────────┼────────────────────┼─────────────────────────────────┴──────┤
│Итого по валюте: #########################################       │####################│####################│                                        │
├─────────────────────────────────────────────────────────────────┼────────────────────┼────────────────────┼─────────────────────────────────┬──────┤]
(namefi, debet_all, kredit_all);
//debugbreak;
i=0;
   while (i<asize(vo))
      if (i==0)
[│Итого по кодам VO по валюте: #############################       │####################│####################│                                 │######│]
(namefi, vod(i), vok(i),vo(i));
      else
[│                                                                 │####################│####################│                                 │######│]
        (vod(i), vok(i),vo(i));
      end;
     i=i+1;
   end;
 end;
remprogress(s);
END;


 /*Обработчик диалоговой панели ввода исходных данных для печати*/
MACRO Event (dlg, cmd, id, key) 

   var const_mess = "~F2~ Продолжить ~SPACE~ По всем офисам ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dprt_v = 0;
      dlg.rec.dprt_code  ="";
      dlg.rec.dprt_name = " ";//"Пробизнесбанк"; //04.09.2014 R-444167-2 DPN
      dlg.rec.Datebegin = {curDate};
      dlg.rec.DateEnd = {curDate};
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     if (FldName(dlg,id)=="dprt_code") 
       message(" ~F3~ Список подразделений "+const_mess);
     elif (FldName(dlg,id)=="Datebegin")
       message(" ~F3~ Выбор даты из календаря "+const_mess2);
     elif (FldName(dlg,id)=="DateEnd")
       message(" ~F3~ Выбор даты из календаря "+const_mess2);
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
     if (FldName(dlg,id) == "Datebegin")
       if ( dlg.rec.DateBegin > {curdate} )
         MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
         MsgBox("Дата начала периода не может быть больше даты окончания периода");
        return CM_CANCEL;
       end;
     end;
     if (FldName(dlg,id) == "DateEnd")
       if ( dlg.rec.DateEnd > {curdate} )
         MsgBox("Дата не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
         MsgBox("Дата окончания периода не может быть меньше даты начала периода");
        return CM_CANCEL;
       end;

    end;
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор подразделения банка из списка подразделений */
        if (FldName(dlg,id) == "dprt_code")
           if (ListDepartment (Department))
              dprt_v = department.code; 
              dlg.rec.dprt_code = Department.name;
              dlg.rec.dprt_name = GetClientName(Department.PartyID);
              message(" ~F3~ Список подразделений "+const_mess);
              UpdateFields(dlg);
           end;
        end;
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "Datebegin")
          dlg.rec.datebegin = GetDateByCalendar ({curDate});
        end;
        if (FldName(dlg,id) == "DateEnd")
          dlg.rec.dateend = GetDateByCalendar ({curDate});
        end;
        
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
          if (dlg.rec.dprt_code != 0 ) 
            dlg.rec.dprt_code="";
            dprt_v = 0;
            dlg.rec.dprt_name = "По всем офисам";
            UpdateFields(dlg);
          end;
          if (dlg.rec.dprt_code == "По всем офисам") 
            message(" ~F3~ Список подразделений "+const_mess);
            UpdateFields(dlg);
          end;

     elif (( KEY == KEY_F2 )  or (KEY == KEY_ENTER))        //Проверки при вводе
         if ( dlg.rec.DateBegin > {curdate} )
                MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
                return CM_IGNORE;
          elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
                MsgBox("Дата начала периода не может быть больше даты окончания периода");
                return CM_IGNORE;
         end;
          if ( dlg.rec.DateEnd > {curdate} )
                MsgBox("Дата не может быть больше даты текущего операционного дня");
                return CM_IGNORE;
          elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
                MsgBox("Дата окончания периода не может быть меньше даты начала периода");
                return CM_IGNORE;
          end;
        if ((strlen(dlg.rec.dprt_code) != 0) and (dlg.rec.dprt_name != "По всем офисам"))
           if (department.nodetype == 2)                   
           branch = "and acc.t_branch="+dprt_v;
           branchname=dlg.rec.dprt_name;
           else
           branch = "and acc.t_department="+dprt_v;
           branchname=dlg.rec.dprt_name;
           end;   

        elif (dlg.rec.dprt_Name == "По всем офисам") 
           branch = "";
           branchname=dlg.rec.dprt_name;
        elif (dprt_v==0)
           branch = "";
           branchname=dlg.rec.dprt_name;
        end;
        Datebegin  = dlg.rec.Datebegin;
        Dateend = dlg.rec.DateEnd;
        if ((Datebegin < {curDate}))    
           Return CM_SAVE;
        elif (gettrue(true,"Дата равна текущему опрерационному дню. Продолжить?"))
           Return CM_SAVE;
           
        end;
      else
           Return CM_IGNORE;
     end;
   end;
        
END;



/*Точка входа в макрос*/
if (RunDialog(dlg, "Event"))

//GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR",2,out);
//fulloutput=out+output;
//setoutput(fulloutput,false);

[ Обороты по транзитным счетам подразделения #################################
за период с ########## по ##########
┌────────────────────────┬────────────────────┬───────────────────┬────────────────────┬────────────────────┬─────────────────────────────────┬──────┐
│    Наименование        │   Транзитный счет  │       Дата        │        Дебет       │      Кредит        │         Основание платежа       │      │
│      клиента           │       клиента      │     проводки      │                    │                    │                                 │      │]
(branchname, date(datebegin), date(dateend));

outall(" AND acc.t_code_currency = 41 ORDER BY acc.t_account ", 41, "Доллар США");
outall(" AND acc.t_code_currency = 45 ORDER BY acc.t_account ", 45, "ЕВРО");
sss="select t_fiid, t_name from dfininstr_dbt where t_fiid>0 and t_fiid not in(41,45) and t_fi_kind=1";
ddd=trsbdataset(sss);
while (ddd.movenext())
  outall(" AND acc.t_code_currency =("+ddd.fiid+") ORDER BY acc.t_account ", ddd.fiid, ddd.name);
end;
[└─────────────────────────────────────────────────────────────────┴────────────────────┴────────────────────┴─────────────────────────────────┴──────┘];

end;
     
end;


