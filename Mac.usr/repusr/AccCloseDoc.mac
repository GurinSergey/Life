/*Неоплаченные платежи                                       */
/*                                                           */
/*Подключен на шаге закрытия счета.                          */
/*                                                           */
/*Тихомиров А.Н. 12.01.2010                    Версия 1.0    */
/*VV С-19749 доработка отчета по неоплаченным платежам 20.05.13*/

import globals, RSD,rcw, rslx, Календарь, rsbdataset, ptinter, bankinter, payminter;

macro OutallDoc(account, fiid)
var rsd, sql, i:integer = 0;
debugbreak;
var txt = GetTxtFileName("AllDOC");
setoutput (txt, false);
sql = "select rownum, t_payer, t_payername, docname, t_valuedate, "+
" t_payeraccount, t_receiveraccount, t_amount, t_ccy, t_ground,  "+
" namestep, t_paymentid, Dockind from (select  t_payer, t_payername, docname, t_valuedate,  "+
" t_payeraccount, t_receiveraccount, t_amount, t_ccy, t_ground,  "+
" namestep, t_paymentid, DECODE (case,   "+
" 'ББ_15_16_70_400_430_440', 'ББ   (15-мультики, 16, 27 -платежки ББ, 70-мемеорики, 400,430,440 -кассовые ББ)',  "+
" 'РКО_230_231_233'        , 'РКО  (230, 231, 233 - Заявления на открытие/закрытие счетов)',  "+
" 'РКО_201_410_420'        , 'РКО  (201 - РДД, 410,420 - Кассовые РКО-шные документы)',  "+
" 'РКО_51'                 , 'РКО  (51 - периодическая комиссия)',  "+
" 'ББ_59'                  , 'ББ   (59 - требования на оплату периодических комиссий)',  "+
" 'АРМП_320_322'        , 'АРМП (Ответные платежки)',  "+
" 'ПРОЧЕЕ'                 , 'Остальные экземпляры операций'  "+
" ) Dockind  from (  "+
"SELECT   rm.t_payername, pm.t_payer, pm.t_valuedate,"+
 "pm.t_payeraccount,pm.t_receiveraccount,pm.t_amount,"+
 "inst.t_ccy,rm.t_ground, "+       
       "  NVL ("+
           " (SELECT   BL.T_NAME stlist"+
             "  FROM   doprstep_dbt st, doprblock_dbt bl"+
            "  WHERE   st.t_id_operation = OPR.T_ID_OPERATION"+
                   "   AND st.T_BLOCKID = BL.T_BLOCKID"+
                    "  AND st.t_id_step ="+
                           " (SELECT   MAX (t_id_step)"+
                            "   FROM   doprstep_dbt t"+
                            "  WHERE   t_id_operation = st.t_id_operation"+
                               "       AND t_isexecute <> CHR (0))),    'Отложен'  )  namestep,   "+                                  
                            " doc.t_name AS docname,pm.t_paymentid,pm.t_basefiid,"+
"     case   "+
"        when pm.t_dockind in (15, 16, 27, 70, 400, 430, 440) then 'ББ_15_16_70_400_430_440'  "+
"        when pm.t_dockind in (230, 231, 233)             then 'РКО_230_231_233'  "+
"        when pm.t_dockind in (201, 410, 420)             then 'РКО_201_410_420'  "+
"        when pm.t_dockind in (51)                        then 'РКО_51'  "+
"        when pm.t_dockind in (59)                        then 'ББ_59'  "+
"        when pm.t_dockind in (320, 322)              then 'АРМП_320_322'  "+
"        else 'Остальное'   "+
"     end case  "+
" FROM   dpmpaym_dbt pm, doproper_dbt opr, dpmrmprop_dbt rm, dpmprop_dbt db,"+
" dfininstr_dbt inst, doprkdoc_dbt doc  "+                                           
" WHERE       pm.t_dockind = OPR.T_DOCKIND"+
      "   AND OPR.T_DOCUMENTID = LPAD (pm.t_paymentid, 34, 0)"+
     "    AND pm.t_PayerAccount = '"+account+"'"+
       "  AND pm.t_PaymStatus NOT IN (32000, 100)"+
       "  AND pm.t_paymentid = rm.T_PAYMENTID"+
       "  AND db.t_PaymentID = pm.t_PaymentID"+
       "  AND rm.t_PaymentID = pm.t_PaymentID"+
       "  AND doc.t_dockind = pm.t_dockind"+
        " AND inst.t_fiid = pm.t_basefiid"+
       "  AND pm.t_FIID = "+fiid+""+
      "   AND pm.t_Chapter = 1"+
      "   AND db.t_DebetCredit = 0  ))";  

rsd = trsbdataset(sql);
initprogress(-1);

[                               Неоплаченные платежи по счету ############################

┌──┬────────────────────┬─────────────────────────────────────┬─────────────────────────┬───────────────────────┬─────────────────┬────────────────────────────┬───────────────────┬──────────────────────────┬──────────┐
│№ │  Лицевой счет      │    Наименование                     │ Вид документа           │      Дата документа   │   Сумма         │   Основание                │   Шаг             │   Область                │  Валюта  │]
(account);

while (rsd.movenext())
[┌──┼────────────────────┼─────────────────────────────────────┼─────────────────────────┼───────────────────────┼─────────────────┼────────────────────────────┼───────────────────┼──────────────────────────┼──────────┐
 │##│####################│#####################################│#########################│#######################│#################│############################│###################│##########################│##########│]
 (int(rsd.rownum), rsd.payeraccount, rsd.payername:w, rsd.docname:w, date(rsd.valuedate), money(rsd.amount), rsd.ground:w, rsd.namestep:w, rsd.dockind:w, rsd.ccy);

i = i+1;
  useprogress(i);


end;
[└──┴────────────────────┴─────────────────────────────────────┴─────────────────────────┴───────────────────────┴─────────────────┴────────────────────────────┴───────────────────┴──────────────────────────┴──────────┘
                                                                               ИТОГО: #########]
                                                                               (i);


remprogress();
setoutput(null,true);
viewfile(txt);


end;


/*
/*Точка входа*/

  OutAllDoc(account.account, account.fiid);*/
