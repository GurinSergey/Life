/*¥ç âì ¢å®¤ïé¨å ¯« â¥¦¥© ­  ­¥¢ëïá­¥­­ëå                   */
/*                                                           */
/*                                                           */
/*’¨å®¬¨à®¢ €.. 20.01.2010                    ‚¥àá¨ï 1.0    */


import globals, RSD,rcw, rslx, Š «¥­¤ àì, rsbdataset, ptinter, bankinter, payminter;

var branchname, opern, inter, corschemn, dprt_v; 
//var out, fulloutput, output = "\\payment.txt";
var reportdate={curdate}, branch, opinter, i:integer, maxs:integer, race;
var fulloutput = GetTxtFileName("printin");
array mn;
mn(0) = "1 à¥©á";
mn(1) = "2 à¥©á";
mn(2) = "3 à¥©á";
mn(3) = "4 à¥©á";
mn(4) = "5 à¥©á";

const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;

record Department ("dp_dep.dbt");
record Corschem  ("Corschem.dbt");
record oper  ("person.dbt");

var Fulloutputl, outl, outputl="printinN.lbr";                    

GetRegistryValue("BANK_INI\\Ž™ˆ… €€Œ…’›\\„ˆ…Š’Žˆˆ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("printin", fulloutputl, TRUE); 

private macro dep(id)
var sl, rs, fl=0;
 while (fl==0)
  sl ="SELECT party.t_shortname "
   " FROM dobjcode_dbt obj, ddp_dep_dbt dep, dparty_dbt party "
   " WHERE obj.t_objectid = dep.t_partyid "
   "  AND obj.t_codekind = 3 "
   "  AND party.t_partyid = dep.t_partyid "
   "  AND dep.t_code = "+id;
  rs = TRsbDataSet( sl);
   if ( rs.moveNext() )
      return rs.shortname;
   else
     sl ="SELECT t_parentcode "
         " FROM ddp_dep_dbt "
         "  where t_code = "+id;
     rs = TRsbDataSet( sl);
      if ( rs.moveNext() )
        id=rs.parentcode;
      else
        return 0;
      end;
    end;
 end;
end;

private macro kind(id)
var sl ="select t_name from dpmpopknd_dbt where t_paymentkind='"+id+"'";
var  rs = TRsbDataSet( sl);
 if ( rs.moveNext() )
   return rs.name;
 end;
return 0;
end;

private macro printpaym(id)
var sl, rs, n;
array payername, receivername, ground, amount, payerbankname, receiverbankname;
var rsbobjpayment = rsbpayment(id);
            strsplit(rsbobjpayment.receiverbankname, receiverbankname, 85, 85, 3);
            strsplit(rsbobjpayment.payerbankname, payerbankname, 85, 85, 3);
            strsplit(curtostralt(rsbobjpayment.baseamount,null,null, 643), amount, 85, 85, 3);
            strsplit(rsbobjpayment.payername, payername, 50, 50, 5);
            strsplit(rsbobjpayment.receivername, receivername, 50, 50, 5);
            strsplit(rsbobjpayment.ground, ground, 95, 95, 3);


            [(3R(s0p13.50h8.5v0s0b20T&l1X&l8D&l0O&a7L&12E];
[
                                                   ############     #############       ÚÄÄÄÄÄÄÄÄÄ¿
   ‹€’…†Ž… Ž“—…ˆ… N ###################       ÄÄÄÄÄÄÄÄÄÄÄÄ     ÄÄÄÄÄÄÄÄÄÄÄÄÄ       ³ 0401060 ³
                                                      („ â )        (‚¨¤ ¯« â¥¦ )       ÀÄÄÄÄÄÄÄÄÄÙ

   ‘ã¬¬    ³ ####################################################################################
   ¯à®¯¨áìî³ ####################################################################################
           ³ ####################################################################################
  ÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
   ################################################## ³ ‘ã¬¬      ³ #############################
   ################################################## ³           ³
   ################################################## ³           ³
   ################################################## ÃÄÄÄÄÄÄÄÄÄÄÄ´
   ################################################## ³ ‘ç.N.     ³ #############################
                                                      ³           ³
   « â¥«ìé¨ª                                         ³           ³
  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
   ################################################## ³ ˆŠ       ³ #############################
   ################################################## ÃÄÄÄÄÄÄÄÄÄÄÄ´
                                                      ³ ‘ç.N.     ³ #############################
    ­ª ¯« â¥«ìé¨ª                                    ³           ³
  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
   ################################################## ³ ˆŠ       ³ #############################
   ################################################## ÃÄÄÄÄÄÄÄÄÄÄÄ´
                                                      ³ ‘ç.N.     ³ #############################
    ­ª ¯®«ãç â¥«ï                                    ³           ³
  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´
   ################################################## ³ ‘ç.N.     ³ #############################
   ################################################## ³           ³
   ################################################## ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ
   ################################################## ³ ‚¨¤ Ž¯¥à. ³ #### ³ ‘à®ª ¯« â. ³ ##########
   ################################################## ÃÄÄÄÄÄÄÄÄÄÄÄ´      ÃÄÄÄÄÄÄÄÄÄÄÄÄ´
                                                      ³  §. ¯«.  ³      ³ Žç¥à. ¯« â.³ ###
                                                      ÃÄÄÄÄÄÄÄÄÄÄÄ´      ÃÄÄÄÄÄÄÄÄÄÄÄÄ´
                                                      ³ Š®¤       ³      ³ ¥§. ¯®«¥  ³
   ®«ãç â¥«ì                                         ³           ³      ³            ³
  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ
    §­ ç¥­¨¥ ¯« â¥¦ , ­ ¨¬¥­®¢ ­¨¥ â®¢ à , ¢ë¯®«­¥­ëå à ¡®â, ®ª § ­­ëå ãá«ã£, N N ¨ ¤ âë â®¢ à­ëå
   ¤®ªã¬¥­â®¢, ¤®£®¢®à®¢, „‘:
   ###############################################################################################
   ###############################################################################################
   ###############################################################################################

  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
                                            ®¤¯¨á¨                        Žâ¬¥âª¨ ¡ ­ª 

        Œ..
                                            ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

                                            ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
                                                                            
]                                                                            
 (date(rsbobjpayment.valuedate), kind(rsbobjpayment.paymentkind), 
  rsbobjpayment.number,
  amount(0),
  amount(1),
  amount(2),
  payername(0), rsbobjpayment.baseamount, 
  payername(1), 
  payername(2),
  payername(3),
  payername(4), rsbobjpayment.payeraccount,
  payerbankname(0), rsbobjpayment.payerbankcode, 
  payerbankname(1),
  rsbobjpayment.PAYERCORRACCNOSTRO, 
  receiverbankname(0), rsbobjpayment.receiverbankcode, 
  receiverbankname(1), rsbobjpayment.RECEIVERCORRACCNOSTRO,
  receivername(0),  rsbobjpayment.receiveraccount, 
  receivername(1),
  receivername(2),
  receivername(3),rsbobjpayment.shifroper, date(rsbobjpayment.paydate),
  receivername(4),
  rsbobjpayment.priority, 
  ground(0), 
  ground(1), 
  ground(2)//,
//  date(reportdate):c, 
//  dep(rsbobjpayment.department):c
);

 end;


private macro outall()
initprogress(-1,"†¤¨â¥...", "Žâ¡¨à îâáï ¯« â¥¦¨");                 
var tp, sql;
if (race == "‚á¥ à¥©áë")
tp = "in (1, 2, 3, 4, 5)";
else
tp = "="+substr(race,1,1);
end;
sql = " SELECT count(1) as cnt "+
  " FROM dwlpm_dbt, "+
      " dpmpaym_dbt, "+
      " dobjcode_dbt, "+
      " dwlmeslnk_dbt, "+
      " dwlmes_dbt, "+
      " dpmrmprop_dbt, "+
      " doproper_dbt, "+
      " dwlsess_dbt, "+
      " doprstep_dbt "+
 " WHERE dwlpm_dbt.t_paymentid = dpmpaym_dbt.t_paymentid "+
   " AND dwlpm_dbt.t_wlpmnum = 0 "+
  " AND dwlpm_dbt.t_direct = CHR (88) "+
  " AND dwlmeslnk_dbt.t_objkind = 501 "+
  " AND dwlmeslnk_dbt.t_objid = dwlpm_dbt.t_wlpmid "+
  " AND dwlmes_dbt.t_mesid = dwlmeslnk_dbt.t_mesid "+
  " AND dpmrmprop_dbt.t_paymentid = dpmpaym_dbt.t_paymentid "+
  " AND dpmpaym_dbt.t_dockind = doproper_dbt.t_dockind "+         //!!!!!!!!!!!!!!!!!!!!!
  " AND doproper_dbt.t_id_operation = doprstep_dbt.t_id_operation "+
  " AND doproper_dbt.t_documentid = lpad(dpmpaym_dbt.t_paymentid, 34, '0') "+
  " AND doprstep_dbt.t_isexecute = 'R' "+
  " AND doprstep_dbt.t_symbol = 'U' "+
  " AND dobjcode_dbt.t_objecttype = 3 "+
  " AND dobjcode_dbt.t_codekind=3 "+
  " AND dpmpaym_dbt.t_payerbankid=dobjcode_dbt.t_objectid "+
   " and dwlmes_dbt.t_sessionid = dwlsess_dbt.t_sessionid "+ // …á«¨ ­ã¦¥­ ­®¬¥à á¥ ­á 
   " and dwlsess_dbt.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY')"+
   " and dwlsess_dbt.T_NUMBERRACE "+tp;
useprogress(-1);
var dataset=trsbdataset(sql);
dataset.movenext();
maxs=dataset.cnt;

sql = " SELECT dpmpaym_dbt.t_paymentid "+
  " FROM dwlpm_dbt, "+
      " dpmpaym_dbt, "+
      " dobjcode_dbt, "+
      " dwlmeslnk_dbt, "+
      " dwlmes_dbt, "+
      " dpmrmprop_dbt, "+
      " doproper_dbt, "+
      " dwlsess_dbt, "+
      " doprstep_dbt "+
 " WHERE dwlpm_dbt.t_paymentid = dpmpaym_dbt.t_paymentid "+
   " AND dwlpm_dbt.t_wlpmnum = 0 "+
  " AND dwlpm_dbt.t_direct = CHR (88) "+
  " AND dwlmeslnk_dbt.t_objkind = 501 "+
  " AND dwlmeslnk_dbt.t_objid = dwlpm_dbt.t_wlpmid "+
  " AND dwlmes_dbt.t_mesid = dwlmeslnk_dbt.t_mesid "+
  " AND dpmrmprop_dbt.t_paymentid = dpmpaym_dbt.t_paymentid "+
  " AND dpmpaym_dbt.t_dockind = doproper_dbt.t_dockind "+         //!!!!!!!!!!!!!!!!!!!!!
  " AND doproper_dbt.t_id_operation = doprstep_dbt.t_id_operation "+
  " AND doproper_dbt.t_documentid = lpad(dpmpaym_dbt.t_paymentid, 34, '0') "+
  " AND doprstep_dbt.t_isexecute = 'R' "+
  " AND doprstep_dbt.t_symbol = 'U' "+
  " AND dobjcode_dbt.t_objecttype = 3 "+
  " AND dobjcode_dbt.t_codekind=3 "+
  " AND dpmpaym_dbt.t_payerbankid=dobjcode_dbt.t_objectid "+
   " and dwlmes_dbt.t_sessionid = dwlsess_dbt.t_sessionid "+ // …á«¨ ­ã¦¥­ ­®¬¥à á¥ ­á 
   " and dwlsess_dbt.t_bankdate = to_date('"+reportdate+"','DD.MM.YYYY')"+
   " and dwlsess_dbt.T_NUMBERRACE "+tp+
   " order by dwlsess_dbt.T_NUMBERRACE,  dpmpaym_dbt.t_amount ";

 dataset=trsbdataset(sql);
remprogress(-1);
initprogress(maxs,"†¤¨â¥...", "à®¨§¢®¤¨âáï à áç¥â");                 

i=0;
 while (dataset.movenext())
  i=i+1;
  useprogress(i);
  printpaym(dataset.paymentid)
 end;
 remprogress(i);
 setoutput(null,true);
// viewfile(fulloutput);
END;

 /*Ž¡à ¡®âç¨ª ¤¨ «®£®¢®© ¯ ­¥«¨ ¢¢®¤  ¨áå®¤­ëå ¤ ­­ëå ¤«ï ¯¥ç â¨*/
MACRO Event (dlg, cmd, id, key) 

   var const_mess = "~F2~ à®¤®«¦¨âì ~SPACE~ ® ¢á¥¬ ®ä¨á ¬ ~ESC~ ‚ëå®¤ ";
   var const_mess2 = "~F2~ à®¤®«¦¨âì ~SPACE~ ~ESC~ ‚ëå®¤ ";
   var m;
   /*¥à¢®­ ç «ì­ ï ¨­¨æ¨ «¨§ æ¨ï ¯®«¥©*/
   if(cmd == DLG_INIT)
      dprt_v = 0;
      dlg.rec.ReportDate = {curDate};
      dlg.rec.race = "‚á¥ à¥©áë";
      UpdateFields(dlg); 
   end;
   
   /*“áâ ­®¢ª  ¯®¤áª §®ª ¢ áâà®ª¥ á®áâ®ï­¨ï*/
   if (cmd==DLG_SETFOCUS)
     if (FldName(dlg,id)=="ReportDate")
       message(" ~F3~ ‚ë¡®à ¤ âë ¨§ ª «¥­¤ àï "+const_mess2);
     elif (FldName(dlg,id)=="Race")
       message(" ~F3~ ‚ë¡®à £« ¢ë áç¥â®¢ "+const_mess2);
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*à®¢¥àª  ª®àà¥ªâ­®áâ¨ ¤ â ®âç¥â */
     if (FldName(dlg,id) == "ReportDate")
       if ( dlg.rec.ReportDate > {curdate} )
         MsgBox("„ â  ­ ç «  ¯¥à¨®¤  ­¥ ¬®¦¥â ¡ëâì ¡®«ìè¥ ¤ âë â¥ªãé¥£® ®¯¥à æ¨®­­®£® ¤­ï");
        return CM_CANCEL;
        end;
     end;
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*‚ëå®¤ ¨§ ¤¨ «®£®¢®£® ®ª­  ä®à¬¨à®¢ ­¨ï ®âç¥â */
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*‚ë¡®à ¤ ­­ëå ¨§ á¯¨áª */
     elif ( KEY == KEY_F3)
        /*‚ë¡®à ¯®¤à §¤¥«¥­¨ï ¡ ­ª  ¨§ á¯¨áª  ¯®¤à §¤¥«¥­¨© */
        if (FldName(dlg,id) == "Race")
              m = menu(mn,"‚ë¡¥à¨â¥ ­®¬¥à à¥©á ", "‚ë¡¥à¨â¥ ­®¬¥à à¥©á ", null, null, 0);
              if (m >= 0)
              dlg.rec.race = mn(m);
              message(" ~F3~ ‚ë¡®à áå¥¬ë à áç¥â®¢ "+const_mess);
              UpdateFields(dlg);
              else
              UpdateFields(dlg);
              end;
        end;
        /*‚ë¡®à ¤ âë ¨§ ª «¥­¤ àï*/
        if (FldName(dlg,id) == "ReportDate")
          dlg.rec.ReportDate = GetDateByCalendar ({curDate});
        end;
        
     elif (KEY == KEY_SPACE)
          /*‘¡à®á ãáâ ­®¢®ª ¢ ¯®«¥ ®ä¨á ¡ ­ª */
          if (FldName(dlg,id) == "Race") 
            dlg.rec.race="‚á¥ à¥©áë";
            UpdateFields(dlg);
          end;
     elif (( KEY == KEY_F2 )  or ( KEY == KEY_ENTER ))         //à®¢¥àª¨ ¯à¨ ¢¢®¤¥
         if ( dlg.rec.ReportDate > {curdate} )
                MsgBox("„ â  ­ ç «  ¯¥à¨®¤  ­¥ ¬®¦¥â ¡ëâì ¡®«ìè¥ ¤ âë â¥ªãé¥£® ®¯¥à æ¨®­­®£® ¤­ï");
                return CM_IGNORE;
         end;
        ReportDate  = dlg.rec.ReportDate;
        Race=dlg.rec.race;
           Return CM_SAVE;
      else
           Return CM_IGNORE;
     end;
   end;
        
END;

/*’®çª  ¢å®¤  ¢ ¬ ªà®á*/
if (RunDialog(dlg, "Event"))
  OutAll;
end;

end;
