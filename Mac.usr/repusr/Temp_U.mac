/*  Бланки уточнений платежных поручений                                   */
/*  Тихомиров А.Н.                                                         */
/*  25.06.2012 C-8799-6 AAN   см. ТЗ к модификации если в краце то менял   */
/*   шаблоны и чутка макрос: названия пунктов меню и сумма прописью        */
//zmp 05.02.2013 I-00321525-2 Сделал пересылку шаблона на терминал
/* VV 17.04.13 C-18944 новый бланк "Уточнение Судьбы денежных средств "*/
// KS 22.11.2013 Предварительная адаптация под 31ю сборку
//11.12.2014 C-26655 DPN Добавил бланки ССП

import globals, oralib, likepy, WordIntf,rsexts, prpm;
import RsbDataset, PTInter, BankInter;
import "fg_Life_parm.mac";  

var RegParam, temppath, Templ, WordApp, WordDoc;         //  AAN
private const fdBank = fg_life_subject({OurBank});        //  AAN
debugbreak;
private macro INN(Pinn)
 var inn1, kpp1; 
  splitfulliNN(Pinn, inn1, kpp1);
 return inn1;
end;

private macro CreateWordApplication()

var startAX, WordApplication;

  if (isStandAlone())
     return ActiveX("Word.Application");
  else
     startAX = CreateObject("rsax", "TRsAxServer", "LoansAxServer", isStandalone());
     WordApplication = startAX.CreateComObject("Word.Application");
     WordApplication.Visible = true;
     return WordApplication;
  end;

end;

private macro ShowReportOnTerminal( WordApp, WordDoc )
  
  var DocFileName : string, TermFileName : string;

  DocFileName = SplitFile( GetTxtFileName("") );

  DocFileName = MergeFile( DocFileName, "fm_prn_" + string(UserNumber), ".doc" );

  DocFileName = MergeFile( GetCurDir(), DocFileName );

  WordApp.visible = true; 
end;  

private macro GetOperName(NumOper:integer):string     //AAN
var sl = "SELECT t_name FROM dperson_dbt "+
          "WHERE t_oper = "+NumOper+"";
var dataS = TRsbDataSet(sl);;
 while(DataS.moveNext())
   return DataS.name;
 end;
 return "";  
end;

private macro Месяц(num)
   if (num == 1)
      return "Января";
   elif (num == 2)
      return "Февраля";
   elif (num == 3)
      return "Марта";
   elif (num == 4)
      return "Апреля";
   elif (num == 5)
      return "Мая";
   elif (num == 6)
      return "Июня";
   elif (num == 7)
      return "Июля";
   elif (num == 8)
      return "Августа";
   elif (num == 9)
      return "Сентября";
   elif (num == 10)
      return "Октября";
   elif (num == 11)
      return "Ноября";
   elif (num == 12)
      return "Декабря";
   end;
end;

macro PrintBlank(Payment)
   array m;
   if ( fdBank.is_PRBB )                                //  AAN
      m(0) = "Бланк изменения назначения платежа";
      m(1) = "Бланк изменения счета получателя";
      m(2) = "Бланк изменения реквизитов получателя";    //  AAN было  "Бланк изменения наименования получателя";
      m(3) = "Бланк изменения наименования получателя";       //  AAN было  "Бланк изменения получателя платежа";
      m(4) = "Бланк возврата платежного поручения ";
      m(5) = "Бланк уточнения судьбы денежных средств";  //VV 17.04.13 C-18944 новый бланк "Уточнение Судьбы денежных средств "
   else
      m(0) = "Бланк изменения назначения платежа";
      m(1) = "Бланк изменения счета получателя";
      m(2) = "Бланк изменения наименования получателя";
      m(3) = "Бланк изменения получателя платежа";
      m(4) = "Бланк возврата платежного поручения ";
      m(5) = "Бланк уточнения судьбы денежных средств";  //VV 17.04.13 C-18944 новый бланк "Уточнение Судьбы денежных средств "
   end;

   var blnk, dat, month, year;
   blnk = menu(m,"Выберите бланк");
   if ( fdBank.is_PRBB )
      if (blnk == 0)
        Templ = "Ground_Temp_new.dot";
      elif (blnk == 1)
        Templ = "Rec_Temp_new.dot";
      elif (blnk == 2)
        Templ = "RecAll_Temp_new.dot";
      elif (blnk == 3)
        Templ = "RecName_Temp_new.dot";
      elif (blnk==4)
        Templ = "Turn_Temp_new.dot";
      elif (blnk==5)
         Templ = "Rec_DENSR_new.dot" //VV 17.04.13 C-18944 новый бланк "Уточнение Судьбы денежных средств "
      else  
      end;
   else
      if (blnk == 0)
        Templ = "Ground_Temp.dot";
      elif (blnk == 1)
        Templ = "Rec_Temp.dot";
      elif (blnk == 2)
        Templ = "RecAll_Temp.dot";
      elif (blnk == 3)
        Templ = "RecName_Temp.dot";
       elif (blnk == 4)
        Templ = "Turn_Temp.dot";
       elif (blnk==5)
        Templ = "Rec_DENSR.dot"  //VV 17.04.13 C-18944 новый бланк "Уточнение Судьбы денежных средств "
       else
       end;
   end;
   /*zmp 05.02.2013 I-00321525-2 Сделал через вызов ф-ции Check_templ() -->*/
   /*      GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,RegParam);
       temppath = findpath(Templ,RegParam);
         if (not temppath)
           msgbox("Не найдена LBR");
        exit();*/
    
   temppath = Check_templ(Templ);
  
   /*<-- zmp 05.02.2013 I-00321525-2*/
   WordApp = CreateWordApplication();
   datesplit({curdate}, dat, month, year);
   if( WordApp )
      WordDoc = WordApp.Documents.Add( temppath );
      if( WordDoc )
         /*Общее для всех шаблонов*/
         WordDoc.Bookmarks("curdate").Range.Text       =  dat;
         WordDoc.Bookmarks("curmonth").Range.Text      =  Месяц(month);
         WordDoc.Bookmarks("curyear").Range.Text       =  year;
         WordDoc.Bookmarks("bic").Range.Text           =  payment.ReceiverBankCode;
         WordDoc.Bookmarks("date").Range.Text          =  payment.Valuedate;
         WordDoc.Bookmarks("nameacc").Range.Text       =  payment.PayerName;
         WordDoc.Bookmarks("nameb").Range.Text         =  payment.ReceiverBankName;
         WordDoc.Bookmarks("number").Range.Text        =  payment.Number;
         WordDoc.Bookmarks("sum").Range.Text           =  string(payment.payerAmount:f,"  руб.");
         if ( fdBank.is_PRBB )
            WordDoc.Bookmarks("oper").Range.Text       =  GetOperName({oper});
            WordDoc.Bookmarks("prop").Range.Text       =  string(" ", payment.payerAmount:m, " ") ; 
         end;
         if (blnk != 4)
            WordDoc.Bookmarks("account").Range.Text       =  payment.payeraccount;
         end;
         /*Уникальные поля шаблонов*/ debugbreak;
         if (blnk == 0)
            WordDoc.Bookmarks("accdt").Range.Text         =  payment.payeraccount;
            WordDoc.Bookmarks("acckt").Range.Text         =  payment.receiveraccount;
         elif (blnk == 4)                                            
           WordDoc.Bookmarks("inn").Range.Text           =  INN(payment.payerINN);
           WordDoc.Bookmarks("nameR").Range.Text         =  payment.ReceiverName;
           WordDoc.Bookmarks("inn2").Range.Text          =  INN(payment.payerINN);
           WordDoc.Bookmarks("account").Range.Text       =  payment.ReceiverAccount;
           WordDoc.Bookmarks("account2").Range.Text      =  payment.PayerAccount;
           if(fdBank.is_PRBB)
            WordDoc.Bookmarks("nam_pl").Range.Text      =  payment.PayerName;
           end;
         elif(blnk==5) //VV 17.04.13 C-18944 новый бланк "Уточнение Судьбы денежных средств "
           WordDoc.Bookmarks("Name_pol").Range.Text         =  payment.ReceiverName;
           WordDoc.Bookmarks("Account_pol").Range.Text       =  payment.ReceiverAccount;
           if(not fdBank.is_PRBB)
            WordDoc.Bookmarks("oper").Range.Text       =  GetOperName({oper});
            WordDoc.Bookmarks("prop").Range.Text       =  string(" ", payment.payerAmount:m, " ") ;          
           end;
         end;
        if( IsStandAlone() )
          WordApp.Visible = TRUE;
        else
          ShowReportOnTerminal( WordApp, WordDoc );
        end; 
      end; /*if( WordDoc )*/
    end;/*if( WordApp )*/
end;

// DPN         05.12.2014 C-26655 - Добавил бланки ССП
macro QSortProc(rec1, rec2):integer
   if (rec1.PayDate < rec2.PayDate)
      return -1;
   elif (rec1.PayDate > rec2.PayDate)
      return +1;
   end;
   return 0;     
END;

macro PrintBlankSSP(Payment)
    array m;
    var partPayList :TPartPayList;
    var table:object;
    var i = 0, flag_p = 0, flag_ik = 0;  //flag_p = 1 - номер и дата постановления записана в кэш, flag_ik = 1 - номер и/п записан в кэш
    
    partPayList = TPartPayList(payment.paymentID);
    
    m(0) = "Бланк-письмо в ССП К2";
    m(1) = "Бланк-письмо в ССП К2 и ч\\о";
    m(2) = "Бланк-письмо в ССП оплата";
    m(3) = "Бланк-письмо в ССП розыск, К2 и ч\\о";
    m(4) = "Бланк-письмо в ССП розыск, К2 ";
    m(5) = "Бланк-письмо в ССП розыск, оплата";
    m(6) = "Бланк-письмо в ССП отзыв";

    var blnk, dat, month, year;
    blnk = menu(m,"Выберите бланк");
    if (blnk == 0)
      Templ = "form_letter_K2.dot";
    elif (blnk == 1)
      Templ = "form_letter_K2_co.dot";
    elif (blnk == 2)
      Templ = "form_letter_paym.dot";
    elif (blnk == 3)
      Templ = "form_letter_search_K2_co.dot";
    elif (blnk==4)
      Templ = "form_letter_search_K2.dot";
    elif (blnk==5)
      Templ = "form_letter_search_paym.dot";
    elif (blnk==6)
       Templ = "form_letter_cansel.dot";
    else  
    end;

    temppath = Check_templ(Templ);
  //11.12.2014 DPN проверка на дату
    macro checkDate(str)
        var d = date (substr(str,1,10));
        if (d != "")
           return True;
        else
           return False;
        end;
    end;
    //11.12.2014 DPN Проверка на номер
    macro checkNum(str)
       if((strbrk(str, "№")>0) or (trim(str) == "б\\н") or (trim(str) == "б/н") )
           return true;
       else
           return False;
       end;
   end;

    WordApp = CreateWordApplication();
    datesplit({curdate}, dat, month, year);
    if( WordApp )
       WordDoc = WordApp.Documents.Add( temppath );
       if( WordDoc )
       debugbreak;
          /*Общее для всех шаблонов*/
          //Gurin S. 22.04.2015 R-574271-2
          if (not fdBank.is_VUZ)
             WordDoc.Bookmarks("curday").Range.Text        =  dat;
             WordDoc.Bookmarks("curmonth").Range.Text      =  Месяц(month);
             WordDoc.Bookmarks("curyear").Range.Text       =  year;
          end;          

          WordDoc.Bookmarks("payName").Range.Text       =  payment.PayerName;
          WordDoc.Bookmarks("recName").Range.Text       =  payment.ReceiverName;
          
          WordDoc.Bookmarks("payDate").Range.Text       =  payment.payDate;
          WordDoc.Bookmarks("payNum").Range.Text        =  payment.Number;

          WordDoc.Bookmarks("sum").Range.Text           =  string(payment.payerAmount:f);
          WordDoc.Bookmarks("oper").Range.Text          =  GetOperName({oper});
          WordDoc.Bookmarks("account").Range.Text       =  payment.payeraccount;
          WordDoc.Bookmarks("inn").Range.Text           =  INN(payment.payerINN);

         var arGround , grNew = "", num = "                ", datePos = "                    ";
         
         //11.12.2014 DPN Разбивает назначение платежа на массив по словам и вытягивает инфу для бланка
         if( (SubStr(payment.receiveraccount, 1 , 5) == "40302"))              
             arGround = split(trim(payment.ground)," ");
             debugbreak;
             i = 0;
             for(i,1, arGround.size)
                 if((checkNum(arGround(i))) )
                     if ( not SubStr(arGround(i), 2))
                         i = i+ 1;
                         debugbreak;
                    end;
                     if (flag_p == 0)
                         num = arGround(i);
                     else
                         if ( flag_ik == 0)
                             grNew = grNew + " к и/п " + arGround(i);
                         else
                             grNew = grNew + " " + arGround(i);
                         end;
                         flag_ik = 1;
                     end;
                 end;
                 if (checkDate(arGround(i)))
                     if (flag_p == 0)
                         grNew = grNew + (arGround(i));
                     else
                         if (flag_ik == 1)
                             grNew = grNew + " от " + (arGround(i));
                         else
                             grNew = grNew + " к и/п от " + (arGround(i));
                         end;
                         flag_ik = 1;
                         i = arGround.size;
                     end;
                     flag_p = 1;
                 end;
                 
             end;
             datePos = grNew;
         end; 
         WordDoc.Bookmarks("num").Range.Text = num;
         WordDoc.Bookmarks("datePos").Range.Text = datePos;

         if ((blnk == 1) or (blnk == 3))
             if((partPayList != null) and (partPayList.size > 0))
                 QSort(partPayList, @QSortProc);
                 WordDoc.Bookmarks("payNum2").Range.Text        =  payment.Number;
                 WordDoc.Bookmarks("payDatePart").Range.Text = string(partPayList.Value(0).PayDate:f);
                 WordDoc.Bookmarks("sumPart").Range.Text = string(partPayList.Value(0).Amount:f);
             end;
         end;
         if (blnk == 2)
             WordDoc.Bookmarks("payDate2").Range.Text       =  payment.payDate;
         end;
         
         if (blnk == 3)
             
             WordDoc.Bookmarks("inn2").Range.Text           =  INN(payment.payerINN);
             WordDoc.Bookmarks("payName2").Range.Text           =  payment.PayerName;
             WordDoc.Bookmarks("date").Range.Text       =  {curdate};
             WordDoc.Bookmarks("rest").Range.Text = restA(payment.payeraccount);
         end;
         
         if (blnk == 4)
             WordDoc.Bookmarks("inn2").Range.Text           =  INN(payment.payerINN);
             WordDoc.Bookmarks("payName2").Range.Text           =  payment.PayerName;
             WordDoc.Bookmarks("date").Range.Text       =  {curdate};
         end;
         if(blnk == 5)
             WordDoc.Bookmarks("payDate2").Range.Text       =  payment.payDate;
             WordDoc.Bookmarks("inn2").Range.Text           =  INN(payment.payerINN);
             WordDoc.Bookmarks("payName2").Range.Text           =  payment.PayerName;
             WordDoc.Bookmarks("date").Range.Text       =  {curdate};
         end;
         if (blnk == 6)
             WordDoc.Bookmarks("date").Range.Text       =  {curdate};
         end;
          
         if( IsStandAlone() )
           WordApp.Visible = TRUE;
         else
           ShowReportOnTerminal( WordApp, WordDoc );
         end; 
       end; /*if( WordDoc )*/
     end;/*if( WordApp )*/
end;
