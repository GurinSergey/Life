/*Журнал межбанковский операций                              */
/*                                                           */
/*                                                           */
/*Тихомиров А.Н. 31.02.2009              Версия 1.0          */

import RSD, rcw, rslx, Календарь, rsbdataset, bankinter, globals;
var sql, dataset, inter, f1, f2, branch, reportdate, maxs:integer, total:integer, n:integer, dprt_v;

const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;

record Department ("dp_dep.dbt");
var Fulloutputl, outl, outputl="mbo.lbr";                    
//var Fulloutput, out, output="\mbo.txt";                    
var fulloutput = GetTxtFileName("mbo");

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("mbo", fulloutputl, TRUE); 

private macro GetNameoper(id)
var  sl="select t_name from dperson_dbt where t_oper="+id ;
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.name;
  else
    msgbox("Субъект не найден в party.dbt");
    return 0;
  end;
END;


private macro dep(id)
var sl, rs, fl=0;
 while (fl==0)
   sl ="SELECT dep.t_code "
       " FROM dobjcode_dbt obj, ddp_dep_dbt dep, dparty_dbt party "
       " WHERE obj.t_objectid = dep.t_partyid "
       "  AND obj.t_codekind = 3 "
       "  AND party.t_partyid = dep.t_partyid "
       "  AND dep.t_code = "+id;
   rs = TRsbDataSet( sl);
    if ( rs.moveNext() )
     return rs.code;
    else
     sl ="SELECT t_parentcode "
         " FROM ddp_dep_dbt "
         "  where t_code = "+id;
     rs = TRsbDataSet( sl);
       if ( rs.moveNext() )
         id=rs.parentcode;
       else
         return 0;
       end;
    end;
 end;
end;

/*Найдем имя по коду*/
private macro GetClientNameID(id)
var  sl=" select dep.t_name from  ddp_dep_dbt dep where dep.t_code="+id;
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.name;
  else
    msgbox("Субъект не найден в party.dbt");
    return 0;
  end;
END;

/*Найдем имя по Partyid*/
private macro GetClientName(id)
var  sl=" select part.t_name from dparty_dbt part, ddp_dep_dbt dep where dep.t_code="+id+" and dep.t_partyid=part.t_partyid";
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.name;
  else
    if (id !=0)
       msgbox("Субъект не найден в party.dbt");
       return 0;
    else
      return "ОАО АКБ Пробизнесбанк";
    end;
  end;
END;

private macro printall (data)
[│#########│####################│#####################│################│##│##### #########################│########################################│]
(data.numb_document,data.account_payer,data.account_receiver,data.sum,data.kind_oper,data.oper, getnameoper(data.oper),data.ground);
end;

private macro outall(inter)
var in;
 if (inter=="")
   in =   " AND (   daccount"+inter+"_dbt.t_type_account NOT LIKE '%П%' "+
          "      AND daccount"+inter+"_dbt.t_type_account NOT LIKE '%Н%' "+
          "      AND daccount"+inter+"_dbt.t_type_account NOT LIKE '%U%' "+
          "     ) ";
 else
  in = "";
end;
 /*
sql = "SELECT /*+ INDEX_JOIN(DACCOUNT_DBT) */ count (*) as cnt "+
  " FROM daccount"+inter+"_dbt, "+
  "     darhdoc"+inter+"_dbt "+
  " WHERE (   daccount"+inter+"_dbt.t_account LIKE '30102%' "+
  "      OR daccount"+inter+"_dbt.t_account LIKE '30110%' "+
  "      OR daccount"+inter+"_dbt.t_account LIKE '30114%' "+
  "     ) "+
  " AND (   daccount"+inter+"_dbt.t_open_close != 'З' "+
  "      OR daccount"+inter+"_dbt.t_close_date > '"+reportdate+"' "+
  "     ) "+
  " AND daccount"+inter+"_dbt.t_department =  "+dep(branch)+
  in+
  " AND (   darhdoc"+inter+"_dbt.t_account_receiver = daccount"+inter+"_dbt.t_account "+
  "      OR darhdoc"+inter+"_dbt.t_account_payer = daccount"+inter+"_dbt.t_account "+
  "     ) ";
dataset = trsbdataset(sql);
if (dataset.movenext())
maxs=dataset.cnt;
end;
initprogress(maxs,"Ждите, обрабатываются счета...","Ждите, обрабатываются счета");
                  */
//GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR",2,out);
//fulloutput=out+output;
//setoutput(fulloutput,false);
                  
initprogress(-1,"Ждите, обрабатываются счета...","Ждите, обрабатываются счета");
[                                                             Журнал операций

                                                       Управление финансовых операций
                                               Отдел учета и контроля межбанковских операций
                                                                за ##########
Валютные документы по дебету счетов НОСТРО
┌─────────┬────────────────────┬─────────────────────┬────────────────┬──┬───────────────────────────────┬────────────────────────────────────────┐
│ № док.  │     Сч. Дебет      │     Сч. Кредит      │       Сумма    │ВО│       Операционист            │     Основание                          │
├─────────┼────────────────────┼─────────────────────┼────────────────┼──┼───────────────────────────────┼────────────────────────────────────────┤]
(date(reportdate));

total=0;

sql = "SELECT  darhdoc"+inter+"_dbt.t_numb_document, darhdoc"+inter+"_dbt.t_account_payer, "+
      " darhdoc"+inter+"_dbt.t_account_receiver, darhdoc"+inter+"_dbt.t_sum, "+
      " darhdoc"+inter+"_dbt.t_kind_oper, darhdoc"+inter+"_dbt.t_oper, darhdoc"+inter+"_dbt.t_ground "+
  "FROM daccount"+inter+"_dbt, "+
   "    darhdoc"+inter+"_dbt, "+
   "    dperson_dbt "+
 "WHERE (   daccount"+inter+"_dbt.t_account LIKE '30102%' "+
  "      OR daccount"+inter+"_dbt.t_account LIKE '30110%' "+
  "      OR daccount"+inter+"_dbt.t_account LIKE '30114%' "+
  "     ) "+
  " AND (   daccount"+inter+"_dbt.t_open_close = chr(0) "+
  "      OR daccount"+inter+"_dbt.t_close_date > TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
  "     ) "+
  " AND daccount"+inter+"_dbt.t_department = "+dep(branch)+
  in+
  " AND (   darhdoc"+inter+"_dbt.t_account_payer = daccount"+inter+"_dbt.t_account "+
  "     ) "+
  " AND darhdoc"+inter+"_dbt.t_date_carry = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
//  " AND darhdoc"+inter+"_dbt.t_date_value = '"+reportdate+"' "+
  " AND dperson_dbt.t_codedepart =  "+branch+
  " AND (   darhdoc"+inter+"_dbt.t_oper = dperson_dbt.t_oper   ) "+
  " order by daccount"+inter+"_dbt.t_code_currency, darhdoc"+inter+"_dbt.t_sum ";
dataset = trsbdataset(sql);
 while (dataset.movenext())
  total=total+1;
  useprogress(total);
  printall (dataset);
 end;


sql = "SELECT  darhdoc"+inter+"_dbt.t_numb_document, darhdoc"+inter+"_dbt.t_account_payer, "+
      " darhdoc"+inter+"_dbt.t_account_receiver, darhdoc"+inter+"_dbt.t_sum, "+
      " darhdoc"+inter+"_dbt.t_kind_oper, darhdoc"+inter+"_dbt.t_oper, darhdoc"+inter+"_dbt.t_ground "+
  "FROM daccount"+inter+"_dbt, "+
   "    darhdoc"+inter+"_dbt, "+
   "    dpmpaym_dbt, "+
   "    dpmdocs_dbt, "+
   "    dperson_dbt per,"+
   "    dperson_dbt pers"+
 " WHERE (   daccount"+inter+"_dbt.t_account LIKE '30102%' "+
  "      OR daccount"+inter+"_dbt.t_account LIKE '30110%' "+
  "      OR daccount"+inter+"_dbt.t_account LIKE '30114%' "+
  "     ) "+
  " AND (   daccount"+inter+"_dbt.t_open_close = chr(0) "+
  "      OR daccount"+inter+"_dbt.t_close_date > TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
  "     ) "+
  " AND daccount"+inter+"_dbt.t_department = "+dep(branch)+
  in+
  " AND (   darhdoc"+inter+"_dbt.t_account_payer = daccount"+inter+"_dbt.t_account "+
  "     ) "+
  " AND dpmdocs_dbt.t_applicationkey = darhdoc"+inter+"_dbt.t_applicationkey "+
  " AND dpmdocs_dbt.t_paymentid = dpmpaym_dbt.t_paymentid "+
  " AND dpmpaym_dbt.t_dockind IN (16, 17, 27, 15, 70, 74) "+
  " AND darhdoc"+inter+"_dbt.t_date_carry = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
//  " AND darhdoc"+inter+"_dbt.t_date_value = '"+reportdate+"' "+
  " AND per.t_codedepart !=  "+branch+
  " AND pers.t_codedepart =  "+branch+
//  " AND (   darhdoc"+inter+"_dbt.t_oper = per.t_oper "+
//  "      AND dpmpaym_dbt.t_oper = pers.t_oper "+
  " AND (  dpmpaym_dbt.t_oper = pers.t_oper )"+  // Платеж проверяем
  " AND (  dpmpaym_dbt.t_oper = per.t_oper "+  // Платеж проверяем

  "     ) order by daccount"+inter+"_dbt.t_code_currency, darhdoc"+inter+"_dbt.t_sum";

dataset = trsbdataset(sql);
 while (dataset.movenext())
  total=total+1;
  useprogress((total));
  printall (dataset);
 end;

[└─────────┴────────────────────┴─────────────────────┴────────────────┴──┴───────────────────────────────┴────────────────────────────────────────┘
Всего документов ###########]
(total);



[Валютные документы по кредиту счетов НОСТРО
┌─────────┬────────────────────┬─────────────────────┬────────────────┬──┬───────────────────────────────┬────────────────────────────────────────┐
│ № док.  │     Сч. Дебет      │     Сч. Кредит      │       Сумма    │ВО│       Операционист            │     Основание                          │
├─────────┼────────────────────┼─────────────────────┼────────────────┼──┼───────────────────────────────┼────────────────────────────────────────┤]
(date(reportdate));
n=total;
total=0;
sql = "SELECT darhdoc"+inter+"_dbt.t_numb_document, darhdoc"+inter+"_dbt.t_account_payer, "+
"       darhdoc"+inter+"_dbt.t_account_receiver, darhdoc"+inter+"_dbt.t_sum, "+
"       darhdoc"+inter+"_dbt.t_kind_oper, darhdoc"+inter+"_dbt.t_oper, darhdoc"+inter+"_dbt.t_ground "+
"  FROM daccount"+inter+"_dbt, "+
"       darhdoc"+inter+"_dbt, "+
"       dperson_dbt "+
" WHERE (   daccount"+inter+"_dbt.t_account LIKE '30102%' "+
"        OR daccount"+inter+"_dbt.t_account LIKE '30110%' "+
"        OR daccount"+inter+"_dbt.t_account LIKE '30114%' "+
"       ) "+
"   AND (   daccount"+inter+"_dbt.t_open_close = chr(0) "+
"        OR daccount"+inter+"_dbt.t_close_date > TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
"       ) "+
"   AND daccount"+inter+"_dbt.t_department = "+dep(branch)+
  in+
"   AND (darhdoc"+inter+"_dbt.t_account_receiver = daccount"+inter+"_dbt.t_account "+
"       ) "+
"   AND darhdoc"+inter+"_dbt.t_date_carry = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
//"   AND darhdoc"+inter+"_dbt.t_date_value = '"+reportdate+"' "+
"   AND dperson_dbt.t_codedepart = "+branch+
"   AND (   darhdoc"+inter+"_dbt.t_oper = dperson_dbt.t_oper "+
"       ) order by daccount"+inter+"_dbt.t_code_currency, darhdoc"+inter+"_dbt.t_sum";

dataset = trsbdataset(sql);
 while (dataset.movenext())
  total=total+1;
  useprogress((total+n));
  printall (dataset);
 end;

sql = "SELECT darhdoc"+inter+"_dbt.t_numb_document, darhdoc"+inter+"_dbt.t_account_payer, "+
"       darhdoc"+inter+"_dbt.t_account_receiver, darhdoc"+inter+"_dbt.t_sum, "+
"       darhdoc"+inter+"_dbt.t_kind_oper, darhdoc"+inter+"_dbt.t_oper, darhdoc"+inter+"_dbt.t_ground "+
"  FROM daccount"+inter+"_dbt, "+
"       darhdoc"+inter+"_dbt, "+
"       dpmpaym_dbt, "+
"       dpmdocs_dbt, "+
"       dperson_dbt pers,"+
"       dperson_dbt per"+
" WHERE (   daccount"+inter+"_dbt.t_account LIKE '30102%' "+
"        OR daccount"+inter+"_dbt.t_account LIKE '30110%' "+
"        OR daccount"+inter+"_dbt.t_account LIKE '30114%' "+
"       ) "+
"   AND (   daccount"+inter+"_dbt.t_open_close = chr(0) "+
"        OR daccount"+inter+"_dbt.t_close_date > TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
"       ) "+
"   AND daccount"+inter+"_dbt.t_department = "+dep(branch)+
  in+
"   AND (darhdoc"+inter+"_dbt.t_account_receiver = daccount"+inter+"_dbt.t_account "+
"       ) "+
"   AND dpmdocs_dbt.t_applicationkey = darhdoc"+inter+"_dbt.t_applicationkey "+
"   AND dpmdocs_dbt.t_paymentid = dpmpaym_dbt.t_paymentid "+
"   AND dpmpaym_dbt.t_dockind IN (16, 17, 27, 15, 70, 74) "+
"   AND darhdoc"+inter+"_dbt.t_date_carry = TO_DATE ('"+reportdate+"', 'DD-MM-YYYY') "+
//"   AND darhdoc"+inter+"_dbt.t_date_value = '"+reportdate+"' "+
  " AND per.t_codedepart !=  "+branch+
  " AND pers.t_codedepart = "+branch+
//  " AND (   darhdoc"+inter+"_dbt.t_oper = per.t_oper "+
//  "      and dpmpaym_dbt.t_oper = pers.t_oper "+
  " AND (  dpmpaym_dbt.t_oper = pers.t_oper )"+   //Платеж проверяем
  " AND (  dpmpaym_dbt.t_oper = per.t_oper "+   //Платеж проверяем

  "     ) order by daccount"+inter+"_dbt.t_code_currency, darhdoc"+inter+"_dbt.t_sum";
dataset = trsbdataset(sql);
 while (dataset.movenext())
  total=total+1;
  useprogress((total+n));
  printall (dataset);
 end;

[└─────────┴────────────────────┴─────────────────────┴────────────────┴──┴───────────────────────────────┴────────────────────────────────────────┘
Всего документов ###########



                       Главный бухгалтер  __________________________________

          Управление финансовых операций

       Начальник Отдела учета и контроля  
                  межбанковских операций  _____________________________

                               Контролер  __________________________]
(total);

remprogress((total+n));
end;

 /*Обработчик диалоговой панели ввода исходных данных для печати*/
MACRO Event (dlg, cmd, id, key) 

   var const_mess = "~F2~ Продолжить ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dprt_v = 0;
      dlg.rec.F1  = "";
      dlg.rec.F2  = "X";
      dlg.rec.reportDate = {curDate};
      dlg.rec.Branch = getclientnameid({operdprt});
      dlg.rec.branchname = GetClientName({operdprt});
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     if ((FldName(dlg,id)=="F1") or (FldName(dlg,id)=="F2"))
       message(const_mess2);
     elif (FldName(dlg,id)=="ReportDate")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="Branch")
       message(" ~F3~ Выбор филиала "+const_mess);
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
     if (FldName(dlg,id) == "ReportDate")
       if ( dlg.rec.reportDate > {curdate} )
         MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       end;
     end;
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "ReportDate")
          dlg.rec.reportdate = GetDateByCalendar ({curDate});
        end;
        if (FldName(dlg,id) == "Branch")
           if (ListDepartment (Department))
              dlg.rec.branch = Department.name;
              dprt_v = department.code;
              dlg.rec.branchname = GetClientName(Department.code);
              message(" ~F3~ Список подразделений "+const_mess);
              UpdateFields(dlg);
           end;
        end;

        
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
           if (FldName(dlg,id) == "F1") 
            if (dlg.rec.f1=="")
            dlg.rec.f1="X";
            dlg.rec.f2="";
            UpdateFields(dlg);
            else
            dlg.rec.f1="";
            dlg.rec.f2="X";
             UpdateFields(dlg);
           end;
           elif (FldName(dlg,id) == "F2")
            if (dlg.rec.f2=="")
            dlg.rec.f2="X";
            dlg.rec.f1="";
            UpdateFields(dlg);
            else
            dlg.rec.f2="";
            dlg.rec.f1="X";
            UpdateFields(dlg);
            end;
           end;

     elif (( KEY == KEY_F2 ) or ( KEY == KEY_ENTER ))        //Проверки при вводе
         if ( dlg.rec.Reportdate > {curdate} )
                MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
                return CM_IGNORE;
         end;
        reportDate  = dlg.rec.reportdate;
        f1=dlg.rec.f1;
        f2=dlg.rec.f2;
        branch=dprt_v;
         if ((reportdate < {curDate}))    
           Return CM_SAVE;
        elif (gettrue(true,"Дата равна текущему опрерационному дню. Продолжить?"))
           Return CM_SAVE;
        end;
      else
           Return CM_IGNORE;
     end;
   end;     
END;

//private macro total
 if (RunDialog(dlg, "Event"))                  
//GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR",2,out);
//Fulloutput = out + output;                    
//setoutput(fulloutput,false);                                                                                         
  if (f1=="X")
    inter ="";
  else
    inter ="$";
  end;
  outall(inter);
  SetOutput (Null,True);
//  ViewFile(fulloutput);
 end;
END;


