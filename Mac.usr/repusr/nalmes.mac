/*R-Style Ukraine, Kiev */            
/*Автор Новиков С. С. */
/*28.08.2008 15:00:00*/
/*15.09.2008*/
/*Сообщения налоговым органам*/
/*ВНИМАНИЕ! Процедура нуждается в апробировании на рабочем стенде Пробизнеса с целью определения дефектных случаев.*/
/*Процедура формирования сообщений по открытым/закрытым счетам (номер, наименование, дата сообщения).
  В процедуру передаються два формальных параметра извне. 
  Первый параметр - acc (номер клиентского счета)*/
import oralib; 

Macro Nal (acc);
  var select:string = "";
  var rs0:object = null;
  var rs1:object = null;
  var rs2:    object = null;
  
  var OpenMesID = 0;
  var OpenMesName = "";
  var OpenMesNumb = "";
  var OpenMesDate = "";

  var CloseMesID = 0;
  var CloseMesName = "";
  var CloseMesNumb = "";
  var CloseMesDate = "";
  
  var ArrVal = TArray();
 
  /*------------------------------------------*/
  /* Отбираем ID сообщения открытия счета acc */
  select = " select ttt.t_mesid " +
           " from (dwlmesrls_dbt t inner join " +
           "       dwlmes_dbt tt on " +
           "       (tt.t_rlsformid = t.t_rlsformid)) inner join " +
           "      dwlmesval_dbt ttt on " +
           "      (tt.t_mesid = ttt.t_mesid) " +
           " where t.t_formid = 130 and " +
           "       ttt.t_fieldid = 5528 and " +
           "       ttt.t_tpfieldid = 499 and " +
           "       ttt.t_value = '" + acc + "'";
  
  rs0 = ExecSQLSelect(select);
  if (rs0.MoveNext())
    OpenMesID = rs0.value("t_mesid");

    /* Название сообщения и номер сообщения */
    select = " select t.t_name, ttt.t_value " +
             " from (dwlmesrls_dbt t inner join " +
             "       dwlmes_dbt tt on " +
             "       (tt.t_rlsformid = t.t_rlsformid)) inner join " +
             "      dwlmesval_dbt ttt on " +
             "      (tt.t_mesid = ttt.t_mesid) " +
             " where ttt.t_mesid = " + OpenMesID + " and " +
             "       t.t_formid = 130 and " +
             "       ttt.t_fieldid = 5510 and " +
             "       ttt.t_tpfieldid = 496 ";
    rs1 = ExecSQLSelect(select);
    if (rs1.MoveNext())
      OpenMesName = rs1.value("t_name");
      OpenMesNumb = rs1.value("t_value");
    else
    
    end;

    /* Дата сообщения */
    select = " select ttt.t_value " +
             " from (dwlmesrls_dbt t inner join " +
             "       dwlmes_dbt tt on " +
             "       (tt.t_rlsformid = t.t_rlsformid)) inner join " +
             "      dwlmesval_dbt ttt on " +
             "      (tt.t_mesid = ttt.t_mesid) " +
             " where ttt.t_mesid = " + OpenMesID + " and " +
             "       t.t_formid = 130 and " +
             "       ttt.t_fieldid = 5531 and " +
             "       ttt.t_tpfieldid = 497 ";
    rs2 = ExecSQLSelect(select);
    if (rs2.MoveNext())
      OpenMesDate = rs2.value("t_value");
    else
   
    end;
  
  else
  
  end;
  
  /*------------------------------------------*/
  /* Отбираем ID сообщения закрытия счета acc */
  select = " select ttt.t_mesid " +
           " from (dwlmesrls_dbt t inner join " +
           "       dwlmes_dbt tt on " +
           "       (tt.t_rlsformid = t.t_rlsformid)) inner join " +
           "      dwlmesval_dbt ttt on " +
           "      (tt.t_mesid = ttt.t_mesid) " +
           " where t.t_formid = 134 and " +
           "       ttt.t_fieldid = 5553 and " + /*изменил номер с 5528 на 5553*/
           "       ttt.t_tpfieldid = 499 and " +
           "       ttt.t_value = '" + acc + "'";
  
  rs0 = ExecSQLSelect(select);
  if (rs0.MoveNext())
    CloseMesID = rs0.value("t_mesid");
    /*Название сообщения и номер сообщения */
    select = " select t.t_name, ttt.t_value " +
             " from (dwlmesrls_dbt t inner join " +
             "       dwlmes_dbt tt on " +
             "       (tt.t_rlsformid = t.t_rlsformid)) inner join " +
             "      dwlmesval_dbt ttt on " +
             "      (tt.t_mesid = ttt.t_mesid) " +
             " where ttt.t_mesid = " + CloseMesID + " and " +
             "       t.t_formid = 134 and " +
             "       ttt.t_fieldid = 5534 and " +  /* изменил номер с 5510 на 5534 */
             "       ttt.t_tpfieldid = 496 ";
    rs1 = ExecSQLSelect(select);
    if (rs1.MoveNext())
      CloseMesName = rs1.value("t_name");
      CloseMesNumb = rs1.value("t_value");
    else
    end;

    /* Дата сообщения */
    select = " select ttt.t_value " +
             " from (dwlmesrls_dbt t inner join " +
             "       dwlmes_dbt tt on " +
             "       (tt.t_rlsformid = t.t_rlsformid)) inner join " +
             "      dwlmesval_dbt ttt on " +
             "      (tt.t_mesid = ttt.t_mesid) " +
             " where ttt.t_mesid = " + CloseMesID + " and " +
             "       t.t_formid = 134 and " +
             "       ttt.t_fieldid = 5556 and " + /* изменил номер с 5531 на 5556 */
             "       ttt.t_tpfieldid = 497 ";
    rs2 = ExecSQLSelect(select);
    if (rs2.MoveNext())
      CloseMesDate = rs2.value("t_value");
    else
    
    end;
  
  else
  
  end;
  
  ArrVal[0] = OpenMesNumb;
  ArrVal[1] = OpenMesName;
  ArrVal[2] = OpenMesDate;
                                      
  
  ArrVal[3] = CloseMesNumb;
  ArrVal[4] = CloseMesName;
  ArrVal[5] = CloseMesDate;
  
  Return ArrVal;

END;




 

   