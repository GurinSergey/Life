/* Отчет по расчету количества расчетных операций ю\л банков  Группы Лайф 
   Ярмольчук А.Ю. по заявке A47354

   Отчет еще находится на тестировании у исполнителя!
*/

import rsd, rcw, Bankinter, "cb_sql.mac", globals;
import "FrontCommon.mac";
import lib_front;

const ЗАГРУЗКА=0;
const ВЫГРУЗКА=1;

const РУБЛИ   =0;
const ВАЛЮТА  =1;

class Отчет_по_количеству_операций

  var Виды_операций; /* Наименования видов операций, которые печатаются в отчет */
  var Наименование;  /* Наименование Банка для отчета */
  var PartyID     ;  /* PartyID банка или строка с PartyID нескольких банков, объединенных в группу */
  var CorrAcc     ;  /* Корсчет Банка */
  var Departments ;  /* Внутренние коды банков группы ЛАЙФ в ТС */
  var Наименование_size;


  var Prefix;        /* Имя схемы если данные текущего Банка находятся в одной схеме на той же БД. */
  var Postfix;       /* Наименование DBLINK если данные текущего Банка находятся на другой БД */ 
  var Строка;        /* Номер строки в отчете по текущей операции */
  var Столбец;       /* Имя столбца в отчете по текущему Банку */ 
  var output =  "rep_oper_cnt.xls"; /* Имя шаблона */

  var Начало_периода, Конец_периода;

  Виды_операций =TArray;
  Наименование  =Tarray;
  Строка        =TArray;
  Столбец       =Tarray;
  PartyID       =TArray;
  CorrAcc       =TArray;
  Departments   =TArray;
  Prefix        =TArray;
  Postfix       =TArray;

  Виды_операций (0) = "Платежные документы, поступившие по системе Интернет Клиент";
  Виды_операций (1) = "Операции расчета и проведения комиссий";
  Виды_операций (2) = "Операции конверсии";
  Виды_операций (3) = "Операции обработки Рейсов (Загрузка)";
  Виды_операций (4) = "Операции обработки Рейсов (Выгрузка)";
  Виды_операций (5) = "Учет картотеки 1 и 2";
  Виды_операций (6) = "Операции по корреспондентским счетам";
  Виды_операций (7) = "Управление остатками";
  Виды_операций (8) = "Операции по таможенным картам";
  Виды_операций (9) = "Овердрафт (погашение, выдача)";

  Строка (0) = 5;
  Строка (1) = 8;
  Строка (2) = 9;
  Строка (3) = 10;
  Строка (4) = 11;
  Строка (5) = 12;
  Строка (6) = 13;
  Строка (7) = 14;
  Строка (8) = 15;
  Строка (9) = 16;

  Наименование (0)="ПРББ";            Столбец (0)="B";   PartyID (0)="3045";          CorrAcc (0)="30102810500000000986";
  Наименование (1)="ИОБ";             Столбец (1)="C";   PartyID (1)="24809";         CorrAcc (1)="30102_задать";
  Наименование (2)="ЭВ-Саратов";      Столбец (2)="D";   PartyID (2)="22067";         CorrAcc (2)="30102_задать";
  Наименование (3)="ЭВ-Волгоград";    Столбец (3)="E";   PartyID (3)="21841";         CorrAcc (3)="30102_задать";
  Наименование (4)="ЭВ-Энгельс";      Столбец (4)="F";   PartyID (4)="81131";         CorrAcc (4)="30102_задать";
  Наименование (5)="ЭВ-Ульяновск";    Столбец (5)="G";   PartyID (5)="82458";         CorrAcc (5)="30102_задать";
  Наименование (6)="ЭВ-Воронеж";      Столбец (6)="H";   PartyID (6)="83051";         CorrAcc (6)="30102_задать";
  Наименование (7)="ВУЗ";             Столбец (7)="I";   PartyID (7)="21567";         CorrAcc (7)="30102_задать";
  Наименование (8)="ГЭБ";             Столбец (8)="J";   PartyID (8)="65771, 57634";  CorrAcc (8)="30102_задать";

  Prefix (0)="";                                      Postfix (0)=""; 
  Prefix (1)=""; /* Пример: Prefix (1)="Shema1."; */  Postfix (1)=""; /* Пример Postfix (1) = "@link" */
  Prefix (2)="";                                      Postfix (2)="";
  Prefix (3)="";                                      Postfix (3)="";
  Prefix (4)="";                                      Postfix (4)="";
  Prefix (5)="";                                      Postfix (5)="";
  Prefix (6)="";                                      Postfix (6)="";
  Prefix (7)="";                                      Postfix (7)="";
  Prefix (8)="";                                      Postfix (8)="";


  Наименование_size = Наименование.size;


  /* Макропроцедуры для расчета  требуемых количеств операций */
  macro Интернет_клиент (curr_bank, iscur)

    var acc_table, sql, rs, ret_val;


    ret_val=0;


    SQL = " SELECT count (*) ";
    SQL = SQL + "  FROM "+Prefix.(curr_bank)+"dpmpaym_dbt"+Postfix.(curr_bank)+" paym ";
    SQL = SQL + " WHERE paym.t_origin = 3 ";
    SQL = SQL + "   AND paym.t_valuedate BETWEEN "+ GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
    SQL = SQL + "   AND paym.t_dockind IN (201, 202, 320, 322) ";

    if (iscur==РУБЛИ)
     acc_table=+Prefix.(curr_bank)+"daccount_dbt"+Postfix.(curr_bank);
     SQL = SQL + "   AND paym.t_basefiid = 0 ";
    else
     acc_table=Prefix.(curr_bank)+"daccount$_dbt"+Postfix.(curr_bank);
     SQL = SQL + "   AND paym.t_basefiid > 0 ";
    end;

    SQL = SQL + "   AND 1 = ";
    SQL = SQL + "          (SELECT 1 ";
    SQL = SQL + "             FROM "+acc_table+" acc ";
    SQL = SQL + "            WHERE acc.t_chapter = paym.t_chapter ";
    SQL = SQL + "              AND acc.t_account = paym.t_payeraccount ";
    sql = sql + "              AND regexp_like ("+GetSQLString (PartyID.(curr_bank));
    sql = sql + "                               ,'(,|^)' || TO_CHAR (acc.t_client) || '(,|$)' ";
    sql = sql + "                              )) ";

    rs = SQL_ExecuteAndGetRs (sql);

    if (rs.movenext)
       ret_val=rs.value (0);
    end;

    return ret_val;

  end;

  macro Комиссии (curr_bank)

    var sql, rs, ret_val;

    ret_val=0;

    /* Выбираем удержанные комисиии по котором сформировано требование на оплату */
    SQL = " SELECT count (*) ";
    SQL = SQL + "  FROM "+Prefix.(curr_bank)+"dsfinv_dbt"+Postfix.(curr_bank)+" inv, "+Prefix.(curr_bank)+"dsfdefcom_dbt"+Postfix.(curr_bank)+" comm ";
    SQL = SQL + " WHERE comm.t_invoiceid = inv.t_invoiceid ";
    SQL = SQL + "   AND comm.t_feetype = 1 ";
    SQL = SQL + "   AND (   inv.t_payeraccount LIKE '405%' ";
    SQL = SQL + "        OR inv.t_payeraccount LIKE '406%' ";
    SQL = SQL + "        OR inv.t_payeraccount LIKE '407%' ";
    SQL = SQL + "        OR inv.t_payeraccount LIKE '40802%' ";
    SQL = SQL + "        OR inv.t_payeraccount LIKE '40807%' ";
    SQL = SQL + "       ) ";
    SQL = SQL +  " AND regexp_like ("+GetSQLString (PartyID.(curr_bank))+", '(,|^)' || TO_CHAR (inv.t_payerbankid) || '(,|$)') ";
    SQL = SQL + "   AND inv.t_invoicedate BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);

    rs = SQL_ExecuteAndGetRs (sql);

    if (rs.movenext)
       ret_val=rs.value (0);
    end;

    return ret_val;


  end;

  macro Конверсии (curr_bank)

    var sql, rs, conv_1, conv_2, conv_3, ret_val;

    conv_1 =0;
    conv_2 =0;
    conv_3 =0;
    ret_val=0;

  
    if (Departments.(curr_bank)>0)

       /* Покупка, продажа, конвертация вал кредит. Сделано согласно требований ТЗ  */

       SQL = " SELECT count (*)  ";
       SQL = SQL + "  FROM "+Prefix.(curr_bank)+"darhdoc$_dbt"+Postfix.(curr_bank)+" arh ";
       SQL = SQL + " WHERE arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
       SQL = SQL + "   AND (arh.t_account_payer LIKE 'ОВП' OR arh.t_account_receiver LIKE 'ОВП') ";
       SQL = SQL + "   AND arh.t_chapter = 1 ";
       SQL = SQL + "   AND arh.t_department = "+Departments.(curr_bank);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          conv_1=rs.value (0); /* Покупка, продажа, конвертация вал кредит */
          ret_val=ret_val+conv_1;
       end;

       /* Распоряжения по транзитному счету */
       SQL = " SELECT count (*) ";
       SQL = SQL + "  FROM "+Prefix.(curr_bank)+"darhdoc$_dbt"+Postfix.(curr_bank)+" arh, "+Prefix.(curr_bank)+"daccount$_dbt"+Postfix.(curr_bank)+" acc_cred ";
       SQL = SQL + " WHERE arh.t_account_receiver = acc_cred.t_account ";
       SQL = SQL + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
       SQL = SQL + "   AND (   arh.t_account_payer LIKE '405%' ";
       SQL = SQL + "        OR arh.t_account_payer LIKE '406%' ";
       SQL = SQL + "        OR arh.t_account_payer LIKE '407%' ";
       SQL = SQL + "        OR arh.t_account_payer LIKE '40802%' ";
       SQL = SQL + "       ) ";
       SQL = SQL + "   AND (   arh.t_account_receiver LIKE '405%' ";
       SQL = SQL + "        OR arh.t_account_receiver LIKE '406%' ";
       SQL = SQL + "        OR arh.t_account_receiver LIKE '407%' ";
       SQL = SQL + "        OR arh.t_account_receiver LIKE '40802%' ";
       SQL = SQL + "       ) ";
       SQL = SQL + "   AND arh.t_chapter = 1 ";
       SQL = SQL + "   AND SUBSTR (arh.t_account_payer, 14, 1) = '1' ";
       SQL = SQL + "   AND acc_cred.t_type_account LIKE '%X%' ";
       SQL = SQL + "   AND arh.t_result_carry NOT IN (14, 23) ";
       SQL = SQL + "   AND arh.t_department = "+Departments.(curr_bank);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          conv_2=rs.value (0); /* Распоряжения по транзитному счету */
          ret_val=ret_val+conv_2;
       end;

       /* Конверсия */
       sql = " SELECT count (*) ";
       sql = sql + "  FROM "+Prefix.(curr_bank)+"dpmpaym_dbt"+Postfix.(curr_bank)+" pmpaym, "+Prefix.(curr_bank)+"dps_bcord_dbt"+Postfix.(curr_bank)+" bcord ";
       sql = sql + " WHERE pmpaym.t_dockind = 200 ";
       sql = sql + "   AND pmpaym.t_payfiid <> 0 ";
       sql = sql + "   AND pmpaym.t_fiid <> 0 ";
       sql = sql + "   AND pmpaym.t_paymentid = bcord.t_paymentid ";
       sql = sql + "   AND pmpaym.t_department = "+Departments.(curr_bank);
       sql = sql + "   AND pmpaym.t_valuedate BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          conv_3=rs.value (0);    /* Конверсия */
          ret_val=ret_val+conv_3;
       end;

    end;
 
    return ret_val;

  end;

  macro Рейсы (curr_bank, direct, iscur)

    var sql, rs, ret_val;

    ret_val=0;

    if (Departments.(curr_bank)>0)

       SQL = " SELECT COUNT (*) ";
       SQL = SQL + "  FROM "+Prefix.(curr_bank)+"dwlpm_dbt"+Postfix.(curr_bank)+" wlpm, ";
       SQL = SQL + "       "+Prefix.(curr_bank)+"dpmpaym_dbt"+Postfix.(curr_bank)+" pmpaym, ";
       SQL = SQL + "       "+Prefix.(curr_bank)+"dwlmeslnk_dbt"+Postfix.(curr_bank)+" meslnk, ";
       SQL = SQL + "       "+Prefix.(curr_bank)+"dwlmes_dbt"+Postfix.(curr_bank)+" mes, ";
       SQL = SQL + "       "+Prefix.(curr_bank)+"dwlmesval_dbt"+Postfix.(curr_bank)+" mesval, ";
       if (iscur==РУБЛИ)
          SQL = SQL + "       "+Prefix.(curr_bank)+"darhdoc_dbt"+Postfix.(curr_bank)+" arh, ";
       else
          SQL = SQL + "       "+Prefix.(curr_bank)+"darhdoc$_dbt"+Postfix.(curr_bank)+" arh, ";
       end;
       SQL = SQL + "       "+Prefix.(curr_bank)+"dpmdocs_dbt"+Postfix.(curr_bank)+" pmd, ";
       SQL = SQL + "       "+Prefix.(curr_bank)+"dwlsess_dbt"+Postfix.(curr_bank)+" sess ";
       SQL = SQL + " WHERE wlpm.t_paymentid = pmpaym.t_paymentid ";
       SQL = SQL + "   AND sess.t_direct = decode ("+direct+","+ЗАГРУЗКА+",'X',chr(0))";
       SQL = SQL + "   AND wlpm.t_wlpmnum = 0 ";
       SQL = SQL + "   AND meslnk.t_objkind = 501 ";
       SQL = SQL + "   AND meslnk.t_objid = wlpm.t_wlpmid ";
       SQL = SQL + "   AND sess.t_tpid = 9 ";
       SQL = SQL + "   AND mes.t_mesid = meslnk.t_mesid ";
       SQL = SQL + "   AND mesval.t_index = 1 ";
       SQL = SQL + "   AND mesval.t_mesid = mes.t_mesid ";
       SQL = SQL + "   AND sess.t_sessionid = mes.t_sessionid ";
       SQL = SQL + "   AND pmd.t_paymentid = pmpaym.t_paymentid ";
       SQL = SQL + "   AND pmd.t_applicationkey = arh.t_applicationkey ";
       SQL = SQL + "   AND (   arh.t_account_payer = "+ GetSQLString(CorrAcc.(curr_bank));
       SQL = SQL + "        OR arh.t_account_receiver = "+ GetSQLString(CorrAcc.(curr_bank));
       SQL = SQL + "       ) ";
       SQL = SQL + "   AND arh.t_result_carry NOT IN (14, 23) ";
       SQL = SQL + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
       SQL = SQL + "   AND arh.t_department =  "+Departments.(curr_bank);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          ret_val=rs.value (0);
       end;

    end;

    return ret_val;

  end;

  macro Картотека  (curr_bank)

    var sql, rs, ret_val;

    ret_val=0;

    if (Departments.(curr_bank)>0)

       sql = " SELECT count (*) ";
       sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc_dbt"+Postfix.(curr_bank)+" arh ";
       sql = sql + " WHERE (   arh.t_account_payer LIKE '90901%' ";
       sql = sql + "        OR arh.t_account_receiver LIKE '90901%' ";
       sql = sql + "        OR arh.t_account_payer LIKE '90902%' ";
       sql = sql + "        OR arh.t_account_receiver LIKE '90902%' ";
       sql = sql + "       ) ";
       sql = sql + "   AND arh.t_result_carry NOT IN (14, 23) ";
       sql = sql + "   AND arh.t_department =  "+Departments.(curr_bank);
       sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          ret_val=rs.value (0);
       end;

    end;

    return ret_val;

  end;

  macro Корр_счета (curr_bank)

    var sql, rs, ret_val;

    ret_val=0;

    if (Departments.(curr_bank)>0)

       sql = " SELECT count (*) ";
       sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc_dbt"+Postfix.(curr_bank)+" arh ";
       sql = sql + " WHERE (   arh.t_account_payer LIKE '30110%' ";
       sql = sql + "        OR arh.t_account_receiver LIKE '30110%' ";
       sql = sql + "        OR arh.t_account_payer LIKE '30114%' ";
       sql = sql + "        OR arh.t_account_receiver LIKE '30114%' ";
       sql = sql + "       ) ";
       sql = sql + "   AND arh.t_result_carry NOT IN (14, 23) ";
       sql = sql + "   AND arh.t_department =  "+Departments.(curr_bank);
       sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          ret_val=rs.value (0);
       end;

    end;

    return ret_val;


  end;

  macro Управление_остатками (curr_bank)

    var sql, rs, ret_val, val_1_r, val_1_v, val_2, val_3;

    var oConnection, connstring;

    array InputParams, OutPutParams;

    oConnection = ActiveX("ADODB.Connection");

  
     val_1_r=0;
     val_1_v=0;
     val_2=0;
     val_3=0;
     ret_val=0;

     if (Departments.(curr_bank)>0)

        /* Аналог выборки из макроса 5.0 report_amont.mac  (процедура Check_ost)*/
        sql = " SELECT COUNT (*) ";
        sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc_dbt"+Postfix.(curr_bank)+" arh ";
        sql = sql + " WHERE (    arh.t_account_payer LIKE '70606%' ";
        sql = sql + "        AND arh.t_account_receiver LIKE '47426%' ";
        sql = sql + "       ) ";
        sql = sql + "    OR     (    (   arh.t_account_payer LIKE '70606%' ";
        sql = sql + "                 OR arh.t_account_payer LIKE '47426%' ";
        sql = sql + "                ) ";
        sql = sql + "            AND (   arh.t_account_receiver LIKE '405%' ";
        sql = sql + "                 OR arh.t_account_receiver LIKE '406%' ";
        sql = sql + "                 OR arh.t_account_receiver LIKE '407%' ";
        sql = sql + "                ) ";
        sql = sql + "           ) ";
        sql = sql + "   AND arh.t_department =  "+Departments.(curr_bank);
        sql = sql + "   AND arh.t_result_carry NOT IN (14, 23) ";
        sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);

        rs = SQL_ExecuteAndGetRs (sql);

        if (rs.movenext)
           val_1_r=rs.value (0); 
           ret_val=ret_val+val_1_r;
        end;

        /* Аналог выборки из макроса 5.0 report_amont.mac  (процедура Check_ost)*/
        sql = " SELECT COUNT (*) ";
        sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc$_dbt"+Postfix.(curr_bank)+" arh ";
        sql = sql + " WHERE (    arh.t_account_payer LIKE '70606%' ";
        sql = sql + "        AND arh.t_account_receiver LIKE '47426%' ";
        sql = sql + "       ) ";
        sql = sql + "    OR     (    (   arh.t_account_payer LIKE '70606%' ";
        sql = sql + "                 OR arh.t_account_payer LIKE '47426%' ";
        sql = sql + "                ) ";
        sql = sql + "            AND (   arh.t_account_receiver LIKE '405%' ";
        sql = sql + "                 OR arh.t_account_receiver LIKE '406%' ";
        sql = sql + "                 OR arh.t_account_receiver LIKE '407%' ";
        sql = sql + "                ) ";
        sql = sql + "           ) ";
        sql = sql + "   AND arh.t_department =  "+Departments.(curr_bank);
        sql = sql + "   AND arh.t_result_carry NOT IN (14, 23) ";
        sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);

        rs = SQL_ExecuteAndGetRs (sql);  

        if (rs.movenext)
           val_1_v=rs.value (0); 
           ret_val=ret_val+val_1_v;
        end;

        InputParams(0) = Начало_периода;
        InputParams(1) = Конец_периода;
        InputParams(2) = {MFO_Bank};

        asize(OutputParams,0);
       
        connstring = getFrontConnectionString (FR_LEGAL);
        conn2front(oConnection, connstring);

        rs=ExecuteFrontProcEx ("rsb_get_operations_RD",InputParams, oConnection, 12, OutputParams);

        if (rs and rs.movenext)
           val_3=rs.m_value[0];
           ret_val=ret_val+val_3;
        end;

     end;

     return ret_val;

  end;

  macro Таможенные_карты (curr_bank)

    var sql, rs, ret_val, val_1_r, val_1_v, val_2;

    var oConnection, connstring;

    array InputParams, OutPutParams;

    oConnection = ActiveX("ADODB.Connection");


    val_1_r=0;
    val_1_v=0;
    val_2  =0;
    ret_val=0;

    if (Departments.(curr_bank)>0)

       sql = " SELECT count (*) ";
       sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc_dbt"+Postfix.(curr_bank)+" arh ";
       sql = sql + " WHERE (    (   arh.t_account_receiver LIKE '405%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '406%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '407%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '40820%' ";
       sql = sql + "            ) ";
       sql = sql + "        AND SUBSTR (arh.t_account_receiver, 11, 1) = '9' ";
       sql = sql + "        AND (   arh.t_account_payer LIKE '30101%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '405%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '406%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '407%' ";
       sql = sql + "            ) ";
       sql = sql + "       ) ";
       sql = sql + "    OR     (    (   arh.t_account_payer LIKE '405%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '406%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '407%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '40820%' ";
       sql = sql + "                ) ";
       sql = sql + "            AND arh.t_account_receiver LIKE '70601%' ";
       sql = sql + "            AND SUBSTR (arh.t_account_payer, 11, 1) = '9' ";
       sql = sql + "           ) ";
       sql = sql + "       AND arh.t_chapter = 1 ";
       sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
       sql = sql + "       AND arh.t_department =  "+Departments.(curr_bank);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          val_1_r=rs.value (0); 
           ret_val=ret_val+val_1_r;
       end;

       sql = " SELECT count (*) ";
       sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc$_dbt"+Postfix.(curr_bank)+" arh ";
       sql = sql + " WHERE (    (   arh.t_account_receiver LIKE '405%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '406%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '407%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '40820%' ";
       sql = sql + "            ) ";
       sql = sql + "        AND SUBSTR (arh.t_account_receiver, 11, 1) = '9' ";
       sql = sql + "        AND (   arh.t_account_payer LIKE '30101%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '405%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '406%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '407%' ";
       sql = sql + "            ) ";
       sql = sql + "       ) ";
       sql = sql + "    OR     (    (   arh.t_account_payer LIKE '405%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '406%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '407%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '40820%' ";
       sql = sql + "                ) ";
       sql = sql + "            AND arh.t_account_receiver LIKE '70601%' ";
       sql = sql + "            AND SUBSTR (arh.t_account_payer, 11, 1) = '9' ";
       sql = sql + "           ) ";
       sql = sql + "       AND arh.t_chapter = 1 ";
       sql = sql + "       AND arh.t_result_carry NOT IN (14, 23) ";
       sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
       sql = sql + "       AND arh.t_department =  "+Departments.(curr_bank);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          val_1_v=rs.value (0); 
           ret_val=ret_val+val_1_v;
       end;


        InputParams(0) = Начало_периода;
        InputParams(1) = Конец_периода;
        InputParams(2) = {MFO_Bank};

        asize(OutputParams,0);
       
        connstring = getFrontConnectionString (FR_LEGAL);
        conn2front(oConnection, connstring);

        rs=ExecuteFrontProcEx ("rsb_get_operations_tk",InputParams, oConnection, 12, OutputParams);

        if (rs and rs.movenext)
           val_2=rs.m_value[0];
           ret_val=ret_val+val_2;
        end;

    end;

    return ret_val;


  end;

  macro Овердрафт (curr_bank)

    var sql, rs, ret_val;

    ret_val=0;

    if (Departments.(curr_bank)>0)

       sql = " SELECT count (*) ";
       sql = sql + "  FROM "+Prefix.(curr_bank)+"darhdoc_dbt"+Postfix.(curr_bank)+" arh ";
       sql = sql + " WHERE (    (   arh.t_account_receiver LIKE '405%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '406%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '407%' ";
       sql = sql + "             OR arh.t_account_receiver LIKE '40802%' ";
       sql = sql + "            ) ";
       sql = sql + "        AND (   arh.t_account_payer LIKE '45101%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '45201%' ";
       sql = sql + "             OR arh.t_account_payer LIKE '45301%' ";
       sql = sql + "            ) ";
       sql = sql + "       ) ";
       sql = sql + "    OR     (    (   arh.t_account_payer LIKE '405%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '406%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '407%' ";
       sql = sql + "                 OR arh.t_account_payer LIKE '40802%' ";
       sql = sql + "                ) ";
       sql = sql + "            AND (   arh.t_account_receiver LIKE '45101%' ";
       sql = sql + "                 OR arh.t_account_receiver LIKE '45201%' ";
       sql = sql + "                 OR arh.t_account_receiver LIKE '45301%' ";
       sql = sql + "                ) ";
       sql = sql + "           ) ";
       sql = sql + "       AND arh.t_chapter = 1 ";
       sql = sql + "       AND arh.t_result_carry NOT IN (14, 23) ";
       sql = sql + "   AND arh.t_date_carry BETWEEN "+GetSQLDate (Начало_периода) + " AND "+ GetSQLDate (Конец_периода);
       sql = sql + "       AND arh.t_department =  "+Departments.(curr_bank);

       rs = SQL_ExecuteAndGetRs (sql);

       if (rs.movenext)
          ret_val=rs.value (0);
       end;

    end;

    return ret_val;


  end;

  macro GetDatePeriod
     /*
     Начало_периода=date (0,0,0);
     Конец_периода =date (0,0,0);

     GetDate (Начало_периода, "Начало периода:");
     GetDate (Конец_периода , "Конец периода:");  */

     Начало_периода=date (10,10,2009);
     Конец_периода =date (26,10,2009);


  end;

  /* Заполняем массив Department (версия ЦАБС). Остальные возможности доступа реализуются через задание массивов Prefix и Postfix  */
  macro FillDepartment

    var i_max, i;
    var rs, sql;

    i=0;
    i_max=PartyID.size;

    while (i<i_max)
      sql="select max (t_code) from ddp_dep_dbt WHERE regexp_like ("+GetSQLString (PartyID.(i))+", '(,|^)' || TO_CHAR (t_partyid) || '(,|$)')";
      rs = SQL_ExecuteAndGetRs (sql);

      if (rs.movenext and (valtype (rs.value(0))!=V_UNDEF))
         Departments.(i)=int (rs.value (0));
      else
         Departments.(i)=-1;
      end;

      i=i+1;
    end;

  end;

  macro PrepareReport

     var ex, ob, out, fulloutput, obBook,  obSheet;
     var i;

     if (IsStandAlone()) // Двухзвенка
         if ((ValType(ex)!=V_UNDEF) and (ex.Visible==False))
            ex = ActiveX("Excel.Application",NULL,false); 
         else
            ex = ActiveX("Excel.Application",NULL,true);
         end;
  
     else // Трехзвенка
         ob = CreateObject ("rsax","TRsAxServer","RsAxServer",false);
         ex = ob.CreateComObject ("Excel.Application",true);
     end; 

     GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,out);

     Fulloutput = FindPath(output, out);                    
	if (not Fulloutput)
		msgbox("Не найдена LBR");
		exit();
	end;


     /*Fulloutput = "D:\\Softlab\\PRBB\\Stend\\mac.usr\\Templs\\rep_oper_cnt.xls";*/

     obBook = ex.Workbooks.open(fulloutput); 

     obSheet = obBook.ActiveSheet; 

     obSheet.Range ("dateperiod").Value="< с "+Начало_периода+" по "+Конец_периода+">";

     i=0;
     while (i<Наименование_size)
       println ("Интернет_клиент начало ", time);
       message ("Подсчет документов...."+Виды_операций. (0)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(0)+1)).Value= Интернет_клиент (i, РУБЛИ);
       obSheet.Range (string (Столбец.(i))+string (Строка.(0)+2)).Value= Интернет_клиент (i, ВАЛЮТА);

       println ("Интернет_клиент завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (1)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(1))).Value  = Комиссии (i);

       println ("Комиссии завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (2)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(2))).Value  = Конверсии (i);

       println ("Конверсии завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (3)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(3))).Value  = Рейсы (i, ЗАГРУЗКА, РУБЛИ)+Рейсы (i, ЗАГРУЗКА, ВАЛЮТА);

       println ("Рейсы загрузка завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (4)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(4))).Value  = Рейсы (i, ВЫГРУЗКА, РУБЛИ)+Рейсы (i, ВЫГРУЗКА, ВАЛЮТА);

       println ("Рейсы выгрузка завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (5)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(5))).Value  = Картотека (i);

       println ("Картотека завершение", time);

       message ("Подсчет документов...."+Виды_операций. (6)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(6))).Value  = Корр_счета (i);

       println ("Косчета завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (7)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(7))).Value  = Управление_остатками (i);

       println ("Управление остатками завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (8)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(8))).Value  = Таможенные_карты (i);

       println ("Таможенные карты завершение ", time);

       message ("Подсчет документов...."+Виды_операций. (9)+" по "+Наименование.(i));
       obSheet.Range (string (Столбец.(i))+string (Строка.(9))).Value  = Овердрафт (i);

       println ("Овердрафт завершение ", time);

       i=i+1;
     end;

     Ex.visible = true;       

  end;


end;

var Отчет:Отчет_по_количеству_операций;

Отчет.FillDepartment;
Отчет.GetDatePeriod;
Отчет.PrepareReport;


