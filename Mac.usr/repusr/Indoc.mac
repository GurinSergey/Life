/*Поступление платежей на счета                              */
/*                                                           */
/*                                                           */
/*Тихомиров А.Н. 05.10.2009                    Версия 1.0    */


import globals, RSD,rcw, rslx, Календарь, rsbdataset, ptinter, bankinter;
var typeflag, maskflag, accmaskDt, accmaskCrd, fl, acctypeDt, acctypeCrd, inter, ruleflag, attr, statinz, statusflag,  datebegin, dateend, i, m, g, k;
var out, output = "indoc.xls", fulloutput, ex, ob, obBook, obsheet, typedtflag, typecrdflag, typedttext, typecrdtext, maskcrdflag, maskdtflag, string1, string2;
                            

var Fulloutputl, outl, outputl="indoc.lbr";                    
GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("indoc", fulloutputl, TRUE); 
var cmd, rsd, ruletext;
array stat, type, rule;

const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;


private macro code1(id)
var cmd, rsd;
if (id>0)
cmd = rsdcommand(" select codedt.t_code from  dobjcode_dbt codedt "+
 " where codedt.t_codekind = 1 "+
 "  AND codedt.t_objecttype = 3 "+
 "  AND codedt.t_objectid = LPAD (?, 9, '0') ");
cmd.addparam("ID", RSDBP_IN, id);
cmd.execute();
rsd = rsdrecordset(cmd);
else
return "Отсутствует код 1";
end;
if (rsd.movenext())
 return rsd.value(0);
 else
 return "Отсутствует код 1";
end;
END;


private macro Outall()
var acctab="", accin="", acctype="", atrtab="", atrin="", statout1="", statout2="", statin="", stattab = "",sql, rsd;
    if (IsStandAlone()) // Двухзвенка
                 if ((ValType(ex)!=V_UNDEF) and (ex.Visible==False))
                   ex = ActiveX("Excel.Application",NULL,false); 
                 else
                   ex = ActiveX("Excel.Application",NULL,true);
                   
                 end;
  
      else // Трехзвенка
               ob = CreateObject ("rsax","TRsAxServer","RsAxServer",false);
               ex = ob.CreateComObject ("Excel.Application", true);

     end; 
GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,out);
Fulloutput = FindPath(output, out);                    
               
obBook = ex.Workbooks.open(fulloutput); 
obSheet = obBook.ActiveSheet(); 



debugbreak;

string1 = "";
string2 = "";
if ((typedtflag) and (maskdtflag))
 string1 = string("Со счетов ",typedttext, " ",acctypedt);
elif (typedtflag)
 string1 = string("Со счетов ",typedttext);
elif (maskdtflag)
 string1 = string("Со счетов ",acctypedt);
end;
if ((typecrdflag) and (maskcrdflag))
 string2 = string("Со счетов ",typecrdtext, " ",acctypecrd);
elif (typecrdflag)
 string2 = string("Со счетов ",typecrdtext);
elif (maskcrdflag)
 string2 = string("Со счетов ",acctypecrd);
end;


   if ((typeDtflag) and (typeCrdflag))
      acctab = "       daccount_dbt accdt, "+
         "       daccount_dbt acckt, ";

      accin =  "  AND pm.t_payeraccount = accdt.t_account"+
         "   AND accdt.t_chapter = 1 "+
         "   AND acckt.t_chapter = 1 "+
         "   AND pm.t_receiveraccount = acckt.t_account ";
         fl = 0;
         while (strlen(accmaskdt)>0)
            if (not fl)
            accin = accin+ "   AND (accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            end;
            accmaskdt = substr(accmaskdt,2);
   
         end;
          if (fl)
          accin = accin+")";
          end;
          fl = 0;
         while (strlen(accmaskcrd)>0)
         
            if (not fl)
            accin = accin+ "   AND (acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            end;
            accmaskcrd = substr(accmaskcrd,2);

         end;
          if (fl)
          accin = accin+")";
          end;

   elif (typeDtflag)
      acctab = "       daccount_dbt accdt, ";

      accin =  "  AND pm.t_payeraccount = accdt.t_account"+
         "   AND accdt.t_chapter = 1 ";

         fl = 0;
         while (strlen(accmaskdt)>0)
            if (not fl)
            accin = accin+ "   AND (accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            end;
            accmaskdt = substr(accmaskdt,2);
   
         end;
          if (fl)
          accin = accin+")";
          end;
  elif (typecrdflag)
      acctab = "       daccount_dbt acckt, ";

      accin =  "   AND acckt.t_chapter = 1 "+
         "   AND pm.t_receiveraccount = acckt.t_account ";

          fl = 0;
         while (strlen(accmaskcrd)>0)
         
            if (not fl)
            accin = accin+ "   AND (acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            end;
            accmaskcrd = substr(accmaskcrd,2);

         end;
          if (fl)
          accin = accin+")";
          end;

   end;


if ((maskDtflag) and (maskCrdflag))

   inter = "";
    fl = 0;
/*   while (strlen(acctypeDt)>0)
   if ((int(substr(acctypeDt,1,1))) or (substr(acctypeDt,1,1)==0))
    inter = inter+substr(acctypeDt,1,1);
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "?")
    inter = inter + "_";
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctypedt =  substr(acctypeDt,2);
    if (not fl)
    acctype  =  " AND (pm.t_payeraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_payeraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;*/
acctype =    ConvertMaskToSQLFormat( acctypeDt, "pm.t_payeraccount" );
   inter = acctype;
    fl = 0;
acctype =    ConvertMaskToSQLFormat( acctypeCrd, "pm.t_receiveraccount" );
inter = inter +" AND "+acctype;
/*   while (strlen(acctypeCrd)>0)
   if ((int(substr(acctypeCrd,1,1))) or (substr(acctypeCrd,1,1)==0))
    inter = inter+substr(acctypeCrd,1,1);
    acctypeCrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "?")
    inter = inter + "_";
    acctypeCrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "*")
    inter = inter + "%";
    acctypeCrd =  substr(acctypeCrd,2);
    if (not fl)
    acctype  =  acctype+" AND (pm.t_receiveraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_receiveraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypecrd =  substr(acctypecrd,2);
    inter = "";
   end;
   end;

   if (fl)
    acctype  =  acctype+")";
   end;
   */
acctype = inter;
elif ((maskdtflag))
   inter = "";
    fl = 0;
/*   while (strlen(acctypeDt)>0)
   if ((int(substr(acctypeDt,1,1))) or (substr(acctypeDt,1,1)==0))
    inter = inter+substr(acctypeDt,1,1);
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "?")
    inter = inter + "_";
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctypedt =  substr(acctypeDt,2);
    if (not fl)
    acctype  =  " AND (pm.t_payeraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_payeraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;
  */
  acctype =    ConvertMaskToSQLFormat( acctypeDt, "pm.t_payeraccount" )

elif ((maskCrdflag))
/*   inter = "";
    fl = 0;
   while (strlen(acctypeCrd)>0)
   if ((int(substr(acctypeCrd,1,1))) or (substr(acctypeCrd,1,1)==0))
    inter = inter+substr(acctypeCrd,1,1);
    acctypecrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "?")
    inter = inter + "_";
    acctypecrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "*")
    inter = inter + "%";
    acctypecrd =  substr(acctypeCrd,2);
    if (not fl)
    acctype  =  " AND (pm.t_receiveraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_receiveraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypecrd =  substr(acctypecrd,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;*/

acctype =    ConvertMaskToSQLFormat( acctypeCrd, "pm.t_receiveraccount" )


end;
acctype = " AND "+acctype;

      obSheet.Range("A"+4).Value=string1;
      obSheet.Range("A"+5).Value=string2;
      obSheet.Range("F8:F64999").numberformat = "@";
      obSheet.Range("G8:G64999").numberformat = "@";
      obSheet.Range("A8:A64999").wraptext=true;
      obSheet.Range("B8:B64999").wraptext=true;
      obSheet.Range("C8:C64999").wraptext=true;
      obSheet.Range("D8:D64999").wraptext=true;
      obSheet.Range("E8:E64999").wraptext=true;
      obSheet.Range("F8:F64999").wraptext=true;
      obSheet.Range("G8:G64999").wraptext=true;
      obSheet.Range("H8:H64999").wraptext=true;
      obSheet.Range("I8:I64999").wraptext=true;
      obSheet.Range("J8:J64999").wraptext=true;
      obSheet.Range("K8:K64999").wraptext=true;
      obSheet.Range("L8:L64999").wraptext=true;
      obSheet.Range("M8:M64999").wraptext=true;
      obSheet.Range("N8:N64999").wraptext=true;

      obSheet.Range("A1").ColumnWidth=5;
      obSheet.Range("B1").ColumnWidth=15;
      obSheet.Range("C1").ColumnWidth=25;
      obSheet.Range("D1").ColumnWidth=15;
      obSheet.Range("E1").ColumnWidth=10;
      obSheet.Range("F1").ColumnWidth=25;
      obSheet.Range("G1").ColumnWidth=25;
      obSheet.Range("H1").ColumnWidth=15;
      obSheet.Range("I1").ColumnWidth=5;
      obSheet.Range("J1").ColumnWidth=30;
      obSheet.Range("K1").ColumnWidth=7;
      obSheet.Range("L1").ColumnWidth=25;
      obSheet.Range("M1").ColumnWidth=30;
      obSheet.Range("N1").ColumnWidth=7;

      obSheet.Range("A"+8).Value="№ п/п";
      obSheet.Range("B"+8).Value="Код плательщика";
      obSheet.Range("C"+8).Value="Плательщик";
      obSheet.Range("D"+8).Value="Документ";
      obSheet.Range("E"+8).Value="Дата";
      obSheet.Range("F"+8).Value="Счет плательщика";
      obSheet.Range("G"+8).Value="Счет получателя";
      obSheet.Range("H"+8).Value="Сумма";
      obSheet.Range("I"+8).Value="Валюта";
      obSheet.Range("J"+8).Value="Назначение платежа";
      obSheet.Range("K"+8).Value="Статус";
      obSheet.Range("L"+8).Value="Шаг операции";
      obSheet.Range("M"+8).Value="Рабочая область";
      obSheet.Range("N"+8).Value="ID платежа";

//----------------------------------------------------------------------------//
/*



if ((typeflag) and (maskflag))

   if ((accmaskDt) and (accmaskCrd))
      acctab = "       daccount_dbt accdt, "+
         "       daccount_dbt acckt, ";

      accin =  "  AND pm.t_payeraccount = accdt.t_account"+
         "   AND accdt.t_chapter = 1 "+
         "   AND acckt.t_chapter = 1 "+
         "   AND pm.t_receiveraccount = acckt.t_account ";
         fl = 0;
         while (strlen(accmaskdt)>0)
            if (not fl)
            accin = accin+ "   AND (accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            end;
            accmaskdt = substr(accmaskdt,2);
   
         end;
          accin = accin+")";
          fl = 0;
         while (strlen(accmaskcrd)>0)
         
            if (not fl)
            accin = accin+ "   AND (acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            end;
            accmaskcrd = substr(accmaskcrd,2);

         end;
          accin = accin+")";

   elif (accmaskDt)
      acctab = "       daccount_dbt accdt, ";

      accin =  "  AND pm.t_payeraccount = accdt.t_account"+
         "   AND accdt.t_chapter = 1 ";

         fl = 0;
         while (strlen(accmaskdt)>0)
            if (not fl)
            accin = accin+ "   AND (accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            end;
            accmaskdt = substr(accmaskdt,2);
   
         end;
          accin = accin+")";
   else
      acctab = "       daccount_dbt acckt, ";

      accin =  "   AND acckt.t_chapter = 1 "+
         "   AND pm.t_receiveraccount = acckt.t_account ";

          fl = 0;
         while (strlen(accmaskcrd)>0)
         
            if (not fl)
            accin = accin+ "   AND (acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            end;
            accmaskcrd = substr(accmaskcrd,2);

         end;
          accin = accin+")";

   end;

if ((acctypeDt) and (acctypeCrd))

   inter = "";
   while (strlen(acctypeDt)>0)
    fl = 0;
   if ((int(substr(acctypeDt,1,1))) or (substr(acctypeDt,1,1)==0))
    inter = inter+substr(acctypeDt,1,1);
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "?")
    inter = inter + "_";
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctypedt =  substr(acctypeDt,2);
    if (not fl)
    acctype  =  " AND (pm.t_payeraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_payeraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;
   inter = "";
   while (strlen(acctypeCrd)>0)
    fl = 0;
   if ((int(substr(acctypeCrd,1,1))) or (substr(acctypeCrd,1,1)==0))
    inter = inter+substr(acctypeCrd,1,1);
    acctype =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "?")
    inter = inter + "_";
    acctype =  substr(acctypeCrd,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctype =  substr(acctypeCrd,2);
    if (not fl)
    acctype  =  acctype+" AND (pm.t_receiveraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_receiveraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;

      obSheet.Range("A"+3).Value="Со счетов "+acctypeDt+" "+accmaskDt;
      obSheet.Range("A"+4).Value="Со счетов "+acctypeCrd+" "+accmaskCrd;
elif (acctypedt)
   inter = "";
    fl = 0;
   while (strlen(acctypeDt)>0)
   if ((int(substr(acctypeDt,1,1))) or (substr(acctypeDt,1,1)==0))
    inter = inter+substr(acctypeDt,1,1);
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "?")
    inter = inter + "_";
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctypedt =  substr(acctypeDt,2);
    if (not fl)
    acctype  =  " AND (pm.t_payeraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_payeraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;

      obSheet.Range("A"+3).Value="Со счетов "+acctypeDt+" "+accmaskDt;
      obSheet.Range("A"+4).Value="Со счетов "+acctypeCrd;
elif (acctypeCrd)
   inter = "";
   while (strlen(acctypeCrd)>0)
    fl = 0;
   if ((int(substr(acctypeCrd,1,1))) or (substr(acctypeCrd,1,1))==0)
    inter = inter+substr(acctypeCrd,1,1);
    acctype =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "?")
    inter = inter + "_";
    acctype =  substr(acctypeCrd,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctype =  substr(acctypeCrd,2);
    if (not fl)
    acctype  =  " AND (pm.t_receiveraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_receiveraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
     if (fl)
    acctype  =  acctype+")";
   end;

      obSheet.Range("A"+3).Value="Со счетов "+acctypeDt;
      obSheet.Range("A"+4).Value="Со счетов "+acctypeCrd+" "+accmaskCrd;
end;

elif (maskflag)
   if ((accmaskDt) and (accmaskCrd))
      acctab = "       daccount_dbt accdt, "+
         "       daccount_dbt acckt, ";

      accin =  "  AND pm.t_payeraccount = accdt.t_account"+
         "   AND accdt.t_chapter = 1 "+
         "   AND acckt.t_chapter = 1 "+
         "   AND pm.t_receiveraccount = acckt.t_account ";

         fl = 0;
         while (strlen(accmaskdt)>0)
            if (not fl)
            accin = accin+ "   AND (accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            end;
            accmaskdt = substr(accmaskdt,2);
   
         end;
          accin = accin+")";

         while (strlen(accmaskcrd)>0)
         
            if (not fl)
            accin = accin+ "   AND (acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            end;
            accmaskcrd = substr(accmaskcrd,2);

         end;
          accin = accin+")";


   elif (accmaskDt)
      acctab = "       daccount_dbt accdt, ";

      accin =  "  AND pm.t_payeraccount = accdt.t_account"+
         "   AND accdt.t_chapter = 1 ";

         fl = 0;
         while (strlen(accmaskdt)>0)
            if (not fl)
            accin = accin+ "   AND (accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR accdt.t_usertypeaccount LIKE '%"+substr(accmaskdt,1,1)+"%' ";
            end;
            accmaskdt = substr(accmaskdt,2);
   
         end;
          accin = accin+")";
   else
      acctab = "       daccount_dbt acckt, ";

      accin =  "   AND acckt.t_chapter = 1 "+
         "   AND pm.t_receiveraccount = acckt.t_account ";

         while (strlen(accmaskcrd)>0)
         
            if (not fl)
            accin = accin+ "   AND (acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            fl = 1;
            else
            accin = accin+ "   OR acckt.t_usertypeaccount LIKE '%"+substr(accmaskcrd,1,1)+"%' ";
            end;
            accmaskcrd = substr(accmaskcrd,2);

         end;
          accin = accin+")";

   end;

   obSheet.Range("A"+3).Value="Со счетов "+acctypeDt;
   obSheet.Range("A"+4).Value="Со счетов "+acctypeCrd;

elif (typeflag)
if ((acctypeDt) and (acctypeCrd))

   inter = "";
   fl = 0;
   while (strlen(acctypeDt)>0)
   if ((int(substr(acctypeDt,1,1))) or (substr(acctypeDt,1,1)==0))
    inter = inter+substr(acctypeDt,1,1);
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "?")
    inter = inter + "_";
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctypedt =  substr(acctypeDt,2);
    if (not fl)
    acctype  =  " AND( pm.t_payeraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_payeraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;

   inter = ""; fl=0;
   while (strlen(acctypeCrd)>0)
   if ((int(substr(acctypeCrd,1,1))) or (substr(acctypeCrd,1,1)==0))
    inter = inter+substr(acctypeCrd,1,1);
    acctypecrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "?")
    inter = inter + "_";
    acctypecrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "*")
    inter = inter + "%";
    acctypecrd =  substr(acctypeCrd,2);
    if (not fl)
    acctype  =  acctype + " AND (pm.t_receiveraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_receiveraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;

      obSheet.Range("A"+3).Value="Со счетов "+accmaskDt;
      obSheet.Range("A"+4).Value="Со счетов "+accmaskCrd;
elif (acctypedt)
   inter = "";
   fl = 0;
   while (strlen(acctypeDt)>0)
   if ((int(substr(acctypeDt,1,1))) or (substr(acctypeDt,1,1)==0))
    inter = inter+substr(acctypeDt,1,1);
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "?")
    inter = inter + "_";
    acctypedt =  substr(acctypeDt,2);
   elif (substr(acctypeDt,1,1) == "*")
    inter = inter + "%";
    acctypedt =  substr(acctypeDt,2);
    if (not fl)
    acctype  =  " AND( pm.t_payeraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_payeraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;

      obSheet.Range("A"+3).Value="Со счетов "+accmaskDt;
elif (acctypeCrd)
   inter = "";
   while (strlen(acctypeCrd)>0)
   if ((int(substr(acctypeCrd,1,1))) or (substr(acctypeCrd,1,1)==0))
    inter = inter+substr(acctypeCrd,1,1);
    acctypecrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "?")
    inter = inter + "_";
    acctypecrd =  substr(acctypeCrd,2);
   elif (substr(acctypeCrd,1,1) == "*")
    inter = inter + "%";
    acctypecrd =  substr(acctypeCrd,2);
    if (not fl)
    acctype  =  " AND( pm.t_receiveraccount LIKE '"+inter+"' ";
    fl = 1;
    else
    acctype  =  acctype+" OR pm.t_receiveraccount LIKE '"+inter+"' ";
    end;
    inter = "";
   else
    acctypedt =  substr(acctypeDt,2);
    inter = "";
   end;
   end;
   if (fl)
    acctype  =  acctype+")";
   end;

      obSheet.Range("A"+4).Value="Со счетов "+accmaskCrd;
end;
end;

*/

if (ruleflag)
   atrtab = "  dobjatcor_dbt ATr, ";

   atrin = " AND ATr.t_objecttype = 501 "+
         " AND ATr.t_groupid = 121 "+
         " AND ATr.t_attrid = "+attr+
         " AND ATr.t_object = LPAD (pm.t_paymentid, 10, '0') ";

   obSheet.Range("A"+6).Value="По правилу "+ Ruletext;
end;


   statout1 = "Status, ";
   statout2 = " val.t_name Status, ";

   stattab =  " doprcurst_dbt cur, "+
           " doprstval_dbt val, ";

   statin = " AND cur.t_id_operation = opr.t_id_operation "+
         " AND cur.t_statuskindid = 291 "+
         " AND cur.t_statuskindid = val.t_statuskindid "+
         " AND cur.t_numvalue = val.t_numvalue ";


if (statusflag)
      statin = statin+   " AND cur.t_numvalue = "+statinz;

end;

sql = "select count(1) as cnt "+
 " FROM dpmpaym_dbt pm, "+
    "   doproper_dbt opr, "+
    "   dpmrmprop_dbt rm, "+
        acctab+atrtab+stattab+
    "   dpmprop_dbt prop, "+
    "   dfininstr_dbt inst, "+
    "   doprstep_dbt step, "+
    "   doprblock_dbt bl, "+
    "   doprkdoc_dbt doc "+
 " WHERE opr.t_documentid = LPAD (TO_CHAR (pm.t_paymentid), 34, '0') "+
    " AND opr.t_dockind = pm.t_dockind  "+
    " AND pm.t_paymentid = rm.t_paymentid "+
    " AND prop.T_TRANSFERDATE BETWEEN to_date('"+datebegin+"','DD-MM-YYYY')  AND to_date('"+dateend+"','DD-MM-YYYY') "+
    " AND prop.t_paymentid = pm.t_paymentid "+
    " AND prop.t_issender = CHR (0) "+
    " AND prop.t_group = 2 "+
      accin+atrin+statin+acctype+
    " AND inst.t_fiid = pm.t_basefiid "+
    " AND step.t_id_operation = opr.t_id_operation "+
    " AND step.t_countnum = (select max(st.t_countnum) from doprstep_dbt st where st.t_id_operation = step.t_id_operation) "+
    " AND bl.t_blockid = step.t_blockid "+
    " AND doc.t_dockind = pm.t_dockind ";
rsd = trsbdataset(sql);
if(rsd.movenext())
initprogress(int(rsd.cnt));
end;
sql = "select rownum, t_payer, t_payername, docname, t_valuedate, "+statout1+
      " t_payeraccount, t_receiveraccount, t_amount, t_ccy, t_ground, "+
      " namestep, t_paymentid, Dockind from (select  t_payer, t_payername, docname, t_valuedate, "+statout1+
      " t_payeraccount, t_receiveraccount, t_amount, t_ccy, t_ground, "+
      " namestep, t_paymentid, DECODE (case,  "+
    " 'ББ_15_16_70_400_430_440', 'ББ   (15-мультики, 16, 27 -платежки ББ, 70-мемеорики, 400,430,440 -кассовые ББ)', "+
    " 'РКО_230_231_233'        , 'РКО  (230, 231, 233 - Заявления на открытие/закрытие счетов)', "+
    " 'РКО_201_410_420'        , 'РКО  (201 - РДД, 410,420 - Кассовые РКО-шные документы)', "+
    " 'РКО_51'                 , 'РКО  (51 - периодическая комиссия)', "+
    " 'ББ_59'                  , 'ББ   (59 - требования на оплату периодических комиссий)', "+
    " 'АРМП_320_322'        , 'АРМП (Ответные платежки)', "+
    " 'ПРОЧЕЕ'                 , 'Остальные экземпляры операций' "+
   " ) Dockind  from ( "+
   " SELECT rm.t_payername, pm.t_payer, pm.t_valuedate, "+
    "   pm.t_payeraccount, pm.t_receiveraccount, pm.t_amount, inst.t_ccy, rm.t_ground, "+
    "   bl.t_name namestep, doc.t_name as docname, pm.t_paymentid, pm.t_basefiid,     "+statout2+
    "     case  "+
    "        when pm.t_dockind in (15, 16, 27, 70, 400, 430, 440) then 'ББ_15_16_70_400_430_440' "+
    "        when pm.t_dockind in (230, 231, 233)             then 'РКО_230_231_233' "+
    "        when pm.t_dockind in (201, 410, 420)             then 'РКО_201_410_420' "+
    "        when pm.t_dockind in (51)                        then 'РКО_51' "+
    "        when pm.t_dockind in (59)                        then 'ББ_59' "+
    "        when pm.t_dockind in (320, 322)              then 'АРМП_320_322' "+
    "        else 'Остальное'  "+
    "     end case "+
 " FROM dpmpaym_dbt pm, "+
    "   doproper_dbt opr, "+
    "   dpmrmprop_dbt rm, "+
        acctab+atrtab+stattab+
    "   dpmprop_dbt prop, "+
    "   dfininstr_dbt inst, "+
    "   doprstep_dbt step, "+
    "   doprblock_dbt bl, "+
    "   doprkdoc_dbt doc "+
 " WHERE opr.t_documentid = LPAD (TO_CHAR (pm.t_paymentid), 34, '0') "+
    " AND opr.t_dockind = pm.t_dockind  "+
    " AND pm.t_paymentid = rm.t_paymentid "+
    " AND prop.T_TRANSFERDATE BETWEEN to_date('"+datebegin+"','DD-MM-YYYY')  AND to_date('"+dateend+"','DD-MM-YYYY') "+
    " AND prop.t_paymentid = pm.t_paymentid "+
    " AND prop.t_issender = CHR (0) "+
    " AND prop.t_group = 2 "+
      accin+atrin+statin+acctype+
    " AND inst.t_fiid = pm.t_basefiid "+
    " AND step.t_id_operation = opr.t_id_operation "+
    " AND step.t_countnum = (select max(st.t_countnum) from doprstep_dbt st where st.t_id_operation = step.t_id_operation) "+
    " AND bl.t_blockid = step.t_blockid "+
    " AND doc.t_dockind = pm.t_dockind) "+
    " order by t_basefiid, t_amount) ";

rsd = trsbdataset(sql);

obSheet.Range("A"+2).Value="Отчет о поступление платежей";
obSheet.Range("A"+3).Value="За период с"+datebegin+" по "+dateend;

i = 8; k=0;
while (rsd.movenext())
useprogress(int(k));
   i = i+1;
   k = k+1;
   obSheet.Range("A"+i).Value=rsd.rownum;
   obSheet.Range("B"+i).Value=code1(rsd.payer);
   obSheet.Range("C"+i).Value=rsd.payername;
   obSheet.Range("D"+i).Value=rsd.docname;
   obSheet.Range("E"+i).Value=rsd.valuedate;
   obSheet.Range("F"+i).Value=rsd.payeraccount;
   obSheet.Range("G"+i).Value=rsd.receiveraccount;
   obSheet.Range("H"+i).Value=rsd.amount;
   obSheet.Range("I"+i).Value=rsd.ccy;
   obSheet.Range("J"+i).Value=rsd.ground;
   obSheet.Range("K"+i).Value=rsd.status;
   obSheet.Range("L"+i).Value=rsd.namestep;
   obSheet.Range("M"+i).Value=rsd.dockind;
   obSheet.Range("N"+i).Value=rsd.paymentid;
   if (i>64499)
     obSheet.Range("A8:N"+i).Borders.Weight=2;
     obSheet.Range("A8:N"+8).interior.color=4035000;
     obbook.Worksheets.add;
     obSheet = obBook.ActiveSheet(); 
     i = 8;
      obSheet.Range("F8:F64999").numberformat = "@";
      obSheet.Range("G8:G64999").numberformat = "@";
      obSheet.Range("A8:A64999").wraptext=true;
      obSheet.Range("B8:B64999").wraptext=true;
      obSheet.Range("C8:C64999").wraptext=true;
      obSheet.Range("D8:D64999").wraptext=true;
      obSheet.Range("E8:E64999").wraptext=true;
      obSheet.Range("F8:F64999").wraptext=true;
      obSheet.Range("G8:G64999").wraptext=true;
      obSheet.Range("H8:H64999").wraptext=true;
      obSheet.Range("I8:I64999").wraptext=true;
      obSheet.Range("J8:J64999").wraptext=true;
      obSheet.Range("K8:K64999").wraptext=true;
      obSheet.Range("L8:L64999").wraptext=true;
      obSheet.Range("M8:M64999").wraptext=true;
      obSheet.Range("N8:N64999").wraptext=true;

      obSheet.Range("A1").ColumnWidth=5;
      obSheet.Range("B1").ColumnWidth=15;
      obSheet.Range("C1").ColumnWidth=25;
      obSheet.Range("D1").ColumnWidth=15;
      obSheet.Range("E1").ColumnWidth=10;
      obSheet.Range("F1").ColumnWidth=25;
      obSheet.Range("G1").ColumnWidth=25;
      obSheet.Range("H1").ColumnWidth=15;
      obSheet.Range("I1").ColumnWidth=5;
      obSheet.Range("J1").ColumnWidth=30;
      obSheet.Range("K1").ColumnWidth=7;
      obSheet.Range("L1").ColumnWidth=25;
      obSheet.Range("M1").ColumnWidth=30;
      obSheet.Range("N1").ColumnWidth=7;

      obSheet.Range("A"+8).Value="№ п/п";
      obSheet.Range("B"+8).Value="Код плательщика";
      obSheet.Range("C"+8).Value="Плательщик";
      obSheet.Range("D"+8).Value="Документ";
      obSheet.Range("E"+8).Value="Дата";
      obSheet.Range("F"+8).Value="Счет плательщика";
      obSheet.Range("G"+8).Value="Счет получателя";
      obSheet.Range("H"+8).Value="Сумма";
      obSheet.Range("I"+8).Value="Валюта";
      obSheet.Range("J"+8).Value="Назначение платежа";
      obSheet.Range("K"+8).Value="Статус";
      obSheet.Range("L"+8).Value="Шаг операции";
      obSheet.Range("M"+8).Value="Рабочая область";
      obSheet.Range("N"+8).Value="ID платежа";

   end;
end;
obSheet.Range("A8:N"+(i)).Borders.Weight=2;
obSheet.Range("A8:N"+8).interior.color=4035000;
Ex.visible = true;       
end;


 /*Обработчик диалоговой панели ввода исходных данных для печати*/
MACRO Event (dlg, cmd, id, key) 

   var const_mess = "~F2~ Продолжить ~SPACE~ По всем офисам ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dlg.rec.Datebegin = {curDate};
      dlg.rec.Dateend = {curDate};
      dlg.rec.statusflag = "";
      dlg.rec.status = "";
      dlg.rec.statustext="";
      dlg.rec.statusflag = "";
      dlg.rec.typedt = "";
      dlg.rec.typedttext="";
      dlg.rec.typedtflag = "";
      dlg.rec.typecrd = "";
      dlg.rec.typecrdtext="";
      dlg.rec.typecrdflag = "";
      dlg.rec.rule = "";
      dlg.rec.ruletext="";
      dlg.rec.ruleflag = "";
      dlg.rec.maskdt = "";
      dlg.rec.maskcrd="";
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     if  (FldName(dlg,id)=="Datebegin")
       message(" ~F3~ Выбор даты из календаря "+const_mess2);
     elif (FldName(dlg,id)=="Dateend")
       message(" ~F3~ Выбор даты из календаря "+const_mess2);
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
     if (FldName(dlg,id) == "Dateend")
       if ( dlg.rec.datebegin>dlg.rec.dateend )
         MsgBox("Дата начала периода не может быть больше даты конца периода");
        return CM_CANCEL;
        end;
     end;
     if (FldName(dlg,id) == "MaskDt")
       if (strlen(dlg.rec.maskDt)>0)
            dlg.rec.maskdtflag = "X";
       else
            dlg.rec.maskdtflag = "";
       end;
     end;
     if (FldName(dlg,id) == "MaskCrd")
       if (strlen(dlg.rec.maskCrd)>0)
            dlg.rec.maskcrdflag = "X";
       else
            dlg.rec.maskcrdflag = "";
       end;
     end;
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор подразделения банка из списка подразделений */
        if (FldName(dlg,id) == "Status")
          m = menu(stat);
          if (m >= 0)
          dlg.rec.statustext = stat(m);
          dlg.rec.status = m+1;
          end;
          dlg.rec.statusflag = "X";
          UpdateFields(dlg);
        end;
        if (FldName(dlg,id) == "TypeDt")
          g = menu(type);
            if (g==0)  
              dlg.rec.typedt = "A";
              dlg.rec.typedttext = "A Касса";
              dlg.rec.Typedtflag = "X";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==1)  
              dlg.rec.typedt = "D";
              dlg.rec.typedttext = "D Касса ККО Зареченский";
              dlg.rec.Typedtflag = "X";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==2)  
              dlg.rec.typedt = "F";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "F Касса ККО Пермский 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==3)  
              dlg.rec.typedt = "G";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "G Касса ККО Иркутский 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==4)  
              dlg.rec.typedt = "I";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "I Касса ККО Пермский 2";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==5)  
              dlg.rec.typedt = "L";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "L Касса ККО Дворянский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==6)  
              dlg.rec.typedt = "N";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "N Касса ККО Иркутский 2";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==7)  
              dlg.rec.typedt = "R";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "R Касса ККО Гагаринский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==8)  
              dlg.rec.typedt = "Q";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Q Касса ККО Сенной";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==9)  
              dlg.rec.typedt = "S";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "S Касса ККО Березники 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==10)  
              dlg.rec.typedt = "U";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "U Касса ККО Березники 2";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==11)  
              dlg.rec.typedt = "Z";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Z Касса ККО Фрунзенский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==12)  
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedt = "Б";
              dlg.rec.typedttext = "Б Бухгалтерия";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==13)  
              dlg.rec.typedt = "Г";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Г Резерв";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==14)  
              dlg.rec.typedt = "Д";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Д Межбанк";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==15)  
              dlg.rec.typedt = "Е";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Е Касса ЦМТ";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==16)  
              dlg.rec.typedt = "Ё";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ё Интернет банк";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==17)  
              dlg.rec.typedt = "Ж";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ж ОВКУ";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==18)  
              dlg.rec.typedt = "З";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "З Депозиты юр.лиц";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==19)  
              dlg.rec.typedt = "Й";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Й Касса Тверской";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==20)  
              dlg.rec.typedt = "К";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "К КЭО";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==21)  
              dlg.rec.typedt = "Л";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Л ГМР";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==22)  
              dlg.rec.typedt = "М";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "М Касса Садово-Кудринский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==23)  
              dlg.rec.typedt = "Н";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Н Розничные финанс. Услуги";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==24)  
              dlg.rec.typedt = "О";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "О Депозиты физ.лиц";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==25)  
              dlg.rec.typedt = "П";
              dlg.rec.typedttext = "П Вексельный сектор";
              dlg.rec.Typedtflag = "X";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==26)  
              dlg.rec.typedt = "Т";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Т К-к офис Тульский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==27)  
              dlg.rec.typedt = "У";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "У ДО 'Центральный'";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==28)  
              dlg.rec.typedt = "Ф";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ф  Касса Петровский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==29)  
              dlg.rec.typedt = "Х";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Х Касса Д/о 'Автозаводский'";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==30)  
              dlg.rec.typedt = "Ц";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ц Ценные бумаги";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==31)  
              dlg.rec.typedt = "Ч";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ч Касса ККО Тюменский 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==32)  
              dlg.rec.typedt = "Ш";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ш Касса ККО Дзержинский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==33)  
              dlg.rec.typedt = "Щ";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Щ Касса ККО Дзержинский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==34)  
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedt = "Ы";
              dlg.rec.typedttext = "Ы Касса ККО Красноармейский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==35)  
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedt = "Ъ";
              dlg.rec.typedttext = "Ъ ОКВКУ 4";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==36)  
              dlg.rec.typedt = "Ь";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ь Касса Толстовский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==37)  
              dlg.rec.typedt = "Ю";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Ю ОКВКУ № 1 (Пудовкина)";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==38)  
              dlg.rec.typedt = "Я";
              dlg.rec.Typedtflag = "X";
              dlg.rec.typedttext = "Я Касса Новоданиловский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            else
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);

            end;

        end;

        if (FldName(dlg,id) == "TypeCrd")
          g = menu(type);
            if (g==0)  
              dlg.rec.typeCrd = "A";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "A Касса";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==1)  
              dlg.rec.typeCrd = "D";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "D Касса ККО Зареченский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==2)  
              dlg.rec.typeCrd = "F";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "F Касса ККО Пермский 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==3)  
              dlg.rec.typeCrd = "G";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "G Касса ККО Иркутский 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==4)  
              dlg.rec.typeCrd = "I";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "I Касса ККО Пермский 2";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==5)  
              dlg.rec.typeCrd = "L";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "L Касса ККО Дворянский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==6)  
              dlg.rec.typeCrd = "N";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "N Касса ККО Иркутский 2";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==7)  
              dlg.rec.typeCrd = "R";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "R Касса ККО Гагаринский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==8)  
              dlg.rec.typeCrd = "Q";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Q Касса ККО Сенной";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==9)  
              dlg.rec.typeCrd = "S";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "S Касса ККО Березники 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==10)  
              dlg.rec.typeCrd = "U";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "U Касса ККО Березники 2";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==11)  
              dlg.rec.typeCrd = "Z";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Z Касса ККО Фрунзенский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==12)  
              dlg.rec.typeCrd = "Б";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Б Бухгалтерия";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==13)  
              dlg.rec.typeCrd = "Г";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Г Резерв";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==14)  
              dlg.rec.typeCrd = "Д";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Д Межбанк";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==15)  
              dlg.rec.typeCrd = "Е";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Е Касса ЦМТ";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==16)  
              dlg.rec.typeCrd = "Ё";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ё Интернет банк";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==17)  
              dlg.rec.typeCrd = "Ж";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ж ОВКУ";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==18)  
              dlg.rec.typeCrd = "З";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "З Депозиты юр.лиц";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==19)  
              dlg.rec.typeCrd = "Й";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Й Касса Тверской";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==20)  
              dlg.rec.typeCrd = "К";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "К КЭО";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==21)  
              dlg.rec.typeCrd = "Л";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Л ГМР";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==22)  
              dlg.rec.typeCrd = "М";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "М Касса Садово-Кудринский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==23)  
              dlg.rec.typeCrd = "Н";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Н Розничные финанс. Услуги";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==24)  
              dlg.rec.typeCrd = "О";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "О Депозиты физ.лиц";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==25)  
              dlg.rec.typeCrd = "П";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "П Вексельный сектор";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==26)  
              dlg.rec.typeCrd = "Т";
              dlg.rec.typeCrdtext = "Т К-к офис Тульский";
              dlg.rec.Typecrdflag = "X";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==27)  
              dlg.rec.typeCrd = "У";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "У ДО 'Центральный'";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==28)  
              dlg.rec.typeCrd = "Ф";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ф  Касса Петровский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==29)  
              dlg.rec.typeCrd = "Х";
              dlg.rec.typeCrdtext = "Х Касса Д/о 'Автозаводский'";
              dlg.rec.Typecrdflag = "X";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==30)  
              dlg.rec.typeCrd = "Ц";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ц Ценные бумаги";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==31)  
              dlg.rec.typeCrd = "Ч";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ч Касса ККО Тюменский 1";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==32)  
              dlg.rec.typeCrd = "Ш";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ш Касса ККО Дзержинский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==33)  
              dlg.rec.typeCrd = "Щ";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Щ Касса ККО Дзержинский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==34)  
              dlg.rec.typeCrd = "Ы";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ы Касса ККО Красноармейский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==35)  
              dlg.rec.typeCrd = "Ъ";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ъ ОКВКУ 4";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==36)  
              dlg.rec.typeCrd = "Ь";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ь Касса Толстовский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==37)  
              dlg.rec.typeCrd = "Ю";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Ю ОКВКУ № 1 (Пудовкина)";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==38)  
              dlg.rec.typeCrd = "Я";
              dlg.rec.Typecrdflag = "X";
              dlg.rec.typeCrdtext = "Я Касса Новоданиловский";
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            else
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);

            end;

        end;
        
        
        if (FldName(dlg,id) == "Rule")
          m = menu(rule);
          if (m >= 0)
          dlg.rec.ruletext = substr(rule(m),(index(rule(m)," | ")+3));
          dlg.rec.rule = substr(rule(m),1,index(rule(m)," | "));
          dlg.rec.Ruleflag = "X";
          end;                                               
          UpdateFields(dlg);
        end;
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "Datebegin")
          dlg.rec.datebegin = GetDateByCalendar ({curDate});
        end;
        if (FldName(dlg,id) == "Dateend")
          dlg.rec.dateend = GetDateByCalendar ({curDate});
        end;
        
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
          if (FldName(dlg,id) == "Statusflag") 
          if (dlg.rec.statusflag=="");
            dlg.rec.statusflag = "X";
          else
            dlg.rec.statusflag = "";
          end;
            UpdateFields(dlg);
          end;
          if (FldName(dlg,id) == "MaskDtflag") 
          if (dlg.rec.maskdtflag=="");
            dlg.rec.maskdtflag = "X";
          else
            dlg.rec.maskdtflag = "";
          end;
            UpdateFields(dlg);
          end;
          if (FldName(dlg,id) == "MaskCrdflag") 
          if (dlg.rec.maskcrdflag=="");
            dlg.rec.maskCrdflag = "X";
          else
            dlg.rec.maskcrdflag = "";
          end;
            UpdateFields(dlg);
          end;
          if (FldName(dlg,id) == "TypeDtflag") 
          if (dlg.rec.TypeDtflag=="");
            dlg.rec.TypeDtflag = "X";
          else
            dlg.rec.TypeDtflag = "";
          end;
            UpdateFields(dlg);
          end;
          if (FldName(dlg,id) == "TypeCrdflag") 
          if (dlg.rec.Typecrdflag=="");
            dlg.rec.Typecrdflag = "X";
          else
            dlg.rec.Typecrdflag = "";
          end;
            UpdateFields(dlg);
          end;
          if (FldName(dlg,id) == "Ruleflag") 
          if (dlg.rec.Ruleflag=="");
            dlg.rec.Ruleflag = "X";
          else
            dlg.rec.Ruleflag = "";
          end;
            UpdateFields(dlg);
          end;
     elif (( KEY == KEY_F2 )  or ( KEY == KEY_ENTER ))         //Проверки при вводе
         if ( dlg.rec.datebegin > dlg.rec.dateend )
                MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
                return CM_IGNORE;
         end;
/*        if ((dlg.rec.typedtflag) or (dlg.rec.typecrdflag))
        maskflag = 1;
        end;
        if ((dlg.rec.maskdtflag) or (dlg.rec.maskcrdflag))
        typeflag = 1;
        end;*/
        maskcrdflag = dlg.rec.maskcrdflag;
        maskdtflag = dlg.rec.maskdtflag;
        typedtflag = dlg.rec.typedtflag;
        typecrdflag = dlg.rec.typecrdflag;
        typedttext = dlg.rec.typedttext;
        typecrdtext = dlg.rec.typecrdtext;
        acctypeDt = dlg.rec.maskdt;
        acctypeCrd = dlg.rec.maskcrd;
        accmaskDt = dlg.rec.typedt;
        accmaskCrd = dlg.rec.typecrd;
        statinz = dlg.rec.status;
        ruleflag = dlg.rec.ruleflag;
        attr = dlg.rec.rule;
        ruletext = dlg.rec.ruletext;
        statusflag = dlg.rec.statusflag;
        datebegin = dlg.rec.datebegin;
        dateend = dlg.rec.dateend;

           Return CM_SAVE;
      else
           Return CM_IGNORE;
     end;
   end;
        
END;



/*Точка входа*/
rsd = rsdrecordset(rsdcommand("select t_name from doprstval_dbt where t_statuskindid = 291"));
while (rsd.movenext())
stat(asize(stat)) = rsd.value(0);
end;  
   type(0)="A Касса";
   type(1)="D Касса ККО Зареченский";
   type(2)="F Касса ККО Пермский 1";
   type(3)="G Касса ККО Иркутский 1";
   type(4)="I Касса ККО Пермский 2";
   type(5)="L Касса ККО Дворянский";
   type(6)="N Касса ККО Иркутский 2";
   type(7)="R Касса ККО Гагаринский";
   type(8)="Q Касса ККО Сенной";
   type(9)="S Касса ККО Березники 1";
   type(10)="U Касса ККО Березники 2";
   type(11)="Z Касса ККО Фрунзенский";
   type(12)="Б Бухгалтерия";
   type(13)="Г Резерв";
   type(14)="Д Межбанк";
   type(15)="Е Касса ЦМТ";
   type(16)="Ё Интернет банк";
   type(17)="Ж ОВКУ";
   type(18)="З Депозиты юр.лиц";
   type(19)="Й Касса Тверской";
   type(20)="К КЭО";
   type(21)="Л ГМР";
   type(22)="М Касса Садово-Кудринский";
   type(23)="Н Розничные финанс. Услуги";
   type(24)="О Депозиты физ.лиц";
   type(25)="П Вексельный сектор";
   type(26)="Т К-к офис Тульский";
   type(27)="У ДО 'Центральный'";
   type(28)="Ф  Касса Петровский";
   type(29)="Х Касса Д/о 'Автозаводский'";
   type(30)="Ц Ценные бумаги";
   type(31)="Ч Касса ККО Тюменский 1";
   type(32)="Ш Касса ККО Дзержинский";
   type(33)="Щ Неторговые операц  ";
   type(34)="Ы Касса ККО Красноармейский";
   type(35)="Ъ ОКВКУ 4";
   type(36)="Ь Касса Толстовский";
   type(37)="Ю ОКВКУ № 1 (Пудовкина)";
   type(38)="Я Касса Новоданиловский";

rsd = rsdrecordset("SELECT t.t_attrid, t.t_name "+
                  "  FROM dobjattr_dbt t "+
                  " WHERE (t.t_objecttype = 501) AND (t.t_groupid = 121)  order by t.t_attrid ");
  
while (rsd.movenext())
rule(asize(rule)) = string(rsd.value(0):2," | ",rsd.value(1));
end;  
if (RunDialog(dlg, "Event"))                  
  OutAll;
end;
