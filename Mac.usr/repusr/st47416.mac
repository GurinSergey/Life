/* Str! Штафель к счету 47416*/
/*Тихомиров Доработка исправление*/
/*ПРОВЕРИТЬ ДАТЫ!!!*/

/* 09.02.11 Зубко С. I-00001686 Тема: в v6 нет штафеля по счету 47417
   Добавил 47417 и переформатировал макрос Тихомирова и Котова очень сильно 
*/

/* 18.02.2011 Зубко С.
I-00008961 Тема: Штафель по 47416. Не все поля подтягиваются (нет счета плательщика, наименование получателя)
I-00008039 Тема: в v 6 просим создать штафель по счету 47417 аналогично v 5(в v6 лишние графы)
*/

import Rsbdataset,"Календарь", globals, oralib, RSD, FIInter;
import oralib,"fastexcel.mac"; /*SDA*/
import "fg_Life_parm.mac";  //Lavrenov 27.10.11

private var ex:object,ob:object,obBook:object,obSheet:object;
private var	out, output="st47416.xlt", fulloutput;
private var fgBank = fg_life_subject({OurBank});

var v_mas_acc = "", v_mas_val = "", v_type_report, out_in_excel=true;
var Paneldate1;

var rselect, cmd, rsrec, count, Acc47416, numRow=0,startRow=4;

array mas_acc;
array mas_val;
array type_report;

private macro Get_Name_Account(p_acc)
  
  var cmd:object,rs:object,sql:string;

  sql = "select acc.T_NAMEACCOUNT from daccount_dbt acc where acc.T_ACCOUNT = ? ";

  cmd = RsdCommand(SQL);
  cmd.AddParam("account", RSDBP_IN, p_acc);
  cmd.execute();

  rs = RsdRecordSet(cmd);
  if (rs.MoveNext and ( Valtype(rs.Value(0)) != 26))
     return rs.Value(0);
  end;
  return "";
END;

private macro Get_Account_to_OK(id)
private var cmd, query, rs, acc="",_i=0; 

/*Gurin S. 30.01.2014 Адаптация 2031 
query = "select ADC.T_ACCOUNT_RECEIVER ACCOUNT "+
     "from dpmdocs_dbt pmd, "+ 
          "darhdoc_dbt adc, "+ 
          "dpmpaym_dbt pm "+
    "where pm.t_paymentid = "+ id + 
     "and pm.t_paymentid = pmd.t_paymentid "+ 
     "and adc.t_applicationkey(+) = pmd.t_applicationkey "+
     "and adc.t_iapplicationkind(+) = pmd.t_applicationkind "+ 
     "and adc.t_account_payer like '47416%' "; 
*/
query = "select trn.t_account_receiver ACCOUNT "+
     "from dpmdocs_dbt pmd, "+ 
          "dacctrn_dbt trn, "+ 
          "dpmpaym_dbt pm "+
    "where pm.t_paymentid = "+ id + 
     "and pm.t_paymentid = pmd.t_paymentid "+ 
     "and trn.t_acctrnid(+) = pmd.t_acctrnid "+
     "and trn.t_account_payer like '47416%' "; 

rs = rsdrecordset(query);

 while (rs.movenext())
  if (_i)
   acc=acc+"\n"
  end;
  acc=acc+rs.value("ACCOUNT");
  _i=_i+1;
 end;
 rs= null;
/* считаем, что выполнен возврат */
 if (trim (acc) == "")

/*Gurin S. 30.01.2014 Адаптация 2031
query = "select ADC.T_ACCOUNT_payer ACCOUNT "+
     "from dpmdocs_dbt pmd, "+ 
          "darhdoc_dbt adc, "+ 
          "dpmpaym_dbt pm "+
    "where pm.t_paymentid = "+ id + 
     "and pm.t_paymentid = pmd.t_paymentid "+ 
     "and adc.t_applicationkey(+) = pmd.t_applicationkey "+
     "and adc.t_iapplicationkind(+) = pmd.t_applicationkind "+ 
     "and adc.t_account_receiver like '47416%' "; 
*/
query = "select trn.t_account_payer ACCOUNT "+
        "from dpmdocs_dbt pmd, "+ 
        "     dacctrn_dbt trn, "+ 
        "     dpmpaym_dbt pm "+
        "where     pm.t_paymentid = "+ id + 
        "      and pm.t_paymentid = pmd.t_paymentid "+ 
        "      and trn.t_acctrnid(+) = pmd.t_acctrnid "+
        "      and trn.t_account_receiver like '47416%' "; 
  rs = rsdrecordset(query);
  while (rs.movenext())
   acc=rs.value("ACCOUNT");
  end;
 end;

return acc;
end;
/*Шапка рубли*/
MACRO PrintHeaderRub()

[                                     Ведомость-расшифровка невыясненных документов за ########## рубли](paneldate1:f);
[┌──────────┬──────────┬─────────────┬───────────────────────────┬─────────────────────────┬─────────────────┐
 │   Дата   │    №     │    БИК      │         Счет              │        Счет             │                 │
 │ прихода  │документа │ плательщика │      плательщика          │      получателя         │      Сумма      │
 │  суммы   │          │             │                           │                         │                 │];


END;

/*Подвал рубли*/
MACRO PrintFooterRub(p_sum, p_cnt)

  [├──────────┴──────────┴─────────────┴───────────────────────────┴─────────────────────────┴─────────────────┤
   │   ИТОГО ДОКУМЕНТОВ : ########## на сумму : ###################                                            │
   └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘](p_cnt, p_sum);
  [
  Исполнитель                    _________________ / _________________


  Контролер                      _________________ / _________________

  ];

END;

/*Шапка валюта*/
MACRO PrintHeaderCur(p_NameCur)
/*SDA 12/01/2012 C-6586
[                                     Ведомость-расшифровка невыясненных документов за ########## валюта](paneldate1:f);

[
  #########################
 ┌──────────┬──────────┬───────────────────────────┬──────────┬──────────┬──────────────────────┬──────────────────────┐
 │   Дата   │   Дата   │       Плательщик          │  Сумма   │   Дата   │  Получатель средств  │     Наименование     │
 │зачисления│валютиров.│                           │          │ списания │                      │      получателя      │
 │          │          │                           │          │          │                      │                      │](p_NameCur);
*/                                                          

[                                     Ведомость-расшифровка невыясненных документов за ########## валюта](paneldate1:f);
[
  #########################
 ┌──────────┬──────────┬─────────────────┬──────────────────────┬────────────────────┬──────────────┬─────────────────────┐
 │   Дата   │    №     │      Банк       │         Счет         │        Счет        │              │ Наименование        │
 │ прихода  │документа │   плательщика   │      плательщика     │      получателя    │    Сумма     │ получателя          │
 │  суммы   │          │                 │                      │                    │              │                     │](p_NameCur);;

END;

/*Середина валюта*/
MACRO PrintMiddleCur( p_sum, p_cnt1, p_NameCur)
/* SDA 12/01/2012 C-6586
[├──────────┴──────────┴───────────────────────────┴──────────┴──────────┴──────────────────────┴──────────────────────┤
 │   ИТОГО ДОКУМЕНТОВ : ########## на сумму : ###################                                                      │
 └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘](p_cnt1, p_sum);

[
  #########################
 ┌──────────┬──────────┬───────────────────────────┬──────────┬──────────┬──────────────────────┬──────────────────────┐
 │   Дата   │   Дата   │       Плательщк           │  Сумма   │   Дата   │  Получатель средств  │     Наименование     │
 │зачисления│валютиров.│                           │          │ списания │                      │      получателя      │
 │          │          │                           │          │          │                      │                      │](p_NameCur);
*/

[├──────────┴──────────┴─────────────────┴──────────────────────┴────────────────────┴──────────────┴─────────────────────┤
 │   ИТОГО ДОКУМЕНТОВ : ########## на сумму : ###################                                                         │
 └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘](p_cnt1, p_sum);

[
  #########################
 ┌──────────┬──────────┬─────────────────┬──────────────────────┬────────────────────┬──────────────┬─────────────────────┐
 │   Дата   │    №     │      Банк       │         Счет         │        Счет        │              │ Наименование        │
 │ прихода  │документа │   плательщика   │      плательщика     │      получателя    │    Сумма     │ получателя          │
 │  суммы   │          │                 │                      │                    │              │                     │](p_NameCur);;

END;

/*Подвал валюта*/
MACRO PrintFooterCur(p_cnt1, p_sum)
/*SDA 12/01/2012 C-6586
[├──────────┴──────────┴───────────────────────────┴──────────┴──────────┴──────────────────────┴──────────────────────┤
 │   ИТОГО ДОКУМЕНТОВ : ########## на сумму : ###################                                                      │
 └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘](p_cnt1, p_sum);
[
*/
[├──────────┴──────────┴─────────────────┴──────────────────────┴────────────────────┴──────────────┴─────────────────────┤
 │   ИТОГО ДОКУМЕНТОВ : ########## на сумму : ###################                                                         │
 └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘](p_cnt1, p_sum);
[

Исполнитель                    _________________ / _________________


Контролер                      _________________ / _________________
];


END;

MACRO outRub()

var sum = $0, cnt = 0;
var cmd, query, rs; 
var acc_left = "", acc_right = "", v_bankcode = "", v_place_date:date, v_out_date:date;
var v_acc_ok ="";
private var _i=0;

/* Gurin S. 30.01.2014 Адаптация 2031
query = "  SELECT   pmrmprop.t_PaymentID T_PAYMENTID, " +
        "\n            pmrmprop.t_Number T_NUMBER, " +
        "\n            pmrmprop.t_ShifrOper T_SHIFROPER, " +
        "\n            pmpaym.t_PayerAccount T_PAYERACCOUNT, " +
        "\n            pmpaym.t_ReceiverAccount T_RECEIVERACCOUNT, " +
        "\n            pmpaym.t_Amount T_AMOUNT, " +
        "\n            pmpaym.t_PayFIID T_PAYFIID, " +
        "\n            pmpaym.t_PayerBankID T_PAYERBANKID, " +
        "\n            pmpaym.t_ReceiverBankID T_RECEIVERBANKID, " +
        "\n            pmprop.t_BankCode T_BANKCODE_D, " +
        "\n            pmprop.t_IsSender T_ISSENDER_D, " +
        "\n            prop2.t_BankCode T_BANKCODE_K, " +
        "\n            prop2.t_IsSender T_ISSENDER_K, " +
        "\n            trunc(rminprop.t_PlaceDate) T_PLACEDATE, " +
        "\n            trunc(rminprop.t_OutDate) T_OUTDATE, " +
        "\n            rminprop.t_Account T_ACCOUNT, " +
        "\n            account.t_Open_Close T_OPEN_CLOSE, " +
        "\n            arh.t_date_carry T_DATE_CARRY "
        "\n     FROM   daccount_dbt account, " +
        "\n            dpmpaym_dbt pmpaym, " +
        "\n            dpmprop_dbt pmprop, " +
        "\n            dpmrmprop_dbt pmrmprop, " +
        "\n            dpmprop_dbt prop2, " +
        "\n            drminprop_dbt rminprop, " +
        "\n            dpmdocs_dbt docs, "+
        "\n            darhdoc_dbt arh "+
        "\n    WHERE       rminprop.t_PaymentID = pmpaym.t_PaymentID " +
        "\n    AND pmpaym.t_PaymentID = pmrmprop.t_PaymentID " +
        "\n    AND pmpaym.t_Department = 1 " +
        "\n    AND pmpaym.t_PaymentID = pmprop.t_PaymentID(+) " +
        "\n    AND pmprop.t_DebetCredit(+) = 1 " +
        "\n    AND pmprop.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_PaymentID = prop2.t_PaymentID(+) " +
        "\n    AND prop2.t_DebetCredit(+) = 0 " +
        "\n    AND prop2.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_ReceiverAccount = account.t_Account(+) " +
        "\n    AND pmpaym.t_chapter = account.t_chapter(+) " +
        "\n    AND rminprop.t_FIID = 0 " +
      /*"   AND rminprop.t_closed <> 'X' " +*/
        "\n    AND ( " +
        "\n         ( " +
        "\n            rminprop.t_ACCOUNT LIKE '47416%' AND " +
        "\n            (          " +
        "\n                                      select max(adc.t_date_carry) t_date_carry " +
        "\n                                        from dpmdocs_dbt pmd,  " +
        "\n                                             darhdoc_dbt adc,  " +
        "\n                                             dpmpaym_dbt pm  " +
        "\n                                       where pm.t_paymentid = pmpaym.t_paymentid  " +
        "\n                                         and pm.t_paymentid = pmd.t_paymentid  " +
        "\n                                         and adc.t_applicationkey(+) = pmd.t_applicationkey  " +
        "\n                                         and adc.t_iapplicationkind(+) = pmd.t_applicationkind  " +
        "\n                                         and adc.t_account_receiver like '47416%' ) <= ? AND " +
        "\n            ( " +
        "\n             (rminprop.t_OutDate > ?) " +
        "\n             OR " +
        "\n             (rminprop.t_OutDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')) " +
        "\n            ) AND rminprop.t_FIID = 0 " +
        "\n           )  " +
        "\n           OR " +
        "\n           ( " +
        "\n            rminprop.t_PlaceDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') AND" +
        "\n            rminprop.t_ACCOUNT = chr(1) AND " +
        "\n            pmpaym.t_FIID = 0 AND " +
        "\n            rminprop.t_closed <> 'X' " +
        "\n           ) " +
        "\n          ) " + /*Чтобы работало и по сконвертированным документам*/
        "\n    AND pmpaym.t_paymentid not in ( " +        
                                         "\n   select pm.t_paymentid " +
                                         "\n     from dpmdocs_dbt pmd, " +
                                         "\n          darhdoc_dbt adc, " +
                                         "\n          dpmpaym_dbt pm " +
                                         "\n    where pm.t_paymentid = pmpaym.t_paymentid " +
                                         "\n      and pm.t_paymentid = pmd.t_paymentid " +
                                         "\n      and adc.t_applicationkey(+) = pmd.t_applicationkey " +
                                         "\n      and adc.t_iapplicationkind(+) = pmd.t_applicationkind " +
                                         "\n      and adc.t_account_payer like '47416%' " +
                                         "\n      and adc.t_date_carry <= ? ) " +          
        "\n    AND pmpaym.t_paymentid = docs.t_paymentid "+
        "\n    AND docs.T_APPLICATIONKEY = arh.T_APPLICATIONKEY "+
        "\n    AND docs.T_APPLICATIONKIND = arh.T_IAPPLICATIONKIND "+
        "\n    AND arh.T_ACCOUNT_receiver like '"+Acc47416+"' "+
        "\n  order by arh.T_ACCOUNT_receiver,arh.t_date_carry,pmpaym.t_amount"; // KS 06.12.2010 По счету, дате, сумме
  /*getstring(query);*/
  */
query = "  SELECT   pmrmprop.t_PaymentID T_PAYMENTID, " +
        "\n            pmrmprop.t_Number T_NUMBER, " +
        "\n            pmrmprop.t_ShifrOper T_SHIFROPER, " +
        "\n            pmpaym.t_PayerAccount T_PAYERACCOUNT, " +
        "\n            pmpaym.t_ReceiverAccount T_RECEIVERACCOUNT, " +
        "\n            pmpaym.t_Amount T_AMOUNT, " +
        "\n            pmpaym.t_PayFIID T_PAYFIID, " +
        "\n            pmpaym.t_PayerBankID T_PAYERBANKID, " +
        "\n            pmpaym.t_ReceiverBankID T_RECEIVERBANKID, " +
        "\n            pmprop.t_BankCode T_BANKCODE_D, " +
        "\n            pmprop.t_IsSender T_ISSENDER_D, " +
        "\n            prop2.t_BankCode T_BANKCODE_K, " +
        "\n            prop2.t_IsSender T_ISSENDER_K, " +
        "\n            trunc(rminprop.t_PlaceDate) T_PLACEDATE, " +
        "\n            trunc(rminprop.t_OutDate) T_OUTDATE, " +
        "\n            rminprop.t_Account T_ACCOUNT, " +
        "\n            account.t_Open_Close T_OPEN_CLOSE, " +
        "\n            trn.t_date_carry T_DATE_CARRY "
        "\n     FROM   daccount_dbt account, " +
        "\n            dpmpaym_dbt pmpaym, " +
        "\n            dpmprop_dbt pmprop, " +
        "\n            dpmrmprop_dbt pmrmprop, " +
        "\n            dpmprop_dbt prop2, " +
        "\n            drminprop_dbt rminprop, " +
        "\n            dpmdocs_dbt docs, "+
        "\n            dacctrn_dbt trn "+
        "\n    WHERE       rminprop.t_PaymentID = pmpaym.t_PaymentID " +
        "\n    AND pmpaym.t_PaymentID = pmrmprop.t_PaymentID " +
        "\n    AND pmpaym.t_Department = 1 " +
        "\n    AND pmpaym.t_PaymentID = pmprop.t_PaymentID(+) " +
        "\n    AND pmprop.t_DebetCredit(+) = 1 " +
        "\n    AND pmprop.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_PaymentID = prop2.t_PaymentID(+) " +
        "\n    AND prop2.t_DebetCredit(+) = 0 " +
        "\n    AND prop2.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_ReceiverAccount = account.t_Account(+) " +
        "\n    AND pmpaym.t_chapter = account.t_chapter(+) " +
        "\n    AND rminprop.t_FIID = 0 " +
      /*"   AND rminprop.t_closed <> 'X' " +*/
        "\n    AND ( " +
        "\n         ( " +
        "\n            rminprop.t_ACCOUNT LIKE '47416%' AND " +
        "\n            (          " +
        "\n                                      select max(ttrn.t_date_carry) t_date_carry " +
        "\n                                        from dpmdocs_dbt pmd,  " +
        "\n                                             dacctrn_dbt ttrn, " +
        "\n                                             dpmpaym_dbt pm  " +
        "\n                                       where pm.t_paymentid = pmpaym.t_paymentid  " +
        "\n                                         and pm.t_paymentid = pmd.t_paymentid  " +
        "\n                                         and ttrn.t_acctrnid(+) = pmd.t_acctrnid" +
        "\n                                         and ttrn.t_account_receiver like '47416%' ) <= ? AND " +
        "\n            ( " +
        "\n             (rminprop.t_OutDate > ?) " +
        "\n             OR " +
        "\n             (rminprop.t_OutDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')) " +
        "\n             OR " +
        /*DAI R-632606*/
        "\n             (rminprop.t_PlaceDate = rminprop.t_OutDate AND rminprop.t_OutDate = ?) " +  
        /**/
        "\n            ) AND rminprop.t_FIID = 0 " +
        "\n           )  " +
        "\n           OR " +
        "\n           ( " +
        "\n            rminprop.t_PlaceDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') AND" +
        "\n            rminprop.t_ACCOUNT = chr(1) AND " +
        "\n            pmpaym.t_FIID = 0 AND " +
        "\n            rminprop.t_closed <> 'X' " +
        "\n           ) " +
        "\n          ) " + /*Чтобы работало и по сконвертированным документам*/
        "\n    AND pmpaym.t_paymentid not in ( " +        
                                         "\n   select pm.t_paymentid " +
                                         "\n     from dpmdocs_dbt pmd, " +
                                         "\n          dacctrn_dbt t_trn, " +
                                         "\n          dpmpaym_dbt pm " +
                                         "\n    where pm.t_paymentid = pmpaym.t_paymentid " +
                                         "\n      and pm.t_paymentid = pmd.t_paymentid " +
                                         "\n      and t_trn.t_acctrnid(+) = pmd.t_acctrnid " +
                                         "\n      and t_trn.t_account_payer like '47416%' " +
                                         "\n      and t_trn.t_date_carry <= ? ) " +          
        "\n    AND pmpaym.t_paymentid = docs.t_paymentid "+
        "\n    AND docs.t_acctrnid = trn.t_acctrnid "+
        "\n    AND trn.T_ACCOUNT_receiver like '"+Acc47416+"' "+
        "\n  order by trn.T_ACCOUNT_receiver,trn.t_date_carry,pmpaym.t_amount"; // KS 06.12.2010 По счету, дате, сумме

  cmd = RSDCommand(query);
  cmd.addParam("PlaceDate",RSDBP_IN, paneldate1);
  cmd.addParam("OutDate",RSDBP_IN, paneldate1);
  /*DAI R-632606*/
  cmd.addParam("OutDate1",RSDBP_IN, paneldate1);
  cmd.addParam("DateCarry",RSDBP_IN, paneldate1);

  rs = RSDRecordset(cmd);
 if (v_type_report == 0)
  /*Печатаем шапку*/
  PrintHeaderRub();
 end;

   _i=startrow;
  if (numrow > startrow)
    _i=numrow;
  end;
  
  while( rs.moveNext() )  

     acc_left = rs.value("t_payeraccount"); 
     acc_right = rs.value("t_receiveraccount");


     if (substr(rs.value("t_account"), 1, 5) == "47416")
       v_bankcode = rs.value("T_BANKCODE_K");
     else
       v_bankcode = rs.value("T_BANKCODE_D");
     end;

     /*Если значение не определено*/
     if(ValType(v_bankcode) == 26)
       v_bankcode = "";
     end;
/*     v_place_date = date(rs.value("T_PLACEDATE"));*/
     v_place_date = date(rs.value("t_date_carry"));
     v_out_date = sqlDate2date(rs.value("T_OUTDATE"));
     
     if (v_out_date < date(01,01,1001))
      v_out_date = date (00,00,00);;
      v_acc_ok ="";
     else
      v_acc_ok =Get_Account_to_OK(rs.value("T_PAYMENTID"));
     end;

 if (v_type_report == 0)
     [├──────────┼──────────┼─────────────┼───────────────────────────┼─────────────────────────┼─────────────────┤];
     [│##########│##########│  #########  │ ######################### │#########################│#################│]
     ((v_place_date):f,   
                 rs.value("T_NUMBER"):r,
                             v_bankcode,
                                            acc_left,
                                                                       acc_right,
                                                                                                 rs.value("T_AMOUNT"));
 elif (v_type_report == 1)                                                                                     
/*
        obSheet.Rows(_i+":"+_i).Copy;
        obSheet.Cells(_i+1,1).Select;
        obSheet.Paste;
*/       
	obSheet.Cells(_i,1).Value= rs.value("t_account");	
        obSheet.Cells(_i,2).Value= "Российский рубль";		
        obSheet.Cells(_i,3).Value= rs.value("T_AMOUNT");	
        obSheet.Cells(_i,4).Value=obSheet.Cells(_i,3).Value;
        obSheet.Cells(_i,5).Value= v_place_date;	
        obSheet.Cells(_i,6).Value= v_out_date;	
        obSheet.Cells(_i,7).Value= v_acc_ok;	
/*      obSheet.Cells(_i,8).Value= "Саратов";	*/
         _i=_i+1;
 end;

     sum = sum+rs.value("T_AMOUNT");
     cnt = cnt+1;
   end;

  /*Печатаем подвал*/
 if (v_type_report == 0)
   PrintFooterRub(sum, cnt);
 elif ((v_type_report == 1) and (v_mas_acc !=0))
   obSheet.Cells(_i,1).Value= "Итого";	
   obSheet.Cells(_i,4).Value= "=СУММ(D"+(4)+":D"+(_i-1)+")";	
   obSheet.Cells(_i,1).Select;
 end;
/*
onerror(x);
Println(query);
exit(0);
*/
 numRow=_i;
END;


/*Отчет по рублям 47417*/
/*Требование таково, что сумма по штафелю должна соответствовать остатку на счете.*/
/*Приход и расход оформляется мемордерами, поэтому используем только документы */
MACRO outRub47417()

var sum = $0, cnt = 0;
var cmd, query, rs; 
var acc_left = "", acc_right = "", v_bankcode = "";

  /*Gurin S. 30.01.2014 Адаптация 2031
  query = 
     " SELECT arh.t_date_carry t_placedate, arh.t_numb_document t_number, ' ' T_BANKCODE, arh.t_account_payer t_payeraccount, arh.t_account_receiver t_receiveraccount, arh.t_sum t_amount " +
     "  FROM darhdoc_dbt arh " + 
     " WHERE arh.T_ACCOUNT_payer like '47417810%' " +
     " and arh.t_date_carry >= ? " +
     " and arh.t_date_carry <= ? " +
     " and not exists (select 1 " + 
     "                from darhdoc_dbt arh2 " + 
/*     "                where arh2.T_ACCOUNT_payer = arh.T_ACCOUNT_receiver " +
     "                and arh2.T_ACCOUNT_receiver = arh.T_ACCOUNT_payer " +
*/
     "                where arh2.T_ACCOUNT_receiver = arh.T_ACCOUNT_payer " +
     "                and arh2.t_date_carry >= arh.t_date_carry " +
     "                and arh2.t_date_carry <= ? " +
     "                and arh2.t_sum = arh.t_sum) " +
     " order by arh.t_date_carry,arh.t_sum ";
   */
  query = 
     " SELECT trn.t_date_carry t_placedate, trn.t_numb_document t_number, ' ' T_BANKCODE, trn.t_account_payer t_payeraccount, trn.t_account_receiver t_receiveraccount, trn.t_sum_natcur t_amount " +//trn.t_sum_natcur t_amount???
     "  FROM dacctrn_dbt trn " + 
     " WHERE     trn.T_ACCOUNT_payer like '47417810%' " +
     "       and trn.t_date_carry >= ? " +
     "       and trn.t_date_carry <= ? " +
     "       and not exists (select 1 " + 
     "                         from dacctrn_dbt ttrn " + 
     "                        where     ttrn.T_ACCOUNT_receiver = trn.T_ACCOUNT_payer " +
     "                              and ttrn.t_date_carry >= trn.t_date_carry " +
     "                              and ttrn.t_date_carry <= ? " +
     "                              and ttrn.t_sum_natcur = trn.t_sum_natcur) " +
     " order by trn.t_date_carry,trn.t_sum_natcur ";

  /*getstring(query);*/
        
  cmd = RSDCommand(query);
  cmd.addParam("DateCarry1",RSDBP_IN, paneldate1 - 5);
  cmd.addParam("DateCarry2",RSDBP_IN, paneldate1);
  cmd.addParam("DateCarry3",RSDBP_IN, paneldate1);


  rs = RSDRecordset(cmd);

  /*Печатаем шапку*/
  PrintHeaderRub();

  while( rs.moveNext() )  

     acc_left = rs.value("t_payeraccount"); 
     acc_right = rs.value("t_receiveraccount");

     v_bankcode = rs.value("T_BANKCODE");

     [├──────────┼──────────┼─────────────┼───────────────────────────┼─────────────────────────┼─────────────────┤];
     [│##########│##########│  #########  │ ######################### │#########################│#################│]
     (date(rs.value("T_PLACEDATE")):f,   
                 rs.value("T_NUMBER"),
                             v_bankcode,
                                            acc_left,
                                                                       acc_right,
                                                                                                 rs.value("T_AMOUNT"));

     sum = sum+rs.value("T_AMOUNT");
     cnt = cnt+1;
   end;

  /*Печатаем подвал*/
  PrintFooterRub(sum, cnt);

END;


MACRO outCur() 

  var sum = $0, cnt = 0, cnt1 = 0, codec = "";
  var cmd, query, rs;
  var acc_left = "", acc_right = "", v_bankcode = "",  v_place_date:date, v_winner = "",v_out_date:date; ;
  var v_name_cur, v_err_get_cur,v_cover_sum;
  var v_acc_ok ="";
  private var _i=0;
/*Gurin S. 30.01.2014 Адаптация 2031
query = "  SELECT   pmpaym.t_ValueDate t_VALUEDATE, " +
        "\n            pmrmprop.t_Number T_NUMBER, " +
        "\n            pmpaym.t_PayerAccount T_PAYERACCOUNT, " +
        "\n            pmpaym.t_ReceiverAccount T_RECEIVERACCOUNT, " +
        "\n            pmrmprop.t_ReceiverName T_RECEIVERNAME, " +
        "\n            pmpaym.t_FuturePayerAccount T_FUTUREPAYERACCOUNT, " +
        "\n            pmpaym.t_FutureReceiverAccount T_FUTURERECEIVERACCOUNT, " +
        "\n            pmpaym.t_Amount T_AMOUNT, " +
        "\n            pmpaym.t_PayFIID T_PAYFIID, " +
        "\n            pmprop.t_BankCode T_BANKCODE_D, " +
        "\n            pmrmprop.t_PayerBankName t_PayerBankName, " +
        "\n            prop2.t_BankCode T_BANKCODE_K, " +
        "\n            trunc(rminprop.t_PlaceDate) T_PLACEDATE, " +
        "\n            trunc(rminprop.t_OutDate) T_OUTDATE, " +
        "\n            rminprop.t_Account T_ACCOUNT, " +
        "\n            arh.t_date_carry T_DATE_CARRY "
        "\n     FROM   daccount_dbt account, " +
        "\n            dpmpaym_dbt pmpaym, " +
        "\n            dpmprop_dbt pmprop, " +
        "\n            dpmrmprop_dbt pmrmprop, " +
        "\n            dpmprop_dbt prop2, " +
        "\n            drminprop_dbt rminprop, " +
        "\n            dpmdocs_dbt docs, "+
        "\n            darhdoc$_dbt arh "+
        "\n    WHERE       rminprop.t_PaymentID = pmpaym.t_PaymentID " +
        "\n    AND pmpaym.t_PaymentID = pmrmprop.t_PaymentID " +
        "\n    AND pmpaym.t_Department = 1 " +
        "\n    AND pmpaym.t_PaymentID = pmprop.t_PaymentID(+) " +
        "\n    AND pmprop.t_DebetCredit(+) = 1 " +
        "\n    AND pmprop.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_PaymentID = prop2.t_PaymentID(+) " +
        "\n    AND prop2.t_DebetCredit(+) = 0 " +
        "\n    AND prop2.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_ReceiverAccount = account.t_Account(+) " +
        "\n    AND pmpaym.t_chapter = account.t_chapter(+) " +
/*        "\n    AND rminprop.t_closed != 'X' " +*/
        "\n    AND ( " +
        "\n         ( " +
        "\n            rminprop.t_ACCOUNT LIKE '47416%' AND " +
        "\n            (          " +
        "\n                                      select adc.t_date_carry  " +
        "\n                                        from dpmdocs_dbt pmd,  " +
        "\n                                             darhdoc$_dbt adc,  " +
        "\n                                             dpmpaym_dbt pm  " +
        "\n                                       where pm.t_paymentid = pmpaym.t_paymentid  " +
        "\n                                         and pm.t_paymentid = pmd.t_paymentid  " +
        "\n                                         and adc.t_applicationkey(+) = pmd.t_applicationkey  " +
        "\n                                         and adc.t_iapplicationkind(+) = pmd.t_applicationkind  " +
        "\n                                         and adc.t_account_receiver like '47416%' ) <= ? AND " +
        "\n            ( " +
        "\n             (rminprop.t_OutDate > ?) " +
        "\n             OR " +
        "\n             (rminprop.t_OutDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')) " +
        "\n            ) AND rminprop.t_FIID != 0 " +
        "\n           )  " +
        "\n           OR " +
        "\n           ( " +
        "\n            rminprop.t_PlaceDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') AND" +
        "\n            rminprop.t_ACCOUNT = chr(1) AND " +
        "\n            pmpaym.t_FIID != 0 AND " +
        "\n            rminprop.t_closed <> 'X' " +
        "\n           ) " +
        "\n          ) " + /*Чтобы работало и по сконвертированным документам*/
        "\n    AND pmpaym.t_paymentid not in ( " +        
                                         "\n   select pm.t_paymentid " +
                                         "\n     from dpmdocs_dbt pmd, " +
                                         "\n          darhdoc$_dbt adc, " +
                                         "\n          dpmpaym_dbt pm " +
                                         "\n    where pm.t_paymentid = pmpaym.t_paymentid " +
                                         "\n      and pm.t_paymentid = pmd.t_paymentid " +
                                         "\n      and adc.t_applicationkey(+) = pmd.t_applicationkey " +
                                         "\n      and adc.t_iapplicationkind(+) = pmd.t_applicationkind " +
                                         "\n      and adc.t_account_payer like '47416%' " +
                                         "\n      and adc.t_date_carry <= ? ) " +          
        "\n    AND pmpaym.t_paymentid = docs.t_paymentid "+
        "\n    AND docs.T_APPLICATIONKEY = arh.T_APPLICATIONKEY "+
        "\n    AND docs.T_APPLICATIONKIND = arh.T_IAPPLICATIONKIND "+
        "\n    AND arh.T_ACCOUNT_receiver like '"+Acc47416+"' "+
        "\n  order by arh.T_ACCOUNT_receiver,arh.t_date_carry,pmpaym.t_amount"; // KS 06.12.2010 По счету, дате, сумме
*/
query = "  SELECT   pmpaym.t_ValueDate t_VALUEDATE, " +
        "\n            pmrmprop.t_Number T_NUMBER, " +
        "\n            pmpaym.t_PayerAccount T_PAYERACCOUNT, " +
        "\n            pmpaym.t_ReceiverAccount T_RECEIVERACCOUNT, " +
        "\n            pmrmprop.t_ReceiverName T_RECEIVERNAME, " +
        "\n            pmpaym.t_FuturePayerAccount T_FUTUREPAYERACCOUNT, " +
        "\n            pmpaym.t_FutureReceiverAccount T_FUTURERECEIVERACCOUNT, " +
        "\n            pmpaym.t_Amount T_AMOUNT, " +
        "\n            pmpaym.t_PayFIID T_PAYFIID, " +
        "\n            pmprop.t_BankCode T_BANKCODE_D, " +
        "\n            pmrmprop.t_PayerBankName t_PayerBankName, " +
        "\n            prop2.t_BankCode T_BANKCODE_K, " +
        "\n            trunc(rminprop.t_PlaceDate) T_PLACEDATE, " +
        "\n            trunc(rminprop.t_OutDate) T_OUTDATE, " +
        "\n            rminprop.t_Account T_ACCOUNT, " +
        "\n            trn.t_date_carry T_DATE_CARRY "
        "\n     FROM   daccount_dbt account, " +
        "\n            dpmpaym_dbt pmpaym, " +
        "\n            dpmprop_dbt pmprop, " +
        "\n            dpmrmprop_dbt pmrmprop, " +
        "\n            dpmprop_dbt prop2, " +
        "\n            drminprop_dbt rminprop, " +
        "\n            dpmdocs_dbt docs, "+
        "\n            dacctrn_dbt trn "+
        "\n    WHERE       rminprop.t_PaymentID = pmpaym.t_PaymentID " +
        "\n    AND pmpaym.t_PaymentID = pmrmprop.t_PaymentID " +
        "\n    AND pmpaym.t_Department = 1 " +
        "\n    AND pmpaym.t_PaymentID = pmprop.t_PaymentID(+) " +
        "\n    AND pmprop.t_DebetCredit(+) = 1 " +
        "\n    AND pmprop.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_PaymentID = prop2.t_PaymentID(+) " +
        "\n    AND prop2.t_DebetCredit(+) = 0 " +
        "\n    AND prop2.t_Group(+) = 1 " +
        "\n    AND pmpaym.t_ReceiverAccount = account.t_Account(+) " +
        "\n    AND pmpaym.t_chapter = account.t_chapter(+) " +
/*        "\n    AND rminprop.t_closed != 'X' " +*/
        "\n    AND ( " +
        "\n         ( " +
        "\n            rminprop.t_ACCOUNT LIKE '47416%' AND " +
        "\n            (          " +
        "\n                                      select ttrn.t_date_carry  " +
        "\n                                        from dpmdocs_dbt pmd,  " +
        "\n                                             dacctrn_dbt ttrn,  " +
        "\n                                             dpmpaym_dbt pm  " +
        "\n                                       where pm.t_paymentid = pmpaym.t_paymentid  " +
        "\n                                         and pm.t_paymentid = pmd.t_paymentid  " +
        "\n                                         and ttrn.t_acctrnid(+) = pmd.t_acctrnid " +
        "\n                                         and ttrn.t_account_receiver like '47416%' ) <= ? AND " +
        "\n            ( " +
        "\n             (rminprop.t_OutDate > ?) " +
        "\n             OR " +
        "\n             (rminprop.t_OutDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')) " +
        "\n            ) AND rminprop.t_FIID != 0 " +
        "\n           )  " +
        "\n           OR " +
        "\n           ( " +
        "\n            rminprop.t_PlaceDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') AND" +
        "\n            rminprop.t_ACCOUNT = chr(1) AND " +
        "\n            pmpaym.t_FIID != 0 AND " +
        "\n            rminprop.t_closed <> 'X' " +
        "\n           ) " +
        "\n          ) " + /*Чтобы работало и по сконвертированным документам*/
        "\n    AND pmpaym.t_paymentid not in ( " +        
                                         "\n   select pm.t_paymentid " +
                                         "\n     from dpmdocs_dbt pmd, " +
                                         "\n          dacctrn_dbt t_trn, " +
                                         "\n          dpmpaym_dbt pm " +
                                         "\n    where pm.t_paymentid = pmpaym.t_paymentid " +
                                         "\n      and pm.t_paymentid = pmd.t_paymentid " +
                                         "\n      and t_trn.t_acctrnid(+) = pmd.t_acctrnid " +
                                         "\n      and t_trn.t_account_payer like '47416%' " +
                                         "\n      and t_trn.t_date_carry <= ? ) " +          
        "\n    AND pmpaym.t_paymentid = docs.t_paymentid "+
        "\n    AND docs.t_acctrnid = trn.t_acctrnid "+
        "\n    AND trn.T_ACCOUNT_receiver like '"+Acc47416+"' "+
        "\n  order by trn.T_ACCOUNT_receiver,trn.t_date_carry,pmpaym.t_amount"; // KS 06.12.2010 По счету, дате, сумме

  /*getstring(query);*/
        
  cmd = RSDCommand(query);
  cmd.addParam("PlaceDate",RSDBP_IN, paneldate1);
  cmd.addParam("OutDate",RSDBP_IN, paneldate1);
  cmd.addParam("DateCarry",RSDBP_IN, paneldate1);


  rs = RSDRecordset(cmd);

   _i=startrow;
  if (numrow > startrow)
    _i=numrow;
  end;

  while( rs.moveNext() ) 
 
     if (cnt == 0)
       codec = rs.value("T_PAYFIID");
       v_name_cur = ПолучитьИмяФинИн ( codec, v_err_get_cur);
       /*Печатаем шапку*/
       if(v_err_get_cur == 0)
         PrintHeaderCur(v_name_cur);
       else
         PrintHeaderCur("");
       end;
     end;

     if (codec != rs.value("T_PAYFIID"))
        codec = rs.value("T_PAYFIID");
        v_name_cur = ПолучитьИмяФинИн (codec, v_err_get_cur);
        PrintMiddleCur( sum, int(cnt1), v_name_cur);
        sum = $0;
        cnt1 = 0;
     end;

     if (substr(rs.value("t_account"), 1, 5) == "47416")
       v_bankcode = rs.value("T_BANKCODE_K");
       acc_right = rs.value("t_receiveraccount");
       if ( fgBank.is_PRBB ) 
           acc_left = rs.value("t_futurepayeraccount"); 
           v_winner = Get_Name_Account(acc_right);
       else
           acc_left = rs.value("t_payeraccount"); 
           v_winner = rs.value("T_RECEIVERNAME");
       end;
     else
       v_bankcode = rs.value("T_BANKCODE_D");
       acc_left = rs.value("t_payeraccount"); 
       acc_right = rs.value("t_futurereceiveraccount");
       v_winner = Get_Name_Account(acc_right);
     end;

     /*Если значение не определено*/
     if(ValType(v_bankcode) == 26)
       v_bankcode = "";
     end;

     v_place_date = date(rs.value("t_date_carry"));
     v_out_date = sqlDate2date(rs.value("T_OUTDATE"));
     
     if (v_out_date < date(01,01,1001))
      v_out_date = date (00,00,00);;
     end;

 if (v_type_report == 0)
/*SDA 12/01/2012 C-6586
     [├──────────┼──────────┼───────────────────────────┼──────────┼──────────┼──────────────────────┼──────────────────────┤];
     [│##########│##########│ ######################### │##########│##########│ #################### │######################│]
     (v_place_date:f,   
                  date(rs.value("t_VALUEDATE")):f,
                              acc_left,
                                                         rs.value("T_AMOUNT"),
                                                                    v_out_date:f,
                                                                                acc_right,
                                                                                                      v_winner:w);

*/                                                                                                             
     [├──────────┼──────────┼─────────────────┼──────────────────────┼────────────────────┼──────────────┼─────────────────────┤];
     [│##########│##########│#################│######################│####################│##############│#####################│]
     (v_place_date:f,   
                  rs.value("T_NUMBER"), 
                           string(rs.value("T_BANKCODE_K")," ",rs.value("t_PayerBankName")):w,
                                           acc_left,
                                                                        acc_right,
                                                                                                  rs.value("T_AMOUNT"),
                                                                                                                 v_winner:w);
 elif (v_type_report == 1)                                                                                     
/*
        obSheet.Rows(_i+":"+_i).Copy;
        obSheet.Cells(_i+1,1).Select;
        obSheet.Paste;
*/       
	obSheet.Cells(_i,1).Value= rs.value("t_account");	
        obSheet.Cells(_i,2).Value= ПолучитьИмяФинИн (codec, v_err_get_cur);	
        obSheet.Cells(_i,3).Value= rs.value("T_AMOUNT");	
        ConvSum( v_cover_sum, rs.value("T_AMOUNT"), v_place_date,codec);
        obSheet.Cells(_i,4).Value= v_cover_sum;

        obSheet.Cells(_i,5).Value= v_place_date;	
        obSheet.Cells(_i,6).Value= v_out_date;	
        obSheet.Cells(_i,7).Value= v_acc_ok;	
/*      obSheet.Cells(_i,8).Value= "Саратов";	*/
         _i=_i+1;
 end;




     cnt=cnt+1;
     /*codec = rs.value("T_PAYFIID");*/
     cnt1=cnt1+1;
     sum = sum + rs.value("T_AMOUNT");
  end;

  /*Печатаем подвал*/
 if (v_type_report == 0)
   PrintFooterCur( int(cnt1), sum );
 elif (v_type_report == 1) 
   obSheet.Cells(_i,1).Value= "Итого";	
   obSheet.Cells(_i,4).Value= "=СУММ(D"+(4)+":D"+(_i-1)+")";	
   obSheet.Cells(_i,1).Select;
 end;
/*
onerror(x);
Println(query);
exit(0);
*/
 numRow=_i;


END;

/************************/
/* Точка входа в макрос */                                                                                       /************************/

  paneldate1 = {curdate};
  type_report(0) = "Ведомость-расшифровка невыясненных документов";
  type_report(1) = "Анализ по счетам невыясненных сумм";
  v_type_report = menu(type_report, "Выберите форму отчета", "Выберите форму отчета:");
  if (v_type_report < 0 ) exit(1) end;

  if (getdate(paneldate1, "Введите дату отчета"));
/* SDA
    If (Paneldate1=="")
      Paneldate1="01.01.2000";
    End;
*/
    rselect = "select t_account " +   
              "\n  from daccount_dbt where t_account like '47416%'" +
              "\n  order by t_account";

    cmd = RSDCommand(rselect);
    rsrec = RSDRecordset( cmd);

    count = 2;
    mas_acc(0) = "По всем счетам";
    mas_acc(1) = "По всем счетам в ин.валюте";
        
    while (rsrec.MoveNext)
      mas_acc(count) = rsrec.Value(0);
      count = count + 1;
    end;
  
    v_mas_acc = menu(mas_acc, "Выберите счет", "Выберите счет:");

   if (v_type_report == 1)

   ob = CFastExcel(False);
	GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERTEMPLSDIR",2,out);
   Fulloutput = FindPath(output, out);
   if (not Fulloutput)
      msgbox("Не найден шаблон");
      exit();
   end;
     ex = ob.Open(Fulloutput);
     ex.visible = false;
     obBook = ex.ActiveWorkbook; 
     obSheet = obBook.ActiveSheet(); 	
     obSheet.Cells(1,1).Value= {name_bank} + " за "+ paneldate1;	
/*
     ob.Show;
     exit(0);
*/
   end;

    if (v_mas_acc>=0);
      if (v_mas_acc==0)
        Acc47416 = "47416%";
        outRub();
        outCur();
      elif (v_mas_acc==1)
        Acc47416 = "47416%";
        outCur();
      else
        Acc47416 = mas_acc(v_mas_acc);
        if (substr(Acc47416,6,3)=="810")
          outRub();
        else
          outCur();
        end;
      end;
    else
      exit(1);
    end;

  end;

  if (v_type_report == 1)
  obBook.ActiveSheet.Range("A4:h"+(numRow)).Borders.Weight=2;
  exit(1);
  end;
