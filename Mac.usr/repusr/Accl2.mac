/*Cканирование картотеки 2 по счетам конкретного операциониста         */
/*                                                                     */
/*                                                                     */
/*Тихомиров А.Н. 26.01.2009        Версия 1.1                          */
/*Амелин А.Н. 04.05.2012   C-9973 переделал подотчёт Картотека в Бюджет*/
/* много чего поправил, см. ТЗ   */
//16.05.2012 DEV по I-00194202-1 не подтягивались претензии, у которых есть буд.дата со статусом "Закрыт"
//16.05.2012 DEV добавила в рамках проверки заявки I-00194202-1, не попадал признак J
//11.07.2012 vihrov C-12122 смена диапазонов кодов
/*26.12.2012 LAO I-00305511-3 этот макрос спасет только удаление, запрос читается с 20-ой попытки, оптимизировал */
/*17.01.2013 Gurin S. I-00313272-3*/
//27.06.2013 Жаворонкова Н. (joy) R-209871-2 Изменения в функции SinPl1(acc) - ищем наибольший статус претензии
//30.07.2013 DPN C-22213-6 Создание дополнительного отчёта по б/о в Картотеке 2 с происхожд. Комиссия за обсл., с притензиями 
//09.08.2013 Gurin S. C-17880 
//09.09.2013 DPN C-23012 ─ Доработка отчёта "Картотека в бюджет"
//14.12.2013 Гуцу Адаптация под новую версию RS-Bank 6.20.031
//Gurin S. 12.02.2014 I-00464060-2 (2031)(оптимизация запроса)
//Gurin S. 18.06.2014 R-394646-2 (перенес C-25869 в 2031)
//zmp 06.01.2015 C-34379 для прбб
//-------------------------------------------------------------------------------------------------------------------------

import globals, oralib, bankinter, likePy, lib_lang;
/* EVG 15/07/2011 */
import cb_sql;

//16.05.2012 DEV в рамках проверки заявки I-00194202-1, не попадал признак J
/* EVG 21/10/2011 Унификация */
import fg_Life_parm;



import RSD, rsbdataset, psinter;
var SQL,cmd,ex,ob,obbook,obsheet, wdays, rest, n, sm, cnt, datasq, sq, acclaiminf, i, as, br, dprt_v, k, sum1, sum2;
var maxs:integer;
array comment;
record Department ("dp_dep.dbt");
record Person     ("person.dbt");
var Fulloutputl, outl, outputl="accl2.lbr";                    

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("kart2", fulloutputl, TRUE); 

const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;

//var output="..\\Rest2.txt";              
var output = GetTxtFileName("rest2");

var inter:string,
    Branch:integer,
    NameBr:string = "",
    NumBranch:string = "",
    NameBranch:string = "",
    OperNum:integer = 0,
    OperName:string = "",
    MinRest:money = 0;

/* EVG 15/07/2011 */
const REPTYPE_ALL    = 0,
      REPTYPE_BUDGET = 1, 
      REPTYPE_RKO    = 2,
      REPTYPE_RKO_WITH_CLAIMS = 3; //30.07.2013 DPN Добавил константу для пункта меню "Картотека РКО с притензиями" C-22213-6
var ReportType, ReportTypeTxt, isAccountForRkoRepType;

//16.05.2012 DEV добавила в рамках проверки заявки I-00194202-1, не попадал признак J
 /* EVG 21/10/2011 Унификация */
 var bnk = fg_life_subject();
 bnk.ConsrtuctByBic( {MFO_bank} );


private macro sumpr(planrest,sinpl2)
   if ((planrest - sinpl2)>0 )
   return (planrest - sinpl2)
   else
   return 0;
   end;
end;

/*Начало группы операционистов*/
private macro persongroupoperfo(id)
var  sl=" select t.t_groupoperfo as grp from dperson_dbt t where t.t_oper="+id;
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.grp;
  end;
end;

/*Окончание группы операционистов*/
private macro persongroupoperlo(id)
var  sl=" select t.t_groupoperlo as grp from dperson_dbt t where t.t_oper="+id;
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.grp;
  end;
end;

/*Имя по Partyid*/
private macro GetClientName(id)
var  sl=" select t_name from dparty_dbt t where t.t_PartyID="+id;
var  DataS=TRsbDataSet(sl);
  if( DataS.moveNext())
    return DataS.name;
  else
    if (id !=0)
       msgbox("Субъект не найден в party.dbt");
       return 0;
    else
      return "ОАО АКБ Пробизнесбанк";
    end;
  end;
END;

/* Процедура отображения название операциониста по номеру */
private macro GetOperName(NumOper:integer):string
var sl = "SELECT t_name FROM dperson_dbt "+
          "WHERE t_oper = "+NumOper+"";
var dataS = TRsbDataSet(sl);;
 while(DataS.moveNext())
   return DataS.name;
 end;
 return "";  
end;

/*Определение претензий к счету*/
private macro acclaim(acc)
var sl;
//sl = "select count(*) cnt from dacclaim_dbt where t_account='"+acc+"'";
//Lavrenov - только активные претензии
sl = "SELECT count(*) " +
     "  FROM dacclaim_dbt cl, dacclaimstate_dbt st " +
     " WHERE cl.t_account = '"+acc+"'" +
     "   AND st.t_claimid = cl.t_claimid " +
     "   AND st.t_state = 1 " +
     "   AND cl.t_startdate <= TO_DATE ('"+{curdate}+"', 'dd.mm.yyyy') " ;

var DataS = TRsbDataSet(sl);
dataS.movenext();

return dataS.cnt;

end;

/*Тип претензии*/
private macro TypeP(id)
var sl = "SELECT   t_name FROM dllvalues_dbt WHERE t_list = 2522 and t_flag="+id;

var DataS = TRsbDataSet(sl);
dataS.movenext();

return dataS.name;

end;

/*Вид претензии*/
private macro TypeV(id)
var sl = "SELECT  t_name  FROM dllvalues_dbt  WHERE t_list = 2520 and t_flag="+id;

var DataS = TRsbDataSet(sl);
dataS.movenext();

return dataS.name;

end;
 
private macro SinPl1(acc)

var sl = "SELECT COUNT (1), nvl(SUM (acclaimstate.t_currentamount),0) as sm"+
"  FROM dacclaim_dbt claim, dacclaimstate_dbt acclaimstate "+
" WHERE claim.t_chapter = 1 "+
" and (claim.t_finishdate > to_date ('"+{curdate}+"','DD-MM-YYYY') or claim.t_finishdate = to_date ('01.01.0001','DD-MM-YYYY')) "+
" and ACCLAIMSTATE.T_STATE = (SELECT MAX (t_state) " +                // 27.06.2013 joy R-209871-2 Нужен наибольший статус претензии
"                               FROM DACCLAIMSTATE_DBT " +            
"                              WHERE T_CLAIMID = claim.T_CLAIMID)"+   
" and acclaimstate.t_state in (1,2)  "+
"   AND claim.t_account = '"+acc+"'"+
"      AND claim.t_claimid = acclaimstate.t_claimid ";

var DataS = TRsbDataSet(sl);
if (dataS.movenext())
return dataS.sm;
else
return 0;
end;
end;

/*Проводки по претензии*/ 
private macro SinPl(acc)
//var sl = "select pmpaym.t_amount, t.t_priority "+
//var sl = "select pmpaym.T_PARTPAYMRESTAMOUNTMAIN, t.t_priority "+
var sl = "select pmpaym.T_FUTUREPAYERAMOUNT, t.t_priority "+
     "from dpsinprop_dbt t, dpmpaym_dbt pmpaym "+
     "where t.t_account='"+acc+"' and pmpaym.t_paymentid=t.t_paymentid order by t_priority";

var DataS = TRsbDataSet(sl);
dataS.movenext();

//return dataS.amount;
//return dataS.PARTPAYMRESTAMOUNTMAIN;
return dataS.T_FUTUREPAYERAMOUNT;
end;

/*Сумма проводок претензии*/
private macro SumPl(acc)

//var sl = "select sum(pmpaym.t_amount) as sum "+
var sl = "select sum(pmpaym.T_FUTUREPAYERAMOUNT) as sum "+
//var sl = "select sum(pmpaym.T_PARTPAYMRESTAMOUNTMAIN) as sum "+
     "from dpsinprop_dbt t, dpmpaym_dbt pmpaym "+
     "where t.t_account='"+acc+"' and pmpaym.t_paymentid=t.t_paymentid";

var DataS = TRsbDataSet(sl);
datas.movenext();
 if (datas.sum)
   return datas.sum;
 else
   return 0;
 end;
end;

//09.07.2013 Gurin S. C-17880 
private macro SumKOR(acc)

var sl = "select t_sum sum from dpsiwpacc_dbt where T_ACCOUNT = '"+acc+"'";

var DataS = TRsbDataSet(sl);
datas.movenext();
 if (datas.sum)
   return datas.sum;
 else
   return 0;
 end;
end;

private macro summa_k2(acc)                     // AAN сумма проводок для отчёта К2_в_бюджет
   var sql = " SELECT SUM (pp.t_futurepayeramount) AS SUM "
+"\n   FROM dpsinprop_dbt kk, dpmpaym_dbt pp "
+"\n  WHERE kk.t_account = '" + acc + "' "
+"\n    AND kk.t_paymentid = pp.t_paymentid "
+"\n    AND ( (pp.t_receiveraccount NOT LIKE '47423%' "       //16.12.2013 DPN C-25869
+"\n           AND pp.t_payerbankid = pp.t_receiverbankid) "
+"\n        OR (pp.t_receiveraccount LIKE '%' "
+"\n           AND pp.t_payerbankid != pp.t_receiverbankid))"
+"\n    AND ( (pp.t_receiveraccount NOT LIKE '706%' "       //16.12.2013 DPN C-25869
+"\n           AND pp.t_payerbankid = pp.t_receiverbankid) "
+"\n        OR (pp.t_receiveraccount LIKE '%' "
+"\n           AND pp.t_payerbankid != pp.t_receiverbankid))"
+"\n    AND pp.t_paymentid NOT IN ( "
+"\n           SELECT pminf.t_paymentid "
+"\n             FROM dpmaddpi_dbt pminf "
+"\n            WHERE pp.t_paymentid = pminf.t_paymentid "   //16.12.2013 DPN C-25869
+"\n              AND (   (pminf.t_account LIKE '47423%' "
+"\n                        OR pminf.t_account LIKE '70601%') "
+"\n                       AND pp.t_payerbankid = pp.t_receiverbankid "
+"\n                   ) "
+"\n           ) "
+"\n    AND (   pp.t_paymentid NOT IN ( "
+"\n               SELECT nt.t_documentid "
+"\n                 FROM dnotetext_dbt nt "
+"\n                WHERE nt.t_objecttype = 501 "
+"\n                  AND nt.t_documentid = LPAD (pp.t_paymentid, 10, 0) "
+"\n                  AND nt.t_notekind IS NOT NULL "
+"\n                  AND nt.t_notekind = 40 "
+"\n                  AND (   nt.t_validtodate = "
+"\n                                         TO_DATE ('01.01.0001', 'dd, mm, yyyy') "
+"\n                       OR nt.t_validtodate = "
+"\n                                         TO_DATE ('31.12.9999', 'dd, mm, yyyy') "
+"\n                      )) "
+"\n         OR pp.t_paymentid NOT IN ( "
+"\n               SELECT nt.t_documentid "
+"\n                 FROM dnotetext_dbt nt "
+"\n                WHERE nt.t_objecttype = 501 "
+"\n                  AND nt.t_documentid = LPAD (pp.t_paymentid, 10, 0) "
+"\n                  AND nt.t_notekind IS NOT NULL "
+"\n                  AND nt.t_notekind = 41 "
+"\n                  AND (   nt.t_validtodate = "
+"\n                                         TO_DATE ('01.01.0001', 'dd, mm, yyyy') "
+"\n                       OR nt.t_validtodate = "
+"\n                                         TO_DATE ('31.12.9999', 'dd, mm, yyyy') "
+"\n                      )) "
+"\n        ) ";


   var DataS = TRsbDataSet(sql);
   datas.movenext();
    if (datas.sum)
      return datas.sum;
    else
      return 0;
    end;
end;

/*Тип доступа*/
private macro persontype(id)
var sl = "select t_ctypeperson type from dperson_dbt where t_oper="+id;
var DataS = TRsbDataSet(sl);
dataS.movenext();
return dataS.type;
end;

/* EVG 15/07/2011 Функция проверки информации по документам картотеки 2.
   Если все счета получателя по документам картотеки 2 указанного счёта
   соответствуют указанной маске, функция возвращает true, иначе - false. */
macro CheckK2Documents( account )
 var query, rs, mask;
 if (bnk.is_SLD)
     mask = "47423810?3*,47423*,70601*";
 else
     mask = "47423810?3*";
 end;
 

 query = " Select pm.t_ReceiverAccount From DPsInProp_dbt ind, DPmPaym_dbt pm " +
         "  Where ind.t_Account  = " + getSQLString( account ) +
         "    and pm.t_PaymentId = ind.t_PaymentId ";

 rs = rsdRecordSet( query );
 while( rs and rs.moveNext() )
    if ( CompareStrWithMasks( mask, rs.value( 0, null, V_STRING ) ) 
         // Счёт получателя может быть не задан (платёж с разноской)
         and ( rs.value( 0, null, V_STRING ) != strfor( 1 ) ) )

       return false;
    end;
 end;

 return true;
end;

/* EVG 15/07/2011 Функция проверки польз. типа счёта */
macro CheckAccountType( account )
 var query, rs;
 var AccType_Arrest = "Т";

 query = " Select t_Type_Account From DAccount_dbt " +
         "  Where t_Account  = " + getSQLString( account );
 rs = rsdRecordSet( query );
 while( rs and rs.moveNext() )
    if ( index( rs.value( 0, null, V_STRING ), AccType_Arrest ) > 0 )
       return false;
    end;
 end;

 return true;
end;


/* EVG 14/12/2013 Функция формирует строчку планового остатка для подстановки в запрос */
macro planrestSubst( alias, aliasR, p_date )

   if( valType( p_date ) == V_UNDEF )
      p_date = {curdate};
   end;

   if( valType( aliasR ) == V_UNDEF )
      aliasR = "";
   end;


   return "RSI_RSB_ACCOUNT.planresta( " + alias + ".t_account,"
                                        + getSQLDate( p_date ) + ","
                                        + alias + ".t_chapter ) " + aliasR;
end;


/*Выводим в документ*/
private macro OutAll()

 var tmp_sum;

 /* EVG 14/12/2013 Переход на 2031
 var sl = "select count (*) cnt from daccount_dbt acc where acc.t_index2=CHR(88) and acc.t_planrest>"+minrest+inter;*/
 var sl = "select count (*) cnt from daccount_dbt acc where acc.t_index2=CHR(88) and " + planrestSubst( "acc" ) + " >"+minrest+inter;

 var DataS = TRsbDataSet(sl);
 datas.movenext();
 maxs=datas.cnt;
 initprogress(-1,"Обрабатываются счета, ждите","Обрабатываются счета");
 /*sql = "select acc.t_account, acc.t_planrest, acc.t_nameaccount, acc.t_oper, dep.t_name from daccount_dbt acc, ddp_dep_dbt dep where acc.t_index2=CHR(88) "+
       " and acc.t_branch = dep.t_code and acc.t_planrest>"+minrest+inter+
       " order by acc.t_branch, acc.t_oper, acc.t_balance, substr(acc.t_Account,16,5)";
*/
useprogress;
if(ReportType == REPTYPE_BUDGET)
    
   /* EVG 14/12/2013 Переход на 2031
   sql = " SELECT not_arest.t_account, not_arest.t_planrest, not_arest.t_nameaccount, "*/
   sql = " SELECT not_arest.t_account, " + planrestSubst( "not_arest", "planrest" ) + ", not_arest.t_nameaccount, "

+"\n        not_arest.t_oper, not_arest.t_name, not_arest.cl, not_arest.not113, "
+"\n        not_arest.not_47423_not_4041, not_arest.typ, not_arest.claimamount "

/* EVG 14/12/2013 Переход на 2031
+"\n   FROM (SELECT   a.t_account, a.t_planrest, a.t_nameaccount, a.t_oper, "*/
+"\n   FROM (SELECT   a.t_account, " + planrestSubst( "a" ) + ", a.t_nameaccount, a.t_oper, a.t_chapter, "

+"\n                  a.t_name, b.cl, a.typ, nvl(b.claimamount, 0) claimamount,"
+"\n                  (SELECT distinct CHR (88) "
+"\n                     FROM dacclaim_dbt claim, "
+"\n                          dacclaimstate_dbt acclaimstate "
+"\n                    WHERE (   claim.t_finishdate = "
+"\n                                           TO_DATE ('01.01.0001', 'dd.mm.yyyy') "
+"\n                           OR claim.t_finishdate > "
+"\n                                           TO_DATE ('" + {curdate} + "', 'DD-MM-YYYY') "
+"\n                          ) "
+"\n                      AND claim.t_account = a.t_account "
+"\n                      AND claim.t_claimid = acclaimstate.t_claimid "
+"\n                      AND (    claim.t_initiator = 3 "
+"\n                           AND claim.t_claimkind = 1 "
+"\n                           AND claim.t_restkind = 1 "
+"\n                          ) "
+"\n                      AND (acclaimstate.t_state = 1 OR acclaimstate.t_state = 2 "
+"\n                          ) "
+"\n                      AND acclaimstate.t_statedate = "
+"\n                             (SELECT MAX (t.t_statedate) "
+"\n                                FROM dacclaimstate_dbt t "
+"\n                               WHERE t.t_claimid = claim.t_claimid "
+"\n                                 AND t.t_statedate <= "
+"\n                                           TO_DATE ('" + {curdate} + "', 'DD-MM-YYYY'))) "
+"\n                                                                        not113, "
+"\n                  (SELECT COUNT (1) "
+"\n                     FROM dpsinprop_dbt kk, dpmpaym_dbt pp "
+"\n                    WHERE kk.t_account = a.t_account "
+"\n                      AND kk.t_paymentid = pp.t_paymentid "
+"\n                      AND ( (pp.t_receiveraccount NOT LIKE '47423%' "  //16.12.2013 DPN C-25869
+"\n                             AND pp.t_payerbankid = pp.t_receiverbankid) "
+"\n                           OR (pp.t_receiveraccount LIKE '%' "
+"\n                             AND pp.t_payerbankid != pp.t_receiverbankid))"
+"\n                      AND ( (pp.t_receiveraccount NOT LIKE '706%' "       //16.12.2013 DPN C-25869
+"\n                             AND pp.t_payerbankid = pp.t_receiverbankid) "
+"\n                           OR (pp.t_receiveraccount LIKE '%' "
+"\n                             AND pp.t_payerbankid != pp.t_receiverbankid))"
+"\n                      AND pp.t_paymentid NOT IN ( "
+"\n                             SELECT pminf.t_paymentid "
+"\n                               FROM dpmaddpi_dbt pminf "
+"\n                              WHERE pp.t_paymentid = pminf.t_paymentid "    //16.12.2013 DPN C-25869
+"\n                                AND (   (pminf.t_account LIKE '47423%' "
+"\n                                           OR pminf.t_account LIKE '70601%') "
+"\n                                         AND pp.t_payerbankid = pp.t_receiverbankid "
+"\n                                    ) "
+"\n                             ) "
+"\n                      AND (   pp.t_paymentid NOT IN ( "   //09.09.2013 DPN C-23012 Отбираются счета с примечанием 40 или 41 на плеже. 
+"\n                                 SELECT nt.t_documentid " //Если есть 40 и 41 одновременно, то счёт не попадает в отчёт. 
+"\n                                   FROM dnotetext_dbt nt "
+"\n                                  WHERE nt.t_objecttype = 501 "
+"\n                                    AND nt.t_documentid = "
+"\n                                                   LPAD (pp.t_paymentid, 10, 0) "
+"\n                                    AND nt.t_notekind IS NOT NULL "
+"\n                                    AND nt.t_notekind = 40 "
+"\n                                    AND (   nt.t_validtodate = "
+"\n                                               TO_DATE ('01.01.0001', "
+"\n                                                        'dd, mm, yyyy' "
+"\n                                                       ) "
+"\n                                         OR nt.t_validtodate = "
+"\n                                               TO_DATE ('31.12.9999', "
+"\n                                                        'dd, mm, yyyy' "
+"\n                                                       ) "
+"\n                                        )) "
+"\n                           OR pp.t_paymentid NOT IN  "
+"\n                               (SELECT pm.t_paymentid"
+"\n                                FROM dpmpaym_dbt pm"
+"\n                                WHERE pm.t_dockind = 201"
+"\n                                AND EXISTS"
+"\n                                    (SELECT 1"
+"\n                                     FROM dnotetext_dbt nt,"
+"\n                                          dnotetext_dbt nt2"
+"\n                                     WHERE nt.t_objecttype = 501"
+"\n                                     AND nt.t_objecttype = nt2.t_objecttype"
+"\n                                     AND nt.t_documentid = nt2.t_documentid"
+"\n                                     AND nt.t_notekind = 40"
+"\n                                     AND nt2.t_notekind = 41"
+"\n                                     AND nt.t_documentid = LPAD (pm.t_paymentid, 10, 0))"
+"\n                                    )"
+"\n                 )) not_47423_not_4041 "
+"\n             FROM (SELECT  acc.t_account, " + planrestSubst( "acc" ) + ", "
+"\n                                   acc.t_nameaccount, acc.t_oper, dep.t_name, "
+"\n                                   acc.t_code_currency, acc.t_chapter, "
+"\n                                   acc.t_balance, acc.t_branch, "
+"\n                                   acc.t_type_account typ, acc.t_client "
+"\n                              FROM daccount_dbt acc, "
+"\n                                   ddp_dep_dbt dep "
+"\n                             WHERE acc.t_index2 = CHR (88) "
+"\n                               AND acc.t_branch = dep.t_code "
+"\n                               AND acc.t_chapter = 1 "
+"\n                               AND acc.t_code_currency = 0 "
+"\n                               AND " + planrestSubst( "acc" ) + " > " + minrest + inter
+"\n                               AND        EXISTS "
+"\n                                         (SELECT   1 "
+"\n                                            FROM   dpsinprop_dbt k2 "
+"\n                                           WHERE   k2.t_account = acc.t_account "
+"\n                                                   AND k2.t_fiid = "
+"\n                                                         acc.t_code_currency "
+"\n                                                   AND k2.t_chapter = "
+"\n                                                         acc.t_chapter "
+"\n                                                   AND k2.t_placedate <= "
+"\n                                                         TO_DATE ('" + {curdate} + "', " //17.01.2013 Gurin S. I-00313272-3
+"\n                                                                  'DD-MM-YYYY')) "
+"\n                          ORDER BY acc.t_account) a "
+"\n                  LEFT JOIN "
+"\n                  (SELECT   CHR (88) cl, COUNT (1), claim.t_account, "
+"\n                            claim.t_chapter, claim.t_fiid , sum(decode(CLAIM.T_PRIORITY, 0, ACCLAIMSTATE.T_CURRENTAMOUNT,0)) claimamount"
+"\n                       FROM dacclaim_dbt claim, dacclaimstate_dbt acclaimstate "
+"\n                      WHERE (   claim.t_finishdate = "
+"\n                                           TO_DATE ('01.01.0001', 'dd.mm.yyyy') "
+"\n                             OR claim.t_finishdate > "
+"\n                                           TO_DATE ('" + {curdate} + "', 'DD-MM-YYYY') "
+"\n                            ) "
+"\n                        AND claim.t_claimid = acclaimstate.t_claimid "
+"\n                        AND (   acclaimstate.t_state = 1 "
+"\n                             OR acclaimstate.t_state = 2 "
+"\n                            ) "
+"\n                        AND acclaimstate.t_statedate = "
+"\n                               (SELECT MAX (t.t_statedate) "
+"\n                                  FROM dacclaimstate_dbt t "
+"\n                                 WHERE t.t_claimid = claim.t_claimid "
+"\n                                   AND t.t_statedate <= "
+"\n                                           TO_DATE ('" + {curdate} + "', 'DD-MM-YYYY')) "
+"\n                   GROUP BY claim.t_account, claim.t_chapter, claim.t_fiid) b "
+"\n                  ON a.t_account = b.t_account "
+"\n                AND b.t_chapter = a.t_chapter "
+"\n                AND b.t_fiid = a.t_code_currency, dobjcode_dbt cod where cod.t_codekind=1 and cod.t_objectid=a.t_client and cod.t_state=0 and t_objecttype=3 "
+"\n         ORDER BY b.cl DESC, "
+"\n                  a.t_branch, "
+"\n                  a.t_oper, "
+"\n                  a.t_balance "
//+"\n                  SUBSTR (a.t_account, 16, 5)) not_arest "
+"\n                  , cod.t_code) not_arest "   //11.07.2012 vihrov не надо сортировать по хвосту. по коду можно, по клиенту и т.д. по хвосту нельзя
+"\n  WHERE not_arest.not113 IS NULL AND not_arest.not_47423_not_4041 > 0 ";

//zmp 06.01.2015 C-34379
if(bnk.is_prbb)
   sql = sql + " and not_arest.claimamount < " + planrestSubst("not_arest");
end;

//30.07.2013 DPN Добавил запрос для отчёта "Картотека РКО с притензиями" C-22213-6
elif(ReportType == REPTYPE_RKO_WITH_CLAIMS)

   sql = " SELECT a.t_account, a.plRest planrest, a.t_nameaccount, a.t_oper, a.t_name, b.cl" +
         " FROM (SELECT acc.t_account, " + planrestSubst( "acc", "plRest" ) + ", acc.t_nameaccount, acc.t_oper, dep.t_name, acc.t_code_currency, acc.t_chapter, acc.t_balance, acc.t_branch, acc.t_client" +
         "       FROM daccount_dbt acc, ddp_dep_dbt dep" +
         "       WHERE acc.t_index2 = CHR (88)" +
         "       AND acc.t_branch = dep.t_code" +
         "       AND usr_get_rest_current (acc.t_account, TO_DATE ('" + {curdate} + "', 'dd.mm.yyyy'),5) > 0) a" +
         " right JOIN" +
         "      (SELECT CHR (88) cl, COUNT (1), claim.t_account, claim.t_chapter, claim.t_fiid" +
         "       FROM dacclaim_dbt claim, dacclaimstate_dbt acclaimstate" +
         "       WHERE (claim.t_finishdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')" +
         "       OR claim.t_finishdate > TO_DATE ('" + {curdate} + "', 'dd.mm.yyyy'))" +
         "       AND claim.t_claimid = acclaimstate.t_claimid" +
         "       AND acclaimstate.t_state = 1" +
         "       AND CLAIM.T_CLAIM_CANCEL = 0" +
         "       AND acclaimstate.t_statedate = ((SELECT MAX (t.t_statedate)" +
         "                                        FROM dacclaimstate_dbt t" +
         "                                        WHERE t.t_claimid = claim.t_claimid" +
         "                                        AND t.t_statedate <= TO_DATE ('" + {curdate} + "', 'dd.mm.yyyy')))" +
         "       GROUP BY claim.t_account, claim.t_chapter, claim.t_fiid,  ACCLAIMSTATE.T_STATE) b" +
         " ON    a.t_account = b.t_account" +
         "       AND b.t_chapter = a.t_chapter" +
         "       AND b.t_fiid = a.t_code_currency," +
         "       dobjcode_dbt cod,dpmpaym_dbt dpm, dpmrmprop_dbt rm" +
         " WHERE cod.t_codekind = 1" +
         " AND cod.t_objectid = a.t_client" +
         " AND cod.t_state = 0" +
         " AND cod.t_objecttype = 3" +
         " AND a.t_account = dpm.t_payeraccount" +
         " AND ((dpm.t_dockind = 286" +
         " AND dpm.t_origin = 3)";
         if (bnk.is_SLD)
             sql = sql + " OR ( (dpm.t_dockind = 201 OR dpm.t_dockind = 286) AND dpm.t_origin = 10000 "+ 
             " AND substr(dpm.t_receiveraccount,1,5) in ('47423','70601'))";
         end;
         sql = sql + " ) AND dpm.t_paymstatus = 2000" +
         " AND dpm.t_paymentid = rm.t_paymentid "+
         " AND (usr_get_rest_current(a.t_account, TO_DATE ('" + {curdate} + "', 'dd.mm.yyyy'),rm.t_priority) > 0)" +
         " group by  a.t_account, plRest, a.t_nameaccount, a.t_oper, a.t_name, b.cl" +
         " ORDER BY a.t_account, plRest, a.t_nameaccount, a.t_oper, a.t_name, b.cl";

   
else

//Gurin S. 12.02.2014 I-00464060-2 (2031)
//Gurin S. 17.03.2015 R-556992-2 
   sql = RSDCommand(" SELECT a.t_account, " + planrestSubst( "a", "planrest" ) + ", a.t_nameaccount, a.t_oper, a.t_name, b.cl,  DECODE (a.t_index2, CHR (0), '-', CHR (1), '-', a.t_index2) index2 " + //09.07.2013 Gurin S. C-17880 add index2 для для счетов имеющих КОР
         " FROM  (SELECT   acc.t_account,"+
         "                 " + planrestSubst( "acc" ) + ","+

         "                 acc.t_nameaccount,"+
         "                 acc.t_oper,"+
         "                 dep.t_name,"+
         "                 acc.t_code_currency,"+
         "                 acc.t_chapter,"+
         "                 acc.t_balance,"+
         "                 acc.t_branch,"+
         "                 acc.t_client,"+
         "                 acc.t_index2"+
         "        FROM daccount_dbt acc, ddp_dep_dbt dep"+
         "       WHERE    acc.t_index2 = CHR (88) "+
         "             AND acc.t_chapter = 1"+
         "             AND acc.t_branch = dep.t_code "+ 
         "             AND " + planrestSubst( "acc" ) + " > :minrest1 " + /*minrest +*/ inter +
         "       UNION ALL "+
         "        SELECT   acc.t_account,"+
         "                 " + planrestSubst( "acc" ) + ","+
         "                 acc.t_nameaccount,"+
         "                 acc.t_oper,"+
         "                 dep.t_name,"+
         "                 acc.t_code_currency,"+
         "                 acc.t_chapter,"+
         "                 acc.t_balance,"+
         "                 acc.t_branch,"+
         "                 acc.t_client,"+
         "                 acc.t_index2"+
         "        FROM daccount_dbt acc, ddp_dep_dbt dep"+
         "        WHERE    acc.t_chapter = 1 "+
         "             AND EXISTS (SELECT  1 "+  
         "                           FROM  dpsiwpacc_dbt dps, dacclaim_dbt dacl, dacclaimstate_dbt daclst " +
         "                         WHERE      dacl.T_CLAIMID = DACLST.T_CLAIMID " +
         "                                AND DPS.T_ACCOUNT = dacl.T_ACCOUNT " +
         "                                AND dacl.T_ACCOUNT = acc.t_account "
         "                                AND daclst.t_state = 4 " +
         "                                AND (dacl.t_initiator = 1 " +
         "                                     OR dacl.t_initiator = 100) " +
         "                                AND dacl.t_claimkind = 1 " +
         "                                AND dacl.t_restkind = 2 " +
         "                                AND daclst.t_stateid = (SELECT   MAX (t_stateid) " +
         "                                                          FROM   dacclaimstate_dbt " +
         "                                                         WHERE   t_claimid = dacl.t_claimid)) " +
         "          AND acc.t_branch = dep.t_code"+
         "          AND " + planrestSubst( "acc" ) + " > :minrest2 " + /*minrest +*/ inter +") a"+ 
         "     LEFT JOIN"+
         "        (  SELECT CHR (88) cl,"+
         "                  COUNT (1),"+
         "                  claim.t_Account,"+
         "                  claim.t_chapter,"+
         "                  claim.t_fiid"+
         "             FROM  dacclaim_dbt claim, dacclaimstate_dbt acclaimstate"+
         "            WHERE (claim.t_FinishDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')"+
         "                   OR claim.t_FinishDate > TO_DATE ('" + {curdate} + "', 'dd.mm.yyyy'))"+
         "                   AND claim.t_ClaimID = acclaimstate.t_ClaimID"+
         "                   AND (acclaimstate.t_State = 1"+
         "                        OR acclaimstate.t_State = 2)"+
         "                   AND acclaimstate.t_StateDate ="+
         "                    ( (SELECT MAX (t.t_StateDate)"+
         "                         FROM dacclaimstate_dbt t"+
         "                        WHERE     t.t_ClaimID = claim.t_ClaimID"+
         "                              AND t.t_StateDate <= TO_DATE ('" + {curdate} + "', 'dd.mm.yyyy')))"+
         "         GROUP BY claim.t_Account, claim.t_chapter, claim.t_fiid) b"+
         "     ON a.T_ACCOUNT = b.t_Account"+
         "        AND b.t_Chapter = a.t_chapter"+
         "        AND b.t_FIID = a.t_code_currency, dobjcode_dbt cod where cod.t_codekind=1 and cod.t_objectid=a.t_client and cod.t_state=0 and t_objecttype=3 "+ //11.07.2012 vihrov C-12122 смена диапазонов кодов
         " ORDER BY b.cl DESC, a.t_branch, a.t_oper, a.t_balance, cod.t_code;");  //11.07.2012 vihrov не надо сортировать по хвосту. по коду можно, по клиенту и т.д. по хвосту нельзя
         sql.addParam( "minrest1", RSDBP_IN, minrest );
         sql.addParam( "minrest2", RSDBP_IN, minrest );
         sql.execute();
end;

 var DataSet = TRsbDataSet(sql);
 remprogress;

   //SetOutput(output,false);
 sum1 = 0;
 sum2 = 0;
 if (branch==0)
   br="";
 else
   br=branch;
 end;

 /*Выводим шапку документа*/
 [  Отчет по счетам с ненулевыми остатками с документами в картотеке №2
    По подразделению ############ ##########################################

    На дату: ##########

    Форма отчёта: #
  
 ┌─────┬──────────────────────┬────┬────────────────────────────────────────┬───────────────┬──────────────┬──────────────┬──────┬────────────────────────────────────────┐
 │№ док│      Номер счета     │Фил.│          Наименование клиента          │    Остаток    │    Остаток   │   Сумма      │ Опер.│              Претензии                 │
 │     │                      │    │                                        │               │    свободн.  │  картотеки   │      │                                        │
 ├─────┼──────────────────────┼────┼────────────────────────────────────────┼───────────────┼──────────────┼──────────────┼──────┼────────────────────────────────────────┤]
 (Namebr,NameBranch,{curdate}, /* EVG 15/07/2011 */ ReportTypeTxt);
 cnt=0;
 initprogress(maxS,"Вывод на печать, ждите","Вывод счетов");

 while (DataSet.movenext());
    isAccountForRkoRepType = false;
    k = 1;
    sq = " select count(1) as cnt, nvl(sum(claim.t_startamount), 0) as t_startamount, claim.t_priority, claim.t_claimkind, claim.t_restkind, val.t_note from dacclaim_dbt claim, dacclaimstate_dbt acclaimstate, dllvalues_dbt val "+
         " where (claim.t_finishdate > to_date ('"+{curdate}+"','DD-MM-YYYY') or claim.t_finishdate = to_date ('01.01.0001','DD-MM-YYYY')) "+
         " and claim.t_startdate <= to_date ('"+{curdate}+"','DD-MM-YYYY') "; // Lavrenov - Только активные
         if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
             if (DataSet.index2 == "-")
                 sq = sq + " and acclaimstate.t_state in (4) ";
             else
                 sq = sq + " and acclaimstate.t_state in (1,2) "; 
             end;
         else
             sq = sq + " and acclaimstate.t_state in (1,2) "; 
         end;
         sq = sq + " and val.t_element = DECODE (claim.t_initiator, 100, 6, claim.t_initiator) and val.t_list = 2523 "+
         " and claim.t_claimid = acclaimstate.t_claimid and t_account ='"+dataset.account+"' "+
         " and acclaimstate.t_statedate = (select max(t_statedate) from dacclaimstate_dbt where t_claimid = claim.t_claimid "+
         "                                                                                  and t_statedate <= " + GetSQLDate({CurDate}) + ") " +
         " group by claim.t_restkind, claim.t_priority, claim.t_claimkind, claim.t_initiator, val.t_note";

    DataSQ = TRsbDataSet(sq);
    acclaiminf = "";
    while (dataSQ.movenext())
       
       /* EVG 15/07/2011 Счета с претензиями - только для формы отчёта "Картотека в бюджет" */
       if ( ( ReportType == REPTYPE_BUDGET ) or ( ReportType == REPTYPE_ALL ) or ( ReportType == REPTYPE_RKO_WITH_CLAIMS ))//30.07.2013 DPN счета с притензиями так же для "Картотека РКО с притензиями" C-22213-6
          sum1 = sum1 + money(dataset.planrest);
          if((ReportType == REPTYPE_BUDGET) or ( ReportType == REPTYPE_RKO_WITH_CLAIMS ))//30.07.2013 DPN Счета с притензиями также для "Картотека РКО с притензиями" C-22213-6
            sum2 = sum2 + money(summa_k2(dataset.account)); sumpl
          else
            sum2 = sum2 + money(sumpl(dataset.account)); 
          end;
          //if ( ReportType == REPTYPE_BUDGET and  index(dataset.typ, "Т")  )
          //  acclaiminf = "Арест на дебет " + "Вид: " + typeV(datasq.claimkind);
          //else
          if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
              if (DataSet.index2 != "-")
                  acclaiminf="Вид: "+typeV(datasq.claimkind);
              end;
          else
              acclaiminf="Вид: "+typeV(datasq.claimkind);
          end;
          //end;
          if (k == 1)
             /* EVG 15/07/2011 Перенёс сюда */
             cnt = cnt + 1;
             if(ReportType == REPTYPE_BUDGET)      //AAN
               //Gurin S. 12.02.2014 R-328683-2 (2031) money(string...
               if(index(dataset.typ, "Т"))
                  [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
                  (cnt,dataset.account,dataset.name, substr(dataset.nameaccount,1,40),money(dataset.planrest),money(string(sumpr(money(dataset.planrest),sinpl1(dataset.account)))),money(summa_k2(dataset.account)),dataset.oper,"Тип счёта: Арест на дебет ");
                  [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
                  ( " "," "," "," "," "," "," "," ",acclaiminf);
               else
                  [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
                  (cnt,dataset.account,dataset.name, substr(dataset.nameaccount,1,40),money(dataset.planrest),money(string(sumpr(money(dataset.planrest),sinpl1(dataset.account)))),money(summa_k2(dataset.account)),dataset.oper,acclaiminf);
               end;
               
            else   
               if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
                   if (DataSet.index2 == "-") tmp_sum = SumKOR(dataset.account); acclaiminf = ""; else tmp_sum = sumpl(dataset.account); end;
               else
                   tmp_sum = sumpl(dataset.account);
               end;
               //Gurin S. 12.02.2014 I-00464060-2 (2031) money(string...
               [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
               (cnt,dataset.account,dataset.name, substr(dataset.nameaccount,1,40),money(dataset.planrest),money(string(sumpr(dataset.planrest,sinpl1(dataset.account)))),money(tmp_sum),dataset.oper,acclaiminf);
            end;
          else
             [│     │                      │    │                                        │               │              │              │      │########################################│]  
             (acclaiminf);
          end;
          if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
              if (DataSet.index2 != "-")
                  [│     │                      │    │########################################│               │              │              │      │########################################│]
                  (substr(dataset.nameaccount,41,40), "Тип: "+TypeP(datasq.restkind));
              end;
          else
              [│     │                      │    │########################################│               │              │              │      │########################################│]
              (substr(dataset.nameaccount,41,40), "Тип: "+TypeP(datasq.restkind));
          end;
          if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
              if (DataSet.index2 != "-")
                  if ((datasq.restkind!=1) and (datasq.restkind!=2))      //1 или 2 - полн или частичный не выводим
                      [│     │                      │    │########################################│               │              │              │      │########################################│]
                      (substr(dataset.nameaccount,81,40),"Сумма: "+money(datasq.startamount));                                   //или datasq.T_CURRENTAMOUNT
                      k = 2;
                  end;
              end;
          else
              if ((datasq.restkind!=1) and (datasq.restkind!=2))      //1 или 2 - полн или частичный не выводим
                  [│     │                      │    │########################################│               │              │              │      │########################################│]
                  (substr(dataset.nameaccount,81,40),"Сумма: "+money(datasq.startamount));                                   //или datasq.T_CURRENTAMOUNT
                  k = 2;
              end;
          end;

          k = k+1;          
          if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
              if (DataSet.index2 != "-") 
                  [│     │                      │    │########################################│               │              │              │      │########################################│]
                  (substr(dataset.nameaccount,(k*40+1),40), "Инициатор: "+datasq.note);
              end;
          else
              [│     │                      │    │########################################│               │              │              │      │########################################│]
              (substr(dataset.nameaccount,(k*40+1),40), "Инициатор: "+datasq.note);
          end;
          if ((ReportType != REPTYPE_BUDGET) and  (ReportType != REPTYPE_RKO_WITH_CLAIMS))
              if (DataSet.index2 != "-")
                  if (datasq.restkind!=1)  
                      k = k+1;                                   
                      [│     │                      │    │########################################│               │              │              │      │########################################│]
                      (substr(dataset.nameaccount,(k*40+1),40), "Приоритет: "+datasq.priority);
                      k = k+1;                                   
                      [│     │                      │    │########################################│               │              │              │      │########################################│]
                     (substr(dataset.nameaccount,(k*40+1),40), "Количество арестов: "+int(datasq.cnt));
                   end;
              end;
          else
              if (datasq.restkind!=1)  
                  k = k+1;                                   
                  [│     │                      │    │########################################│               │              │              │      │########################################│]
                  (substr(dataset.nameaccount,(k*40+1),40), "Приоритет: "+datasq.priority);
                  k = k+1;                                   
                  [│     │                      │    │########################################│               │              │              │      │########################################│]
                 (substr(dataset.nameaccount,(k*40+1),40), "Количество арестов: "+int(datasq.cnt));
              end;
          end;

 //16.05.2012 DEV добавила в рамках проверки заявки I-00194202-1, не попадал признак J
    /* EVG 21/10/2011 Унификация. Добавлено для банка ВУЗ. */
          if( bnk.is_VUZ )
             var note153 = ReadNoteForObject(4,"010000000"+dataset.account,153);
             var notlen  = StrLen(note153);
             var strpast;
             var b = 0;
             if (notlen > 35) 
                     strpast = substr(note153, 1, 35);
                     b = round((notlen / 35), 0) ;
             else
                     strpast = ReadNoteForObject(4,"010000000"+dataset.account,153);
             end;
             [│     │                      │    │########################################│               │              │              │      │########################################│]

             (substr(dataset.nameaccount,(k*40+1),40), "J- " + strpast);
             var i =1;
             while (i<=b)
                    strpast = substr(note153, 35*i,35);
                     [│     │                      │    │########################################│               │              │              │      │########################################│]
                     (substr(dataset.nameaccount,(k*40+1),40), strpast);
                     i = i + 1 ;
             end;
          end;

       /* 15/07/2011 Изменяем k для того, чтобы при выводе в режиме "Картотека РКО"
          счета с претензиями не проходили дальше. */
       else
          k = 2;
          cnt = cnt + 1;
       end;

    end; // while (dataSQ.movenext())
      
    /* EVG 15/07/2011 Определяем, подходит ли данный счёт для формы отчёта "Картотека РКО" */
    if ( ( k == 1 )                                        // EVG Используем k == 1 как признак того, что претензий по счёту нет, иначе бы k было больше.
         and ( money(dataset.planrest) > $0 )              // EVG Остаток на счёте > 0
         and CheckK2Documents( dataset.account )           // EVG Пройдена проверка документов К2
         and CheckAccountType( dataset.account )           // EVG Пройдена проверка типа счёта
       )
       
       isAccountForRkoRepType = true;
    end;
   
    /* EVG 15/07/2011 Рисуем разделитель для режима "Картотека в бюджет" или "Полный отчёт" */
    if ( (k > 1) and (( ReportType == REPTYPE_BUDGET ) or ( ReportType == REPTYPE_ALL )) )
          [├─────┼──────────────────────┼────┼────────────────────────────────────────┼───────────────┼──────────────┼──────────────┼──────┼────────────────────────────────────────┤];
    end;
   
    if (k == 1)

       /* EVG 15/07/2011 */
       // EVG Если выбран режим "Картотека в бюджет" и счёт подходит
       if ( ( ( ReportType == REPTYPE_BUDGET )
              and not isAccountForRkoRepType
            )
            or
            // EVG ...или выбран режим "Картотека РКО" и счёт подходит
            ( ( ReportType == REPTYPE_RKO )
              and isAccountForRkoRepType
            )
            or 
            // 19/07/2011 ... или выбран режим "Полный отчёт"
            ( ReportType == REPTYPE_ALL )
            or
            //30.07.2013 DPN ...или выбран режим "Картотека РКО  с притензиями" и счёт подходит (C-22213-6)
            ( ( ReportType == REPTYPE_RKO_WITH_CLAIMS )
              and isAccountForRkoRepType
            )
          )
          
          /* EVG 15/07/2011 Перенёс сюда */
          cnt = cnt + 1;
          sum1 = sum1 + money(dataset.planrest);
          if((ReportType == REPTYPE_BUDGET) or (ReportType == REPTYPE_RKO_WITH_CLAIMS))//30.07.2013 DPN Добавил так же для "Картотека РКО с притензиями" C-22213-6
            sum2 = sum2 + money(summa_k2(dataset.account)); sumpl
          else
            sum2 = sum2 + money(sumpl(dataset.account)); 
          end;
          if (ReportType == REPTYPE_BUDGET)
            //Gurin S. R-328683-2 12.02.2014 (2031) money(string...
            if(index(dataset.typ, "Т"))
               [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
               (cnt,dataset.account,dataset.name, substr(dataset.nameaccount,1,40),money(dataset.planrest),money(string(sumpr(dataset.planrest,sinpl1(dataset.account)))),money(summa_k2(dataset.account)),dataset.oper, "Тип счёта: Арест на дебет ");
            else
               [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
            (cnt,dataset.account,dataset.name, substr(dataset.nameaccount,1,40),money(dataset.planrest),money(string(sumpr(dataset.planrest,sinpl1(dataset.account)))),money(summa_k2(dataset.account)),dataset.oper, acclaiminf);
            end;
         else
          //Gurin S. I-00464060-2 12.02.2014 (2031) money(string...
          [│#####│ #################### │ ###│########################################│###############│##############│##############│ #####│########################################│]
          (cnt,dataset.account,dataset.name, substr(dataset.nameaccount,1,40),money(dataset.planrest),money(string(sumpr(dataset.planrest,sinpl1(dataset.account)))),money(sumpl(dataset.account)),dataset.oper,acclaiminf);
          end;
          k = 1;
          while (strlen(substr(dataset.nameaccount,(k*40+1),40)) > 0)
             [│     │                      │    │########################################│               │              │              │      │                                        │]
             (substr(dataset.nameaccount,(k*40+1),40));
             k=k+1;
          end;

          [├─────┼──────────────────────┼────┼────────────────────────────────────────┼───────────────┼──────────────┼──────────────┼──────┼────────────────────────────────────────┤];
       end;

    end;
    
    useprogress(cnt);
   
 end;
 
 [└─────┴──────────────────────┴────┴────────────────────────────────────────┴───────────────┴──────────────┴──────────────┴──────┴────────────────────────────────────────┘
   Итого                                                                ###############                ##############]
   (money(sum1), money(sum2));


remprogress(cnt);
  SetOutput (Null,True);
//  ViewFile(output);
END;


MACRO Event (dlg, cmd, id, key)

   var const_mess = "~F2~ Продолжить ~SPACE~ По всем офисам ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~ESC~ Выход ";

   /* EVG 15/07/2011 */
   var choice;
   array repType;
   repType(0) = "Полный отчёт";
   repType(1) = "Картотека в бюджет";
   repType(2) = "Картотека РКО";
   repType(3) = "Картотека РКО с претензиями"; //30.07.2013 Добавил пункт меню C-22213-6
    
   if(cmd == DLG_INIT)
     dprt_v = 0;
     if (persontype({oper})=="О")
      dlg.rec.branch = "";
      dlg.rec.Namebranch = "";
      dlg.rec.OperNum = {oper};
      dlg.rec.OperName = GetOperName({oper});
     elif (persontype({oper})=="Н")
      dlg.rec.branch = "";
      dlg.rec.Namebranch = "Весь банк";
      dlg.rec.OperNum = "";
      dlg.rec.OperName = "Группа операционистов";
     else
      dlg.rec.branch = "";
      dlg.rec.Namebranch = "Весь банк";
      dlg.rec.OperNum = "";
      dlg.rec.OperName = "Все операционисты";
     end;

      /* EVG 15/07/2011 Заполнение поля "Форма отчёта" */
      dlg.rec.repType = ReportTypeTxt = repType(0);
      ReportType = 0;
      
      dlg.rec.minrest=minrest;
      UpdateFields(Dlg);
      SetFocus (dlg, 2 );
      return CM_IGNORE;
   end;

   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)

     if (FldName(dlg,id)=="Branch") 
       if(persontype({oper})!="О")
       message(" ~F3~ Список подразделений "+const_mess);
       else 
       message(const_mess2);
       end;
     elif (FldName(dlg,id)=="OperNum") 
        if (persontype({oper})=="Н")
           message(" ~F3~ Список операционистов "+const_mess2+" ~SPACE~ По группе операционистов");
        elif (persontype({oper})=="О")
           message(const_mess2);
        else
           message(" ~F3~ Список операционистов "+const_mess2+" ~SPACE~ По всем операционистам");
        end;
     elif (FldName(dlg,id)=="MinRest")
       message(const_mess2);
    end;
   end;

   if ((cmd == DLG_REMFOCUS))
     if (FldName(dlg,id)=="OperNum")
       if ((GetOperName(dlg.rec.OperNum) == "") and (dlg.rec.operNum!="")) 
          msgbox("Операционист "+dlg.rec.OperNum+" не найден ");
          UpdateFields(dlg);
          return CM_CANCEL;
       else
          if ((dlg.rec.OperNum == "") and (persontype({oper})!="Н"))
             dlg.rec.OperName = "Все операционисты";
          elif ((dlg.rec.OperNum == "") and (persontype({oper})=="Н"))
             dlg.rec.OperName = "Группа операционистов";
           else  
             dlg.rec.OperName = GetOperName(dlg.rec.OperNum);
          end;
          UpdateFields(dlg); 
       end;
     end;
     UpdateFields(dlg); 
   end; 

   if (cmd==DLG_KEY)
      if (KEY==KEY_ESC)
         exit(1);
         return  CM_CANCEL;
      elif (KEY==KEY_F3)
         if ((FldName(dlg,id) == "Branch") and (persontype({oper})!="О"))

          if (ListDepartment (Department))
             dprt_v = department.code;
             dlg.rec.Branch = Department.Name;
             dlg.rec.NameBranch = GetClientName(Department.PartyID);
             UpdateFields(dlg);
          end;
         elif ((FldName(dlg,id) == "OperNum") and (persontype({oper})!="О"))
          if (ListOper(Person))
            if (persontype({oper})=="Н") 
             if ((person.oper>=persongroupoperfo({oper})) AND (person.oper<=persongroupoperlo({oper})))
             dlg.rec.OperNum = Person.Oper;
             dlg.rec.OperName = Person.Name;
             else
             msgbox("Операционист не входит в Вашу группу операционистов \n"+
             "Ваша группа: начало номеров "+persongroupoperfo({oper})+", окончание номеров "+persongroupoperlo({oper}));
             dlg.rec.OperNum = persongroupoperfo({oper});
             dlg.rec.OperName = GetOperName(dlg.rec.opernum);
             end;
            elif (persontype({oper})!="Н") 
             dlg.rec.OperNum = Person.Oper;
             dlg.rec.OperName = Person.Name;
            else
             dlg.rec.operName = "Группа операционистов";
             dlg.rec.OperNum="";
            end;
             UpdateFields(dlg); 
          end; 
         
         /* EVG 15/07/2011 Выбор значения поля "Форма отчёта" */
         elif( FldName(dlg,id) == "repType" )
            choice = menu( repType );
            if ( choice >= 0 )
               dlg.rec.repType = repType( choice );
               ReportType      = choice;
               ReportTypeTxt   = repType( choice );
            else
               Return CM_DEFAULT;
            end;
            UpdateFields(dlg); 
         end;
         
        elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
          if ((FldName(dlg,id) == "Branch") and (persontype({oper})!="О"))
            dlg.rec.Namebranch = "Весь банк";
            dlg.rec.branch="";
            dprt_v = 0;
            UpdateFields(dlg);
          end;
                    /*Сброс установок в поле операционист*/
             if ((FldName(dlg,id) == "OperNum") and (persontype({oper})!="О"))
            if (persontype({oper})!="Н")
            dlg.rec.operName = "Все операционисты";
            dlg.rec.OperNum="";
            else
            dlg.rec.operName = "Группа операционистов";
            dlg.rec.OperNum="";
            end;
            UpdateFields(dlg);
          end;

      elif ( KEY==KEY_F2 )
         Branch = dprt_v;
         NameBranch = dlg.rec.NameBranch;
         NameBr = dlg.rec.Branch;
         OperNum = dlg.rec.OperNum;
         OperName = dlg.rec.OperName;
         Minrest = dlg.rec.Minrest;
 
         if ((operNum!=0) or (operName=="Группа операционистов"))             //Операционист
            if (operName=="Группа операционистов")
             if (branch!=0)
             inter=" and acc.t_oper between "+persongroupoperfo({oper})+" and "+ persongroupoperlo({oper})+" and acc.t_branch= "+branch;
             else
             inter=" and acc.t_oper between "+persongroupoperfo({oper})+" and "+ persongroupoperlo({oper});
             end;
             else
             inter=" and acc.t_oper="+operNum;
             end;
         elif (branch!=0)              //Если операциониста нет, а есть всп
             if (department.nodetype==1) 
               inter=" and acc.t_department= "+branch;   //Все
             else
               inter=" and acc.t_branch= "+branch;
             end;
          else 
             inter="";
          end;
         Return CM_SAVE;
      else
      Return CM_DEFAULT;
    end; /* end cmd==DLG_KEY*/

end;
end;

if (RunDialog(dlg, "Event"))                  
  OutAll;

end;