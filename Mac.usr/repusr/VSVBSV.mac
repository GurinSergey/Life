/*Ведомость по субсчетам ВБС (рубли)                                   */
/*                                                                     */
/*                                                                     */
/*Тихомиров А.Н. 29.04.2009                    Версия 1.0              */

//12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 

//var Fulloutput,  out,  output="\\vsvbs.txt";                    
var maxs:integer, s:integer, dept, datebegin, dateend, inter, i, pos, m, g, in, dep, acc, sql, dataset, fl, fnul, fhead, fsubb, mode, view, type, sq, data, branchn, fii = "", fiin;
var symb, symbol, ap, pa, cl="", pab, apb, chap, modein, sumd=0, sumk=0, sumb=0, sume=0, asumd=0, asumk=0, asumb=0, asume=0, balacc="", gnamep, cnt, intype, cntype, branchv;
var gg=3, ac, dept_v=1, ii, data1;
import RSD,rcw, rslx, Календарь, rsbdataset, payminter, globals, ptinter, bankinter, currinter;
var fulloutput = GetTxtFileName("vsvbs");
const  KEY_F1      =315;
const  KEY_F2      =316;
const  KEY_F3      =317;
const KEY_ESC      = 27;
const KEY_SPACE    = 32;
const KEY_ENTER    = 13;

import FIInter;
record fi( fininstr );
file av( avoiriss );


var Fulloutputl, outl, outputl="vbs.lbr"; 
record oper (person);     
record department (dp_dep);    
record accountr (account);          

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\LBRDIR",2,outl);
Fulloutputl = FindPath(outputl, outl);
var dlg = TRecHandler("vsvbsv", fulloutputl, TRUE); 


/*Найдем имя по Partyid*/
private macro GetClientName(id)

var  sl=" select part.t_name from dparty_dbt part, ddp_dep_dbt dep where part.t_partyid=dep.t_partyid and dep.t_code="+id;

var  DataS=TRsbDataSet(sl);

  if( DataS.moveNext())
    return DataS.name;
  else
    if (id !=0)
       msgbox("Субъект не найден в party.dbt");
       return 0;
    else
      return "ОАО АКБ Пробизнесбанк";
    end;
  end;

END;


private macro outall()
in="";
dep="";
modein="";
symb="";
cntype=1;


i=0;

while (i<strlen(symbol))
i=i+1;
            if (substr(symbol,i,1)=="A");
              symb=symb+"or acc.t_usertypeaccount like '%А%'";
            elif (substr(symbol,i,1)=="D");
              symb=symb+"or acc.t_usertypeaccount like '%D%'";
            elif (substr(symbol,i,1)=="F");
              symb=symb+"or acc.t_usertypeaccount like '%F%'";
            elif (substr(symbol,i,1)=="G");
              symb=symb+"or acc.t_usertypeaccount like '%G%'";
            elif (substr(symbol,i,1)=="I");
              symb=symb+"or acc.t_usertypeaccount like '%I%'";
            elif (substr(symbol,i,1)=="L");
              symb=symb+"or acc.t_usertypeaccount like '%L%'";
            elif (substr(symbol,i,1)=="N");
              symb=symb+"or acc.t_usertypeaccount like '%N%'";
            elif (substr(symbol,i,1)=="R");
              symb=symb+"or acc.t_usertypeaccount like '%R%'";
            elif (substr(symbol,i,1)=="Q");
              symb=symb+"or acc.t_usertypeaccount like '%Q%'";
            elif (substr(symbol,i,1)=="S");
              symb=symb+"or acc.t_usertypeaccount like '%S%'";
            elif (substr(symbol,i,1)=="U");
              symb=symb+"or acc.t_usertypeaccount like '%U%'";
            elif (substr(symbol,i,1)=="Z");
              symb=symb+"or acc.t_usertypeaccount like '%Z%'";
            elif (substr(symbol,i,1)=="Б");
              symb=symb+"or acc.t_usertypeaccount like '%Б%'";
            elif (substr(symbol,i,1)=="Г");
              symb=symb+"or acc.t_usertypeaccount like '%Г%'";
            elif (substr(symbol,i,1)=="Д");
              symb=symb+"or acc.t_usertypeaccount like '%Д%'";
            elif (substr(symbol,i,1)=="Е");
              symb=symb+"or acc.t_usertypeaccount like '%Е%'";
            elif (substr(symbol,i,1)=="Ё");
              symb=symb+"or acc.t_usertypeaccount like '%Ё%'";
            elif (substr(symbol,i,1)=="Ж");
              symb=symb+"or acc.t_usertypeaccount like '%Ж%'";
            elif (substr(symbol,i,1)=="З");
              symb=symb+"or acc.t_usertypeaccount like '%З%'";
            elif (substr(symbol,i,1)=="Й");
              symb=symb+"or acc.t_usertypeaccount like '%Й%'";
            elif (substr(symbol,i,1)=="К");
              symb=symb+"or acc.t_usertypeaccount like '%К%'";
            elif (substr(symbol,i,1)=="Л");
              symb=symb+"or acc.t_usertypeaccount like '%Л%'";
            elif (substr(symbol,i,1)=="М");
              symb=symb+"or acc.t_usertypeaccount like '%М%'";
            elif (substr(symbol,i,1)=="Н");
              symb=symb+"or acc.t_usertypeaccount like '%Н%'";
            elif (substr(symbol,i,1)=="О");
              symb=symb+"or acc.t_usertypeaccount like '%О%'";
            elif (substr(symbol,i,1)=="П");
              symb=symb+"or acc.t_usertypeaccount like '%П%'";
            elif (substr(symbol,i,1)=="Т");
              symb=symb+"or acc.t_usertypeaccount like '%Т%'";
            elif (substr(symbol,i,1)=="У");
              symb=symb+"or acc.t_usertypeaccount like '%У%'";
            elif (substr(symbol,i,1)=="Ф");
              symb=symb+"or acc.t_usertypeaccount like '%Ф%'";
            elif (substr(symbol,i,1)=="Х");
              symb=symb+"or acc.t_usertypeaccount like '%Х%'";
            elif (substr(symbol,i,1)=="Ц");
              symb=symb+"or acc.t_usertypeaccount like '%Ц%'";
            elif (substr(symbol,i,1)=="Ч");
              symb=symb+"or acc.t_usertypeaccount like '%Ч%'";
            elif (substr(symbol,i,1)=="Ш");
              symb=symb+"or acc.t_usertypeaccount like '%Ш%'";
            elif (substr(symbol,i,1)=="Щ");
              symb=symb+"or acc.t_usertypeaccount like '%Щ%'";
            elif (substr(symbol,i,1)=="Ы");
              symb=symb+"or acc.t_usertypeaccount like '%Ы%'";
            elif (substr(symbol,i,1)=="Ъ");
              symb=symb+"or acc.t_usertypeaccount like '%Ъ%'";
            elif (substr(symbol,i,1)=="Ь");
              symb=symb+"or acc.t_usertypeaccount like '%Ь%'";
            elif (substr(symbol,i,1)=="Ю");
              symb=symb+"or acc.t_usertypeaccount like '%Ю%'";
            elif (substr(symbol,i,1)=="Я");
              symb=symb+"or acc.t_usertypeaccount like '%Я%'";
            else

            end;
end;

if (strlen (symb)>0)
symb=string("AND (",substr(symb,3),")");
end;


if (fii != "")
  fiin = " AND acc.t_code_currency = " + fii;
else
  fiin = "";
end;


 if ((fhead) and (fsubb))
   dep=string(" AND acc.t_department= ",dept);
// elif (fhead)
 elif (fsubb)
   dep=string(" AND acc.t_branch= ",dept);
// elif (fsubb)
 elif (fhead)
//   dep=string(" AND acc.t_branch!= ",dept," AND acc.t_department= ",dept);
   dep=string(" AND acc.t_branch= ",dept);
 else 
   msgbox("Не выбрано подразделение ТС");
   return 0;
 end;

if (g=="В")
  in="AND acc.T_CHAPTER = 3 ";
  chap=3;
 elif (g=="Г")
  in="AND acc.T_CHAPTER = 4 ";
  chap=4;
end;

if (type=="Общая")
 intype="";
 else
 intype=" acc.t_branch, ";
end;


initprogress(-1,"Ждите, отбираются счета...", "Ждите");
useprogress(-1);
sql = " SELECT count(*) as cnt "+
    " FROM daccount_dbt acc "+  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
   " WHERE  (t_open_close = chr(0) OR t_close_date > TO_DATE ('"+datebegin+"', 'DD-MM-YYYY')) "+
       in+
       dep+
       fiin+
       symb+
   " AND acc.t_code_currency != 0 " +   //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
   "   AND t_open_date <= '"+dateend+"' ";
dataset = trsbdataset(sql);
dataset.movenext();
maxs=dataset.cnt;
//GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR",2,out);
//fulloutput=out+output;
//setoutput(fulloutput,false);


sql = " SELECT distinct(acc.t_code_currency) as fi"+
    " FROM daccount_dbt acc"+  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
   " WHERE  (t_open_close = chr(0) OR t_close_date > TO_DATE ('"+datebegin+"', 'DD-MM-YYYY')) "+
       in+
       dep+
       symb+
       fiin+
   " AND acc.t_code_currency != 0 " + //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
   "   AND t_open_date <= '"+dateend+"' ";
data1 = trsbdataset(sql);
s=0;
remprogress(-1);
initprogress(maxs,"Ждите, производится расчет...", "Ждите, производится расчет");
while (data1.movenext())
cntype = 1; asumd=0; asumk=0; asumb=0; asume=0; sumd=0; sumk=0; sumb=0; sume=0;


sql = " SELECT   acc.t_account, acc.t_nameaccount, acc.t_balance, acc.t_branch, instr.t_name, acc.t_code_currency "+
    " FROM daccount_dbt acc, dfininstr_dbt instr "+  //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
   " WHERE  (t_open_close = chr(0) OR t_close_date > TO_DATE ('"+datebegin+"', 'DD-MM-YYYY')) "+
   "   AND t_open_date <= TO_DATE ('"+dateend+"', 'DD-MM-YYYY') "+
       in+
       dep+
       symb+
  " AND acc.t_code_currency != 0 " +   //12.02.2014 R-326546-3 DPN - Адаптация под 31-й патч 
  " AND instr.t_fiid = acc.t_code_currency " +
  " AND acc.t_code_currency = "+data1.fi+
" ORDER BY "+intype+"+acc.t_account ";
dataset = trsbdataset(sql); 

// debugbreak;
cnt=1;
branchv="";
while (dataset.movenext())
//102 Обновление
// if ((CheckAccountRestriction(73, 1, 0, dataset.account, 0, ACS_OnlyCheck , CNTX_None, {oper}  )))
if ((branchv==dataset.branch) and (type!="Общая"))
//
/*asumd=asumd+debetA(dataset.account,datebegin,dateend,chap);
asumk=asumk+kreditA(dataset.account,datebegin,dateend,chap);
asumb=asumb+restA(dataset.account,(datebegin-1),null,chap);
asume=asume+restA(dataset.account,dateend,null,chap);*/
elif (type!="Общая")
if (branchv!="")
if (view=="Оборотно-сальдовая")
[├─────────────────────────┼──────────────────────────────┼───────────────────┼───────────────────┼──────────────────────┼────────────────────────┤
│ИТОГО ПО #####           │                              │###################│###################│######################│########################│]
(balacc,sumb,sumd,sumk,sume);

[└─────────────────────────┴──────────────────────────────┴───────────────────┴───────────────────┴──────────────────────┴────────────────────────┘
  ИТОГО:
  Сальдо на начало периода: ####################
  Обороты по дебету: #####################
  Обороты по кредиту: #####################
  Сальдо на конец периода: ####################

  Исполнитель: __________________ ######################
]
(asumb,asumd,asumk,asume,{oper} );
else
[├─────────────────────────┼──────────────────────────────────────────────┼───────────────────┼────────────────────────┤
│ИТОГО ПО #####           │                                              │###################│########################│]
(balacc,sumb,sume);

[└─────────────────────────┴──────────────────────────────────────────────┴───────────────────┴────────────────────────┘
  ИТОГО:
  Сальдо на начало периода: ####################
  Сальдо на конец периода: ####################

  Исполнитель: __________________ ######################
]
(asumb, asume, {oper} );
end;
end;
branchv=dataset.branch;
balacc=dataset.balance;
asumd=0;
asumk=0;
asumb=0;
asume=0;
cntype=1;
sumd=0;
sumk=0;
sumb=0;
sume=0;
end;

if (cntype)
if ((view=="Оборотно-сальдовая"))

[######################
Глава:  ###########################
                                                     Оборотно-сальдовая ведомость
                                                  за период с ########## по ##########

#################################

#################################
┌─────────────────────────┬──────────────────────────────┬───────────────────┬──────────────────────────────────────────┬────────────────────────┐
│      Лицевой счет       │   Наименование субсчета      │     Сальдо на     │                Обороты                   │         Сальдо на      │
│                         │                              │  начало периода   ├───────────────────┬──────────────────────┤       конец периода    │
│                         │                              │                   │      ДЕБЕТ        │       КРЕДИТ         │                        │]

(branchn,substr(gnamep,1,30), date(datebegin),date(dateend),dataset.name, fnul);    

else

[######################
Глава:  ###########################
                                                           Cальдовая ведомость
                                                  за период с ########## по ##########

#####################################

#################################
┌─────────────────────────┬──────────────────────────────────────────────┬───────────────────┬────────────────────────┐
│      Лицевой счет       │            Наименование субсчета             │     Сальдо на     │         Сальдо на      │
│                         │                                              │  начало периода   │       конец периода    │
│                         │                                              │                   │                        │]

(branchn,substr(gnamep,1,47), date(datebegin),date(dateend), dataset.name, fnul);    
end;
end;
cntype=0;
s=s+1;
useprogress(s);
if (view=="Оборотно-сальдовая")

if (balacc==dataset.balance);
sumd=sumd+debetAC(dataset.account,dataset.code_currency, datebegin,dateend,chap);
sumk=sumk+kreditAC(dataset.account,dataset.code_currency,datebegin,dateend,chap);
sumb=sumb+restAC(dataset.account,dataset.code_currency,(datebegin-1),null,chap);
sume=sume+restAC(dataset.account,dataset.code_currency,dateend,null,chap);
else
if (balacc!="")
[├─────────────────────────┼──────────────────────────────┼───────────────────┼───────────────────┼──────────────────────┼────────────────────────┤
│ИТОГО ПО #####           │                              │###################│###################│######################│########################│]
(balacc,sumb,sumd,sumk,sume);
sumd=debetAC(dataset.account,dataset.code_currency,datebegin,dateend,chap);
sumk=kreditAC(dataset.account,dataset.code_currency,datebegin,dateend,chap);
sumb=restAC(dataset.account,dataset.code_currency,(datebegin-1),null,chap);
sume=restAC(dataset.account,dataset.code_currency,dateend,null,chap);
cnt=1;
else
sumd=debetAC(dataset.account,dataset.code_currency,datebegin,dateend,chap);
sumk=kreditAC(dataset.account,dataset.code_currency,datebegin,dateend,chap);
sumb=restAC(dataset.account,dataset.code_currency,(datebegin-1),null,chap);
sume=restAC(dataset.account,dataset.code_currency,dateend,null,chap);
cnt=1;
end;
end;

  if ((fnul=="X") or (restaC(dataset.account,dataset.code_currency,(datebegin-1),null, chap)!=0) or (restac(dataset.account,dataset.code_currency,dateend,null, chap)!=0) or (debetAc(dataset.account,dataset.code_currency,datebegin,dateend,chap)!=0) or (kreditAc(dataset.account,dataset.code_currency,datebegin,dateend,chap)!=0))
if (cnt)
[├─────────────────────────┼──────────────────────────────┼───────────────────┼───────────────────┼──────────────────────┼────────────────────────┤]
end;
cnt=0;
[│#########################│##############################│###################│###################│######################│########################│]
(dataset.account, substr(dataset.nameaccount,1,30), restac(dataset.account,dataset.code_currency,(datebegin-1),null, chap),debetAc(dataset.account,dataset.code_currency,datebegin,dateend,chap),kreditAc(dataset.account,dataset.code_currency,datebegin,dateend,chap),restac(dataset.account,dataset.code_currency,dateend,null, chap));
ii=1;
while ((strlen(dataset.nameaccount)-ii*30)>0)
[│                         │##############################│                   │                   │                      │                        │]
(substr(dataset.nameaccount,(ii*30+1)));
ii = ii+1;
end;

end;


else

if ((balacc==dataset.balance) );
sumb=sumb+restAc(dataset.account,dataset.code_currency,(datebegin-1),null,chap);
sume=sume+restAc(dataset.account,dataset.code_currency,dateend,null,chap);
else
if (balacc!="")
[├─────────────────────────┼──────────────────────────────────────────────┼───────────────────┼────────────────────────┤
│ИТОГО ПО #####           │                                              │###################│########################│]
(balacc,sumb,sume);
cnt=1;
sumb=restA(dataset.account,(datebegin-1),null,chap);
sume=restA(dataset.account,dateend,null,chap);
end;
end;
  if ((fnul=="X") or (restac(dataset.account,dataset.code_currency,(datebegin-1),null, chap)!=0) or (restac(dataset.account,dataset.code_currency,dateend,null, chap)!=0))
if (cnt)
[├─────────────────────────┼──────────────────────────────────────────────┼───────────────────┼────────────────────────┤]
end;
cnt=0;
  
[│#########################│##############################################│###################│########################│]
(dataset.account, substr(dataset.nameaccount,1,47), restac(dataset.account,dataset.code_currency,(datebegin-1),null, chap),restac(dataset.account,dataset.code_currency,dateend, null, chap));
ii=1;
while ((strlen(dataset.nameaccount)-ii*47)>0)
[│                         │##############################################│                   │                        │]
(substr(dataset.nameaccount,(ii*47+1)));
ii = ii+1;
end;

end;

end;
branchv=dataset.branch;
balacc=dataset.balance;
asumd=asumd+debetAc(dataset.account,dataset.code_currency,datebegin,dateend,chap);
asumk=asumk+kreditAc(dataset.account,dataset.code_currency,datebegin,dateend,chap);
asumb=asumb+restAc(dataset.account,dataset.code_currency,(datebegin-1),null,chap);
asume=asume+restAc(dataset.account,dataset.code_currency,dateend,null,chap);

end;

if (view=="Оборотно-сальдовая")
[├─────────────────────────┼──────────────────────────────┼───────────────────┼───────────────────┼──────────────────────┼────────────────────────┤
│ИТОГО ПО #####           │                              │###################│###################│######################│########################│]
(balacc,sumb,sumd,sumk,sume);

[└─────────────────────────┴──────────────────────────────┴───────────────────┴───────────────────┴──────────────────────┴────────────────────────┘
  ИТОГО:
  Сальдо на начало периода: ####################
  Обороты по дебету: #####################
  Обороты по кредиту: #####################
  Сальдо на конец периода: ####################

  Исполнитель: __________________ ######################
]
(asumb,asumd,asumk,asume,{oper} );
else
[├─────────────────────────┼──────────────────────────────────────────────┼───────────────────┼────────────────────────┤
│ИТОГО ПО #####           │                                              │###################│########################│]
(balacc,sumb,sume);

[└─────────────────────────┴──────────────────────────────────────────────┴───────────────────┴────────────────────────┘
  ИТОГО:
  Сальдо на начало периода: ####################
  Сальдо на конец периода: ####################

  Исполнитель: __________________ ######################
]
(asumb, asume, {oper} );
end;
end;      //
remprogress(s);
 setoutput(null,true);
// viewfile(fulloutput);

END;



 /*Обработчик диалоговой панели ввода исходных данных для печати*/
MACRO Event (dlg, cmd, id, key) 
   array gname, typename, viewname, modename, symbolname;
   gname(0)="В 'Внебалансовые счета'";
   gname(1)="Г 'Срочные сделки'";

   typename(0)="Общая";
   typename(1)="По подразделениям";

   viewname(0)="Оборотно-сальдовая";
   viewname(1)="Сальдовая";

   modename(0)="Все счета";
   modename(1)="Только рублевые покрытия";
   modename(2)="Без рублевого покрытия";
    
   symbolname(0)="A Касса";
   symbolname(1)="D Касса ККО Зареченский";
   symbolname(2)="F Касса ККО Пермский 1";
   symbolname(3)="G Касса ККО Иркутский 1";
   symbolname(4)="I Касса ККО Пермский 2";
   symbolname(5)="L Касса ККО Дворянский";
   symbolname(6)="N Касса ККО Иркутский 2";
   symbolname(7)="R Касса ККО Гагаринский";
   symbolname(8)="Q Касса ККО Сенной";
   symbolname(9)="S Касса ККО Березники 1";
   symbolname(10)="U Касса ККО Березники 2";
   symbolname(11)="Z Касса ККО Фрунзенский";
   symbolname(12)="Б Бухгалтерия";
   symbolname(13)="Г Резерв";
   symbolname(14)="Д Межбанк";
   symbolname(15)="Е Касса ЦМТ";
   symbolname(16)="Ё Интернет банк";
   symbolname(17)="Ж ОВКУ";
   symbolname(18)="З Депозиты юр.лиц";
   symbolname(19)="Й Касса Тверской";
   symbolname(20)="К КЭО";
   symbolname(21)="Л ГМР";
   symbolname(22)="М Касса Садово-Кудринский";
   symbolname(23)="Н Розничные финанс. Услуги";
   symbolname(24)="О Депозиты физ.лиц";
   symbolname(25)="П Вексельный сектор";
   symbolname(26)="Т К-к офис Тульский";
   symbolname(27)="У ДО 'Центральный'";
   symbolname(28)="Ф  Касса Петровский";
   symbolname(29)="Х Касса Д/о 'Автозаводский'";
   symbolname(30)="Ц Ценные бумаги";
   symbolname(31)="Ч Касса ККО Тюменский 1";
   symbolname(32)="Ш Касса ККО Дзержинский";
   symbolname(33)="Щ Неторговые операц  ";
   symbolname(34)="Ы Касса ККО Красноармейский";
   symbolname(35)="Ъ ОКВКУ 4";
   symbolname(36)="Ь Касса Толстовский";
   symbolname(37)="Ю ОКВКУ № 1 (Пудовкина)";
   symbolname(38)="Я Касса Новоданиловский";


   var const_mess = "~F2~ Продолжить ~ESC~ Выход ";
   var const_mess2 = "~F2~ Продолжить ~SPACE~ ~ESC~ Выход ";

   /*Первоначальная инициализация полей*/
   if(cmd == DLG_INIT)
      dlg.rec.Fnul  = "";
      dlg.rec.G ="В";
      dlg.rec.Gname ="Внебалансовые счета";
      dlg.rec.fhead="";
      dlg.rec.fsubb="X";
      dlg.rec.type="Общая";
      dlg.rec.view="Оборотно-сальдовая";
      dlg.rec.fiid="";
      dlg.rec.fiidname="Все";
      dlg.rec.DateBegin = {curDate};
      dlg.rec.Symbol = "A";
      dlg.rec.DateEnd = {curDate};
      dlg.rec.Dept = {operdprtnode};
      dlg.rec.deptname = GetClientName({operdprtnode});
      UpdateFields(dlg); 
   end;
   
   /*Установка подсказок в строке состояния*/
   if (cmd==DLG_SETFOCUS)
     if ((FldName(dlg,id)=="Fnul"))
       message(const_mess2);
     elif ((FldName(dlg,id)=="Fhead"))
       message(const_mess2);
     elif (FldName(dlg,id)=="Symbol")
       message(" ~F3~ Выбор Символа счета "+const_mess);
     elif ((FldName(dlg,id)=="Fsubb"))
       message(const_mess2);
     elif (FldName(dlg,id)=="DateBegin")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="DateEnd")
       message(" ~F3~ Выбор даты из календаря "+const_mess);
     elif (FldName(dlg,id)=="G")
       message(" ~F3~ Выбор главы счетов "+const_mess);
     elif (FldName(dlg,id)=="Dept")
       message(" ~F3~ Выбор филиала "+const_mess);
     elif (FldName(dlg,id)=="Fiid")
       message(" ~F3~ Выбор валюты "+const_mess);
    end;
   end;
   
   if (cmd == DLG_REMFOCUS)
     /*Проверка корректности дат отчета*/
     if (FldName(dlg,id) == "DateBegin")
       if ( dlg.rec.DateBegin > {curdate} )
         MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
         MsgBox("Дата начала периода не может быть больше даты окончания периода");
        return CM_CANCEL;
       end;
     end;
     if (FldName(dlg,id) == "DateEnd")
       if ( dlg.rec.DateEnd > {curdate} )
         MsgBox("Дата не может быть больше даты текущего операционного дня");
        return CM_CANCEL;
       elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
         MsgBox("Дата окончания периода не может быть меньше даты начала периода");
        return CM_CANCEL;
       end;

     end;
      UpdateFields(dlg); 
   end;

   if (cmd == DLG_KEY)
     /*Выход из диалогового окна формирования отчета*/
     if (KEY == KEY_ESC)
       return exit(1);//CM_CANCEL;
     /*Выбор данных из списка*/
     elif ( KEY == KEY_F3)
        /*Выбор даты из календаря*/
        if (FldName(dlg,id) == "DateBegin")
          dlg.rec.datebegin = GetDateByCalendar ({curDate});
        end;
        if (FldName(dlg,id) == "DateEnd")
          dlg.rec.dateend = GetDateByCalendar ({curDate});
        end;
        if (FldName(dlg,id) == "Dept")
           if (ListDepartment (Department))
              dlg.rec.dept = Department.Name;
              dept_v = department.code;
              dlg.rec.deptname = GetClientName(Department.code);
              message(" ~F3~ Список подразделений "+const_mess);
              UpdateFields(dlg);
           end;
        end;
        if (FldName(dlg,id) == "Fiid")
           if (ListFI( FIKIND_CURRENCY, 0, fi ))
              fii = fi.fiid;
              dlg.rec.fiid = fi.fi_code;
              dlg.rec.fiidname = fi.name;
              message(" ~F3~ Список валют "+const_mess);
              UpdateFields(dlg);
           end;
        end;
        if (FldName(dlg,id) == "G")
            g=menu(gname,"Глава счетов");
            if (g==0)  
              dlg.rec.g = "В";
              dlg.rec.gname = "Внебалансовые счета";
              gg=3;
              message(" ~F3~ Список глав счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==1)
              dlg.rec.g = "Г";
              dlg.rec.gname = "Срочные сделки";
              gg=4;
              message(" ~F3~ Список глав счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==2)
              dlg.rec.g = "Н";
              dlg.rec.gname = "Налоговый учет";
              gg=6;
              message(" ~F3~ Список глав счетов "+const_mess);
              UpdateFields(dlg);
            else
              UpdateFields(dlg);
            end;
        end;

        if (FldName(dlg,id) == "Symbol")
            g=menu(symbolname,"Символ отчетности счета");
            if (g==0)  
              dlg.rec.symbol = string(dlg.rec.symbol,"A");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==1)  
              dlg.rec.symbol = string(dlg.rec.symbol,"D");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==2)  
              dlg.rec.symbol = string(dlg.rec.symbol,"F");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==3)  
              dlg.rec.symbol = string(dlg.rec.symbol,"G");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==4)  
              dlg.rec.symbol = string(dlg.rec.symbol,"I");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==5)  
              dlg.rec.symbol = string(dlg.rec.symbol,"L");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==6)  
              dlg.rec.symbol = string(dlg.rec.symbol,"N");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==7)  
              dlg.rec.symbol = string(dlg.rec.symbol,"R");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==8)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Q");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==9)  
              dlg.rec.symbol = string(dlg.rec.symbol,"S");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==10)  
              dlg.rec.symbol = string(dlg.rec.symbol,"U");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==11)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Z");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==12)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Б");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==13)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Г");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==14)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Д");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==15)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Е");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==16)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ё");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==17)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ж");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==18)  
              dlg.rec.symbol = string(dlg.rec.symbol,"З");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==19)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Й");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==20)  
              dlg.rec.symbol = string(dlg.rec.symbol,"К");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==21)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Л");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==22)  
              dlg.rec.symbol = string(dlg.rec.symbol,"М");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==23)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Н");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==24)  
              dlg.rec.symbol = string(dlg.rec.symbol,"О");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==25)  
              dlg.rec.symbol = string(dlg.rec.symbol,"П");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==26)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Т");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==27)  
              dlg.rec.symbol = string(dlg.rec.symbol,"У");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==28)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ф");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==29)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Х");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==30)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ц");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==31)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ч");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==32)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ш");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==33)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Щ");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==34)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ы");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==35)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ъ");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==36)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ь");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==37)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Ю");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            elif (g==38)  
              dlg.rec.symbol = string(dlg.rec.symbol,"Я");
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);
            else
              message(" ~F3~ Список типов символов счетов "+const_mess);
              UpdateFields(dlg);

            end;
        end;
        
        
        if (FldName(dlg,id) == "Type")
            g=menu(typename,"Тип отчета");
            if (g==0)  
              dlg.rec.Type = "Общая";
              UpdateFields(dlg);
            elif (g==1)
              dlg.rec.type = "По подразделениям";
              UpdateFields(dlg);
            else
              UpdateFields(dlg);
            end;
        end;
        if (FldName(dlg,id) == "View")
            g=menu(viewname,"Вид отчета");
            if (g==0)  
              dlg.rec.view = "Оборотно-сальдовая";
              UpdateFields(dlg);
            elif (g==1)
              dlg.rec.view = "Сальдовая";
              UpdateFields(dlg);
            else
              UpdateFields(dlg);
            end;
        end;
        if (FldName(dlg,id) == "Mode")
            g=menu(modename,"Режим отчета");
            if (g==0)  
              dlg.rec.mode = "Все счета";
              UpdateFields(dlg);
            elif (g==1)
              dlg.rec.mode = "Только рублевые покрытия";
              UpdateFields(dlg);
            elif (g==2)
              dlg.rec.mode = "Без рублевого покрытия";
              UpdateFields(dlg);
            else
              UpdateFields(dlg);
            end;
        end;

        
     elif (KEY == KEY_SPACE)
          /*Сброс установок в поле офис банка*/
           if (FldName(dlg,id) == "Fnul") 
            if (dlg.rec.fnul=="")
            dlg.rec.fnul="X";
            UpdateFields(dlg);
            else
            dlg.rec.fnul="";
            UpdateFields(dlg);
            end;
           elif (FldName(dlg,id) == "Fiid")
              fii = "";
              dlg.rec.fiid = "";
              dlg.rec.fiidname = "Все";
              UpdateFields(dlg);
           elif (FldName(dlg,id) == "Symbol")
              dlg.rec.symbol = "";
           elif (FldName(dlg,id) == "FHead") 
            if (dlg.rec.fhead=="")
            dlg.rec.fhead="X";
            UpdateFields(dlg);
            else
            dlg.rec.fhead="";
            UpdateFields(dlg);
            end;
           elif (FldName(dlg,id) == "FSubb") 
            if (dlg.rec.fsubb=="")
            dlg.rec.fsubb="X";
            UpdateFields(dlg);
            else
            dlg.rec.fsubb="";
            UpdateFields(dlg);
            end;
/*           elif (FldName(dlg,id) == "Dept")
            dlg.rec.dept="";
            dlg.rec.deptname="";
            UpdateFields(dlg);*/
          end;

     elif (( KEY == KEY_F2 ) or (KEY == KEY_ENTER))         //Проверки при вводе
         if ( dlg.rec.DateBegin > {curdate} )
                MsgBox("Дата начала периода не может быть больше даты текущего операционного дня");
                return CM_IGNORE;
          elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
                MsgBox("Дата начала периода не может быть больше даты окончания периода");
                return CM_IGNORE;
         end;
          if ( dlg.rec.DateEnd > {curdate} )
                MsgBox("Дата не может быть больше даты текущего операционного дня");
                return CM_IGNORE;
          elif ( dlg.rec.DateBegin > dlg.rec.DateEnd )
                MsgBox("Дата окончания периода не может быть меньше даты начала периода");
                return CM_IGNORE;
          end;
        Datebegin  = dlg.rec.Datebegin;
        Dateend = dlg.rec.DateEnd;
        fnul=dlg.rec.fnul;
        fhead=dlg.rec.fhead;
        fsubb=dlg.rec.fsubb;
        g=dlg.rec.g;
        branchn = dlg.rec.deptname;
        gnamep=dlg.rec.gname;
        dept=dept_V;
        type=dlg.rec.type;
        view=dlg.rec.view;
        symbol=dlg.rec.symbol;
         if ((Datebegin < {curDate}))    
           Return CM_SAVE;
        elif (gettrue(true,"Дата равна текущему опрерационному дню. Продолжить?"))
           Return CM_SAVE;
        end;
      else
           Return CM_IGNORE;
     end;
   end;
        
END;


/*Точка входа в макрос*/
if (RunDialog(dlg, "Event"))                  
outall();
end;
END;

