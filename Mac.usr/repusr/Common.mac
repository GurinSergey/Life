/************************************************************************/
/*          Автоматизированная банковская система RS-Bank v6.0          */
/*                                                                      */
/*               Copyright (c) R-Style Ukraine, Kiev                    */
/*                                                                      */
/*  Имя файла        : Common.mac                                       */
/*                                                                      */
/*  Описание         : Макрос общих процедур                            */
/*                                                                      */
/*                                                                      */
/*  Программист      : Новиков С. С.                                    */
/*                                                                      */
/*  Создан           : 15.08.2008                                       */
/*  AAN : 29.03.13 I-00315514-4 в ведомости счетов по корсчетам 30109*  */
/*    не проставлялись номера сообщений в налоговую, а так же даты      */
/*      а это плохо!!!                                                  */
/************************************************************************/
import oralib;

const typesPrior = "ЧLYЯБКИ";  // KS 02.09.2010 I-059324 Признаки V6, определяющие вид счета считать первичными: "Ч", "L", "Y", "Я", "Б", "К", "И"
const typesNoNeed = "LY";       // KS 06.09.2010 I-064156 При формировании отчета "Ведомость открытых счетов" счета, имеющие признаки L (накопительные), Y (транзитные) в поле "Тип счета" должны иметь строку "Не требуется". 

// AAN : 29.03.13 I-00315514-4  Begin
//было так const nalMask = "401*-407*,40802*,40807*,40821*"; // KS 02.09.2010 I-059324 Для этих счетов надо выводить дату сообщения в налоговые органы
// а стало вот так 
const nalMask = "30109*,401*-407*,40802*,40807*,40821*"; // добавил в маску балансовый 30109*
// AAN : 29.03.13 I-00315514-4  End

// KS 17.08.2010 Заявка I-050744. Написал по образу GetAccountTypeNameByAccount. Но эта функция определяет, какой типы счета нам наиболее важный.
//                                Когда строка приорететных типов задана, то возвращается только один тип счета!
//                                Кроме того, функция возвратит и буквенные коды типа счета (types)
//                                findMethod - метод поиска. 0 - ищем тип из typePrior, 1 - ищем всё что угодно лишь бы не из typePrior
MACRO GetAccountTypeNameByAccountPrior(account,chapter, code, typePrior, types, findMethod)
private var rsc:object = Null, rsc1:object = Null, str="";
var chset,strsum = "Не указано";
var type_account     = "";
var type_account_buf = "";
var i = 1;

  /* EVG 16/12/2013 Не актуально для 2031
  if(code == 0) //национальная валюта
    str = string(" select t.t_type_account from daccount_dbt t where t.t_chapter=",chapter," and t.t_account='",account,"'");    
  else  //валюта
    str = string(" select t.t_type_account from daccount$_dbt t where t.t_chapter=",chapter," and t.t_account='",account,"'");    
  end;*/
  str = string(" select t.t_type_account from daccount_dbt t where t.t_chapter=",chapter," and t.t_account='",account,"'");    

  rsc = execSQLselect(str);

  if (rsc.moveNext())
    if (valtype(rsc.value("t_type_account")) != V_UNDEF) 

      // KS 02.09.2010 Найду тип счета без "мусора"
      if (typePrior=="")
        type_account     = rsc.value("t_type_account");
      else
        type_account = "";
        type_account_buf = rsc.value("t_type_account");

        i = 1;

        while (i <= strlen(type_account_buf))
          chset = SubStr(type_account_buf, i, 1);
          if ( ((findMethod == 0) and (Index (typePrior, chset) >  0)) or
               ((findMethod != 0) and (Index (typePrior, chset) == 0))
             )
            type_account = type_account + chset;
          end;    
          i = i + 1;      
        end;
      end;

      i = 1;

      while (i <= strlen(type_account))
      
        chset = SubStr(type_account, i, 1);

        if(code == 0) //национальная валюта
          str=string(" select t.t_name_type from dtypeac_dbt t where t.t_type_account ='",chset,"'"," and t.t_inumtype = 1"); //and t.t_inumtype = 1 order by t.t_name_type");    
        else
          str=string(" select t.t_name_type from dtypeac_dbt t where t.t_type_account ='",chset,"'"," and t.t_inumtype = 4"); //and t.t_inumtype = 4 order by t.t_name_type");    
        end;
  

        rsc1=execSQLselect(str);

        if(rsc1.moveNext())
          if (valtype(rsc1.value("t_name_type")) != V_UNDEF)
            str = rsc1.value("t_name_type");
            if (strsum != "Не указано") 
              strsum = strsum + ", " + str;
            else
              strsum = str;
            end;
          end;
        end;      
        i = i + 1;
      end;
   end;
  SetParm(4 , type_account);   // KS 02.09.2010 буквенные коды типа счета (types)
  if ((type_account == "") and (findMethod != 0))
    strsum = "";
  end;
  return strsum;  
  else
    msgbox ("Счет ",account," по главе ",chapter," не найден ");
    SetParm(4 , "");
    return "";
  end;

END;


/*R-Style Ukraine, Kiev */
/*Автор Новиков С. С. */
/*14.08.2008 19:00:00*/
/*добавил процедуру  Поиск наименования типа счета по счету ,главе и валюте */

/* Ярмольчук А.Ю. 13.11.2009 Вернул проверку на категорию типа (t.t_inumtype) Заявка № A43307 */
// KS 02.09.2010 Заявка I-050744 Обернул функцию
MACRO GetAccountTypeNameByAccount(account,chapter, code)

var types = "";

  return GetAccountTypeNameByAccountPrior(account,chapter, code, "", types, 0);

END;

// KS 02.09.2010 Заявка I-050744 Наименование счета
MACRO GetAccountName(account,chapter, code)
private var rsc:object = Null, rsc1:object = Null, str="";
var chset,strsum = "Не указано";
var i = 1;

  /* EVG 16/12/2013 Не актуально для 2031
  if(code == 0) //национальная валюта
    str = string(" select t.t_nameaccount from daccount_dbt t where t.t_chapter=",chapter," and t.t_account='",account,"'");    
  else
    str = string(" select t.t_nameaccount from daccount$_dbt t where t.t_chapter=",chapter," and t.t_account='",account,"'");    
  end;*/
  str = string(" select t.t_nameaccount from daccount_dbt t where t.t_chapter=",chapter," and t.t_account='",account,"'");    

    rsc = execSQLselect(str);

    if (rsc.moveNext())
      if (valtype(rsc.value("t_nameaccount")) != V_UNDEF) 
        return rsc.value("t_nameaccount");
      end;
    end;

    return "";

END;
