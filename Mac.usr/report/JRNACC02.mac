/************************************************************************/
/*          Автоматизированная банковская система RS-Bank v6.0          */
/*                                                                      */
/*               Copyright (c) R-Style Ukraine                          */
/*                                                                      */
/*  Имя файла        : JRNACC02.mac                                     */
/*                                                                      */
/*  Изменен          : Новиков С. С.                                    */
/*                                                                      */
/*  Дата             : 15.08.2008                                       */
/************************************************************************/

/*───────────────────────────────────────────────────────────────────────────┐
  Ведомость открытых и закрытых счетов - печать

  File Name     : jrnacc02.mac
  Call functions: PrintAccOpenCloseList
  Call from     : bk_opacc.mac
//Lavrenov: 31.05.2012 I-00201906-2
//Lavrenov: 04.06.2012 I-00203090-2
AAN : 29.03.2013 I-00328074-2 проблема с номерами сообщений в налоговую. в отчёт всегда попадал номер последнего сообщения,
      а это неправильно, в первую табл надо ставить номер сообщения об открытии счёта, а вот вторую табл сообщ о закрытии счёта
  DAI     : 25.06.2014 C-29673, C-28953, С-30730 и сопутствующая чистка кода
  VV 23.07.2014 C-30525
└───────────────────────────────────────────────────────────────────────────*/

import  BankInter, CTInter, RsbDataSet, cb_sql, rep_lib, ocp, lib_lang,
        common, nalmes; /*добавил Новиков С.С. импорт макроса общих процедур */  
                       /*добавил Новиков С.С. импорт макроса определения сообщений МНС по открытым/ закрытым счетам*/  

// KS 13.12.2010 I-087464 Ведомость открытых... Одинаковая форма для Клиентов и банков
import "fg_Life_parm.mac"; // KS 13.12.2010 I-087464 Ведомость открытых... Под ГЭБ
// KS 15.03.2012 И.К. Иванова аты сообщений налогов орг.( и отк и закр) - следующий, за днем открытия/закрытия рабочий день.
import Календарь;
private var fgBank = fg_life_subject({OurBank}); // KS 13.12.2010 I-087464 Ведомость открытых... Под ГЭБ
                   
/*------------------ Глобалы -----------------------------------------*/
private const TempTableName = "dbk_opacc_tmp";  /* имя врем. таблицы */

const  Открытые    = 1,
       Закрытые    = 2;

file pt (party);        /* Справочник клиентов     */

var Params;             /* Параметры отчёта, выбираемые в панели. */
var Count;              /* Счётчик в progress bar'е */

//VV
File  OPAC () txt write;
 var name = "data.txt";
 import lib_reporting;
var ex,ob,obBook,obSheet,obWind;

/*---------- Функции печати ------------------------------------------*/
macro printEmptyData()
    println();
    println("\tДанные отсутствуют");
    println();
end;

/* Напечатать заголовок */
MACRO  PrintReportHeader( date1, date2, openClose, accType )
    var strMain, strDat;
    debugbreak;

    if( openClose == Открытые )
        strMain = "Ведомость открытых счетов";
        OPAC.str="Ведомость открытых счетов";
        insert(OPAC);
        open(OPAC,name);
    else
        strMain = "Ведомость закрытых счетов";
        OPAC.str="Ведомость закрытых счетов";
        insert(OPAC);
        open(OPAC,name);
    end;

    if( date1 == date2 )
        strDat = "за " + date1;
        OPAC.str="за"+"|"+date1;
        insert(OPAC);
        open(OPAC,name);
    else
        strDat = "за период с " + date1 + " по " + date2;
        OPAC.str="за период с " + "|"+date1 +"|"+ " по " +"|"+date2;
        insert(OPAC);
        open(OPAC,name);
    end;

    if(  ( accType == СчетаБанка ) and (ФормаОтчета == false) )
        println();
        println(mkstr(" ", 85 - strlen(strMain) / 2) + strMain);
        println(mkstr(" ", 85 - strlen("по внутрибанковским операциям") / 2) + "по внутрибанковским операциям");
        println(mkstr(" ", 85 - strlen(strDat) / 2) + strDat);
        println();
    elif( (accType == СчетаКлиентов ) or (ФормаОтчета == true) )
        strMain = strMain + " клиентов";
        println();
        println(mkstr(" ", 85 - strlen(strMain) / 2) + strMain);
        println(mkstr(" ", 85 - strlen(strDat) / 2) + strDat);
        println();
    end;
END;

/* Напечатать заголовок */
MACRO  PrintTableHeader( date1, date2, openClose, accType )

    // KS 13.12.2010 I-087464 Ведомость открытых... Одинаковая форма для Клиентов и банков
    // SDA 08.11.2011 - приводим к форме 302-П - печать производится по одной форме 
    if (fgBank.is_GO)
        // SDA -  Мануйловой И. Посвящается - убраны необязательные столбцы о номере и наименовании сообщения в налоговую
        if( Params.NeedPrintFunds )
            [┌──────────┬────────────────────────────────────┬─────────────────────────┬─────────────────────────┬─────────────────────────┬──────────────┬──────────────┬────────────┬────────────┬────────────┬──────────┬───────────────┬─────────────────────────┐];
            [│   Дата   │ Договор об открытии счета          │                         │                         │                         │   Порядок и  │Дата сообщения│ Пенсионный │Фонд обяза- │ Госкомстат │   Дата   │ Дата сообщения│        Примечание       │];
            [│ открытия ├──────────┬─────────────────────────┤   Наименование клиента  │       Наименование      │   Номер лицевого счета  │ периодичность│  налоговым   │ фонд       │тельного    │            │ закрытия │ налоговым     │                         │];
            [│   счета  │   Дата   │  № договора             │                         │       (цель) счета      │                         │выдачи выписок│  органам об  │            │медицинского│            │  счета   │ органам о     │                         │];
            [│          │          │                         │                         │                         │                         │   по счету   │открытии счета│            │страхования │            │          │ закрытии счета│                         │];
            [├──────────┼──────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────┼──────────────┼────────────┼────────────┼────────────┼──────────┼───────────────┼─────────────────────────┤];
            [│    1     │    2     │            3            │            4            │            5            │            6            │      7       │       8      │      9     │     10     │     11     │    12    │      13       │            14           │];
         OPAC.str="Дата открытия счета  "+"|"+"Дата договора об открытии счета   "+"|"+"№ договора  "+"|"+"Наименование клиента      "+"|"+"Наименование(цель) счета "+"|"+"Номер лицевого счета  "+"|"+"Порядок и периодичность выдачи выписок по счету   "+"|"+"Дата сообщения налоговым органам об открытии счета   "+"|"+"Пенсионный фонд  "+"|"+"Фонд обязательного медицинского страхования "+"|"+"Госкомстат"+"|"+"Дата закрытия счета"+"|"+"Дата сообщения налоговым органам о закрытии счета"+"|"+"Примечание";
         insert(OPAC);
         open(OPAC,name);
       
                    else
            [┌──────────┬─────────────────────┬─────────────────────────┬───────────────┬─────────────────────────┬──────────────┬──────────────┬──────────┬───────────────┬─────────────────────────┐];
            [│   Дата   │ Договор об открытии │                         │               │                         │   Порядок и  │Дата сообщения│   Дата   │ Дата сообщения│        Примечание       │];
            [│ открытия │ счета               │   Наименование клиента  │  Наименование │   Номер лицевого счета  │ периодичность│  налоговым   │ закрытия │ налоговым     │                         │];
            [│   счета  ├──────────┬──────────┤                         │  (цель) счета │                         │выдачи выписок│  органам об  │  счета   │ органам о     │                         │];
            [│          │   Дата   │№ договора│                         │               │                         │   по счету   │открытии счета│          │ закрытии счета│                         │];
            [├──────────┼──────────┼──────────┼─────────────────────────┼───────────────┼─────────────────────────┼──────────────┼──────────────┼──────────┼───────────────┼─────────────────────────┤];
            [│    1     │    2     │    3     │            4            │       5       │            6            │      7       │      8       │     9    │      10       │            11           │];
         OPAC.str="Дата открытия счета"+"|"+"Дата договора об открытии счета"+"|"+"№ договора"+"|"+"Наименование клиента"+"|"+"Наименование(цель) счета"+"|"+"Номер лицевого счета"+"|"+"Порядок и периодичность выдачи выписок по счету"+"|"+"Дата сообщения налоговым органам об открытии счета"+"|"+"Дата закрытия счета"+"|"+"Дата сообщения налоговым органам о закрытии счета"+"|"+"Примечание";       
         insert(OPAC);
         open(OPAC,name);
         
        end;
    else
       /* EVG 16/12/2013 Как я понял (по старому макросу), в банке нет различий между формой по клиентским и внутрибанковским счетам.
       if(  ( accType == СчетаБанка ) and (ФормаОтчета == false) )
          [┌──────────┬─────────────────────────┬────────────────────┬────────────────────────────────────────┬──────────┬─────────────────────────────────────────┬───────────────┐];
          [│   Дата   │                         │                    │                                        │   Дата   │                                         │               │];
          [│ открытия │   Номер лицевого счета  │ Название счета     │        Основание открытия счета        │ закрытия │         Основание закрытия счета        │   Примечание  │];
          [│   счета  │                         │                    │                                        │   счета  │                                         │               │];
          [├──────────┼─────────────────────────┼────────────────────┼────────────────────────────────────────┼──────────┼─────────────────────────────────────────┼───────────────┤];
          [│    1     │            2            │          3         │                    4                   │     5    │                    6                    │       7       │];

       elif( (accType == СчетаКлиентов ) or (ФормаОтчета == true) )*/
           if( Params.NeedPrintFunds )
              /* EVG 16/12/2013 Форма, используемая у заказчика, немного отличается от штатной.
              [┌──────────┬────────────────────────────────────┬─────────────────────────┬─────────────────────────┬─────────────────────────┬──────────────┬──────────────┬────────────┬────────────┬────────────┬──────────┬───────────────┬───────────────┐];
              [│   Дата   │ Договор об открытии счета          │                         │                         │                         │   Порядок и  │Дата сообщения│ Пенсионный │Фонд обяза- │ Госкомстат │   Дата   │ Дата сообщения│   Примечание  │];
              [│ открытия ├──────────┬─────────────────────────┤   Наименование клиента  │       Наименование      │   Номер лицевого счета  │ периодичность│  налоговым   │ фонд       │тельного    │            │ закрытия │ налоговым     │               │];
              [│   счета  │   Дата   │  № договора             │                         │       (цель) счета      │                         │выдачи выписок│  органам об  │            │медицинского│            │  счета   │ органам о     │               │];
              [│          │          │                         │                         │                         │                         │   по счету   │открытии счета│            │страхования │            │          │ закрытии счета│               │];
              [├──────────┼──────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────┼──────────────┼────────────┼────────────┼────────────┼──────────┼───────────────┼───────────────┤];
              [│    1     │    2     │            3            │            4            │            5            │            6            │      7       │       8      │     9      │     10     │     11     │    12    │      13       │       14      │];*/
              [┌──────────┬────────────────────────────────────┬─────────────────────────┬─────────────────────────┬─────────────────────────┬──────────────┬─────────────────┬──────────────┬──────────────┬────────────┬────────────┬────────────┬──────────┬─────────────────┬──────────────┬───────────────┬─────────────────────────┐];
              [│   Дата   │ Договор об открытии счета          │                         │                         │                         │   Порядок и  │Номер сообщения  │ Наименование │Дата сообщения│ Пенсионный │Фонд обяза- │ Госкомстат │   Дата   │Номер сообщения  │Наименование  │ Дата сообщения│        Примечание       │];
              [│ открытия ├──────────┬─────────────────────────┤   Наименование клиента  │       Наименование      │   Номер лицевого счета  │ периодичность│  налоговым      │ электронного │  налоговым   │ фонд       │тельного    │            │ закрытия │  налоговым      │электронного  │ налоговым     │                         │];
              [│   счета  │   Дата   │  № договора             │                         │       (цель) счета      │                         │выдачи выписок│  органам об     │ сообщения об │  органам об  │            │медицинского│            │  счета   │  органам о      │сообщения о   │ органам о     │                         │];
              [│          │          │                         │                         │                         │                         │   по счету   │открытии счета   │открытии счета│открытии счета│            │страхования │            │          │ закрытии счета  │закрытии счета│ закрытии счета│                         │];
              [├──────────┼──────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────┼─────────────────┼──────────────┼──────────────┼────────────┼────────────┼────────────┼──────────┼─────────────────┼──────────────┼───────────────┼─────────────────────────┤];
              [│    1     │    2     │            3            │            4            │            5            │            6            │      7       │        8        │      9       │       10     │     11     │     12     │     13     │    14    │        15       │     16       │      17       │            18           │];

         OPAC.str="Дата открытия счета   "+"|"+"Дата договора об открытии счета   "+"|"+"№ договора  "+"|"+"Наименование клиента  "+"|"+"Наименование(цель) счета  "+"|"+"Номер лицевого счета  "+"|"+"Порядок и периодичность выдачи выписок по счету"+"|"+"Номер сообщения налоговым органам об открытии счета"+"|"+"Наименование электронного сообщения об открытии счета"+"|"+"Дата сообщения налоговым органам об открытии счета"+"|"+"Пенсионный фонд"+"|"+"Госкомстат"+"|"+"Дата закрытия счета"+"|"+"Номер сообщения налоговым органам о закрытии счета"+"|"+"Наименование электронного сообщения о закрытии счета"+"|"+"Дата сообщения налоговым органам об открытии счета"+"|"+"Примечание";
         insert(OPAC);
         open(OPAC,name);
        
           else
              /* EVG 16/12/2013 Форма, используемая у заказчика, немного отличается от штатной.
              [┌──────────┬────────────────────────────────────┬─────────────────────────┬─────────────────────────┬─────────────────────────┬──────────────┬──────────────┬──────────┬───────────────┬───────────────┐];
              [│   Дата   │ Договор об открытии счета          │                         │                         │                         │   Порядок и  │Дата сообщения│   Дата   │ Дата сообщения│   Примечание  │];
              [│ открытия ├──────────┬─────────────────────────┤   Наименование клиента  │       Наименование      │   Номер лицевого счета  │ периодичность│  налоговым   │ закрытия │ налоговым     │               │];
              [│   счета  │   Дата   │  № договора             │                         │       (цель) счета      │                         │выдачи выписок│  органам об  │  счета   │ органам о     │               │];
              [│          │          │                         │                         │                         │                         │   по счету   │открытии счета│          │ закрытии счета│               │];
              [├──────────┼──────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────┼──────────────┼──────────┼───────────────┼───────────────┤];
              [│    1     │    2     │            3            │            4            │            5            │            6            │      7       │       8      │    9     │      10       │       11      │];*/
              [┌──────────┬─────────────────────┬─────────────────────────┬───────────────┬─────────────────────────┬──────────────┬───────────────────────┬──────────────┬──────────────┬──────────┬───────────────────────┬──────────────┬───────────────┬─────────────────────────┐];
              [│   Дата   │ Договор об открытии │                         │               │                         │   Порядок и  │   Номер сообщения     │ Наименование │Дата сообщения│   Дата   │   Номер сообщения     │ Наименование │ Дата сообщения│        Примечание       │];
              [│ открытия │ счета               │   Наименование клиента  │  Наименование │   Номер лицевого счета  │ периодичность│     налоговым         │ электронного │  налоговым   │ закрытия │     налоговым         │ электронного │ налоговым     │                         │];
              [│   счета  ├──────────┬──────────┤                         │  (цель) счета │                         │выдачи выписок│     органам об        │ сообщения об │  органам об  │  счета   │     органам о         │  сообщения о │ органам о     │                         │];
              [│          │   Дата   │№ договора│                         │               │                         │   по счету   │   открытии счета      │открытии счета│открытии счета│          │   закрытии счета      │закрытии счета│ закрытии счета│                         │];
              [├──────────┼──────────┼──────────┼─────────────────────────┼───────────────┼─────────────────────────┼──────────────┼───────────────────────┼──────────────┼──────────────┼──────────┼───────────────────────┼──────────────┼───────────────┼─────────────────────────┤];
              [│    1     │    2     │    3     │            4            │       5       │            6            │      7       │            8          │      9       │      10      │    11    │           12          │      13      │      14       │            15           │];

         OPAC.str="Дата открытия счета"+"|"+"Дата договора об открытии счета"+"|"+"№ договора"+"|"+"Наименование клиента"+"|"+"Наименование(цель) счета"+"|"+"Номер лицевого счета"+"|"+"Порядок и периодичность выдачи выписок по счету"+"|"+"Номер сообщения налоговым органам об открытии счета"+"|"+"Наименование электронного сообщения об открытии счета"+"|"+"Дата сообщения налоговым органам об открытии счета"+"|"+"Дата закрытия счета"+"|"+"Номер сообщения налоговым органам о закрытии счета"+"|"+"Наименование электронного сообщения о закрытии счета"+"|"+"Дата сообщения налоговым органам о закрытии счета"+"|"+"Примечание";
         insert(OPAC);
         open(OPAC,name);
        
           end;
       //end;
    end;
END;

/*-----------------------------------------------------------------------*/
MACRO PrintReportFooter( accType )
    printLn();
    printLn({Name_Book}," ___________________ ", {FIO_Book});
    printLn();
END;

MACRO PrintTableFooter(accType, date1, date2, openClose, count )
    private var strMain,strDat;
    if (fgBank.is_GO)
    // SDA -  Мануйловой И. Посвящается - убраны необязательные столбцы о номере и наименовании сообщения в налоговую
        if( Params.NeedPrintFunds )
            [└──────────┴──────────┴─────────────────────────┴─────────────────────────┴─────────────────────────┴─────────────────────────┴──────────────┴──────────────┴────────────┴────────────┴────────────┴──────────┴───────────────┴─────────────────────────┘];
        else
            [└──────────┴──────────┴──────────┴─────────────────────────┴───────────────┴─────────────────────────┴──────────────┴──────────────┴──────────┴───────────────┴─────────────────────────┘];
        end;
    else
        if( Params.NeedPrintFunds )
            [└──────────┴──────────┴─────────────────────────┴─────────────────────────┴─────────────────────────┴─────────────────────────┴──────────────┴─────────────────┴──────────────┴──────────────┴────────────┴────────────┴────────────┴──────────┴─────────────────┴──────────────┴───────────────┴─────────────────────────┘];
        else
            [└──────────┴──────────┴──────────┴─────────────────────────┴───────────────┴─────────────────────────┴──────────────┴───────────────────────┴──────────────┴──────────────┴──────────┴───────────────────────┴──────────────┴───────────────┴─────────────────────────┘];
        end;
    end;
    if( openClose == Открытые )
        strMain = " открыто";
    else
        strMain = " закрыто";
    end;

    if( date1 == date2 )
        strDat = "Итого за " + date1;
    else
        strDat = "Итого за период с " + date1 + " по " + date2;
    end;
    strMain = strDat+strMain+" "+count+" счетов";
     OPAc.str= " ";
        insert(OPAC);
        open(OPAC,name);
    OPAc.str= strMain;
        insert(OPAC);
        open(OPAC,name);
    [ #  
    ]( strMain );
END;

MACRO ConvParm( )
    var i = 0, val;
    while( GetParm( i, val ) )
        if( val == NULL )
            val = "";
        else
            val = SQL_ConvType( val );
        end;
        SetParm( i, val );
        i = i + 1;
    end;
END;

//DAI 17.06.2014 C-28953
MACRO MesFromStatement(acc)
    var OpenMesID = 0;
    var OpenMesName = "";
    var OpenMesNumb = "";
    var OpenMesDate = "";

    var CloseMesID = 0;
    var CloseMesName = "";
    var CloseMesNumb = "";
    var CloseMesDate = "";
    
    //TAM 19.09.2014 R-454130-2
    var MesType = "";
    
    var ArrVal = TArray();

    var TextSQL = "SELECT   wltpfld.t_name,"+"\n"+
                  "         wlmesval.t_value,"+"\n"+
                  "         lnk.t_objkind,"+"\n"+
                  "         wlmesval.t_mesid"+"\n"+
                  "  FROM   dreqopena_dbt req,"+"\n"+
                  "         DWLMESLNK_DBT lnk,"+"\n"+
                  "         dwlmesval_dbt wlmesval,"+"\n"+
                  "         dwltpfld_dbt wltpfld,"+"\n"+
                  "         dwlmesfld_dbt wlmesfld"+"\n"+
                  " WHERE       req.t_account = '"+acc+"'"+"\n"+
                  "         AND wlmesval.t_mesid = lnk.t_mesid"+"\n"+
                  "         AND lnk.t_objkind = 450"+"\n"+ //Заявление на открытие
                  "         AND req.t_requestid = lnk.t_objid"+"\n"+
                  "         AND wlmesfld.t_TpFieldID = wltpfld.t_TpfieldID"+"\n"+
                  "         AND wlmesval.t_FieldID(+) = wlmesfld.t_FieldID"+"\n"+
                  "         AND wltpfld.t_name = 'НомСооб'"+"\n"+
                  " UNION "+"\n"+
                  "SELECT   wltpfld.t_name,"+"\n"+
                  "         wlmesval.t_value,"+"\n"+
                  "         lnk.t_objkind,"+"\n"+
                  "         wlmesval.t_mesid"+"\n"+
                  "  FROM   dreqclosa_dbt req,"+"\n"+
                  "         DWLMESLNK_DBT lnk,"+"\n"+
                  "         dwlmesval_dbt wlmesval,"+"\n"+
                  "         dwltpfld_dbt wltpfld,"+"\n"+
                  "         dwlmesfld_dbt wlmesfld"+"\n"+
                  " WHERE       req.t_account = '"+acc+"'"+"\n"+
                  "         AND wlmesval.t_mesid = lnk.t_mesid"+"\n"+
                  "         AND lnk.t_objkind = 451"+"\n"+ //Заявление на закрытие
                  "         AND req.t_requestid = lnk.t_objid"+"\n"+
                  "         AND wlmesfld.t_TpFieldID = wltpfld.t_TpfieldID"+"\n"+
                  "         AND wlmesval.t_FieldID(+) = wlmesfld.t_FieldID"+"\n"+
                  "         AND wltpfld.t_name = 'НомСооб'";

    var rs = trsbdataset(TextSQL);

    while( rs and rs.moveNext() )
        if   (rs.t_objkind ==450)
            OpenMesID   = rs.t_mesid;
            OpenMesNumb = rs.t_value;
        elif (rs.t_objkind == 451)
            CloseMesID   = rs.t_mesid;
            CloseMesNumb = rs.t_value;
        end;
    end;

    if (OpenMesID != 0)
        TextSQL = "SELECT   T.T_NAME, T.T_DESCRIPTION"+"\n"+
                  "  FROM   dwlmesrls_dbt t, dwlmes_dbt tt"+"\n"+
                  " WHERE   TT.T_MESID = " + OpenMesID +"\n"+
                  "     AND tt.t_rlsformid = t.t_rlsformid";
        rs = trsbdataset(TextSQL);
        if (rs.moveNext())
            OpenMesName = rs.t_name;
        end;
    end;

    if (CloseMesID != 0)
        TextSQL = "SELECT   T.T_NAME, T.T_DESCRIPTION"+"\n"+
                  "  FROM   dwlmesrls_dbt t, dwlmes_dbt tt"+"\n"+
                  " WHERE   TT.T_MESID = " + CloseMesID +"\n"+
                  "     AND tt.t_rlsformid = t.t_rlsformid";
        rs = trsbdataset(TextSQL);
        if (rs.moveNext())
            CloseMesName = rs.t_name;
        end;
    end;

    //TAM 19.09.2014 R-454130-2
    if(index(CloseMesName, "510") > 0)
        TextSQL = " SELECT   nvl(VAL.T_VALUE,'') t_type                            " +
                  " FROM   dwlmesval_dbt val, dwltpfld_dbt fld, dwlmesfld_dbt mfld " +
                  " WHERE    val.t_mesid = " + CloseMesID                            +
                  "      AND fld.t_name = 'ТипСооб'                                " +
                  "      AND mfld.t_TpFieldID = fld.t_TpfieldID                    " +
                  "      AND VAL.T_FIELDID(+) = MFLD.T_FIELDID                     ";
        rs = trsbdataset(TextSQL);
        if (rs.moveNext())
            MesType = rs.t_type;
            CloseMesNumb = CloseMesNumb + "," + MesType;
        end;
    end;
    
    if(index(OpenMesName, "510") > 0)
        TextSQL = " SELECT   nvl(VAL.T_VALUE,'') t_type                            " +
                  " FROM   dwlmesval_dbt val, dwltpfld_dbt fld, dwlmesfld_dbt mfld " +
                  " WHERE    val.t_mesid = " + OpenMesId                             +
                  "      AND fld.t_name = 'ТипСооб'                                " +
                  "      AND mfld.t_TpFieldID = fld.t_TpfieldID                    " +
                  "      AND VAL.T_FIELDID(+) = MFLD.T_FIELDID                     ";
        rs = trsbdataset(TextSQL);
        if (rs.moveNext())
            MesType = rs.t_type;
            OpenMesNumb  = OpenMesNumb + ","  + MesType;
        end;
    end;
    
    ArrVal[0] = OpenMesNumb;
    ArrVal[1] = OpenMesName;
    ArrVal[2] = OpenMesDate;

    ArrVal[3] = CloseMesNumb;
    ArrVal[4] = CloseMesName;
    ArrVal[5] = CloseMesDate;
    
    Return ArrVal;

END;

MACRO PrintAccClient( Open_Date, Contr_Date, Contr_Number, NameCl, NameAccount, Account, ExtractPeriod, Reg_Date, Close_Date, RegDate1, chapter,code_currency)
            var ar = tarray;
    private var short_account_name:string="";
    private var pz_:integer=0;
    private var types = ""; // KS 02.09.2010 I-059324 Буквенный код типа счета
    private var Notes = ""; // KS 02.09.2010 I-059324 Для примечания
    //ar = Nal(account);
    ar = MesFromStatement(account); //DAI 17.06.2014 C-28953
    private var rs, str, str1;
    private var cmd;
    private var accType;
    
   /*SDA - определяем является ли счет клиентским или банковским */
    if (CompareStrWithMasks( МаскаСчетовКлиентов, substr(Account,1,5)) == 0)
        accType = СчетаКлиентов;
    else
        accType = СчетаБанка; 
        Contr_Date = date(0,0,0);
        Contr_Number = " ";
        NameCl = {Name_Bank};
    end;
    /*//01 Aug 07 Wed 10:24:07 Malakhova Irina 110772
    */
    /*Добавила колонку с датой сообщения налоговым органам о закрытии счета*/
    const NO_NEED = "Не требуется";
    const NO_CLOSED = "Не закрыт";
    private var i = 1; // KS 06.09.2010 Итератор
    private var typesNoNeedIsExists = false;  // KS 06.09.2010 Встретились ли типы, по которым не надо выводить дату
    ConvParm( Open_Date, Contr_Date, Contr_Number, NameCl, NameAccount, Account, ExtractPeriod, Reg_Date, Close_Date, RegDate1);

    // KS 31.01.2012 C-8638
    if (StrLen(ExtractPeriod)==0)
        ExtractPeriod = "по провед. опер";
    end;

    short_account_name= GetAccountTypeNameByAccountPrior( Account,chapter, code_currency, typesPrior, types, 0); // KS 17.08.2010-02.09.2010 I-059324 Признаки V6, определяющие вид счета считать первичными: "Ч", "L", "Y", "Я", "Б", "К", "И"
    if ((index(typesPrior, types)==0)or(types=="")) // KS 02.09.2010 I-059324 Eсли признак не первичный, то брать наименование
        short_account_name = GetAccountName( Account,chapter, code_currency);
        short_account_name = StrSubst(short_account_name,StrFor(13),"");
        short_account_name = Trim(StrSubst(short_account_name,NameCl,""));
    end;
    // KS 17.08.2010-02.09.2010 I-059324 Признаки V6, определяющие вид счета считать вторичными - все кроме: "Ч", "L", "Y", "Я", "Б", "К", "И"
    // KS 06.09.2010 I-064156 При формировании отчета "Ведомость открытых счетов" счета, имеющие признаки L (накопительные), Y (транзитные) в поле "Тип счета" должны иметь строку "Не требуется". 
    while ((i <= strlen(types)) and (not typesNoNeedIsExists))
        if (index(typesNoNeed,substr(types,i,1)))
            typesNoNeedIsExists = true;
        end;
        i = i + 1;      
    end;
    
    if ( (CompareStrWithMasks(МаскаСчетовССообВМНС, Account)) or // KS 02.09.2010 I-059324 Для этих счетов надо выводить дату сообщения в налоговые органы, для остальных - нет
         (typesNoNeedIsExists) )                    // KS 06.09.2010 I-064156 При формировании отчета "Ведомость открытых счетов" счета, имеющие признаки L (накопительные), Y (транзитные) в поле "Тип счета" должны иметь строку "Не требуется". 
      ar[2] = ar[5] = NO_NEED;
    else // KS 02.09.2010 I-059324 Если даты не заполнены, то берём даты открытия и закрытия
        // KS 22.02.2011 I-00009450 Заполнение полей в Книге Регистрации
        //DAI 17.06.2014 C-28953
        if ((Open_Date  >= Params.BeginDate) and (Open_Date  <= Params.EndDate) and 
            (Close_Date == date(0,0,0)))
            //Счет открыт внутри периода и не закрыт
            ar[3] = ""; //сообщение о закрытии не существует
            ar[4] = ""; //столбцы 12 и 13 не заполняем
        elif ((Close_Date >= Params.BeginDate) and (Close_Date <= Params.EndDate) and 
              (Open_Date  < Params.BeginDate))
            //Счет закрыт внутри периода но открыт был раньше
            ar[0] = ""; //№ сообщения об открытии счета в 8м столбце не указываем
            ar[1] = "";
                end;
            
        if (ar[2] == "")
            ar[2] = Reg_Date; //Open_Date; //тащить дату из даты сообщения в налоговую
        end;
        if (ar[2] == "") // KS 15.03.2012 И.К. Иванова аты сообщений налогов орг.( и отк и закр) - следующий, за днем открытия/закрытия рабочий день.
            ar[2] = GetDateAfterWorkDays(Open_Date, 1);
        end;
        if (ar[5] == "")
            if (Close_Date == date(0,0,0))
                //Lavrenov: 04.06.2012 I-00203090-2 Дата сообщения об открытии должна быть пустой.
                if (fgBank.is_PRBB)
                    ar[5] = "";
                else
                    ar[5] = "00.00.0000";
                end;
            else
                //ar[5] = Close_Date;
                // KS 15.03.2012 И.К. Иванова аты сообщений налогов орг.( и отк и закр) - следующий, за днем открытия/закрытия рабочий день.
                ar[5] = GetDateAfterWorkDays(Close_Date, 1);
            end;
        end;
    end;
    // KS 02.09.2010 I-059324 Вычисляем примечание
    //Lavrenov: 31.05.2012 I-00201906-2 в 15 столбце в закрытых счетах стоит расшифровка типа счета - не нужно!
    //Lavrenov: 04.06.2012 I-00203090-2 в 15 столбце расшифровка не нужна вообще.
    if (fgBank.is_PRBB)
        /*if (Close_Date==date(0,0,0))
            Notes = GetAccountTypeNameByAccountPrior( Account,chapter, code_currency, typesPrior, types, 1); // KS 17.08.2010-02.09.2010 I-059324 Признаки V6, определяющие вид счета считать вторичными - все кроме: "Ч", "L", "Y", "Я", "Б", "К", "И"
        end; */
        Notes = "";
    else
        Notes = GetAccountTypeNameByAccountPrior( Account,chapter, code_currency, typesPrior, types, 1); // KS 17.08.2010-02.09.2010 I-059324 Признаки V6, определяющие вид счета считать вторичными - все кроме: "Ч", "L", "Y", "Я", "Б", "К", "И"
    end;
    if (types == "")
        Notes = "";
    end;

    // KS 22.02.2011 I-00009450 Заполнение полей в Книге Регистрации
    if (Close_Date == date(0,0,0))
        //Lavrenov: 31.05.2012 I-00201906-2 В открытых счетах в 11 стголбце не надо писать ничего.
        if (fgBank.is_PRBB)
            Close_Date = "";
        else
            Close_Date = NO_CLOSED;
        end;
        ar[3] = ""; // KS 31.01.2012 C-8638
    else
        if (not fgBank.is_PRBB)
           ar[0] = ""; // KS 31.01.2012 C-8638
        end;
    end;

    if (fgBank.is_GO)
    // SDA -  Мануйловой И. Посвящается - убраны необязательные столбцы о номере и наименовании сообщения в налоговую
        if( Params.NeedPrintFunds )
            [├──────────┼──────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────┼──────────────┼────────────┼────────────┼────────────┼──────────┼───────────────┼─────────────────────────┤];
            [│##########│##########│#########################│#########################│#########################│#########################│##############│##############│############│############│############│##########│###############│#########################│]
            ( Open_Date:f:c, Contr_Date:f:c, Contr_Number:w, NameCl:w,
             short_account_name:w, 
             Account:f, ExtractPeriod:w, ar[2]/*Reg_Date:c*/, NO_NEED, NO_NEED, NO_NEED, Close_Date:f:c, ar[5]/*RegDate1:c*/,
             Notes // KS 02.09.2010 I-059324 вторичный признак должен отображаться только в графе "Примечание"
            );
            OPAC.str=Open_Date+"|"+Contr_Date+"|"+Contr_Number+"|"+NameCl+"|"+short_account_name+"|"+Account+"|"+ExtractPeriod+"|"+ar[2]+"|"+NO_NEED+"|"+NO_NEED+"|"+NO_NEED+"|"+Close_Date+"|"+ar[5]+"|"+Notes; 
            insert(OPAC); 
            open(OPAC,name);
        else
            [├──────────┼──────────┼──────────┼─────────────────────────┼───────────────┼─────────────────────────┼──────────────┼──────────────┼──────────┼───────────────┼─────────────────────────┤];
            [│##########│##########│##########│#########################│###############│#########################│##############│##############│##########│###############│#########################│]
            ( Open_Date:f:c, Contr_Date:f:c, Contr_Number:w, NameCl:w, 
              short_account_name:w, 
             Account:f, ExtractPeriod:w,ar[2]/*Reg_Date:c*/, Close_Date/*:f*/:c, ar[5]/*RegDate1:c*/,
             Notes // KS 02.09.2010 I-059324 вторичный признак должен отображаться только в графе "Примечание"
            );
            OPAC.str=Open_Date+"|"+Contr_Date+"|"+Contr_Number+"|"+NameCl+"|"+short_account_name+"|"+Account+"|"+ExtractPeriod+"|"+ar[2]+"|"+Close_Date+"|"+ar[5]+"|"+Notes; 
            insert(OPAC); 
            open(OPAC,name);
        end;
    else
        if( Params.NeedPrintFunds )
            [├──────────┼──────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────┼─────────────────┼──────────────┼──────────────┼────────────┼──────────────┼────────────┼──────────┼───────────────┼──────────────┼───────────────┼─────────────────────────┤];
            [│##########│##########│#########################│#########################│#########################│#########################│##############│################ │############  │##############│############│##############│############│######### │ ############# │ #############│ ############# │#########################│]
            ( Open_Date:f:c, Contr_Date:f:c, Contr_Number:w, NameCl:w,

            // GetAccountTypeNameByAccount( Account,chapter, code_currency):w, заремил vihrov 17.11.2009
             short_account_name:w, //vihrov 17.11.2009 чтобы в графе 5 вместо "Текущий, Арест на кредит" было просто "текущий". просьба банка.
             Account:f, ExtractPeriod:w, /*"Нет данных",*/ar[0]:w, ar[1]:w/*"Нет данных"*/,ar[2]/*Reg_Date:c*/, NO_NEED, NO_NEED, NO_NEED, Close_Date:f:c,/*"Нет данных"*/ar[3]:w,ar[4]:w /*"Нет данных"*/,ar[5]/*RegDate1:c*/,
             Notes // KS 02.09.2010 I-059324 вторичный признак должен отображаться только в графе "Примечание"
            );
            OPAC.str=Open_Date+"|"+Contr_Date+"|"+Contr_Number+"|"+NameCl+"|"+short_account_name+"|"+Account+"|"+ExtractPeriod+"|"+ar[0]+"|"+ar[1]+"|"+ar[2]+"|"+NO_NEED+"|"+NO_NEED+"|"+NO_NEED+"|"+Close_Date+"|"+ar[3]+"|"+ar[4]+"|"+ar[5]+"|"+Notes; 
            insert(OPAC); 
            open (OPAC,name);

        else
            [├──────────┼──────────┼──────────┼─────────────────────────┼───────────────┼─────────────────────────┼──────────────┼───────────────────────┼──────────────┼──────────────┼──────────┼───────────────────────┼──────────────┼───────────────┼─────────────────────────┤];     
            [│##########│##########│##########│#########################│###############│#########################│##############│###################### │############  │##############│##########│###################### │ ############ │############## │#########################│]
            ( Open_Date:f:c, Contr_Date:f:c, Contr_Number:w, NameCl:w, 
              short_account_name:w, //vihrov 17.11.2009 чтобы в графе 5 вместо "Текущий, Арест на кредит" было просто "текущий". просьба банка.
             Account:f, ExtractPeriod:w, ar[0]:w, ar[1]:w ,ar[2], Close_Date:c, ar[3]:w,ar[4]:w, ar[5],
             Notes // KS 02.09.2010 I-059324 вторичный признак должен отображаться только в графе "Примечание"
            );
            OPAC.str=Open_Date+"|"+Contr_Date+"|"+Contr_Number+"|"+NameCl+"|"+short_account_name+"|"+Account+"|"+ExtractPeriod+"|"+ar[0]+"|"+ar[1]+"|"+ar[2]+"|"+Close_Date+"|"+ar[3]+"|"+ar[4]+"|"+ar[5]+"|"+Notes; 
            insert(OPAC);
            open (OPAC,name);
        end;


    end;
END;

/* Является ли закрытым */
MACRO IsClose( a )
    return ( a.Close_Date == NULL ) or ( ( a.Close_Date >= Params.BeginDate ) and ( a.Close_Date <= Params.EndDate ) );
END;

MACRO GetClient( a )
    pt.PartyID = a.Client;
    if( getEQ( pt ) )
        return pt;
    else
        msgbox( "Не найден клиент " + string( a.Client ) + " для ЛС " + string( a.Account ) );
        exit( 1 );
    end;
END;

MACRO PutAccBank( a )
    var accountForPrint; /* 16.10.2007 Malakhova 114925*/

    if (a.backOffice == REP_SUBSYSTEMS_RETAIL)
        accountForPrint = substr(a.Account, 1, 20);
    else
        accountForPrint = a.Account;
    end;
    
    var client = GetClient( a );
    var closeDate = a.Close_Date;
    
    if( not IsClose( a ) )
        closeDate = Date(0,0,0);
    end;
    
    PrintAccClient( a.Open_Date, a.ContractDate, a.ContractNumber, client.Name,
                    a.NameAccount, accountForPrint, a.ExtractPeriod,
                    GetTaxMsgDate(a, client, OPEN_DATE), CloseDate,
                    GetTaxMsgDate(a, client, CLOSE_DATE), a.Chapter, a.Code_Currency);
    
END;

MACRO PutAccClient( a )
    var client = GetClient( a );
    var closeDate = a.Close_Date;

    var accountForPrint; /* 16.10.2007 Malakhova 114925*/

    if (a.backOffice == REP_SUBSYSTEMS_RETAIL)
        accountForPrint = substr(a.Account, 1, 20);
    else
        accountForPrint = a.Account;
    end;

    if( not IsClose( a ) )
        closeDate = Date(0,0,0);
    end;

    PrintAccClient( a.Open_Date, a.ContractDate, a.ContractNumber, client.Name,
                    a.NameAccount, accountForPrint, a.ExtractPeriod,
                    GetTaxMsgDate(a, client, OPEN_DATE), CloseDate,
                    GetTaxMsgDate(a, client, CLOSE_DATE), a.Chapter, a.Code_Currency);
END;

/* dat - дата отчёта (если за каждый день)
   OpenClose    - Открытые или Закрытые
   AccType      - СчетаБанка или СчетаКлиентов
   PutAccFunc   - Функция вывода счёта (@PutAccBank или @PutAccClient)
*/
MACRO PutOneTable( dat, openClose, accType, putAccFunc )
    var ЗаголовокНапечатан = FALSE;
    var filter, dateField;

    //Lavrenov: 31.05.2012 I-00201906-2 Количество счетов не совпадало с итогом.
    count = 0;


    /* Открытые/закрытые и дата */
    if(   openClose == Открытые )
        dateField = "t_Open_Date";
    elif( openClose == Закрытые )
        dateField = "t_Close_Date";
    end;
    if( dat != NULL )
        filter = dateField + " = " + GetSQLDate( dat );
    else
        filter = dateField + " BETWEEN " + GetSQLDate( Params.BeginDate ) + " AND " + GetSQLDate( Params.EndDate );
    end;

    /* По принадлежности счёта */
    if(   accType == СчетаБанка )
        filter = filter + " AND not (" + ConvertMaskToSQLFormat( МаскаСчетовКлиентов, "t_Balance" ) + ")";
    elif( accType == СчетаКлиентов )
        filter = filter + " AND     (" + ConvertMaskToSQLFormat( МаскаСчетовКлиентов, "t_Balance" ) + ")";
    end;

    var data = TRsbDataSet( "SELECT * FROM " + TempTableName + " WHERE " + filter
        + " ORDER BY " + dateField + ", t_Account" );

    while( data.MoveNext( ) )
        if( not ЗаголовокНапечатан )
            if( dat != NULL )
                PrintReportHeader( dat, dat, openClose, accType );
                PrintTableHeader( dat, dat, openClose, accType );
            else
                PrintReportHeader( Params.BeginDate, Params.EndDate, openClose, accType );
                PrintTableHeader( Params.BeginDate, Params.EndDate, openClose, accType );
            end;
            ЗаголовокНапечатан = TRUE;
        end;

        // KS 13.12.2010 I-087464 Ведомость открытых... Одинаковая форма для Клиентов и банков
        if (  accType == СчетаБанка ) 
            data.ContractDate = data.Open_Date;
        end;

        // KS 02.02.2012 C-8638
        if(  ( fgBank.is_EXV ) and
             ( openClose == Открытые ) )
          data.Close_Date = date(0,0,0);
        end;

        ExecMacro( PutAccFunc, data );

        UseProgress( count = count + 1 );
    end;
    //Lavrenov: 31.05.2012 I-00201906-2 Количество счетов не совпадало с итогом.
    if ( ЗаголовокНапечатан )
        if( dat != NULL )
            PrintTableFooter(accType, dat, dat, openClose, count);
            count = 0;
        else
            PrintTableFooter(accType, Params.BeginDate, Params.EndDate, openClose, count);
            count = 0;
        end;
    end;

end;

/* dat - за какую дату отчёт. NULL, если по всему периоду. */
MACRO _Report( dat )

/*SDA - приводим форму к 302-п в режиме всех и клиентских счетов */
    if( ( Params.AccountType == ВсеСчета ) or ( Params.AccountType == СчетаБанка ) )
        if( Params.NeedAccOpen )
            PutOneTable( dat, Открытые, СчетаБанка, @PutAccBank ); 
        end;
        if ( Params.NeedAccClose )
            PutOneTable( dat, Закрытые, СчетаБанка, @PutAccBank ); 
        end;
    end; 
    if( ( Params.AccountType == ВсеСчета ) or ( Params.AccountType == СчетаКлиентов ) )
        if( Params.NeedAccOpen )
            PutOneTable( dat, Открытые, СчетаКлиентов, @PutAccClient );
        end;
        if ( Params.NeedAccClose )
            PutOneTable( dat, Закрытые, СчетаКлиентов, @PutAccClient );
        end;
    end;
    
    /* EVG 16/12/2013 Данный блок (пользовательский) дублирует счета в отчёте, поэтому каммент.
    if ( Params.AccountType == ВсеСчета ) 
        if( Params.NeedAccOpen )
            PutOneTable( dat, Открытые, ВсеСчета, @PutAccClient );
        end;
        if ( Params.NeedAccClose )
            PutOneTable( dat, Закрытые, ВсеСчета, @PutAccClient );
        end;
    end;
     */
END;

 open(OPAC,name);
 
macro viz()

close(OPAC);

ob = CreateObject ("rsax","TRsAxServer","RsAxServer",IsStandAlone());
ex = ob.CreateComObject ("Excel.Application", True);
ex.visible=false; 
 
CopyFile(name, "$c:\\rspar\\"+name, TRUE);
var ss = "c:\\rspar\\"+name;

  if(not (fgBank.is_GO) )
    var aw = SetTypeColumns("d,d,g,t,t,t,g,t,d,d,d,g,t,d,t,g,g,t");
  end;           
 
  obBook = ex.Workbooks.opentext (ss, 866, 1, 1,2,false,false,false,false,false,true,"|",aw,1,"."," ",true,false);

 // var numOfCol:integer;
  var obSheet = ex.Sheets(1);           /* выделение активного листа книги, с которым будем работать                                */
   obSheet.Range("A3").Select;   
   ex.ActiveWindow.Selection.RowHeight = 30;   
   obSheet.Columns("A:O").EntireColumn.AutoFit;                         /* установка автоширины колонок                  */  
   obSheet.Columns("A:O").WrapText = true;                              /* перенос по словам                             */ 
   obsheet.Columns("A:O").Select;
   ex.ActiveWindow.Selection.ColumnWidth = 20;
   obSheet.Range("A3:O3").Interior.Color = RSU_Rep_xlHeadColor;      /* заливка шапки отчета бледно-серым цветом      */
   obSheet.Range("A3:O3").Font.Bold = true;                          /* полужирный текст                              */
   obSheet.Range("A3:O3").HorizontalAlignment = xlCenter;            /* горизонтальное выравнивание по центру         */
  
	
      ex.visible = true;
end;


/****************************************************************************/
/*                                Точка входа                               */
/****************************************************************************/
MACRO PrintAccOpenCloseList( parameters, hasData )
    Params = parameters;

    if (hasData)
        // В независимости от настроек, каждый счёт из вр. табл. выведется ровно один раз.
        /*23 Mar 07 Malakhova Irina 103782*/
        InitProgress(-1, "~Ждите...~", "Печать отчета" );
        Count = 0;

        var dat;
        if( not Params.NeedEveryDay )
            _Report( ); /* без параметра - за все дни */
        else
            dat = Params.BeginDate;
            while( dat <= Params.EndDate )
                message( dat );
                _Report( dat );

                dat = dat + 1;
            end;
        end;

        RemProgress();
    else
        PrintReportHeader(Params.BeginDate, Params.EndDate, ternary(Params.NeedAccOpen, Открытые, Закрытые), Params.AccountType);
        printEmptyData();
        PrintReportFooter();
    end;
    viz();

    return TRUE;
END;

/* EoF */
