
/*дддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : PR_IND2I.MAC

  Description : ▌БГ╔Б ╞╝ ╓╝╙Ц╛╔╜Б═╛, ╜═Е╝╓ОИ╗╛АО/╞╝╛╔И╔╜╜К╛ ╒ ┼2            

  Change      : VDN 27.08.2014 C-32485 └╝║═╒╚╔╜К ╙╝╚╝╜╙╗ ▌Г╔Ю╔╓╜╝АБЛ ╗ ≤╗ДЮ ╝╞╔Ю═Ф╗╗, А╝ЮБ╗Ю╝╒╙═, ╗Б╝ё╗ ╞╝ Х╗ДЮЦ ╒╛╔АБ╝ ╝╞╔Ю═Ф╗╝╜╗АБ═
              : DPN 02.09.2014 I-00512544-2 ┬А╞Ю═╒╗╚ ╝Х╗║╙Ц ╒ ╖═╞Ю╝А╔
юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд*/

import PSInter, CTInter, globals, prreplib, FIInter, pm_categ, pm_common;

private const DOC_INSERT  = 1, // ▐╝╛╔И╔╜╜К╔ 
              LOCATED_DOC = 2; // █═Е╝╓ОИ╗╔АО

private const PSREP_FORM_RECEIVER = 0,     // ▒ ╜═╖╒═╜╗╔╛ ╞╝╚ЦГ═Б╔╚О ╗ ╝А╜╝╒═╜╗╔╛
              PSREP_FORM_DOC      = 1;     // ▒╞╗А╝╙ ╓╝╙Ц╛╔╜Б╝╒

private var ReportHead = "";
private var KindReport = 0;
private var OutForm    = 0;
private var DprtNumber = -1;
private var FIID       = -1;
private var DateOut    = date(0,0,0);

private class (RsbPayment)TRepPayment( PaymentID:integer, _isKOR:string )
  InitRsbPayment(PaymentID);
  var isKOR = _isKOR;
end;
private macro PrintHeader( parm:TPrnReportParm )
[
                                       #

                                       #
                                       #

]({Name_Bank}:c, 
   ReportHead:c, 
   IfThenElse( KindReport == DOC_INSERT, string("c "  + string( parm.m_DateIn:m ) + " ╞╝ " + string( parm.m_DateOut:m ) ), 
                                         string("╜═ " + string( parm.m_DateOut:m ) ) ):c
 );
end;

private macro PrintDprtHeader()
  var DepCode= "", DepName = "";
  CB_GetDepartmentCodeAndName( DprtNumber, DepCode, NULL, DepName );
  if( DepName != "" )
[                             #
]("▌Б╓╔╚╔╜╗╔ " + DepCode + "  " + DepName );
  end;
end;

private macro PrintOperHeader( Shifr:string )
[
  ≤╗ДЮ ╝╞╔Ю═Ф╗╗: #####]( shifr );

if( OutForm == PSREP_FORM_RECEIVER )
  if( KindReport == LOCATED_DOC )
[здддддбддддддддддбддддддддддбдддддддддддддддддддддддддбдддддддддддддддддддддддддддддддддддбддддддддддддддддддддддбддддддддддддддддддддддбдддддддддддддддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддбдддддддддддддбдддддд©
 Ё  N  Ё   └═Б═   Ё   └═Б═   Ё     ▐╚═Б╔╚ЛИ╗╙          Ё            ▐╝╚ЦГ═Б╔╚Л             Ё                      Ё                      Ё                           Ё                                                                                                         Ё             Ё      Ё
 Ё ╓╝╙ Ё ╓╝╙Ц╛╔╜Б═Ё ╞╝╛╔И╔╜╗ОЁ                         цдддддддддбддддддддддддддддддддддддд╢         ▒Ц╛╛═        Ё   █═Г═╚Л╜═О АЦ╛╛═    Ё    █═╖╒═╜╗╔ ╞╝╚ЦГ═Б╔╚О    Ё                                           ▌А╜╝╒═╜╗╔ ╞╚═Б╔╕═                                             Ё ▌Г╔Ю╔╓╜╝АБЛ Ё ≤╗ДЮ Ё
 Ё     Ё          Ё          Ё                         Ё   │┬┼   Ё          ▒Г╔Б           Ё                      Ё                      Ё                           Ё                                                                                                         Ё             Ё      Ё
 цдддддеддддддддддеддддддддддедддддддддддддддддддддддддедддддддддедддддддддддддддддддддддддеддддддддддддддддддддддеддддддддддддддддддддддедддддддддддддддддддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддедддддддддддддедддддд╢
];
  else
[здддддбддддддддддбддддддддддбдддддбдддддбдддддддддддддддддддддддддбдддддддддддддддддддддддддддддддддддбддддддддддддддддддддддбдддддддддддддддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддбдддддддддддддбдддддд©
 Ё  N  Ё   └═Б═   Ё   └═Б═   Ё ┼▌░ Ё ┌═╚ Ё       ▐╚═Б╔╚ЛИ╗╙        Ё            ▐╝╚ЦГ═Б╔╚Л             Ё                      Ё                           Ё                                                                                                         Ё             Ё      Ё
 Ё ╓╝╙ Ё ╓╝╙Ц╛╔╜Б═Ё ╞╝╛╔И╔╜╗ОЁ     Ё     Ё                         цдддддддддбддддддддддддддддддддддддд╢         ▒Ц╛╛═        Ё    █═╖╒═╜╗╔ ╞╝╚ЦГ═Б╔╚О    Ё                                             ▌А╜╝╒═╜╗╔ ╞╚═Б╔╕═                                           Ё ▌Г╔Ю╔╓╜╝АБЛ Ё ≤╗ДЮ Ё
 Ё     Ё          Ё          Ё     Ё     Ё                         Ё   │┬┼   Ё          ▒Г╔Б           Ё                      Ё                           Ё                                                                                                         Ё             Ё      Ё
 цдддддеддддддддддеддддддддддедддддедддддедддддддддддддддддддддддддедддддддддедддддддддддддддддддддддддеддддддддддддддддддддддедддддддддддддддддддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддедддддддддддддедддддд╢
];
  end;
else
  if( KindReport == LOCATED_DOC )
[здддддбддддддддддбддддддддддбдддддддддддддддддддддддддбдддддддддддддддддддддддддддддддддддбддддддддддддддддддддддбддддддддддддддддддддддбдддддддддддддбдддддд©
 Ё  N  Ё   └═Б═   Ё   └═Б═   Ё     ▐╚═Б╔╚ЛИ╗╙          Ё            ▐╝╚ЦГ═Б╔╚Л             Ё                      Ё                      Ё             Ё      Ё
 Ё ╓╝╙ Ё ╓╝╙Ц╛╔╜Б═Ё ╞╝╛╔И╔╜╗ОЁ                         цдддддддддбддддддддддддддддддддддддд╢         ▒Ц╛╛═        Ё   █═Г═╚Л╜═О АЦ╛╛═    Ё ▌Г╔Ю╔╓╜╝АБЛ Ё ≤╗ДЮ Ё
 Ё     Ё          Ё          Ё                         Ё   │┬┼   Ё          ▒Г╔Б           Ё                      Ё                      Ё             Ё      Ё
 цдддддеддддддддддеддддддддддедддддддддддддддддддддддддедддддддддедддддддддддддддддддддддддеддддддддддддддддддддддеддддддддддддддддддддддедддддддддддддедддддд╢
] 
  else
[здддддбддддддддддбддддддддддбдддддбдддддбдддддддддддддддддддддддддбдддддддддддддддддддддддддддддддддддбддддддддддддддддддддддбдддддддддддддбдддддд©
 Ё  N  Ё   └═Б═   Ё   └═Б═   Ё ┼▌░ Ё ┌═╚ Ё       ▐╚═Б╔╚ЛИ╗╙        Ё            ▐╝╚ЦГ═Б╔╚Л             Ё                      Ё             Ё      Ё
 Ё ╓╝╙ Ё ╓╝╙Ц╛╔╜Б═Ё ╞╝╛╔И╔╜╗ОЁ     Ё     Ё                         цдддддддддбддддддддддддддддддддддддд╢         ▒Ц╛╛═        Ё ▌Г╔Ю╔╓╜╝АБЛ Ё ≤╗ДЮ Ё
 Ё     Ё          Ё          Ё     Ё     Ё                         Ё   │┬┼   Ё          ▒Г╔Б           Ё                      Ё             Ё      Ё
 цдддддеддддддддддеддддддддддедддддедддддедддддддддддддддддддддддддедддддддддедддддддддддддддддддддддддеддддддддддддддддддддддедддддддддддддедддддд╢
];
  end;
end;

end;

PRIVATE MACRO PrintItogAccount( Account:string, counts:TArray, amounts:TArray )
if( OutForm == PSREP_FORM_RECEIVER )
  if( KindReport == LOCATED_DOC )
[Ё┬Б╝ё╝ ╞╝ АГ╔БЦ ##############################       ##### ╓╝╙Ц╛. ╜═                       ######################Ё######################Ё                           Ё                                                                                                         Ё             Ё      Ё
 Ё                                                                                                                Ё                      Ё                           Ё                                                                                                         Ё             Ё      Ё
]( Account, counts[0], amounts[0], amounts[1]);
  else
[Ё┬Б╝ё╝ ╞╝ АГ╔БЦ ##############################       ##### ╓╝╙Ц╛. ╜═                                   ######################Ё                           Ё                                                                                                         Ё             Ё      Ё
 Ё                                                                                                                            Ё                           Ё                                                                                                         Ё             Ё      Ё
]( Account, counts[0], amounts[0] );
  end;
else
  if( KindReport == LOCATED_DOC )
[Ё┬Б╝ё╝ ╞╝ АГ╔БЦ ##############################       ##### ╓╝╙Ц╛. ╜═                       ######################Ё######################Ё             Ё      Ё                        
 Ё                                                                                                                Ё                      Ё             Ё      Ё
]( Account, counts[0], amounts[0], amounts[1] );
  else
[Ё┬Б╝ё╝ ╞╝ АГ╔БЦ ##############################       ##### ╓╝╙Ц╛. ╜═                                   ######################Ё             Ё      Ё
 Ё                                                                                                                            Ё             Ё      Ё
]( Account, counts[0], amounts[0] );
  end;
end;
END;

private macro PrintItogOper( Shifr:string, counts:TArray, amounts:TArray )
if( KindReport == LOCATED_DOC )
  if( OutForm == PSREP_FORM_RECEIVER )
[юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддаддддддддддддддддддддддадддддддддддддддддддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддадддддддддддддадддддды
];
  else
[юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддаддддддддддддддддддддддадддддддддддддадддддды
];
  end;
if( FIID != -1/*ALLFININSTR*/ )
[ ┬Б╝ё╝ ╞╝ Х╗ДЮЦ ╝╞╔Ю═Ф╗╗: ####                       ##### ╓╝╙Ц╛. ╜═                       ######################
]( Shifr, counts[0], amounts[0] );
end;

else
  if( OutForm == PSREP_FORM_RECEIVER )
[юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддаддддддддддддддддддддддадддддддддддддддддддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддадддддддддддддадддддды
];
  else
[юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддаддддддддддддддддддддддадддддддддддддадддддды
];
  end;
if( FIID != -1/*ALLFININSTR*/ )
[ ┬Б╝ё╝ ╞╝ Х╗ДЮЦ ╝╞╔Ю═Ф╗╗: ####                       ##### ╓╝╙Ц╛. ╜═                                   ######################
]( Shifr, counts[0], amounts[0] );
end;
end;
end;

private macro PrintItogDprt( NumDprt:integer, counts:TArray, amounts:TArray )
if( FIID != -1/*ALLFININSTR*/)
if( KindReport == LOCATED_DOC )
[ 
  ┌А╔ё╝                                               ##### ╓╝╙Ц╛. ╜═                       ######################
]( counts[0], amounts[0]);
else
[ 
  ┌А╔ё╝                                               ##### ╓╝╙Ц╛. ╜═                                   ######################
]( counts[0], amounts[0]);
end;
end;
end;

private macro PrintDocument( PaymentObj:object, amounts:TArray )

  var fininstr = TRecHandler("fininstr.dbt");
  var FI_Code = "";
  if( not ▐╝╚ЦГ╗БЛ■╗╜┬╜( PaymentObj.PayerFIID, fininstr ) )
    FI_Code = fininstr.rec.FI_Code;
  end;

if( OutForm == PSREP_FORM_RECEIVER )
  if( KindReport == LOCATED_DOC )
[Ё#####Ё##########Ё##########Ё#########################Ё#########Ё#########################Ё######################Ё######################Ё###########################Ё#########################################################################################################Ё      #      Ё  ##  Ё
](PaymentObj.Number, PaymentObj.Date, PaymentObj.I2PlaceDate, PaymentObj.PayerAccount:f, PaymentObj.ReceiverBankCode, PaymentObj.ReceiverAccount:f, amounts[0], amounts[1], PaymentObj.ReceiverName, PaymentObj.Ground, PaymentObj.Priority, PaymentObj.ShifrOper );
  else
[Ё#####Ё##########Ё##########Ё#####Ё#####Ё#########################Ё#########Ё#########################Ё######################Ё###########################Ё#########################################################################################################Ё      #      Ё  ##  Ё
](PaymentObj.Number, PaymentObj.Date, PaymentObj.I2PlaceDate, PaymentObj.isKOR, FI_Code, PaymentObj.PayerAccount:f, PaymentObj.ReceiverBankCode, PaymentObj.ReceiverAccount:f, amounts[0], PaymentObj.ReceiverName, PaymentObj.Ground, PaymentObj.Priority, PaymentObj.ShifrOper );                           
  end;
else
  if( KindReport == LOCATED_DOC )
[Ё#####Ё##########Ё##########Ё#########################Ё#########Ё#########################Ё######################Ё######################Ё      #      Ё  ##  Ё
](PaymentObj.Number, PaymentObj.Date, PaymentObj.I2PlaceDate, PaymentObj.PayerAccount:f, PaymentObj.ReceiverBankCode, PaymentObj.ReceiverAccount:f, amounts[0], amounts[1], PaymentObj.Priority, PaymentObj.ShifrOper ); 
  else
[Ё#####Ё##########Ё##########Ё#####Ё#####Ё#########################Ё#########Ё#########################Ё######################Ё      #      Ё  ##  Ё
](PaymentObj.Number, PaymentObj.Date, PaymentObj.I2PlaceDate, PaymentObj.isKOR, FI_Code, PaymentObj.PayerAccount:f, PaymentObj.ReceiverBankCode, PaymentObj.ReceiverAccount:f, amounts[0], PaymentObj.Priority, PaymentObj.ShifrOper );                           
  end;
end;

end;
// АЦ╛╛═ ╞Ю╝╒╝╓╝╙ ╞╝ Г═АБ╗Г╜╝╛Ц ╗╚╗ ╞╝╚╜╝╛Ц А╞╗А═╜╗Н А ┼2 ╒ ╒═╚НБ╔ ╞Ю╝╒╝╓╙╗
private macro ▒╞╗А═╜╜═О▒Ц╛╛═( PaymentObj:object ):money

  var ▒╞╗А═╜╜═О▒Ц╛╛═ = $0;
  var params:TArray  = TArray();
  var select = "SELECT  trn.t_AccTrnID, trn.t_Sum_Receiver "+ 
              "  FROM dacctrn_dbt trn, dpmdocs_dbt pd, dpmpaym_dbt pm, dpmlink_dbt lnk "+
              " WHERE lnk.t_InitialPayment = :PaymentID "+
              "   AND lnk.t_LinkKind = 2 "+/*PMLINK_KIND_KVITING*/
              "   AND pm.t_PaymentID = lnk.t_PurposePayment "+
              "   AND pd.t_PaymentID = lnk.t_PurposePayment "+
              "   AND trn.t_AccTrnID = pd.t_AccTrnID "+
              "   AND trn.t_Result_Carry in ( 51, 52 )"+
              "   AND trn.t_date_carry BETWEEN :DateIn AND :DateOut"+
              "   AND trn.t_FIID_Receiver = pm.t_BaseFIID ";
  params[params.size] = SQLParam( "PaymentID", PaymentObj. PaymentID  );    
  params[params.size] = SQLParam( "DateIn"   , date(0,0,0)     );    
  params[params.size] = SQLParam( "DateOut"  , DateOut    );    
  var rs:RsdRecordset = execSQLselect( select, params, FALSE );
  if( rs )
    rs.Command.NullConversion = true;
    while( rs.MoveNext() )
      ▒╞╗А═╜╜═О▒Ц╛╛═ = ▒╞╗А═╜╜═О▒Ц╛╛═ + money( rs.value(1) );
    end;                          
  end;
  return ▒╞╗А═╜╜═О▒Ц╛╛═;
end;

MACRO PrintRep_K2_InsLoc( MapVal :PSRepMap )

  /* └═╜╜К╔ ╞═╜╔╚╗ */
  var DateIn        :date     = MapVal.Value( "DateIn"       );
      DateOut                 = MapVal.Value( "DateOut"      );
      FIID                    = MapVal.Value( "FIID"         );
  var Account       :string   = MapVal.Value( "Account"      );
  var DepNum        :integer  = MapVal.Value( "DepNum"       );
  var NodeNum       :integer  = MapVal.Value( "NodeNum"      );
  var Oper          :integer  = MapVal.Value( "Oper"         );
  var cSetCategory  :bool     = MapVal.Value( "cSetCategory" );

  KindReport  = MapVal.Value( "KindReport"   );
  OutForm     = MapVal.Value( "iOutForm"     );
  DprtNumber  = IfThenElse( NodeNum > 0, NodeNum, DepNum ); 
  /* ┤═╞Ю╝А */ 
  var params:TArray  = TArray();
  var select:string = "";

  /* └═╜╜К╔ ╖═╞Ю╝А═ */
  var I2InsLocReport  :object = NULL;
  var Payments        :TArray = TArray();
  var Amounts         :TArray = TArray();

  var PaymentObj   :object = NULL,
      PsPayOrderObj:object = NULL;

  var fCarin:object;
  var SOut:money = $0;// АЦ╛╛═, А╞╗А═╜╜═О А ┼2 ╞╝ ╞╚═Б╔╕Ц
  var SIn :money = $0;// АЦ╛╛═, ╖═Г╗А╚╔╜╜═О ╜═ ┼2 ╞╝ ╞╚═Б╔╕Ц

debugbreak;
  /* └═╜╜К╔ Д╗╚ЛБЮ═Ф╗╗ ╞╝ ╙═Б╔ё╝Ю╗О╛ */
  /* ╞╔Ю╔╓═НБАО ╞═Ю═╛╗<GroupIDi,AttrIDi>, ╜═Г╗╜═О А 9-ё╝ ╖╜═Г╔╜╗О MapVal */
  var i    :integer = 0        ;    // АГ╔БГ╗╙ ╞╝ ╙═Б╔ё╝Ю╗О╛ ╓╚О Д╗╚ЛБЮ═Ф╗╗ 
  var isSet:bool    = true     ;    // ╙═Б╔ё╝Ю╗О ЦАБ═╜╝╒╚╔╜═

  var isKOR:string  = ""       ;    // ╞Ю╗╖╜═╙, ГБ╝ ╞╚═Б╔╕ ╞Ю╗Х╔╚ ╗╖ ┼▌░ - ╓╚О ╞╝╛╔И╔╜╜КЕ

  if( KindReport == DOC_INSERT )
    select = ┌К║Ю═БЛ▐Ю╝╒╝╓╙╗▐╝┌╜╔║═╚═╜АЦ┌╗╓═( "50", DateIn, DateOut, params );
  else  //KindReport == LOCATED_DOC
    //VDN 27.08.2014 └╝║═╒╗╚ dpmrmprop_dbt ╓╚О ╒╝╖╛╝╕╜╝АБ╗ А╝ЮБ╗Ю╝╒╙╗ ╞╝ Х╗ДЮЦ
    select = ┌К║Ю═БЛPaymentID() + FromPMHIST_PMPAYM() + ", daccount_dbt ac, dpmrmprop_dbt rm WHERE pm.t_paymentid = rm.t_paymentid AND ";
    ▐╚═Б╔╕│К╚▐╝╛╔И╔╜┌_┼2( @select, params, DateIn, DateOut );
    select = select + ▒╒О╖Л▒▓═║╚╗Ф╔╘▒Г╔Б╝╒(1) + 
                      " AND NOT EXISTS ( SELECT * "+
                                          "FROM dpmhist_dbt pmh2 "+
                                         "WHERE pmh2.t_PaymentID = pm.t_PaymentID "+
                                           "AND pmh2.t_StatusIDFrom = 2000 "+
                                           "AND pmh2.t_StatusIDTo <> 2000 "+
                                           "AND pmh2.t_Date <= :DateIn2 ) ";
    params[params.size]   = SQLParam( "DateIn2"  , DateOut  );    

    if( cSetCategory == true )
      select = select + ▐╚═Б╔╕┼╚╗╔╜БА╙╗╘▌Ю╓╔Ю();
    end;
  end;
  └╝║═╒╗БЛ⌠А╚╝╒╗╔▐╝▒Г╔БЦ▐╚═Б╔╚ЛИ╗╙═      ( @select, params, Account );
  └╝║═╒╗БЛ⌠А╚╝╒╗╔▐╝■╗╚╗═╚Ц▒Г╔Б═          ( @select, params, DepNum  );
  └╝║═╒╗БЛ⌠А╚╝╒╗╔▐╝┌▒▐▒Г╔Б═              ( @select, params, NodeNum );
  └╝║═╒╗БЛ⌠А╚╝╒╗╔▐╝▌╞╔Ю═Ф╗╝╜╗АБЦ▐╚═Б╔╕═  ( @select, params, Oper    );
  └╝║═╒╗БЛ⌠А╚╝╒╗╔▐╝┌═╚НБ╔▒Г╔Б═▐╚═Б╔╚ЛИ╗╙═( @select, params, FIID    );

  //VDN 27.08.2014 ▒╝ЮБ╗Ю╝╒╙═ ╞╝ Х╗ДЮЦ ╝╞Ю═Ф╗╗, ▒-32485
  //▒╝ЮБ╗Ю╝╒╙═▐╝▌╞╔Ю═Ф╗╝╜╗АБЦ▒Г╔БЦ▐╚═Б╔╚ЛИ╗╙═( @select );

  //zmp 09.12.2014 R-509869-2

  if( KindReport == DOC_INSERT )  select = select + "ORDER BY TRN.T_SHIFR_OPER, pm.t_payeraccount, pm.t_i2placedate ";
  else                            select = select + "ORDER BY rm.T_SHIFROPER, pm.t_payeraccount, pm.t_i2placedate ";
  end;


  ReportHead = IfThenElse( KindReport == DOC_INSERT, "└╝╙Ц╛╔╜БК, ╞╝╛╔И╔╜╜К╔ ╒ ╙═ЮБ╝Б╔╙Ц Э2", 
                                                     "└╝╙Ц╛╔╜БК, ╜═Е╝╓ОИ╗╔АО ╒ ╙═ЮБ╝Б╔╙╔ Э2" );
  var rs:RsdRecordset = execSQLselect( select, params, FALSE );
  if( rs )
    rs.Command.NullConversion = true;
    while( ( rs.MoveNext() ) and ( rs.value(0) > 0 ) )
      fCarin = TbFile( "acctrn.dbt", "R" );
      if( KindReport == DOC_INSERT )
        fCarin.rec.AccTrnID = rs.value(0);
        if( fCarin.GetEQ() )
          if( ( ValType( PaymentObj ) == V_UNDEF ) or ( PaymentObj.PaymentID != rs.value(1) ) )
            isKOR = IfThenElse( fCarin.rec.Account_Receiver == TIndexWPPrimDoc( PM_GetSfContrID( RsbPayment( rs.value(1) ) ), rs.value(1) ).FindAndOpenSysAccount( "┼═ЮБ ▌░", IsOprMultiExec() ),
                                "X", "" );
            PaymentObj = TRepPayment( rs.value(1), isKOR );
            Payments[Payments.size] = PaymentObj;
            Amounts[Amounts.size]   = TArray();
            Amounts[Amounts.size - 1][Amounts[Amounts.size - 1].size] = ▒Ц╛╛═┌┌═╚НБ╔▒Г╔Б═( fCarin.rec.Sum_Payer, fCarin.rec.Date_Carry, PaymentObj );
          end;
        end;
      else // KindReport == LOCATED_DOC
        PaymentObj = RsbPayment( rs.value(0) );

        // Д╗╚ЛБЮ═Ф╗О ╞╝ ╙═Б╔ё╝Ю╗О╛
        if( cSetCategory )
          PsPayOrderObj = RsbPSPayOrder( rs.value(0) );
          i = 0;
          while( isSet and MapVal.Exists( "GroupID" + string(i)) and MapVal.Exists( "AttrID" + string(i) ) )
            isSet = PsPayOrderObj.Categories.IsAttrPresense( MapVal.Value( "GroupID" + string(i) ), 
                                                             MapVal.Value( "AttrID" + string(i) ), null, null, true, {curdate} );
            i = i + 1;
          end;
        end;

        if( ( cSetCategory == false ) or ( isSet == true ) )            
          SOut = ▒╞╗А═╜╜═О▒Ц╛╛═( PaymentObj ); 
          SIn  = ┤═Г╗А╚╔╜╜═О█═┼2▒Ц╛╛═( PaymentObj, fCarin.rec.AccTrnID ); 
          if( fCarin.rec.AccTrnID > 0 )
            fCarin.GetEQ();
          end;
          Payments[Payments.size] = PaymentObj;
          Amounts[Amounts.size] = TArray();
          // Б╔╙ЦИ═О АЦ╛╛═ ╞╝ ╓╝╙Ц╛╔╜БЦ
          if( SOut > 0 ) // ║К╚╗ А╞╗А═╜╗О А ┼2
            Amounts[Amounts.size - 1][Amounts[Amounts.size - 1].size] = ▒Ц╛╛═┌┌═╚НБ╔▒Г╔Б═( SIn - SOut, DateOut, PaymentObj );
          else
            fCarin.rec.Date_Carry = DateOut;
            Amounts[Amounts.size - 1][Amounts[Amounts.size - 1].size] = ▒Ц╛╛═▐Ю╝╒╝╓╙╗┌┌═╚НБ╔▒Г╔Б═▐╚═Б╔╚ЛИ╗╙═( fCarin, PaymentObj, false );
          end;
          // ╜═Г═╚Л╜═О АЦ╛╛═ ╓╝╙Ц╛╔╜Б═ 
          Amounts[Amounts.size - 1][Amounts[Amounts.size - 1].size] = ▒Ц╛╛═▐Ю╝╒╝╓╙╗┌┌═╚НБ╔▒Г╔Б═▐╚═Б╔╚ЛИ╗╙═( fCarin, PaymentObj, false );
        end;
      end;
      isSet = true;
    end;//while( rs.MoveNext())

  end;

  I2InsLocReport = TPSReportPayments( ReportHead, "PR_IND2I.mac", Payments, Amounts, DateIn, DateOut, DepNum, Oper);

  //VDN 27.08.2014 ≈Б╝║К ╜╔ Ю╝╖╒═╚╗БЛ ╓ЮЦё╗Е ╝БГ╔Б╝╒, ╞╔Ю╔╓═╚ ╞Ю╗╖╜═╙ ╗╖╛╔╜╔╜╗О ╒ ╙╚═АА ╝БГ╔Б╝╒
  I2InsLocReport.PrintPSReportPayments(true);
  
END;
