/* -------------------------------------------------------------------- */
/*         Автоматизированная банковская система RS-Bank v6.0           */
/*                 Copyright (c) R-Style Software Lab                   */
/*                                                                      */
/*  Имя файла  : reqcla.mac                                             */
/*                                                                      */
/*  Описание   : Операция - 3035 - "Закрытие лицевого счета"            */
/*               Шаг      - 60   - "Закрытие счета"                     */
/*                                                                      */
/*  Программист: Андреева Е.П.                                          */
/*                                                                      */
/*  Создан     : 13.01.2005                                             */
/*                                                                      */
// KS 22.11.2013 Перенесены доработки из 30й сборки
/* -------------------------------------------------------------------- */
import reqinter, InsCarryDoc, PaymInter, PSInter, CheckDelivery;

RECORD req( reqclosa );

var TB_ReqClosAcc = TBFile("reqclosa.dbt",  "R", 0, "reqclosa.dbt",  "bank.def");


var ReqCloseAccObj:RsbReqCloseAcc;

PRIVATE MACRO GetMainRegDocDate( ClientID:integer, RegDate:date ):integer

var select = "SELECT RGDOC.T_DOCDATE"+
            " FROM DOBJRGDOC_DBT RGDOC"+
            " WHERE RGDOC.T_OBJECTID = :ClientID"+
              " AND RGDOC.T_ISMAIN = 'X'"+
              " AND RGDOC.T_ISCLOSED = CHR(0)";


var params:TArray = makeArray( SQLParam( "ClientID", ClientID ) );

var rset:RsdRecordset = execSQLselect( select, params, TRUE );

if( rset and rset.moveNext() )
  SetParm( 1, date( rset.value(0) ) );
end;     

return 0;

ONERROR(x)
  MsgBox( x.Message );
  return 1;

END;


PRIVATE VAR UR_PERS = 1;
PRIVATE VAR PR_PERS = 2;
/* Выполнение шага */
MACRO ExecuteStep( doc, reqacc )

  debugbreak;

  var stat:integer = 0;
  var RegDate:date = date( 0, 0, 0);
  var IPDate:date = date( 1, 1, 2004 );
  //Kozina в дистрибутиве была проверка на дату date( 1, 7, 2002 ), больше не актуальна
  //var URDate:date = date( 1, 7, 2002 );
  var URDate:date = date( 1, 7, 1900 );
  

  var Series = "", Number = "";// серия и номер сообщения в фонды 
  var TypeAccount = GetTypeAccount( 1/*CHAPT1*/, ReqCloseAccObj.Account, ReqCloseAccObj.Code_Currency );

  var KindClientFlag = -1;
  
  stat = GetMainRegDocDate( Req_GetAccClient( ReqCloseAccObj.Code_Currency, ReqCloseAccObj.Account ), RegDate ); 

  if( PM_FindBalanceInReg_117( "PS\\REQOPENACC\\Счета клиентов", ReqCloseAccObj.Account, 1 ) )
      KindClientFlag = UR_PERS;
  elif( Index( substr(ReqCloseAccObj.Account, 1, 5 ), "40802" ) )
      KindClientFlag = PR_PERS;
  end;

  if( stat == 0 )

    if( CheckTypeAccPSRegVal( TypeAccount, "ТИПЫ_СЧЕТОВ" ) )    
      // Заполнить статусы сегментов операции
      if( not InsertOprStatus( REQCLOSA_ST_KIND_FS, REQCLOSA_ST_FS_NEED ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return 1;
      end;
    else
      if( not InsertOprStatus( REQCLOSA_ST_KIND_DO, REQCLOSA_ST_DO_CLOSED ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return 1;
      end;
    end;

    //Gurin S. 17.02.2015 R-545305-2
    execSql("update daccount_dbt set t_close_date = :d where t_account = :acc and t_close_date is null", makeArray (SQLParam ("d",{Curdate}), SQLParam ("acc",ReqCloseAccObj.Account)));
  end;

  return 0;
END;

//TAM 10.10.2012 I-00214498-4
macro CheckStepAction ( mes )
  debugbreak;
  if (mes == OP_BACKOUT_STEP)
    if(not CheckDelivery(ReqCloseAccObj.RequestID, 2))
      return 1;
    end;
  end;
  
  return 0;
End;