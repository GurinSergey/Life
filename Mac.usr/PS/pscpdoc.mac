/***********************************************************************
          Автоматизированная банковская система RS-Bank v6.0           
                  Copyright (c) R-Style Software Lab                   
   Имя файла        : psrqdoc.mac
   Описание         : Макродействия валютных клиентских платежей
   Создан           : 01.03.2011                                       
***********************************************************************/
// KS 22.11.2013 Перенесены доработки из PS_CP.MAC

import pmbuff, globals, PaymInter, PTInter, lnpaym, check117, "pmchoper.mac","pm_tools.mac", "pm_opr.mac", pm_chksave, "pm_syscont.mac";


/*номера полей в панели*/
const pscp_fld_Number      = 1,
      pscp_fld_Date        = 2,
      pscp_fld_DateValue   = 3,
      pscp_fld_BaseAmount  = 4,
      pscp_fld_ReceiverINN = 30,
      pscp_fld_Details     = 34,
      pscp_fld_ReceiverBankName = 23,
      pscp_fld_PayerBankName    = 18,
      pscp_fld_ReceiverName     = 29,
      pscp_fld_PayerName        = 12;
const pscp_fld_kzPayerCode    = 13,
      pscp_fld_kzReceiverCode = 30;

macro ЗапретРедактирванияПЗО()

    if(r_pscpord.Origin != PSPO_OR_SF) return false; end;     /* Не является ПЗО*/

    if(not ПроверкаИдентичности(r_pscpord,r_pscpord_old))    return true; end;
    if(not ПроверкаИдентичности(r_pmpaym, r_pmpaym_old))     return true; end;
    if(not ПроверкаИдентичности(r_credit, r_credit_old))     return true; end;
    if(not ПроверкаИдентичности(r_pmrmprop, r_pmrmprop_old)) return true; end;

    return false;
end;

macro PS_CurPayOrderNewDoc()
  return 0;
end;

macro PS_CurPayOrderUserFunc( Режим:integer )
  return 1;
end;

macro PS_CurPayOrderCheckDoc( Режим )
  
  var stat     :integer = 0 ,
      note     :string  = "",
      save_note:string  = "",
      ErrStr   :string  = "",
      ret_val  :bool,
      OldDoc   :integer = 0;


  /* EVG Проверка номера пачки */
  if (r_pmpaym.NumberPack < 0)
      msgbox ( "Номер пачки не может быть отрицательным!" );
      return 42;
  end;

  /*Проверяем номер для всех документов, в том числе и отложенных.*/           
  if ( (Режим == 2 ) or (Режим == 3) or (Режим == 8) ) 
     if( needUseKZpm() )
        if( CompareStrWithMasks("10-29&??", r_pmkz.PayerCode) )
          MsgBox("Некорректное значение КОд");
          return pscp_fld_kzPayerCode;
        end;
        if( CompareStrWithMasks("10-29&??", r_pmkz.ReceiverCode) )
          MsgBox("Некорректное значение Кбе");
          return pscp_fld_kzReceiverCode;
        end;
     end;              
    if( CheckINN(r_pmrmprop.ReceiverINN) > 0 )
      msgBox ("Ошибка в ИНН получателя");
      return pscp_fld_ReceiverINN;
    end;
    if( StrLen( r_pmrmprop.Ground ) == 0 )
       MsgBox("Не заданы детали платежа");
       return pscp_fld_Details;
    end;
    if( StrLen( r_pmrmprop.Number ) == 0 )
      MsgBox("Не задан номер документа");
      return pscp_fld_Number;
    end;
    /*Gurin S. 16.03.2016 I-00591696-2
    if( ({curdate} - r_pmrmprop.Date) > 10 )
      msgbox("Некорректно задана дата документа");
      return pscp_fld_Date;
    end;
    */
    // Документ не устарел?
    if( OldDoc = GetRegValueOldDoc( r_pmpaym.DocKind ) )
      if((r_pmpaym.ValueDate - r_pmrmprop.Date) > OldDoc ) 
        MsgBox("Документ устарел и не может быть сохранён");
        return pscp_fld_Date;
      end;
    end;
    if( r_pmpaym.BaseAmount < 0.0 )
      msgbox("Нельзя задавать отрицательную сумму");
      return pscp_fld_BaseAmount;
    end;

    if( PM_CheckPayments( r_pmpaym, NULL, r_credit, r_pmrmprop, 1 ) )
      return 1;
    end;

    if( StrLen( r_pmrmprop.Ground )>210 )                
      if ( RsbGetTrue( False,True,"Основание платежа превышает 210 символов.|Продолжить?")==False )                   
        return pscp_fld_Details;
      end;
    end;

    if( StrLen( r_pmrmprop.PartyInfo)>210-33 )
      if ( RsbGetTrue( False,True,"Информация участнику превышает 177 символов.|Продолжить?")==False )
        return 1;
      end;
    end;

    if( StrLen( r_pmrmprop.ReceiverBankName)>140 )
      if ( RsbGetTrue( False,True,"Наименование банка получателя превышает 140 символов.|Продолжить?")==False )
        return pscp_fld_ReceiverBankName;
      end;
    end;

    if( StrLen( r_pmrmprop.PayerBankName)>140 )
      if ( RsbGetTrue( False,True,"Наименование банка плательщика превышает 140 символов.|Продолжить?")==False )
        return pscp_fld_PayerBankName;
      end;
    end;

    if( StrLen( r_pmrmprop.ReceiverName)>160 )
      if ( RsbGetTrue( False,True,"Наименование получателя превышает 160 символов.|Продолжить?")==False )
        return pscp_fld_ReceiverName;
      end;
    end;

    if( StrLen( r_pmrmprop.PayerName)>160 )
      if ( RsbGetTrue( False,True,"Наименование плательщика превышает 160 символов.|Продолжить?")==False )
        return pscp_fld_PayerName;
      end;
    end;

    ErrStr = PM_CheckPaymAccounts( r_pmpaym, NULL, r_credit, r_pmrmprop, 1 );

    if( strlen(ErrStr) > 0 )
      msgbox( ErrStr );
      return 1;
    end;

    /* Общие проверки по списку */
    stat = PSCP_ScrolMacroCommonChecks( TPanelFields(), r_pmpaym, r_debet, r_credit, r_pmrmprop );
    if( stat != NOTERROR )
      return stat;
    end;

    /* Проверить по 117-И */
    if( CheckOnSave_117( r_pmpaym, NULL, r_credit, NULL, r_pmrmprop ) )
      return pscp_fld_Number;
    end;

    /*проверка реквизитов валютной операции*/
    if(PM_CheckCO(r_pmpaym,r_pmrmprop,0,r_credit))
       return 1;
    end;
    
    if( stat ) return stat; end;

  end;

  if( Режим == 1 ) /*УДАЛЕНИЕ ДОКУМЕНТА*/

     if(not isDLMRuning())
       if( r_pscpord.Origin == CP_OR_SF )
         msgbox("Документ является платой за обслуживание.|Удаление запрещено.");
         stat = 1;
       end;
       /* Документ из Клиент-Банк'а (или БОУРМ) */
       if( r_pscpord.Origin == CP_OR_CLB )
         save_note = note = readNoteForObject(OBJTYPE_PSCPORDER, makeObjectID(OBJTYPE_PSCPORDER, NULL, r_pscpord), NOTEKIND_PSCP_DELETEGROUND);
         ret_val = GetString(note, "Основание для удаления документа, полученного по системе \"Клиент-Банк\"", 68);
         if( ret_val and (save_note != note) )
           stat = addNoteForObject(OBJTYPE_PSCPORDER, makeObjectID(OBJTYPE_PSCPORDER, null, r_pscpord), NOTEKIND_PSCP_DELETEGROUND, note);
           if( stat )
             MsgBox("Ошибка добавления примечания к документу");
             return stat;
           end;
         end;
         if( not note )
           MsgBox("Документ получен по системе \"Клиент-Банк\".|Удаление без ввода основания запрещено.");
           return 1;
         end;
       end;
     end;

     if(CheckDeletePayment(r_pmpaym.PaymentID))
       return 1;
     end;
  end;
         
  if( Режим == 2 )  /* ВВОД ДОКУМЕНТА */
    if( r_pscpord.Kind_Operation ) /* Вставка документа одновременно с началом операции */
    end;
  end;

  if( Режим == 3 )  /* РЕДАКТИРОВАНИЕ ДОКУМЕНТА */
    if( r_pscpord.Origin == CP_OR_SF )
      if( ЗапретРедактирванияПЗО() )
        msgbox("Документ является платой за обслуживание.|Корректировка реквизитов запрещена.");
        stat = 1;
      end;
    end;

    /* EVG Корректировка реквизитов документов "Клиент-Банк" разрешена. //Str! частично*/     
    /* Если документ получен по системе "Клиент-Банк", то запрещаем корректировку */
    /* Происхождения рублевых платежек: PSPO_OR_MANUAL-ручной ввод;PSPO_OR_CLB- Клиент банка */
    if( r_pscpord.Origin == CP_OR_CLB )
      if( (r_pmpaym.FIID            != r_pmpaym_old.FIID )           or
//          (r_pmpaym.Amount          != r_pmpaym_old.Amount)          or
          (r_pmpaym.PayFIID         != r_pmpaym_old.PayFIID)         or
//          (r_pmpaym.PayerAccount    != r_pmpaym_old.PayerAccount)    or
//          (r_pmpaym.ValueDate       != r_pmpaym_old.ValueDate)       or
          (r_pmrmprop.PayerINN        != r_pmrmprop_old.PayerINN)        or
          (r_pmrmprop.ReceiverBankName!= r_pmrmprop_old.ReceiverBankName)or
          (r_pmrmprop.ReceiverINN     != r_pmrmprop_old.ReceiverINN)     or
//          (r_pmrmprop.ShifrOper       != r_pmrmprop_old.ShifrOper)       or
          (r_pmrmprop.Ground          != r_pmrmprop_old.Ground) )
//          msgbox("Документ получен по системе \"Клиент-Банк\".|Корректировка реквизитов БЦИ запрещена.");
//          stat = CHANG_NOTKEEP;
      else
          stat = CHANG_NOTIMPORTANT;
      end;
/*    elif( r_pscpord.Origin == CP_OR_CLSB )
       msgbox("Документ получен по системе \"Клиент-Сбербанк\".|Корректировка реквизитов запрещена.");
       stat = 1;*/
    elif( (r_pscpord.CurrentState != 0) and (not EditFromHistScrol) )/* документ находится не в отложенных */
       /*При редактировании производим проверку важности внесенных изменений */
       /* Константы важности внесенных изменений:           */
       /* CHANG_NOTIMPORTANT   - изменения неважные (сохранение без отката операции)*/
       /* CHANG_IMPORTANT      - изменения важны (сохранение изменений возможно только при откате) */
       /* CHANG_NOTKEEP        - не сохранять изменения */
       /* Если возвращаемое значение  > 0, то это оно интерпритируется как номер поля с ошибочным параметром*/
       /* Если возвращаемое значение  = 0, то cчитается, что проверка прошла успешно
          и сохранение изменений можно производить без отката операции      */
        if( (r_pmpaym.BaseAmount      != r_pmpaym_old.BaseAmount) or
            (r_pmpaym.Amount          != r_pmpaym_old.Amount) or
            (r_pmpaym.PayerAccount    != r_pmpaym_old.PayerAccount) or
            (r_pmpaym.ReceiverAccount != r_pmpaym_old.ReceiverAccount) or
            (r_pmpaym.ValueDate       != r_pmpaym_old.ValueDate) or
//            (r_pmpaym.NumberPack      != r_pmpaym_old.NumberPack) or
            (r_credit.Corschem        != r_credit_old.Corschem) or
            (r_credit.RlsFormID       != r_credit_old.RlsFormID) or
            (r_credit.CodeKind        != r_credit_old.CodeKind) or
            (r_credit.BankCode        != r_credit_old.BankCode) or 
            (r_pmrmprop.ComissCharges != r_pmrmprop_old.ComissCharges) or
            (r_pmrmprop.SymbNotBalDebet != r_pmrmprop_old.SymbNotBalDebet) )
//            stat = CHANG_IMPORTANT; 
            // KS 13.06.2012 I-00198430 Сохраняем
            stat = CHANG_NOTIMPORTANT
        end;
     end;
          
              if( ( 
                   Opr_IsStepExecuteSymb( r_pmpaym.DocumentID, r_pmpaym.DocKind, "К" ) Or 
                   Opr_IsStepExecuteSymb( r_pmpaym.DocumentID, r_pmpaym.DocKind, "А" ) Or
                   Opr_IsStepExecuteSymb( r_pmpaym.DocumentID, r_pmpaym.DocKind, "Е" ) Or
                   Opr_IsStepExecuteSymb( r_pmpaym.DocumentID, r_pmpaym.DocKind, "е" ) ) 
                   And
                   ( /*r_pscpord.CurrentState != PSPO_ST_REJECTED*/
                     r_pmpaym.PaymStatus != PM_REJECTED) )

                if ( not ( 
                     ПроверкаИдентичности(r_pscpord , r_pscpord_old   ) And
                     ПроверкаИдентичности(r_credit  , r_credit_old    ) And
                     ПроверкаИдентичности(r_pmpaym  , r_pmpaym_old,   "FUTURERECEIVERACCOUNT") And
                     ПроверкаИдентичности(r_pmrmprop, r_pmrmprop_old  ) 
                     ) )                   
//                        stat = CHANG_NOTKEEP;
                        // KS 13.06.2012 I-00198430 Сохраняем
                        stat = CHANG_NOTIMPORTANT
                        //msgbox("Изменения не будут сохранены");
                elif (       
                     (Not Opr_IsStepExecuteSymb( r_pmpaym.DocumentID, r_pmpaym.DocKind, "U", "R") ) 
                      And
                     (Not Opr_IsStepExecuteSymb( r_pmpaym.DocumentID, r_pmpaym.DocKind, "З", "R", 29029) )
                      And 
                     (r_pmpaym.FutureReceiverAccount != r_pmpaym_old.FutureReceiverAccount )
                     )
//                        stat = CHANG_NOTKEEP;
                        // KS 13.06.2012 I-00198430 Сохраняем
                        stat = CHANG_NOTIMPORTANT
                        //msgbox("Изменения не будут сохранены");
                end;
            end;
 
  end;
  if( Режим == 7 ) /*ПОМЕЩЕНИЕ ДОКУМЕНТА В ОТЛОЖЕННЫЕ, ОТКАТ ОПЕРАЦИИ*/
  end;
  if( Режим == 8 )  /*ВВОД В ОТЛОЖЕННЫЕ*/
  end;

  if(Режим == OBJ_AFTEREDIT) // Проверка важности изменений влияющей на необходимость смены опера документа
                               // (изменения в буферах не сохраняются)
    return IsImportantChangeForOperPsCpOrder(r_pmpaym, r_pmpaym_old, r_pmrmprop, r_pmrmprop_old, r_credit, r_credit_old);
  end;

  return stat;
end;

