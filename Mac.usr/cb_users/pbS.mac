//ПользовательскиеПроверкиПриСохранении
import Rsbdataset, BankInter;  //
import "AvtoTypePayment.mac";  //

Macro ПользовательскиеПроверкиПриСохранении (pmpaym, pmprop, pmrmprop)


   MACRO not_in(val)
     var i = 1,str;
     while(getparm(i,str))
        if(val == str)
           return false;
        end;
        i=i+1;
     end;
     return true;
   END;

   MACRO in(val)
     var i = 1,str;
     while(getparm(i,str))
        if(val == str)
           return true;
        end;
        i=i+1;
     end;
     return false;
   END;

   /* EVG
   macro IsDigitalNumber( Number )*/
   private macro IsDigitalNumber( Number )
     var stat = 0, i = 1, ch, DigitString = "0123456789";

         while( (not stat) and (i <= strlen(Number)) )
           ch = SubStr( Number, i, 1 );
           if( not Index( DigitString, ch ))
             stat = 1;
           end;
           i = i + 1;
         end;
     return stat;
   end;

   macro ПроверитьЗапрещенныеСимволы(str);

   var nosymb="" + StrFor(26)+StrFor(9)+StrFor(13); 
   var i=1;
      while (i<=strlen(str))
         if ((index(nosymb, substr(str,i,1)))!=0)
            return False;
         end;
      i=i+1;
      end;
   return True;
   end;

var PaymentKind;
var PayerINN:string = "", ReceiverINN:string = "";
var PayerKPP:string = "", ReceiverKPP:string = "";
var note;
var nak;
debugbreak;

  //1. Контроль шифра (Шифр платежа должен быть 01, 02, 06, 16, 17)
  if(not_in(Pmrmprop.shifroper,"01", "02", "06", "16", "17"))
     Msgbox("Неверный шифр операции: "+Pmrmprop.shifroper);
     return 1;
  end;

   If(IsDigitalNumber(pmrmprop.number) != 0)
      MsgBox("Номер документа не цифровой");
      return 1 ;
   End;  

//2.2 Наличие суммы платежа
  If(pmpaym.Amount==0)
     MsgBox("Сумма документа не укзана");
     return 1;
  End;

//2.4. Очередность платежа должна быть задана
  If(pmrmprop.priority=="")
      MsgBox("Очередность платежа должна быть задана");
   return 1;
  End;

//2.7. Наличие счета плательщика, длина 20 символов
     //3.В счете плательщика/получателя д.б. только цифры
  If (strlen(pmpaym.PayerAccount)!=20);
     MsgBox("Счет плательщика не двадцатизначный");
     return 1;
  End;

  if (pmpaym.ReceiverAccount!="")
     If (strlen(pmpaym.ReceiverAccount)!=20)
        MsgBox("Счет получателя не двадцатизначный");
        return 1;
     End;

     if(isdigitalNumber(pmpaym.receiveraccount) != 0)
        Msgbox("В счете получателя встречаются нечисловые символы: "+pmpaym.receiveraccount);
        return 1;
     end;


     if (Substr(pmpaym.receiveraccount,6,3) != "810" )
        Msgbox("Валюта счета получателя не 810");
        return 1;
     End;
  end;

  if(isdigitalNumber(pmpaym.payeraccount) != 0)
     Msgbox("В счете плательщика встречаются нечисловые символы: "+pmpaym.payeraccount);
     return 1;
  end;

  if (Substr(pmpaym.payeraccount,6,3) != "810" )
     msgbox("Валюта счета плательщика не 810");
     return 1;
  End;

//2.9. Наличие наименования плательщика
  If(pmrmprop.PayerName=="")
     MsgBox("Наименование плательщика не задано");
     return 1;
  End;
//2.11. Наличие наименования получателя
  If(pmrmprop.ReceiverName=="")
     MsgBox("Наименование получателя не задано");
     return 1;
  End;

//2.10. БИК банка получателя задан и состоит из 9 символов
  If (not((pmprop.debetcredit==1)and(pmprop.codekind==3)and(strlen(pmprop.bankcode)==9)))  
     MsgBox("У получателя не задан 9 значный БИК");
     return 1;
  End;
//7.В корсчете получателя д.б. только цифры
  if(isdigitalNumber(pmrmprop.Receivercorraccnostro) != 0)
    Msgbox("В корсчете получателя встречаются нечисловые символы: "+pmrmprop.Receivercorraccnostro);
    return 1;
  end;

      //недопустимые символы
  if (not ПроверитьЗапрещенныеСимволы(pmrmprop.PayerName))
     MsgBox("В наименовании плательщика встречаются недопустимые символы");
     return 1;
  end;

  if (not ПроверитьЗапрещенныеСимволы(pmrmprop.ReceiverName))
     MsgBox("В наименовании получателя встречаются недопустимые символы");
     return 1;
  end;

  if (not ПроверитьЗапрещенныеСимволы(pmrmprop.ground))
     MsgBox("В назначении платежа встречаются недопустимые символы");
     return 1;
  end;

//11.ИНН плательщика/получателя должен только цифры.
//13.КПП плательщика/получателя должен быть больше 9 симв.
//14.КПП плательщика/получателя должен только цифры.

   If  (SplitFullINN(pmrmprop.PayerINN,PayerINN,PayerKPP))
       MsgBox("Ошибка ИНН");
   else
      if(strlen(PayerINN) > 12)
         MsgBox("Длинна ИНН плательщика не должна превышать 12 символов");
         return 1; //ош
      end;
      if(isdigitalNumber(PayerINN) != 0)
         Msgbox("В ИНН плательщика встречаются нечисловые символы: "+PayerINN);
         return 1;
      end;

      if(strlen(PayerKPP) > 9)
         MsgBox("Длинна КПП плательщика не должна превышать 9 символов");
         return 1; //ош
      end;

      if(isdigitalNumber(PayerKPP) != 0)
         Msgbox("В КПП плательщика встречаются нечисловые символы: "+PayerKPP);
         return 1;
      end;
   end;

   If  (SplitFullINN(pmrmprop.ReceiverINN,ReceiverINN,ReceiverKPP))
       MsgBox("Ошибка ИНН");
   else
      if(strlen(ReceiverINN) > 12)
         MsgBox("Длинна ИНН получателя не должна превышать 12 символов");
         return 1; //ош
      end;
      if(isdigitalNumber(ReceiverINN) != 0)
         Msgbox("В ИНН получателя встречаются нечисловые символы: "+ReceiverKPP);
         return 1;
      end;

      if(strlen(ReceiverKPP) > 9)
         MsgBox("Длинна КПП получателя не должна превышать 9 символов");
         return 1; //ош
      end;

      if(isdigitalNumber(ReceiverKPP) != 0)
         Msgbox("В КПП получателя встречаются нечисловые символы: "+ReceiverKPP);
         return 1;
      end;
   end;

return 0 // все ок
End;//Macro
