//ПользовательскиеПроверкиПредобработки
import BankInter,Rsbdataset;
import "PaymTestFormat.mac";
import "AvtoTypePayment.mac";  //
/*******************************************************************************************
********************************************************************************************/
MACRO ПользовательскиеПроверкиПредобработки(PaymentObj,Bn_Stat)



   macro ПроверитьЗапрещенныеСимволы(str);
   var nosymb="" + StrFor(26)+StrFor(9)+StrFor(13); 
   var i=1;
   while (i<=strlen(str))
      if ((index(nosymb, substr(str,i,1)))!=0)
         return False;
      end;
   i=i+1;
   end;
   return True;
   end;

   MACRO not_in(val)
     var i = 1,str;
     while(getparm(i,str))
        if(val == str)
           return false;
        end;
        i=i+1;
     end;
     return true;
   END;

   macro IsDigitalNumber( Number )
     var stat = 0, i = 1, ch, DigitString = "0123456789";

         while( (not stat) and (i <= strlen(Number)) )
           ch = SubStr( Number, i, 1 );
           if( not Index( DigitString, ch ))
             stat = 1;
           end;
           i = i + 1;
         end;
     return stat;
   end;

   //record note(notetext);
   var clacc;//счета клиентов
   var PaymentKind;//Str!  тип платежа из формы ввода
   var note;//примечание "Счет"а и "СчетВнешнего"
   var PayerINN:string = "", ReceiverINN:string = "";
   var PayerKPP:string = "", ReceiverKPP:string = "";
   var type_ac;
   //var Bn_Stat;// статус банка получателя  - теперь входным параметром

  //1. Контроль шифра (Шифр платежа должен быть 01, 02, 06, 16, 17)
  if(not_in(PaymentObj.shifroper,"01", "02", "06", "16", "17"))
     Msgbox("Неверный шифр операции: "+PaymentObj.shifroper);
     PaymentObj.notes.addnote(42,"Неверный шифр операции: "+PaymentObj.shifroper);
     return 1;
  end;

   //1 Номер документа не должен состоять из нулей и имеет хотя бы одну цифру
   If(IsDigitalNumber(PaymentObj.number) != 0)
       MsgBox("Номер документа не цифровой");
       PaymentObj.notes.addnote(42,"Номер документа не цифровой");
       return 1 ;
   End;

   If(PaymentObj.payerAmount==0)
      MsgBox("Сумма документа не укзана");
      PaymentObj.notes.addnote(42,"Сумма документа не укзана");
      return 1;
   End;

//   If(not ((PaymentObj.priority >= 1) and (PaymentObj.priority <=6)))
   If(not ((PaymentObj.priority >= 0) and (PaymentObj.priority <=6)))
       MsgBox("Очередность платежа указана неверно");
       PaymentObj.notes.addnote(42,"Очередность платежа указана неверно");
    return 1;
   End;


   If (strlen(PaymentObj.PayerAccount)!=20);
      MsgBox("Счет плательщика не двадцатизначный");
      PaymentObj.notes.addnote(42,"Счет плательщика не двадцатизначный");
      return 1;
   End;

   if(isdigitalNumber(PaymentObj.payeraccount) != 0)
      Msgbox("В счете плательщика встречаются нечисловые символы: "+PaymentObj.payeraccount);
      PaymentObj.notes.addnote(42,"В счете плательщика встречаются нечисловые символы: "+PaymentObj.payeraccount);
      return 1;
   end;

   if (Substr(PaymentObj.payeraccount,6,3) != "810" )
      msgbox("Валюта счета плательщика не 810");
      PaymentObj.notes.addnote(42,"Валюта счета плательщика не 810");
      return 1;
   End;

   if (PaymentObj.ReceiverAccount!="")
      If (strlen(PaymentObj.ReceiverAccount)!=20);
         MsgBox("Счет получателя не двадцатизначный");
         PaymentObj.notes.addnote(42,"Счет получателя не двадцатизначный");
         return 1;
      End;

      if(isdigitalNumber(PaymentObj.receiveraccount) != 0)
         Msgbox("В счете получателя встречаются нечисловые символы: "+PaymentObj.receiveraccount);
         PaymentObj.notes.addnote(42,"В счете получателя встречаются нечисловые символы: "+PaymentObj.receiveraccount);
         return 1;
      end;

      if (Substr(PaymentObj.receiveraccount,6,3) != "810" )
         Msgbox("Валюта счета получателя не 810");
         PaymentObj.notes.addnote(42,"Валюта счета получателя не 810");
         return 1;
      End;
   end;
   //2.10. БИК банка получателя задан и состоит из 9 символов
   If (not((PaymentObj.ReceiverBankCodeKind==3)and(strlen(PaymentObj.ReceiverBankCode)==9)))
      MsgBox("У получателя не задан 9 значный БИК");
      PaymentObj.notes.addnote(42,"У получателя не задан 9 значный БИК");
      return 1;
   End;
  //7.В корсчете получателя д.б. только цифры
   if(isdigitalNumber(PaymentObj.Receivercorraccnostro) != 0)
      Msgbox("В корсчете получателя встречаются нечисловые символы: "+PaymentObj.Receivercorraccnostro);
      PaymentObj.notes.addnote(42,"В корсчете получателя встречаются нечисловые символы: "+PaymentObj.Receivercorraccnostro);
      return 1;
   end;

//2.9. Наличие наименования плательщика
   If(PaymentObj.PayerName=="")
      MsgBox("Наименование плательщика не задано");
      PaymentObj.notes.addnote(42,"Наименование плательщика не задано");
      return 1;
   End;
//2.11. Наличие наименования получателя
   If(PaymentObj.ReceiverName=="")
      MsgBox("Наименование получателя не задано");
      PaymentObj.notes.addnote(42,"Наименование получателя не задано");
      return 1;
   End;
//2.12. Наличие назначения платежа
   If(strlen(PaymentObj.ground)==0)
      MsgBox("Назначение платежа не задано");
      PaymentObj.notes.addnote(42,"Назначение платежа не задано");
      return 1;
   End;
   
   //недопустимые символы
   if (not ПроверитьЗапрещенныеСимволы(PaymentObj.PayerName))
      MsgBox("В наименовании плательщика встречаются недопустимые символы");
      PaymentObj.notes.addnote(42,"В наименовании плательщика встречаются недопустимые символы");
      return 1;
   end;

   if (not ПроверитьЗапрещенныеСимволы(PaymentObj.ReceiverName))
      MsgBox("В наименовании получателя встречаются недопустимые символы");
      PaymentObj.notes.addnote(42,"В наименовании получателя встречаются недопустимые символы");
      return 1;
   end;

   if (not ПроверитьЗапрещенныеСимволы(PaymentObj.ground))
      MsgBox("В назначении платежа встречаются недопустимые символы");
      PaymentObj.notes.addnote(42,"В назначении платежа встречаются недопустимые символы");
      return 1;
   end;
   
   /* A.Gregeradsky - 30.11.2009 - Добавлена проверка внешнего рублевого платежа на соответствие формату УФЭБС по длине полей */
   if((PaymentObj.IsExternal) and (PaymentObj.BaseFIID == 0))
     var tr = ПроверитьПоФорматуУФЭБС(PaymentObj);

     if(strlen(trim(tr)) > 0)
       MsgBox(tr);
       PaymentObj.notes.addnote(42,tr);
       return 1;
     end;
   end;
   /* End Gregeradsky */

//11.ИНН плательщика/получателя должен только цифры.
//12.ИНН плательщика/получателя должен быть не больше 12 симв.
//13.КПП плательщика/получателя должен быть не больше 9 симв.
//14.КПП плательщика/получателя должен только цифры.
   If  (SplitFullINN(PaymentObj.PayerINN,PayerINN,PayerKPP))
       MsgBox("Ошибка ИНН");
   else
      if(strlen(PayerINN) > 12)
         MsgBox("Длинна ИНН плательщика не должна превышать 12 символов");
         PaymentObj.notes.addnote(42,"Длинна ИНН плательщика не должна превышать 12 символов");
         return 1; //ош
      end;

      if(isdigitalNumber(PayerINN) != 0)
         Msgbox("В ИНН плательщика встречаются нечисловые символы: "+PayerINN);
         PaymentObj.notes.addnote(42,"В ИНН плательщика встречаются нечисловые символы: "+PayerINN);
         return 1;
      end;

      if(strlen(PayerKPP) > 9)
         MsgBox("Длинна КПП плательщика не должна превышать 9 символов");
         PaymentObj.notes.addnote(42,"Длинна КПП плательщика не должна превышать 9 символов");
         return 1; //ош
      end;

      if(isdigitalNumber(PayerKPP) != 0)
         Msgbox("В КПП плательщика встречаются нечисловые символы: "+PayerKPP);
         PaymentObj.notes.addnote(42,"В КПП плательщика встречаются нечисловые символы: "+PayerKPP);
         return 1;
      end;
   end;

   If  (SplitFullINN(PaymentObj.ReceiverINN,ReceiverINN,ReceiverKPP))
       MsgBox("Ошибка ИНН");
   else
      if(strlen(ReceiverINN) > 12)
         MsgBox("Длинна ИНН получателя не должна превышать 12 символов");
         PaymentObj.notes.addnote(42,"Длинна ИНН получателя не должна превышать 12 символов");
         return 1; //ош
      end;

      if(isdigitalNumber(ReceiverINN) != 0)
         Msgbox("В ИНН получателя встречаются нечисловые символы: "+ReceiverKPP);
         PaymentObj.notes.addnote(42,"В ИНН получателя встречаются нечисловые символы: "+ReceiverKPP);
         return 1;
      end;

      if(strlen(ReceiverKPP) > 9)
         MsgBox("Длинна КПП получателя не должна превышать 9 символов");
         PaymentObj.notes.addnote(42,"Длинна КПП получателя не должна превышать 9 символов");
         return 1; //ош
      end;

      if(isdigitalNumber(ReceiverKPP) != 0)
         Msgbox("В КПП получателя встречаются нечисловые символы: "+ReceiverKPP);
         PaymentObj.notes.addnote(42,"В КПП получателя встречаются нечисловые символы: "+ReceiverKPP);
         return 1;
      end;
   end;

   return 0; //ок, все пользовательские проверки пройдены успешно  

END;//macro
